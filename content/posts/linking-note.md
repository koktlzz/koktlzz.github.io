---
title: "CSAPP 读书笔记：链接"
date: 2022-03-02T21:31:42+01:00
draft: true
tags: ["CSAPP","OS"]
summary: "链接（Linking）是将各部分代码和数据收集并组成单个文件的过程，该文件可以被加载（复制）到内存中执行。链接可以在编译时（即源代码被翻译成机器代码时）执行，也可以在加载时 ..."
---

链接（Linking）是将各部分代码和数据收集并组成单个文件的过程，该文件可以被加载（复制）到内存中执行。链接可以在编译时（即源代码被翻译成机器代码时）执行，也可以在加载时（即程序被加载到内存并由加载器执行时）执行，甚至还可以在运行时通过应用程序执行。链接是由称为链接器（Linker）的程序自动执行的。

链接器支持单独编译（Separate Compilation），因此在软件开发中起着至关重要的作用。与其将大型应用程序组织为一个单一的大块源文件，不如将其分解为一些更小、更易于管理并且可以单独修改和编译的模块。如果我们修改了其中某个模块，只需重新对其编译并链接应用程序，而无需重新编译其他文件。

## 编译器驱动

大多数编译系统都提供了一个编译器驱动（Compiler Driver），它根据用户需求调用语言预处理器、编译器、汇编器和链接器等。例如要在 GNU 编译系统中构建下列程序，我们可以使用命令`gcc -Og -o prog main.c sum.c`:

![20220302220232](https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/20220302220232.png)

编译器驱动将示例程序从 ASCII 源文件转换为可执行目标文件时的过程如下图所示：

![202203022208](https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/202203022208.png)

首先，驱动运行 C 预处理器（C Preprocessor，CPP），将源文件`main.c`转换为 ASCII 中间文件`main.i`；接下来，驱动运行 C 编译器 (C Compiler，CC)，将`main.i`转换为 ASCII
汇编语言文件`main.s`；然后，驱动运行汇编器，将`main.s`转换为二进制可重定位（Relocatable）目标文件`main.o`（`sum.o`的生成过程相同）；最后，驱动运行链接器，将`main.o`、`sum.o`和一些必要的系统目标文件组合，创建二进制可执行目标文件`prog`。

## 静态链接

静态链接器（Static Linker）将可重定位目标文件和命令行参数作为输入，生成完全链接的可执行目标文件。作为输入的可重定位目标文件由各种代码和数据组成，其中每个部分都是一个连续的字节序列。指令、初始化的全局变量和未初始化的变量分别处于不同部分。

链接器需要完成两个主要任务：

- 符号解析（Symbol Resolution）：目标文件定义并引用符号，每个符号对应一个函数、全局变量或静态变量（即使用`static`声明的任何变量）。符号解析的目的是将每个符号引用与一个符号定义相关联；
- 重定位：编译器和汇编器生成从地址 0 开始的代码和数据段。链接器通过将内存位置与每个符号定义相关联来重定位这些段，然后修改所有对这些符号的引用，从而使它们指向该内存位置。链接器使用由汇编器生成的详细指令（称为重定位条目）盲目地执行重定位操作。

目标文件只是字节块的集合。其中一些块包含程序代码，另一些包含程序数据，还有一些包含指导链接器和加载器的数据结构。链接器将块连接在一起，决定连接块的运行时位置，并修改代码和数据块中的各个位置。链接器对目标机器的了解很少。生成目标文件的编译器和汇编器已经完成了大部分工作。

## 目标文件
