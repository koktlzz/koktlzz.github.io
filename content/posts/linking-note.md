---
title: "CSAPP 读书笔记：链接"
date: 2022-03-02T21:31:42+01:00
draft: false
tags: ["CSAPP","OS"]
summary: "链接（Linking）是将各部分代码和数据收集并组成单个文件的过程，该文件可以被加载（复制）到内存中执行。链接可以在编译时（即源代码被翻译成机器代码时）执行，也可以在加载时 ..."
---

链接（Linking）是将各部分代码和数据收集并组成单个文件的过程，该文件可以被加载（复制）到内存中执行。链接可以在编译时（即源代码被翻译成机器代码时）执行，也可以在加载时（即程序被加载到内存并由加载器执行时）执行，甚至还可以在运行时通过应用程序执行。链接是由称为链接器（Linker）的程序自动执行的。

链接器支持单独编译（Separate Compilation），因此在软件开发中起着至关重要的作用。与其将大型应用程序组织为一个单一的大块源文件，不如将其分解为一些更小、更易于管理并且可以单独修改和编译的模块。如果我们修改了其中某个模块，只需重新对其编译并链接应用程序，而无需重新编译其他文件。

## 编译器驱动

大多数编译系统都提供了一个编译器驱动（Compiler Driver），它根据用户需求调用语言预处理器、编译器、汇编器和链接器等。例如要在 GNU 编译系统中构建下列程序，我们可以使用命令`gcc -Og -o prog main.c sum.c`:

![20220302220232](https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/20220302220232.png)

编译器驱动将示例程序从 ASCII 源文件转换为可执行目标文件时的过程如下图所示：

![202203022208](https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/202203022208.png)

首先，驱动运行 C 预处理器（C Preprocessor，CPP），将源文件`main.c`转换为 ASCII 中间文件`main.i`；接下来，驱动运行 C 编译器 (C Compiler，CC)，将`main.i`转换为 ASCII
汇编语言文件`main.s`；然后，驱动运行汇编器，将`main.s`转换为二进制可重定位（Relocatable）目标文件`main.o`（`sum.o`的生成过程相同）；最后，驱动运行链接器，将`main.o`、`sum.o`和一些必要的系统目标文件组合，创建二进制可执行目标文件`prog`。

## 静态链接

静态链接器（Static Linker）将可重定位目标文件和命令行参数作为输入，生成完全链接的可执行目标文件。作为输入的可重定位目标文件由各种代码和数据组成，其中每个部分都是一个连续的字节序列。指令、初始化的全局变量和未初始化的变量分别处于不同部分。

链接器需要完成两个主要任务：

- 符号解析（Symbol Resolution）：目标文件定义并引用符号，每个符号对应一个函数、全局变量或静态变量（即使用`static`声明的任何变量）。符号解析的目的是将每个符号引用与一个符号定义相关联；
- 重定位：编译器和汇编器生成的代码和数据段是从地址 0 开始的，而链接器会将一个内存位置与每个符号定义相关联，从而重定位这些段。它随后修改所有的符号引用，使其指向该内存位置。链接器使用由汇编器生成的详细指令（称为重定位条目）盲目地执行重定位操作。

**请明确**：目标文件只是字节块的集合。这些块中可能包含代码，也可能包含数据，还有可能包含指导链接器和加载器的数据结构。链接器将它们连接在一起，确定整体的运行时位置，并修改代码和数据块中的各个位置。

## 目标文件

目标文件（Object File）有三种形式：

- 可重定位目标文件：包含二进制代码和数据，可以在编译时与其他可重定位目标文件组合以创建可执行目标文件；
- 可执行目标文件：包含二进制代码和数据形式，可直接被复制到内存中执行；
- 共享目标文件：一种特殊类型的可重定位目标文件，可以在加载时或运行时加载到内存中并动态链接。

## 可重定位目标文件

典型的 ELF（Executable and Linkable Format）可重定位目标文件格式如下图所示：

![20220303215852](https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/20220303215852.png)

- ELF 头（ELF Header）：开头是一个表征系统字长（Word Size）和字节顺序（Byte Ordering）的 16 字节序列。其余部分包括 ELF 头的大小、目标文件的类型（如可重定位、可执行或共享）、机器类型（如 x86-64）、节头表（Section Header Table）的文件偏移量以及其中的条目；
- 节头表：描述了目标文件中每个 Section 的位置和大小；
- Section：位于 ELF 头和节头表之间，包括：
  - *.text*：编译后程序的机器码；
  - *.rodata*：只读数据，例如`printf`语句中的格式字符串，以及`switch`语句的跳转表；
  - *.data*：已初始化的全局变量和静态变量。非静态局部变量在运行时位于栈中，不会出现在 *.data* 或 *.bss* 中；
  - *.bss*：未初始化的静态变量，以及初始化为 0 的全局变量和静态变量。此 Section 只是一个占位符，在目标文件中不占用实际空间，因此可以提升空间效率。这些变量在运行时被分配到内存中，初始值为零；
  - *.symtab* ：包含在程序中定义和引用的函数和全局变量信息的符号表（Symbol Table）。与编译器中的符号表不同，*.symtab* 中的符号表不包含任何局部变量；
  - *.rel.text*：当链接器将此目标文件与其他文件组合时，*.text* 中的许多位置都需要被修改。通常，任何调用外部函数或引用全局变量的指令都需要被修改，而调用局部函数的指令则不变。可执行目标文件一般不需要重定位信息，因此可以省略；
  - *.rel.data*：被引用或定义的任何全局变量的重定位信息。通常，所有初始值为全局变量地址或外部定义函数地址的已初始化全局变量都需要修改；
  - *.debug*：调试符号表，仅在使用`-g`选项调用编译器驱动时出现；
  - *.line*：原始程序中行号与 *.text* 中机器代码指令之间的映射，仅在使用`-g`选项调用编译器驱动时出现；
  - *.strtab*：一个以 Null 结尾，包含 *.symtab* 和 *.debug* 中的符号表以及 Section 名称的字符串序列。

## 符号和符号表

每个目标文件都有一个符号表，其中包含了该文件所定义和引用的符号信息。符号有以下三种：

- 全局符号（Global Symbols）：由该文件定义且可以被其他文件引用的符号；
- 外部符号（Externals）：被该文件引用但由其他文件定义的符号；
- 局部符号（Local Symbols）：由该文件定义且无法被其他文件引用的符号，即使用`static`声明的函数和变量。

上节提到，非静态局部变量在运行时位于栈中，与链接器无关。而静态局部变量则保存在 *.data* 或 *.bss* 中，编译器会在符号表中为其创建名称唯一的局部符号。例如同一文件中的两个函数都定义了静态局部变量`x`：

```c
int f()
{
    static int x = 0;
    return x;
}
int g()
{
    static int x = 1;
    return x;
}
```

则编译器可能将`x.1`作为函数`f()`中的变量符号，将`x.2`作为函数`g()`中的变量符号，然后发送给汇编器。汇编器使用接收到的 .s 文件中的符号构建符号表。ELF 符号表中每个条目的数据结构为：

![20220315222437](https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/20220315222437.png)

- `name`：符号名在字符串表 *.strtab* 中的偏移量；
- `value`：对于可重定位目标文件是符号在其 Section 中的偏移量，对于可执行目标文件是符号的运行时地址；
- `size`：符号的大小；
- `type`：符号的类型；
- `binding`：符号是局部的还是全局的；
- `section`：符号所在的 Section 在节头表中的索引。

值得一提的是，有三个伪 Section 在节头表中没有条目：

- ABS：不应重定位的符号；
- UNDEF：在此文件中引用但在其他文件中定义的符号；
- COMMON：未初始化的全局符号。

上述三个 Section 仅存在于可重定位目标文件，而在可执行目标文件中并不存在。我们可以使用 READELF 工具阅读目标文件中的内容，[示例程序 main.c](/posts/linking-note/#编译器驱动) 生成的目标文件符号表条目如下：

![20220315225352](https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/20220315225352.png)

READELF 通过整数索引 Ndx 标识每个 Section，1 表示 *.text*，3 表示 *.data*。全局符号`main`和`array`分别位于两个 Section 的首部，因此偏移量`value`均为 0。外部符号`sum`未在本文件中定义，因此位于 UNDEF。

## 符号解析
