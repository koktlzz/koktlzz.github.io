<!doctype html><html lang=en><head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#"><meta charset=UTF-8><meta name=generator content="Hugo 0.135.0"><meta name=theme-color content="#fff"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no, date=no, address=no, email=no"><meta http-equiv=Cache-Control content="no-transform"><meta http-equiv=Cache-Control content="no-siteapp"><title>《Go 语言设计与实现》读书笔记：常用关键字 | Inspire Hub</title>
<link rel=stylesheet href=/css/meme.min.29f06ccbcbf49b8f420fa6e6976a12c3760e5b7fc62170ba2f32d3e10a36c609.css><script src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js defer></script><script src=/js/meme.min.afe5e32f041c73f30c35ee4995b010968e55825ff6f568b51b055236df10a0fd.js></script><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=IBM+Plex+Serif:ital,wght@0,400;0,500;0,700;1,400;1,700&amp;family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&amp;family=Comfortaa:wght@700&amp;display=swap" media=print onload='this.media="all"'><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=IBM+Plex+Serif:ital,wght@0,400;0,500;0,700;1,400;1,700&amp;family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&amp;family=Comfortaa:wght@700&amp;display=swap"></noscript><meta name=author content="koktlzz"><meta name=description content="Go 语言中的经典循环在编译器看来是一个OFOR类型的节点，这个节点由以下四个部分组成：1. 初始化循环的Ninit；2. 循环的继续条件Left；3. 循环体结束时执行的Right；4. 循环体NBody …"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=mask-icon href=/icons/safari-pinned-tab.svg color=#2a6df4><link rel=apple-touch-icon sizes=180x180 href=/icons/apple-touch-icon.png><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-title content="Inspire Hub"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=mobile-web-app-capable content="yes"><meta name=application-name content="Inspire Hub"><meta name=msapplication-starturl content="../../"><meta name=msapplication-TileColor content="#fff"><meta name=msapplication-TileImage content="../../icons/mstile-150x150.png"><link rel=manifest href=/manifest.json><link rel=canonical href=/posts/go--common-keywords-note/><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","datePublished":"2024-08-17T23:09:42+01:00","dateModified":"2024-10-11T17:09:39+08:00","url":"/posts/go--common-keywords-note/","headline":"《Go 语言设计与实现》读书笔记：常用关键字","description":"Go 语言中的经典循环在编译器看来是一个OFOR类型的节点，这个节点由以下四个部分组成：1. 初始化循环的Ninit；2. 循环的继续条件Left；3. 循环体结束时执行的Right；4. 循环体NBody …","inLanguage":"en","articleSection":"posts","wordCount":3967,"image":["https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/20240818171951.png","https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/20240818172027.png","https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/20240818172235.png"],"author":{"@type":"Person","email":"koktlgwr@gmail.com","image":"/icons/apple-touch-icon.png","url":"/","name":"koktlzz"},"license":"[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)","publisher":{"@type":"Organization","name":"Inspire Hub","logo":{"@type":"ImageObject","url":"/icons/apple-touch-icon.png"},"url":"/"},"mainEntityOfPage":{"@type":"WebSite","@id":"/"}}</script><meta property="og:title" content="《Go 语言设计与实现》读书笔记：常用关键字"><meta property="og:description" content="Go 语言中的经典循环在编译器看来是一个OFOR类型的节点，这个节点由以下四个部分组成：1. 初始化循环的Ninit；2. 循环的继续条件Left；3. 循环体结束时执行的Right；4. 循环体NBody …"><meta property="og:url" content="/posts/go--common-keywords-note/"><meta property="og:site_name" content="Inspire Hub"><meta property="og:locale" content="en"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/20240818171951.png"><meta property="og:type" content="article"><meta property="article:published_time" content="2024-08-17T23:09:42+01:00"><meta property="article:modified_time" content="2024-10-11T17:09:39+08:00"><meta property="article:section" content="posts"><link rel=preconnect href=https://www.google-analytics.com crossorigin><script async src="https://www.googletagmanager.com/gtag/js?id=G-D022F6NT2P"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-D022F6NT2P")</script></head><body><div class=container><header class=header><div class=header-wrapper><div class="header-inner single"><div class=site-brand><a href=/ class=brand>Inspire Hub</a></div><nav class=nav><ul class=menu id=menu><li class=menu-item><a href=/posts/><svg viewBox="0 0 512 512" class="icon archive"><path d="M32 448c0 17.7 14.3 32 32 32h384c17.7.0 32-14.3 32-32V160H32v288zm160-212c0-6.6 5.4-12 12-12h104c6.6.0 12 5.4 12 12v8c0 6.6-5.4 12-12 12H204c-6.6.0-12-5.4-12-12v-8zM480 32H32C14.3 32 0 46.3.0 64v48c0 8.8 7.2 16 16 16h480c8.8.0 16-7.2 16-16V64c0-17.7-14.3-32-32-32z"/></svg><span class=menu-item-name>Posts</span></a></li><li class=menu-item><a href=/series/><svg viewBox="0 0 512 512" class="icon th"><path d="M149.333 56v80c0 13.255-10.745 24-24 24H24c-13.255.0-24-10.745-24-24V56c0-13.255 10.745-24 24-24h101.333c13.255.0 24 10.745 24 24zm181.334 240v-80c0-13.255-10.745-24-24-24H205.333c-13.255.0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.256.0 24.001-10.745 24.001-24zm32-240v80c0 13.255 10.745 24 24 24H488c13.255.0 24-10.745 24-24V56c0-13.255-10.745-24-24-24H386.667c-13.255.0-24 10.745-24 24zm-32 80V56c0-13.255-10.745-24-24-24H205.333c-13.255.0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.256.0 24.001-10.745 24.001-24zm-205.334 56H24c-13.255.0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.255.0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24zM0 376v80c0 13.255 10.745 24 24 24h101.333c13.255.0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H24c-13.255.0-24 10.745-24 24zm386.667-56H488c13.255.0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H386.667c-13.255.0-24 10.745-24 24v80c0 13.255 10.745 24 24 24zm0 160H488c13.255.0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H386.667c-13.255.0-24 10.745-24 24v80c0 13.255 10.745 24 24 24zM181.333 376v80c0 13.255 10.745 24 24 24h101.333c13.255.0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H205.333c-13.255.0-24 10.745-24 24z"/></svg><span class=menu-item-name>Series</span></a></li><li class=menu-item><a href=/tags/><svg viewBox="0 0 640 512" class="icon tags"><path d="M497.941 225.941 286.059 14.059A48 48 0 00252.118.0H48C21.49.0.0 21.49.0 48v204.118a48 48 0 0014.059 33.941l211.882 211.882c18.744 18.745 49.136 18.746 67.882.0l204.118-204.118c18.745-18.745 18.745-49.137.0-67.882zM112 160c-26.51.0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm513.941 133.823L421.823 497.941c-18.745 18.745-49.137 18.745-67.882.0l-.36-.36L527.64 323.522c16.999-16.999 26.36-39.6 26.36-63.64s-9.362-46.641-26.36-63.64L331.397.0h48.721a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882z"/></svg><span class=menu-item-name>Tags</span></a></li><li class=menu-item><a href></a></li><li class="menu-item search-item"><form id=search class=search role=search><label for=search-input><svg viewBox="0 0 512 512" class="icon search-icon"><path d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></label>
<input type=search id=search-input class=search-input></form><template id=search-result hidden><article class="content post"><h2 class=post-title><a class=summary-title-link></a></h2><summary class=summary></summary><div class=read-more-container><a class=read-more-link>Read More »</a></div></article></template></li></ul></nav></div></div><input type=checkbox id=nav-toggle aria-hidden=true>
<label for=nav-toggle class=nav-toggle></label>
<label for=nav-toggle class=nav-curtain></label></header><main class="main single" id=main><nav class=contents><h2 id=contents class=contents-title>On This Page</h2><ol class=toc><li><a id=contents:for-和-range href=#for-和-range>For 和 Range</a><ol><li><a id=contents:数组和切片 href=#数组和切片>数组和切片</a><ol><li><a id=contents:遍历清空元素 href=#遍历清空元素>遍历清空元素</a></li><li><a id=contents:for-range-a href=#for-range-a><code>for range a{}</code></a></li><li><a id=contents:for-i--range-a- href=#for-i--range-a-><code>for i := range a {}</code></a></li><li><a id=contents:for-i-elem--range-a- href=#for-i-elem--range-a-><code>for i, elem := range a {}</code></a></li></ol></li><li><a id=contents:哈希表 href=#哈希表>哈希表</a></li><li><a id=contents:字符串 href=#字符串>字符串</a></li><li><a id=contents:管道 href=#管道>管道</a></li></ol></li><li><a id=contents:select href=#select>Select</a><ol><li><a id=contents:数据结构 href=#数据结构>数据结构</a></li><li><a id=contents:实现原理 href=#实现原理>实现原理</a><ol><li><a id=contents:直接阻塞 href=#直接阻塞>直接阻塞</a></li><li><a id=contents:单一管道 href=#单一管道>单一管道</a></li><li><a id=contents:非阻塞操作 href=#非阻塞操作>非阻塞操作</a><ol><li><a id=contents:发送 href=#发送>发送</a></li><li><a id=contents:接收 href=#接收>接收</a></li></ol></li><li><a id=contents:常见流程 href=#常见流程>常见流程</a></li></ol></li></ol></li><li><a id=contents:defer href=#defer>Defer</a><ol><li><a id=contents:数据结构-1 href=#数据结构-1>数据结构</a></li><li><a id=contents:执行机制 href=#执行机制>执行机制</a></li><li><a id=contents:堆中分配 href=#堆中分配>堆中分配</a><ol><li><a id=contents:创建延迟调用 href=#创建延迟调用>创建延迟调用</a></li><li><a id=contents:执行延迟调用 href=#执行延迟调用>执行延迟调用</a></li></ol></li><li><a id=contents:栈上分配 href=#栈上分配>栈上分配</a></li><li><a id=contents:开放编码 href=#开放编码>开放编码</a><ol><li><a id=contents:启用优化 href=#启用优化>启用优化</a></li><li><a id=contents:延迟记录 href=#延迟记录>延迟记录</a></li></ol></li></ol></li><li><a id=contents:panic--recover href=#panic--recover>Panic & Recover</a><ol><li><a id=contents:数据结构-2 href=#数据结构-2>数据结构</a></li><li><a id=contents:程序崩溃 href=#程序崩溃>程序崩溃</a></li><li><a id=contents:崩溃恢复 href=#崩溃恢复>崩溃恢复</a></li></ol></li><li><a id=contents:make--new href=#make--new>Make & New</a><ol><li><a id=contents:make href=#make>Make</a></li><li><a id=contents:new href=#new>New</a></li></ol></li><li><a id=contents:future-work href=#future-work>Future Work</a></li></ol></nav><div class=main-inner><article class="content post h-entry" data-small-caps=true data-align=default data-type=posts><h1 class="post-title p-name">《Go 语言设计与实现》读书笔记：常用关键字</h1><div class=post-tags><a href=/tags/go/ rel=tag class=post-tags-link><svg viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49.0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882.0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>Go</a></div><div class="post-body e-content"><blockquote><p>原书中的代码片段基于 Go 1.15，笔记则根据 Go 1.22 版本的更新进行了相应替换。</p></blockquote><h2 id=for-和-range><a href=#for-和-range class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:for-和-range class=headings>For 和 Range</a></h2><p>Go 语言中的经典循环在编译器看来是一个<code>OFOR</code>类型的节点，这个节点由以下四个部分组成：</p><ol><li>初始化循环的<code>Ninit</code>；</li><li>循环的继续条件<code>Left</code>；</li><li>循环体结束时执行的<code>Right</code>；</li><li>循环体<code>NBody</code>：</li></ol><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>for</span> <span class=nx>Ninit</span><span class=p>;</span> <span class=nx>Left</span><span class=p>;</span> <span class=nx>Right</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>NBody</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>在生成 <a href=/posts/go-compiler-principle-note/#%E4%B8%AD%E9%97%B4%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90>SSA 中间代码</a> 的阶段，<a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/cmd/compile/internal/ssagen/ssa.go#L1431 target=_blank rel=noopener>cmd/compile/internal/ssagen.stmt</a> 会将循环中的代码分成不同的块：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// stmt converts the statement n to SSA and adds it to s.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>state</span><span class=p>)</span> <span class=nf>stmt</span><span class=p>(</span><span class=nx>n</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=nx>n</span><span class=p>.</span><span class=nf>Op</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>OFOR</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1>// OFOR: for Ninit; Left; Right { Nbody }
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// cond (Left); body (Nbody); incr (Right)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>n</span> <span class=o>:=</span> <span class=nx>n</span><span class=p>.(</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>ForStmt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>base</span><span class=p>.</span><span class=nf>Assert</span><span class=p>(!</span><span class=nx>n</span><span class=p>.</span><span class=nx>DistinctVars</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>bCond</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>f</span><span class=p>.</span><span class=nf>NewBlock</span><span class=p>(</span><span class=nx>ssa</span><span class=p>.</span><span class=nx>BlockPlain</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>bBody</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>f</span><span class=p>.</span><span class=nf>NewBlock</span><span class=p>(</span><span class=nx>ssa</span><span class=p>.</span><span class=nx>BlockPlain</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>bIncr</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>f</span><span class=p>.</span><span class=nf>NewBlock</span><span class=p>(</span><span class=nx>ssa</span><span class=p>.</span><span class=nx>BlockPlain</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>bEnd</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>f</span><span class=p>.</span><span class=nf>NewBlock</span><span class=p>(</span><span class=nx>ssa</span><span class=p>.</span><span class=nx>BlockPlain</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>这些代码块之间的连接表示汇编语言中的跳转关系，与我们理解的<code>for</code>循环控制结构没有太多的差别：</p><p><img src=https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/20240818171951.png alt=20240818171951></p><p>除了使用经典的三段式循环之外，Go 语言还引入了另一个关键字<code>range</code>帮助我们快速遍历数组、切片、哈希表以及管道等集合类型。编译器会在编译期间将所有 for-range 循环变成普通 for 循环，即将<code>ORANGE</code>类型的节点转换成<code>OFOR</code>节点。我们将按照元素类型依次介绍遍历数组和切片、哈希表、字符串以及管道的过程。</p><h3 id=数组和切片><a href=#数组和切片 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:数组和切片 class=headings>数组和切片</a></h3><p>对于数组和切片来说，Go 语言有三种不同的遍历方式，分别对应着代码中的不同条件。它们会在 <a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/cmd/compile/internal/walk/range.go#L95 target=_blank rel=noopener>cmd/compile/internal/walk.walkRange</a> 函数中转换成不同的控制逻辑：</p><ol><li>遍历数组和切片清空元素的情况；</li><li>使用<code>for range a {}</code>遍历数组和切片；</li><li>使用<code>for i := range a {}</code>遍历数组和切片；</li><li>使用<code>for i, elem := range a {}</code>遍历数组和切片；</li></ol><h4 id=遍历清空元素><a href=#遍历清空元素 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:遍历清空元素 class=headings>遍历清空元素</a></h4><p>相比于依次清除数组或者切片中的数据，Go 语言会直接使用 <a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/memclr_386.s#L13 target=_blank rel=noopener>runtime.memclrNoHeapPointers</a> 或者 <a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/mbarrier.go#L369 target=_blank rel=noopener>runtime.memclrHasPointers</a> 清除目标数组内存空间中的全部数据，并在执行完成后更新遍历数组的索引：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 原代码
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>a</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>a</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=nx>zero</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 优化后
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>a</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>hp</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>a</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>hn</span> <span class=p>=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>a</span><span class=p>)</span><span class=o>*</span><span class=nf>sizeof</span><span class=p>(</span><span class=nf>elem</span><span class=p>(</span><span class=nx>a</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nf>memclrNoHeapPointers</span><span class=p>(</span><span class=nx>hp</span><span class=p>,</span> <span class=nx>hn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>i</span> <span class=p>=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>a</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=for-range-a><a href=#for-range-a class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:for-range-a class=headings><code>for range a{}</code></a></h4><p>调用者不关心数组<code>a</code>的索引和元素，循环会被编译器转换成如下形式：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>ha</span> <span class=o>:=</span> <span class=nx>a</span>
</span></span><span class=line><span class=cl><span class=nx>hv1</span> <span class=o>:=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nx>hn</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>ha</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>;</span> <span class=nx>hv1</span> <span class=p>&lt;</span> <span class=nx>hn</span><span class=p>;</span> <span class=nx>hv1</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=for-i--range-a-><a href=#for-i--range-a- class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:for-i--range-a- class=headings><code>for i := range a {}</code></a></h4><p>调用者不关心数组的元素，只关心遍历数组使用的索引。循环会被编译器转换成如下形式：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>ha</span> <span class=o>:=</span> <span class=nx>a</span>
</span></span><span class=line><span class=cl><span class=nx>hv1</span> <span class=o>:=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nx>hn</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>ha</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>;</span> <span class=nx>hv1</span> <span class=p>&lt;</span> <span class=nx>hn</span><span class=p>;</span> <span class=nx>hv1</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 传递遍历数组时的索引
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>v1</span> <span class=o>:=</span> <span class=nx>hv1</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=for-i-elem--range-a-><a href=#for-i-elem--range-a- class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:for-i-elem--range-a- class=headings><code>for i, elem := range a {}</code></a></h4><p>调用者同时关心数组的索引和切片，循环会被编译器转换成如下形式：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>ha</span> <span class=o>:=</span> <span class=nx>a</span>
</span></span><span class=line><span class=cl><span class=nx>hv1</span> <span class=o>:=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nx>hn</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>ha</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>;</span> <span class=nx>hv1</span> <span class=p>&lt;</span> <span class=nx>hn</span><span class=p>;</span> <span class=nx>hv1</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 变量在循环内部定义
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>v1</span><span class=p>,</span> <span class=nx>v2</span> <span class=o>:=</span> <span class=nx>hv1</span><span class=p>,</span> <span class=nx>ha</span><span class=p>[</span><span class=nx>hv1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>对于所有的 for-range 循环，Go 语言都会在编译期将原切片或者数组赋值给一个新变量<code>ha</code>，在赋值的过程中发生了拷贝。而我们又通过<code>len</code>关键字预先获取了切片的长度，所以在循环中追加新的元素并不会改变循环执行的次数：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>arr</span> <span class=o>:=</span> <span class=p>[]</span><span class=kt>int</span><span class=p>{</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>arr</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>arr</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>arr</span><span class=p>,</span> <span class=nx>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>arr</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 循环不会永动
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>$</span> <span class=k>go</span> <span class=nx>run</span> <span class=nx>main</span><span class=p>.</span><span class=k>go</span>
</span></span><span class=line><span class=cl><span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span> <span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span>
</span></span></code></pre></td></tr></table></div></div></div><p>另外，之前版本的 Go 语言会在循环外部定义变量<code>v2</code>，每次迭代<code>v2</code>的地址均不变，因此会出现如下 Bug：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>   <span class=nx>arr</span> <span class=o>:=</span> <span class=p>[]</span><span class=kt>int</span><span class=p>{</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>}</span>  
</span></span><span class=line><span class=cl>   <span class=nx>newArr</span> <span class=o>:=</span> <span class=p>[]</span><span class=o>*</span><span class=kt>int</span><span class=p>{}</span>  
</span></span><span class=line><span class=cl>   <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>arr</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>      <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;origin addr: %p value: %v\n&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>v</span><span class=p>,</span> <span class=nx>v</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>      <span class=c1>// newArr = append(newArr, &amp;arr[i])      
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>newArr</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>newArr</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>v</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl>   <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>newArr</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>      <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;addr: %p  value: %v\n&#34;</span><span class=p>,</span> <span class=nx>v</span><span class=p>,</span> <span class=o>*</span><span class=nx>v</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=p>}</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// go 1.21
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>$</span> <span class=k>go</span> <span class=nx>run</span> <span class=nx>main</span><span class=p>.</span><span class=k>go</span>
</span></span><span class=line><span class=cl><span class=nx>origin</span> <span class=nx>addr</span><span class=p>:</span> <span class=mh>0xc0000a0000</span> <span class=nx>value</span><span class=p>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=nx>origin</span> <span class=nx>addr</span><span class=p>:</span> <span class=mh>0xc0000a0000</span> <span class=nx>value</span><span class=p>:</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=nx>origin</span> <span class=nx>addr</span><span class=p>:</span> <span class=mh>0xc0000a0000</span> <span class=nx>value</span><span class=p>:</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=nx>addr</span><span class=p>:</span> <span class=mh>0xc0000a0000</span>  <span class=nx>value</span><span class=p>:</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=nx>addr</span><span class=p>:</span> <span class=mh>0xc0000a0000</span>  <span class=nx>value</span><span class=p>:</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=nx>addr</span><span class=p>:</span> <span class=mh>0xc0000a0000</span>  <span class=nx>value</span><span class=p>:</span> <span class=mi>3</span>
</span></span></code></pre></td></tr></table></div></div></div><p>Go 语言在 1.22 版本修改了控制结构的执行语义，短声明定义的循环变量将在每次迭代重新定义，详见：<a href=https://go.googlesource.com/proposal/+/master/design/60078-loopvar.md target=_blank rel=noopener>Proposal: Less Error-Prone Loop Variable Scoping</a>。因此执行上述代码会输出我们期望得到的结果：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// go 1.22
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>$</span> <span class=k>go</span> <span class=nx>run</span> <span class=nx>main</span><span class=p>.</span><span class=k>go</span>
</span></span><span class=line><span class=cl><span class=nx>origin</span> <span class=nx>addr</span><span class=p>:</span> <span class=mh>0xc000012028</span> <span class=nx>value</span><span class=p>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=nx>origin</span> <span class=nx>addr</span><span class=p>:</span> <span class=mh>0xc000012060</span> <span class=nx>value</span><span class=p>:</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=nx>origin</span> <span class=nx>addr</span><span class=p>:</span> <span class=mh>0xc000012068</span> <span class=nx>value</span><span class=p>:</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=nx>addr</span><span class=p>:</span> <span class=mh>0xc000012028</span>  <span class=nx>value</span><span class=p>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=nx>addr</span><span class=p>:</span> <span class=mh>0xc000012060</span>  <span class=nx>value</span><span class=p>:</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=nx>addr</span><span class=p>:</span> <span class=mh>0xc000012068</span>  <span class=nx>value</span><span class=p>:</span> <span class=mi>3</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=哈希表><a href=#哈希表 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:哈希表 class=headings>哈希表</a></h3><p><a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/map.go#L166 target=_blank rel=noopener>runtime.hiter</a> 是 Go 语言内部用于哈希表迭代的结构体：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>hiter</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>key</span>         <span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span> <span class=c1>// 指向当前迭代的键，nil 代表迭代结束
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>elem</span>        <span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span> <span class=c1>// 指向当前迭代的值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>t</span>           <span class=o>*</span><span class=nx>maptype</span>       <span class=c1>// 指向当前 map 的类型信息
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>h</span>           <span class=o>*</span><span class=nx>hmap</span>          <span class=c1>// 指向当前正在迭代的 map
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>buckets</span>     <span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span> <span class=c1>// 指向迭代初始化时的桶
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>bptr</span>        <span class=o>*</span><span class=nx>bmap</span>          <span class=c1>// 指向当前迭代的桶
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>overflow</span>    <span class=o>*</span><span class=p>[]</span><span class=o>*</span><span class=nx>bmap</span>       
</span></span><span class=line><span class=cl>    <span class=nx>oldoverflow</span> <span class=o>*</span><span class=p>[]</span><span class=o>*</span><span class=nx>bmap</span>       
</span></span><span class=line><span class=cl>    <span class=nx>startBucket</span> <span class=kt>uintptr</span>        
</span></span><span class=line><span class=cl>    <span class=nx>offset</span>      <span class=kt>uint8</span>          
</span></span><span class=line><span class=cl>    <span class=nx>wrapped</span>     <span class=kt>bool</span>           
</span></span><span class=line><span class=cl>    <span class=nx>B</span>           <span class=kt>uint8</span>
</span></span><span class=line><span class=cl>    <span class=nx>i</span>           <span class=kt>uint8</span>
</span></span><span class=line><span class=cl>    <span class=nx>bucket</span>      <span class=kt>uintptr</span>
</span></span><span class=line><span class=cl>    <span class=nx>checkBucket</span> <span class=kt>uintptr</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>在遍历哈希表时，编译器会使用 <a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/map.go#L816 target=_blank rel=noopener>runtime.mapiterinit</a> 和 <a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/map.go#L862 target=_blank rel=noopener>runtime.mapiternext</a> 重写原始的 for-range 循环。前者首先初始化 <a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/map.go#L166 target=_blank rel=noopener>runtime.hiter</a> 结构体中的字段并保存当前桶的状态，然后随机选择一个桶作为遍历的起始位置：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>mapiterinit</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>maptype</span><span class=p>,</span> <span class=nx>h</span> <span class=o>*</span><span class=nx>hmap</span><span class=p>,</span> <span class=nx>it</span> <span class=o>*</span><span class=nx>hiter</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>it</span><span class=p>.</span><span class=nx>t</span> <span class=p>=</span> <span class=nx>t</span>
</span></span><span class=line><span class=cl>    <span class=nx>it</span><span class=p>.</span><span class=nx>h</span> <span class=p>=</span> <span class=nx>h</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// grab snapshot of bucket state
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>it</span><span class=p>.</span><span class=nx>B</span> <span class=p>=</span> <span class=nx>h</span><span class=p>.</span><span class=nx>B</span>
</span></span><span class=line><span class=cl>    <span class=nx>it</span><span class=p>.</span><span class=nx>buckets</span> <span class=p>=</span> <span class=nx>h</span><span class=p>.</span><span class=nx>buckets</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>t</span><span class=p>.</span><span class=nx>Bucket</span><span class=p>.</span><span class=nx>PtrBytes</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>h</span><span class=p>.</span><span class=nf>createOverflow</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nx>it</span><span class=p>.</span><span class=nx>overflow</span> <span class=p>=</span> <span class=nx>h</span><span class=p>.</span><span class=nx>extra</span><span class=p>.</span><span class=nx>overflow</span>
</span></span><span class=line><span class=cl>        <span class=nx>it</span><span class=p>.</span><span class=nx>oldoverflow</span> <span class=p>=</span> <span class=nx>h</span><span class=p>.</span><span class=nx>extra</span><span class=p>.</span><span class=nx>oldoverflow</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// decide where to start
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>r</span> <span class=o>:=</span> <span class=nb>uintptr</span><span class=p>(</span><span class=nf>rand</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=nx>it</span><span class=p>.</span><span class=nx>startBucket</span> <span class=p>=</span> <span class=nx>r</span> <span class=o>&amp;</span> <span class=nf>bucketMask</span><span class=p>(</span><span class=nx>h</span><span class=p>.</span><span class=nx>B</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>it</span><span class=p>.</span><span class=nx>offset</span> <span class=p>=</span> <span class=nb>uint8</span><span class=p>(</span><span class=nx>r</span> <span class=o>&gt;&gt;</span> <span class=nx>h</span><span class=p>.</span><span class=nx>B</span> <span class=o>&amp;</span> <span class=p>(</span><span class=nx>bucketCnt</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// iterator state
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>it</span><span class=p>.</span><span class=nx>bucket</span> <span class=p>=</span> <span class=nx>it</span><span class=p>.</span><span class=nx>startBucket</span>
</span></span><span class=line><span class=cl>    <span class=nf>mapiternext</span><span class=p>(</span><span class=nx>it</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p><a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/map.go#L862 target=_blank rel=noopener>runtime.mapiternext</a> 函数的执行主要分为桶的选择和桶内元素遍历两部分：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>mapiternext</span><span class=p>(</span><span class=nx>it</span> <span class=o>*</span><span class=nx>hiter</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>h</span> <span class=o>:=</span> <span class=nx>it</span><span class=p>.</span><span class=nx>h</span>
</span></span><span class=line><span class=cl>    <span class=nx>t</span> <span class=o>:=</span> <span class=nx>it</span><span class=p>.</span><span class=nx>t</span>
</span></span><span class=line><span class=cl>    <span class=nx>bucket</span> <span class=o>:=</span> <span class=nx>it</span><span class=p>.</span><span class=nx>bucket</span>
</span></span><span class=line><span class=cl>    <span class=c1>// b 指向待遍历的桶
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>b</span> <span class=o>:=</span> <span class=nx>it</span><span class=p>.</span><span class=nx>bptr</span>                 
</span></span><span class=line><span class=cl>    <span class=nx>i</span> <span class=o>:=</span> <span class=nx>it</span><span class=p>.</span><span class=nx>i</span>
</span></span><span class=line><span class=cl>    <span class=nx>checkBucket</span> <span class=o>:=</span> <span class=nx>it</span><span class=p>.</span><span class=nx>checkBucket</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>next</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>b</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>bucket</span> <span class=o>==</span> <span class=nx>it</span><span class=p>.</span><span class=nx>startBucket</span> <span class=o>&amp;&amp;</span> <span class=nx>it</span><span class=p>.</span><span class=nx>wrapped</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 当不存在待遍历的桶时，结束迭代
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>it</span><span class=p>.</span><span class=nx>key</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>            <span class=nx>it</span><span class=p>.</span><span class=nx>elem</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>h</span><span class=p>.</span><span class=nf>growing</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=nx>it</span><span class=p>.</span><span class=nx>B</span> <span class=o>==</span> <span class=nx>h</span><span class=p>.</span><span class=nx>B</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 哈希表正在扩容中，处理扩容逻辑
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 待遍历的桶为空时，计算需要遍历的新桶地址
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>b</span> <span class=p>=</span> <span class=p>(</span><span class=o>*</span><span class=nx>bmap</span><span class=p>)(</span><span class=nf>add</span><span class=p>(</span><span class=nx>it</span><span class=p>.</span><span class=nx>buckets</span><span class=p>,</span> <span class=nx>bucket</span><span class=o>*</span><span class=nb>uintptr</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>BucketSize</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>            <span class=nx>checkBucket</span> <span class=p>=</span> <span class=nx>noCheck</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>bucket</span><span class=o>++</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>bucket</span> <span class=o>==</span> <span class=nf>bucketShift</span><span class=p>(</span><span class=nx>it</span><span class=p>.</span><span class=nx>B</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>bucket</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            <span class=nx>it</span><span class=p>.</span><span class=nx>wrapped</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>i</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>bucketCnt</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>offi</span> <span class=o>:=</span> <span class=p>(</span><span class=nx>i</span> <span class=o>+</span> <span class=nx>it</span><span class=p>.</span><span class=nx>offset</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=nx>bucketCnt</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 根据偏移量计算桶内键值对指针
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>k</span> <span class=o>:=</span> <span class=nf>add</span><span class=p>(</span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=nx>b</span><span class=p>),</span> <span class=nx>dataOffset</span><span class=o>+</span><span class=nb>uintptr</span><span class=p>(</span><span class=nx>offi</span><span class=p>)</span><span class=o>*</span><span class=nb>uintptr</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>KeySize</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=nx>e</span> <span class=o>:=</span> <span class=nf>add</span><span class=p>(</span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=nx>b</span><span class=p>),</span> <span class=nx>dataOffset</span><span class=o>+</span><span class=nx>bucketCnt</span><span class=o>*</span><span class=nb>uintptr</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>KeySize</span><span class=p>)</span><span class=o>+</span><span class=nb>uintptr</span><span class=p>(</span><span class=nx>offi</span><span class=p>)</span><span class=o>*</span><span class=nb>uintptr</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>ValueSize</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>checkBucket</span> <span class=o>!=</span> <span class=nx>noCheck</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>h</span><span class=p>.</span><span class=nf>sameSizeGrow</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 哈希表正在增量扩容中，处理扩容逻辑
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>b</span><span class=p>.</span><span class=nx>tophash</span><span class=p>[</span><span class=nx>offi</span><span class=p>]</span> <span class=o>!=</span> <span class=nx>evacuatedX</span> <span class=o>&amp;&amp;</span> <span class=nx>b</span><span class=p>.</span><span class=nx>tophash</span><span class=p>[</span><span class=nx>offi</span><span class=p>]</span> <span class=o>!=</span> <span class=nx>evacuatedY</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>            <span class=p>!(</span><span class=nx>t</span><span class=p>.</span><span class=nf>ReflexiveKey</span><span class=p>()</span> <span class=o>||</span> <span class=nx>t</span><span class=p>.</span><span class=nx>Key</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>k</span><span class=p>,</span> <span class=nx>k</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 目标元素未迁移，k 和 e 为准确数据，可以直接返回
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>it</span><span class=p>.</span><span class=nx>key</span> <span class=p>=</span> <span class=nx>k</span>
</span></span><span class=line><span class=cl>            <span class=nx>it</span><span class=p>.</span><span class=nx>elem</span> <span class=p>=</span> <span class=nx>e</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 目标元素已迁移，需要通过 runtime.mapaccessK 获取键值对
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>rk</span><span class=p>,</span> <span class=nx>re</span> <span class=o>:=</span> <span class=nf>mapaccessK</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>h</span><span class=p>,</span> <span class=nx>k</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>it</span><span class=p>.</span><span class=nx>key</span> <span class=p>=</span> <span class=nx>rk</span>
</span></span><span class=line><span class=cl>            <span class=nx>it</span><span class=p>.</span><span class=nx>elem</span> <span class=p>=</span> <span class=nx>re</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>it</span><span class=p>.</span><span class=nx>bucket</span> <span class=p>=</span> <span class=nx>bucket</span>
</span></span><span class=line><span class=cl>        <span class=nx>it</span><span class=p>.</span><span class=nx>i</span> <span class=p>=</span> <span class=nx>i</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=nx>it</span><span class=p>.</span><span class=nx>checkBucket</span> <span class=p>=</span> <span class=nx>checkBucket</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果当前桶已迭代完成，继续迭代溢出桶
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>b</span> <span class=p>=</span> <span class=nx>b</span><span class=p>.</span><span class=nf>overflow</span><span class=p>(</span><span class=nx>t</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>i</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>goto</span> <span class=nx>next</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>由此可见，哈希表的遍历过程为：首先随机选出一个正常桶开始遍历，然后遍历其所有的溢出桶，最后按照索引顺序遍历其他的正常桶和溢出桶，直到全部桶遍历完成。</p><p>哈希表遍历的随机性也会导致一些奇怪现象：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>m</span> <span class=p>=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>int</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;A&#34;</span><span class=p>:</span> <span class=mi>21</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;B&#34;</span><span class=p>:</span> <span class=mi>22</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;C&#34;</span><span class=p>:</span> <span class=mi>23</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>counter</span> <span class=o>:=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>k</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>m</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>counter</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>m</span><span class=p>[</span><span class=s>&#34;D&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=mi>20</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>counter</span><span class=o>++</span>
</span></span><span class=line><span class=cl>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>k</span><span class=p>,</span> <span class=nx>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>counter</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 可能的结果
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>$</span> <span class=k>go</span> <span class=nx>run</span> <span class=nx>main</span><span class=p>.</span><span class=k>go</span>
</span></span><span class=line><span class=cl><span class=nx>B</span> <span class=mi>22</span>
</span></span><span class=line><span class=cl><span class=nx>A</span> <span class=mi>21</span>
</span></span><span class=line><span class=cl><span class=nx>C</span> <span class=mi>23</span>
</span></span><span class=line><span class=cl><span class=mi>3</span>
</span></span></code></pre></td></tr></table></div></div></div><p>多次执行上述代码可能出现<code>counter</code>为 3 且输出结果不包含<code>D</code>的情况。这是因为遍历开始时随机选择的桶为空桶，而<code>D</code>又恰好插入了该桶。</p><h3 id=字符串><a href=#字符串 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:字符串 class=headings>字符串</a></h3><p>字符串的遍历过程与数组、切片和哈希表非常相似，只是会将字符串中的字节转换成<code>rune</code>类型。<code>for i, r := range s {}</code>的结构会被转换成如下所示的形式：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>ha</span> <span class=o>:=</span> <span class=nx>s</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>hv1</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>hv1</span> <span class=p>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>ha</span><span class=p>);</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>hv1t</span> <span class=o>:=</span> <span class=nx>hv1</span>
</span></span><span class=line><span class=cl>    <span class=nx>hv2</span> <span class=o>:=</span> <span class=nb>rune</span><span class=p>(</span><span class=nx>ha</span><span class=p>[</span><span class=nx>hv1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 当前字节是常规 ASCII 码，只占用一个字节长度
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>hv2</span> <span class=p>&lt;</span> <span class=nx>utf8</span><span class=p>.</span><span class=nx>RuneSelf</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>hv1</span><span class=o>++</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 占用多个字节，使用 runtime.decoderune 解码
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>hv2</span><span class=p>,</span> <span class=nx>hv1</span> <span class=p>=</span> <span class=nf>decoderune</span><span class=p>(</span><span class=nx>ha</span><span class=p>,</span> <span class=nx>hv1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>v1</span><span class=p>,</span> <span class=nx>v2</span> <span class=o>:=</span> <span class=nx>hv1t</span><span class=p>,</span> <span class=nx>hv2</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=管道><a href=#管道 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:管道 class=headings>管道</a></h3><p>使用<code>range</code>遍历管道也是比较常见的做法，一个形如<code>for v := range ch {}</code>的语句最终会被转换成如下的格式：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>ha</span> <span class=o>:=</span> <span class=nx>a</span>
</span></span><span class=line><span class=cl><span class=c1>// 从管道中取出等待处理的值并阻塞当前协程
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>hv1</span><span class=p>,</span> <span class=nx>hb</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>ha</span>
</span></span><span class=line><span class=cl><span class=c1>// 若当前值不存在，则管道已被关闭
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>for</span> <span class=p>;</span> <span class=nx>hb</span> <span class=o>!=</span> <span class=kc>false</span><span class=p>;</span> <span class=nx>hv1</span><span class=p>,</span> <span class=nx>hb</span> <span class=p>=</span> <span class=o>&lt;-</span><span class=nx>ha</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 若当前值存在，将其赋给 v1
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>v1</span> <span class=o>:=</span> <span class=nx>hv1</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 清除 hv1 中的数据，重新陷入阻塞等待新数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>hv1</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>这里的代码可能与编译器生成的稍微有一些出入，但是结构和效果是完全相同的。</p><h2 id=select><a href=#select class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:select class=headings>Select</a></h2><p>C 语言中的系统调用 <a href=/posts/concurrent-programming-note/#%E4%BD%BF%E7%94%A8-io-%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E5%AE%9E%E7%8E%B0%E5%B9%B6%E5%8F%91>select</a> 可以同时监听多个文件描述符的可读或者可写的状态，Go 语言中的<code>select</code>也能够让 Goroutine 同时等待多个管道可读或者可写。</p><p><code>select</code>是与<code>switch</code>相似的控制结构。与<code>switch</code>不同的是，<code>select</code>中虽然也有多个<code>case</code>，但是这些<code>case</code>中的表达式都必须是管道的收发操作。当<code>select</code>中的两个<code>case</code>同时触发时，会随机执行其中一个（避免饥饿问题的出现）。</p><h3 id=数据结构><a href=#数据结构 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:数据结构 class=headings>数据结构</a></h3><p>Go 语言的源代码中没有<code>select</code>对应的结构体，但其控制结构中的<code>case</code>关键字是由 <a href=https://github.com/golang/go/blob/29252e4c5a6fe19bc90fc8b335b3d1c29ae582cb/src/runtime/select.go#L19 target=_blank rel=noopener>runtime.scase</a> 结构体表示的：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>scase</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span>    <span class=o>*</span><span class=nx>hchan</span>         <span class=c1>// chan
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>elem</span> <span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span> <span class=c1>// data element
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>因为非<code>default</code>的<code>case</code>都与管道的发送和接收有关，所以该结构体中也包含了一个 <a href=https://github.com/golang/go/blob/29252e4c5a6fe19bc90fc8b335b3d1c29ae582cb/src/runtime/chan.go#L33 target=_blank rel=noopener>runtime.hchan</a> 类型的字段存储<code>case</code>中使用的管道。</p><h3 id=实现原理><a href=#实现原理 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:实现原理 class=headings>实现原理</a></h3><p>编译器在中间代码生成期间会根据以下四种情况对控制语句进行优化：</p><ol><li><code>select</code>不存在任何的<code>case</code>；</li><li><code>select</code>只存在一个<code>case</code>；</li><li><code>select</code>存在两个<code>case</code>，其中一个<code>case</code>是<code>default</code>；</li><li><code>select</code>存在多个<code>case</code>；</li></ol><p>上述过程均发生在 <a href=https://github.com/golang/go/blob/29252e4c5a6fe19bc90fc8b335b3d1c29ae582cb/src/cmd/compile/internal/walk/select.go#L33 target=_blank rel=noopener>cmd/compile/internal/walk.walkSelectCases</a> 函数中。</p><h4 id=直接阻塞><a href=#直接阻塞 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:直接阻塞 class=headings>直接阻塞</a></h4><p>如果<code>select</code>中不存在任何<code>case</code>：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>walkSelectCases</span><span class=p>(</span><span class=nx>cases</span> <span class=p>[]</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>CommClause</span><span class=p>)</span> <span class=p>[]</span><span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ncas</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>cases</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>ncas</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// mkcallstmt 调用 runtime.block 函数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=p>[]</span><span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=p>{</span><span class=nf>mkcallstmt</span><span class=p>(</span><span class=s>&#34;block&#34;</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>block</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 当前 Goroutine 让出对处理器的使用权
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 传入等待原因 waitReasonSelectNoCases
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>gopark</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>waitReasonSelectNoCases</span><span class=p>,</span> <span class=nx>traceBlockForever</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>因此，空的<code>select</code>语句会直接阻塞当前 Goroutine，导致其进入无法被唤醒的永久休眠状态。</p><h4 id=单一管道><a href=#单一管道 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:单一管道 class=headings>单一管道</a></h4><p>如果当前的<code>select</code>中只包含一个 <code>case</code>，那么编译器会将其改写为：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 改写前
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>case</span> <span class=nx>v</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>&lt;-</span><span class=nx>ch</span><span class=p>:</span> <span class=c1>// case ch &lt;- v
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>...</span>    
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 改写后
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=nx>ch</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 若 case 中的 ch 为空，当前 Goroutine 会被挂起并陷入永久休眠
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>block</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>v</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>ch</span> <span class=c1>// case ch &lt;- v
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>...</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=非阻塞操作><a href=#非阻塞操作 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:非阻塞操作 class=headings>非阻塞操作</a></h4><p>当<code>select</code>中仅包含两个 <code>case</code>，并且其中一个是 <code>default</code> 时，Go 语言的编译器就会认为这是一次非阻塞的收发操作。<a href=https://github.com/golang/go/blob/29252e4c5a6fe19bc90fc8b335b3d1c29ae582cb/src/cmd/compile/internal/walk/select.go#L33 target=_blank rel=noopener>cmd/compile/internal/walk.walkSelectCases</a> 会对这种情况单独处理。</p><h5 id=发送><a href=#发送 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:发送 class=headings>发送</a></h5><p>当<code>case</code>中表达式的类型是<code>OSEND</code>时，编译器会使用条件语句和 <a href=https://github.com/golang/go/blob/29252e4c5a6fe19bc90fc8b335b3d1c29ae582cb/src/runtime/chan.go#L693 target=_blank rel=noopener>runtime.selectnbsend</a> 函数改写代码：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 改写前
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>case</span> <span class=nx>ch</span> <span class=o>&lt;-</span> <span class=nx>v</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span> <span class=nx>foo</span>
</span></span><span class=line><span class=cl><span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span> <span class=nx>bar</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 改写后
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=nf>selectnbsend</span><span class=p>(</span><span class=nx>ch</span><span class=p>,</span> <span class=nx>v</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span> <span class=nx>foo</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span> <span class=nx>bar</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p><a href=https://github.com/golang/go/blob/29252e4c5a6fe19bc90fc8b335b3d1c29ae582cb/src/runtime/chan.go#L693 target=_blank rel=noopener>runtime.selectnbsend</a> 向 <a href=https://github.com/golang/go/blob/b4086b7c1668716c9a7b565b708ea49e1d35fadc/src/runtime/chan.go#L160 target=_blank rel=noopener>runtime.chansend</a> 函数传入的<code>block</code>参数为<code>false</code>，因此当无缓冲管道不存在等待的接收者或有缓冲管道的缓冲区空间不足时，当前 Goroutine 不会被阻塞而是直接返回。详见：<a href=/posts/go-concurrent-programming-note/#%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE>发送数据</a>。</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>selectnbsend</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>hchan</span><span class=p>,</span> <span class=nx>elem</span> <span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span><span class=p>)</span> <span class=p>(</span><span class=nx>selected</span> <span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>chansend</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span> <span class=nx>elem</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=nf>getcallerpc</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h5 id=接收><a href=#接收 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:接收 class=headings>接收</a></h5><p>当<code>case</code>中表达式的类型是<code>OSELRECV2</code>时，编译器会使用条件语句和 <a href=https://github.com/golang/go/blob/29252e4c5a6fe19bc90fc8b335b3d1c29ae582cb/src/runtime/chan.go#L713 target=_blank rel=noopener>runtime.selectnbrecv</a> 函数改写代码：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 改写前
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl><span class=k>case</span> <span class=nx>v</span><span class=p>,</span> <span class=nx>ok</span> <span class=p>=</span> <span class=o>&lt;-</span><span class=nx>c</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>    <span class=o>...</span> <span class=nx>foo</span>  
</span></span><span class=line><span class=cl><span class=k>default</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>    <span class=o>...</span> <span class=nx>bar</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 改写后
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=nx>selected</span><span class=p>,</span> <span class=nx>ok</span> <span class=p>=</span> <span class=nf>selectnbrecv</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>v</span><span class=p>,</span> <span class=nx>c</span><span class=p>);</span> <span class=nx>selected</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=o>...</span> <span class=nx>foo</span>  
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=o>...</span> <span class=nx>bar</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p><a href=https://github.com/golang/go/blob/29252e4c5a6fe19bc90fc8b335b3d1c29ae582cb/src/runtime/chan.go#L713 target=_blank rel=noopener>runtime.selectnbrecv</a> 向 <a href=https://github.com/golang/go/blob/b4086b7c1668716c9a7b565b708ea49e1d35fadc/src/runtime/chan.go#L457 target=_blank rel=noopener>runtime.chanrecv</a> 函数传入的<code>block</code>参数为<code>false</code>，因此当不存在等待的发送者且缓冲区中也没有数据时，当前 Goroutine 不会被阻塞而是直接返回。详见：<a href=/posts/go-concurrent-programming-note/#%E6%8E%A5%E6%94%B6%E6%95%B0%E6%8D%AE>接收数据</a>。</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>selectnbrecv</span><span class=p>(</span><span class=nx>elem</span> <span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span><span class=p>,</span> <span class=nx>c</span> <span class=o>*</span><span class=nx>hchan</span><span class=p>)</span> <span class=p>(</span><span class=nx>selected</span><span class=p>,</span> <span class=nx>received</span> <span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>chanrecv</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span> <span class=nx>elem</span><span class=p>,</span> <span class=kc>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=常见流程><a href=#常见流程 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:常见流程 class=headings>常见流程</a></h4><p>在默认的情况下，编译器会使用如下的流程处理<code>select</code>语句：</p><ol><li>将所有的<code>case</code>转换成包含管道和类型等信息的 <a href=https://github.com/golang/go/blob/29252e4c5a6fe19bc90fc8b335b3d1c29ae582cb/src/runtime/select.go#L19 target=_blank rel=noopener>runtime.scase</a> 结构体；</li><li>调用运行时函数 <a href=https://github.com/golang/go/blob/29252e4c5a6fe19bc90fc8b335b3d1c29ae582cb/src/runtime/select.go#L121 target=_blank rel=noopener>runtime.selectgo</a> 从多个准备就绪的管道中选择一个可执行的 <a href=https://github.com/golang/go/blob/29252e4c5a6fe19bc90fc8b335b3d1c29ae582cb/src/runtime/select.go#L19 target=_blank rel=noopener>runtime.scase</a> 结构体；</li><li>通过<code>for</code>循环生成一组<code>if</code>语句，在语句中判断自己是不是被选中的<code>case</code>。</li></ol><p>上述流程可以用示例代码表示：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>sel</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>scase</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>cases</span><span class=p>))</span>  
</span></span><span class=line><span class=cl><span class=nx>nsends</span><span class=p>,</span> <span class=nx>nrecvs</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span>  
</span></span><span class=line><span class=cl><span class=nx>dflt</span> <span class=o>:=</span> <span class=o>-</span><span class=mi>1</span>  
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>rc</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>cases</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>j</span> <span class=kt>int</span>  
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>dir</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>selectDefault</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>       <span class=nx>dflt</span> <span class=p>=</span> <span class=nx>i</span>  
</span></span><span class=line><span class=cl>       <span class=k>continue</span>  
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>selectSend</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>       <span class=nx>j</span> <span class=p>=</span> <span class=nx>nsends</span>  
</span></span><span class=line><span class=cl>       <span class=nx>nsends</span><span class=o>++</span>  
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>selectRecv</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>       <span class=nx>nrecvs</span><span class=o>++</span>  
</span></span><span class=line><span class=cl>       <span class=nx>j</span> <span class=p>=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>cases</span><span class=p>)</span> <span class=o>-</span> <span class=nx>nrecvs</span>  
</span></span><span class=line><span class=cl>    <span class=p>}</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=nx>sel</span><span class=p>[</span><span class=nx>j</span><span class=p>]</span> <span class=p>=</span> <span class=nx>scase</span><span class=p>{</span><span class=nx>c</span><span class=p>:</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>ch</span><span class=p>,</span> <span class=nx>elem</span><span class=p>:</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>val</span><span class=p>}</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>order</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>uint16</span><span class=p>,</span> <span class=mi>2</span><span class=o>*</span><span class=p>(</span><span class=nx>nsends</span><span class=o>+</span><span class=nx>nrecvs</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>pc0</span> <span class=o>*</span><span class=kt>uintptr</span>
</span></span><span class=line><span class=cl><span class=nx>chosen</span><span class=p>,</span> <span class=nx>recvOK</span> <span class=o>:=</span> <span class=nf>selectgo</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>sel</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=o>&amp;</span><span class=nx>order</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>pc0</span><span class=p>,</span> <span class=nx>nsends</span><span class=p>,</span> <span class=nx>nrecvs</span><span class=p>,</span> <span class=nx>dflt</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>chosen</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>break</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>chosen</span> <span class=o>==</span> <span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>break</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>chosen</span> <span class=o>==</span> <span class=nb>len</span><span class=p>(</span><span class=nx>cases</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>break</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=defer><a href=#defer class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:defer class=headings>Defer</a></h2><p>Go 语言的<code>defer</code>会在当前函数返回前执行传入的函数，经常用于关闭文件描述符、关闭数据库连接以及解锁资源。</p><h3 id=数据结构-1><a href=#数据结构-1 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:数据结构-1 class=headings>数据结构</a></h3><p><a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/runtime2.go#L1026 target=_blank rel=noopener>runtime._defer</a> 结构体是延迟调用链表中的一个元素，所有的结构体都会通过<code>link</code>字段串联成链表：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>_defer</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>heap</span>      <span class=kt>bool</span>
</span></span><span class=line><span class=cl>    <span class=nx>rangefunc</span> <span class=kt>bool</span>    <span class=c1>// true for rangefunc list
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>sp</span>        <span class=kt>uintptr</span> <span class=c1>// sp at time of defer
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>pc</span>        <span class=kt>uintptr</span> <span class=c1>// pc at time of defer
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fn</span>        <span class=kd>func</span><span class=p>()</span>  <span class=c1>// can be nil for open-coded defers
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>link</span>      <span class=o>*</span><span class=nx>_defer</span> <span class=c1>// next defer on G; can point to either heap or stack!
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// If rangefunc is true, *head is the head of the atomic linked list
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// during a range-over-func execution.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>head</span> <span class=o>*</span><span class=nx>atomic</span><span class=p>.</span><span class=nx>Pointer</span><span class=p>[</span><span class=nx>_defer</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p><img src=https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/20240818172027.png alt=20240818172027></p><p><code>fn</code>字段表示<code>defer</code>关键字传入的函数，曾经是<code>*funcval</code>类型，其指向的函数可以拥有任意签名。而在 <a href=https://go-review.googlesource.com/c/go/+/337650/3/src/runtime/runtime2.go target=_blank rel=noopener>runtime: use func() for deferred functions</a> 提交之后，该字段就变成了没有参数和返回值的<code>func()</code>类型。这是因为 Go 语言会在类型检查阶段调用 <a href=https://github.com/golang/go/blob/0a525a3ed0effd31749a0d56f9349cf533f90ce9/src/cmd/compile/internal/typecheck/stmt.go#L220 target=_blank rel=noopener>cmd/compile/internal/typecheck.normalizeGoDeferCall</a> 将<code>OGO</code>和<code>ODEFER</code>声明中形如<code>f(x, y)</code>的函数标准化为：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>x1</span><span class=p>,</span> <span class=nx>y1</span> <span class=o>:=</span> <span class=nx>x</span><span class=p>,</span> <span class=nx>y</span>          <span class=c1>// added to init
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span><span class=p>()</span> <span class=p>{</span> <span class=nf>f</span><span class=p>(</span><span class=nx>x1</span><span class=p>,</span> <span class=nx>y1</span><span class=p>)</span> <span class=p>}()</span>  <span class=c1>// result
</span></span></span></code></pre></td></tr></table></div></div></div><h3 id=执行机制><a href=#执行机制 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:执行机制 class=headings>执行机制</a></h3><p>中间代码生成阶段的 <a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/cmd/compile/internal/ssagen/ssa.go#L1431 target=_blank rel=noopener>cmd/compile/internal/ssagen.stmt</a> 负责处理程序中的<code>defer</code>关键字，该函数会根据情况使用三种不同的执行机制：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// stmt converts the statement n to SSA and adds it to s.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>state</span><span class=p>)</span> <span class=nf>stmt</span><span class=p>(</span><span class=nx>n</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=nx>n</span><span class=p>.</span><span class=nf>Op</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>ODEFER</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>n</span> <span class=o>:=</span> <span class=nx>n</span><span class=p>.(</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>GoDeferStmt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>s</span><span class=p>.</span><span class=nx>hasOpenDefers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>s</span><span class=p>.</span><span class=nf>openDeferRecord</span><span class=p>(</span><span class=nx>n</span><span class=p>.</span><span class=nx>Call</span><span class=p>.(</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>CallExpr</span><span class=p>))</span>  <span class=c1>// 开放编码
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>d</span> <span class=o>:=</span> <span class=nx>callDefer</span>  <span class=c1>// 堆中分配
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=nx>n</span><span class=p>.</span><span class=nf>Esc</span><span class=p>()</span> <span class=o>==</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>EscNever</span> <span class=o>&amp;&amp;</span> <span class=nx>n</span><span class=p>.</span><span class=nx>DeferAt</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>d</span> <span class=p>=</span> <span class=nx>callDeferStack</span>  <span class=c1>// 栈上分配
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nx>s</span><span class=p>.</span><span class=nf>call</span><span class=p>(</span><span class=nx>n</span><span class=p>.</span><span class=nx>Call</span><span class=p>.(</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>CallExpr</span><span class=p>),</span> <span class=nx>d</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>n</span><span class=p>.</span><span class=nx>DeferAt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><ul><li>早期的 Go 语言会在堆上分配 <a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/runtime2.go#L1026 target=_blank rel=noopener>runtime._defer</a> 结构体，不过实现的性能较差；</li><li>1.13 版本的 Go 语言引入栈上分配的<code>defer</code>，减少了 30% 的额外开销，详见：<a href=https://go-review.googlesource.com/c/go/+/171758 target=_blank rel=noopener>runtime: allocate defer records on the stack</a>；</li><li>1.14 版本的 Go 语言引入了基于开放编码的<code>defer</code>，使其额外开销可以忽略不计，详见：<a href=https://go-review.googlesource.com/c/go/+/190098/6 target=_blank rel=noopener>runtime: make defers low-cost through inline code and extra funcdata</a>。</li></ul><h3 id=堆中分配><a href=#堆中分配 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:堆中分配 class=headings>堆中分配</a></h3><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>unpredictableNumber</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span> <span class=c1>// Heap-allocated defer
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>编译器无法预测示例代码中循环的迭代次数，<a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/runtime2.go#L1026 target=_blank rel=noopener>runtime._defer</a> 的数量会在运行期间改变，因此该结构体只能在堆中分配。在编译器看来，<code>defer</code>也是函数调用，因此会执行 <a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/cmd/compile/internal/ssagen/ssa.go#L5299 target=_blank rel=noopener>cmd/compile/internal/ssagen.call</a> 为其生成中间代码：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>state</span><span class=p>)</span> <span class=nf>call</span><span class=p>(</span><span class=nx>n</span> <span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>CallExpr</span><span class=p>,</span> <span class=nx>k</span> <span class=nx>callKind</span><span class=p>,</span> <span class=nx>returnResultAddr</span> <span class=kt>bool</span><span class=p>,</span> <span class=nx>deferExtra</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>Expr</span><span class=p>)</span> <span class=o>*</span><span class=nx>ssa</span><span class=p>.</span><span class=nx>Value</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>call</span> <span class=o>*</span><span class=nx>ssa</span><span class=p>.</span><span class=nx>Value</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>switch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nx>k</span> <span class=o>==</span> <span class=nx>callDefer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 运行期间将调用 runtime.deferproc
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>sym</span> <span class=o>:=</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>Syms</span><span class=p>.</span><span class=nx>Deferproc</span>
</span></span><span class=line><span class=cl>            <span class=nx>aux</span> <span class=o>:=</span> <span class=nx>ssa</span><span class=p>.</span><span class=nf>StaticAuxCall</span><span class=p>(</span><span class=nx>sym</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>f</span><span class=p>.</span><span class=nx>ABIDefault</span><span class=p>.</span><span class=nf>ABIAnalyzeTypes</span><span class=p>(</span><span class=nx>ACArgs</span><span class=p>,</span> <span class=nx>ACResults</span><span class=p>))</span> 
</span></span><span class=line><span class=cl>            <span class=nx>call</span> <span class=p>=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>newValue0A</span><span class=p>(</span><span class=nx>ssa</span><span class=p>.</span><span class=nx>OpStaticLECall</span><span class=p>,</span> <span class=nx>aux</span><span class=p>.</span><span class=nf>LateExpansionResultType</span><span class=p>(),</span> <span class=nx>aux</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>Go 语言的编译器不仅将<code>defer</code>转换成了 <a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/panic.go#L271 target=_blank rel=noopener>runtime.deferproc</a>，还通过以下三个步骤为所有调用<code>defer</code>的函数末尾插入 <a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/panic.go#L592 target=_blank rel=noopener>runtime.deferreturn</a>：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// cmd/compile/internal/walk.walkStmt
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>walkStmt</span><span class=p>(</span><span class=nx>n</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=p>)</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=nx>n</span><span class=p>.</span><span class=nf>Op</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>ODEFER</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>n</span> <span class=o>:=</span> <span class=nx>n</span><span class=p>.(</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>GoDeferStmt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 设置当前函数的 hasdefer 属性
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>ir</span><span class=p>.</span><span class=nx>CurFunc</span><span class=p>.</span><span class=nf>SetHasDefer</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=k>fallthrough</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// cmd/compile/internal/ssagen.buildssa
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>buildssa</span><span class=p>(</span><span class=nx>fn</span> <span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>Func</span><span class=p>,</span> <span class=nx>worker</span> <span class=kt>int</span><span class=p>)</span> <span class=o>*</span><span class=nx>ssa</span><span class=p>.</span><span class=nx>Func</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>s</span> <span class=nx>state</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 更新 state 的 hasdefer 字段
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>s</span><span class=p>.</span><span class=nx>hasdefer</span> <span class=p>=</span> <span class=nx>fn</span><span class=p>.</span><span class=nf>HasDefer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// cmd/compile/internal/ssagen.exit
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>state</span><span class=p>)</span> <span class=nf>exit</span><span class=p>()</span> <span class=o>*</span><span class=nx>ssa</span><span class=p>.</span><span class=nx>Block</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>s</span><span class=p>.</span><span class=nx>hasdefer</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 在函数返回前插入 runtime.deferreturn
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>s</span><span class=p>.</span><span class=nf>rtcall</span><span class=p>(</span><span class=nx>ir</span><span class=p>.</span><span class=nx>Syms</span><span class=p>.</span><span class=nx>Deferreturn</span><span class=p>,</span> <span class=kc>true</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>上述两个函数是<code>defer</code>运行时机制的入口，分别承担了不同的工作：</p><ul><li><a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/panic.go#L271 target=_blank rel=noopener>runtime.deferproc</a> 负责创建新的延迟调用；</li><li><a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/panic.go#L592 target=_blank rel=noopener>runtime.deferreturn</a> 负责在函数调用结束时执行所有的延迟调用。</li></ul><h4 id=创建延迟调用><a href=#创建延迟调用 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:创建延迟调用 class=headings>创建延迟调用</a></h4><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>deferproc</span><span class=p>(</span><span class=nx>fn</span> <span class=kd>func</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>gp</span> <span class=o>:=</span> <span class=nf>getg</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>d</span> <span class=o>:=</span> <span class=nf>newdefer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将 _defer 追加到链表最前面
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>d</span><span class=p>.</span><span class=nx>link</span> <span class=p>=</span> <span class=nx>gp</span><span class=p>.</span><span class=nx>_defer</span>
</span></span><span class=line><span class=cl>    <span class=nx>gp</span><span class=p>.</span><span class=nx>_defer</span> <span class=p>=</span> <span class=nx>d</span>
</span></span><span class=line><span class=cl>    <span class=nx>d</span><span class=p>.</span><span class=nx>fn</span> <span class=p>=</span> <span class=nx>fn</span>
</span></span><span class=line><span class=cl>    <span class=nx>d</span><span class=p>.</span><span class=nx>pc</span> <span class=p>=</span> <span class=nf>getcallerpc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>d</span><span class=p>.</span><span class=nx>sp</span> <span class=p>=</span> <span class=nf>getcallersp</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>return0</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p><a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/panic.go#L501 target=_blank rel=noopener>runtime.newdefer</a> 的作用是想尽办法获得 <a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/runtime2.go#L1026 target=_blank rel=noopener>runtime._defer</a> 结构体，包含三种方式：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>newdefer</span><span class=p>()</span> <span class=o>*</span><span class=nx>_defer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>d</span> <span class=o>*</span><span class=nx>_defer</span>
</span></span><span class=line><span class=cl>    <span class=nx>mp</span> <span class=o>:=</span> <span class=nf>acquirem</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>pp</span> <span class=o>:=</span> <span class=nx>mp</span><span class=p>.</span><span class=nx>p</span><span class=p>.</span><span class=nf>ptr</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>pp</span><span class=p>.</span><span class=nx>deferpool</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>deferpool</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>lock</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>sched</span><span class=p>.</span><span class=nx>deferlock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=nb>len</span><span class=p>(</span><span class=nx>pp</span><span class=p>.</span><span class=nx>deferpool</span><span class=p>)</span> <span class=p>&lt;</span> <span class=nb>cap</span><span class=p>(</span><span class=nx>pp</span><span class=p>.</span><span class=nx>deferpool</span><span class=p>)</span><span class=o>/</span><span class=mi>2</span> <span class=o>&amp;&amp;</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>deferpool</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 从调度器的延迟调用缓存池 sched.deferpool 中取出 _defer
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>d</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>deferpool</span>
</span></span><span class=line><span class=cl>            <span class=nx>sched</span><span class=p>.</span><span class=nx>deferpool</span> <span class=p>=</span> <span class=nx>d</span><span class=p>.</span><span class=nx>link</span>
</span></span><span class=line><span class=cl>            <span class=nx>d</span><span class=p>.</span><span class=nx>link</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 并追加到当前 Goroutine 的缓存池中
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>pp</span><span class=p>.</span><span class=nx>deferpool</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>pp</span><span class=p>.</span><span class=nx>deferpool</span><span class=p>,</span> <span class=nx>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nf>unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>sched</span><span class=p>.</span><span class=nx>deferlock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>n</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>pp</span><span class=p>.</span><span class=nx>deferpool</span><span class=p>);</span> <span class=nx>n</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 从 Goroutine 的延迟调用缓存池 pp.deferpool 中取出 _defer
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>d</span> <span class=p>=</span> <span class=nx>pp</span><span class=p>.</span><span class=nx>deferpool</span><span class=p>[</span><span class=nx>n</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=nx>pp</span><span class=p>.</span><span class=nx>deferpool</span><span class=p>[</span><span class=nx>n</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>        <span class=nx>pp</span><span class=p>.</span><span class=nx>deferpool</span> <span class=p>=</span> <span class=nx>pp</span><span class=p>.</span><span class=nx>deferpool</span><span class=p>[:</span><span class=nx>n</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>releasem</span><span class=p>(</span><span class=nx>mp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>mp</span><span class=p>,</span> <span class=nx>pp</span> <span class=p>=</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>d</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 在堆上创建一个新的 _defer
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>d</span> <span class=p>=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>_defer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>d</span><span class=p>.</span><span class=nx>heap</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>d</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>无论使用哪种方式，<a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/runtime2.go#L1026 target=_blank rel=noopener>runtime._defer</a> 结构体都会被追加到所在 Goroutine <code>_defer</code>链表的最前面。<code>defer</code>关键字的插入顺序是从后向前的，而执行则是从前向后的，这也解释了为什么后调用的<code>defer</code>会先执行：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=mi>3</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>defer</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>$</span> <span class=k>go</span> <span class=nx>run</span> <span class=nx>main</span><span class=p>.</span><span class=k>go</span>
</span></span><span class=line><span class=cl><span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=mi>0</span>
</span></span></code></pre></td></tr></table></div></div></div><p>另外，<a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/panic.go#L271 target=_blank rel=noopener>runtime.deferproc</a> 在创建延迟调用时会立刻复制函数的参数，因此后者不会等到真正执行时计算：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=nx>n</span> <span class=o>:=</span> <span class=mi>1</span>  
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>n</span> <span class=o>==</span> <span class=mi>1</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>        <span class=k>defer</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>n</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>        <span class=nx>n</span> <span class=o>+=</span> <span class=mi>100</span>  
</span></span><span class=line><span class=cl>    <span class=p>}</span>  
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>n</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>$</span> <span class=k>go</span> <span class=nx>run</span> <span class=nx>main</span><span class=p>.</span><span class=k>go</span>
</span></span><span class=line><span class=cl><span class=mi>101</span>
</span></span><span class=line><span class=cl><span class=mi>1</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=执行延迟调用><a href=#执行延迟调用 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:执行延迟调用 class=headings>执行延迟调用</a></h4><p><a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/panic.go#L592 target=_blank rel=noopener>runtime.deferreturn</a> 会在函数返回之前执行 Goroutine <code>_defer</code>链表中注册的所有函数：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>deferreturn</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>p</span> <span class=nx>_panic</span>
</span></span><span class=line><span class=cl>    <span class=nx>p</span><span class=p>.</span><span class=nx>deferreturn</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>p</span><span class=p>.</span><span class=nf>start</span><span class=p>(</span><span class=nf>getcallerpc</span><span class=p>(),</span> <span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=nf>getcallersp</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 获取下一个要执行的 defer 函数
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>fn</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>nextDefer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 若没有更多的 defer 函数要执行，则退出循环
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 执行 defer 函数
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>fn</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=栈上分配><a href=#栈上分配 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:栈上分配 class=headings>栈上分配</a></h3><p>当<code>defer</code>在函数体中最多执行一次时，<a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/runtime2.go#L1026 target=_blank rel=noopener>runtime._defer</a> 会在编译期间被分配到栈上：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// cmd/compile/internal/ssagen.call
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>state</span><span class=p>)</span> <span class=nf>call</span><span class=p>(</span><span class=nx>n</span> <span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>CallExpr</span><span class=p>,</span> <span class=nx>k</span> <span class=nx>callKind</span><span class=p>,</span> <span class=nx>returnResultAddr</span> <span class=kt>bool</span><span class=p>,</span> <span class=nx>deferExtra</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>Expr</span><span class=p>)</span> <span class=o>*</span><span class=nx>ssa</span><span class=p>.</span><span class=nx>Value</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>call</span> <span class=o>*</span><span class=nx>ssa</span><span class=p>.</span><span class=nx>Value</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>k</span> <span class=o>==</span> <span class=nx>callDeferStack</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 在栈上初始化 defer 结构体
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>t</span> <span class=o>:=</span> <span class=nf>deferstruct</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 运行期间将调用 runtime.deferprocStack 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>ACArgs</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>ACArgs</span><span class=p>,</span> <span class=nx>types</span><span class=p>.</span><span class=nx>Types</span><span class=p>[</span><span class=nx>types</span><span class=p>.</span><span class=nx>TUINTPTR</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=nx>aux</span> <span class=o>:=</span> <span class=nx>ssa</span><span class=p>.</span><span class=nf>StaticAuxCall</span><span class=p>(</span><span class=nx>ir</span><span class=p>.</span><span class=nx>Syms</span><span class=p>.</span><span class=nx>DeferprocStack</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>f</span><span class=p>.</span><span class=nx>ABIDefault</span><span class=p>.</span><span class=nf>ABIAnalyzeTypes</span><span class=p>(</span><span class=nx>ACArgs</span><span class=p>,</span> <span class=nx>ACResults</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=nx>callArgs</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>callArgs</span><span class=p>,</span> <span class=nx>addr</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nf>mem</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=nx>call</span> <span class=p>=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>newValue0A</span><span class=p>(</span><span class=nx>ssa</span><span class=p>.</span><span class=nx>OpStaticLECall</span><span class=p>,</span> <span class=nx>aux</span><span class=p>.</span><span class=nf>LateExpansionResultType</span><span class=p>(),</span> <span class=nx>aux</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>call</span><span class=p>.</span><span class=nf>AddArgs</span><span class=p>(</span><span class=nx>callArgs</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>call</span><span class=p>.</span><span class=nx>AuxInt</span> <span class=p>=</span> <span class=nb>int64</span><span class=p>(</span><span class=nx>types</span><span class=p>.</span><span class=nx>PtrSize</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p><a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/panic.go#L462 target=_blank rel=noopener>runtime.deferprocStack</a> 只需要设置一些未在编译期间初始化的字段，就可以把<code>defer</code>结构体追加到 Goroutine 的延迟调用链表中：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>deferprocStack</span><span class=p>(</span><span class=nx>d</span> <span class=o>*</span><span class=nx>_defer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>gp</span> <span class=o>:=</span> <span class=nf>getg</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>d</span><span class=p>.</span><span class=nx>heap</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=nx>d</span><span class=p>.</span><span class=nx>rangefunc</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=nx>d</span><span class=p>.</span><span class=nx>sp</span> <span class=p>=</span> <span class=nf>getcallersp</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>d</span><span class=p>.</span><span class=nx>pc</span> <span class=p>=</span> <span class=nf>getcallerpc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// The lines below implement:
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//   d.panic = nil
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//   d.fd = nil
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//   d.link = gp._defer
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//   d.head = nil
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//   gp._defer = d
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=kt>uintptr</span><span class=p>)(</span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>d</span><span class=p>.</span><span class=nx>link</span><span class=p>))</span> <span class=p>=</span> <span class=nb>uintptr</span><span class=p>(</span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=nx>gp</span><span class=p>.</span><span class=nx>_defer</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=kt>uintptr</span><span class=p>)(</span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>d</span><span class=p>.</span><span class=nx>head</span><span class=p>))</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=kt>uintptr</span><span class=p>)(</span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>gp</span><span class=p>.</span><span class=nx>_defer</span><span class=p>))</span> <span class=p>=</span> <span class=nb>uintptr</span><span class=p>(</span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=nx>d</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>return0</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>除了分配位置不同，栈上分配和堆中分配并没有本质区别，前者可以适用于绝大多数场景。</p><h3 id=开放编码><a href=#开放编码 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:开放编码 class=headings>开放编码</a></h3><p>开放编码将<code>defer</code>调用直接内联到函数末尾以及汇编代码中每一个返回语句之前，仅在满足以下条件时启用：</p><ul><li>函数的<code>defer</code>数量少于或者等于 8 个；</li><li>函数的<code>defer</code>关键字不能在循环中执行；</li><li>函数的<code>return</code>语句与<code>defer</code>语句的乘积小于或者等于 15 个。</li></ul><p>否则，最终生成的二进制代码将会非常臃肿。除上述几个条件外，也有其他条件会限制开放编码的使用。不过它们都是不太重要的细节，这里不会深究。</p><h4 id=启用优化><a href=#启用优化 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:启用优化 class=headings>启用优化</a></h4><p>Go 语言会在编译期间决定是否启用开放编码。在编译器生成中间代码之前，<a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/cmd/compile/internal/walk/stmt.go#L15 target=_blank rel=noopener>cmd/compile/internal/walk.walkStmt</a> 会 <a href=/posts/go-compiler-principle-note/#%E9%81%8D%E5%8E%86%E5%92%8C%E6%9B%BF%E6%8D%A2>修改已经生成的抽象语法树</a>，设置函数体上的<code>OpenCodedDeferDisallowed</code>属性：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>walkStmt</span><span class=p>(</span><span class=nx>n</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=p>)</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>ODEFER</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 函数的 defer 数量大于 8
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>CurFunc</span><span class=p>.</span><span class=nx>NumDefers</span> <span class=p>&gt;</span> <span class=nx>maxOpenDefers</span> <span class=o>||</span> <span class=nx>n</span><span class=p>.</span><span class=nx>DeferAt</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>ir</span><span class=p>.</span><span class=nx>CurFunc</span><span class=p>.</span><span class=nf>SetOpenCodedDeferDisallowed</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// defer 在循环中出现
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=nx>n</span><span class=p>.</span><span class=nf>Esc</span><span class=p>()</span> <span class=o>!=</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>EscNever</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>ir</span><span class=p>.</span><span class=nx>CurFunc</span><span class=p>.</span><span class=nf>SetOpenCodedDeferDisallowed</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>fallthrough</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>我们在 SSA 中间代码生成阶段的 <a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/cmd/compile/internal/ssagen/ssa.go#L293C6-L293C14 target=_blank rel=noopener>cmd/compile/internal/ssagen.buildssa</a> 函数中也能够看到启用开放编码优化的其他条件：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>buildssa</span><span class=p>(</span><span class=nx>fn</span> <span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>Func</span><span class=p>,</span> <span class=nx>worker</span> <span class=kt>int</span><span class=p>)</span> <span class=o>*</span><span class=nx>ssa</span><span class=p>.</span><span class=nx>Func</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>s</span><span class=p>.</span><span class=nx>hasOpenDefers</span> <span class=p>=</span> <span class=nx>base</span><span class=p>.</span><span class=nx>Flag</span><span class=p>.</span><span class=nx>N</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>s</span><span class=p>.</span><span class=nx>hasdefer</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>s</span><span class=p>.</span><span class=nx>curfn</span><span class=p>.</span><span class=nf>OpenCodedDeferDisallowed</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>s</span><span class=p>.</span><span class=nx>hasOpenDefers</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// return 和 defer 语句数量的乘积大于 15
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>s</span><span class=p>.</span><span class=nx>curfn</span><span class=p>.</span><span class=nx>NumReturns</span><span class=o>*</span><span class=nx>s</span><span class=p>.</span><span class=nx>curfn</span><span class=p>.</span><span class=nx>NumDefers</span> <span class=p>&gt;</span> <span class=mi>15</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>s</span><span class=p>.</span><span class=nx>hasOpenDefers</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h4 id=延迟记录><a href=#延迟记录 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:延迟记录 class=headings>延迟记录</a></h4><p>延迟比特和延迟记录是使用开放编码实现<code>defer</code>的两个最重要结构，Go 语言会在编译期间调用 <a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/cmd/compile/internal/ssagen/ssa.go#L435 target=_blank rel=noopener>cmd/compile/internal/ssagen.buildssa</a> 在栈上初始化大小为 8 个比特的<code>deferBits</code>变量。</p><p>该变量中的每个比特位都表示对应的<code>defer</code>关键字是否需要被执行。如下图所示，倒数第二个比特位被设置成了 1，那么其对应的函数将在函数返回前执行：</p><p><img src=https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/20240818172235.png alt=20240818172235></p><p>编译器还会通过 <a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/cmd/compile/internal/ssagen/ssa.go#L5136 target=_blank rel=noopener>cmd/compile/internal/ssagen.openDeferRecord</a> 添加代码以评估和存储<code>defer</code>调用的函数，并记录有关<code>defer</code>的信息。传入<code>defer</code>的函数和参数存储在 <a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/cmd/compile/internal/ssagen/ssa.go#L827 target=_blank rel=noopener>cmd/compile/internal/ssagen.openDeferInfo</a> 结构体中：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>state</span><span class=p>)</span> <span class=nf>openDeferRecord</span><span class=p>(</span><span class=nx>n</span> <span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>CallExpr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>opendefer</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>openDeferInfo</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>n</span><span class=p>:</span> <span class=nx>n</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>fn</span> <span class=o>:=</span> <span class=nx>n</span><span class=p>.</span><span class=nx>Fun</span>
</span></span><span class=line><span class=cl>    <span class=nx>closureVal</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>expr</span><span class=p>(</span><span class=nx>fn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>closure</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>openDeferSave</span><span class=p>(</span><span class=nx>fn</span><span class=p>.</span><span class=nf>Type</span><span class=p>(),</span> <span class=nx>closureVal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>opendefer</span><span class=p>.</span><span class=nx>closureNode</span> <span class=p>=</span> <span class=nx>closure</span><span class=p>.</span><span class=nx>Aux</span><span class=p>.(</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>!(</span><span class=nx>fn</span><span class=p>.</span><span class=nf>Op</span><span class=p>()</span> <span class=o>==</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>ONAME</span> <span class=o>&amp;&amp;</span> <span class=nx>fn</span><span class=p>.(</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>Name</span><span class=p>).</span><span class=nx>Class</span> <span class=o>==</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>PFUNC</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>opendefer</span><span class=p>.</span><span class=nx>closure</span> <span class=p>=</span> <span class=nx>closure</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>index</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>openDefers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>s</span><span class=p>.</span><span class=nx>openDefers</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>openDefers</span><span class=p>,</span> <span class=nx>opendefer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>bitvalue</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>constInt8</span><span class=p>(</span><span class=nx>types</span><span class=p>.</span><span class=nx>Types</span><span class=p>[</span><span class=nx>types</span><span class=p>.</span><span class=nx>TUINT8</span><span class=p>],</span> <span class=mi>1</span><span class=o>&lt;&lt;</span><span class=nb>uint</span><span class=p>(</span><span class=nx>index</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>newDeferBits</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>newValue2</span><span class=p>(</span><span class=nx>ssa</span><span class=p>.</span><span class=nx>OpOr8</span><span class=p>,</span> <span class=nx>types</span><span class=p>.</span><span class=nx>Types</span><span class=p>[</span><span class=nx>types</span><span class=p>.</span><span class=nx>TUINT8</span><span class=p>],</span> <span class=nx>s</span><span class=p>.</span><span class=nf>variable</span><span class=p>(</span><span class=nx>deferBitsVar</span><span class=p>,</span> <span class=nx>types</span><span class=p>.</span><span class=nx>Types</span><span class=p>[</span><span class=nx>types</span><span class=p>.</span><span class=nx>TUINT8</span><span class=p>]),</span> <span class=nx>bitvalue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>s</span><span class=p>.</span><span class=nx>vars</span><span class=p>[</span><span class=nx>deferBitsVar</span><span class=p>]</span> <span class=p>=</span> <span class=nx>newDeferBits</span>
</span></span><span class=line><span class=cl>    <span class=nx>s</span><span class=p>.</span><span class=nf>store</span><span class=p>(</span><span class=nx>types</span><span class=p>.</span><span class=nx>Types</span><span class=p>[</span><span class=nx>types</span><span class=p>.</span><span class=nx>TUINT8</span><span class=p>],</span> <span class=nx>s</span><span class=p>.</span><span class=nx>deferBitsAddr</span><span class=p>,</span> <span class=nx>newDeferBits</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>在函数返回前，<a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/cmd/compile/internal/ssagen/ssa.go#L5219 target=_blank rel=noopener>cmd/compile/internal/ssagen.openDeferExit</a> 将处理所有使用开放编码优化的<code>defer</code>关键字，检查延迟比特的每个位以确定是否执行了相应的<code>defer</code>语句：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// cmd/compile/internal/ssagen.exit
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>state</span><span class=p>)</span> <span class=nf>exit</span><span class=p>()</span> <span class=o>*</span><span class=nx>ssa</span><span class=p>.</span><span class=nx>Block</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>s</span><span class=p>.</span><span class=nx>hasdefer</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>s</span><span class=p>.</span><span class=nx>hasOpenDefers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span> 
</span></span><span class=line><span class=cl>            <span class=nx>s</span><span class=p>.</span><span class=nf>openDeferExit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span> 
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>上述优化过程可以用伪码表示为：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>deferBits</span> <span class=o>:=</span> <span class=mi>0</span>               <span class=c1>// 初始化延迟比特
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>deferBits</span> <span class=o>|=</span> <span class=mi>1</span><span class=o>&lt;&lt;</span><span class=mi>0</span>            <span class=c1>// 延迟比特最后一位设为 1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>_f1</span><span class=p>,</span> <span class=nx>_a1</span> <span class=o>:=</span> <span class=nx>f1</span><span class=p>,</span> <span class=nx>a1</span>           <span class=c1>// 保存函数及参数
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>condition</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>deferBits</span> <span class=o>|=</span> <span class=mi>1</span><span class=o>&lt;&lt;</span><span class=mi>1</span>        <span class=c1>// 若条件满足，延迟比特倒数第二位设为 1
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>_f2</span><span class=p>,</span> <span class=nx>_a2</span> <span class=o>:=</span> <span class=nx>f2</span><span class=p>,</span> <span class=nx>a2</span>       <span class=c1>// 保存函数及参数
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>exit</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>deferBits</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=o>&lt;&lt;</span><span class=mi>1</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>   <span class=c1>// 00000011 &amp; 00000010 != 0
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>deferBits</span> <span class=o>&amp;^=</span> <span class=mi>1</span><span class=o>&lt;&lt;</span><span class=mi>1</span>       <span class=c1>// 将倒数第二位复原为 0 以进行下一次判断
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>_f2</span><span class=p>(</span><span class=nx>_a2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>deferBits</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=o>&lt;&lt;</span><span class=mi>0</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>   <span class=c1>// 00000001 &amp; 00000001 != 0
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>deferBits</span> <span class=o>&amp;^=</span> <span class=mi>1</span><span class=o>&lt;&lt;</span><span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=nf>_f1</span><span class=p>(</span><span class=nx>_a1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>综上所述，开放编码使用延迟比特和 <a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/cmd/compile/internal/ssagen/ssa.go#L827 target=_blank rel=noopener>cmd/compile/internal/ssagen.openDeferInfo</a> 结构体存储<code>defer</code>的相关信息，将其直接在当前函数内展开，并在返回前根据延迟比特位决定是否执行调用。这种方法只使用了少量的位运算指令和内存资源，因此性能最好。</p><h2 id=panic--recover><a href=#panic--recover class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:panic--recover class=headings>Panic & Recover</a></h2><ul><li><code>panic</code>能够改变程序的控制流。调用<code>panic</code>后会立刻停止执行当前函数的剩余代码，并递归执行当前 Goroutine 中的<code>defer</code>；</li><li><code>recover</code>可以中止<code>panic</code>造成的程序崩溃，不过只能在<code>defer</code>中发挥作用。</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>badCall</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;bad end&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>test</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>e</span> <span class=o>:=</span> <span class=nb>recover</span><span class=p>();</span> <span class=nx>e</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Panicing %s\r\n&#34;</span><span class=p>,</span> <span class=nx>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl>    <span class=nf>badCall</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;After bad call\r\n&#34;</span><span class=p>)</span> <span class=c1>// 无法到达
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Calling test\r\n&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>test</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Test completed\r\n&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>$</span> <span class=k>go</span> <span class=nx>run</span> <span class=nx>main</span><span class=p>.</span><span class=k>go</span>
</span></span><span class=line><span class=cl><span class=nx>Calling</span> <span class=nx>test</span>
</span></span><span class=line><span class=cl><span class=nx>Panicing</span> <span class=nx>bad</span> <span class=nx>end</span>
</span></span><span class=line><span class=cl><span class=nx>Test</span> <span class=nx>completed</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=数据结构-2><a href=#数据结构-2 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:数据结构-2 class=headings>数据结构</a></h3><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>_panic</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>argp</span> <span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span> <span class=c1>// 指向发生 panic 时执行 defer 调用的参数的指针
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>arg</span>  <span class=nx>any</span>            <span class=c1>// panic 的参数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>link</span> <span class=o>*</span><span class=nx>_panic</span>        <span class=c1>// 指向更早的 runtime._panic
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// 调用 _panic.start 时的程序计数器和栈指针
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>startPC</span> <span class=kt>uintptr</span>
</span></span><span class=line><span class=cl>    <span class=nx>startSP</span> <span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 调用 defer 时的栈帧
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>sp</span> <span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span>
</span></span><span class=line><span class=cl>    <span class=nx>lr</span> <span class=kt>uintptr</span>
</span></span><span class=line><span class=cl>    <span class=nx>fp</span> <span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 存储 panic 应当跳转回去的程序计数器位置
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>retpc</span> <span class=kt>uintptr</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 用于处理开放编码优化的 defer
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>deferBitsPtr</span> <span class=o>*</span><span class=kt>uint8</span>
</span></span><span class=line><span class=cl>    <span class=nx>slotsPtr</span>     <span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>recovered</span>   <span class=kt>bool</span>    <span class=c1>// 是否已经被 recover 恢复
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>goexit</span>      <span class=kt>bool</span>    <span class=c1>// 保证 rutime.Goexit 不会被 defer 中的
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=c1>// panic 和 recover 取消
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>deferreturn</span> <span class=kt>bool</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p><a href=https://github.com/golang/go/blob/0a525a3ed0effd31749a0d56f9349cf533f90ce9/src/runtime/runtime2.go#L1047 target=_blank rel=noopener>runtime._panic</a> 中的<code>link</code>字段与 <a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/runtime2.go#L1026 target=_blank rel=noopener>runtime._defer</a> 类似，因此<code>panic</code>关键字也支持嵌套调用：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;in main&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;panic again and again&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}()</span>
</span></span><span class=line><span class=cl>        <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;panic again&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;panic once&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>$</span> <span class=k>go</span> <span class=nx>run</span> <span class=nx>main</span><span class=p>.</span><span class=k>go</span>
</span></span><span class=line><span class=cl><span class=nx>in</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl><span class=nx>panic</span><span class=p>:</span> <span class=nx>panic</span> <span class=nx>once</span>
</span></span><span class=line><span class=cl>    <span class=nx>panic</span><span class=p>:</span> <span class=nx>panic</span> <span class=nx>again</span>
</span></span><span class=line><span class=cl>    <span class=nx>panic</span><span class=p>:</span> <span class=nx>panic</span> <span class=nx>again</span> <span class=nx>and</span> <span class=nx>again</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>goroutine</span> <span class=mi>1</span> <span class=p>[</span><span class=nx>running</span><span class=p>]:</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=nx>exit</span> <span class=nx>status</span> <span class=mi>2</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=程序崩溃><a href=#程序崩溃 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:程序崩溃 class=headings>程序崩溃</a></h3><p>编译器会将关键字<code>panic</code>转换成 <a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/panic.go#L720 target=_blank rel=noopener>runtime.gopanic</a>：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>gopanic</span><span class=p>(</span><span class=nx>e</span> <span class=nx>any</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 初始化 runtime._panic
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>var</span> <span class=nx>p</span> <span class=nx>_panic</span>
</span></span><span class=line><span class=cl>    <span class=nx>p</span><span class=p>.</span><span class=nx>arg</span> <span class=p>=</span> <span class=nx>e</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>runningPanicDefers</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// *_panic.start 设置 _panic 结构体的字段
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 并将其添加到所在 Goroutine _panic 链表的最前端
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>p</span><span class=p>.</span><span class=nf>start</span><span class=p>(</span><span class=nf>getcallerpc</span><span class=p>(),</span> <span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=nf>getcallersp</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 不断从当前 Goroutine _defer 链表中获取并执行 defer 调用
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>fn</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>nextDefer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nf>fn</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>preprintpanics</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 终止整个程序
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>fatalpanic</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>p</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=kt>int</span><span class=p>)(</span><span class=kc>nil</span><span class=p>)</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>该函数最后调用的 <a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/panic.go#L1217 target=_blank rel=noopener>runtime.fatalpanic</a> 实现了无法被恢复的程序崩溃：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>fatalpanic</span><span class=p>(</span><span class=nx>msgs</span> <span class=o>*</span><span class=nx>_panic</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>pc</span> <span class=o>:=</span> <span class=nf>getcallerpc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>sp</span> <span class=o>:=</span> <span class=nf>getcallersp</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>gp</span> <span class=o>:=</span> <span class=nf>getg</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>docrash</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>    <span class=nf>systemstack</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nf>startpanic_m</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=nx>msgs</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>runningPanicDefers</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 打印全部 panic 消息以及调用时传入的参数
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nf>printpanics</span><span class=p>(</span><span class=nx>msgs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>docrash</span> <span class=p>=</span> <span class=nf>dopanic_m</span><span class=p>(</span><span class=nx>gp</span><span class=p>,</span> <span class=nx>pc</span><span class=p>,</span> <span class=nx>sp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>docrash</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>crash</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 退出当前程序并返回错误码 2
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>systemstack</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=kt>int</span><span class=p>)(</span><span class=kc>nil</span><span class=p>)</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=崩溃恢复><a href=#崩溃恢复 class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:崩溃恢复 class=headings>崩溃恢复</a></h3><p>编译器会将关键字<code>recover</code>转换为 <a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/panic.go#L984 target=_blank rel=noopener>runtime.gorecover</a>：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>gorecover</span><span class=p>(</span><span class=nx>argp</span> <span class=kt>uintptr</span><span class=p>)</span> <span class=nx>any</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>gp</span> <span class=o>:=</span> <span class=nf>getg</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>p</span> <span class=o>:=</span> <span class=nx>gp</span><span class=p>.</span><span class=nx>_panic</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>p</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>p</span><span class=p>.</span><span class=nx>goexit</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>p</span><span class=p>.</span><span class=nx>recovered</span> <span class=o>&amp;&amp;</span> <span class=nx>argp</span> <span class=o>==</span> <span class=nb>uintptr</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>argp</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 修改 runtime._panic 的 recovered 字段
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>p</span><span class=p>.</span><span class=nx>recovered</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 返回 panic 的参数
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=nx>p</span><span class=p>.</span><span class=nx>arg</span> 
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p><code>p != nil</code>：如果当前 Goroutine 没有<code>panic</code>，该函数将返回<code>nil</code>。因此，<code>recover</code>只能在<code>defer</code>调用中生效：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;in main&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nb>recover</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;unknown err&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>$</span> <span class=k>go</span> <span class=nx>run</span> <span class=nx>main</span><span class=p>.</span><span class=k>go</span>
</span></span><span class=line><span class=cl><span class=nx>in</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl><span class=nx>panic</span><span class=p>:</span> <span class=nx>unknown</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>goroutine</span> <span class=mi>1</span> <span class=p>[</span><span class=nx>running</span><span class=p>]:</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=nx>exit</span> <span class=nx>status</span> <span class=mi>2</span>
</span></span></code></pre></td></tr></table></div></div></div><p><code>argp == uintptr(p.argp)</code>：<a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/panic.go#L984 target=_blank rel=noopener>runtime.gorecover</a> 的参数<code>argp</code>是当前栈帧的栈指针，而<code>p.argp</code>则是发生<code>panic</code>时执行<code>defer</code>调用的参数的指针。因此，下面两段代码，第一段的<code>panic</code>可以<code>recover</code>，第二段则不会：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 第一段
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// argp 为 匿名函数的栈指针
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nb>recover</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl>    <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;ooo&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 第二段
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// argp 为 main 函数的栈指针
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>defer</span> <span class=nb>recover</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;ooo&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p><a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/panic.go#L984 target=_blank rel=noopener>runtime.gorecover</a> 中并不包含恢复程序的逻辑，这项工作是由 <a href=https://github.com/golang/go/blob/0a525a3ed0effd31749a0d56f9349cf533f90ce9/src/runtime/panic.go#L1063 target=_blank rel=noopener>runtime.recovery</a> 完成的：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>gopanic</span><span class=p>(</span><span class=nx>e</span> <span class=nx>any</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>fn</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>nextDefer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nf>fn</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>_panic</span><span class=p>)</span> <span class=nf>nextDefer</span><span class=p>()</span> <span class=p>(</span><span class=kd>func</span><span class=p>(),</span> <span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>gp</span> <span class=o>:=</span> <span class=nf>getg</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>!</span><span class=nx>p</span><span class=p>.</span><span class=nx>deferreturn</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>gp</span><span class=p>.</span><span class=nx>_panic</span> <span class=o>!=</span> <span class=nx>p</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>throw</span><span class=p>(</span><span class=s>&#34;bad panic stack&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>p</span><span class=p>.</span><span class=nx>recovered</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>mcall</span><span class=p>(</span><span class=nx>recovery</span><span class=p>)</span> <span class=c1>// 不会返回
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nf>throw</span><span class=p>(</span><span class=s>&#34;recovery failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>recovery</span><span class=p>(</span><span class=nx>gp</span> <span class=o>*</span><span class=nx>g</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>p</span> <span class=o>:=</span> <span class=nx>gp</span><span class=p>.</span><span class=nx>_panic</span>
</span></span><span class=line><span class=cl>    <span class=nx>pc</span><span class=p>,</span> <span class=nx>sp</span><span class=p>,</span> <span class=nx>fp</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>retpc</span><span class=p>,</span> <span class=nb>uintptr</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>sp</span><span class=p>),</span> <span class=nb>uintptr</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>fp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>p0</span><span class=p>,</span> <span class=nx>saveOpenDeferState</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nx>deferBitsPtr</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=o>*</span><span class=nx>p</span><span class=p>.</span><span class=nx>deferBitsPtr</span> <span class=o>!=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>gp</span><span class=p>.</span><span class=nx>sched</span><span class=p>.</span><span class=nx>sp</span> <span class=p>=</span> <span class=nx>sp</span>
</span></span><span class=line><span class=cl>    <span class=nx>gp</span><span class=p>.</span><span class=nx>sched</span><span class=p>.</span><span class=nx>pc</span> <span class=p>=</span> <span class=nx>pc</span>
</span></span><span class=line><span class=cl>    <span class=nx>gp</span><span class=p>.</span><span class=nx>sched</span><span class=p>.</span><span class=nx>lr</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将函数的返回值设置为 1
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>gp</span><span class=p>.</span><span class=nx>sched</span><span class=p>.</span><span class=nx>ret</span> <span class=p>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 根据 pc 和 sp 跳回 defer 关键字调用的位置
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>gogo</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>gp</span><span class=p>.</span><span class=nx>sched</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p><code>runtime.deferproc</code>的 <a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/panic.go#L288 target=_blank rel=noopener>注释</a> 表明，当函数的返回值为 1 时，编译器生成的代码会直接跳转到 <a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/panic.go#L592 target=_blank rel=noopener>runtime.deferreturn</a> 并恢复到正常的执行流程。</p><h2 id=make--new><a href=#make--new class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:make--new class=headings>Make & New</a></h2><ul><li><code>make</code>：初始化内置的数据结构，如切片、哈希表和管道；</li><li><code>new</code>：根据传入的类型分配一片内存空间并返回指向这片内存空间的指针；</li></ul><h3 id=make><a href=#make class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:make class=headings>Make</a></h3><p>在类型检查阶段，编译器会将代表<code>make</code>关键字的<code>OMAKE</code>节点根据参数类型转换成<code>OMAKESLICE</code>、<code>OMAKEMAP</code>和<code>OMAKECHAN</code>三种不同的节点。这些节点调用不同的运行时函数初始化对应的数据结构。</p><h3 id=new><a href=#new class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:new class=headings>New</a></h3><p>编译器在中间代码生成的 <a href=/posts/go-compiler-principle-note/#%E9%81%8D%E5%8E%86%E5%92%8C%E6%9B%BF%E6%8D%A2>遍历和替换</a> 阶段调用 <a href=https://github.com/golang/go/blob/0a525a3ed0effd31749a0d56f9349cf533f90ce9/src/cmd/compile/internal/walk/expr.go#L83 target=_blank rel=noopener>cmd/compile/internal/walk.walkExpr1</a> 和 <a href=https://github.com/golang/go/blob/0a525a3ed0effd31749a0d56f9349cf533f90ce9/src/cmd/compile/internal/walk/builtin.go#L521 target=_blank rel=noopener>cmd/compile/internal/walk.walkNew</a> 决定变量的分配方式：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>walkExpr1</span><span class=p>(</span><span class=nx>n</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=p>,</span> <span class=nx>init</span> <span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>Nodes</span><span class=p>)</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=nx>n</span><span class=p>.</span><span class=nf>Op</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>ONEW</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>n</span> <span class=o>:=</span> <span class=nx>n</span><span class=p>.(</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>UnaryExpr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nf>walkNew</span><span class=p>(</span><span class=nx>n</span><span class=p>,</span> <span class=nx>init</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>walkNew</span><span class=p>(</span><span class=nx>n</span> <span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>UnaryExpr</span><span class=p>,</span> <span class=nx>init</span> <span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>Nodes</span><span class=p>)</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=nx>t</span> <span class=o>:=</span> <span class=nx>n</span><span class=p>.</span><span class=nf>Type</span><span class=p>().</span><span class=nf>Elem</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>    <span class=c1>// 该类型无法分配到堆上
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>t</span><span class=p>.</span><span class=nf>NotInHeap</span><span class=p>()</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>       <span class=nx>base</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;%v can&#39;t be allocated in Go; it is incomplete (or unallocatable)&#34;</span><span class=p>,</span> <span class=nx>n</span><span class=p>.</span><span class=nf>Type</span><span class=p>().</span><span class=nf>Elem</span><span class=p>())</span>  
</span></span><span class=line><span class=cl>    <span class=p>}</span>  
</span></span><span class=line><span class=cl>    <span class=c1>// 变量没有逃逸到堆上
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>n</span><span class=p>.</span><span class=nf>Esc</span><span class=p>()</span> <span class=o>==</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>EscNone</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>        <span class=c1>// 类型的大小超过了编译器允许的隐式栈变量的最大大小
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=k>if</span> <span class=nx>t</span><span class=p>.</span><span class=nf>Size</span><span class=p>()</span> <span class=p>&gt;</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>MaxImplicitStackVarSize</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>          <span class=nx>base</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;large ONEW with EscNone: %v&#34;</span><span class=p>,</span> <span class=nx>n</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>       <span class=p>}</span>  
</span></span><span class=line><span class=cl>       <span class=c1>// 在栈上分配变量 tmp 并将 &amp;tmp 表达式附加到 init
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=k>return</span> <span class=nf>stackTempAddr</span><span class=p>(</span><span class=nx>init</span><span class=p>,</span> <span class=nx>t</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>    <span class=p>}</span>  
</span></span><span class=line><span class=cl>    <span class=c1>// 计算类型的大小和对齐方式
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>types</span><span class=p>.</span><span class=nf>CalcSize</span><span class=p>(</span><span class=nx>t</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>    <span class=nx>n</span><span class=p>.</span><span class=nf>MarkNonNil</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>n</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>如果变量需要被分配到堆上，<code>new</code>关键字后续将由 <a href=https://github.com/golang/go/blob/0a525a3ed0effd31749a0d56f9349cf533f90ce9/src/cmd/compile/internal/ssagen/ssa.go#L2755 target=_blank rel=noopener>cmd/compile/internal/ssagen.*state.expr</a> 等函数处理：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>state</span><span class=p>)</span> <span class=nf>expr</span><span class=p>(</span><span class=nx>n</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=p>)</span> <span class=o>*</span><span class=nx>ssa</span><span class=p>.</span><span class=nx>Value</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>s</span><span class=p>.</span><span class=nf>exprCheckPtr</span><span class=p>(</span><span class=nx>n</span><span class=p>,</span> <span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>state</span><span class=p>)</span> <span class=nf>exprCheckPtr</span><span class=p>(</span><span class=nx>n</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=p>,</span> <span class=nx>checkPtrOK</span> <span class=kt>bool</span><span class=p>)</span> <span class=o>*</span><span class=nx>ssa</span><span class=p>.</span><span class=nx>Value</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=nx>n</span><span class=p>.</span><span class=nf>Op</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>ONEW</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>n</span> <span class=o>:=</span> <span class=nx>n</span><span class=p>.(</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>UnaryExpr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>rtype</span> <span class=o>*</span><span class=nx>ssa</span><span class=p>.</span><span class=nx>Value</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>x</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>n</span><span class=p>.</span><span class=nx>X</span><span class=p>.(</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>DynamicType</span><span class=p>);</span> <span class=nx>ok</span> <span class=o>&amp;&amp;</span> <span class=nx>x</span><span class=p>.</span><span class=nf>Op</span><span class=p>()</span> <span class=o>==</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>ODYNAMICTYPE</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>rtype</span> <span class=p>=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>expr</span><span class=p>(</span><span class=nx>x</span><span class=p>.</span><span class=nx>RType</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>s</span><span class=p>.</span><span class=nf>newObject</span><span class=p>(</span><span class=nx>n</span><span class=p>.</span><span class=nf>Type</span><span class=p>().</span><span class=nf>Elem</span><span class=p>(),</span> <span class=nx>rtype</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>state</span><span class=p>)</span> <span class=nf>newObject</span><span class=p>(</span><span class=nx>typ</span> <span class=o>*</span><span class=nx>types</span><span class=p>.</span><span class=nx>Type</span><span class=p>,</span> <span class=nx>rtype</span> <span class=o>*</span><span class=nx>ssa</span><span class=p>.</span><span class=nx>Value</span><span class=p>)</span> <span class=o>*</span><span class=nx>ssa</span><span class=p>.</span><span class=nx>Value</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=c1>// 若申请的空间为 0，则返回一个表示空指针的 Zerobase
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>typ</span><span class=p>.</span><span class=nf>Size</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>       <span class=k>return</span> <span class=nx>s</span><span class=p>.</span><span class=nf>newValue1A</span><span class=p>(</span><span class=nx>ssa</span><span class=p>.</span><span class=nx>OpAddr</span><span class=p>,</span> <span class=nx>types</span><span class=p>.</span><span class=nf>NewPtr</span><span class=p>(</span><span class=nx>typ</span><span class=p>),</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>Syms</span><span class=p>.</span><span class=nx>Zerobase</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>sb</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>    <span class=p>}</span>  
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>rtype</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>       <span class=nx>rtype</span> <span class=p>=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>reflectType</span><span class=p>(</span><span class=nx>typ</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将关键字转换为 runtime.Newobject
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=nx>s</span><span class=p>.</span><span class=nf>rtcall</span><span class=p>(</span><span class=nx>ir</span><span class=p>.</span><span class=nx>Syms</span><span class=p>.</span><span class=nx>Newobject</span><span class=p>,</span> <span class=kc>true</span><span class=p>,</span> <span class=p>[]</span><span class=o>*</span><span class=nx>types</span><span class=p>.</span><span class=nx>Type</span><span class=p>{</span><span class=nx>types</span><span class=p>.</span><span class=nf>NewPtr</span><span class=p>(</span><span class=nx>typ</span><span class=p>)},</span> <span class=nx>rtype</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p><a href=https://github.com/golang/go/blob/0a525a3ed0effd31749a0d56f9349cf533f90ce9/src/runtime/malloc.go#L1389 target=_blank rel=noopener>runtime.newobject</a> 根据传入类型所占空间的大小，调用 <a href=https://github.com/golang/go/blob/0a525a3ed0effd31749a0d56f9349cf533f90ce9/src/runtime/malloc.go#L971 target=_blank rel=noopener>runtime.mallocgc</a> 在堆中申请一块内存并返回指向它的指针：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>newobject</span><span class=p>(</span><span class=nx>typ</span> <span class=o>*</span><span class=nx>_type</span><span class=p>)</span> <span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>mallocgc</span><span class=p>(</span><span class=nx>typ</span><span class=p>.</span><span class=nx>Size_</span><span class=p>,</span> <span class=nx>typ</span><span class=p>,</span> <span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>使用<code>var</code>关键字初始化变量的过程与之类似：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// cmd/compile/internal/ssagen.*state.stmt
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>state</span><span class=p>)</span> <span class=nf>stmt</span><span class=p>(</span><span class=nx>n</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=nx>n</span><span class=p>.</span><span class=nf>Op</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>ODCL</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>n</span> <span class=o>:=</span> <span class=nx>n</span><span class=p>.(</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>Decl</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 若变量逃逸到堆上
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=nx>v</span> <span class=o>:=</span> <span class=nx>n</span><span class=p>.</span><span class=nx>X</span><span class=p>;</span> <span class=nx>v</span><span class=p>.</span><span class=nf>Esc</span><span class=p>()</span> <span class=o>==</span> <span class=nx>ir</span><span class=p>.</span><span class=nx>EscHeap</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>s</span><span class=p>.</span><span class=nf>newHeapaddr</span><span class=p>(</span><span class=nx>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// cmd/compile/internal/ssagen.*state.newHeapaddr
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>state</span><span class=p>)</span> <span class=nf>newHeapaddr</span><span class=p>(</span><span class=nx>n</span> <span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>s</span><span class=p>.</span><span class=nf>setHeapaddr</span><span class=p>(</span><span class=nx>n</span><span class=p>.</span><span class=nf>Pos</span><span class=p>(),</span> <span class=nx>n</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nf>newObject</span><span class=p>(</span><span class=nx>n</span><span class=p>.</span><span class=nf>Type</span><span class=p>(),</span> <span class=kc>nil</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=future-work><a href=#future-work class=anchor-link><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:future-work class=headings>Future Work</a></h2><ul><li><del>在阅读源码时发现了书中未提到的 <a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/panic.go#L373 target=_blank rel=noopener>runtime.deferrangefunc</a> 和 <a href=https://github.com/golang/go/blob/cb4eee693c382bea4222f20837e26501d40ed892/src/runtime/panic.go#L402 target=_blank rel=noopener>runtime.deferprocat</a> 函数，它们的作用是什么？</del> 两者用于实现 Go 1.22 版本的新特性：<a href=https://go.dev/wiki/RangefuncExperiment target=_blank rel=noopener>Go Wiki: Rangefunc Experiment</a>；</li></ul></div><p class=edit-page><a href=https://github.com/koktlzz/koktlzz.github.io/blob/main/content/posts/go-%20common-keywords-note.md><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2"><path d="M17 3a2.828 2.828.0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>Edit this page on GitHub</a></p></article><script src=https://giscus.app/client.js data-repo=koktlzz/koktlzz.github.io data-repo-id=R_kgDOGRJFtw data-category=Announcements data-category-id=DIC_kwDOGRJFt84CTCRR data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div></main><div id=back-to-top class=back-to-top><a href=#><svg viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6.0-33.9L207 39c9.4-9.4 24.6-9.4 33.9.0l194.3 194.3c9.4 9.4 9.4 24.6.0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3.0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a></div><footer id=footer class=footer><div class=footer-inner><div class=site-info>©&nbsp;2020–2024&nbsp;<svg viewBox="0 0 512 512" class="icon footer-icon"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3.0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>&nbsp;koktlzz</div><div class=powered-by>Powered by <a href=https://github.com/gohugoio/hugo target=_blank rel=noopener>Hugo</a> | Theme is <a href=https://github.com/reuixiy/hugo-theme-meme target=_blank rel=noopener>MemE</a></div><div class=site-copyright><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en target=_blank rel=noopener>CC BY-NC-SA 4.0</a></div><ul class=socials><li class=socials-item><a href=/rss.xml target=_blank rel="external noopener" title=RSS><svg viewBox="0 0 24 24" class="icon social-icon"><path d="M19.199 24C19.199 13.467 10.533 4.8.0 4.8V0c13.165.0 24 10.835 24 24h-4.801zM3.291 17.415c1.814.0 3.293 1.479 3.293 3.295.0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526.0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727.0 15.909 7.184 15.909 15.91z"/></svg></a></li><li class=socials-item><a href=mailto:gwrhnu@163.com target=_blank rel="external noopener" title=Email><svg viewBox="0 0 512 512" class="icon social-icon"><path d="M464 64H48C21.49 64 0 85.49.0 112v288c0 26.51 21.49 48 48 48h416c26.51.0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm0 48v40.805c-22.422 18.259-58.168 46.651-134.587 106.49-16.841 13.247-50.201 45.072-73.413 44.701-23.208.375-56.579-31.459-73.413-44.701C106.18 199.465 70.425 171.067 48 152.805V112h416zM48 4e2V214.398c22.914 18.251 55.409 43.862 104.938 82.646 21.857 17.205 60.134 55.186 103.062 54.955 42.717.231 80.509-37.199 103.053-54.947 49.528-38.783 82.032-64.401 104.947-82.653V4e2H48z"/></svg></a></li><li class=socials-item><a href=https://github.com/koktlzz target=_blank rel="external noopener" title=GitHub><svg viewBox="0 0 24 24" class="icon social-icon"><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a></li></ul></div></footer></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.css integrity="sha256-gPJfuwTULrEAAcI3X4bALVU/2qBU+QY/TpoD3GO+Exw=" crossorigin=anonymous><script>if(typeof renderMathInElement=="undefined"){var getScript=e=>{var t=document.createElement("script");t.defer=!0,t.crossOrigin="anonymous",Object.keys(e).forEach(n=>{t[n]=e[n]}),document.body.appendChild(t)};getScript({src:"https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.js",integrity:"sha256-YTW9cMncW/ZQMhY69KaUxIa2cPTxV87Uh627Gf5ODUw=",onload:()=>{getScript({src:"https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/contrib/mhchem.min.js",integrity:"sha256-yzSfYeVsWJ1x+2g8CYHsB/Mn7PcSp8122k5BM4T3Vxw=",onload:()=>{getScript({src:"https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/contrib/auto-render.min.js",integrity:"sha256-fxJzNV6hpc8tgW8tF0zVobKa71eTCRGTgxFXt1ZpJNM=",onload:()=>{renderKaTex()}})}})}})}else renderKaTex();function renderKaTex(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}]})}</script><script src=https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js></script><script>let imgNodes=document.querySelectorAll("div.post-body img");imgNodes=Array.from(imgNodes).filter(e=>e.parentNode.tagName!=="A"),mediumZoom(imgNodes,{background:"hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)"})</script><script src=https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js type=module defer></script></body></html>