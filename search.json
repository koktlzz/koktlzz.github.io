[{"content":" åŸä¹¦ä¸­çš„ä»£ç ç‰‡æ®µåŸºäº Go 1.15ï¼Œç¬”è®°åˆ™æ ¹æ® Go 1.22 ç‰ˆæœ¬çš„æ›´æ–°è¿›è¡Œäº†ç›¸åº”æ›¿æ¢ã€‚\næ•°ç»„ æˆ‘ä»¬é€šå¸¸ä¼šä»ä¸¤ä¸ªç»´åº¦æè¿°æ•°ç»„ï¼šæ•°ç»„ä¸­å­˜å‚¨çš„å…ƒç´ ç±»å‹ï¼ˆTypeï¼‰å’Œæ•°ç»„æœ€å¤§èƒ½å­˜å‚¨çš„å…ƒç´ ä¸ªæ•°ï¼ˆBoundï¼‰ã€‚\n1 2 3 4 type Array struct { Elem *Type // element type Bound int64 // number of elements; \u003c0 if unknown yet } Go è¯­è¨€æ•°ç»„åœ¨åˆå§‹åŒ–ä¹‹åå¤§å°å°±æ— æ³•æ”¹å˜ã€‚å­˜å‚¨å…ƒç´ ç±»å‹ç›¸åŒã€ä½†å¤§å°ä¸åŒçš„æ•°ç»„ç±»å‹åœ¨ Go è¯­è¨€çœ‹æ¥ä¹Ÿæ˜¯å®Œå…¨ä¸åŒçš„ï¼Œåªæœ‰ä¸¤ä¸ªæ¡ä»¶éƒ½ç›¸åŒæ‰æ˜¯åŒä¸€ç±»å‹ã€‚\nç¼–è¯‘æœŸé—´çš„æ•°ç»„ç±»å‹æ˜¯ç”±Â cmd/compile/internal/types.NewArrayÂ å‡½æ•°ç”Ÿæˆçš„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 func NewArray(elem *Type, bound int64) *Type { if bound \u003c 0 { base.Fatalf(\"NewArray: invalid bound %v\", bound) } t := newType(TARRAY) t.extra = \u0026Array{Elem: elem, Bound: bound} if elem.HasShape() { t.SetHasShape(true) } return t } åˆå§‹åŒ– Go è¯­è¨€çš„æ•°ç»„æœ‰ä¸¤ç§ä¸åŒçš„åˆ›å»ºæ–¹å¼ï¼Œä¸€ç§æ˜¯æ˜¾å¼çš„æŒ‡å®šæ•°ç»„å¤§å°ï¼Œå¦ä¸€ç§æ˜¯ä½¿ç”¨[...]Tå£°æ˜æ•°ç»„ã€‚å¦‚ä¸‹ä¸¤ç§å£°æ˜æ–¹å¼åœ¨è¿è¡ŒæœŸé—´å¾—åˆ°çš„ç»“æœæ˜¯å®Œå…¨ç›¸åŒçš„ï¼š\n1 2 arr1 := [3]int{1, 2, 3} arr2 := [...]int{1, 2, 3} ä¸è¿‡ç¬¬ä¸€ç§æ–¹å¼å£°æ˜çš„æ•°ç»„çš„å¤§å°åœ¨ [[ç¼–è¯‘åŸç†#ç±»å‹æ£€æŸ¥|ç±»å‹æ£€æŸ¥]] é˜¶æ®µå°±ä¼šè¢«æå–å‡ºæ¥ï¼Œè€Œç¬¬äºŒç§æ–¹å¼åˆ™éœ€è¦ç¼–è¯‘å™¨é€šè¿‡éå†å…ƒç´ æ¥è®¡ç®—ã€‚å› æ­¤ï¼Œ[...]TÂ è¿™ç§åˆå§‹åŒ–æ–¹å¼å…¶å®æ˜¯ Go è¯­è¨€ä¸ºæˆ‘ä»¬æä¾›çš„ä¸€ç§è¯­æ³•ç³–ã€‚\nå¯¹äºä¸€ä¸ªç”±å­—é¢é‡ï¼ˆLiteralï¼‰ç»„æˆçš„æ•°ç»„ï¼Œæ ¹æ®æ•°ç»„å…ƒç´ æ•°é‡çš„ä¸åŒï¼Œç¼–è¯‘å™¨ä¼šåœ¨è´Ÿè´£åˆå§‹åŒ–å­—é¢é‡çš„Â cmd/compile/internal/walk.anylitÂ å‡½æ•°ä¸­åšä¸¤ç§ä¸åŒçš„ä¼˜åŒ–ï¼š\nå½“å…ƒç´ æ•°é‡å°äºæˆ–è€…ç­‰äº 4 ä¸ªæ—¶ï¼Œä¼šç›´æ¥å°†æ•°ç»„ä¸­çš„å…ƒç´ æ”¾ç½®åœ¨æ ˆä¸Šï¼› å½“å…ƒç´ æ•°é‡å¤§äº 4 ä¸ªæ—¶ï¼Œä¼šå°†æ•°ç»„ä¸­çš„å…ƒç´ æ”¾ç½®åˆ°é™æ€åŒºå¹¶åœ¨è¿è¡Œæ—¶å¤åˆ¶åˆ°æ ˆä¸­ã€‚ ä¸¾ä¾‹æ¥è¯´ï¼Œ[3]int{1, 2, 3}ä¼šè¢«æ‹†åˆ†æˆä¸€ä¸ªå£°æ˜å˜é‡çš„è¡¨è¾¾å¼å’Œå‡ ä¸ªèµ‹å€¼è¡¨è¾¾å¼ï¼š\n1 2 3 4 var arr [3]int arr[0] = 1 arr[1] = 2 arr[2] = 3 è€Œ[5]int{1, 2, 3, 4, 5}çš„åˆå§‹åŒ–è¿‡ç¨‹åˆ™ç­‰æ•ˆäºå¦‚ä¸‹ä¼ªç ï¼š\n1 2 3 4 5 6 7 8 var arr [5]int // å…ƒç´ å­˜å‚¨äºé™æ€åŒº statictmp_0[0] = 1 statictmp_0[1] = 2 statictmp_0[2] = 3 statictmp_0[3] = 4 statictmp_0[4] = 5 arr = statictmp_0 è®¿é—®å’Œèµ‹å€¼ æ— è®ºæ˜¯åœ¨æ ˆä¸Šè¿˜æ˜¯é™æ€å­˜å‚¨åŒºï¼Œæ•°ç»„åœ¨å†…å­˜ä¸­éƒ½æ˜¯ä¸€è¿ä¸²çš„å†…å­˜ç©ºé—´ï¼Œæˆ‘ä»¬é€šè¿‡æŒ‡å‘æ•°ç»„å¼€å¤´çš„æŒ‡é’ˆã€å…ƒç´ çš„æ•°é‡ä»¥åŠå…ƒç´ ç±»å‹å çš„ç©ºé—´å¤§å°è¡¨ç¤ºæ•°ç»„ã€‚\nGo è¯­è¨€ä¸­å¯ä»¥åœ¨ç¼–è¯‘æœŸé—´çš„é™æ€ç±»å‹æ£€æŸ¥åˆ¤æ–­æ•°ç»„è¶Šç•Œï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨å˜é‡å»è®¿é—®æ•°ç»„æˆ–è€…å­—ç¬¦ä¸²æ—¶ï¼Œæˆ‘ä»¬å°±éœ€è¦ Go è¯­è¨€è¿è¡Œæ—¶é˜»æ­¢ä¸åˆæ³•çš„è®¿é—®ï¼š\n1 2 3 4 // é™æ€ç±»å‹æ£€æŸ¥ arr[4]: invalid argument: index 4 out of bounds [0:3] // è¿è¡Œæ—¶ runtime.panicIndex arr[i]: panic: runtime error: index out of range [4] with length 3 åˆ‡ç‰‡ åˆ‡ç‰‡ï¼Œå³åŠ¨æ€æ•°ç»„ï¼Œå…¶é•¿åº¦å¹¶ä¸å›ºå®šï¼Œæ‰€ä»¥å£°æ˜æ—¶åªéœ€è¦æŒ‡å®šåˆ‡ç‰‡ä¸­çš„å…ƒç´ ç±»å‹ï¼š\n1 2 []int []interface{} ç¼–è¯‘æœŸé—´çš„åˆ‡ç‰‡æ˜¯Â cmd/compile/internal/types.SliceÂ ç±»å‹çš„ï¼Œåªç¡®å®šäº†å…ƒç´ çš„ç±»å‹ï¼š\n1 2 3 type Slice struct { Elem *Type // element type } åœ¨è¿è¡Œæ—¶åˆ™ç”± internal/unsafeheader.Slice ç»“æ„ä½“è¡¨ç¤ºï¼š\n1 2 3 4 5 type SliceHeader struct { Data unsafe.Pointer // æŒ‡å‘åº•å±‚æ•°ç»„çš„æŒ‡é’ˆ Len int // å½“å‰åˆ‡ç‰‡çš„é•¿åº¦ Cap int // å½“å‰åˆ‡ç‰‡çš„å®¹é‡ï¼Œå³åº•å±‚æ•°ç»„çš„å¤§å° } ç”±äºå¤§é‡å¼€å‘è€…ä½¿ç”¨ reflect.StringHeader å’Œ reflect.SliceHeader å®ç°é›¶å¤åˆ¶çš„å­—ç¬¦ä¸²/å­—èŠ‚æ•°ç»„è½¬æ¢è€Œäº§ç”Ÿè¯¸å¤šå†…å­˜æ³„éœ²é—®é¢˜ï¼Œä¸¤è€…åœ¨ Go 1.20 ç‰ˆæœ¬ä¸­è¢«å¼ƒç”¨ï¼Œè¯¦è§ï¼šunsafe: add StringData, String, SliceDataã€‚åˆ‡ç‰‡å’Œå­—ç¬¦ä¸²çš„è¿è¡Œæ—¶è¡¨ç¤ºç›®å‰ä¸ºï¼šunsafeheader.Slice å’Œ unsafeheader.Stringï¼ŒåŒºåˆ«åœ¨äºDataå­—æ®µçš„ç±»å‹ç”±uintptræ”¹ä¸ºunsafe.Pointerã€‚\nå› æ­¤æˆ‘ä»¬å¯ä»¥å°†åˆ‡ç‰‡ç†è§£æˆä¸€ç‰‡è¿ç»­çš„å†…å­˜ç©ºé—´ï¼ˆåº•å±‚æ•°ç»„ï¼‰ä»¥åŠé•¿åº¦ä¸å®¹é‡çš„æ ‡è¯†ï¼š\n![[Pasted image 20221201224650.png]]\nåˆå§‹åŒ– Go è¯­è¨€ä¸­æ”¯æŒä¸‰ç§åˆå§‹åŒ–åˆ‡ç‰‡çš„æ–¹å¼ï¼š\n1 2 3 arr[0:3] or slice[0:3] // é€šè¿‡ä¸‹æ ‡è·å–æ•°ç»„æˆ–åˆ‡ç‰‡çš„ä¸€éƒ¨åˆ† slice := []int{1, 2, 3} // ä½¿ç”¨å­—é¢é‡åˆå§‹åŒ–æ–°åˆ‡ç‰‡ slice := make([]int, 10) // ä½¿ç”¨å…³é”®å­— make åˆ›å»ºåˆ‡ç‰‡ ä½¿ç”¨ä¸‹æ ‡ ä½¿ç”¨ä¸‹æ ‡åˆå§‹åŒ–åˆ‡ç‰‡ä¸ä¼šå¤åˆ¶åŸæ•°ç»„æˆ–è€…åŸåˆ‡ç‰‡ä¸­çš„æ•°æ®ï¼Œå®ƒåªä¼šåˆ›å»ºä¸€ä¸ªæŒ‡å‘åŸæ•°ç»„çš„åˆ‡ç‰‡ç»“æ„ä½“ï¼Œæ‰€ä»¥ä¿®æ”¹æ–°åˆ‡ç‰‡çš„æ•°æ®ä¹Ÿä¼šä¿®æ”¹åŸåˆ‡ç‰‡ã€‚è¿™ç§æ“ä½œæ˜¯æ‰€æœ‰åˆ›å»ºåˆ‡ç‰‡çš„æ–¹æ³•ä¸­æœ€ä¸ºåº•å±‚çš„ã€‚\nä½¿ç”¨å­—é¢é‡ å½“æˆ‘ä»¬ä½¿ç”¨å­—é¢é‡[]int{1, 2, 3}åˆ›å»ºæ–°çš„åˆ‡ç‰‡æ—¶ï¼Œcmd/compile/internal/walk.slicelitÂ å‡½æ•°ä¼šåœ¨ç¼–è¯‘æœŸé—´å°†å®ƒå±•å¼€æˆå¦‚ä¸‹æ‰€ç¤ºçš„ä»£ç ç‰‡æ®µï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // æ ¹æ®åˆ‡ç‰‡å…ƒç´ æ•°é‡åˆ›å»ºåº•å±‚æ•°ç»„ var vstat [3]int // å°†å­—é¢é‡å…ƒç´ å­˜å‚¨åˆ°åˆå§‹åŒ–çš„æ•°ç»„ä¸­ // å¦‚ vstat[0] = 1 vstat = constpart{} // åˆ›å»ºä¸€ä¸ªæŒ‡å‘Â [3]intÂ ç±»å‹çš„æ•°ç»„æŒ‡é’ˆ // å¹¶åœ¨å †ä¸Šä¸ºå…¶åˆ†é…å†…å­˜ var vauto *[3]int = new([3]int) // å°†æ•°ç»„Â vstat å¤åˆ¶åˆ°Â vauto æŒ‡å‘çš„æ•°ç»„ // æ³¨æ„ï¼ŒGo è¯­è¨€çš„æ•°ç»„åæ˜¯å€¼è€Œé C ä¸­çš„éšå¼æŒ‡é’ˆ *vauto = vstat vauto[i] = dynamic part // é€šè¿‡Â [:] æ“ä½œè·å–ä¸€ä¸ªåº•å±‚ä½¿ç”¨Â vauto çš„åˆ‡ç‰‡ slice := vauto[:] æœ€åä¸€æ­¥å®é™…ä¸Šå°±æ˜¯ä½¿ç”¨ä¸‹æ ‡åˆ›å»ºåˆ‡ç‰‡ã€‚\nä½¿ç”¨ make ä¸å…¶ä»–ä¸¤ç§æ–¹æ³•ç›¸æ¯”ï¼Œä½¿ç”¨makeå…³é”®å­—åˆ›å»ºåˆ‡ç‰‡æ—¶ï¼Œå¾ˆå¤šå·¥ä½œéœ€è¦è¿è¡Œæ—¶çš„å‚ä¸ã€‚ç±»å‹æ£€æŸ¥æœŸé—´çš„ cmd/compile/internal/typecheck.typecheck1Â å‡½æ•°ä¼šæ ¡éªŒlenæ˜¯å¦ä¼ å…¥ï¼Œä»¥åŠcapæ˜¯å¦å¤§äºæˆ–ç­‰äºlenã€‚\néšå cmd/compile/internal/walk.walkMakeSlice ä¼šæ ¹æ®åˆ‡ç‰‡çš„å¤§å°ä»¥åŠæ˜¯å¦å‘ç”Ÿå†…å­˜é€ƒé€¸è¿›è¡Œä¸åŒçš„å¤„ç†ï¼šå¦‚æœå½“å‰çš„åˆ‡ç‰‡ä¸ä¼šå‘ç”Ÿé€ƒé€¸å¹¶ä¸”åˆ‡ç‰‡éå¸¸å°çš„æ—¶å€™ï¼Œmake([]int, 3, 4)Â ä¼šåœ¨ç¼–è¯‘é˜¶æ®µè¢«ç›´æ¥è½¬æ¢æˆå¦‚ä¸‹æ‰€ç¤ºçš„ä»£ç ï¼š\n1 2 var arr [4]int n := arr[:3] è€Œå½“åˆ‡ç‰‡å‘ç”Ÿé€ƒé€¸æˆ–è€…éå¸¸å¤§æ—¶ï¼Œè¿è¡Œæ—¶éœ€è¦Â runtime.makesliceÂ åœ¨å †ä¸Šåˆå§‹åŒ–åˆ‡ç‰‡ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func makeslice(et *_type, len, cap int) unsafe.Pointer { // è®¡ç®—åˆ‡ç‰‡å ç”¨çš„å†…å­˜ç©ºé—´ // å†…å­˜ç©ºé—´ = å…ƒç´ å¤§å° * åˆ‡ç‰‡å®¹é‡ mem, overflow := math.MulUintptr(et.size, uintptr(cap)) // æ£€æŸ¥å†…å­˜æ˜¯å¦å‘ç”Ÿæº¢å‡ºæˆ–è¶…å‡ºæœ€å¤§å¯åˆ†é…å†…å­˜ // é•¿åº¦æ˜¯å¦å°äº 0 æˆ–é•¿åº¦æ˜¯å¦å¤§äºå®¹é‡ if overflow || mem \u003e maxAlloc || len \u003c 0 || len \u003e cap { mem, overflow := math.MulUintptr(et.size, uintptr(len)) if overflow || mem \u003e maxAlloc || len \u003c 0 { panicmakeslicelen() } panicmakeslicecap() } // ç”³è¯·ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´ return mallocgc(mem, et, true) } åœ¨ä¹‹å‰ç‰ˆæœ¬çš„ Go è¯­è¨€ä¸­ï¼Œè¯¥å‡½æ•°æœ€åä¼šå°†æ•°ç»„æŒ‡é’ˆã€é•¿åº¦å’Œå®¹é‡åˆæˆä¸€ä¸ª runtime.slice ç»“æ„ä½“ã€‚ä½†æ˜¯ä» cmd/compile: move slice construction to callers of makeslice æäº¤ä¹‹åï¼Œè¿™é¡¹å·¥ä½œå°±äº¤ç»™äº†å‡½æ•°çš„è°ƒç”¨æ–¹ã€‚åè€…ä¼šåœ¨ç¼–è¯‘æœŸé—´æ„å»ºåˆ‡ç‰‡ç»“æ„ä½“ï¼Œè€Œ runtime.makeslice ä»…è¿”å›æŒ‡å‘åº•å±‚æ•°ç»„çš„æŒ‡é’ˆã€‚\nè®¿é—®å…ƒç´  ä½¿ç”¨Â lenÂ å’ŒÂ capÂ è·å–é•¿åº¦æˆ–è€…å®¹é‡æ˜¯åˆ‡ç‰‡æœ€å¸¸è§çš„æ“ä½œï¼Œç¼–è¯‘å™¨å°†è¿™å®ƒä»¬çœ‹æˆä¸¤ç§ç‰¹æ®Šæ“ä½œï¼Œå³Â OLENÂ å’ŒÂ OCAPã€‚\nåœ¨ç¼–è¯‘æœŸé—´ï¼Œå¯¹åˆ‡ç‰‡ä¸­å…ƒç´ çš„è®¿é—®æ“ä½œ OINDEX ä¼šè¢«è½¬æ¢æˆå¯¹åœ°å€çš„ç›´æ¥è®¿é—®ï¼Œè€ŒåŒ…å«rangeå…³é”®å­—çš„éå†åˆ™è¢«è½¬æ¢æˆå½¢å¼æ›´ç®€å•çš„å¾ªç¯ã€‚\nè¿½åŠ å’Œæ‰©å®¹ å¦‚æœ append è¿”å›çš„æ–°åˆ‡ç‰‡ä¸ä¼šè¦†ç›–åŸåˆ‡ç‰‡ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 // new_slice := append(s, 1, 2, 3) ptr, len, cap := s len += 3 if uint(len) \u003e uint(cap) { ptr, len, cap = growslice(ptr, len, cap, 3, typ) // Note that len is unmodified by growslice. } // with write barriers, if needed: *(ptr+(len-3)) = e1 *(ptr+(len-2)) = e2 *(ptr+(len-1)) = e3 return makeslice(ptr, len, cap) å¦‚æœappendè¿”å›çš„åˆ‡ç‰‡ä¼šè¦†ç›–åŸåˆ‡ç‰‡ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // s = append(s, 1, 2, 3) a := \u0026s ptr, len, cap := s len += 3 if uint(len) \u003e uint(cap) { ptr, len, cap = growslice(ptr, len, cap, 3, typ) vardef(a) // if necessary, advise liveness we are writing a new a *a.cap = cap // write before ptr to avoid a spill *a.ptr = ptr // with write barrier } *a.len = len // with write barriers, if needed: *(ptr+(len-3)) = e1 *(ptr+(len-2)) = e2 *(ptr+(len-1)) = e3 ä¸¤è€…çš„é€»è¾‘å…¶å®å·®ä¸å¤šï¼Œæœ€å¤§çš„åŒºåˆ«åœ¨äºå¾—åˆ°çš„æ–°åˆ‡ç‰‡æ˜¯å¦ä¼šèµ‹å€¼å›åŸå˜é‡ã€‚\n![[Pasted image 20240715171701.png]]\næ‰©å®¹æ˜¯ä¸ºåˆ‡ç‰‡åˆ†é…æ–°çš„å†…å­˜ç©ºé—´å¹¶å¤åˆ¶åŸåˆ‡ç‰‡ä¸­å…ƒç´ çš„è¿‡ç¨‹ï¼Œruntime.growsliceÂ å‡½æ•°æœ€ç»ˆä¼šè¿”å›ä¸€ä¸ªæ–°çš„åˆ‡ç‰‡ï¼Œå…¶ä¸­åŒ…å«äº†æ–°çš„æ•°ç»„æŒ‡é’ˆã€å¤§å°å’Œå®¹é‡ã€‚runtime.nextslicecap åˆ™æ ¹æ®åˆ‡ç‰‡çš„å½“å‰å®¹é‡é€‰æ‹©ä¸åŒçš„ç­–ç•¥è¿›è¡Œæ‰©å®¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 // nextslicecap computes the next appropriate slice length. func nextslicecap(newLen, oldCap int) int { newcap := oldCap doublecap := newcap + newcap if newLen \u003e doublecap { return newLen } const threshold = 256 if oldCap \u003c threshold { return doublecap } for { // Transition from growing 2x for small slices // to growing 1.25x for large slices. This formula // gives a smooth-ish transition between the two. newcap += (newcap + 3*threshold) \u003e\u003e 2 // We need to check `newcap \u003e= newLen` and whether `newcap` overflowed. // newLen is guaranteed to be larger than zero, hence // when newcap overflows then `uint(newcap) \u003e uint(newLen)`. // This allows to check for both with the same comparison. if uint(newcap) \u003e= uint(newLen) { break } } // Set newcap to the requested cap when // the newcap calculation overflowed. if newcap \u003c= 0 { return newLen } return newcap } å½“æˆ‘ä»¬æ‰§è¡Œå¦‚ä¸‹ä»£ç æ—¶ï¼Œä¼šè§¦å‘Â runtime.growsliceÂ å‡½æ•°æ‰©å®¹arråˆ‡ç‰‡å¹¶ä¼ å…¥æœŸæœ›çš„æ–°å®¹é‡ 5ï¼Œæ­¤æ—¶æœŸæœ›åˆ†é…çš„å†…å­˜å¤§å°ä¸º 40 å­—èŠ‚ã€‚ä¸è¿‡åˆ‡ç‰‡ä¸­çš„å…ƒç´ å¤§å°åº”ç­‰äºsys.PtrSizeï¼Œæ‰€ä»¥è¿è¡Œæ—¶ä¼šè°ƒç”¨Â runtime.roundupsizeÂ å‘ä¸Šå–æ•´å†…å­˜çš„å¤§å°åˆ° 48 å­—èŠ‚ï¼Œæ–°åˆ‡ç‰‡çš„å®¹é‡ä¸º 48 / 8 = 6ï¼š\n1 2 var arr []int64 arr = append(arr, 1, 2, 3, 4, 5) å¤åˆ¶åˆ‡ç‰‡ æ— è®ºæ˜¯ç¼–è¯‘æœŸé—´å¤åˆ¶è¿˜æ˜¯è¿è¡Œæ—¶å¤åˆ¶ï¼Œä¸¤ç§å¤åˆ¶æ–¹å¼éƒ½ä¼šé€šè¿‡Â runtime.memmoveÂ å°†æ•´å—å†…å­˜çš„å†…å®¹å¤åˆ¶åˆ°ç›®æ ‡çš„å†…å­˜åŒºåŸŸä¸­ï¼š\n![[Pasted image 20221204214706.png]]\nç›¸æ¯”äºä¾æ¬¡å¤åˆ¶å…ƒç´ ï¼Œè¿™ç§æ–¹å¼èƒ½å¤Ÿæä¾›æ›´å¥½çš„æ€§èƒ½ã€‚ä¸è¿‡ï¼Œæ•´å—å¤åˆ¶å†…å­˜ä»ç„¶ä¼šå ç”¨éå¸¸å¤šçš„èµ„æºï¼Œå¯¹å¤§åˆ‡ç‰‡æ‰§è¡Œå¤åˆ¶æ“ä½œæ—¶ä¸€å®šè¦æ³¨æ„å¯¹æ€§èƒ½çš„å½±å“ã€‚\nå“ˆå¸Œè¡¨ è®¾è®¡åŸç† å“ˆå¸Œè¡¨æ˜¯è®¡ç®—æœºç§‘å­¦ä¸­çš„æœ€é‡è¦æ•°æ®ç»“æ„ä¹‹ä¸€ï¼Œè¿™ä¸ä»…å› ä¸ºå®ƒÂ ğ‘‚(1)Â çš„è¯»å†™æ€§èƒ½éå¸¸ä¼˜ç§€ï¼Œè¿˜å› ä¸ºå®ƒæä¾›äº†é”®å€¼ä¹‹é—´çš„æ˜ å°„ã€‚æƒ³è¦å®ç°ä¸€ä¸ªæ€§èƒ½ä¼˜å¼‚çš„å“ˆå¸Œè¡¨ï¼Œéœ€è¦æ³¨æ„ä¸¤ä¸ªå…³é”®ç‚¹ â€”â€” å“ˆå¸Œå‡½æ•°å’Œå†²çªè§£å†³æ–¹æ³•ã€‚\nå“ˆå¸Œå‡½æ•°æ˜ å°„çš„ç»“æœä¸€å®šè¦å°½å¯èƒ½å‡åŒ€ï¼Œç»“æœä¸å‡åŒ€çš„å“ˆå¸Œå‡½æ•°ä¼šå¸¦æ¥æ›´å¤šçš„å“ˆå¸Œå†²çªä»¥åŠæ›´å·®çš„è¯»å†™æ€§èƒ½ã€‚\n![[Pasted image 20221204221354.png]]\nè§£å†³å“ˆå¸Œå†²çªçš„å¸¸è§æ–¹æ³•æœ‰å¼€æ”¾å¯»å€æ³•å’Œæ‹‰é“¾æ³•ã€‚\nå¼€æ”¾å¯»å€æ³• è¿™ç§æ–¹æ³•çš„æ ¸å¿ƒæ€æƒ³æ˜¯ä¾æ¬¡æ¢æµ‹å’Œæ¯”è¾ƒæ•°ç»„ä¸­çš„å…ƒç´ ä»¥åˆ¤æ–­ç›®æ ‡é”®å€¼å¯¹æ˜¯å¦å­˜åœ¨äºå“ˆå¸Œè¡¨ä¸­ï¼Œæ­¤æ—¶å®ç°å“ˆå¸Œè¡¨åº•å±‚çš„æ•°æ®ç»“æ„æ˜¯æ•°ç»„ã€‚ä¸è¿‡å› ä¸ºæ•°ç»„çš„é•¿åº¦æœ‰é™ï¼Œå‘å“ˆå¸Œè¡¨å†™å…¥é”®å€¼å¯¹æ—¶ä¼šä»å¦‚ä¸‹çš„ç´¢å¼•å¼€å§‹éå†ï¼š\n1 index := hash(\"Key3\") % array.len å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå½“ Key3 ä¸å·²ç»å­˜å…¥å“ˆå¸Œè¡¨ä¸­çš„ä¸¤ä¸ªé”®å€¼å¯¹ Key1 å’Œ Key2 å‘ç”Ÿå†²çªæ—¶ï¼ŒKey3 ä¼šè¢«å†™å…¥ Key2 åé¢çš„ç©ºé—²ä½ç½®ã€‚å½“æˆ‘ä»¬å†å»è¯»å– Key3 å¯¹åº”çš„å€¼æ—¶å°±ä¼šå…ˆè·å–é”®çš„å“ˆå¸Œå¹¶å–æ¨¡ï¼Œè¿™ä¼šå…ˆå¸®åŠ©æˆ‘ä»¬æ‰¾åˆ° Key1ï¼Œæ‰¾åˆ° Key1 åå‘ç°å®ƒä¸ Key 3 ä¸ç›¸ç­‰ï¼Œæ‰€ä»¥ä¼šç»§ç»­æŸ¥æ‰¾åé¢çš„å…ƒç´ ï¼Œç›´åˆ°å†…å­˜ä¸ºç©ºæˆ–è€…æ‰¾åˆ°ç›®æ ‡å…ƒç´ ã€‚\n![[Pasted image 20221204223840.png]]\nå¼€æ”¾å¯»å€æ³•ä¸­å¯¹æ€§èƒ½å½±å“æœ€å¤§çš„æ˜¯è£…è½½å› å­ï¼Œå®ƒæ˜¯æ•°ç»„ä¸­å…ƒç´ çš„æ•°é‡ä¸æ•°ç»„å¤§å°çš„æ¯”å€¼ã€‚éšç€è£…è½½å› å­çš„å¢åŠ ï¼Œçº¿æ€§æ¢æµ‹çš„å¹³å‡ç”¨æ—¶å°±ä¼šé€æ¸å¢åŠ ï¼Œè¿™ä¼šå½±å“å“ˆå¸Œè¡¨çš„è¯»å†™æ€§èƒ½ã€‚å½“è£…è½½ç‡è¶…è¿‡ 70% ä¹‹åï¼Œå“ˆå¸Œè¡¨çš„æ€§èƒ½å°±ä¼šæ€¥å‰§ä¸‹é™ï¼Œè€Œä¸€æ—¦è£…è½½ç‡è¾¾åˆ° 100%ï¼Œæ•´ä¸ªå“ˆå¸Œè¡¨å°±ä¼šå®Œå…¨å¤±æ•ˆï¼Œè¿™æ—¶æŸ¥æ‰¾å’Œæ’å…¥ä»»æ„å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯Â ğ‘‚(ğ‘›) çš„ï¼Œå³éœ€è¦éå†æ•°ç»„ä¸­çš„å…¨éƒ¨å…ƒç´ ã€‚\næ‹‰é“¾æ³• å¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€éƒ½é‡‡ç”¨æ‹‰é“¾æ³•ï¼Œå®ƒçš„å¹³å‡æŸ¥æ‰¾æ—¶é—´è¾ƒçŸ­ä¸”å¯ä»¥åŠ¨æ€ç”³è¯·å†…å­˜ä»¥å‡å°‘å†…å­˜å ç”¨ã€‚å®ç°æ‹‰é“¾æ³•ä¸€èˆ¬ä¼šä½¿ç”¨æ•°ç»„åŠ ä¸Šé“¾è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒçœ‹æˆå¯ä»¥æ‰©å±•çš„äºŒç»´æ•°ç»„ï¼š\n![[Pasted image 20221204224617.png]]\nå’Œå¼€æ”¾åœ°å€æ³•ä¸€æ ·ï¼Œé€‰æ‹©æ¡¶çš„æ–¹å¼æ˜¯ç›´æ¥å¯¹å“ˆå¸Œå‡½æ•°è¿”å›çš„ç»“æœå–æ¨¡ï¼š\n1 index := hash(\"Key6\") % array.len å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒKey 6 çš„ç´¢å¼•ä¸º 2ï¼Œæ­¤æ—¶éå† 2 å·æ¡¶ä¸­çš„é“¾è¡¨æ—¶å¯èƒ½ä¼šé‡åˆ°ä¸¤ç§æƒ…å†µï¼š\næ‰¾åˆ°é”®ç›¸åŒçš„é”®å€¼å¯¹ï¼Œåˆ™è¯»å–/å†™å…¥é”®å¯¹åº”çš„å€¼ï¼› æœªæ‰¾åˆ°é”®ç›¸åŒçš„é”®å€¼å¯¹ï¼Œåˆ™è¿”å›è¯¥é”®ä¸å­˜åœ¨ï¼ˆè¯»å–ï¼‰/åœ¨é“¾è¡¨çš„æœ«å°¾è¿½åŠ æ–°çš„é”®å€¼å¯¹ï¼ˆå†™å…¥ï¼‰ï¼› æ‹‰é“¾æ³•çš„è£…è½½å› å­ç­‰äºå…ƒç´ æ•°é‡é™¤ä»¥æ¡¶çš„æ•°é‡ï¼Œè£…è½½å› å­è¶Šå¤§ï¼ˆä¸€èˆ¬ä¸ä¼šè¶…è¿‡ 1ï¼‰ï¼Œè¯»å†™æ€§èƒ½å°±è¶Šå·®ã€‚å½“è£…è½½å› å­è¾ƒå¤§æ—¶ä¼šè§¦å‘å“ˆå¸Œçš„æ‰©å®¹ï¼Œå³åˆ›å»ºæ›´å¤šçš„æ¡¶æ¥å­˜å‚¨å“ˆå¸Œä¸­çš„å…ƒç´ ï¼Œä¿è¯æ€§èƒ½ä¸ä¼šå‡ºç°ä¸¥é‡çš„ä¸‹é™ã€‚\næ•°æ®ç»“æ„ Go è¯­è¨€è¿è¡Œæ—¶åŒæ—¶ä½¿ç”¨äº†å¤šä¸ªæ•°æ®ç»“æ„ç»„åˆè¡¨ç¤ºå“ˆå¸Œè¡¨ï¼Œå…¶ä¸­Â runtime.hmapÂ æ˜¯æœ€æ ¸å¿ƒçš„ç»“æ„ä½“ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 type hmap struct { count int // å½“å‰å“ˆå¸Œè¡¨ä¸­çš„å…ƒç´ æ•°é‡ flags uint8 B uint8 // å½“å‰å“ˆå¸Œè¡¨çš„æ¡¶æ•°é‡ä¸º 2 ^ B noverflow uint16 // ä½¿ç”¨çš„æº¢å‡ºæ¡¶æ•°é‡ hash0 uint32 // ä¸ºå“ˆå¸Œå‡½æ•°å¼•å…¥éšæœºæ€§ç§å­ buckets unsafe.Pointer // æŒ‡å‘ bmap æ•°ç»„çš„æŒ‡é’ˆ oldbuckets unsafe.Pointer // æ‰©å®¹æ—¶ä¿å­˜çš„æ—§æ¡¶ï¼Œå¤§å°ä¸ºå½“å‰çš„ä¸€åŠ nevacuate uintptr // æ ‡è¯†æ‰©å®¹è¿›åº¦ï¼Œå°äºæ­¤åœ°å€çš„æ¡¶å·²è¿ç§»å®Œæˆ extra *mapextra } type mapextra struct { overflow *[]*bmap // å·²ä½¿ç”¨çš„æº¢å‡ºæ¡¶åœ°å€ oldoverflow *[]*bmap // æ‰©å®¹æ—¶æ—§æ¡¶ä½¿ç”¨çš„æº¢å‡ºæ¡¶åœ°å€ nextOverflow *bmap // æŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²çš„æº¢å‡ºæ¡¶ } ![[Pasted image 20221204231720.png]]\nå¦‚ä¸Šå›¾æ‰€ç¤ºå“ˆå¸Œè¡¨Â runtime.hmapÂ çš„æ¡¶æ˜¯Â runtime.bmapï¼Œåè€…èƒ½å­˜å‚¨ 8 ä¸ªé”®å€¼å¯¹ã€‚å½“å“ˆå¸Œè¡¨ä¸­å­˜å‚¨çš„æ•°æ®è¿‡å¤šï¼Œå•ä¸ªæ¡¶å·²ç»è£…æ»¡æ—¶å°±ä¼šä½¿ç”¨extra.nextOverflowä¸­çš„æ¡¶å­˜å‚¨æº¢å‡ºçš„æ•°æ®ã€‚\nä¸Šè¿°ä¸¤ç§ä¸åŒçš„æ¡¶åœ¨å†…å­˜ä¸­æ˜¯è¿ç»­å­˜å‚¨çš„ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå°†å®ƒä»¬åˆ†åˆ«ç§°ä¸ºæ­£å¸¸æ¡¶å’Œæº¢å‡ºæ¡¶ï¼Œä¸Šå›¾ä¸­é»„è‰²çš„Â runtime.bmapÂ å°±æ˜¯æ­£å¸¸æ¡¶ï¼Œç»¿è‰²çš„Â runtime.bmapÂ æ˜¯æº¢å‡ºæ¡¶ã€‚\nå½“ map ä¸­æ‰¾ä¸åˆ°å¯ç”¨çš„æº¢å‡ºæ¡¶æ—¶ï¼Œruntime.newoverflow ä¼šé€šè¿‡ newobject æ–°å»ºæº¢å‡ºæ¡¶ï¼Œæ­¤æ—¶æ­£å¸¸æ¡¶å’Œæº¢å‡ºæ¡¶åœ¨å†…å­˜ä¸­çš„å­˜å‚¨ç©ºé—´å°±ä¸å†è¿ç»­äº†ã€‚\næ¡¶çš„ç»“æ„ä½“Â runtime.bmapÂ åœ¨ Go è¯­è¨€æºä»£ç ä¸­çš„å®šä¹‰åªåŒ…å«ä¸€ä¸ªç®€å•çš„tophashå­—æ®µï¼Œå®ƒå­˜å‚¨äº†é”®çš„å“ˆå¸Œå€¼çš„é«˜ 8 ä½ã€‚é€šè¿‡æ¯”è¾ƒtophashå¯ä»¥å‡å°‘è®¿é—®é”®å€¼å¯¹çš„æ¬¡æ•°ä»¥æé«˜æ€§èƒ½ã€‚\nåœ¨è¿è¡ŒæœŸé—´ï¼Œè¯¥ç»“æ„ä½“å…¶å®ä¸æ­¢åŒ…å«tophashå­—æ®µï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®ç¼–è¯‘æœŸé—´çš„Â cmd/compile/internal/reflectdata.MapBucketTypeÂ å‡½æ•°é‡å»ºå®ƒçš„ç»“æ„ï¼š\n1 2 3 4 5 6 type bmap struct { topbits [8]uint8 keys [8]keytype values [8]valuetype overflow uintptr } ![[Pasted image 20221204234422.png]]\nåˆå§‹åŒ– å­—é¢é‡ å½“å“ˆå¸Œè¡¨ä¸­çš„å…ƒç´ æ•°é‡å°‘äºæˆ–è€…ç­‰äº 25 ä¸ªæ—¶ï¼Œç¼–è¯‘å™¨ä¼šå°†å­—é¢é‡åˆå§‹åŒ–çš„ç»“æ„ä½“è½¬æ¢æˆä»¥ä¸‹çš„ä»£ç ï¼Œå°†æ‰€æœ‰çš„é”®å€¼å¯¹ä¸€æ¬¡åŠ å…¥åˆ°å“ˆå¸Œè¡¨ä¸­ï¼š\n1 2 3 4 hash := make(map[string]int, 3) hash[\"1\"] = 2 hash[\"3\"] = 4 hash[\"5\"] = 6 ä¸€æ—¦å“ˆå¸Œè¡¨ä¸­å…ƒç´ çš„æ•°é‡è¶…è¿‡äº† 25 ä¸ªï¼Œç¼–è¯‘å™¨ä¼šåˆ›å»ºä¸¤ä¸ªæ•°ç»„åˆ†åˆ«å­˜å‚¨é”®å’Œå€¼ï¼Œè¿™äº›é”®å€¼å¯¹ä¼šé€šè¿‡å¦‚ä¸‹æ‰€ç¤ºçš„forå¾ªç¯åŠ å…¥å“ˆå¸Œï¼š\n1 2 3 4 5 6 hash := make(map[string]int, 26) vstatk := []string{\"1\", \"2\", \"3\", ... ï¼Œ \"26\"} vstatv := []int{1, 2, 3, ... , 26} for i := 0; i \u003c len(vstak); i++ { hash[vstatk[i]] = vstatv[i] } æ— è®ºä½¿ç”¨å“ªç§æ–¹æ³•ï¼Œä½¿ç”¨å­—é¢é‡åˆå§‹åŒ–çš„è¿‡ç¨‹éƒ½ä¼šä½¿ç”¨ Go è¯­è¨€ä¸­çš„å…³é”®å­—makeæ¥åˆ›å»ºæ–°çš„å“ˆå¸Œå¹¶é€šè¿‡æœ€åŸå§‹çš„[]è¯­æ³•å‘å“ˆå¸Œè¿½åŠ å…ƒç´ ã€‚\nè¿è¡Œæ—¶ å½“åˆ›å»ºçš„å“ˆå¸Œè¢«åˆ†é…åˆ°æ ˆä¸Šå¹¶ä¸”å…¶å®¹é‡å°äºBUCKETSIZE = 8æ—¶ï¼Œcmd/compile/internal/walk.walkMakeSlice å‡½æ•°ä¼šåœ¨ç¼–è¯‘é˜¶æ®µå¿«é€Ÿåˆå§‹åŒ–å“ˆå¸Œï¼Œè¿™æ˜¯ç¼–è¯‘å™¨å¯¹å°å®¹é‡çš„å“ˆå¸Œæ‰€åšçš„ä¼˜åŒ–ï¼š\n1 2 3 4 5 6 7 8 9 10 var h *hmap // Allocate hmap on stack var hv hmap h = \u0026hv if hint \u003c= BUCKETSIZE { var bv bmap b := \u0026bv h.buckets = b h.hash0 = rand32() } é™¤æ­¤ä¹‹å¤–ï¼Œæ‰€æœ‰åˆå§‹åŒ–mapçš„è¯­å¥éƒ½ä¼šè¢«è½¬æ¢æˆÂ runtime.makemapï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 func makemap(t *maptype, hint int, h *hmap) *hmap { // è®¡ç®—å“ˆå¸Œå ç”¨çš„å†…å­˜æ˜¯å¦æº¢å‡ºæˆ–è€…è¶…å‡ºèƒ½åˆ†é…çš„æœ€å¤§å€¼ mem, overflow := math.MulUintptr(uintptr(hint), t.Bucket.Size_) if overflow || mem \u003e maxAlloc { hint = 0 } if h == nil { h = new(hmap) } // è·å–ä¸€ä¸ªéšæœºçš„å“ˆå¸Œç§å­ h.hash0 = uint32(rand()) B := uint8(0) // æ ¹æ®ä¼ å…¥çš„ hintï¼ˆmake(map[k]v, hint)ï¼‰è®¡ç®—å‡ºè‡³å°‘éœ€è¦çš„æ¡¶æ•°é‡ï¼› for overLoadFactor(hint, B) { B++ } h.B = B if h.B != 0 { var nextOverflow *bmap // ä½¿ç”¨ runtime.makeBucketArray åˆ›å»ºç”¨äºä¿å­˜æ¡¶çš„æ•°ç»„ h.buckets, nextOverflow = makeBucketArray(t, h.B, nil) if nextOverflow != nil { h.extra = new(mapextra) h.extra.nextOverflow = nextOverflow } } return h } runtime.makeBucketArrayÂ ä¼šæ ¹æ®Bè®¡ç®—å‡ºéœ€è¦åˆ›å»ºçš„æ¡¶æ•°å¹¶åœ¨å†…å­˜ä¸­åˆ†é…ä¸€ç‰‡è¿ç»­çš„ç©ºé—´ç”¨äºå­˜å‚¨æ•°æ®ï¼š\nå½“æ¡¶çš„æ•°é‡å°äºÂ $2^4$Â æ—¶ï¼Œç”±äºæ•°æ®è¾ƒå°‘ã€ä½¿ç”¨æº¢å‡ºæ¡¶çš„å¯èƒ½æ€§è¾ƒä½ï¼Œä¼šçœç•¥åˆ›å»ºçš„è¿‡ç¨‹ä»¥å‡å°‘é¢å¤–å¼€é”€ï¼› å½“æ¡¶çš„æ•°é‡å¤§äºÂ $2^4$ æ—¶ï¼Œä¼šé¢å¤–åˆ›å»º $2^{B-4}$Â ä¸ªæº¢å‡ºæ¡¶ã€‚ è¯»å†™æ“ä½œ è®¿é—® v := hash[key]Â æ“ä½œä¼šå…ˆè¢«è½¬åŒ–ä¸º runtime.mapaccess1ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 func mapaccess1(t *maptype, h *hmap, key unsafe.Pointer) unsafe.Pointer { ... // map ä¸æ”¯æŒå¹¶å‘è¯»å†™ if h.flags\u0026hashWriting != 0 { fatal(\"concurrent map read and map write\") } // é€šè¿‡å“ˆå¸Œå‡½æ•°å’Œç§å­è·å– key å¯¹åº”çš„å“ˆå¸Œå€¼ hash := t.Hasher(key, uintptr(h.hash0)) // m ä¸ºæ¡¶æ©ç ï¼Œç­‰äº 1\u003c\u003cB - 1 m := bucketMask(h.B) // hash\u0026m ä¸º key æ‰€åœ¨æ¡¶çš„ç¼–å· // é€šè¿‡æŒ‡é’ˆè®¡ç®—ç›®æ ‡æ¡¶çš„ä½ç½® b := (*bmap)(add(h.buckets, (hash\u0026m)*uintptr(t.BucketSize))) // è·å– key å¯¹åº”çš„å“ˆå¸Œå€¼çš„é«˜å…«ä½ top := tophash(hash) bucketloop: // ä¾æ¬¡éå†æ­£å¸¸æ¡¶å’Œæº¢å‡ºæ¡¶ä¸­çš„æ•°æ® for ; b != nil; b = b.overflow(t) { for i := uintptr(0); i \u003c bucketCnt; i++ { // å°† key å¯¹åº”çš„å“ˆå¸Œå€¼çš„é«˜å…«ä½ä¸æ¡¶ä¸­å­˜å‚¨çš„ tophash è¿›è¡Œæ¯”è¾ƒ if b.tophash[i] != top { if b.tophash[i] == emptyRest { break bucketloop } continue } // è‹¥ tophash ç›¸ç­‰ï¼Œåˆ™ç§»åŠ¨æŒ‡é’ˆå¾—åˆ°æ¡¶ä¸­å­˜å‚¨çš„é”® k // å…¶ä¸­ï¼ŒdataOffset æ˜¯æ¡¶ä¸­ç¬¬ä¸€ä¸ªé”®ç›¸å¯¹äº bmap èµ·å§‹åœ°å€çš„åç§»é‡ k := add(unsafe.Pointer(b), dataOffset+i*uintptr(t.KeySize)) // å†å°† key ä¸ k è¿›è¡Œæ¯”è¾ƒï¼Œè‹¥ç›¸ç­‰åˆ™è¯»å–æŒ‡å‘ç›®æ ‡å€¼çš„æŒ‡é’ˆå¹¶è¿”å› if t.Key.Equal(key, k) { e := add(unsafe.Pointer(b), dataOffset+bucketCnt*uintptr(t.KeySize)+i*uintptr(t.t.ValueSize)) return e } } } return unsafe.Pointer(\u0026zeroVal[0]) } å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ­£æ˜¯å› ä¸ºæ¯ä¸ªæ¡¶éƒ½æ˜¯ä¸€ç‰‡è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œæˆ‘ä»¬æ‰èƒ½é€šè¿‡ runtime.add æ“ä½œæŒ‡é’ˆä»¥è®¿é—®æ¡¶ä¸­å­˜å‚¨çš„é”®ã€‚\n![[Pasted image 20221205221842.png]]\nå¦å¤–ï¼Œé€‰æ‹©æ¡¶åºå·æ—¶ç”¨çš„æ˜¯é”®çš„å“ˆå¸Œå€¼çš„æœ€ä½å‡ ä½ï¼ˆhash\u0026mï¼‰ï¼Œè€ŒåŠ é€Ÿè®¿é—®ç”¨çš„æ˜¯é”®çš„å“ˆå¸Œå€¼çš„é«˜ 8 ä½ï¼Œè¿™ç§è®¾è®¡èƒ½å¤Ÿå‡å°‘åŒä¸€ä¸ªæ¡¶ä¸­æœ‰å¤§é‡ç›¸ç­‰tophashçš„æ¦‚ç‡ä»¥å…å½±å“æ€§èƒ½ã€‚\nv, ok := hash[key]æ“ä½œåˆ™ä¼šè¢«è½¬åŒ–ä¸º runtime.mapaccess2ï¼Œå®ƒåœ¨æ­¤åŸºç¡€ä¹‹ä¸Šå¤šè¿”å›äº†ä¸€ä¸ªæ ‡è¯†é”®å€¼å¯¹æ˜¯å¦å­˜åœ¨çš„å¸ƒå°”å€¼ã€‚æˆ‘ä»¬èƒ½å¤Ÿé€šè¿‡è¿™ä¸ªå¸ƒå°”å€¼æ›´å‡†ç¡®åœ°çŸ¥é“ï¼šå½“v == nilæ—¶ï¼ŒvÂ åˆ°åº•æ˜¯å“ˆå¸Œä¸­å­˜å‚¨çš„å…ƒç´ è¿˜æ˜¯è¡¨ç¤ºè¯¥é”®å¯¹åº”çš„å…ƒç´ ä¸å­˜åœ¨ã€‚å› æ­¤æˆ‘ä»¬åœ¨è®¿é—®å“ˆå¸Œè¡¨æ—¶æ›´æ¨èä½¿ç”¨è¿™ç§æ–¹å¼åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨ã€‚\nå†™å…¥ hash[k] = væ“ä½œä¼šåœ¨ç¼–è¯‘æœŸé—´è¢«è½¬æ¢æˆÂ runtime.mapassignï¼Œè¯¥å‡½æ•°éœ€è¦å…¼é¡¾ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š\nkåœ¨æ¡¶ä¸­å­˜åœ¨ï¼Œè¿”å›våœ¨æ¡¶ä¸­çš„åœ°å€ï¼› kåœ¨æ¡¶ä¸­ä¸å­˜åœ¨ä¸”æ¡¶ä¸­æœ‰ç©ºä½ï¼Œè¿”å›kå’Œvåº”å½“æ’å…¥çš„åœ°å€ï¼› kåœ¨æ¡¶ä¸­ä¸å­˜åœ¨ä¸”æ¡¶å·²æ»¡ï¼Œå¯¹å½“å‰æ¡¶è¿›è¡Œæ‰©å®¹ç„¶åå†è¿”å›kå’Œvåº”å½“æ’å…¥çš„åœ°å€ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 func mapassign(t *maptype, h *hmap, key unsafe.Pointer) unsafe.Pointer { // æ ¹æ® key è®¡ç®—å“ˆå¸Œå€¼ hash := t.hasher(key, uintptr(h.hash0)) again: // è·å– key æ‰€åœ¨çš„æ¡¶åºå· bucket := hash \u0026 bucketMask(h.B) b := (*bmap)(add(h.buckets, bucket*uintptr(t.BucketSize))) // è·å– key å¯¹åº”çš„å“ˆå¸Œå€¼çš„é«˜å…«ä½ top := tophash(hash) var inserti *uint8 // key çš„å“ˆå¸Œå€¼åœ¨ tophash æ•°ç»„ä¸­çš„ç´¢å¼• var insertk unsafe.Pointer // key æ’å…¥çš„åœ°å€ var elem unsafe.Pointer // elem æ’å…¥çš„åœ°å€ bucketloop: for { // éå†æ‰€æœ‰æ­£å¸¸æ¡¶å’Œæº¢å‡ºæ¡¶ for i := uintptr(0); i \u003c bucketCnt; i++ { // å°† key å¯¹åº”çš„å“ˆå¸Œå€¼çš„é«˜å…«ä½ä¸æ¡¶ä¸­å­˜å‚¨çš„ tophash è¿›è¡Œæ¯”è¾ƒ if b.tophash[i] != top { // è‹¥ä¸ç›¸ç­‰ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦ä¸ºç©ºä½ if isEmpty(b.tophash[i]) \u0026\u0026 inserti == nil { // è‹¥ä¸ºç©ºä½ï¼Œåˆ™å°†å…¶æ ‡è®°ä¸ºé”®å€¼å¯¹æ’å…¥çš„ä½ç½® inserti = \u0026b.tophash[i] insertk = add(unsafe.Pointer(b), dataOffset+i*uintptr(t.KeySize)) elem = add(unsafe.Pointer(b), dataOffset+bucketCnt*uintptr(t.KeySize)+i*uintptr(t.ValueSize)) } if b.tophash[i] == emptyRest { break bucketloop } // è‹¥ tophash å‡ä¸åŒ¹é…ï¼Œåˆ™è·³å‡ºå†…å¾ªç¯ continue } // è‹¥ tophash ç›¸ç­‰ï¼Œåˆ™ç§»åŠ¨æŒ‡é’ˆå¾—åˆ°æ¡¶ä¸­å­˜å‚¨çš„é”® k k := add(unsafe.Pointer(b), dataOffset+i*uintptr(t.KeySize)) // å†å°† key ä¸ k è¿›è¡Œæ¯”è¾ƒ if !t.Key.Equal(key, k) { continue } // é€šè¿‡æŒ‡é’ˆç§»åŠ¨å¾—åˆ°å€¼çš„åœ°å€å¹¶ç›´æ¥è¿”å› elem = add(unsafe.Pointer(b), dataOffset+bucketCnt*uintptr(t.KeySize)+i*uintptr(t.ValueSize)) goto done } // éå†å®Œæ­£å¸¸æ¡¶åï¼Œå°†åœ¨ä¸‹ä¸€ä¸ªå†…å¾ªç¯ä¸­éå†æº¢å‡ºæ¡¶ ovf := b.overflow(t) if ovf == nil { break } b = ovf } // inserti ä¸º nilï¼Œè¯´æ˜å½“å‰æ¡¶å’Œæº¢å‡ºæ¡¶å·²æ»¡ if inserti == nil { // è°ƒç”¨ runtime.newoverflow åˆ›å»ºæ–°æ¡¶ newb := h.newoverflow(t, b) inserti = \u0026newb.tophash[0] insertk = add(unsafe.Pointer(newb), dataOffset) elem = add(insertk, bucketCnt*uintptr(t.KeySize)) } // è‹¥ key åœ¨å“ˆå¸Œè¡¨ä¸­ä¸å­˜åœ¨ï¼Œåˆ™ä¸ºæ–°é”®å€¼å¯¹è§„åˆ’å†…å­˜ if t.indirectkey() { kmem := newobject(t.Key) *(*unsafe.Pointer)(insertk) = kmem insertk = kmem } if t.indirectelem() { vmem := newobject(t.Elem) *(*unsafe.Pointer)(elem) = vmem } // é€šè¿‡ runtime.typedmemmove å°† key ç§»åŠ¨åˆ°å¯¹åº”çš„å†…å­˜ç©ºé—´ä¸­ typedmemmove(t.Key, insertk, key) *inserti = top h.count++ done: // è¿”å› key å¯¹åº”çš„ elem åœ°å€ return elem } ç”±æ­¤å¯è§ï¼Œruntime.mapassign å¹¶ä¸ä¼šå°†å€¼å¤åˆ¶åˆ°æ¡¶ä¸­ï¼ŒçœŸæ­£çš„èµ‹å€¼æ“ä½œæ˜¯åœ¨ç¼–è¯‘æœŸé—´æ’å…¥çš„ï¼š\n1 2 3 4 00018 (+5) CALL runtime.mapassign_fast64(SB) 00020 (5) MOVQ 24(SP), DI ;; DI = \u0026value 00026 (5) LEAQ go.string.\"88\"(SB), AX ;; AX = \u0026\"88\" 00027 (5) MOVQ AX, (DI) ;; *DI = AX runtime.mapassign_fast64Â ä¸Â runtime.mapassignÂ å‡½æ•°çš„é€»è¾‘å·®ä¸å¤šï¼Œæˆ‘ä»¬éœ€è¦å…³æ³¨çš„æ˜¯åé¢çš„ä¸‰è¡Œä»£ç ã€‚å…¶ä¸­24(SP)æ˜¯è¯¥å‡½æ•°è¿”å›çš„å€¼åœ°å€ï¼Œæˆ‘ä»¬é€šè¿‡LEAQæŒ‡ä»¤å°†å­—ç¬¦ä¸²çš„åœ°å€å­˜å‚¨åˆ°å¯„å­˜å™¨AXä¸­ï¼ŒMOVQÂ æŒ‡ä»¤å°†å­—ç¬¦ä¸²\"88\"å­˜å‚¨åˆ°äº†ç›®æ ‡åœ°å€ä¸Šä»è€Œå®Œæˆäº†è¿™æ¬¡å“ˆå¸Œçš„å†™å…¥ã€‚\næ‰©å®¹ ä¸Šä¸€èŠ‚åœ¨ä»‹ç»mapassignæ—¶å…¶å®çœç•¥äº†å…¶ä¸­çš„æ‰©å®¹æ“ä½œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 func mapassign(t *maptype, h *hmap, key unsafe.Pointer) unsafe.Pointer { ... // å“ˆå¸Œçš„æ‰©å®¹ä¸æ˜¯ä¸€ä¸ªåŸå­çš„è¿‡ç¨‹ï¼Œéœ€è¦åˆ¤æ–­å½“å‰æ˜¯å¦å¤„äºæ‰©å®¹çŠ¶æ€ // åˆ¤æ–­ h.growing() è¿”å›çš„ oldbuckets æ˜¯å¦éç©º // è‹¥ oldbuckets éç©ºï¼Œåˆ™è¯´æ˜æ­£åœ¨æ‰©å®¹ // è£…è½½å› å­è¶…è¿‡ 6.5 æˆ–æº¢å‡ºæ¡¶è¿‡å¤šæ—¶è§¦å‘æ‰©å®¹ hashgrow if !h.growing() \u0026\u0026 (overLoadFactor(h.count+1, h.B) || tooManyOverflowBuckets(h.noverflow, h.B)) { hashGrow(t, h) // Growing the table invalidates everything, so try again goto again } ... } æˆ‘ä»¬å¯ä»¥å‘ç°æœ‰ä»¥ä¸‹ä¸¤ç§æƒ…å†µå°†è§¦å‘æ‰©å®¹ï¼š\nè£…è½½å› å­è¶…è¿‡ 6.5ï¼šå“ˆå¸Œçš„ç©ºé—´ä½¿ç”¨ç‡è¿‡é«˜ï¼Œå“ˆå¸Œå†²çªçš„æ¦‚ç‡è¾ƒå¤§ï¼› æº¢å‡ºæ¡¶è¿‡å¤šï¼šå¦‚æœæˆ‘ä»¬æŒç»­å‘å“ˆå¸Œä¸­æ’å…¥æ•°æ®å¹¶å°†å®ƒä»¬å…¨éƒ¨åˆ é™¤ï¼Œé‚£ä¹ˆå³ä½¿å“ˆå¸Œè¡¨ä¸­çš„è£…è½½å› å­æ²¡æœ‰è¶…è¿‡é˜ˆå€¼ï¼Œæº¢å‡ºæ¡¶çš„æ•°é‡ä¹Ÿä¼šè¶Šæ¥è¶Šå¤šä»è€Œé€ æˆç¼“æ…¢çš„ å†…å­˜æ³„æ¼ã€‚ runtime.hashGrow ä¼šæ ¹æ®å…·ä½“æƒ…å†µé‡‡å–ä¸åŒçš„æ‰©å®¹ç­–ç•¥ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 func hashGrow(t *maptype, h *hmap) { bigger := uint8(1) // è‹¥è£…è½½å› å­æœªè¶…è¿‡é˜ˆå€¼ï¼Œåˆ™è¯´æ˜æº¢å‡ºæ¡¶è¿‡å¤šè§¦å‘äº†æ‰©å®¹ if !overLoadFactor(h.count+1, h.B) { bigger = 0 // æ‰©å®¹è§„åˆ™å°†æ˜¯Â sameSizeGrowï¼Œå³ç­‰é‡æ‰©å®¹ï¼Œh.B ä¸å˜ h.flags |= sameSizeGrow } oldbuckets := h.buckets // åˆ›å»ºä¸€ç»„æ–°æ¡¶å’Œé¢„åˆ›å»ºçš„æº¢å‡ºæ¡¶ // è‹¥è£…è½½å› å­è¶…è¿‡é˜ˆå€¼ï¼Œh.b åŠ ä¸€ï¼Œæ¡¶çš„æ•°é‡ç¿»å€ newbuckets, nextOverflow := makeBucketArray(t, h.B+bigger, nil) h.B += bigger h.flags = flags //å°† oldbucket è®¾ä¸ºåŸæœ‰çš„æ¡¶ h.oldbuckets = oldbuckets // å°† bucket è®¾ä¸ºæ–°çš„æ–°çš„ç©ºæ¡¶ h.buckets = newbuckets h.nevacuate = 0 h.noverflow = 0 // æº¢å‡ºæ¡¶é‡‡ç”¨ç›¸åŒçš„é€»è¾‘ h.extra.oldoverflow = h.extra.overflow h.extra.overflow = nil h.extra.nextOverflow = nextOverflow } ![[Pasted image 20221206234604.png]]\næˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œç­‰é‡æ‰©å®¹åˆ›å»ºçš„æ–°æ¡¶æ•°é‡å’Œæ—§æ¡¶ä¸€æ ·ï¼Œè€Œå¢é‡æ‰©å®¹åˆ›å»ºçš„æ–°æ¡¶åˆ™ä¸ºåŸæ¥çš„ä¸¤å€ã€‚hashGrowåªæ˜¯åˆ›å»ºäº†æ–°æ¡¶ï¼Œå¹¶æ²¡æœ‰å¯¹æ•°æ®è¿›è¡Œå¤åˆ¶å’Œè½¬ç§»ã€‚å“ˆå¸Œè¡¨çš„æ•°æ®è¿ç§»æ˜¯ç”±Â runtime.evacuateÂ å®Œæˆçš„ï¼Œå®ƒä¼šå¯¹æ¡¶ä¸­çš„å…ƒç´ åˆ†æµï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 func evacuate(t *maptype, h *hmap, oldbucket uintptr) { // è®¡ç®—è¦è¿ç§»çš„æ—§æ¡¶ b çš„åœ°å€ b := (*bmap)(add(h.oldbuckets, oldbucket*uintptr(t.BucketSize))) // è®¡ç®—æ‰©å®¹å‰æ¡¶çš„æ•°é‡ newbit := h.noldbuckets() // è‹¥ b æ²¡æœ‰è¢«è¿ç§» if !evacuated(b) { // åˆ›å»ºä¸¤ä¸ª evacDst ç»“æ„ä½“ç”¨äºä¿å­˜åˆ†é…ä¸Šä¸‹æ–‡ // å®ƒä»¬åˆ†åˆ«æŒ‡å‘ä¸€ä¸ªæ–°æ¡¶ var xy [2]evacDst x := \u0026xy[0] // è¿ç§»åˆ° x æ‰§è¡Œçš„æ¡¶åºå·ä¸å˜ x.b = (*bmap)(add(h.buckets, oldbucket*uintptr(t.BucketSize))) x.k = add(unsafe.Pointer(x.b), dataOffset) x.e = add(x.k, bucketCnt*uintptr(t.KeySize)) // åªæœ‰åœ¨ç¿»å€æ‰©å®¹çš„æƒ…å†µä¸‹æ‰è®¡ç®— y if !h.sameSizeGrow() { y := \u0026xy[1] // è¿ç§»åˆ° y æŒ‡å‘çš„æ¡¶åºå·å¢åŠ æ‰©å®¹å‰æ¡¶çš„æ•°é‡ y.b = (*bmap)(add(h.buckets, (oldbucket+newbit)*uintptr(t.BucketSize))) y.k = add(unsafe.Pointer(y.b), dataOffset) y.e = add(y.k, bucketCnt*uintptr(t.KeySize)) } // éå†æ‰€æœ‰çš„æ­£å¸¸æ¡¶å’Œæº¢å‡ºæ¡¶ for ; b != nil; b = b.overflow(t) { k := add(unsafe.Pointer(b), dataOffset) e := add(k, bucketCnt*uintptr(t.KeySize)) // éå†æ¡¶ b ä¸­çš„æ‰€æœ‰å…ƒç´  for i := 0; i \u003c bucketCnt; i, k, e = i+1, add(k, uintptr(t.KeySize)), add(e, uintptr(t.ValueSize)) { top := b.tophash[i] k2 := k var useY uint8 hash := t.hasher(k2, uintptr(h.hash0)) // ç¡®å®šè¯¥å…ƒç´ åº”å½“è¿ç§»åˆ° x æŒ‡å‘çš„æ¡¶è¿˜æ˜¯ y æŒ‡å‘çš„æ¡¶ if hash\u0026newbit != 0 { useY = 1 } b.tophash[i] = evacuatedX + useY dst := \u0026xy[useY] if dst.i == bucketCnt { dst.b = h.newoverflow(t, dst.b) dst.i = 0 dst.k = add(unsafe.Pointer(dst.b), dataOffset) dst.e = add(dst.k, bucketCnt*uintptr(t.KeySize)) } dst.b.tophash[dst.i\u0026(bucketCnt-1)] = top // å°†é”®å€¼å¯¹å¤åˆ¶åˆ°ç›®æ ‡æ¡¶ä¸­ typedmemmove(t.Key, dst.k, k) typedmemmove(t.Elem, dst.e, e) dst.i++ dst.k = add(dst.k, uintptr(t.KeySize)) dst.e = add(dst.e, uintptr(t.ValueSize)) } } ... // è‹¥æ­¤æ¬¡è¿ç§»çš„ bucket ä»£è¡¨å½“å‰è¿ç§»è¿›åº¦ // åˆ™å¢åŠ è®¡æ•°å™¨ nevacuate // å¹¶åœ¨æ‰€æœ‰æ—§æ¡¶è¿ç§»å®Œæˆåæ¸…ç©º oldbuckets å’Œ oldoverflow if oldbucket == h.nevacuate { advanceEvacuationMark(h, t, newbit) } ä¸¾ä¾‹æ¥è¯´ï¼Œæ—§æ¡¶æ•°é‡æ˜¯ 4ï¼Œæ–°æ¡¶æ•°é‡æ˜¯ 8ã€‚åˆ™æ—§æ¡¶çš„æ©ç æ˜¯ $11_2$ï¼Œæ–°æ¡¶çš„æ©ç æ˜¯ $111_2$ã€‚é‚£ä¹ˆæ—§æ¡¶ä¸­ 3 å·æ¡¶çš„å…ƒç´ ï¼ˆå“ˆå¸Œå€¼åä¸¤ä½ä¸º $11$ï¼‰å°±ä¼šè¢«åˆ†æµåˆ°æ–°æ¡¶ä¸­çš„ 3 å·æ¡¶ï¼ˆå“ˆå¸Œå€¼åä¸‰ä½ä¸º $011$ï¼‰å’Œ 7 å·æ¡¶ï¼ˆå“ˆå¸Œå€¼åä¸‰ä½ä¸º $111$ï¼‰ï¼š\n![[Pasted image 20221207000509.png]]\nä¹‹å‰åœ¨åˆ†æè®¿é—®å“ˆå¸Œè¡¨æ—¶å…¶å®çœç•¥äº†æ‰©å®¹æœŸé—´è·å–é”®å€¼å¯¹çš„é€»è¾‘ï¼Œå½“å“ˆå¸Œè¡¨çš„oldbucketså­˜åœ¨æ—¶ï¼Œä¼šå…ˆå®šä½åˆ°æ—§æ¡¶å¹¶åœ¨è¯¥æ¡¶æ²¡æœ‰è¢«è¿ç§»æ—¶ä»ä¸­è·å–é”®å€¼å¯¹ã€‚\nè€Œå½“å“ˆå¸Œè¡¨æ­£åœ¨å¤„äºæ‰©å®¹çŠ¶æ€æ—¶ï¼Œåªæœ‰å‘å“ˆå¸Œè¡¨å†™å…¥å€¼æ—¶æ‰ä¼šè§¦å‘Â runtime.growWorkÂ å¢é‡å¤åˆ¶å“ˆå¸Œè¡¨ä¸­çš„å†…å®¹ã€‚å…ˆè¿ç§»æ—§æ¡¶ï¼Œå†å®Œæˆå†™å…¥ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 func mapassign(t *maptype, h *hmap, key unsafe.Pointer) unsafe.Pointer { ... again: bucket := hash \u0026 bucketMask(h.B) if h.growing() { growWork(t, h, bucket) } ... } func growWork(t *maptype, h *hmap, bucket uintptr) { // evacuate å°†æ—§æ¡¶ä¸­çš„å…ƒç´ è¿ç§»åˆ°æ‰©å®¹åçš„æ–°æ¡¶ evacuate(t, h, bucket\u0026h.oldbucketmask()) // å¦‚æœå·²å¤„äºæ‰©å®¹é˜¶æ®µï¼Œåˆ™å†è¿ç§»ç¬¬ä¸€ä¸ªæœªè¿ç§»çš„æ—§æ¡¶ // é˜²æ­¢æŸäº›æ—§æ¡¶æ²¡æœ‰è¢«å†™å…¥å¯¼è‡´æ‰©å®¹é•¿æ—¶é—´æ— æ³•å®Œæˆ if h.growing() { evacuate(t, h, h.nevacuate) } } ä¼ å…¥è¯¥å‡½æ•°çš„bucketå‚æ•°æ˜¯æˆ‘ä»¬å³å°†è®¿é—®çš„æŸä¸€ä¸ªæ–°æ¡¶ï¼Œbucket\u0026h.oldbucketmask()æ˜¯ä¸ä¹‹å¯¹åº”çš„æ—§æ¡¶åœ°å€ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œæ—§æ¡¶æ•°é‡æ˜¯ 4ï¼Œæ–°æ¡¶æ•°é‡æ˜¯ 8ï¼Œæ—§æ¡¶çš„æ©ç æ˜¯ $11_2$ã€‚å¦‚æœbucketæŒ‡å‘æ–°æ¡¶ä¸­çš„ 5 å·æ¡¶ï¼Œé‚£ä¹ˆå®ƒåœ¨æ—§æ¡¶ä¸­çš„åºå·å°±åº”å½“æ˜¯ $0101\\space \u0026 \\space 0011 = 0001$ï¼Œå³ 1 å·ã€‚è¯¥å‡½æ•°ä»…æ“ä½œå•ä¸ªæ¡¶è€Œéæ•´ä¸ªbmapæ•°ç»„ï¼Œå› æ­¤ Go è¯­è¨€ä¸­å“ˆå¸Œçš„æ‰©å®¹æ˜¯æ¸è¿›å¼çš„ï¼Œæ¯æ¬¡æœ€å¤šè¿ç§»ä¸¤ä¸ªæ¡¶ã€‚\nåˆ é™¤ deleteå…³é”®å­—å¯ä»¥åˆ é™¤å“ˆå¸Œè¡¨ä¸­æŸä¸€ä¸ªé”®å¯¹åº”çš„å…ƒç´ ï¼Œå®ƒä¼šåœ¨ç¼–è¯‘æ—¶è¢«è½¬æ¢ä¸ºÂ runtime.mapdeleteÂ å‡½æ•°ç°‡ä¸­çš„ä¸€ä¸ªã€‚ç”¨äºå¤„ç†åˆ é™¤é€»è¾‘çš„å‡½æ•°ä¸Â runtime.mapassign å‡ ä¹å®Œå…¨ç›¸åŒï¼Œä¸å¤ªéœ€è¦åˆ»æ„å…³æ³¨ã€‚\nå­—ç¬¦ä¸² Go è¯­è¨€ä¸­çš„å­—ç¬¦ä¸²æ˜¯ä¸€ä¸ªåªè¯»çš„å­—èŠ‚æ•°ç»„ï¼š\n![[Pasted image 20221209001155.png]]\nä¸è¿‡æˆ‘ä»¬ä»ç„¶å¯ä»¥é€šè¿‡åœ¨stringå’Œ[]byteç±»å‹ä¹‹é—´åå¤è½¬æ¢å®ç°ä¿®æ”¹è¿™ä¸€ç›®çš„ï¼š\nå…ˆå°†è¿™æ®µå†…å­˜å¤åˆ¶åˆ°å †æˆ–è€…æ ˆä¸Šï¼› å°†å˜é‡çš„ç±»å‹è½¬æ¢æˆ[]byteåå¹¶ä¿®æ”¹å­—èŠ‚æ•°æ®ï¼› å°†ä¿®æ”¹åçš„å­—èŠ‚æ•°ç»„è½¬æ¢å›stringï¼› ä½¿ç”¨åŒå¼•å·å£°æ˜çš„å­—ç¬¦ä¸²åªèƒ½ç”¨äºå•è¡Œå­—ç¬¦ä¸²çš„åˆå§‹åŒ–ï¼Œå¦‚æœå­—ç¬¦ä¸²å†…éƒ¨å‡ºç°åŒå¼•å·ï¼Œåˆ™éœ€è¦ä½¿ç”¨\\ç¬¦å·é¿å…ç¼–è¯‘å™¨çš„è§£æé”™è¯¯ã€‚è€Œåå¼•å·å£°æ˜çš„å­—ç¬¦ä¸²å¯ä»¥æ‘†è„±å•è¡Œçš„é™åˆ¶ï¼Œå¹¶ä¸”å¯ä»¥åœ¨å­—ç¬¦ä¸²å†…éƒ¨ç›´æ¥ä½¿ç”¨\"ï¼Œåœ¨é‡åˆ°éœ€è¦æ‰‹å†™ JSON æˆ–è€…å…¶ä»–å¤æ‚æ•°æ®æ ¼å¼çš„åœºæ™¯ä¸‹éå¸¸æ–¹ä¾¿ï¼š\n1 2 3 4 str1 := \"this is a string\" str2 := `this is another string` json := `{\"author\": \"draven\", \"tags\": [\"golang\"]}` æ•°æ®ç»“æ„ æ¯ä¸€ä¸ªå­—ç¬¦ä¸²åœ¨è¿è¡Œæ—¶éƒ½ä¼šä½¿ç”¨å¦‚ä¸‹çš„Â internal/unsafeheader.StringÂ è¡¨ç¤ºï¼Œå…¶ä¸­åŒ…å«æŒ‡å‘å­—èŠ‚æ•°ç»„çš„æŒ‡é’ˆå’Œæ•°ç»„çš„å¤§å°ï¼š\n1 2 3 4 type String struct { Data unsafe.Pointer Len int } å› æ­¤æˆ‘ä»¬å¸¸è¯´å­—ç¬¦ä¸²æ˜¯åªè¯»çš„åˆ‡ç‰‡ç±»å‹ï¼Œæ‰€æœ‰åœ¨å­—ç¬¦ä¸²ä¸Šçš„å†™å…¥æ“ä½œéƒ½æ˜¯é€šè¿‡å¤åˆ¶å®ç°çš„ã€‚\næ‹¼æ¥ æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿è¡Œæ—¶ä¼šè°ƒç”¨copyå°†è¾“å…¥çš„å¤šä¸ªå­—ç¬¦ä¸²å¤åˆ¶åˆ°ç›®æ ‡å­—ç¬¦ä¸²æ‰€åœ¨çš„å†…å­˜ç©ºé—´ã€‚æ–°çš„å­—ç¬¦ä¸²æ˜¯ä¸€ç‰‡æ–°çš„å†…å­˜ç©ºé—´ï¼Œä¸åŸæ¥çš„å­—ç¬¦ä¸²ä¹Ÿæ²¡æœ‰ä»»ä½•å…³è”ï¼Œä¸€æ—¦éœ€è¦æ‹¼æ¥çš„å­—ç¬¦ä¸²éå¸¸å¤§ï¼Œå¤åˆ¶å¸¦æ¥çš„æ€§èƒ½æŸå¤±æ˜¯æ— æ³•å¿½ç•¥çš„ã€‚\n![[Pasted image 20240714210009.png]]\nå¦‚æœéœ€è¦æ‹¼æ¥å¤šæ¬¡ï¼Œåº”ä½¿ç”¨strings.Builderï¼Œæœ€å°åŒ–å†…å­˜å¤åˆ¶æ¬¡æ•°ã€‚\nç±»å‹è½¬æ¢ ä»å­—èŠ‚æ•°ç»„[]byteåˆ°å­—ç¬¦ä¸²çš„è½¬æ¢éœ€è¦ä½¿ç”¨Â runtime.slicebytetostringÂ å‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // ptr æ˜¯æŒ‡å‘åˆ‡ç‰‡ç¬¬ä¸€ä¸ªå…ƒç´ çš„æŒ‡é’ˆ // n æ˜¯åˆ‡ç‰‡çš„é•¿åº¦ï¼Œbuf æ˜¯ç”¨äºä¿å­˜ç»“æœçš„å›ºå®šé•¿åº¦ç¼“å†²åŒº func slicebytetostring(buf *tmpBuf, ptr *byte, n int) string { if n == 0 { return \"\" } ... if n == 1 { p := unsafe.Pointer(\u0026staticuint64s[*ptr]) // unfase.String æ ¹æ®ä¼ å…¥çš„æŒ‡é’ˆå’Œé•¿åº¦ // è¿”å›å®é™…çš„ string return unsafe.String((*byte)(p), 1) } var p unsafe.Pointer // æ ¹æ®ç¼“å†²åŒºå¤§å°å†³å®šæ˜¯å¦éœ€è¦ä¸ºæ–°å­—ç¬¦ä¸²åˆ†é…ä¸€ç‰‡å†…å­˜ç©ºé—´ if buf != nil \u0026\u0026 n \u003c= len(buf) { p = unsafe.Pointer(buf) } else { p = mallocgc(uintptr(n), nil, false) } // å°†å­—èŠ‚æ•°ç»„ä¸­çš„å…ƒç´ å¤åˆ¶åˆ°æ–°çš„å†…å­˜ç©ºé—´ä¸­ memmove(p, unsafe.Pointer(ptr), uintptr(n)) return unsafe.String((*byte)(p), n) } å½“æˆ‘ä»¬æƒ³è¦å°†å­—ç¬¦ä¸²è½¬æ¢æˆ[]byteç±»å‹æ—¶ï¼Œéœ€è¦ä½¿ç”¨Â runtime.stringtoslicebyteÂ å‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func stringtoslicebyte(buf *tmpBuf, s string) []byte { var b []byte if buf != nil \u0026\u0026 len(s) \u003c= len(buf) { *buf = tmpBuf{} // ä¼ å…¥ç¼“å†²åŒºæ—¶ï¼Œç”¨ç¼“å†²åŒºå­˜å‚¨å­—èŠ‚åˆ‡ç‰‡ b = buf[:len(s)] } else { // æ— ç¼“å†²åŒºæ—¶ï¼Œåˆ›å»ºæ–°çš„å­—èŠ‚åˆ‡ç‰‡ b = rawbyteslice(len(s)) } // å°†å­—ç¬¦ä¸²ä¸­çš„å†…å®¹å¤åˆ¶åˆ°å­—èŠ‚åˆ‡ç‰‡ copy(b, s) return b } å› æ­¤ä¸è¿‡æ— è®ºä»å“ªç§ç±»å‹è½¬æ¢åˆ°å¦ä¸€ç§éƒ½éœ€è¦å¤åˆ¶æ•°æ®ï¼Œè€Œå†…å­˜å¤åˆ¶çš„æ€§èƒ½æŸè€—ä¼šéšç€å­—ç¬¦ä¸²å’Œ[]byteé•¿åº¦çš„å¢é•¿è€Œå¢é•¿ã€‚\n","description":"","tags":["Go","Data-structure"],"title":"ã€ŠGo è¯­è¨€è®¾è®¡ä¸å®ç°ã€‹è¯»ä¹¦ç¬”è®°ï¼šæ•°æ®ç»“æ„","uri":"/posts/go-data-structure-note/"},{"content":" åŸä¹¦ä¸­çš„ä»£ç ç‰‡æ®µåŸºäº Go 1.15ï¼Œç¬”è®°åˆ™æ ¹æ® Go 1.22 ç‰ˆæœ¬çš„æ›´æ–°è¿›è¡Œäº†ç›¸åº”æ›¿æ¢ã€‚\né¢„å¤‡çŸ¥è¯† æŠ½è±¡è¯­æ³•æ ‘ æŠ½è±¡è¯­æ³•æ ‘ï¼ˆAbstract Syntax Treeï¼ŒASTï¼‰ï¼Œæ˜¯æºä»£ç è¯­æ³•çš„ç»“æ„çš„ä¸€ç§æŠ½è±¡è¡¨ç¤ºã€‚å®ƒç”¨æ ‘çŠ¶çš„æ–¹å¼è¡¨ç¤ºç¼–ç¨‹è¯­è¨€çš„è¯­æ³•ç»“æ„ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½è¡¨ç¤ºæºä»£ç ä¸­çš„ä¸€ä¸ªå…ƒç´ ï¼Œæ¯ä¸€é¢—å­æ ‘éƒ½è¡¨ç¤ºä¸€ä¸ªè¯­æ³•å…ƒç´ ã€‚ä»¥ä¸‹åˆ—ä»£ç ä¸ºä¾‹ï¼š\n1 2 3 4 5 6 while b â‰  0: if a \u003e b: a := a - b else: b := b - a return a ç¼–è¯‘å™¨çš„è¯­æ³•åˆ†æé˜¶æ®µä¼šç”Ÿæˆå¦‚ä¸‹å›¾æ‰€ç¤ºçš„æŠ½è±¡è¯­æ³•æ ‘ï¼š\næŠ½è±¡è¯­æ³•æ ‘æŠ¹å»äº†æºä»£ç ä¸­ä¸é‡è¦çš„ä¸€äº›å­—ç¬¦â€”â€”ç©ºæ ¼ã€åˆ†å·æˆ–è€…æ‹¬å·ç­‰ç­‰ã€‚ç¼–è¯‘å™¨åœ¨æ‰§è¡Œå®Œè¯­æ³•åˆ†æä¹‹åä¼šè¾“å‡ºä¸€ä¸ªæŠ½è±¡è¯­æ³•æ ‘ï¼Œè¿™ä¸ªæŠ½è±¡è¯­æ³•æ ‘ä¼šè¾…åŠ©ç¼–è¯‘å™¨è¿›è¡Œè¯­ä¹‰åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥ç¡®å®šè¯­æ³•æ­£ç¡®çš„ç¨‹åºæ˜¯å¦å­˜åœ¨ä¸€äº›ç±»å‹ä¸åŒ¹é…çš„é—®é¢˜ã€‚\né™æ€å•èµ‹å€¼ é™æ€å•èµ‹å€¼ï¼ˆStatic Single Assignmentï¼ŒSSAï¼‰æ˜¯ä¸­é—´ä»£ç ï¼ˆIRï¼‰çš„ä¸€ç§ç‰¹æ€§ï¼Œå³æ¯ä¸ªå˜é‡åªä¼šè¢«èµ‹å€¼ä¸€æ¬¡ã€‚åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šç”¨ä¸‹æ ‡å®ç°é™æ€å•èµ‹å€¼ã€‚ä¸‹åˆ—ä»£ç ä¸­ç¬¬ä¸€è¡Œçš„èµ‹å€¼è¯­å¥æ˜¾ç„¶æ²¡æœ‰èµ·åˆ°ä»»ä½•ä½œç”¨ï¼š\n1 2 3 x := 1 x := 2 y := x ä½†å¯¹äºç¼–è¯‘å™¨æ¥è¯´ï¼Œå¿…é¡»æ‰§è¡Œä¸€å®šåˆ†ææ‰èƒ½ç¡®å®šè¿™ä¸€ç‚¹ã€‚è€Œå¦‚æœä¸­é—´ä»£ç å…·å¤‡ SSA ç‰¹æ€§ï¼š\n1 2 3 x_1 := 1 x_2 := 2 y_1 := x_2 ç¼–è¯‘å™¨ä¾¿å¯ä»¥æ¸…æ¥šåœ°å‘ç°x_1å’Œy_1æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œå®ƒåœ¨ç”Ÿæˆæœºå™¨ç æ—¶å°±å¯ä»¥çœå»Â x := 1Â çš„èµ‹å€¼ï¼Œä»è€Œé€šè¿‡å‡å°‘éœ€è¦æ‰§è¡Œçš„æŒ‡ä»¤æ¥ä¼˜åŒ–è¿™æ®µä»£ç ã€‚\nç¼–è¯‘å™¨å‰ç«¯è´Ÿè´£å°†æºä»£ç ç¿»è¯‘æˆä¸ç¼–ç¨‹è¯­è¨€æ— å…³çš„ä¸­é—´ä»£ç ï¼Œåç«¯ä¸»è¦è´Ÿè´£ç›®æ ‡ä»£ç çš„ç”Ÿæˆå’Œä¼˜åŒ–ã€‚å› ä¸º SSA çš„ä¸»è¦ä½œç”¨æ˜¯å¯¹ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œæ‰€ä»¥å®ƒæ˜¯ç¼–è¯‘å™¨åç«¯çš„ä¸€éƒ¨åˆ†ã€‚\nISA å¤æ‚æŒ‡ä»¤é›†ï¼šé€šè¿‡å¢åŠ æŒ‡ä»¤çš„ç±»å‹ï¼Œå‡å°‘éœ€è¦æ‰§è¡Œçš„æŒ‡ä»¤æ•°é‡ï¼› ç²¾ç®€æŒ‡ä»¤é›†ï¼šé€šè¿‡æ›´å°‘çš„æŒ‡ä»¤ç±»å‹å®Œæˆè®¡ç®—ä»»åŠ¡ã€‚ ç¼–è¯‘åŸç† è¯æ³•åˆ†æ è¯æ³•åˆ†æçš„ä½œç”¨æ˜¯è§£ææºä»£ç æ–‡ä»¶ï¼Œå®ƒå°†æ–‡ä»¶ä¸­çš„å­—ç¬¦ä¸²åºåˆ—è½¬æ¢æˆ Token åºåˆ—ï¼ˆå³åˆ†è¯ï¼‰ï¼Œå¦‚package,Â json,Â import,Â â€¦â€¦ï¼Œæ–¹ä¾¿åé¢çš„å¤„ç†å’Œè§£æã€‚æˆ‘ä»¬ä¸€èˆ¬ä¼šæŠŠæ‰§è¡Œè¯æ³•åˆ†æçš„ç¨‹åºç§°ä¸ºè¯æ³•è§£æå™¨ï¼ˆLexerï¼‰ã€‚\nä» Go è¯­è¨€ä¸­å®šä¹‰çš„ Token ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…ƒç´ åˆ†æˆå‡ ä¸ªä¸åŒçš„ç±»åˆ«ï¼Œåˆ†åˆ«æ˜¯åç§°å’Œå­—é¢é‡ã€æ“ä½œç¬¦ã€åˆ†éš”ç¬¦å’Œå…³é”®å­—ã€‚è¯æ³•åˆ†æä¸»è¦ç”±Â cmd/compile/internal/syntax.scannerÂ ç»“æ„ä½“çš„Â nextÂ æ–¹æ³•é©±åŠ¨ï¼Œè¯¥ç»“æ„ä½“ä¼šæŒæœ‰å½“å‰è¢«æ‰«æåˆ°çš„ Tokenï¼Œè€Œè¯¥å‡½æ•°çš„ä¸»ä½“åˆ™æ˜¯ä¸€ä¸ªswitch/caseç»“æ„ã€‚\nè¯­æ³•åˆ†æ è¯­æ³•åˆ†æå™¨åˆ™ä¼šå°†è¯æ³•åˆ†æå™¨è¾“å‡ºçš„ Token åºåˆ—æŒ‰ç…§ç¼–ç¨‹è¯­è¨€è§„å®šå¥½çš„æ–‡æ³•ï¼ˆGrammarï¼‰å½’çº³æˆä¸€ä¸ªÂ SourceFileÂ ç»“æ„ï¼Œå³æŠ½è±¡è¯­æ³•æ ‘ï¼š\n1 2 3 4 5 6 7 \"json.go\": SourceFile { PackageName: \"json\", ImportDecl: []Import{ \"io\", }, TopLevelDecl: ... } è¯¥æ ‘çš„æ ¹èŠ‚ç‚¹ cmd/compile/internal/syntax.File åŒ…å«äº†å½“å‰æ–‡ä»¶æ‰€å±çš„åŒ…åã€å®šä¹‰çš„å¸¸é‡ã€ç»“æ„ä½“å’Œå‡½æ•°ç­‰ï¼š\n1 2 3 4 5 6 7 type File struct { Pragma Pragma PkgName *Name DeclList []Decl Lines uint node } å…¶ä»–èŠ‚ç‚¹çš„ç»“æ„ä½“åˆ™åœ¨ cmd/compile/internal/syntax/nodes.go æ–‡ä»¶ä¸­å®šä¹‰ï¼Œå…¶ä¸­åŒ…å«äº†å…¨éƒ¨å£°æ˜ç±»å‹ï¼Œå¦‚å‡½æ•°å£°æ˜ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 type ( Decl interface { Node aDecl() } ... FuncDecl struct { Attr map[string]bool Recv *Field // æ¥æ”¶è€… Name *Name // å‡½æ•°å Type *FuncType // å‡½æ•°ç±»å‹ Body *BlockStmt // å‡½æ•°ä½“ Pragma Pragma decl } ) ç±»å‹æ£€æŸ¥ ç¼–è¯‘å™¨éå†æŠ½è±¡è¯­æ³•æ ‘ä»¥ä¿è¯èŠ‚ç‚¹ä¸å­˜åœ¨ç±»å‹é”™è¯¯ï¼Œæ‰€æœ‰çš„ç±»å‹é”™è¯¯å’Œä¸åŒ¹é…éƒ½ä¼šåœ¨è¿™ä¸€ä¸ªé˜¶æ®µè¢«æš´éœ²å‡ºæ¥ï¼ˆå¼ºç±»å‹ï¼‰ï¼ŒåŒ…æ‹¬ç»“æ„ä½“å¯¹æ¥å£çš„å®ç°ã€‚\nGo è¯­è¨€çš„ç¼–è¯‘å™¨ä¸ä»…ä½¿ç”¨é™æ€ç±»å‹æ£€æŸ¥æ¥ä¿è¯ç¨‹åºè¿è¡Œçš„ç±»å‹å®‰å…¨ï¼Œè¿˜ä¼šåœ¨ç¼–è¯‘æœŸé—´å¼•å…¥ç±»å‹ä¿¡æ¯ï¼Œè®©å·¥ç¨‹å¸ˆèƒ½å¤Ÿä½¿ç”¨åå°„æ¥åˆ¤æ–­å‚æ•°å’Œå˜é‡çš„ç±»å‹ã€‚å½“æˆ‘ä»¬æƒ³è¦å°†Â interface{}Â è½¬æ¢æˆå…·ä½“ç±»å‹æ—¶ä¼šè¿›è¡ŒåŠ¨æ€ç±»å‹æ£€æŸ¥ï¼Œå¦‚æœæ— æ³•å‘ç”Ÿè½¬æ¢ç¨‹åºå°±ä¼šå´©æºƒã€‚\nç¼–è¯‘å™¨ç±»å‹æ£€æŸ¥çš„ä¸»è¦é€»è¾‘éƒ½åœ¨Â cmd/compile/internal/typecheck.typecheckÂ å’ŒÂ cmd/compile/internal/typecheck.typecheck1Â ä¸­ï¼Œåè€…æ˜¯ç±»å‹æ£€æŸ¥çš„æ ¸å¿ƒã€‚è¯¥å‡½æ•°æ ¹æ®ä¼ å…¥ èŠ‚ç‚¹ çš„æ“ä½œç±»å‹è¿›å…¥ä¸åŒåˆ†æ”¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 func typecheck1(n ir.Node, top int) ir.Node { switch n.Op { ... // type or expr case ir.ODEREF: n := n.(*ir.StarExpr) return tcStar(n, top) ... case ir.OMAKE: n := n.(*ir.CallExpr) return tcMake(n) case ir.ONEW: n := n.(*ir.UnaryExpr) return tcNew(n) ... } } ä»¥OMAKEèŠ‚ç‚¹ä¸ºä¾‹ï¼Œcmd/compile/internal/typecheck.tcMake ä¼šå¯¹ä¼ å…¥makeçš„å‚æ•°è¿›è¡Œåˆæ³•æ€§æ£€æŸ¥ï¼Œå¹¶æ ¹æ®ç¬¬ä¸€ä¸ªå‚æ•°ä¿®æ”¹èŠ‚ç‚¹çš„æ“ä½œç±»å‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 func tcMake(n *ir.CallExpr) ir.Node { args := n.Args if len(args) == 0 { base.Errorf(\"missing argument to make\") n.SetType(nil) return n } n.Args = nil l := args[0] l = typecheck(l, ctxType) t := l.Type() if t == nil { n.SetType(nil) return n } // i ä»£è¡¨å‚æ•°çš„æœ€å°ä¸ªæ•° i := 1 var nn ir.Node switch t.Kind() { ... case types.TSLICE: ... // èŠ‚ç‚¹çš„æ“ä½œç±»å‹å˜ä¸º OMAKESLICE nn = ir.NewMakeExpr(n.Pos(), ir.OMAKESLICE, l, r) case types.TMAP: ... // èŠ‚ç‚¹çš„æ“ä½œç±»å‹å˜ä¸º OMAKEMAP nn = ir.NewMakeExpr(n.Pos(), ir.OMAKEMAP, l, nil) case types.TCHAN: ... // èŠ‚ç‚¹çš„æ“ä½œç±»å‹å˜ä¸º OMAKECHAN nn = ir.NewMakeExpr(n.Pos(), ir.OMAKECHAN, l, nil) } if i \u003c len(args) { base.Errorf(\"too many arguments to make(%v)\", t) n.SetType(nil) return n } nn.SetType(t) return nn } ä¸­é—´ä»£ç ç”Ÿæˆ åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œç¼–è¯‘å™¨ä¼šåœ¨å°†æºä»£ç è½¬æ¢åˆ°æœºå™¨ç çš„è¿‡ç¨‹ä¸­ï¼Œå…ˆæŠŠæºä»£ç è½¬æ¢æˆä¸€ç§ä¸­é—´çš„è¡¨ç¤ºå½¢å¼ï¼Œå³ ä¸­é—´ä»£ç ã€‚å¾ˆå¤šç¼–è¯‘å™¨éœ€è¦å°†æºä»£ç ç¿»è¯‘æˆå¤šç§æœºå™¨ç ï¼Œè€Œç›´æ¥ç¿»è¯‘é«˜çº§ç¼–ç¨‹è¯­è¨€ç›¸å¯¹æ¯”è¾ƒå›°éš¾ã€‚ä¸­é—´ä»£ç æ˜¯ä¸€ç§æ›´æ¥è¿‘æœºå™¨è¯­è¨€çš„è¡¨ç¤ºå½¢å¼ï¼Œå¯¹å®ƒçš„ä¼˜åŒ–å’Œåˆ†æç›¸æ¯”ç›´æ¥åˆ†æé«˜çº§ç¼–ç¨‹è¯­è¨€æ›´å®¹æ˜“ã€‚\nç¼–è¯‘é˜¶æ®µå…¥å£çš„ä¸»å‡½æ•° cmd/compile/internal/gc.Main ä¸­å…³äºä¸­é—´ä»£ç ç”Ÿæˆçš„éƒ¨åˆ†å¦‚ä¸‹ï¼Œä¸»è¦åˆ†ä¸ºé…ç½®åˆå§‹åŒ–å’Œç¼–è¯‘å‡½æ•°ä¸¤éƒ¨åˆ†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func Main(archInit func(*ssagen.ArchInfo)) { ... // Prepare for backend processing. ssagen.InitConfig() ... // The SSA backend supports using multiple goroutines, // so keep it as late as possible to maximize // how much work we can batch and process concurrently. if len(compilequeue) != 0 { compileFunctions() continue } } é…ç½®åˆå§‹åŒ– cmd/compile/internal/ssagen.InitConfig çš„æ‰§è¡Œè¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼Œé¦–å…ˆä¾¿æ˜¯åˆ›å»ºç»“æ„ä½“å¹¶ç¼“å­˜ç±»å‹ä¿¡æ¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 func InitConfig() { // ssa.types å­˜å‚¨äº† Go æ‰€æœ‰åŸºæœ¬ç±»å‹å¯¹åº”çš„æŒ‡é’ˆ types_ := ssa.NewTypes() // types.NewPtr æ ¹æ®ç±»å‹ç”ŸæˆæŒ‡å‘å¯¹åº”ç±»å‹çš„æŒ‡é’ˆ // åŒæ—¶æ ¹æ®ç¼–è¯‘å™¨çš„é…ç½®å°†ç”Ÿæˆçš„æŒ‡é’ˆç±»å‹ç¼“å­˜åœ¨å½“å‰ç±»å‹ä¸­ // ä»è€Œä¼˜åŒ–ç±»å‹æŒ‡é’ˆçš„è·å–æ•ˆç‡ _ = types.NewPtr(types.Types[types.TINTER]) // *interface{} _ = types.NewPtr(types.NewPtr(types.Types[types.TSTRING])) _ = types.NewPtr(types.NewSlice(types.Types[types.TINTER])) ... _ = types.NewPtr(types.ErrorType) // *error è¯¥å‡½æ•°éšåæ ¹æ®å½“å‰çš„ CPU æ¶æ„ã€ç±»å‹ç»“æ„ä½“å’Œä¸Šä¸‹æ–‡ä¿¡æ¯è®¾ç½®ç”¨äºç”Ÿæˆä¸­é—´ä»£ç å’Œæœºå™¨ç çš„å‡½æ•°ã€‚æ‰€æœ‰çš„é…ç½®ä¸€æ—¦è¢«åˆ›å»ºï¼Œåœ¨æ•´ä¸ªç¼–è¯‘æœŸé—´å°±å˜ä¸ºåªè¯»çš„ä¸”è¢«ä¸­é—´ä»£ç ç”Ÿæˆå’Œæœºå™¨ç ç”Ÿæˆé˜¶æ®µå…±äº«ï¼š\n1 2 3 4 // ssa.NewConfig è¿”å›ä¸€ä¸ª ssa.Config ç»“æ„ä½“ // åè€…åŒ…å«äº†ç”¨äºç”Ÿæˆä¸­é—´ä»£ç å’Œæœºå™¨ç çš„å‡½æ•°ä»¥åŠ // ç¼–è¯‘å™¨ä½¿ç”¨çš„æŒ‡é’ˆã€å¯„å­˜å™¨å¤§å°ã€å¯ç”¨å¯„å­˜å™¨åˆ—è¡¨ç­‰ç¼–è¯‘é€‰é¡¹ï¼š ssaConfig = ssa.NewConfig(base.Ctxt.Arch.Name, *types_, base.Ctxt, base.Flag.N == 0, Arch.SoftFloat) æœ€åï¼Œè¯¥å‡½æ•°ä¼šåˆå§‹åŒ–ä¸€äº›ç¼–è¯‘å™¨å¯èƒ½ç”¨åˆ°çš„ Go è¯­è¨€è¿è¡Œæ—¶çš„å‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 // Set up some runtime functions we'll need to call ... // LookupRuntimeFunc looks up Go function name in package runtime // è¡¨ç¤ºè¯¥æ–¹æ³•å·²ç»æ³¨å†Œåˆ°è¿è¡Œæ—¶åŒ…ä¸­ ir.Syms.Growslice = typecheck.LookupRuntimeFunc(\"growslice\") ir.Syms.Memmove = typecheck.LookupRuntimeFunc(\"memmove\") ir.Syms.Newobject = typecheck.LookupRuntimeFunc(\"newobject\") ... éå†å’Œæ›¿æ¢ åœ¨ç”Ÿæˆä¸­é—´ä»£ç ä¹‹å‰ï¼Œç¼–è¯‘å™¨è¿˜éœ€è¦æ›¿æ¢æŠ½è±¡è¯­æ³•æ ‘ä¸­èŠ‚ç‚¹çš„ä¸€äº›å…ƒç´ ï¼Œè¿™æ˜¯é€šè¿‡ cmd/compile/internal/walk åŒ…ä¸­çš„ç›¸å…³å‡½æ•°å®ç°çš„ï¼š\n1 2 3 4 5 6 7 func walkExpr1(n ir.Node, init *ir.Nodes) ir.Node {} func walkAppend(n *ir.CallExpr, init *ir.Nodes, dst ir.Node) ir.Node {} func walkMakeMap(n *ir.MakeExpr, init *ir.Nodes) ir.Node {} func walkMakeSlice(n *ir.MakeExpr, init *ir.Nodes) ir.Node {} func walkSelect(sel *ir.SelectStmt) {} func walkSwitch(sw *ir.SwitchStmt) {} ... å®ƒä»¬ä¼šå°†ä¸€äº›å…³é”®å­—å’Œå†…å»ºå‡½æ•°è½¬æ¢æˆè¿è¡Œæ—¶åŒ…ä¸­çš„å‡½æ•°è°ƒç”¨ï¼š\nå› æ­¤ï¼Œå…³é”®å­—å’Œå†…ç½®å‡½æ•°çš„åŠŸèƒ½æ˜¯ç”±ç¼–è¯‘å™¨å’Œè¿è¡Œæ—¶å…±åŒå®Œæˆçš„ï¼š\nSSA ç”Ÿæˆ ç»è¿‡walkç³»åˆ—å‡½æ•°çš„å¤„ç†ä¹‹åï¼ŒæŠ½è±¡è¯­æ³•æ ‘å°±ä¸ä¼šå†æ”¹å˜äº†ã€‚æ”¹å†™åçš„è¯­æ³•æ ‘ä¼šç»è¿‡å¤šè½®å¤„ç†ï¼ˆå»æ‰æ— ç”¨ä»£ç å¹¶ç²¾ç®€æ“ä½œæ•°ï¼‰è½¬å˜æˆæœ€åçš„ SSA ä¸­é—´ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤ç”Ÿæˆmain.goçš„ä¸­é—´ä»£ç ssa.htmlï¼š\n1 2 3 4 5 $ GOSSAFUNC=main go build main.go # runtime dumped SSA to /usr/local/Cellar/go/1.14.2_1/libexec/src/runtime/ssa.html # command-line-arguments dumped SSA to ./ssa.html æœºå™¨ç ç”Ÿæˆ Go è¯­è¨€æºä»£ç çš„Â cmd/compile/internalÂ ç›®å½•ä¸­åŒ…å«äº†å¾ˆå¤šæœºå™¨ç ç”Ÿæˆç›¸å…³çš„åŒ…ï¼Œä¸åŒç±»å‹çš„ CPU åˆ†åˆ«ä½¿ç”¨äº†ä¸åŒçš„åŒ…ç”Ÿæˆæœºå™¨ç ï¼Œå…¶ä¸­åŒ…æ‹¬ amd64ã€armã€arm64ã€mipsã€mips64ã€ppc64ã€s390xã€x86 å’Œ wasmã€‚\næœºå™¨ç çš„ç”Ÿæˆä¸»è¦ç”±ä¸¤éƒ¨åˆ†ååŒå®Œæˆï¼š\nSSA é™çº§ï¼šå°†ä¸­é—´ä»£ç é™çº§ä¸ºæ±‡ç¼–ä»£ç ï¼› æ±‡ç¼–å™¨ï¼šå°†æ±‡ç¼–ä»£ç ç¿»è¯‘ä¸ºæœºå™¨ç ã€‚ æ¨èé˜…è¯» Lexical Scanning in Go - Rob Pike Go: Overview of the Compiler ","description":"","tags":["Go","Compiler-principle"],"title":"ã€ŠGo è¯­è¨€è®¾è®¡ä¸å®ç°ã€‹è¯»ä¹¦ç¬”è®°ï¼šç¼–è¯‘åŸç†","uri":"/posts/go-compiler-principle-note/"},{"content":"æ ¹æ® ç¬¬å…«ç«  ä»‹ç»çš„å†…å®¹ï¼Œä¸¤ä¸ªåœ¨æ—¶é—´ä¸Šé‡å çš„é€»è¾‘æ§åˆ¶æµæ˜¯å¹¶å‘çš„ã€‚ç¡¬ä»¶å¼‚å¸¸å¤„ç†ç¨‹åºã€è¿›ç¨‹å’Œ Linux ä¿¡å·å¤„ç†ç¨‹åºç­‰éƒ½æ˜¯è®¡ç®—æœºç³»ç»Ÿåœ¨ä¸åŒå±‚çº§ä¸Šå¯¹å¹¶å‘çš„åº”ç”¨ã€‚ç°ä»£æ“ä½œç³»ç»Ÿä¸ºæ„å»ºå¹¶å‘ç¨‹åºæä¾›äº†ä¸‰ç§åŸºæœ¬æ–¹æ³•ï¼š\nè¿›ç¨‹ I/O å¤šè·¯å¤ç”¨ï¼ˆMultiplexingï¼‰ çº¿ç¨‹ï¼ˆThreadï¼‰ ä½¿ç”¨è¿›ç¨‹å®ç°å¹¶å‘ æ„å»ºå¹¶å‘ç¨‹åºæœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨è¿›ç¨‹ï¼Œå¦‚åœ¨çˆ¶è¿›ç¨‹ä¸­æ¥å—å®¢æˆ·ç«¯è¯·æ±‚ï¼Œç„¶ååˆ›å»ºå­è¿›ç¨‹ä¸ºå®¢æˆ·ç«¯æä¾›æœåŠ¡ã€‚\nå‡è®¾æœåŠ¡å™¨åœ¨ç›‘å¬æè¿°ç¬¦listenfd(3)ä¸Šæ¥å—æ¥è‡ªå®¢æˆ·ç«¯ 1 çš„è¿æ¥è¯·æ±‚ï¼Œå¹¶è¿”å›ä¸€ä¸ªè¿æ¥æè¿°ç¬¦connfd(4)ï¼š\næœåŠ¡å™¨å°†è°ƒç”¨forkåˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼ˆä¸‹å›¾ä¸­çš„â€œChild 1â€ï¼‰ï¼Œå®ƒè·å¾—æœåŠ¡å™¨ æè¿°ç¬¦è¡¨ çš„å®Œæ•´å‰¯æœ¬ã€‚ç”±äºå­è¿›ç¨‹ä¸å†éœ€è¦ç›‘å¬æè¿°ç¬¦ï¼Œè€Œçˆ¶è¿›ç¨‹ä¸å†éœ€è¦è¿æ¥æè¿°ç¬¦ï¼Œæˆ‘ä»¬åº”å½“å°†å®ƒä»¬å…³é—­ï¼š\néšåæœåŠ¡å™¨æ¥å—æ¥è‡ªå®¢æˆ·ç«¯ 2 çš„è¿æ¥è¯·æ±‚å¹¶è¿”å›ä¸€ä¸ªæ–°çš„è¿æ¥æè¿°ç¬¦connfd(5)ï¼š\næœåŠ¡å™¨å†æ¬¡è°ƒç”¨forkåˆ›å»ºå¦ä¸€ä¸ªå­è¿›ç¨‹ï¼ˆä¸‹å›¾ä¸­çš„â€œChild 2â€ï¼‰ã€‚æ­¤æ—¶ï¼Œçˆ¶è¿›ç¨‹æ­£åœ¨ç­‰å¾…ä¸‹ä¸€ä¸ªè¿æ¥è¯·æ±‚ï¼Œä¸¤ä¸ªå­è¿›ç¨‹åˆ™å¹¶å‘åœ°ä¸ºå„è‡ªçš„å®¢æˆ·ç«¯æä¾›æœåŠ¡ï¼š\nåŸºäºè¿›ç¨‹çš„å¹¶å‘æœåŠ¡å™¨ ä¸€ä¸ªåŸºäºè¿›ç¨‹çš„å¹¶å‘æœåŠ¡å™¨ä»£ç å¦‚ä¸‹ï¼Œå…¶ä¸­ç¬¬ 32 è¡Œè°ƒç”¨çš„echoå‡½æ•°æ¥è‡ªäºä¸Šä¸€ç« ä»‹ç»çš„ echo.cï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 #include \"csapp.h\" void echo(int connfd); void sigchld_handler(int sig) { while (waitpid(-1, 0, WNOHANG) \u003e 0) ; return; } int main(int argc, char **argv) { int listenfd, connfd; socklen_t clientlen; struct sockaddr_storage clientaddr; if (argc != 2) { fprintf(stderr, \"usage: %s \u003cport\u003e\\n\", argv[0]); exit(0); } Signal(SIGCHLD, sigchld_handler); listenfd = Open_listenfd(argv[1]); while (1) { clientlen = sizeof(struct sockaddr_storage); connfd = Accept(listenfd, (SA *)\u0026clientaddr, \u0026clientlen); if (Fork() == 0) { Close(listenfd); /* Child closes its listening socket */ echo(connfd); /* Child services client */ Close(connfd); /* Child closes connection with client */ exit(0); /* Child exits */ } Close(connfd); /* Parent closes connected socket (important!) */ } } è€ƒè™‘åˆ°æœåŠ¡å™¨å°†è¿è¡Œå¾ˆé•¿æ—¶é—´ï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…ä¸€ä¸ª SIGCHLD ä¿¡å·å¤„ç†ç¨‹åºæ¥å›æ”¶å­è¿›ç¨‹ï¼ˆç¬¬ 4ï½9 è¡Œï¼‰ï¼Œè¯¦è§ æ­£ç¡®çš„ä¿¡å·å¤„ç†ã€‚\nçˆ¶è¿›ç¨‹å¿…é¡»å…³é—­connfdï¼ˆç¬¬ 36 è¡Œï¼‰ï¼Œå¦åˆ™è¿æ¥æè¿°ç¬¦æŒ‡å‘çš„ æ‰“å¼€æ–‡ä»¶è¡¨æ¡ç›® æ°¸è¿œä¸ä¼šè¢«é‡Šæ”¾ï¼Œä»è€Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚å­è¿›ç¨‹åˆ™ä¸éœ€è¦å…³é—­connfdï¼ˆç¬¬ 33 è¡Œå¯ä»¥çœç•¥ï¼‰ï¼Œå› ä¸ºå®ƒä¼šåœ¨å­è¿›ç¨‹é€€å‡ºæ—¶ç”±å†…æ ¸è‡ªåŠ¨å…³é—­ã€‚\nè¿›ç¨‹çš„ä¼˜ç¼ºç‚¹ çˆ¶å­è¿›ç¨‹å…±äº«æ‰“å¼€æ–‡ä»¶è¡¨ï¼Œä½†å¹¶ä¸å…±äº«ç”¨æˆ·åœ°å€ç©ºé—´ï¼ˆè™šæ‹Ÿå†…å­˜ï¼‰ï¼Œå› æ­¤è¿›ç¨‹ä¹‹é—´å¿…é¡»æ˜¾å¼åœ°ä½¿ç”¨ IPCï¼ˆInterprocess Communicationsï¼‰æœºåˆ¶æ¥å…±äº«çŠ¶æ€ä¿¡æ¯ã€‚ç”±äºè¿›ç¨‹æ§åˆ¶å’Œ IPC çš„å¼€é”€å¾ˆé«˜ï¼ŒåŸºäºè¿›ç¨‹çš„å¹¶å‘ç¨‹åºå¾€å¾€å¾ˆæ…¢ã€‚\nä½¿ç”¨ I/O å¤šè·¯å¤ç”¨å®ç°å¹¶å‘ I/O å¤šè·¯å¤ç”¨æŠ€æœ¯çš„åŸºæœ¬æ€æƒ³æ˜¯åº”ç”¨ç¨‹åºè°ƒç”¨selectå‡½æ•°ç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œç­‰å¾…ä¸€ä¸ªæˆ–å¤šä¸ªæè¿°ç¬¦å‡†å¤‡å¥½ç”¨äºæŸç§ I/O æ“ä½œã€‚è¯¥å‡½æ•°ååˆ†å¤æ‚å¹¶æœ‰å¤šç§ä½¿ç”¨åœºæ™¯ï¼Œè¿™é‡Œæˆ‘ä»¬åªè®¨è®º I/O æ“ä½œä¸ºè¯»å–çš„æƒ…å†µï¼š\n1 2 3 4 5 6 7 8 9 #include \u003csys/select.h\u003e int select(int n, fd_set *fdset, NULL, NULL, NULL); // Returns: nonzero count of ready descriptors, âˆ’1 on error // Macros for manipulating descriptor sets FD_ZERO(fd_set *fdset); /* Clear all bits in fdset */ FD_CLR(int fd, fd_set *fdset); /* Clear bit fd in fdset */ FD_SET(int fd, fd_set *fdset); /* Turn on bit fd in fdset */ FD_ISSET(int fd, fd_set *fdset); /* Is bit fd in fdset on? */ å‚æ•°fd_setæ˜¯ä¸€ä¸ªæè¿°ç¬¦é›†ï¼Œå®ƒåœ¨é€»è¾‘ä¸Šæ˜¯ä¸€ä¸ªä½å‘é‡ï¼ˆå›ºå®šé•¿åº¦çš„ 0ï¼Œ1 åºåˆ—ï¼‰ï¼š\n$$b_{n - 1},â€¦, b_1, b_0$$\nå…¶ä¸­çš„æ¯ä¸ªä½ $b_k$ éƒ½å¯¹åº”äº†ä¸€ä¸ªæè¿°ç¬¦ $k$ã€‚å½“ä¸”ä»…å½“ $b_k$ ç­‰äº 1 æ—¶ï¼Œæè¿°ç¬¦ $k$ å±äºè¯¥æè¿°ç¬¦é›†ã€‚\nåœ¨æˆ‘ä»¬çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œå‚æ•°fd_setæ˜¯è¯»å–æè¿°ç¬¦é›†ï¼ˆRead Setï¼‰ï¼Œå‚æ•°næ˜¯è¯»å–é›†çš„åŸºæ•°ï¼ˆCardinalityï¼‰ã€‚ç¨‹åºè°ƒç”¨selectå‡½æ•°åä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°è¯»å–é›†ä¸­è‡³å°‘æœ‰ä¸€ä¸ªæè¿°ç¬¦å‡†å¤‡å¥½è¢«è¯»å–ï¼ˆå³ä»è¯¥æè¿°ç¬¦ä¸­è¯»å–ä¸€ä¸ªå­—èŠ‚çš„è¯·æ±‚ä¸ä¼šé˜»å¡ï¼‰ã€‚\næˆ‘ä»¬å°†è¯»å–é›†ä¸­å·²å‡†å¤‡å¥½è¢«è¯»å–çš„æè¿°ç¬¦é›†åˆç§°ä¸ºå°±ç»ªé›†ï¼ˆReady Setï¼‰ã€‚selectå‡½æ•°ä¼šå°†fdsetä¿®æ”¹ä¸ºå°±ç»ªé›†ï¼Œå¹¶è¿”å›å°±ç»ªé›†çš„åŸºæ•°ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åœ¨æ¯æ¬¡è°ƒç”¨è¯¥å‡½æ•°å‰éƒ½åº”å½“å…ˆæ›´æ–°è¯»å–é›†ã€‚\nåŸºäº I/O å¤šè·¯å¤ç”¨çš„å¹¶å‘æœåŠ¡å™¨ ä¸€ä¸ªåŸºäº I/O å¤šè·¯å¤ç”¨çš„å¹¶å‘æœåŠ¡å™¨ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 #include \"csapp.h\" typedef struct { /* represents a pool of connected descriptors */ int maxfd; /* largest descriptor in read_set */ fd_set read_set; /* set of all active descriptors */ fd_set ready_set; /* subset of descriptors ready for reading */ int nready; /* number of ready descriptors from select */ int maxi; /* highwater index into client array */ int clientfd[FD_SETSIZE]; /* set of active descriptors */ rio_t clientrio[FD_SETSIZE]; /* set of active read buffers */ } pool; int byte_cnt = 0; /* counts total bytes received by server */ int main(int argc, char **argv) { int listenfd, connfd; socklen_t clientlen; struct sockaddr_storage clientaddr; static pool pool; if (argc != 2) { fprintf(stderr, \"usage: %s \u003cport\u003e\\n\", argv[0]); exit(0); } listenfd = Open_listenfd(argv[1]); init_pool(listenfd, \u0026pool); while (1) { /* Wait for listening/connected descriptor(s) to become ready */ pool.ready_set = pool.read_set; pool.nready = Select(pool.maxfd + 1, \u0026pool.ready_set, NULL, NULL, NULL); /* If listening descriptor ready, add new client to pool */ if (FD_ISSET(listenfd, \u0026pool.ready_set)) { clientlen = sizeof(struct sockaddr_storage); connfd = Accept(listenfd, (SA *)\u0026clientaddr, \u0026clientlen); add_client(connfd, \u0026pool); } /* Echo a text line from each ready connected descriptor */ check_clients(\u0026pool); } } è¯¥ç¨‹åºä½¿ç”¨poolç±»å‹çš„ç»“æ„ä½“ï¼ˆç¬¬ 3ï½12 è¡Œï¼‰ä¿å­˜æ´»è·ƒçš„å®¢æˆ·ç«¯ï¼Œå¹¶ä½¿ç”¨init_poolå‡½æ•°åˆå§‹åŒ–å®¢æˆ·ç«¯æ± ï¼ˆç¬¬ 29 è¡Œï¼‰ã€‚åœ¨æ— é™å¾ªç¯çš„æ¯æ¬¡è¿­ä»£ä¸­ï¼ŒæœåŠ¡å™¨è°ƒç”¨selectå‡½æ•°æ£€æµ‹ä¸¤ç§ä¸åŒç±»å‹çš„è¾“å…¥äº‹ä»¶ï¼šæ¥è‡ªæ–°å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ï¼›ä¸ºç°æœ‰å®¢æˆ·ç«¯æä¾›æœåŠ¡çš„è¿æ¥æè¿°ç¬¦å·²å‡†å¤‡å¥½è¢«è¯»å–ã€‚å½“è¿æ¥è¯·æ±‚åˆ°è¾¾æ—¶ï¼ˆç¬¬ 38 è¡Œï¼‰ï¼ŒæœåŠ¡å™¨æ‰“å¼€è¿æ¥ï¼ˆç¬¬ 41 è¡Œï¼‰å¹¶å°†æ–°å®¢æˆ·ç«¯åŠ å…¥åˆ°å®¢æˆ·ç«¯æ± ä¸­ï¼ˆç¬¬ 42 è¡Œï¼‰ã€‚æœ€åï¼ŒæœåŠ¡å™¨è°ƒç”¨check_clientså‡½æ•°å‘æ¯ä¸ªå·²è¿æ¥çš„æè¿°ç¬¦å†™å…¥æ–‡æœ¬è¡Œï¼ˆç¬¬ 46 è¡Œï¼‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 void init_pool(int listenfd, pool *p) { /* Initially, there are no connected descriptors */ int i; p-\u003emaxi = -1; for (i = 0; i \u003c FD_SETSIZE; i++) p-\u003eclientfd[i] = -1; /* Initially, listenfd is only member of select read set */ p-\u003emaxfd = listenfd; FD_ZERO(\u0026p-\u003eread_set); FD_SET(listenfd, \u0026p-\u003eread_set); } init_poolå‡½æ•°åˆå§‹åŒ–å®¢æˆ·ç«¯æ± ã€‚p-\u003eclientfdæ•°ç»„åŒ…å«äº†æ‰€æœ‰å·²è¿æ¥çš„æè¿°ç¬¦ï¼Œä¸€å¼€å§‹æˆ‘ä»¬ä½¿ç”¨ -1 å¡«å……å®ƒï¼ˆç¬¬ 5ï½7 è¡Œï¼‰ã€‚æ­¤æ—¶listenfdæ˜¯è¯»å–é›†p-\u003eread_setä¸­å”¯ä¸€çš„æè¿°ç¬¦ï¼ˆç¬¬ 10ï½12 è¡Œï¼‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 void add_client(int connfd, pool *p) { int i; p-\u003enready--; for (i = 0; i \u003c FD_SETSIZE; i++) /* Find an available slot */ if (p-\u003eclientfd[i] \u003c 0) { /* Add connected descriptor to the pool */ p-\u003eclientfd[i] = connfd; Rio_readinitb(\u0026p-\u003eclientrio[i], connfd); /* Add the descriptor to descriptor set */ FD_SET(connfd, \u0026p-\u003eread_set); /* Update max descriptor and pool highwater mark */ if (connfd \u003e p-\u003emaxfd) p-\u003emaxfd = connfd; if (i \u003e p-\u003emaxi) p-\u003emaxi = i; break; } if (i == FD_SETSIZE) /* Couldn't find an empty slot */ app_error(\"add_client error: Too many clients\"); } add_clientå‡½æ•°å°†ä¸€ä¸ªæ–°å®¢æˆ·ç«¯æ·»åŠ åˆ°æ´»è·ƒå®¢æˆ·ç«¯æ± ä¸­ã€‚å¦‚æœp-\u003eclientfdæ•°ç»„ä¸­è¿˜æœ‰ç©ºä½ï¼ˆç¬¬ 6 è¡Œï¼‰ï¼Œè¯¥å‡½æ•°å°±å°†è¿æ¥æè¿°ç¬¦connfdæ·»åŠ åˆ°è¯¥æ•°ç»„å¹¶åˆå§‹åŒ–ä¸€ä¸ªè¯»å–ç¼“å†²åŒºä»¥è°ƒç”¨ rio_readlinebï¼ˆç¬¬ 9ï½10 è¡Œï¼‰ã€‚éšåå‡½æ•°å°†è¿æ¥æè¿°ç¬¦connfdæ·»åŠ åˆ°è¯»å–é›†ï¼ˆç¬¬ 13 è¡Œï¼‰ï¼Œå¹¶æ›´æ–°å®¢æˆ·ç«¯æ± çš„ä¸€äº›å±æ€§ï¼šå˜é‡maxfdä»£è¡¨selectå‡½æ•°ç›‘è§†çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦ï¼›å˜é‡maxiä»£è¡¨p-\u003eclientfdæ•°ç»„çš„æœ€å¤§ç´¢å¼•ï¼ˆè¿™æ ·check_clientså‡½æ•°å°±ä¸éœ€è¦éå†æ•´ä¸ªæ•°ç»„ï¼‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 void check_clients(pool *p) { int i, connfd, n; char buf[MAXLINE]; rio_t rio; for (i = 0; (i \u003c= p-\u003emaxi) \u0026\u0026 (p-\u003enready \u003e 0); i++) { connfd = p-\u003eclientfd[i]; rio = p-\u003eclientrio[i]; /* If the descriptor is ready, echo a text line from it */ if ((connfd \u003e 0) \u0026\u0026 (FD_ISSET(connfd, \u0026p-\u003eready_set))) { p-\u003enready--; if ((n = Rio_readlineb(\u0026rio, buf, MAXLINE)) != 0) { byte_cnt += n; printf(\"Server received %d (%d total) bytes on fd %d\\n\", n, byte_cnt, connfd); Rio_writen(connfd, buf, n); } /* EOF detected, remove descriptor from pool */ else { Close(connfd); FD_CLR(connfd, \u0026p-\u003eread_set); p-\u003eclientfd[i] = -1; } } } } check_clientså‡½æ•°éå†å®¢æˆ·ç«¯æ± ä¸­æ‰€æœ‰å·²å°±ç»ªçš„è¿æ¥æè¿°ç¬¦ï¼Œå¦‚æœä»æè¿°ç¬¦ä¸­è¯»å–æ–‡æœ¬è¡ŒæˆåŠŸï¼ˆç¬¬ 16 è¡Œï¼‰ï¼Œå°±å°†è¯¥è¡Œè¿”å›ç»™å®¢æˆ·ç«¯ï¼ˆç¬¬ 18-21 è¡Œï¼‰ã€‚ä¸€æ—¦å®¢æˆ·ç«¯å…³é—­è¿æ¥ä¸”æœåŠ¡å™¨æ£€æµ‹åˆ° EOFï¼ŒæœåŠ¡å™¨ä¾¿å…³é—­è¿æ¥æè¿°ç¬¦ï¼ˆç¬¬ 27 è¡Œï¼‰å¹¶å°†è¯¥æè¿°ç¬¦ä»è¯»å–é›†å’Œå®¢æˆ·ç«¯æ± ä¸­åˆ é™¤ï¼ˆç¬¬ 28-29 è¡Œï¼‰ã€‚\nI/O å¤šè·¯å¤ç”¨çš„æœ¬è´¨æ˜¯å°†é€»è¾‘æ§åˆ¶æµå»ºæ¨¡ä¸ºçŠ¶æ€æœºï¼ˆState Machinesï¼‰ï¼š\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒåŸºäº I/O å¤šè·¯å¤ç”¨çš„å¹¶å‘æœåŠ¡å™¨ä¸ºæ¯ä¸ªæ–°å®¢æˆ·ç«¯ $k$ åˆ›å»ºä¸€ä¸ªçŠ¶æ€æœº $s_k$ å¹¶å°†å…¶ä¸è¿æ¥æè¿°ç¬¦ $d_k$ å…³è”ã€‚æ¯ä¸ªçŠ¶æ€æœºéƒ½æœ‰ä¸€ä¸ªçŠ¶æ€ï¼ˆç­‰å¾…æè¿°ç¬¦ $d_k$ å‡†å¤‡å¥½è¢«è¯»å–ï¼‰ï¼Œä¸€ä¸ªè¾“å…¥äº‹ä»¶ï¼ˆæè¿°ç¬¦ $d_k$ å·²å‡†å¤‡å¥½è¢«è¯»å–ï¼‰å’Œä¸€ä¸ªçŠ¶æ€è½¬æ¢ï¼ˆä»æè¿°ç¬¦ $d_k$ ä¸­è¯»å–æ–‡æœ¬è¡Œï¼‰ã€‚\nåœ¨ç¤ºä¾‹çš„å¹¶å‘æœåŠ¡å™¨ä¸­ï¼Œselectå‡½æ•°æ£€æµ‹è¾“å…¥äº‹ä»¶ï¼Œadd_clientå‡½æ•°åˆ›å»ºæ–°çš„çŠ¶æ€æœºï¼ˆé€»è¾‘æ§åˆ¶æµï¼‰ã€‚check_clientså‡½æ•°é€šè¿‡è¯»å†™æ–‡æœ¬è¡Œæ¥æ‰§è¡ŒçŠ¶æ€è½¬æ¢ï¼Œå¹¶åœ¨å®¢æˆ·ç«¯å‘é€å®Œæ–‡æœ¬è¡Œååˆ é™¤çŠ¶æ€æœºã€‚\nI/O å¤šè·¯å¤ç”¨çš„ä¼˜ç¼ºç‚¹ åŸºäº I/O å¤šè·¯å¤ç”¨çš„åº”ç”¨ç¨‹åºè¿è¡Œåœ¨å•ä¸ªè¿›ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå› æ­¤æ¯ä¸ªé€»è¾‘æ§åˆ¶æµéƒ½å¯ä»¥è®¿é—®æ•´ä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œè¿™ä½¿å¾—æ§åˆ¶æµä¹‹é—´å…±äº«æ•°æ®å˜å¾—éå¸¸å®¹æ˜“ã€‚ç”±äºå®ƒä¸éœ€è¦é€šè¿‡ä¸Šä¸‹æ–‡åˆ‡æ¢ç®¡ç†æ–°è¿›ç¨‹ï¼Œç¨‹åºçš„è¿è¡Œæ•ˆç‡è¾ƒé«˜ã€‚åƒ Node.jsã€Nginx å’Œ Tornado ç­‰ç°ä»£é«˜æ€§èƒ½æœåŠ¡å™¨å‡ä½¿ç”¨ I/O å¤šè·¯å¤ç”¨å®ç°ã€‚\nI/O å¤šè·¯å¤ç”¨çš„ç¼ºç‚¹æ˜¯ç¼–ç ååˆ†å¤æ‚ï¼Œå¹¶ä¸”æ— æ³•å……åˆ†åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨ã€‚\nä½¿ç”¨çº¿ç¨‹å®ç°å¹¶å‘ çº¿ç¨‹æ˜¯åœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡ä¸­è¿è¡Œçš„é€»è¾‘æ§åˆ¶æµï¼Œå®ƒç”±å†…æ ¸è‡ªåŠ¨è°ƒåº¦ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„çº¿ç¨‹ä¸Šä¸‹æ–‡ï¼ŒåŒ…æ‹¬ä¸€ä¸ªå”¯ä¸€çš„çº¿ç¨‹ IDï¼ˆTIDï¼‰ã€æ ˆã€æ ˆæŒ‡é’ˆã€ç¨‹åºè®¡æ•°å™¨ã€é€šç”¨å¯„å­˜å™¨å’Œæ¡ä»¶ç å¯„å­˜å™¨ã€‚åœ¨åŒä¸€ä¸ªè¿›ç¨‹å†…è¿è¡Œçš„æ‰€æœ‰çº¿ç¨‹å…±äº«è¯¥è¿›ç¨‹å…¨éƒ¨çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚\nçº¿ç¨‹æ‰§è¡Œæ¨¡å‹ çº¿ç¨‹çš„æ‰§è¡Œæ¨¡å‹ä¸è¿›ç¨‹ç±»ä¼¼ï¼š\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸»çº¿ç¨‹ï¼ˆMain Threadï¼‰æ˜¯è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸçš„å¼€å§‹ï¼Œå®ƒåœ¨æŸä¸€æ—¶åˆ»åˆ›å»ºäº†ä¸€ä¸ªå¯¹ç­‰çº¿ç¨‹ï¼ˆPeer Threadï¼‰ã€‚ä¸¤çº¿ç¨‹åŒæ—¶è¿è¡Œï¼Œæ§åˆ¶æƒé€šè¿‡ä¸Šä¸‹æ–‡åˆ‡æ¢ä¼ é€’ã€‚\nçº¿ç¨‹æ‰§è¡Œä¸è¿›ç¨‹çš„åŒºåˆ«åœ¨äºï¼š\nçº¿ç¨‹ä¸Šä¸‹æ–‡æ¯”è¿›ç¨‹ä¸Šä¸‹æ–‡å°å¾—å¤šï¼Œå› æ­¤çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ¯”è¿›ç¨‹å¿«ï¼› å±äºåŒä¸€è¿›ç¨‹çš„çº¿ç¨‹æ„æˆäº†ä¸€ä¸ªå¯¹ç­‰æ± ï¼Œå®ƒä»¬æ²¡æœ‰çˆ¶å­å±‚çº§ç»“æ„ã€‚çº¿ç¨‹å¯ä»¥æ€æ­»ä»»ä½•å¯¹ç­‰çº¿ç¨‹æˆ–ç­‰å¾…ä»»ä½•å¯¹ç­‰çº¿ç¨‹ç»ˆæ­¢ï¼› æ¯ä¸ªå¯¹ç­‰çº¿ç¨‹éƒ½å¯ä»¥è¯»å†™ç›¸åŒçš„å…±äº«æ•°æ®ã€‚ Posix çº¿ç¨‹ Posix çº¿ç¨‹ï¼ˆPthreadï¼‰æ˜¯ C ç¨‹åºæ“ä½œçº¿ç¨‹çš„æ ‡å‡†æ¥å£ã€‚å®ƒå®šä¹‰äº†å¤§çº¦å…­åä¸ªå‡½æ•°ï¼Œå…è®¸ç¨‹åºåˆ›å»ºçº¿ç¨‹ã€ç»ˆæ­¢çº¿ç¨‹ã€å›æ”¶çº¿ç¨‹ã€ä¸å¯¹ç­‰çº¿ç¨‹å®‰å…¨åœ°å…±äº«æ•°æ®ä»¥åŠé€šçŸ¥å¯¹ç­‰çº¿ç¨‹ç³»ç»ŸçŠ¶æ€çš„å˜åŒ–ç­‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 #include \"csapp/csapp.h\" void *thread(void *vargp) /* thread routine */ { printf(\"Hello, world!\\n\"); return NULL; } int main() { pthread_t tid; Pthread_create(\u0026tid, NULL, thread, NULL); Pthread_join(tid, NULL); exit(0); } ç¤ºä¾‹ç¨‹åºä¸­ï¼Œä¸»çº¿ç¨‹åˆ›å»ºäº†ä¸€ä¸ªå¯¹ç­‰çº¿ç¨‹å¹¶ç­‰å¾…å®ƒç»ˆæ­¢ï¼Œå¯¹ç­‰çº¿ç¨‹åœ¨æ‰“å°Hello, world!\\nåè¿”å›ã€‚\nçº¿ç¨‹çš„ä»£ç å’Œå±€éƒ¨æ•°æ®å°è£…åœ¨çº¿ç¨‹ä¾‹ç¨‹ï¼ˆThread Routineï¼‰ä¸­ï¼Œå®ƒå°†é€šç”¨æŒ‡é’ˆvoid *ä½œä¸ºè¾“å…¥å¹¶è¿”å›å¦ä¸€ä¸ªé€šç”¨æŒ‡é’ˆï¼ˆç¬¬ 2 è¡Œï¼‰ã€‚å¦‚æœéœ€è¦å‘çº¿ç¨‹ä¾‹ç¨‹ä¼ é€’å¤šä¸ªå‚æ•°ï¼Œåˆ™åº”å°†å®ƒä»¬æ”¾å…¥ä¸€ä¸ªç»“æ„ä½“ä¸­å¹¶ä¼ é€’æŒ‡å‘è¯¥ç»“æ„ä½“çš„æŒ‡é’ˆã€‚åŒæ ·ï¼Œå¦‚æœæƒ³è®©çº¿ç¨‹ä¾‹ç¨‹è¿”å›å¤šä¸ªå‚æ•°ï¼Œåˆ™åº”è¿”å›ä¸€ä¸ªæŒ‡å‘åŒ…å«å¤šä¸ªå‚æ•°çš„ç»“æ„ä½“æŒ‡é’ˆã€‚\nåˆ›å»ºçº¿ç¨‹ çº¿ç¨‹è°ƒç”¨å‡½æ•°pthread_createåˆ›å»ºæ–°çº¿ç¨‹ï¼š\n1 2 3 4 5 #include \u003cpthread.h\u003e typedef void *(func)(void *); int pthread_create(pthread_t *tid, pthread_attr_t *attr, func *f, void *arg); // Returns: 0 if OK, nonzero on error å‚æ•°fæ˜¯æ–°çº¿ç¨‹åœ¨å…¶ä¸Šä¸‹æ–‡ä¸­è¿è¡Œçš„ä¾‹ç¨‹ï¼Œå‚æ•°argæ˜¯è¯¥ä¾‹ç¨‹çš„è¾“å…¥å‚æ•°ã€‚å‚æ•°attrå¯ç”¨äºæ›´æ”¹æ–°çº¿ç¨‹çš„é»˜è®¤å±æ€§ï¼Œä¸€èˆ¬è®¾ä¸ºNULLã€‚è¯¥å‡½æ•°è¿”å›æ—¶ï¼Œå‚æ•°tidå°†å˜ä¸ºæ–°çº¿ç¨‹çš„çº¿ç¨‹ IDã€‚çº¿ç¨‹è¿˜å¯ä»¥è°ƒç”¨pthread_selfå‡½æ•°ç¡®è®¤è‡ªå·±çš„çº¿ç¨‹ IDï¼š\n1 2 3 #include \u003cpthread.h\u003e pthread_t pthread_self(void); //Returns: thread ID of caller ç»ˆæ­¢çº¿ç¨‹ çº¿ç¨‹ç»ˆæ­¢çš„æ–¹å¼åŒ…æ‹¬ï¼š\nåœ¨å…¶ä¾‹ç¨‹è¿”å›æ—¶éšå¼ç»ˆæ­¢ï¼› è°ƒç”¨å‡½æ•°pthread_exitæ˜¾å¼ç»ˆæ­¢ï¼Œå‚æ•°thread_returnç”¨äºå‡½æ•° pthread_joinï¼š 1 2 3 #include \u003cpthread.h\u003e void pthread_exit(void *thread_return); // Never returns è°ƒç”¨ Linux å‡½æ•°exitç»ˆæ­¢è¿›ç¨‹ä»¥åŠä¸è¯¥è¿›ç¨‹å…³è”çš„æ‰€æœ‰çº¿ç¨‹ï¼› è°ƒç”¨å‡½æ•°pthread_cancelç»ˆæ­¢å¦ä¸€ä¸ªçº¿ç¨‹ ID ä¸ºtidçš„å¯¹ç­‰çº¿ç¨‹ï¼š 1 2 3 #include \u003cpthread.h\u003e int pthread_cancel(pthread_t tid); // Returns: 0 if OK, nonzero on error å›æ”¶çº¿ç¨‹ çº¿ç¨‹è°ƒç”¨pthread_joinå‡½æ•°ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹tidç»ˆæ­¢ï¼š\n1 2 3 #include \u003cpthread.h\u003e int pthread_join(pthread_t tid, void **thread_return); // Returns: 0 if OK, nonzero on error çº¿ç¨‹tidç»ˆæ­¢åï¼Œè¯¥å‡½æ•°å°†çº¿ç¨‹ä¾‹ç¨‹è¿”å›çš„é€šç”¨æŒ‡é’ˆåˆ†é…åˆ°thread_returnæŒ‡å‘çš„ä½ç½®ï¼Œç„¶åå›æ”¶ç»ˆæ­¢çº¿ç¨‹æŒæœ‰çš„æ‰€æœ‰å†…å­˜èµ„æºã€‚ä¸ waitpid ä¸åŒï¼Œpthread_joinåªèƒ½ç­‰å¾…æŸä¸ªç‰¹å®šçº¿ç¨‹ç»ˆæ­¢ã€‚\nåˆ†ç¦»çº¿ç¨‹ åœ¨ä»»æ„æ—¶åˆ»ï¼Œçº¿ç¨‹éƒ½æ˜¯å¯è¿æ¥çš„ï¼ˆJoinableï¼‰æˆ–åˆ†ç¦»çš„ï¼ˆDetachedï¼‰ã€‚ä¸€ä¸ªå¯è¿æ¥çš„çº¿ç¨‹å¯ä»¥è¢«å…¶ä»–çº¿ç¨‹å›æ”¶æˆ–æ€æ­»ï¼Œå…¶å†…å­˜èµ„æºï¼ˆå¦‚æ ˆï¼‰åœ¨å®ƒè¢«å¦ä¸€ä¸ªçº¿ç¨‹å›æ”¶ä¹‹å‰ä¸ä¼šé‡Šæ”¾ï¼›ç›¸åï¼Œä¸€ä¸ªåˆ†ç¦»çš„çº¿ç¨‹æ— æ³•è¢«å…¶ä»–çº¿ç¨‹å›æ”¶æˆ–æ€æ­»ï¼Œå…¶å†…å­˜èµ„æºå°†åœ¨å®ƒç»ˆæ­¢æ—¶ç”±ç³»ç»Ÿè‡ªåŠ¨é‡Šæ”¾ã€‚\né»˜è®¤æƒ…å†µä¸‹ï¼Œçº¿ç¨‹æ˜¯å¯è¿æ¥çš„ã€‚ä¸ºäº†é¿å…å†…å­˜æ³„æ¼ï¼Œæ¯ä¸ªå¯è¿æ¥çš„çº¿ç¨‹éƒ½åº”å½“è¢«å¦ä¸€ä¸ªçº¿ç¨‹æ˜¾å¼åœ°å›æ”¶ï¼Œæˆ–è€…è°ƒç”¨pthread_detachå‡½æ•°æˆä¸ºä¸€ä¸ªåˆ†ç¦»çš„çº¿ç¨‹ï¼š\n1 2 3 #include \u003cpthread.h\u003e int pthread_detach(pthread_t tid); // Returns: 0 if OK, nonzero on error å‚æ•°tidæ˜¯è¢«åˆ†ç¦»çš„çº¿ç¨‹ IDï¼Œçº¿ç¨‹å¯ä»¥å°†å…¶è®¾ä¸ºpthread_self()æ¥åˆ†ç¦»è‡ªå·±ã€‚\nåˆå§‹åŒ–çº¿ç¨‹ çº¿ç¨‹è°ƒç”¨pthread_onceå‡½æ•°åˆå§‹åŒ–ä¸çº¿ç¨‹ä¾‹ç¨‹å…³è”çš„çŠ¶æ€ï¼š\n1 2 3 4 5 #include \u003cpthread.h\u003e pthread_once_t once_control = PTHREAD_ONCE_INIT; int pthread_once(pthread_once_t *once_control, void (*init_routine)(void)); // Always returns 0 å‚æ•°once_controlæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡æˆ–é™æ€å˜é‡ï¼Œå®ƒå§‹ç»ˆè¢«åˆå§‹åŒ–ä¸ºPTHREAD_ONCE_INITã€‚è¯¥å‡½æ•°ç¬¬ä¸€æ¬¡è¢«è°ƒç”¨æ—¶ä¼šç›´æ¥è°ƒç”¨init_routineï¼Œéšåä½¿ç”¨ç›¸åŒonce_controlå‚æ•°çš„è°ƒç”¨ä¸ä¼šèµ·ä»»ä½•ä½œç”¨ã€‚å¦‚ä¸‹ç¤ºä¾‹ç¨‹åºå°†è¾“å‡º 1ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 #include \u003cpthread.h\u003e #include \u003cstdio.h\u003e pthread_once_t once_control = PTHREAD_ONCE_INIT; int cnt; void init_routine(void) { cnt++; } int main() { pthread_once(\u0026once_control, *init_routine); pthread_once(\u0026once_control, *init_routine); printf(\"%d\", cnt); } å½“æˆ‘ä»¬éœ€è¦åŠ¨æ€åˆå§‹åŒ–å¤šä¸ªçº¿ç¨‹å…±äº«çš„å…¨å±€å˜é‡æ—¶ï¼Œè¯¥å‡½æ•°ååˆ†æœ‰ç”¨ã€‚\nåŸºäºçº¿ç¨‹çš„å¹¶å‘æœåŠ¡å™¨ ä¸€ä¸ªåŸºäºçº¿ç¨‹çš„å¹¶å‘æœåŠ¡å™¨ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 #include \"csapp.h\" void echo(int connfd); /* thread routine */ void *thread(void *vargp) { int connfd = *((int *)vargp); Pthread_detach(pthread_self()); Free(vargp); echo(connfd); Close(connfd); return NULL; } int main(int argc, char **argv) { int listenfd, *connfdp; socklen_t clientlen; struct sockaddr_storage clientaddr; pthread_t tid; if (argc != 2) { fprintf(stderr, \"usage: %s \u003cport\u003e\\n\", argv[0]); exit(0); } listenfd = Open_listenfd(argv[1]); while (1) { clientlen = sizeof(struct sockaddr_storage); connfdp = Malloc(sizeof(int)); *connfdp = Accept(listenfd, (SA *)\u0026clientaddr, \u0026clientlen); Pthread_create(\u0026tid, NULL, thread, connfdp); } } ç¨‹åºçš„æ•´ä½“ç»“æ„ä¸åŸºäºè¿›ç¨‹çš„å¹¶å‘æœåŠ¡å™¨ç±»ä¼¼ï¼Œä¸»çº¿ç¨‹åå¤ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ï¼Œç„¶ååˆ›å»ºå¯¹ç­‰çº¿ç¨‹å¤„ç†è¯·æ±‚ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¯¥ç¨‹åºè°ƒç”¨Mallocå‡½æ•°ç”ŸæˆæŒ‡å‘è¿æ¥æè¿°ç¬¦çš„æŒ‡é’ˆconnfdpå¹¶å°†å…¶ä¼ é€’ç»™å¯¹ç­‰çº¿ç¨‹ï¼ˆç¬¬ 32ï½34 è¡Œï¼‰ã€‚è¿™æ˜¯å› ä¸ºå¦‚æœæˆ‘ä»¬ç›´æ¥ä¼ é€’æŒ‡é’ˆï¼Œå¦‚ï¼š\n1 2 3 4 5 6 7 connfd = Accept(listenfd, (SA *) \u0026clientaddr, \u0026clientlen); Pthread_create(\u0026tid, NULL, thread, \u0026connfd); void *thread(void *vargp) { int connfd = *((int *)vargp); . . . } å°±ä¼šå¯¼è‡´å¯¹ç­‰çº¿ç¨‹ä¸­çš„èµ‹å€¼è¯­å¥ä¸ä¸»çº¿ç¨‹ä¸­çš„Accpetè°ƒç”¨äº§ç”Ÿç«äº‰ï¼šè‹¥æ–°å®¢æˆ·ç«¯åœ¨èµ‹å€¼è¯­å¥æ‰§è¡Œå®Œæ¯•å‰ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼Œåˆ™å¯¹ç­‰çº¿ç¨‹ä¸­çš„å±€éƒ¨å˜é‡connfdä¼šå˜æˆæ–°å®¢æˆ·ç«¯çš„è¿æ¥æè¿°ç¬¦ã€‚ç”±äºMallocå¯ä»¥å°†connfdåŠ¨æ€åˆ†é…åˆ°ä¸åŒçš„å †å†…å­˜ Block ä¸­ï¼Œè¿™ä¸€é—®é¢˜ä¾¿å¾—åˆ°äº†è§£å†³ã€‚\nä¸ºäº†é¿å…å†…å­˜æ³„æ¼ï¼Œæˆ‘ä»¬å¿…é¡»åˆ†ç¦»æ¯ä¸ªçº¿ç¨‹ï¼ˆç¬¬ 8 è¡Œï¼‰å¹¶é‡Šæ”¾ä¸»çº¿ç¨‹åˆ†é…çš„å †å†…å­˜ï¼ˆç¬¬ 9 è¡Œï¼‰ã€‚è¿›ç¨‹ä¸­çš„æ‰€æœ‰çº¿ç¨‹å…±äº«æè¿°ç¬¦è¡¨ï¼Œè¿æ¥æè¿°ç¬¦çš„rfcntå§‹ç»ˆä¸º 1ã€‚å› æ­¤æˆ‘ä»¬åªéœ€åœ¨å¯¹ç­‰çº¿ç¨‹ä¸­å…³é—­è¿æ¥æè¿°ç¬¦ï¼Œè€Œä¸å¿…åƒåŸºäºè¿›ç¨‹çš„å¹¶å‘æœåŠ¡å™¨é‚£æ ·åœ¨ä¸»çº¿ç¨‹è¿›è¡ŒåŒæ ·çš„æ“ä½œã€‚\nçº¿ç¨‹ç¨‹åºä¸­çš„å…±äº«å˜é‡ åœ¨ç¨‹åºå‘˜çœ‹æ¥ï¼Œçº¿ç¨‹çš„æœ€å¤§ä¼˜åŠ¿åœ¨äºå¤šä¸ªçº¿ç¨‹å¯ä»¥è½»æ¾åœ°å…±äº«ç›¸åŒçš„ç¨‹åºå˜é‡ã€‚ç„¶è€Œï¼Œè¿™ç§ä¾¿åˆ©å¯èƒ½ä¼šå¸¦æ¥ä¸€äº›é—®é¢˜ã€‚ä¸ºäº†æ­£ç¡®åœ°ç¼–å†™çº¿ç¨‹ç¨‹åºï¼Œæˆ‘ä»¬ä»¥å¦‚ä¸‹ç¨‹åºä¸ºä¾‹è¯´æ˜å…±äº«å˜é‡çš„å«ä¹‰åŠå·¥ä½œåŸç†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 #include \"csapp.h\" #define N 2 void *thread(void *vargp); char **ptr; /* global variable */ int main() { int i; pthread_t tid; char *msgs[N] = { \"Hello from foo\", \"Hello from bar\"}; ptr = msgs; for (i = 0; i \u003c N; i++) Pthread_create(\u0026tid, NULL, thread, (void *)i); Pthread_exit(NULL); } void *thread(void *vargp) { int myid = (int)vargp; static int cnt = 0; printf(\"[%d]: %s (cnt=%d)\\n\", myid, ptr[myid], ++cnt); return NULL; } çº¿ç¨‹å†…å­˜æ¨¡å‹ æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„çº¿ç¨‹ä¸Šä¸‹æ–‡ï¼Œå› æ­¤å¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«åŒä¸€è¿›ç¨‹ä¸Šä¸‹æ–‡ä¸­çš„å…¶ä½™éƒ¨åˆ†ã€‚å®ƒä»¬åŒ…æ‹¬ï¼šåªè¯»æ–‡æœ¬ï¼ˆä»£ç ï¼‰æ®µã€å¯è¯»å†™æ•°æ®æ®µã€å †ã€å…±äº«åº“å’Œæ‰“å¼€æ–‡ä»¶æè¿°ç¬¦ç­‰ã€‚\nçº¿ç¨‹æ— æ³•è¯»å–æˆ–å†™å…¥å¦ä¸€ä¸ªçº¿ç¨‹çš„å¯„å­˜å™¨ï¼Œä½†ä»»ä½•çº¿ç¨‹éƒ½èƒ½å¤Ÿè®¿é—®å…±äº«è™šæ‹Ÿå†…å­˜ä¸­çš„ä»»ä½•ä½ç½®ã€‚å°½ç®¡æ ˆå±äºçº¿ç¨‹ä¸Šä¸‹æ–‡çš„ä¸€éƒ¨åˆ†ï¼Œä½†çº¿ç¨‹å¯ä»¥ä½¿ç”¨æŒ‡é’ˆå¯¹å¦ä¸€ä¸ªçº¿ç¨‹çš„æ ˆå†…å®¹è¯»å–å’Œå†™å…¥ã€‚ç¤ºä¾‹ç¨‹åºç¬¬ 25 è¡Œï¼Œå¯¹ç­‰çº¿ç¨‹é€šè¿‡å…¨å±€å˜é‡ptré—´æ¥å¼•ç”¨äº†ä¸»çº¿ç¨‹æ ˆä¸­çš„æ•°ç»„msgs[N]ã€‚\nå°†å˜é‡æ˜ å°„åˆ°å†…å­˜ C çº¿ç¨‹ç¨‹åºæ ¹æ®å˜é‡çš„å­˜å‚¨ç±»å‹å°†å…¶æ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜ï¼š\nå…¨å±€å˜é‡ï¼šå…¨å±€å˜é‡çš„å”¯ä¸€å®ä¾‹åœ¨è¿è¡Œæ—¶ä½äº å¯è¯»å†™æ®µï¼Œå®ƒå¯ä»¥è¢«ä»»æ„çº¿ç¨‹å¼•ç”¨ã€‚ç¤ºä¾‹ç¨‹åºç¬¬ 5 è¡Œå£°æ˜çš„å…¨å±€å˜é‡pträ¾¿æ˜¯å¦‚æ­¤ï¼› å±€éƒ¨è‡ªåŠ¨å˜é‡ï¼šå±€éƒ¨è‡ªåŠ¨å˜é‡åœ¨è¿è¡Œæ—¶ä½äºæ¯ä¸ªçº¿ç¨‹çš„æ ˆä¸­ï¼Œå¦‚ç¤ºä¾‹ç¨‹åºä¸­çš„å˜é‡tidå’Œmyidã€‚ä¸ºäº†åŒºåˆ†ä¸åŒçº¿ç¨‹ä¸­çš„ç›¸åŒå˜é‡ï¼Œæˆ‘ä»¬å°†å®ƒä»¬åˆ†åˆ«è¡¨ç¤ºä¸ºtid.mã€myid.p0å’Œmyid.p1ï¼› å±€éƒ¨é™æ€å˜é‡ï¼šä¸å…¨å±€å˜é‡ä¸€æ ·ï¼Œå±€éƒ¨é™æ€å˜é‡çš„å”¯ä¸€å®ä¾‹åœ¨è¿è¡Œæ—¶ä½äºå¯è¯»å†™æ®µã€‚å³ä½¿ç¤ºä¾‹ç¨‹åºä¸­çš„æ¯ä¸ªå¯¹ç­‰çº¿ç¨‹éƒ½å£°æ˜äº†å±€éƒ¨é™æ€å˜é‡cntï¼ˆç¬¬ 24 è¡Œï¼‰ï¼Œåœ¨è¿è¡Œæ—¶è™šæ‹Ÿå†…å­˜ä¸­ä¹Ÿåªæœ‰ä¸€ä¸ªcntå®ä¾‹ã€‚ å…±äº«å˜é‡ å½“ä¸€ä¸ªå˜é‡çš„å®ä¾‹è¢«å¤šä¸ªçº¿ç¨‹å¼•ç”¨æ—¶ï¼Œæˆ‘ä»¬å°±ç§°å®ƒä¸ºå…±äº«çš„ã€‚åœ¨ç¤ºä¾‹ç¨‹åºä¸­ï¼Œå˜é‡cntæ˜¯å…±äº«çš„ï¼Œè€Œmyidåˆ™ä¸æ˜¯ã€‚å¯¹ç­‰çº¿ç¨‹å‡é€šè¿‡ptré—´æ¥å¼•ç”¨äº†å±€éƒ¨å˜é‡msgsï¼Œå› æ­¤msgsä¹Ÿæ˜¯å…±äº«çš„ã€‚\nä½¿ç”¨ä¿¡å·é‡åŒæ­¥çº¿ç¨‹ ä»¥ä¸‹ç¨‹åºbadcnt.cåˆ›å»ºäº†ä¸¤ä¸ªå¯¹ç­‰çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šå°†å…¨å±€å…±äº«å˜é‡cnté€’å¢nitersæ¬¡ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 #include \"csapp.h\" void *thread(void *vargp); /* Thread routine prototype */ /* Global shared variable */ volatile long cnt = 0; /* Counter */ int main(int argc, char **argv) { long niters; pthread_t tid1, tid2; /* Check input argument */ if (argc != 2) { printf(\"usage: %s \u003cniters\u003e\\n\", argv[0]); exit(0); } niters = atoi(argv[1]); /* Create threads and wait for them to finish */ Pthread_create(\u0026tid1, NULL, thread, \u0026niters); Pthread_create(\u0026tid2, NULL, thread, \u0026niters); Pthread_join(tid1, NULL); Pthread_join(tid2, NULL); /* Check result */ if (cnt != (2 * niters)) printf(\"BOOM! cnt=%d\\n\", cnt); else printf(\"OK cnt=%d\\n\", cnt); exit(0); } /* Thread routine */ void *thread(void *vargp) { long i, niters = *((long *)vargp); for (i = 0; i \u003c niters; i++) cnt++; return NULL; } ç†è®ºä¸Šï¼Œè¯¥ç¨‹åºçš„è¾“å‡ºç»“æœåº”ä¸º2 * nitersã€‚ç„¶è€Œå½“å®ƒåœ¨ Linux ç³»ç»Ÿä¸Šè¿è¡Œæ—¶ï¼Œæˆ‘ä»¬ä¸ä½†ä¼šå¾—åˆ°é”™è¯¯çš„ç­”æ¡ˆï¼Œå¹¶ä¸”æ¯æ¬¡çš„ç»“æœè¿˜ä¸åŒï¼š\n1 2 3 linux\u003e ./badcnt 1000000 BOOM! cnt=1445085 linux\u003e ./badcnt 1000000 BOOM! cnt=1915220 linux\u003e ./badcnt 1000000 BOOM! cnt=1404746 ä¸ºäº†æ¸…æ¥šåœ°ç†è§£è¿™ä¸€é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ç ”ç©¶ä¸€ä¸‹è®¡æ•°å™¨å¾ªç¯ï¼ˆç¬¬ 40ï½41 è¡Œï¼‰çš„æ±‡ç¼–ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 ; i in %rax, niters in %rcx, cnt in %rdx movq (%rdi), %rcx testq %rcx, %rcx jle .L2 movl $0, %eax .L3: movq cnt(%rip), %rdx addq $1, %rdx movq movq %rdx, cnt(%rip) addq $1, %rax cmpq %rcx, %rax jne .L3 .L2: è¿™æ®µä»£ç å¯ä»¥åˆ†ä¸ºä»¥ä¸‹äº”ä¸ªéƒ¨åˆ†ï¼š\n$H_i$ï¼šå¾ªç¯å¤´éƒ¨çš„æŒ‡ä»¤å—ï¼ˆç¬¬ 2ï½5 è¡Œï¼‰ï¼› $L_i$ï¼šå°†å˜é‡cntåŠ è½½åˆ°å¯„å­˜å™¨ %$rdx_i$ï¼ˆç¬¬ 7 è¡Œï¼‰ï¼› $U_i$ï¼šå°† %$rdx_i$ åŠ ä¸€ï¼ˆç¬¬ 8 è¡Œï¼‰ï¼› $S_i$ï¼šå°† %$rdx_i$ æ›´æ–°åçš„å€¼å­˜å›å˜é‡cntï¼ˆç¬¬ 9 è¡Œï¼‰ï¼› $T_i$ï¼šå¾ªç¯å°¾éƒ¨çš„æŒ‡ä»¤å—ï¼ˆç¬¬ 10ï½13 è¡Œï¼‰ã€‚ ä¸Šè¿°æŒ‡ä»¤åœ¨å•æ ¸å¤„ç†å™¨ä¸Šä»¥æŸç§é¡ºåºä¾æ¬¡æ‰§è¡Œï¼Œä¸åŒçš„æ‰§è¡Œé¡ºåºå°†å¯¼è‡´ä¸åŒçš„ç»“æœã€‚æˆ‘ä»¬ä»¥ç¬¬ä¸€æ¬¡å¾ªç¯ä¸ºä¾‹ï¼š\nå¦‚å›¾ï¼ˆbï¼‰æ‰€ç¤ºï¼Œçº¿ç¨‹ 2 åœ¨ç¬¬äº”æ­¥å°†å˜é‡cntåŠ è½½åˆ° %$rdx_2$ã€‚æ­¤æ—¶çº¿ç¨‹ 1 å·²ç»åœ¨ç¬¬ä¸‰æ­¥æ›´æ–°äº† %$rdx_1$ çš„å€¼ï¼Œä½†è¿˜æœªæŠŠå®ƒå­˜å›cntã€‚å› æ­¤ %$rdx_2$ çš„åˆå§‹å€¼ä¸º 0ï¼Œçº¿ç¨‹ 2 æ— æ³•åƒå›¾ï¼ˆaï¼‰é‚£æ ·å°†cntä» 1 é€’å¢åˆ° 2ã€‚\nè¿›åº¦å›¾ è¿›åº¦å›¾ï¼ˆProgress Graphï¼‰å°† n ä¸ªå¹¶å‘çº¿ç¨‹å»ºæ¨¡ä¸º n ç»´ç¬›å¡å°”ç©ºé—´ä¸­çš„è½¨è¿¹ï¼ˆTrajectoryï¼‰ã€‚å…¶ä¸­ï¼Œæ¯ä¸ªåæ ‡è½´å¯¹åº”çº¿ç¨‹ $k$ çš„è¿›åº¦ï¼Œæ¯ä¸ªç‚¹ä»£è¡¨çº¿ç¨‹ $k$ å·²å®ŒæˆæŒ‡ä»¤ $I_k$ çš„çŠ¶æ€ã€‚ç¨‹åºbadcnt.cç¬¬ä¸€æ¬¡å¾ªç¯çš„è¿›åº¦å›¾å¦‚ä¸‹ï¼Œç‚¹ $(L_1, S_2)$ ä»£è¡¨çº¿ç¨‹ 1 å·²å®Œæˆ $L_1$ï¼Œçº¿ç¨‹ 2 åˆ™å·²å®Œæˆ $S_2$ï¼š\nç¨‹åºçš„æ‰§è¡Œå†å²å¯ä»¥ç”¨è¿›åº¦å›¾ä¸­çš„è½¨è¿¹è¡¨ç¤ºã€‚å‡è®¾è¯¥ç¨‹åºç¬¬ä¸€æ¬¡å¾ªç¯çš„æŒ‡ä»¤æ‰§è¡Œé¡ºåºä¸ºï¼š\n$$H_1, L_1, U_1, H_2, L_2, S_1, T_1, U_2, S_2, T_2$$\nåˆ™è¿›åº¦å›¾è½¨è¿¹ä¸ºï¼š\nå¯¹äºçº¿ç¨‹ $i$ï¼Œæ“ä½œå…±äº«å˜é‡cntçš„æŒ‡ä»¤ $(L_i, U_i, S_i)$ æ„æˆäº†ä¸€ä¸ªä¸´ç•ŒåŒºï¼ˆCritical Sectionï¼‰ï¼Œå®ƒä¸åº”å½“ä¸å…¶ä»–çº¿ç¨‹çš„ä¸´ç•ŒåŒºç›¸äº¤ã€‚åœ¨è¿›åº¦å›¾ä¸Šï¼Œä¸¤çº¿ç¨‹ä¸´ç•ŒåŒºçš„äº¤é›†æ„æˆäº†ä¸å®‰å…¨åŒºï¼ˆUnsafe Regionï¼‰ï¼š\nä¸å®‰å…¨åŒºä¸åŒ…æ‹¬å…¶è¾¹ç¼˜ï¼Œä¾‹å¦‚çŠ¶æ€ $(H_1, H_2)$ å’Œ $(S_1, U_2)$ å‡ä¸å±äºè¯¥åŒºåŸŸã€‚ç»•è¿‡ä¸å®‰å…¨åŒºçš„è½¨è¿¹è¢«ç§°ä¸ºå®‰å…¨è½¨è¿¹ï¼Œè€Œè§¦åŠäº†ä¸å®‰å…¨åŒºä¸­ä»»ä½•éƒ¨åˆ†çš„è½¨è¿¹éƒ½æ˜¯ä¸å®‰å…¨çš„ã€‚\nä¿¡å·é‡ ä¿¡å·é‡ï¼ˆSemaphoreï¼‰sæ˜¯ä¸€ä¸ªå…·æœ‰éè´Ÿæ•´æ•°å€¼çš„å…¨å±€å˜é‡ï¼Œæˆ‘ä»¬åªèƒ½å¯¹å®ƒè¿›è¡Œä¸¤ç§æ“ä½œï¼š\nP(s)ï¼šè‹¥séé›¶ï¼Œåˆ™å°†å…¶å‡ä¸€å¹¶ç«‹å³è¿”å›ï¼›è‹¥sä¸ºé›¶ï¼Œåˆ™å°†çº¿ç¨‹æš‚åœã€‚å½“så˜ä¸ºéé›¶ä¸”çº¿ç¨‹ç”±Væ“ä½œé‡å¯åï¼ŒPå†å°†så‡ä¸€å¹¶æŠŠæ§åˆ¶æƒè¿”å›ç»™è°ƒç”¨è€…ï¼› V(s)ï¼šå°†såŠ ä¸€ã€‚å¦‚æœå­˜åœ¨ä»»ä½•è¢«Pæ“ä½œé˜»å¡çš„çº¿ç¨‹ï¼Œå°±éšæœºé‡å¯å®ƒä»¬ä¸­çš„ä¸€ä¸ªã€‚ P(s)å’ŒV(s)æ“ä½œä¸å¯åˆ†å‰²ï¼ˆå…·æœ‰åŸå­æ€§ï¼‰ï¼Œå› æ­¤å®ƒä»¬ä¸ä¼šè¢«ä¸­æ–­ã€‚å…¶å®šä¹‰ä¿è¯äº†æ­£ç¡®åˆå§‹åŒ–çš„ä¿¡å·é‡æ°¸è¿œä¸ä¼šå˜ä¸ºè´Ÿå€¼ï¼Œæˆ‘ä»¬å°†è¿™ç§å±æ€§ç§°ä¸ºä¿¡å·é‡çš„ä¸å˜æ€§ï¼ˆSemaphore Invariantï¼‰ã€‚\nPosix æ ‡å‡†å®šä¹‰äº†å¤šç§æ“ä½œä¿¡å·é‡çš„å‡½æ•°ï¼š\n1 2 3 4 5 #include \u003csemaphore.h\u003e int sem_init(sem_t *sem, int pshared, unsigned int value); int sem_wait(sem_t *s); /* P(s) */ int sem_post(sem_t *s); /* V(s) */ // Returns: 0 if OK, âˆ’1 on error æ¯ä¸ªä¿¡å·é‡éƒ½å¿…é¡»åœ¨ä½¿ç”¨å‰åˆå§‹åŒ–ï¼Œsem_initå‡½æ•°åˆ™å°†ä¿¡å·é‡semåˆå§‹åŒ–ä¸ºå‚æ•°valueã€‚åœ¨æˆ‘ä»¬çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œå‚æ•°psharedå§‹ç»ˆä¸º 0ã€‚çº¿ç¨‹åˆ†åˆ«è°ƒç”¨sem_waitå’Œsem_postå‡½æ•°æ¥æ‰§è¡ŒP(s)å’ŒV(s)æ“ä½œã€‚ä¸ºäº†ç®€æ´èµ·è§ï¼Œæˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹ç­‰æ•ˆçš„åŒ…è£…å‡½æ•°ä»£æ›¿ï¼š\n1 2 3 4 #include \"csapp.h\" void P(sem_t *s); /* Wrapper function for sem_wait */ void V(sem_t *s); /* Wrapper function for sem_post */ // Returns: nothing ä½¿ç”¨ä¿¡å·é‡å®ç°äº’æ–¥ ä¿¡å·é‡æä¾›äº†ä¸€ç§ä¾¿æ·çš„æ–¹æ³•æ¥ç¡®ä¿çº¿ç¨‹å¯¹å…±äº«å˜é‡çš„è®¿é—®äº’æ–¥ï¼ˆMutually Exclusive ï¼‰ï¼šå°†ä¸€ä¸ªåˆå§‹å€¼ä¸º 1 çš„ä¿¡å·é‡ä¸æ¯ä¸ªå…±äº«å˜é‡ç›¸å…³è”ï¼Œç„¶åä½¿ç”¨På’ŒVæ“ä½œåŒ…å›´ä¸´ç•ŒåŒºã€‚\nåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¿¡å·é‡çš„å€¼å§‹ç»ˆä¸º 0 æˆ– 1ï¼Œå› æ­¤æˆ‘ä»¬å°†å®ƒç§°ä¸ºäºŒè¿›åˆ¶ä¿¡å·é‡ã€‚ç”¨äºå®ç°äº’æ–¥çš„äºŒè¿›åˆ¶ä¿¡å·é‡é€šå¸¸è¢«ç§°ä¸ºäº’æ–¥é”ï¼ˆMutexï¼‰ï¼Œå¯¹å…¶è¿›è¡ŒPå’ŒVæ“ä½œåˆ™åˆ†åˆ«è¢«ç§°ä¸ºåŠ é”å’Œè§£é”ã€‚ä¸€ä¸ªå·²è¢«é”å®šä½†äº’æ–¥é”è¿˜æœªè¢«è§£é”çš„çº¿ç¨‹è¢«ç§°ä¸ºæŒæœ‰äº’æ–¥é”ã€‚\nä¸‹å›¾å±•ç¤ºäº†æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨äºŒè¿›åˆ¶ä¿¡å·é‡æ­£ç¡®åŒæ­¥ç¨‹åºbadcnt.cï¼Œå…¶ä¸­çš„æ¯ä¸ªçŠ¶æ€éƒ½æ ‡æ³¨äº†è¯¥çŠ¶æ€ä¸‹ä¿¡å·é‡çš„å€¼ï¼š\nå›¾ä¸­ä¿¡å·é‡ä¸º -1 çš„çŠ¶æ€å…±åŒæ„æˆäº†ç¦æ­¢åŒºï¼ˆForbidden Regionï¼‰ã€‚ç”±äºä¿¡å·é‡çš„ä¸å˜æ€§ï¼Œä»»ä½•å¯è¡Œçš„è½¨è¿¹éƒ½æ— æ³•è¿›å…¥è¯¥åŒºåŸŸã€‚ç¦æ­¢åŒºå®Œå…¨åŒ…å›´äº†ä¸å®‰å…¨åŒºï¼Œå› æ­¤è½¨è¿¹ä¹Ÿä¸ä¼šè§¦åŠä¸å®‰å…¨åŒºçš„ä»»ä½•éƒ¨åˆ†ã€‚æ— è®ºè¿è¡Œæ—¶æŒ‡ä»¤æ‰§è¡Œçš„é¡ºåºå¦‚ä½•ï¼Œç¨‹åºéƒ½ä¼šæ­£ç¡®åœ°é€’å¢cntã€‚\nç»¼ä¸Šï¼Œä¸ºäº†ä½¿ç”¨ä¿¡å·é‡å®ç°äº’æ–¥ï¼Œæˆ‘ä»¬éœ€è¦é¦–å…ˆå£°æ˜ä¸€ä¸ªä¿¡å·é‡mutexï¼š\n1 2 volatile long cnt = 0; /* Counter */ sem_t mutex; /* Semaphore that protects counter */ ç„¶ååœ¨ä¸»çº¿ç¨‹ä¸­å°†å…¶åˆå§‹åŒ–ï¼š\n1 Sem_init(\u0026mutex, 0, 1); /* mutex = 1 */ æœ€ç»ˆåœ¨å¯¹ç­‰çº¿ç¨‹ä¸­è°ƒç”¨På’ŒVåŒ…å›´å¯¹å…±äº«å˜é‡cntçš„æ›´æ–°æ“ä½œï¼š\n1 2 3 4 5 for (i = 0; i \u003c niters; i++) { P(\u0026mutex); cnt++; V(\u0026mutex); } ä½¿ç”¨ä¿¡å·é‡è°ƒåº¦å…±äº«èµ„æº é™¤äº†å®ç°äº’æ–¥ä¹‹å¤–ï¼Œä¿¡å·é‡çš„å¦ä¸€ä¸ªé‡è¦ä½œç”¨æ˜¯è°ƒåº¦å¯¹å…±äº«èµ„æºçš„è®¿é—®ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œçº¿ç¨‹ä½¿ç”¨ä¿¡å·é‡ä¸å…¶ä»–çº¿ç¨‹é€šä¿¡ã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹ä¸¤ä¸ªç»å…¸æ¡ˆä¾‹ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…ï¼ˆProducer-Consumerï¼‰é—®é¢˜å’Œè¯»å–è€…-å†™å…¥è€…ï¼ˆReaders-Writersï¼‰é—®é¢˜ã€‚\nç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çº¿ç¨‹å…±äº«ä¸€ä¸ªæœ‰ç•Œç¼“å†²åŒºã€‚ç”Ÿäº§è€…çº¿ç¨‹é‡å¤ç”Ÿæˆæ–°é¡¹ç›®å¹¶å°†å®ƒä»¬æ’å…¥ç¼“å†²åŒºï¼Œæ¶ˆè´¹è€…çº¿ç¨‹åˆ™ä¸æ–­ä»ç¼“å†²åŒºä¸­åˆ é™¤é¡¹ç›®ï¼Œç„¶åæ¶ˆè´¹ï¼ˆä½¿ç”¨ï¼‰å®ƒä»¬ã€‚\nç”±äºæ’å…¥å’Œåˆ é™¤é¡¹ç›®æ¶‰åŠåˆ°æ›´æ–°å…±äº«å˜é‡ï¼Œæˆ‘ä»¬å¿…é¡»ä¿è¯çº¿ç¨‹å¯¹ç¼“å†²åŒºçš„è®¿é—®æ˜¯äº’æ–¥çš„ã€‚ä½†ä»…ä»…ä¿è¯äº’æ–¥æ˜¯ä¸å¤Ÿçš„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è°ƒåº¦çº¿ç¨‹å¯¹ç¼“å†²åŒºçš„è®¿é—®ï¼šè‹¥ç¼“å†²åŒºå·²æ»¡ï¼ˆæ²¡æœ‰ç©ºä½ï¼‰ï¼Œåˆ™ç”Ÿäº§è€…å¿…é¡»ç­‰å¾…ç©ºä½ï¼›è‹¥ç¼“å†²åŒºä¸ºç©ºï¼ˆæ²¡æœ‰å¯ç”¨çš„é¡¹ç›®ï¼‰ï¼Œåˆ™æ¶ˆè´¹è€…å¿…é¡»ç­‰å¾…é¡¹ç›®å¯ç”¨ã€‚\næˆ‘ä»¬å¼€å‘äº†ä¸€ä¸ªåä¸º $S_{buf}$ çš„ç®€å•åŒ…ï¼Œå®ƒå¯ä»¥æ“ä½œsbuf_tç±»å‹çš„ç¼“å†²åŒºï¼š\n1 2 3 4 5 6 7 8 9 typedef struct { int *buf; /* Buffer array */ int n; /* Maximum number of slots */ int front; /* buf[(front+1)%n] is first item */ int rear; /* buf[rear%n] is last item */ sem_t mutex; /* Protects accesses to buf */ sem_t slots; /* Counts available slots */ sem_t items; /* Counts available items */ } sbuf_t; æ‰€æœ‰é¡¹ç›®å‡å­˜å‚¨åœ¨ä¸€ä¸ªåŠ¨æ€åˆ†é…ä¸”åŒ…å« n ä¸ªç©ºä½çš„æ•´å‹æ•°ç»„bufä¸­ï¼Œfrontå’Œrearç”¨äºè®°å½•æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªé¡¹ç›®å’Œæœ€åä¸€ä¸ªé¡¹ç›®ã€‚ä¿¡å·é‡mutexå®ç°äº†å¯¹ç¼“å†²åŒºè®¿é—®çš„äº’æ–¥ï¼Œslotså’Œitemsåˆ™åˆ†åˆ«è®¡ç®—ç¼“å†²åŒºä¸­çš„ç©ºä½å’Œå¯ç”¨é¡¹ç›®çš„æ•°é‡ã€‚\n$S_{buf}$ åŒ…çš„å®ç°å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 #include \"csapp.h\" #include \"sbuf.h\" /* Create an empty, bounded, shared FIFO buffer with n slots */ void sbuf_init(sbuf_t *sp, int n) { sp-\u003ebuf = Calloc(n, sizeof(int)); sp-\u003en = n; /* Buffer holds max of n items */ sp-\u003efront = sp-\u003erear = 0; /* Empty buffer iff front == rear */ Sem_init(\u0026sp-\u003emutex, 0, 1); /* Binary semaphore for locking */ Sem_init(\u0026sp-\u003eslots, 0, n); /* Initially, buf has n empty slots */ Sem_init(\u0026sp-\u003eitems, 0, 0); /* Initially, buf has zero data items */ } /* Clean up buffer sp */ void sbuf_deinit(sbuf_t *sp) { Free(sp-\u003ebuf); } /* Insert item onto the rear of shared buffer sp */ void sbuf_insert(sbuf_t *sp, int item) { P(\u0026sp-\u003eslots); /* Wait for available slot */ P(\u0026sp-\u003emutex); /* Lock the buffer */ sp-\u003ebuf[(++sp-\u003erear)%(sp-\u003en)] = item; /* Insert the item */ V(\u0026sp-\u003emutex); /* Unlock the buffer */ V(\u0026sp-\u003eitems); /* Announce available item */ } /* Remove and return the first item from buffer sp */ int sbuf_remove(sbuf_t *sp) { int item; P(\u0026sp-\u003eitems); /* Wait for available item */ P(\u0026sp-\u003emutex); /* Lock the buffer */ item = sp-\u003ebuf[(++sp-\u003efront)%(sp-\u003en)]; /* Remove the item */ V(\u0026sp-\u003emutex); /* Unlock the buffer */ V(\u0026sp-\u003eslots); /* Announce available slot */ return item; } sbuf_initå‡½æ•°ä¸ºç¼“å†²åŒºåˆ†é…å †å†…å­˜ï¼Œå°†frontå’Œrearè®¾ä¸º 0ï¼Œå¹¶ä¸ºä¸‰ä¸ªä¿¡å·é‡åˆ†é…åˆå§‹å€¼ï¼›sbuf_deinitå‡½æ•°åœ¨ç¨‹åºä½¿ç”¨å®Œç¼“å†²åŒºåé‡Šæ”¾å®ƒï¼›sbuf_insertå‡½æ•°ç­‰å¾…ä¸€ä¸ªå¯ç”¨çš„ç©ºä½ï¼Œç„¶åé”å®šmutexï¼Œå°†é¡¹ç›®æ·»åŠ åˆ°ç¼“å†²åŒºå°¾éƒ¨å¹¶è§£é”mutexï¼Œæœ€åé€šçŸ¥æ¶ˆè´¹è€…çº¿ç¨‹æ–°é¡¹ç›®å¯ç”¨ï¼›sbuf_removeå‡½æ•°ä¸ä¹‹å¯¹ç§°ï¼šå½“ç¼“å†²åŒºä¸­æœ‰é¡¹ç›®å¯ç”¨æ—¶ï¼Œå®ƒé”å®šmutexï¼Œç„¶åç§»é™¤ç¼“å†²åŒºå¤´éƒ¨çš„é¡¹ç›®å¹¶è§£é”mutexï¼Œæœ€åé€šçŸ¥ç”Ÿäº§è€…æœ‰æ–°çš„ç©ºä½ã€‚\nè¯»å–è€…-å†™å…¥è€…é—®é¢˜ è¯»å–è€…-å†™å…¥è€…é—®é¢˜æ˜¯äº’æ–¥é—®é¢˜çš„ä¸€èˆ¬åŒ–ã€‚å‡è®¾å¹¶å‘çº¿ç¨‹é›†åˆæ­£åœ¨è®¿é—®ä¸€ä¸ªå…±äº«å¯¹è±¡ï¼Œå¦‚ä¸»å­˜ä¸­çš„æ•°æ®ç»“æ„æˆ–ç£ç›˜ä¸Šçš„æ•°æ®åº“ã€‚å†™å…¥è€…å¿…é¡»æ‹¥æœ‰å¯¹è¯¥å¯¹è±¡çš„ç‹¬å è®¿é—®æƒï¼Œä½†è¯»å–è€…å´å¯ä»¥ä¸å…¶ä»–è¯»å–è€…å…±äº«ã€‚\næˆ‘ä»¬å¯ä»¥æ ¹æ®è¯»å–è€…å’Œå†™å…¥è€…çš„ä¼˜å…ˆçº§å°†è¿™ä¸€é—®é¢˜åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š\nè¯»å–è€…ä¼˜å…ˆï¼šè¯»å–è€…ä¸ä¼šå› å†™å…¥è€…åœ¨ç­‰å¾…è€Œç­‰å¾…ï¼› å†™å…¥è€…ä¼˜å…ˆï¼šä¸€æ—¦å†™å…¥è€…å‡†å¤‡å¥½å†™å…¥å°±å°½å¿«æ‰§è¡Œå†™å…¥ã€‚ ç¤ºä¾‹ç¨‹åºå±•ç¤ºäº†ä¸€ä¸ªè¯»å–è€…ä¼˜å…ˆçš„è§£å†³æ–¹æ¡ˆï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 /* Global variables */ int readcnt; /* Initially = 0 */ sem_t mutex, w; /* Both initially = 1 */ void reader(void) { while (1) { P(\u0026mutex); readcnt++; if (readcnt == 1) /* First in */ P(\u0026w); V(\u0026mutex); /* Critical section */ /* Reading happens */ P(\u0026mutex); readcnt--; if (readcnt == 0) /* Last out */ V(\u0026w); V(\u0026mutex); } } void writer(void) { while (1) { P(\u0026w); /* Critical section */ /* Writing happens */ V(\u0026w); } } ä¿¡å·é‡wå®ç°äº†å¯¹å…±äº«å¯¹è±¡è®¿é—®çš„äº’æ–¥ï¼Œmutexåˆ™ä¿æŠ¤äº†å¯¹å…±äº«å˜é‡readcntï¼ˆè¡¨ç¤ºå½“å‰å¤„äºä¸´ç•ŒåŒºçš„è¯»å–è€…æ•°é‡ï¼‰çš„è®¿é—®ã€‚å†™å…¥è€…æ¯æ¬¡è¿›å…¥ä¸´ç•ŒåŒºæ—¶éƒ½ä¼šé”å®šwå¹¶åœ¨ç¦»å¼€æ—¶å¯¹å…¶è§£é”ã€‚ä½†åªæœ‰ç¬¬ä¸€ä¸ªè¿›å…¥ä¸´ç•ŒåŒºçš„è¯»å–è€…æ‰éœ€è¦é”å®šwï¼Œåªæœ‰æœ€åä¸€ä¸ªç¦»å¼€ä¸´ç•ŒåŒºçš„è¯»å–è€…æ‰éœ€è¦è§£é”å®ƒã€‚å› æ­¤åªè¦æœ‰ä¸€ä¸ªè¯»å–è€…æŒæœ‰wï¼ˆä½äºä¸´ç•ŒåŒºï¼‰ï¼Œå…¶ä»–è¯»å–è€…å°±éƒ½å¯ä»¥ç•…é€šæ— é˜»åœ°è®¿é—®å…±äº«å¯¹è±¡ã€‚\næ‰€æœ‰æ­¤ç±»é—®é¢˜çš„è§£å†³æ–¹æ¡ˆéƒ½ä¼šå¯¼è‡´é¥¥é¥¿ï¼ˆStarvationï¼‰ï¼Œå³çº¿ç¨‹è¢«é˜»å¡å¹¶æ— æ³•å–å¾—ä»»ä½•è¿›å±•ã€‚ä¾‹å¦‚åœ¨ä¸Šè¿°ç¨‹åºä¸­ï¼Œå½“è¯»å–è€…çº¿ç¨‹æ‰¹é‡åˆ°è¾¾æ—¶ï¼Œå†™å…¥è€…åªèƒ½æ— é™æœŸç­‰å¾…ã€‚\nåŸºäºé¢„çº¿ç¨‹çš„å¹¶å‘æœåŠ¡å™¨ å‰æ–‡ä»‹ç»çš„ åŸºäºçº¿ç¨‹çš„å¹¶å‘æœåŠ¡å™¨ éœ€è¦ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œå› æ­¤å…¶æˆæœ¬è¾ƒé«˜ã€‚åŸºäºé¢„çº¿ç¨‹ï¼ˆPrethreadingï¼‰çš„å¹¶å‘æœåŠ¡å™¨å¯ä»¥é€šè¿‡ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹å‡å°‘è¿™ä¸€å¼€é”€ï¼š\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸»çº¿ç¨‹ä¸æ–­åœ°æ¥å—æ¥è‡ªå®¢æˆ·ç«¯è¿æ¥è¯·æ±‚å¹¶åœ¨æœ‰ç•Œç¼“å†²åŒºä¸­æ’å…¥è¿æ¥æè¿°ç¬¦ã€‚æ¯ä¸ªå·¥ä½œçº¿ç¨‹é‡å¤åœ°ä»ç¼“å†²åŒºä¸­ç§»é™¤ä¸€ä¸ªæè¿°ç¬¦å¹¶ä¸ºå®¢æˆ·ç«¯æä¾›æœåŠ¡ï¼Œç„¶åç­‰å¾…ä¸‹ä¸€ä¸ªæè¿°ç¬¦ã€‚\næˆ‘ä»¬ä½¿ç”¨ $S_{buf}$ åŒ…å®ç°è¿™ä¸€æ¨¡å‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 #include \"csapp.h\" #include \"sbuf.h\" #define NTHREADS 4 #define SBUFSIZE 16 void echo_cnt(int connfd); void *thread(void *vargp); sbuf_t sbuf; /* shared buffer of connected descriptors */ int main(int argc, char **argv) { int i, listenfd, connfd; socklen_t clientlen; struct sockaddr_storage clientaddr; pthread_t tid; if (argc != 2) { fprintf(stderr, \"usage: %s \u003cport\u003e\\n\", argv[0]); exit(0); } listenfd = Open_listenfd(argv[1]); sbuf_init(\u0026sbuf, SBUFSIZE); for (i = 0; i \u003c NTHREADS; i++) /* Create worker threads */ Pthread_create(\u0026tid, NULL, thread, NULL); while (1) { clientlen = sizeof(struct sockaddr_storage); connfd = Accept(listenfd, (SA *)\u0026clientaddr, \u0026clientlen); sbuf_insert(\u0026sbuf, connfd); /* Insert connfd in buffer */ } } void *thread(void *vargp) { Pthread_detach(pthread_self()); while (1) { int connfd = sbuf_remove(\u0026sbuf);/* Remove connfd from buffer */ echo_cnt(connfd); /* Service client */ Close(connfd); } } åœ¨åˆå§‹åŒ–ç¼“å†²åŒºsbufï¼ˆç¬¬ 25 è¡Œï¼‰ä¹‹åï¼Œä¸»çº¿ç¨‹åˆ›å»ºäº†ä¸€ç»„å·¥ä½œçº¿ç¨‹ï¼ˆç¬¬ 26ï½27 è¡Œï¼‰ã€‚å®ƒè¿›å…¥æ— é™å¾ªç¯ï¼Œæ¥å—è¿æ¥è¯·æ±‚å¹¶å°†è¿æ¥æè¿°ç¬¦æ’å…¥åˆ°sbufä¸­ã€‚å·¥ä½œçº¿ç¨‹ç­‰å¾…è¿æ¥æè¿°ç¬¦å¯ç”¨åä¾¿å°†å…¶ä»ç¼“å†²åŒºä¸­ç§»é™¤ï¼ˆç¬¬ 42 è¡Œï¼‰ï¼Œç„¶åè°ƒç”¨echo_cntå‡½æ•°ä¸ºå®¢æˆ·ç«¯æä¾›æœåŠ¡ã€‚\necho_cntæ˜¯ä¸Šæ–‡æåˆ°çš„echoå‡½æ•°çš„å˜ä½“ï¼Œå®ƒå°†æœåŠ¡å™¨æ¥æ”¶åˆ°çš„å­—èŠ‚æ•°è®°å½•åœ¨å…¨å±€å˜é‡byte_cntä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 #include \"csapp.h\" static int byte_cnt; /* byte counter */ static sem_t mutex; /* and the mutex that protects it */ static void init_echo_cnt(void) { Sem_init(\u0026mutex, 0, 1); byte_cnt = 0; } void echo_cnt(int connfd) { int n; char buf[MAXLINE]; rio_t rio; static pthread_once_t once = PTHREAD_ONCE_INIT; Pthread_once(\u0026once, init_echo_cnt); Rio_readinitb(\u0026rio, connfd); while ((n = Rio_readlineb(\u0026rio, buf, MAXLINE)) != 0) { P(\u0026mutex); byte_cnt += n; printf(\"server received %d (%d total) bytes on fd %d\\n\", n, byte_cnt, connfd); V(\u0026mutex); Rio_writen(connfd, buf, n); } } è¯¥å‡½æ•°ä½¿ç”¨Pthread_onceï¼ˆç¬¬ 19 è¡Œï¼‰åˆå§‹åŒ–ä¿¡å·é‡mutexå’Œbyte_cntï¼Œäºæ˜¯æˆ‘ä»¬ä¾¿ä¸å¿…åœ¨ä¸»çº¿ç¨‹è¿›è¡ŒåŒæ ·çš„æ“ä½œäº†ã€‚è¿™ç§æ–¹æ³•ä½¿åŒ…æ›´åŠ æ˜“äºä½¿ç”¨ï¼Œä¸è¿‡åŒæ—¶ä¹Ÿå¢åŠ äº†è®¸å¤šæ— ç”¨çš„å·¥ä½œï¼ˆåªæœ‰ç¬¬ä¸€æ¬¡è°ƒç”¨Pthread_onceæ˜¯æœ‰æ„ä¹‰çš„ï¼‰ã€‚\nä½¿ç”¨çº¿ç¨‹å®ç°å¹¶è¡Œ åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å¯¹å¹¶å‘çš„ç ”ç©¶ä»…å±€é™äºå•æ ¸å¤„ç†å™¨ã€‚å®é™…ä¸Šå¹¶å‘ç¨‹åºå¾€å¾€åœ¨æ‹¥æœ‰å¤šæ ¸å¤„ç†å™¨çš„æœºå™¨ä¸Šè¿è¡Œå¾—æ›´å¿«ï¼Œè¿™æ˜¯å› ä¸ºæ“ä½œç³»ç»Ÿå†…æ ¸å¯ä»¥åœ¨å¤šä¸ª CPU æ ¸å¿ƒä¸Šå¹¶è¡Œè°ƒåº¦çº¿ç¨‹ã€‚\nç¼–å†™å¹¶è¡Œç¨‹åºååˆ†æ£˜æ‰‹ï¼Œçœ‹ä¼¼å¾ˆå°çš„ä»£ç æ›´æ”¹å´ä¼šå¯¹ç¨‹åºæ€§èƒ½äº§ç”Ÿé‡å¤§çš„å½±å“ã€‚å¹¶è¡Œç¨‹åºåŒæ­¥çº¿ç¨‹çš„å¼€é”€éå¸¸é«˜ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°½é‡é¿å…å®ƒï¼Œå¦åˆ™å°±å¯èƒ½å‡ºç°çº¿ç¨‹æ•°å¢åŠ ç¨‹åºæ€§èƒ½åè€Œé™ä½çš„é—®é¢˜ã€‚å¦‚æœåŒæ­¥æ“ä½œä¸å¯é¿å…ï¼Œåˆ™åº”å½“å°½å¯èƒ½åœ°å¢åŠ æœ‰ç”¨è®¡ç®—ä»¥åˆ†æ‘Šå…¶å¼€é”€ã€‚\nç”±äºåœ¨åŒä¸€ä¸ªæ ¸å¿ƒä¸Šåˆ‡æ¢å¤šä¸ªçº¿ç¨‹çš„ä¸Šä¸‹æ–‡ä¼šäº§ç”Ÿé¢å¤–çš„å¼€é”€ï¼Œå¹¶è¡Œç¨‹åºçš„çº¿ç¨‹æ•°é€šå¸¸ä¸æœºå™¨çš„ CPU æ ¸å¿ƒæ•°ç›¸åŒã€‚\nå¹¶è¡Œç¨‹åºçš„æ€§èƒ½æŒ‡æ ‡ åŠ é€Ÿæ¯”ï¼ˆSpeedupï¼‰è¢«å®šä¹‰ä¸ºï¼š\n$$S_p = \\cfrac{T_1}{T_p}$$\nå…¶ä¸­ï¼Œ$p$ æ˜¯å¤„ç†å™¨æ ¸å¿ƒçš„æ•°é‡ï¼Œ$T_p$ æ˜¯ç¨‹åºåœ¨ $p$ ä¸ªæ ¸å¿ƒä¸Šè¿è¡Œçš„æ—¶é—´ã€‚è¿™ä¸ªå…¬å¼ä¹Ÿè¢«ç§°ä¸ºå¼ºç¼©æ”¾ï¼ˆStrong Scalingï¼‰ã€‚å½“ $T_1$ æ˜¯å¹¶è¡Œç¨‹åºçš„é¡ºåºæ‰§è¡Œç‰ˆæœ¬çš„è¿è¡Œæ—¶é—´æ—¶ï¼Œ$S_p$ è¢«ç§°ä¸ºç»å¯¹åŠ é€Ÿæ¯”ï¼›å½“ $T_1$ æ˜¯å¹¶è¡Œç¨‹åºåœ¨ä¸€ä¸ªæ ¸å¿ƒä¸Šçš„è¿è¡Œæ—¶é—´æ—¶ï¼Œ$S_p$ è¢«ç§°ä¸ºç›¸å¯¹åŠ é€Ÿæ¯”ã€‚ç»å¯¹åŠ é€Ÿæ¯”æ¯”ç›¸å¯¹åŠ é€Ÿæ¯”æ›´èƒ½çœŸå®åœ°åæ˜ ç¨‹åºçš„æ€§èƒ½ï¼Œç„¶è€Œå®ƒä¹Ÿæ›´éš¾æµ‹é‡ã€‚å°¤å…¶æ˜¯ä¸€äº›å¤æ‚çš„å¹¶è¡Œç¨‹åºï¼Œä¸ºå…¶åˆ›å»ºä¸€ä¸ªé¡ºåºæ‰§è¡Œçš„ç‰ˆæœ¬éå¸¸å›°éš¾ã€‚\næ•ˆç‡ï¼ˆEfficiencyï¼‰è¢«å®šä¹‰ä¸ºï¼š\n$$E_p = \\cfrac{S_p}{p} = \\cfrac{T_1}{pT_p}$$\nè¯¥æŒ‡æ ‡èƒ½å¤Ÿè¡¡é‡ç¨‹åºå¹¶è¡ŒåŒ–çš„å¼€é”€ï¼Œæ•ˆç‡é«˜çš„ç¨‹åºç”¨äºçº¿ç¨‹åŒæ­¥å’Œé€šä¿¡çš„æ—¶é—´è¾ƒå°‘ã€‚\nå…¶ä»–å¹¶å‘é—®é¢˜ çº¿ç¨‹å®‰å…¨ è‹¥ä¸€ä¸ªå‡½æ•°è¢«å¤šä¸ªå¹¶å‘çº¿ç¨‹é‡å¤è°ƒç”¨æ—¶æ€»èƒ½ç”Ÿæˆæ­£ç¡®çš„ç»“æœï¼Œæˆ‘ä»¬å°±ç§°å®ƒä¸ºçº¿ç¨‹å®‰å…¨çš„ï¼ˆThread-safeï¼‰ã€‚åä¹‹ï¼Œåˆ™ä¸ºçº¿ç¨‹ä¸å®‰å…¨å‡½æ•°ã€‚çº¿ç¨‹ä¸å®‰å…¨å‡½æ•°å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å››ç±»ï¼š\nä¸ä¿æŠ¤å…±äº«å˜é‡çš„å‡½æ•°ï¼šä¸Šæ–‡æåˆ°çš„ badcnt å‡½æ•°ä¾¿å±äºæ­¤ç±»ã€‚æˆ‘ä»¬åªéœ€ä½¿ç”¨På’ŒVç­‰åŒæ­¥æ“ä½œä¿æŠ¤å…±äº«å˜é‡ä¾¿å¯ä½¿å‡½æ•°çº¿ç¨‹å®‰å…¨ï¼Œä½†åŒæ—¶ä¹Ÿä¼šå¢åŠ ç¨‹åºçš„è¿è¡Œæ—¶é—´ï¼› åœ¨å¤šæ¬¡è°ƒç”¨ä¸­æŒç»­è·Ÿè¸ªçŠ¶æ€çš„å‡½æ•°ï¼šå¦‚ä¼ªéšæœºæ•°ç”Ÿæˆå‡½æ•° randï¼Œå…¶å½“å‰è°ƒç”¨çš„ç»“æœå–å†³äºä¸Šæ¬¡è¿­ä»£çš„ä¸­é—´ç»“æœã€‚å› æ­¤å¦‚æœå¤šä¸ªçº¿ç¨‹è°ƒç”¨è¯¥å‡½æ•°ï¼Œæˆ‘ä»¬å°±æ— æ³•ç¡®å®šè¿”å›çš„éšæœºæ•°åºåˆ—ã€‚ä¿®æ”¹æ­¤ç±»å‡½æ•°å”¯ä¸€çš„æ–¹æ³•ä¾¿æ˜¯é‡å†™å®ƒä»¬ï¼Œä½¿å…¶ä¸ä¾èµ–ä»»ä½•staticæ•°æ®å¹¶è®©è°ƒç”¨è€…é€šè¿‡å‚æ•°æ¥ä¼ é€’çŠ¶æ€ä¿¡æ¯ï¼› 1 2 3 4 5 6 7 8 9 10 11 12 13 14 static unsigned int next_seed = 1; /* rand - return pseudo-random integer on 0..32767 */ int rand(void) { next_seed = next_seed*1103515245 + 12345; return (unsigned int)(next_seed/65536) % 32768; } /* srand - set seed for rand() */ void srand(unsigned int new_seed) { next_seed = new_seed; } è¿”å›æŒ‡å‘staticå˜é‡æŒ‡é’ˆçš„å‡½æ•°ï¼šä¸€äº›å‡½æ•°ï¼Œå¦‚ctimeå’Œgethostbynameï¼Œåœ¨staticå˜é‡ä¸­è®¡ç®—ç»“æœå¹¶è¿”å›æŒ‡å‘è¯¥å˜é‡çš„æŒ‡é’ˆã€‚å¦‚æœå¹¶å‘çº¿ç¨‹è°ƒç”¨æ­¤ç±»å‡½æ•°ï¼Œä¸€ä¸ªçº¿ç¨‹æ­£åœ¨ä½¿ç”¨çš„å˜é‡å°±æœ‰å¯èƒ½è¢«å¦ä¸€ä¸ªçº¿ç¨‹è¿”å›çš„ç»“æœè¦†ç›–ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥é‡å†™å®ƒä»¬ï¼Œä½†ä¹Ÿå¯ä»¥åœ¨æºç ä¸å¯ç”¨æˆ–éš¾ä»¥ä¿®æ”¹æ—¶ä½¿ç”¨é”å®šå’Œå¤åˆ¶ï¼ˆLock-and-Copyï¼‰æŠ€æœ¯æ¥è§£å†³çº¿ç¨‹ä¸å®‰å…¨é—®é¢˜ï¼› 1 2 3 4 5 6 7 8 9 10 char *ctime_ts(const time_t *timep, char *privatep) { char *sharedp; P(\u0026mutex); sharedp = ctime(timep); strcpy(privatep, sharedp); /* Copy string from shared to private */ V(\u0026mutex); return privatep; } è°ƒç”¨çº¿ç¨‹ä¸å®‰å…¨å‡½æ•°çš„å‡½æ•°ï¼šå¦‚æœå‡½æ•°fè°ƒç”¨äº†ç¬¬äºŒç±»çº¿ç¨‹ä¸å®‰å…¨å‡½æ•°gï¼Œé‚£ä¹ˆfä¹Ÿæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„å¹¶ä¸”åªèƒ½é‡å†™gï¼›å¦‚æœgæ˜¯ç¬¬ä¸€ç±»æˆ–ç¬¬ä¸‰ç±»å‡½æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨äº’æ–¥é”ä¿æŠ¤è°ƒç”¨ç‚¹å’Œæ‰€æœ‰ç”Ÿæˆçš„å…±äº«æ•°æ®ä»¥ä½¿fçº¿ç¨‹å®‰å…¨ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œè™½ç„¶å‡½æ•°ctime_tsè°ƒç”¨äº†çº¿ç¨‹ä¸å®‰å…¨å‡½æ•°ctimeï¼Œä½†å®ƒå´æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ å¯é‡å…¥ å¯é‡å…¥ï¼ˆReentrantï¼‰å‡½æ•°æ˜¯ä¸€ç§ç‰¹æ®Šçš„çº¿ç¨‹å®‰å…¨å‡½æ•°ï¼Œå®ƒåœ¨è¢«å¤šä¸ªçº¿ç¨‹è°ƒç”¨æ—¶ä¸ä¼šå¼•ç”¨ä»»ä½•å…±äº«æ•°æ®ã€‚\nå¯é‡å…¥å‡½æ•°ä¸éœ€è¦è¿›è¡ŒåŒæ­¥æ“ä½œï¼Œå› æ­¤é€šå¸¸æ¯”ä¸å¯é‡å…¥å‡½æ•°æ›´é«˜æ•ˆã€‚å°†ç¬¬äºŒç±»çº¿ç¨‹ä¸å®‰å…¨å‡½æ•°é‡å†™ä¸ºå¯é‡å…¥å‡½æ•°æ˜¯ä½¿å…¶çº¿ç¨‹å®‰å…¨çš„å”¯ä¸€æ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥å°†ä¸ŠèŠ‚æåˆ°çš„å‡½æ•°randä¿®æ”¹ä¸ºï¼š\n1 2 3 4 5 6 /* rand_r - a reentrant pseudo-random integer on 0..32767 */ int rand_r(unsigned int *nextp) { *nextp = *nextp * 1103515245 + 12345; return (unsigned int)(*nextp / 65536) % 32768; } å…¶å…³é”®æ€æƒ³åœ¨äºï¼Œrand_rä½¿ç”¨è¢«è°ƒç”¨è€…ä¼ å…¥çš„æŒ‡é’ˆnextpä»£æ›¿äº†é™æ€å˜é‡next_seedã€‚\nå¦‚æœå‡½æ•°çš„æ‰€æœ‰å‚æ•°éƒ½æŒ‰å€¼ä¼ é€’ä¸”æ‰€æœ‰çš„æ•°æ®å¼•ç”¨éƒ½æŒ‡å‘å±€éƒ¨è‡ªåŠ¨å˜é‡ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ç§°è¯¥å‡½æ•°æ˜¯æ˜¾å¼å¯é‡å…¥çš„ã€‚æ— è®ºè¯¥å‡½æ•°è¢«è°ƒç”¨çš„æ–¹å¼å¦‚ä½•ï¼Œå…¶å¯é‡å…¥æ€§éƒ½ä¸å˜ï¼›å¦‚æœå‡½æ•°çš„æŸäº›å‚æ•°é€šè¿‡å¼•ç”¨ï¼ˆæŒ‡é’ˆï¼‰ä¼ é€’ä¸”è°ƒç”¨è€…çº¿ç¨‹å°å¿ƒåœ°å°†éå…±äº«æ•°æ®ä¼ é€’ç»™æŒ‡é’ˆï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ç§°è¯¥å‡½æ•°æ˜¯éšå¼å¯é‡å…¥çš„ï¼Œå‡½æ•°rand_rä¾¿æ˜¯å¦‚æ­¤ã€‚\nç«äº‰ å½“å¤šä¸ªçº¿ç¨‹çš„æ‰§è¡Œé¡ºåºä¼šå½±å“ç¨‹åºçš„æ­£ç¡®æ€§æ—¶å°±ä¼šå‘ç”Ÿç«äº‰ï¼Œå¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 #include \"csapp.h\" #define N 4 void *thread(void *vargp); int main() { pthread_t tid[N]; int i; for (i = 0; i \u003c N; i++) Pthread_create(\u0026tid[i], NULL, thread, \u0026i); for (i = 0; i \u003c N; i++) Pthread_join(tid[i], NULL); exit(0); } /* thread routine */ void *thread(void *vargp) { int myid = *((int *)vargp); printf(\"Hello from thread %d\\n\", myid); return NULL; } ç¤ºä¾‹ç¨‹åºä¸­ï¼Œä¸»çº¿ç¨‹åˆ›å»ºäº†å››ä¸ªå¯¹ç­‰çº¿ç¨‹å¹¶å°†æŒ‡å‘äº†å”¯ä¸€æ•´æ•° ID çš„æŒ‡é’ˆ\u0026iä¼ é€’ç»™å®ƒä»¬ã€‚å¯¹ç­‰çº¿ç¨‹å°†å‚æ•°ä¼ é€’çš„ ID å¤åˆ¶åˆ°å±€éƒ¨å˜é‡ï¼ˆç¬¬ 21 è¡Œï¼‰ï¼Œç„¶åæ‰“å°åŒ…å« ID çš„æ¶ˆæ¯ã€‚è¯¥ç¨‹åºçœ‹ä¼¼ç®€å•ï¼Œç„¶è€Œå´è¾“å‡ºäº†é”™è¯¯çš„ç»“æœï¼š\n1 2 3 4 5 linux\u003e ./race Hello from thread 1 Hello from thread 3 Hello from thread 2 Hello from thread 3 å‡ºç°è¿™ä¸€é—®é¢˜çš„åŸå› åœ¨äºï¼Œä¸»çº¿ç¨‹å¾ªç¯ä¸­å˜é‡içš„è‡ªå¢ï¼ˆç¬¬ 12 è¡Œï¼‰ä¸å¯¹ç­‰çº¿ç¨‹ä¸­å¯¹å‚æ•°çš„è§£å¼•ç”¨å’Œèµ‹å€¼ï¼ˆç¬¬ 21 è¡Œï¼‰ä¹‹é—´äº§ç”Ÿäº†ç«äº‰ã€‚å¦‚æœå¯¹ç­‰çº¿ç¨‹åœ¨ä¸»çº¿ç¨‹å˜é‡iè‡ªå¢ä¹‹åæ‰æ‰§è¡Œç¬¬ 22 è¡Œçš„ä»£ç ï¼Œé‚£ä¹ˆå˜é‡myidå°±å˜æˆäº†å…¶ä»–çº¿ç¨‹çš„ IDã€‚\nä¸ºäº†æ¶ˆé™¤ç«äº‰ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæ¯ä¸ª ID åŠ¨æ€åˆ†é…ä¸€ä¸ªå †å†…å­˜ Blockï¼Œå¹¶å‘çº¿ç¨‹ä¼ é€’æŒ‡å‘è¯¥ Block çš„æŒ‡é’ˆã€‚å®é™…ä¸Šï¼Œå‰æ–‡ä»‹ç»çš„ åŸºäºçº¿ç¨‹çš„å¹¶å‘æœåŠ¡å™¨ ä¾¿ä½¿ç”¨äº†è¿™ä¸€æ–¹æ³•ã€‚\nå¦ä¸€ç§æ–¹æ³•æ˜¯ä¸»çº¿ç¨‹ç›´æ¥å‘å¯¹ç­‰çº¿ç¨‹ä¼ é€’iè€Œéå…¶æŒ‡é’ˆï¼š\n1 2 for (i = 0; i \u003c N; i++) Pthread_create(\u0026tid[i], NULL, thread, (void *) i); å¯¹ç­‰çº¿ç¨‹åˆ™å°†å‚æ•°è½¬æ¢å›intç±»å‹å¹¶èµ‹ç»™å˜é‡myidï¼š\n1 int myid = (int)vargp; ç›¸æ¯”äºç¬¬ä¸€ç§æ–¹æ³•ï¼Œè¿™ç§æ–¹æ³•çš„å¥½å¤„æ˜¯å‡å°‘äº†è°ƒç”¨mallocå’Œfreeå¸¦æ¥çš„å¼€é”€ã€‚ä½†åœ¨ç±»å‹è½¬æ¢ä¸­ï¼Œå®ƒå‡è®¾æŒ‡é’ˆè‡³å°‘ä¸æ•´å‹ä¸€æ ·å¤§ï¼Œå¯èƒ½ä¸é€‚ç”¨äºæŸäº›æ“ä½œç³»ç»Ÿã€‚\næ­»é” ä¿¡å·é‡çš„å¼•å…¥å¯èƒ½ä¼šå¯¼è‡´çº¿ç¨‹è¢«æ°¸è¿œé˜»å¡ï¼Œæˆ‘ä»¬å°†è¿™ç§è¿è¡Œæ—¶é”™è¯¯ç§°ä¸ºæ­»é”ï¼ˆDeadlockï¼‰ã€‚è¿›åº¦å›¾æ˜¯ç†è§£æ­»é”çš„é‡è¦å·¥å…·ï¼š\nä¸Šå›¾ä¸­çš„ä¸¤ä¸ªçº¿ç¨‹ä½¿ç”¨ä¿¡å·é‡så’Œtå®ç°äº’æ–¥ï¼Œä½†ç¨‹åºå‘˜é”™è¯¯åœ°å¯¹På’ŒVæ“ä½œæ’åºã€‚ä¸€æ—¦æŸä¸ªè½¨è¿¹è¿›å…¥äº†æ­»é”çŠ¶æ€dï¼Œä¸¤ä¿¡å·é‡é‡å çš„ç¦æ­¢åŒºåŸŸä¾¿é˜»æ­¢äº†å®ƒæ‰€æœ‰çš„å¯è¡Œè·¯çº¿ã€‚æ¢è¨€ä¹‹ï¼Œç”±äºæ¯ä¸ªé˜»å¡çº¿ç¨‹ç­‰å¾…çš„Væ“ä½œæ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œï¼Œç¨‹åºå‘ç”Ÿæ­»é”ã€‚\næ­»é”æ˜¯ä¸€ä¸ªéå¸¸æ£˜æ‰‹çš„é—®é¢˜ï¼Œå› ä¸ºå®ƒéš¾ä»¥é¢„æµ‹ã€‚ç¨‹åºå¯èƒ½æ­£ç¡®åœ°è¿è¡Œäº†ä¸Šåƒæ¬¡ï¼Œä½†ä¸‹ä¸€æ¬¡ä¾¿ä¼šå‡ºç°æ­»é”ã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œå¹¶å‘ç¨‹åºæ¯æ¬¡æ‰§è¡Œçš„è½¨è¿¹éƒ½æœ‰æ‰€ä¸åŒï¼Œå› æ­¤æ­»é”è¿˜éš¾ä»¥å¤ç°ã€‚\nå¯¹äºäºŒè¿›åˆ¶ä¿¡å·é‡ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨äº’æ–¥é”æ’åºè§„åˆ™æ¥é˜²æ­¢æ­»é”ï¼šè‹¥æ¯ä¸ªçº¿ç¨‹ä»¥ç›¸åŒçš„é¡ºåºåŠ é”ï¼ˆå¦‚ä¸Šå›¾ä¸­ä¸¤çº¿ç¨‹å‡å…ˆæ‰§è¡ŒP(s)ï¼Œå†æ‰§è¡ŒP(t)ï¼‰ï¼Œåˆ™ç¨‹åºæ— æ­»é”ã€‚è§£é”çš„é¡ºåºå¹¶ä¸é‡è¦ï¼Œå› ä¸ºVæ“ä½œä¸ä¼šé˜»å¡çº¿ç¨‹ã€‚\n","description":"","tags":["OS"," Concurrent"],"title":"CSAPP è¯»ä¹¦ç¬”è®°ï¼šå¹¶å‘ç¼–ç¨‹","uri":"/posts/concurrent-programming-note/"},{"content":"æ‰€æœ‰çš„ç½‘ç»œåº”ç”¨ç¨‹åºéƒ½åŸºäºç›¸åŒçš„åŸºæœ¬ç¼–ç¨‹æ¨¡å‹ï¼Œå…·æœ‰ç›¸ä¼¼çš„æ•´ä½“é€»è¾‘ç»“æ„ï¼Œå¹¶ä¸”ä¾èµ–äºç›¸åŒçš„ç¼–ç¨‹æ¥å£ã€‚\nå®¢æˆ·ç«¯-æœåŠ¡å™¨ç¼–ç¨‹æ¨¡å‹ æ¯ä¸ªç½‘ç»œåº”ç”¨ç¨‹åºéƒ½åŸºäºå®¢æˆ·ç«¯-æœåŠ¡å™¨æ¨¡å‹ï¼ˆClient-Server Modelï¼‰ï¼Œå¹¶ç”±ä¸€ä¸ªæœåŠ¡å™¨è¿›ç¨‹å’Œå¤šä¸ªå®¢æˆ·ç«¯è¿›ç¨‹ç»„æˆã€‚æœåŠ¡å™¨ç®¡ç†èµ„æºï¼Œæ“ä½œå®ƒä»¬ä»¥å‘å®¢æˆ·ç«¯æä¾›æœåŠ¡ã€‚\nå®¢æˆ·ç«¯-æœåŠ¡å™¨æ¨¡å‹ä¸­çš„åŸºæœ¬æ“ä½œæ˜¯äº‹åŠ¡ï¼ˆTransactionï¼‰ï¼Œå®ƒç”±ä»¥ä¸‹å››ä¸ªæ­¥éª¤ç»„æˆï¼š\nè¯·æ³¨æ„ï¼Œè¿™é‡Œçš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨æŒ‡çš„æ˜¯è¿›ç¨‹è€Œéæœºå™¨æˆ–ä¸»æœºï¼ˆHostï¼‰ã€‚å•å°ä¸»æœºèƒ½å¤ŸåŒæ—¶è¿è¡Œå¤šä¸ªä¸åŒçš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº‹åŠ¡ä¹Ÿå¯ä»¥åœ¨ç›¸åŒæˆ–ä¸åŒçš„ä¸»æœºä¸Šæ‰§è¡Œã€‚\nç½‘ç»œ ä¸è¿‡ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é€šå¸¸åœ¨ä¸åŒçš„ä¸»æœºä¸Šè¿è¡Œï¼Œä¸¤è€…ä½¿ç”¨è®¡ç®—æœºç½‘ç»œçš„è½¯ç¡¬ä»¶èµ„æºè¿›è¡Œé€šä¿¡ã€‚å¯¹äºä¸»æœºæ¥è¯´ï¼Œç½‘ç»œåªæ˜¯ä¸€ç§ I/O è®¾å¤‡ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸»æœºä½¿ç”¨ DMA æŠ€æœ¯å°†ç½‘ç»œæ•°æ®é€šè¿‡ I/O æ€»çº¿å’Œå­˜å‚¨å™¨æ€»çº¿ä»é€‚é…å™¨å¤åˆ¶åˆ°ä¸»å­˜ï¼ˆåä¹‹äº¦ç„¶ï¼‰ï¼š\nç½‘ç»œæ˜¯æŒ‰åœ°ç†é‚»è¿‘åº¦ç»„ç»‡çš„åˆ†å±‚ç³»ç»Ÿï¼Œå…¶æœ€ä½å±‚æ˜¯è¦†ç›–ä¸€ä¸ªå»ºç­‘ç‰©æˆ–æ ¡å›­çš„å±€åŸŸç½‘ï¼ˆLocal Area Networkï¼ŒLANï¼‰ã€‚è¿„ä»Šä¸ºæ­¢æœ€æµè¡Œçš„å±€åŸŸç½‘æŠ€æœ¯æ˜¯ä»¥å¤ªç½‘ï¼ˆEthernetï¼‰ï¼š\nåœ¨æ›´é«˜å±‚ï¼Œå¤šä¸ªäº’ä¸è¿é€šçš„å±€åŸŸç½‘å¯ä»¥é€šè¿‡è·¯ç”±å™¨è¿æ¥ä¸ºäº’è”ç½‘ï¼ˆInterconnected Networkï¼ŒInternetï¼‰ï¼Œè€Œå¤šä¸ªè·¯ç”±å™¨ç‚¹å¯¹ç‚¹è¿æ¥ä¾¿å½¢æˆäº†å¹¿åŸŸç½‘ï¼ˆWide Area Networkï¼ŒWANï¼‰ï¼š\näº’è”ç½‘å¯ä»¥ç”±ä½¿ç”¨å®Œå…¨ä¸åŒä¸”ä¸å…¼å®¹æŠ€æœ¯çš„å±€åŸŸç½‘å’Œå¹¿åŸŸç½‘ç»„æˆï¼Œè¿™æ˜¯å®ƒçš„ä¸€ä¸ªå…³é”®ç‰¹æ€§ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨æ¯å°ä¸»æœºå’Œè·¯ç”±å™¨ä¸Šè¿è¡Œåè®®è½¯ä»¶ï¼ˆProtocol Softwareï¼‰æ¥æ¶ˆé™¤ä¸åŒç½‘ç»œä¹‹é—´çš„å·®å¼‚ã€‚è¯¥è½¯ä»¶å®ç°çš„åè®®å°†ç®¡ç†ä¸»æœºå’Œè·¯ç”±å™¨å¦‚ä½•åä½œä»¥ä¼ è¾“æ•°æ®ï¼Œå®ƒå¿…é¡»æä¾›ä¸¤ä¸ªåŸºæœ¬åŠŸèƒ½ï¼š\nå‘½åæ–¹æ¡ˆï¼ˆNaming Schemeï¼‰ï¼šä¸ºä¸»æœºåœ°å€å®šä¹‰ç»Ÿä¸€çš„æ ¼å¼ï¼Œå¹¶ä¸ºæ¯å°ä¸»æœºåˆ†é…è‡³å°‘ä¸€ä¸ªå”¯ä¸€æ ‡è¯†å®ƒçš„äº’è”ç½‘åœ°å€ï¼› äº¤ä»˜æœºåˆ¶ï¼ˆDelivery Mechanismï¼‰ï¼šå®šä¹‰ä¸€ç§ç»Ÿä¸€çš„æ–¹å¼å°†æ•°æ®ä½å°è£…ä¸ºè‹¥å¹²ä¸ªå—ï¼Œå³æ•°æ®åŒ…ï¼ˆPacketï¼‰ã€‚å…¶å¤§å°å’Œæº/ç›®çš„ä¸»æœºåœ°å€ä½äºåŒ…çš„å¤´éƒ¨ï¼ˆHeaderï¼‰ï¼Œè€Œæºä¸»æœºå‘é€çš„æ•°æ®ä½åˆ™åœ¨æœ‰æ•ˆè´Ÿè½½ï¼ˆPayloadï¼‰ä¹‹ä¸­ã€‚ å…¨çƒ IP äº’è”ç½‘ å‡ ä¹æ‰€æœ‰çš„ç°ä»£è®¡ç®—æœºç³»ç»Ÿéƒ½æ”¯æŒ TCP/IP åè®®ï¼ˆTransmission Control Protocol/Internet Protocolï¼‰ï¼Œå› æ­¤æ¯å°äº’è”ç½‘ä¸»æœºä¸Šå‡è¿è¡Œç€å®ç°äº†è¯¥åè®®çš„è½¯ä»¶ã€‚å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä½¿ç”¨ Socket æ¥å£å‡½æ•°å’Œ Unix I/O å‡½æ•°æ··åˆçš„æ–¹å¼è¿›è¡Œé€šä¿¡ã€‚å‰è€…é€šå¸¸ä¸ºç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒä»¬ä¼šè¯·æ±‚å†…æ ¸ï¼ˆTrap into Kernelï¼‰è°ƒç”¨ TCP/IP ä¸­çš„å„ç§å†…æ ¸æ€å‡½æ•°ã€‚\nåœ¨ç¨‹åºå‘˜çœ‹æ¥ï¼Œäº’è”ç½‘æ˜¯å…·æœ‰ä»¥ä¸‹å±æ€§çš„ä¸»æœºé›†åˆï¼š\næ‰€æœ‰ä¸»æœºå‡æ˜ å°„åˆ°ä¸€ç»„ 32 ä½çš„ IP åœ°å€ï¼› æ‰€æœ‰ IP åœ°å€å‡æ˜ å°„åˆ°ä¸€ç»„æ ‡è¯†ç¬¦ï¼Œå³åŸŸåï¼ˆDomain Nameï¼‰ï¼› ä¸€å°ä¸»æœºä¸Šçš„è¿›ç¨‹å¯ä»¥é€šè¿‡è¿æ¥ï¼ˆConnectionï¼‰ä¸å…¶ä»–ä»»ä½•ä¸»æœºä¸Šçš„è¿›ç¨‹é€šä¿¡ã€‚ IP åœ°å€ IP åœ°å€æ˜¯ä¸€ä¸ªæ— ç¬¦å·çš„ 32 ä½æ•´æ•°ã€‚ç”±äºå†å²åŸå› ï¼Œç½‘ç»œç¨‹åºå°†å…¶å­˜å‚¨åœ¨å¦‚ä¸‹ç»“æ„ä½“ä¸­ï¼š\n1 2 3 4 /* IP address structure */ struct in_addr { uint32_t s_addr; /* Address in network byte order (big-endian) */ }; äº’è”ç½‘ä¸­ä¸»æœºå­˜å‚¨å­—èŠ‚çš„é¡ºåºå¯èƒ½ä¸åŒï¼Œå› æ­¤ TCP/IP å¿…é¡»ä¸ºæ•´å‹æ•°æ®é¡¹ï¼ˆå¦‚æ•°æ®åŒ…å¤´éƒ¨çš„ IP åœ°å€ï¼‰å®šä¹‰ä¸€ä¸ªç»Ÿä¸€çš„ç½‘ç»œå­—èŠ‚é¡ºåºï¼ˆå¤§ç«¯ï¼‰ã€‚å³ä½¿ä¸»æœºçš„å­—èŠ‚é¡ºåºæ˜¯å°ç«¯ï¼Œin_addrç»“æ„ä½“ä¸­çš„ IP åœ°å€ä¹Ÿä¼šä»¥ç½‘ç»œå­—èŠ‚é¡ºåºå­˜å‚¨ã€‚Unix æä¾›äº†ç”¨äºè½¬æ¢å­—èŠ‚é¡ºåºçš„å‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 #include \u003carpa/inet.h\u003e // host to network uint32_t htonl(uint32_t hostlong); uint16_t htons(uint16_t hostshort); // Returns: value in network byte order // network to host uint32_t ntohl(uint32_t netlong); uint16_t ntohs(unit16_t netshort); // Returns: value in host byte order ä¸ºäº†ä¾¿äºäººç±»é˜…è¯»ï¼ŒIP åœ°å€é€šå¸¸ä»¥ç‚¹åˆ†åè¿›åˆ¶ï¼ˆDotted-Decimalï¼‰çš„å½¢å¼è¡¨ç¤ºã€‚åº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨å‡½æ•°inet_ptonå’Œinet_ntopå¯¹ä¸Šè¿°ä¸¤ç§æ–¹å¼è¿›è¡Œè½¬æ¢ï¼š\n1 2 3 4 5 6 7 #include \u003carpa/inet.h\u003e int inet_pton(AF_INET, const char *src, void *dst); // Returns: 1 if OK, 0 if src is invalid dotted decimal, âˆ’1 on error const char *inet_ntop(AF_INET, const void *src, char *dst, socklen_t size); // Returns: pointer to a dotted-decimal string if OK, NULL on error åŸŸå åƒ IP åœ°å€è¿™æ ·è¾ƒå¤§çš„æ•´æ•°å¾ˆéš¾è®©äººè®°ä½ï¼Œå› æ­¤äº’è”ç½‘å®šä¹‰äº†ä¸€ç»„æ›´åŠ äººæ€§åŒ–çš„åŸŸåé›†åˆå¹¶å°†å…¶ä¸ IP åœ°å€æ˜ å°„ã€‚åŸŸåæ˜¯ç”±å¥ç‚¹åˆ†éš”çš„å•è¯ï¼ˆå­—æ¯ã€æ•°å­—å’Œç ´æŠ˜å·ï¼‰åºåˆ—ï¼Œå¦‚whaleshark.ics.cs.cmu.eduã€‚åŸŸåçš„å±‚çº§ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nè¿æ¥ å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é€šè¿‡è¿æ¥æ¥æ”¶å‘å­—èŠ‚æµå¹¶è¿›è¡Œé€šä¿¡ã€‚è¿æ¥æ˜¯ç‚¹å¯¹ç‚¹ï¼Œå…¨åŒå·¥ï¼ˆæ•°æ®å¯ä»¥åŒæ—¶åœ¨ä¸¤ä¸ªæ–¹å‘ä¸Šä¼ è¾“ï¼‰ä¸”å¯é çš„â€”â€”é™¤éå‘ç”Ÿä¸€äº›ç¾éš¾æ€§çš„æ•…éšœã€‚\nSocket æ˜¯è¿æ¥çš„ç«¯ç‚¹ï¼Œæ¯ä¸ª Socket éƒ½å¯¹åº”äº†ä¸€ä¸ª Socket åœ°å€ã€‚è¯¥åœ°å€ç”± IP åœ°å€å’Œ 16 ä½æ•´å‹çš„ç«¯å£ï¼ˆPortï¼‰ç»„æˆï¼Œè¡¨ç¤ºä¸ºï¼šaddress:portã€‚\nå®¢æˆ·ç«¯ Socket åœ°å€ä¸­çš„ç«¯å£é€šå¸¸æ˜¯å…¶å‘èµ·è¿æ¥è¯·æ±‚æ—¶ç”±å†…æ ¸è‡ªåŠ¨åˆ†é…çš„ï¼Œè¢«ç§°ä¸ºä¸´æ—¶ç«¯å£ï¼ˆEphemeral Portï¼‰ï¼›è€ŒæœåŠ¡å™¨ Socket åœ°å€ä¸­çš„ç«¯å£åˆ™é€šå¸¸ä¸æœåŠ¡æ°¸ä¹…å…³è”ï¼Œè¢«ç§°ä¸ºçŸ¥åç«¯å£ï¼ˆWell-known Portï¼‰ã€‚\nè¿æ¥ç”±ä¸¤ä¸ªç«¯ç‚¹çš„ Socket åœ°å€ï¼ˆå³ Socket Pairï¼‰å”¯ä¸€æ ‡è¯†ï¼Œå¯ä»¥ç”¨å…ƒç»„è¡¨ç¤ºä¸ºï¼š(cliaddr:cliport, servaddr:servport)ã€‚\nSocket æ¥å£ ä¸Šæ–‡æåˆ°ï¼ŒSocket æ¥å£æ˜¯ä¸€ç»„å‡½æ•°ï¼Œå®ƒä»¬ä¸ Unix I/O å‡½æ•°ä¸€åŒç”¨äºæ„å»ºç½‘ç»œåº”ç”¨ç¨‹åºï¼š\nSocket åœ°å€ç»“æ„ä½“ ä» Linux å†…æ ¸çš„è§’åº¦æ¥çœ‹ï¼ŒSocket æ˜¯è¿æ¥çš„ä¸€ä¸ªç«¯ç‚¹ï¼›è€Œä» Linux ç¨‹åºçš„è§’åº¦æ¥çœ‹ï¼ŒSocket åˆ™æ˜¯ä¸€ä¸ªä¸æè¿°ç¬¦å¯¹åº”çš„æ‰“å¼€æ–‡ä»¶ã€‚IPv4 Socket åœ°å€å­˜å‚¨åœ¨ sockaddr_inç±»å‹çš„ 16 å­—èŠ‚ç»“æ„ä½“ä¸­ï¼š\n1 2 3 4 5 6 7 /* IP socket address structure */ struct sockaddr_in { uint16_t sin_family; /* Protocol family (always AF_INET) */ uint16_t sin_port; /* Port number in network byte order */ struct in_addr sin_addr; /* IP address in network byte order */ unsigned char sin_zero[8]; /* Pad to sizeof(struct sockaddr) */ }; sin_familyå­—æ®µä¸ºAF_INETï¼Œsin_portå­—æ®µä¸º 16 ä½ç«¯å£å·ï¼Œsin_addrå­—æ®µä¸­åŒ…å« 32 ä½ IP åœ°å€ã€‚IP åœ°å€å’Œç«¯å£å·å§‹ç»ˆä»¥ç½‘ç»œå­—èŠ‚é¡ºåºï¼ˆå¤§ç«¯ï¼‰å­˜å‚¨ã€‚\nåœ¨è°ƒç”¨å‡½æ•°connectã€bindå’Œacceptæ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¼ å…¥ä¸€ä¸ªæŒ‡å‘ Socket åœ°å€ç»“æ„ä½“çš„æŒ‡é’ˆã€‚ç”±äº Socket æœ‰å¤šç§ç±»å‹ï¼Œä¸åŒåè®®çš„ Socket åœ°å€ç»“æ„ä½“ç±»å‹ä¹Ÿæœ‰æ‰€ä¸åŒã€‚å¦‚ IPv6 Socket åœ°å€å­˜å‚¨åœ¨sockaddr_in6ç±»å‹çš„ç»“æ„ä½“ä¸­ï¼Œsin_familyå­—æ®µä¸ºAF_INET6ï¼›Unix Domain Socket åœ°å€å­˜å‚¨åœ¨sockaddr_unç±»å‹çš„ç»“æ„ä½“ä¸­ï¼Œsin_familyå­—æ®µä¸ºAF_UNIXã€‚ç„¶è€Œåœ¨ Socket æ¥å£è®¾è®¡è€…æ‰€å¤„çš„æ—¶ä»£ï¼ŒC è¿˜å¹¶ä¸æ”¯æŒä½¿ç”¨void *æŒ‡é’ˆã€‚äºæ˜¯ä»–ä»¬åªå¥½é‡æ–°å®šä¹‰ä¸€ä¸ªé€‚ç”¨äºæ‰€æœ‰åè®®çš„sockaddrç»“æ„ä½“ï¼Œç„¶åè¦æ±‚åº”ç”¨ç¨‹åºå°†ä»»ä½•ä¸åè®®æœ‰å…³çš„ç»“æ„ä½“æŒ‡é’ˆè½¬æ¢ä¸ºè¿™ç§é€šç”¨çš„ç»“æ„ä½“æŒ‡é’ˆï¼š\n1 2 3 4 5 /* Generic socket address structure (for connect, bind, and accept) */ struct sockaddr { uint16_t sa_family; /* Protocol family */ char sa_data[14]; /* Address data */ }; socketå‡½æ•° å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä½¿ç”¨socketå‡½æ•°åˆ›å»ºä¸€ä¸ª Socket æ–‡ä»¶æè¿°ç¬¦ï¼š\n1 2 3 4 #include \u003csys/types.h\u003e #include \u003csys/socket.h\u003e int socket(int domain, int type, int protocol); // Returns: nonnegative descriptor if OK, âˆ’1 on erro å¦‚æœæˆ‘ä»¬å¸Œæœ› Socket æˆä¸ºè¿æ¥çš„ç«¯ç‚¹ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‚æ•°è°ƒç”¨è¯¥å‡½æ•°ï¼š\n1 clientfd = Socket(AF_INET, SOCK_STREAM, 0); å…¶ä¸­ï¼ŒAF_INETä»£è¡¨ä½¿ç”¨ 32 ä½ IP åœ°å€ï¼ŒSOCK_STREAMè¡¨ç¤º Socket å°†æˆä¸ºè¿æ¥çš„ç«¯ç‚¹ã€‚è¯¥å‡½æ•°è¿”å›çš„æè¿°ç¬¦clientfdåªæ˜¯éƒ¨åˆ†æ‰“å¼€ï¼Œè¿˜ä¸èƒ½è¿›è¡Œè¯»å†™ã€‚\nconnectå‡½æ•° å®¢æˆ·ç«¯è°ƒç”¨connectå‡½æ•°ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼š\n1 2 3 4 #include \u003csys/socket.h\u003e int connect(int clientfd, const struct sockaddr *addr, socklen_t addrlen); //Returns: 0 if OK, âˆ’1 on error è¯¥å‡½æ•°å°è¯•è¿æ¥ Socket åœ°å€ä¸ºaddrçš„æœåŠ¡å™¨ï¼Œå‚æ•°addrlenæ˜¯ç»“æ„ä½“sockaddr_inçš„å¤§å°ã€‚connectå‡½æ•°åœ¨è¿æ¥å»ºç«‹æˆ–å‘ç”Ÿé”™è¯¯å‰ä¼šä¸€ç›´é˜»å¡ï¼Œè‹¥å»ºç«‹æˆåŠŸåˆ™ Socket æè¿°ç¬¦clientfdä¾¿å¯è¿›è¡Œè¯»å†™ã€‚\nbindå‡½æ•° bindå‡½æ•°è¯·æ±‚å†…æ ¸å°†å‚æ•°addrä¸­çš„æœåŠ¡å™¨ Socket åœ°å€ä¸ Socket æè¿°ç¬¦sockfdç›¸å…³è”ï¼Œå‚æ•°addrlenæ˜¯ç»“æ„ä½“sockaddr_inçš„å¤§å°ï¼š\n1 2 3 4 #include \u003csys/socket.h\u003e int bind(int sockfd, const struct sockaddr *addr, socklen_t addrlen); // Returns: 0 if OK, âˆ’1 on error listenå‡½æ•° é»˜è®¤æƒ…å†µä¸‹ï¼Œå†…æ ¸å‡å®šsocketå‡½æ•°åˆ›å»ºçš„æè¿°ç¬¦æ˜¯ç”¨äºå®¢æˆ·ç«¯è¿æ¥çš„ã€‚å› æ­¤æœåŠ¡å™¨éœ€è¦è°ƒç”¨listenå‡½æ•°å‘Šè¯‰å†…æ ¸å‚æ•°sockfdç”¨äºæœåŠ¡å™¨è€Œéå®¢æˆ·ç«¯ï¼š\n1 2 3 #include \u003csys/socket.h\u003e int listen(int sockfd, int backlog); // Returns: 0 if OK, âˆ’1 on error å‚æ•°backlogæ˜¯å†…æ ¸å¼€å§‹æ‹’ç»è¯·æ±‚å‰åº”å½“æ’é˜Ÿçš„æœªå®Œæˆè¿æ¥è¯·æ±‚æ•°ï¼Œé€šå¸¸è®¾ä¸º 1024ã€‚\nacceptå‡½æ•° æœåŠ¡å™¨è°ƒç”¨acceptå‡½æ•°ç­‰å¾…å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚åˆ°è¾¾ç›‘å¬æè¿°ç¬¦listenfdï¼Œç„¶åå°†å®¢æˆ·ç«¯ Socket åœ°å€å†™å…¥åˆ°addrä¸­ï¼Œæœ€åè¿”å›ä¸€ä¸ªå¯ä½¿ç”¨ Unix I/O å‡½æ•°ä¸å®¢æˆ·ç«¯é€šä¿¡çš„è¿æ¥æè¿°ç¬¦ï¼š\n1 2 3 #include \u003csys/socket.h\u003e int accept(int listenfd, struct sockaddr *addr, int *addrlen); // Returns: nonnegative connected descriptor if OK, âˆ’1 on error ç›‘å¬æè¿°ç¬¦ä½œä¸ºå®¢æˆ·ç«¯å‘èµ·è¿æ¥è¯·æ±‚çš„ç«¯ç‚¹ï¼Œé€šå¸¸åªä¼šåˆ›å»ºä¸€æ¬¡ï¼Œåœ¨æœåŠ¡å™¨çš„ç”Ÿå‘½å‘¨æœŸå†…å­˜åœ¨ï¼›è¿æ¥æè¿°ç¬¦æ˜¯å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´å·²å»ºç«‹çš„è¿æ¥çš„ç«¯ç‚¹ï¼Œåœ¨æ¯æ¬¡æœåŠ¡å™¨æ¥å—è¿æ¥è¯·æ±‚æ—¶åˆ›å»ºï¼Œå¹¶ä¸”ä»…åœ¨æœåŠ¡å™¨ä¸ºå®¢æˆ·ç«¯æä¾›æœåŠ¡æ—¶å­˜åœ¨ï¼š\nåœ¨è¿æ¥å»ºç«‹ä¹‹åï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å¯ä»¥åˆ†åˆ«é€šè¿‡è¯»å†™clientfdå’Œconnfdæ¥ä¼ è¾“æ•°æ®ã€‚\nä¸»æœºå’ŒæœåŠ¡è½¬æ¢ æˆ‘ä»¬å¯ä»¥å°†getaddrinfoå’Œgetnameinfoå‡½æ•°ä¸ Socket æ¥å£å‡½æ•°ç»“åˆï¼Œç¼–å†™é€‚ç”¨äºä»»ä½•ç‰ˆæœ¬ IP åè®®çš„ç½‘ç»œç¨‹åºã€‚\ngetaddrinfoå‡½æ•° getaddrinfoå‡½æ•°å°†ä¸»æœºåï¼ˆæˆ–ä¸»æœºåœ°å€ï¼‰å’ŒæœåŠ¡åï¼ˆæˆ–ç«¯å£å·ï¼‰è½¬æ¢ä¸º Socket åœ°å€ç»“æ„ä½“ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 #include \u003csys/types.h\u003e #include \u003csys/socket.h\u003e #include \u003cnetdb.h\u003e struct addrinfo { int ai_flags; /* Hints argument flags */ int ai_family; /* First arg to socket function */ int ai_socktype; /* Second arg to socket function */ char ai_protocol; /* Third arg to socket function */ char *ai_canonname; /* Canonical hostname */ size_t ai_addrlen; /* Size of ai_addr struct */ struct sockaddr *ai_addr; /* Ptr to socket address structure */ struct addrinfo *ai_next; /* Ptr to next item in linked list */ } int getaddrinfo(const char *host, const char *service, const struct addrinfo *hints, struct addrinfo **result); // Returns: 0 if OK, nonzero error code on error è¯¥å‡½æ•°ä¼šæ ¹æ®hintsæŒ‡å®šçš„è§„èŒƒåˆ†é…å¹¶åˆå§‹åŒ–ä¸€ä¸ªaddrinfoç»“æ„ä½“é“¾è¡¨ï¼Œå…¶ä¸­æ¯ä¸ªç»“æ„ä½“çš„ai_addrå­—æ®µéƒ½æŒ‡å‘ä¸€ä¸ªä¸hostå’Œserviceå¯¹åº”çš„ Socket åœ°å€ï¼ŒresultæŒ‡å‘é“¾è¡¨å¤´éƒ¨ï¼š\nå‚æ•°hostå¯ä»¥æ˜¯åŸŸåï¼Œä¹Ÿå¯ä»¥æ˜¯æ•°å­—åœ°å€ï¼ˆå¦‚ç‚¹åˆ†åè¿›åˆ¶ IP åœ°å€ï¼‰ï¼›å‚æ•°serviceå¯ä»¥æ˜¯æœåŠ¡åç§°ï¼ˆå¦‚ httpï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯åè¿›åˆ¶ç«¯å£å·ã€‚å¦‚æœæˆ‘ä»¬ä¸éœ€è¦ Socket åœ°å€ä¸­çš„ä¸»æœºåï¼Œå°±å¯ä»¥å°†hostè®¾ä¸ºNULLã€‚å¯¹äºæœåŠ¡åæ¥è¯´ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œä¸è¿‡ä¸¤è€…ä¸èƒ½åŒæ—¶ä¸ºNULLã€‚\nå®¢æˆ·ç«¯åœ¨è°ƒç”¨è¯¥å‡½æ•°åä¼šéå†ä¸Šè¿°é“¾è¡¨ï¼Œä¾æ¬¡ä½¿ç”¨æ¯ä¸ª Socket åœ°å€ä½œä¸ºå‚æ•°è°ƒç”¨socketå’Œconnectç›´è‡³æˆåŠŸå¹¶å»ºç«‹è¿æ¥ï¼›æœåŠ¡å™¨åœ¨è°ƒç”¨è¯¥å‡½æ•°åä¼šéå†ä¸Šè¿°é“¾è¡¨ï¼Œä¾æ¬¡ä½¿ç”¨æ¯ä¸ª Socket åœ°å€ä½œä¸ºå‚æ•°è°ƒç”¨socketå’Œbindç›´è‡³æˆåŠŸä¸”æè¿°ç¬¦è¢«ç»‘å®šåˆ°ä¸€ä¸ªæœ‰æ•ˆçš„ Socket åœ°å€ã€‚\nç»†å¿ƒçš„è¯»è€…å¯èƒ½ä¼šç–‘æƒ‘ä¸ºä»€ä¹ˆgetaddrinfoä¼šä¸ºåŒä¸€ä¸ªhostå’Œserviceåˆå§‹åŒ–å¤šä¸ªaddrinfoç»“æ„ä½“ï¼Œè¿™æ˜¯å› ä¸ºï¼šä¸»æœºå¯èƒ½æ˜¯å¤šå®¿ä¸»çš„ï¼ˆMultihomedï¼‰ï¼Œå¯ä»¥é€šè¿‡å¤šç§åè®®ï¼ˆå¦‚ IPv4 å’Œ IPv6ï¼‰è®¿é—®ï¼›å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡ä¸åŒçš„ Socket ç±»å‹ï¼ˆå¦‚SOCK_STREAMå’ŒSOCK_DGRAMï¼‰è®¿é—®ç›¸åŒçš„æœåŠ¡ã€‚å› æ­¤é€šå¸¸æˆ‘ä»¬ä¼šæ ¹æ®éœ€æ±‚è®¾ç½®hintså‚æ•°ï¼Œä»¥ä½¿å‡½æ•°ç”Ÿæˆæˆ‘ä»¬æœŸæœ›çš„ Socket åœ°å€ã€‚\nå½“hintsä½œä¸ºå‚æ•°ä¼ é€’æ—¶ï¼Œåªæœ‰ai_familyã€ai_socktypeã€ai_protocolå’Œai_flagså­—æ®µå¯ä»¥è¢«è®¾ç½®ï¼Œå…¶ä»–å­—æ®µå¿…é¡»ä¸º 0 æˆ–NULLã€‚åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨ memset å‡½æ•°å°†hintså½’é›¶ï¼Œç„¶åè®¾ç½®ä»¥ä¸‹å­—æ®µï¼š\nai_familyä¸ºAF_INETæ—¶ï¼Œè¯¥å‡½æ•°å°†ç”Ÿæˆ IPv4 Socket åœ°å€ï¼›ai_familyä¸ºAF_INET6æ—¶ï¼Œè¯¥å‡½æ•°å°†ç”Ÿæˆ IPv6 Socket åœ°å€ï¼› å¯¹äºé¢å‘è¿æ¥çš„ç½‘ç»œåº”ç”¨ç¨‹åºï¼Œai_socktypeåº”å½“è®¾ä¸ºSOCK_STREAMï¼› ai_flagsæ˜¯èƒ½å¤Ÿä¿®æ”¹å‡½æ•°é»˜è®¤è¡Œä¸ºçš„ä½æ©ç ï¼Œä¸»è¦åŒ…æ‹¬ï¼š AI_ADDRCONFIGï¼šä»…å½“æœ¬åœ°ä¸»æœºä½¿ç”¨ IPv4 æ—¶ç”Ÿæˆ IPv4 Socket åœ°å€ï¼› AI_CANONNAMEï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œaddrinfoç»“æ„ä½“å†…çš„ai_canonnameå­—æ®µä¸ºNULLã€‚è‹¥è®¾ç½®è¯¥æ©ç ï¼Œå‡½æ•°ä¼šå°†é“¾è¡¨ä¸­ç¬¬ä¸€ä¸ªaddrinfoç»“æ„ä½“å†…çš„ai_canonnameå­—æ®µæŒ‡å‘ä¸»æœºçš„è§„èŒƒï¼ˆå®˜æ–¹ï¼‰åç§°ï¼ˆå¦‚ä¸Šå›¾æ‰€ç¤ºï¼‰ï¼› AI_NUMERICSERVï¼šå¼ºåˆ¶å‚æ•°serviceä½¿ç”¨ç«¯å£å·ï¼› AI_PASSIVEï¼šæœåŠ¡å™¨å¯ä»¥ä½¿ç”¨è¯¥å‡½æ•°ç”Ÿæˆçš„ Socket åœ°å€åˆ›å»ºç›‘å¬æè¿°ç¬¦ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå‚æ•°hoståº”å½“è®¾ä¸ºNULLï¼Œè¡¨ç¤ºæœåŠ¡å™¨çš„æ‰€æœ‰ IP åœ°å€å‡å¯ç”¨äºè¿æ¥ï¼ˆå³INADDR_ANYæˆ– 0.0.0.0ï¼‰ï¼› å½“getaddrinfoåˆå§‹åŒ–addrinfoç»“æ„ä½“é“¾è¡¨æ—¶ï¼Œå®ƒä¼šå¡«å……é™¤ai_flagsä¹‹å¤–çš„æ‰€æœ‰å­—æ®µã€‚ai_familyã€ai_socktypeå’Œai_protocolå¯ä»¥ç›´æ¥ä¼ é€’ç»™socketå‡½æ•°ï¼Œai_addrå’Œai_addrlenå¯ä»¥ç›´æ¥ä¼ é€’ç»™connectå’Œbindå‡½æ•°ã€‚å› æ­¤æˆ‘ä»¬èƒ½å¤Ÿä½¿ç”¨å®ƒç¼–å†™é€‚ç”¨äºä»»ä½•ç‰ˆæœ¬ IP åè®®çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ã€‚\nä¸ºäº†é¿å…å†…å­˜æ³„æ¼ï¼Œåº”ç”¨ç¨‹åºæœ€ç»ˆå¿…é¡»è°ƒç”¨freeaddrinfoå‡½æ•°é‡Šæ”¾é“¾è¡¨ï¼š\n1 2 void freeaddrinfo(struct addrinfo *result); // Returns: nothing getaddrinfoå‡½æ•°ä¼šè¿”å›éé›¶é”™è¯¯ç ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥è°ƒç”¨gai_strerrorå‡½æ•°å°†å…¶è½¬æ¢ä¸ºæ¶ˆæ¯å­—ç¬¦ä¸²ï¼š\n1 2 const char *gai_strerror(int errcode); // Returns: error message getnameinfoå‡½æ•° getnameinfoå‡½æ•°æ˜¯getaddrinfoçš„é€†å‡½æ•°ï¼Œå®ƒå°† Socket åœ°å€ç»“æ„ä½“è½¬æ¢ä¸ºå¯¹åº”çš„ä¸»æœºåå’ŒæœåŠ¡åï¼š\n1 2 3 4 5 6 #include \u003csys/socket.h\u003e #include \u003cnetdb.h\u003e int getnameinfo(const struct sockaddr *sa, socklen_t salen, char *host, size_t hostlen, char *service, size_t servlen, int flags); // Returns: 0 if OK, nonzero error code on error å‚æ•°saæŒ‡å‘ä¸€ä¸ªå¤§å°ä¸ºsalenå­—èŠ‚çš„ Socket åœ°å€ç»“æ„ä½“ï¼ŒhostæŒ‡å‘ä¸€ä¸ªå¤§å°ä¸ºhostlenå­—èŠ‚çš„ç¼“å†²åŒºï¼Œè€Œserviceåˆ™æŒ‡å‘ä¸€ä¸ªå¤§å°ä¸ºservlenå­—èŠ‚çš„ç¼“å†²åŒºã€‚è¯¥å‡½æ•°å°†saè½¬æ¢ä¸ºä¸»æœºåå’ŒæœåŠ¡åå­—ç¬¦ä¸²ï¼Œç„¶åå°†å®ƒä»¬å¤åˆ¶åˆ°hostå’ŒserviceæŒ‡å‘çš„ç¼“å†²åŒºã€‚å¦‚æœè¯¥å‡½æ•°è¿”å›éé›¶é”™è¯¯ä»£ç ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥è°ƒç”¨gai_strerrorå°†å…¶è½¬æ¢ä¸ºæ¶ˆæ¯å­—ç¬¦ä¸²ã€‚\nå¦‚æœæˆ‘ä»¬ä¸éœ€è¦ä¸»æœºåï¼Œå°±å¯ä»¥å°†hostè®¾ä¸ºNULLã€‚å¯¹äºæœåŠ¡åæ¥è¯´ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œä¸è¿‡ä¸¤è€…ä¸èƒ½åŒæ—¶ä¸ºNULLã€‚\nå‚æ•°flagsæ˜¯ä¿®æ”¹å‡½æ•°é»˜è®¤è¡Œä¸ºçš„ä½æ©ç ï¼ŒåŒ…æ‹¬ï¼š\nNI_NUMERICHOSTï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œå‡½æ•°å°†åœ¨hostæŒ‡å‘çš„ç¼“å†²åŒºä¸­ç”Ÿæˆä¸€ä¸ªåŸŸåã€‚è‹¥è®¾ç½®è¯¥æ©ç ï¼Œå‡½æ•°ä¼šç”Ÿæˆä¸€ä¸ªæ•°å­—åœ°å€å­—ç¬¦ä¸²ï¼› NI_NUMERICSERVï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œå‡½æ•°å°†åœ¨/etc/servicesæ–‡ä»¶ä¸­æŸ¥æ‰¾å¹¶ç”ŸæˆæœåŠ¡åã€‚è‹¥è®¾ç½®è¯¥æ©ç ï¼Œå‡½æ•°ä¼šè·³è¿‡æŸ¥æ‰¾å¹¶ç”Ÿæˆç«¯å£å·ã€‚ å¦‚ä¸‹ç¤ºä¾‹ç¨‹åºä½¿ç”¨getaddrinfoå’Œgetnameinfoå‡½æ•°å®ç°åŸŸåè§£æï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 #include \"csapp.h\" int main(int argc, char **argv) { struct addrinfo *p, *listp, hints; char buf[MAXLINE]; int rc, flags; if (argc != 2) { fprintf(stderr, \"usage: %s \u003cdomain name\u003e\\n\", argv[0]); exit(0); } /* Get a list of addrinfo records */ memset(\u0026hints, 0, sizeof(struct addrinfo)); hints.ai_family = AF_INET; /* IPv4 only */ hints.ai_socktype = SOCK_STREAM; /* Connections only */ if ((rc = getaddrinfo(argv[1], NULL, \u0026hints, \u0026listp)) != 0) { fprintf(stderr, \"getaddrinfo error: %s\\n\", gai_strerror(rc)); exit(1); } /* Walk the list and display each IP address */ flags = NI_NUMERICHOST; /* Display address string instead of domain name */ for (p = listp; p; p = p-\u003eai_next) { getnameinfo(p-\u003eai_addr, p-\u003eai_addrlen, buf, MAXLINE, NULL, 0, flags); printf(\"%s\\n\", buf); } /* Clean up */ freeaddrinfo(listp); exit(0); } Socket æ¥å£çš„è¾…åŠ©å‡½æ•° getaddrinfoå’Œ Socket æ¥å£å‡½æ•°å¹¶ä¸æ˜“äºä½¿ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ›´é«˜çº§çš„è¾…åŠ©å‡½æ•°open_clientfdå’Œopen_listenfdåŒ…è£…å®ƒä»¬ã€‚\nopen_clientfdå‡½æ•° å®¢æˆ·ç«¯è°ƒç”¨open_clientfdå‡½æ•°ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼š\n1 2 3 #include \"csapp.h\" int open_clientfd(char *hostname, char *port); // Returns: descriptor if OK, âˆ’1 on error å‚æ•°hostnameæ˜¯æœåŠ¡å™¨æ‰€åœ¨çš„ä¸»æœºåï¼Œå‚æ•°portæ˜¯æœåŠ¡å™¨ç›‘å¬çš„ç«¯å£å·ã€‚å‡½æ•°è¿”å›ä¸€ä¸ªæ‰“å¼€çš„ Socket æè¿°ç¬¦ï¼Œå®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨ Unix I/O å‡½æ•°å¯¹å…¶è¯»å†™ã€‚è¯¥å‡½æ•°çš„ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 int open_clientfd(char *hostname, char *port) { int clientfd; struct addrinfo hints, *listp, *p; /* Get a list of potential server addresses */ memset(\u0026hints, 0, sizeof(struct addrinfo)); hints.ai_socktype = SOCK_STREAM; /* Open a connection */ hints.ai_flags = AI_NUMERICSERV; /* ... using a numeric port arg. */ hints.ai_flags |= AI_ADDRCONFIG; /* Recommended for connections */ getaddrinfo(hostname, port, \u0026hints, \u0026listp); /* Walk the list for one that we can successfully connect to */ for (p = listp; p; p = p-\u003eai_next) { /* Create a socket descriptor */ if ((clientfd = socket(p-\u003eai_family, p-\u003eai_socktype, p-\u003eai_protocol)) \u003c 0) continue; /* Socket failed, try the next */ /* Connect to the server */ if (connect(clientfd, p-\u003eai_addr, p-\u003eai_addrlen) != -1) break; /* Success */ Close(clientfd); /* Connect failed, try another */ } /* Clean up */ freeaddrinfo(listp); if (!p) /* All connects failed */ return -1; else /* The last connect succeeded */ return clientfd; } open_clientfdä¸­ä¸å­˜åœ¨ä»»ä½•ä¾èµ–äºç‰¹å®šç‰ˆæœ¬åè®®çš„ä»£ç ï¼Œè°ƒç”¨socketå’Œconnectæ—¶ä½¿ç”¨çš„å‚æ•°æ˜¯ç”±getaddrinfoè‡ªåŠ¨ç”Ÿæˆçš„ï¼Œå› æ­¤è¯¥å‡½æ•°å¹²å‡€ä¸”å¯ç§»æ¤ã€‚\nopen_listenfdå‡½æ•° æœåŠ¡å™¨è°ƒç”¨open_listenfdå‡½æ•°åˆ›å»ºä¸€ä¸ªèƒ½å¤Ÿæ¥å—è¿æ¥è¯·æ±‚çš„ç›‘å¬æè¿°ç¬¦ï¼š\n1 2 3 #include \"csapp.h\" int open_listenfd(char *port); // Returns: descriptor if OK, âˆ’1 on error å‚æ•°portæ˜¯æœåŠ¡å™¨ç›‘å¬çš„ç«¯å£å·ã€‚è¯¥å‡½æ•°çš„ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 int open_listenfd(char *port) { struct addrinfo hints, *listp, *p; int listenfd, optval = 1; /* Get a list of potential server addresses */ memset(\u0026hints, 0, sizeof(struct addrinfo)); hints.ai_socktype = SOCK_STREAM; /* Accept connections */ hints.ai_flags = AI_PASSIVE | AI_ADDRCONFIG; /* ... on any IP address */ hints.ai_flags |= AI_NUMERICSERV; /* ... using port number */ getaddrinfo(NULL, port, \u0026hints, \u0026listp); /* Walk the list for one that we can bind to */ for (p = listp; p; p = p-\u003eai_next) { /* Create a socket descriptor */ if ((listenfd = socket(p-\u003eai_family, p-\u003eai_socktype, p-\u003eai_protocol)) \u003c 0) continue; /* Socket failed, try the next */ /* Eliminates \"Address already in use\" error from bind */ Setsockopt(listenfd, SOL_SOCKET, SO_REUSEADDR, (const void *)\u0026optval, sizeof(int)); /* Bind the descriptor to the address */ if (bind(listenfd, p-\u003eai_addr, p-\u003eai_addrlen) == 0) break; /* Success */ Close(listenfd); /* Bind failed, try the next */ } /* Clean up */ freeaddrinfo(listp); if (!p) /* No address worked */ return -1; /* Make it a listening socket ready to accept connection requests */ if (listen(listenfd, LISTENQ) \u003c 0) { Close(listenfd); return -1; } return listenfd; } åœ¨ç¬¬ 20 è¡Œä¸­æˆ‘ä»¬ä½¿ç”¨Setsockoptå‡½æ•°ï¼ˆè§ csapp.cï¼‰é…ç½®æœåŠ¡å™¨ï¼Œä½¿å…¶èƒ½å¤Ÿåœ¨é‡æ–°å¯åŠ¨åç«‹å³å¼€å§‹æ¥å—è¿æ¥è¯·æ±‚ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œé‡æ–°å¯åŠ¨çš„æœåŠ¡å™¨ä¼šåœ¨å¤§çº¦ 30 ç§’å†…æ‹’ç»æ¥è‡ªå®¢æˆ·ç«¯çš„è¿æ¥ï¼Œè¿™å°†ä¸¥é‡å½±å“è°ƒè¯•ã€‚\nç¤ºä¾‹ Echo å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ å­¦ä¹  Socket æ¥å£å‡½æ•°çš„æœ€ä½³æ–¹æ³•ä¾¿æ˜¯é˜…è¯»ç¤ºä¾‹ä»£ç ã€‚ä¸€ä¸ªç®€å•çš„å®¢æˆ·ç«¯ç¨‹åºå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 #include \"csapp.h\" int main(int argc, char **argv) { int clientfd; char *host, *port, buf[MAXLINE]; rio_t rio; if (argc != 3) { fprintf(stderr, \"usage: %s \u003chost\u003e \u003cport\u003e\\n\", argv[0]); exit(0); } host = argv[1]; port = argv[2]; clientfd = Open_clientfd(host, port); Rio_readinitb(\u0026rio, clientfd); while (Fgets(buf, MAXLINE, stdin) != NULL) { Rio_writen(clientfd, buf, strlen(buf)); Rio_readlineb(\u0026rio, buf, MAXLINE); Fputs(buf, stdout); } Close(clientfd); exit(0); } åœ¨ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥ä¹‹åï¼Œå®¢æˆ·ç«¯è¿›å…¥ While å¾ªç¯ã€‚å®ƒä¸æ–­ä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–æ–‡æœ¬è¡Œï¼ˆFgetsï¼‰ï¼Œç„¶åå°†æ–‡æœ¬è¡Œå‘é€åˆ°æœåŠ¡å™¨ï¼ˆRio_writenï¼‰ã€‚æ¥ä¸‹æ¥å†è¯»å–æœåŠ¡å™¨çš„è¿”å›ï¼ˆRio_readlinebï¼‰ï¼Œæœ€ç»ˆå°†ç»“æœæ‰“å°åˆ°æ ‡å‡†è¾“å‡ºï¼ˆFputsï¼‰ã€‚å½“ç”¨æˆ·é”®å…¥ Ctrl+D æ—¶ï¼Œå¾ªç¯ä¸­æ­¢ï¼Œå®¢æˆ·ç«¯éšåå…³é—­æè¿°ç¬¦clientfdã€‚\nè¯¥å®¢æˆ·ç«¯è¿æ¥çš„æœåŠ¡å™¨ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 #include \"csapp.h\" typedef struct sockaddr SA; void echo(int connfd) { size_t n; char buf[MAXLINE]; rio_t rio; Rio_readinitb(\u0026rio, connfd); while ((n = Rio_readlineb(\u0026rio, buf, MAXLINE)) != 0) { printf(\"server received %d bytes\\n\", (int)n); Rio_writen(connfd, buf, n); } } int main(int argc, char **argv) { int listenfd, connfd; socklen_t clientlen; struct sockaddr_storage clientaddr; /* Enough space for any address */ char client_hostname[MAXLINE], client_port[MAXLINE]; if (argc != 2) { fprintf(stderr, \"usage: %s \u003cport\u003e\\n\", argv[0]); exit(0); } listenfd = Open_listenfd(argv[1]); while (1) { clientlen = sizeof(struct sockaddr_storage); connfd = accept(listenfd, (SA *)\u0026clientaddr, \u0026clientlen); getnameinfo((SA *)\u0026clientaddr, clientlen, client_hostname, MAXLINE, client_port, MAXLINE, 0); printf(\"Connected to (%s, %s)\\n\", client_hostname, client_port); echo(connfd); Close(connfd); } exit(0); } ä»£ç ç¬¬ 23 è¡Œå£°æ˜çš„å˜é‡clientaddræ˜¯ä¸€ä¸ªsockaddr_storageç±»å‹çš„ Socket åœ°å€ç»“æ„ä½“ï¼Œacceptå‡½æ•°ä¼šåœ¨è¿”å›å‰å°†å®¢æˆ·ç«¯çš„ Socket åœ°å€å¡«å…¥å…¶ä¸­ã€‚æˆ‘ä»¬ä½¿ç”¨sockaddr_storageè€Œésockaddr_inçš„åŸå› åœ¨äºå‰è€…è¶³å¤Ÿå¤§ï¼Œå¯ä»¥ä¿å­˜ä»»ä½•ç±»å‹çš„ Socket åœ°å€ï¼Œä»è€Œä½¿ä»£ç ä¸åè®®ç‹¬ç«‹ï¼ˆè¯¦è§ï¼šReasoning behind C sockets sockaddr and sockaddr_storageï¼‰ã€‚\næœåŠ¡å™¨æ‰“å¼€ç›‘å¬æè¿°ç¬¦åè¿›å…¥æ— é™å¾ªç¯ã€‚å®ƒç­‰å¾…æ¥è‡ªå®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ï¼Œæ‰“å°å®¢æˆ·ç«¯çš„ä¸»æœºåå’Œç«¯å£ï¼Œç„¶åè°ƒç”¨echoå‡½æ•°ã€‚è¯¥å‡½æ•°é‡å¤è¯»å–å¹¶å†™å…¥æ–‡æœ¬è¡Œï¼Œç›´åˆ°Rio_readlinebé‡åˆ° EOFï¼ˆå¯¹äºç½‘ç»œè¿æ¥ï¼Œå½“ä¸€ç«¯çš„è¿›ç¨‹å…³é—­è¿æ¥ï¼Œå¦ä¸€ç«¯çš„è¿›ç¨‹å°è¯•è¯»å–æµä¸­çš„æœ€åä¸€ä¸ªå­—èŠ‚æ—¶å°†æ£€æµ‹åˆ° EOFï¼‰ã€‚ä¸€æ—¦å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å‡å…³é—­äº†å„è‡ªçš„æè¿°ç¬¦ï¼Œè¿æ¥ä¾¿ä¼šç»ˆæ­¢ã€‚\nè¯·æ³¨æ„ï¼Œç¤ºä¾‹çš„ç®€å•æœåŠ¡å™¨ä¸€æ¬¡åªèƒ½å¤„ç†ä¸€ä¸ªå®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ï¼Œæˆ‘ä»¬ç§°è¿™ç§ç±»å‹çš„æœåŠ¡å™¨ä¸ºè¿­ä»£æœåŠ¡å™¨ï¼ˆIterative Serverï¼‰ã€‚æ›´åŠ å¤æ‚çš„å¹¶å‘æœåŠ¡å™¨ï¼ˆConcurrent Serverï¼‰åˆ™å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ã€‚\nWeb æœåŠ¡å™¨ Web å†…å®¹ å¯¹äº Web å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ï¼Œå†…å®¹ï¼ˆContentï¼‰æ˜¯ä¸æŸç§ MIMEï¼ˆMultipurpose Internet Mail Extensionsï¼‰ç±»å‹å…³è”çš„å­—èŠ‚åºåˆ—ï¼š\nWeb æœåŠ¡å™¨é€šè¿‡ä¸¤ç§ä¸åŒæ–¹å¼å‘å®¢æˆ·ç«¯æä¾›å†…å®¹ï¼š\nè·å–ç£ç›˜æ–‡ä»¶ï¼ˆé™æ€å†…å®¹ï¼‰å¹¶å°†å…¶è¿”å›ç»™å®¢æˆ·ç«¯ï¼› è¿è¡Œä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶å¹¶å°†å…¶è¾“å‡ºç»“æœï¼ˆåŠ¨æ€å†…å®¹ï¼‰è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ Web æœåŠ¡å™¨è¿”å›çš„æ¯æ¡å†…å®¹éƒ½ä¸å…¶ç®¡ç†çš„æŸä¸ªæ–‡ä»¶ç›¸å…³è”ï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„åç§°ï¼Œå³ URLï¼ˆUniversal Resource Locatorï¼‰ã€‚\nHTTP äº‹åŠ¡ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨telnetå‘½ä»¤ä¸äº’è”ç½‘ä¸Šä»»æ„ Web æœåŠ¡å™¨å»ºç«‹äº‹åŠ¡ï¼š\n","description":"","tags":["Network"],"title":"CSAPP è¯»ä¹¦ç¬”è®°ï¼šç½‘ç»œç¼–ç¨‹","uri":"/posts/network-programming-note/"},{"content":"è¾“å…¥/è¾“å‡º (I/O) æ˜¯åœ¨ä¸»å­˜å‚¨å™¨å’Œå¤–éƒ¨è®¾å¤‡ï¼ˆå¦‚ç£ç›˜é©±åŠ¨ã€ç»ˆç«¯å’Œç½‘ç»œç­‰ï¼‰ä¹‹é—´å¤åˆ¶æ•°æ®çš„è¿‡ç¨‹ã€‚è¾“å…¥æ“ä½œå°†æ•°æ®ä» I/O è®¾å¤‡å¤åˆ¶åˆ°ä¸»å­˜ï¼Œè¾“å‡ºæ“ä½œåˆ™å°†æ•°æ®ä»ä¸»å­˜å¤åˆ¶åˆ°è®¾å¤‡ã€‚\nUnix I/O Linux æ–‡ä»¶æ˜¯ç”± m ä¸ªå­—èŠ‚ç»„æˆçš„åºåˆ—ï¼š\n$$B_0, B_1, â€¦, B_k, â€¦, B_{m-1}$$\næ‰€æœ‰çš„ I/O è®¾å¤‡å‡è¢«å»ºæ¨¡ä¸ºæ–‡ä»¶ï¼Œè¾“å…¥å’Œè¾“å‡ºæ˜¯é€šè¿‡è¯»å†™å¯¹åº”çš„æ–‡ä»¶æ¥å®Œæˆçš„ã€‚Linux å†…æ ¸åŸºäºè¿™ç§è®¾å¤‡ä¸æ–‡ä»¶ä¹‹é—´çš„ä¼˜é›…æ˜ å°„ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªç®€å•è€Œä½çº§çš„åº”ç”¨ç¨‹åºæ¥å£ï¼Œå³ Unix I/Oï¼Œå®ƒä½¿å¾—æ‰€æœ‰çš„è¾“å…¥å’Œè¾“å‡ºéƒ½èƒ½ä»¥ä¸€è‡´çš„æ–¹å¼æ‰§è¡Œï¼š\næ‰“å¼€æ–‡ä»¶ï¼šåº”ç”¨ç¨‹åºé€šè¿‡å‘å†…æ ¸å‘èµ·æ‰“å¼€æ–‡ä»¶è¯·æ±‚ä»¥è®¿é—® I/O è®¾å¤‡ã€‚å†…æ ¸å°†è¿”å›ä¸€ä¸ªå°çš„éè´Ÿæ•´æ•°ï¼Œå³æ–‡ä»¶æè¿°ç¬¦ï¼ˆFile Descriptorï¼‰ï¼Œå®ƒå°†åœ¨å¯¹æ–‡ä»¶çš„åç»­æ“ä½œä¸­æ ‡è¯†è¯¥æ–‡ä»¶ã€‚å†…æ ¸è·Ÿè¸ªä¸æ‰“å¼€æ–‡ä»¶ç›¸å…³çš„æ‰€æœ‰ä¿¡æ¯ï¼Œè€Œåº”ç”¨ç¨‹åºåˆ™åªè·Ÿè¸ªæè¿°ç¬¦ã€‚æ¯ä¸ªç”± Linux Shell åˆ›å»ºçš„è¿›ç¨‹éƒ½ä¼šæ‰“å¼€ä¸‰ä¸ªæ–‡ä»¶ï¼šæ ‡å‡†è¾“å…¥ï¼ˆSTDIN_ FILENOï¼Œæè¿°ç¬¦ 0ï¼‰ã€æ ‡å‡†è¾“å‡ºï¼ˆSTDOUT_FILENOï¼Œæè¿°ç¬¦ 1ï¼‰å’Œæ ‡å‡†é”™è¯¯ï¼ˆSTDERR_FILENOï¼Œæè¿°ç¬¦ 2ï¼‰ï¼› æ”¹å˜å½“å‰æ–‡ä»¶ä½ç½®ï¼šå†…æ ¸ä¸ºæ¯ä¸ªæ‰“å¼€æ–‡ä»¶ç»´æŠ¤ä¸€ä¸ªæ–‡ä»¶ä½ç½®ï¼ˆFile Positionï¼‰kï¼Œåˆå§‹å€¼ä¸º 0ã€‚æ–‡ä»¶ä½ç½®æ˜¯æ–‡ä»¶ä¸­ä¸‹ä¸€ä¸ªå³å°†è¢«è¯»å–æˆ–å†™å…¥çš„å­—ç¬¦åˆ°æ–‡ä»¶èµ·å§‹ä½ç½®çš„å­—èŠ‚åç§»é‡ï¼Œå¹¶éæŒ‡è¯¥æ–‡ä»¶åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä½ç½®ã€‚åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡æ‰§è¡Œ Seek æ“ä½œæ¥æ˜¾å¼åœ°è®¾ç½®å½“å‰æ–‡ä»¶ä½ç½® kï¼› è¯»å†™æ–‡ä»¶ï¼šè¯»å–æ“ä½œä»å½“å‰æ–‡ä»¶ä½ç½® k å¼€å§‹ï¼Œå¤åˆ¶ n ä¸ªå­—èŠ‚åˆ°å†…å­˜ä¸­ï¼Œéšåä»¤ k å¢åŠ  nã€‚å½“æ–‡ä»¶ä½ç½®å¤§äºæˆ–ç­‰äºæ–‡ä»¶å¤§å°æ—¶ï¼Œè¯»å–æ“ä½œä¼šè§¦å‘ EOFï¼ˆEnd-of-Fileï¼‰ã€‚ç±»ä¼¼åœ°ï¼Œå†™å…¥æ“ä½œä»å½“å‰æ–‡ä»¶ä½ç½® k å¼€å§‹ï¼Œå¤åˆ¶ n ä¸ªå­—èŠ‚åˆ°æ–‡ä»¶ä¸­å¹¶æ›´æ–° k çš„å€¼ï¼› å…³é—­æ–‡ä»¶ï¼šå½“åº”ç”¨ç¨‹åºç»“æŸå¯¹æ–‡ä»¶çš„è®¿é—®æ—¶ï¼Œå®ƒä¼šå‘å†…æ ¸å‘èµ·å…³é—­æ–‡ä»¶è¯·æ±‚ï¼Œå†…æ ¸é‡Šæ”¾æ‰“å¼€æ–‡ä»¶æ—¶åˆ›å»ºçš„æ•°æ®ç»“æ„å¹¶å°†æè¿°ç¬¦æ”¾å›å¯ç”¨æè¿°ç¬¦æ± ã€‚è‹¥è¿›ç¨‹å› æŸäº›åŸå› ç»ˆæ­¢ï¼Œå†…æ ¸å°†å…³é—­æ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶å¹¶é‡Šæ”¾ç›¸åº”çš„å†…å­˜èµ„æºã€‚ æ–‡ä»¶ æ¯ä¸ª Linux æ–‡ä»¶éƒ½æœ‰ä¸€ä¸ªè¡¨å¾å…¶åœ¨ç³»ç»Ÿä¸­è§’è‰²çš„ç±»å‹ï¼š\nå¸¸è§„æ–‡ä»¶ï¼ˆRegular Fileï¼‰ï¼šå¯¹äºåº”ç”¨ç¨‹åºæ¥è¯´ï¼Œå¸¸è§„æ–‡ä»¶åˆ†ä¸ºä»…åŒ…å« ASCII æˆ– Unicode å­—ç¬¦çš„æ–‡æœ¬æ–‡ä»¶ï¼ˆText Fileï¼‰å’ŒäºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆBinary Fileï¼‰ï¼›ä½†å¯¹äºå†…æ ¸è€Œè¨€ï¼Œä¸¤è€…æ²¡æœ‰åŒºåˆ«ã€‚Linux æ–‡æœ¬æ–‡ä»¶ç”±ä¸€ç³»åˆ—æ–‡æœ¬è¡Œï¼ˆText Lineï¼‰ç»„æˆï¼Œå…¶ä¸­æ¯ä¸€è¡Œéƒ½ä»¥æ¢è¡Œç¬¦\\nç»“å°¾ï¼› ç›®å½•ï¼ˆDirectoryï¼‰ï¼šç›®å½•æ˜¯ç”±é“¾æ¥ï¼ˆLinkï¼‰æ•°ç»„æ„æˆçš„æ–‡ä»¶ã€‚é“¾æ¥å°†ä¸€ä¸ªæ–‡ä»¶åæ˜ å°„åˆ°ä¸€ä¸ªæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å¯èƒ½æ˜¯å¦ä¸€ä¸ªç›®å½•ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ã€‚æ¯ä¸ªç›®å½•ä¸­è‡³å°‘åŒ…å«ä¸¤ä¸ªé“¾æ¥ï¼š.æŒ‡å‘ç›®å½•æœ¬èº«ï¼Œè€Œ..æŒ‡å‘ä¸Šçº§ç›®å½•ï¼› Socketï¼šç”¨äºé€šè¿‡ç½‘ç»œä¸å¦ä¸€ä¸ªè¿›ç¨‹é€šä¿¡çš„æ–‡ä»¶ã€‚ æ‰“å¼€å’Œå…³é—­æ–‡ä»¶ è¿›ç¨‹å¯ä»¥è°ƒç”¨å‡½æ•°openæ¥æ‰“å¼€ä¸€ä¸ªå·²å­˜åœ¨çš„æ–‡ä»¶æˆ–åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ï¼š\n1 2 3 4 5 #include \u003csys/types.h\u003e #include \u003csys/stat.h\u003e #include \u003cfcntl.h\u003e int open(char *filename, int flags, mode_t mode); // Returns: new file descriptor if OK, âˆ’1 on error è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦æ˜¯è¿›ç¨‹å½“å‰æœªæ‰“å¼€çš„æœ€å°æè¿°ç¬¦ã€‚å‚æ•°flagsæŒ‡ç¤ºè¿›ç¨‹å¦‚ä½•è®¿é—®æ–‡ä»¶ï¼š\nO_RDONLYï¼šåªè¯» O_WRONLYï¼šåªå†™ O_RDWRï¼šè¯»å†™ è¯¥å‚æ•°è¿˜å¯ä»¥ä¸ä¸€ä¸ªæˆ–å¤šä¸ªä½æ©ç è¿›è¡Œæˆ–ï¼ˆORï¼‰è¿ç®—ï¼Œè¿™äº›ä½æ©ç æä¾›å†™å…¥çš„é™„åŠ è¯´æ˜ï¼š\nO_CREATï¼šå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶ï¼› O_TRUNCï¼šå¦‚æœæ–‡ä»¶å·²ç»å­˜åœ¨ï¼Œåˆ™æ¸…ç©ºæ–‡ä»¶å†…å®¹ï¼› O_APPENDï¼šåœ¨æ¯æ¬¡å†™å…¥æ“ä½œä¹‹å‰ï¼Œå°†æ–‡ä»¶ä½ç½®è®¾ç½®ä¸ºæ–‡ä»¶æœ«å°¾ã€‚ è‹¥æ–‡ä»¶å·²å­˜åœ¨ï¼Œå‚æ•°modeåº”è®¾ä¸º 0ï¼›åä¹‹ï¼Œåˆ™è®¾ä¸ºæ–°æ–‡ä»¶çš„è®¿é—®æƒé™ä½ï¼Œå¯é€‰é¡¹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nä½œä¸ºè¿›ç¨‹ä¸Šä¸‹æ–‡çš„ä¸€éƒ¨åˆ†ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªé€šè¿‡umaskå‡½æ•°è®¾ç½®çš„umaskæ©ç ã€‚å½“è¿›ç¨‹è°ƒç”¨openå‡½æ•°åˆ›å»ºæ–°æ–‡ä»¶æ—¶ï¼Œæ–‡ä»¶çš„è®¿é—®æƒé™ä½ä¼šè¢«è®¾ç½®ä¸ºmode \u0026 ~umaskã€‚å¦‚ä¸‹ç¤ºä¾‹ç¨‹åºå°†åˆ›å»ºä¸€ä¸ªæ‰€æœ‰è€…æ‹¥æœ‰è¯»å†™æƒé™ã€å…¶ä»–ç”¨æˆ·éƒ½æœ‰è¯»å–æƒé™çš„æ–°æ–‡ä»¶ï¼š\n1 2 3 4 5 #define DEF_MODE S_IRUSR|S_IWUSR|S_IRGRP|S_IWGRP|S_IROTH|S_IWOTH #define DEF_UMASK S_IWGRP|S_IWOTH umask(DEF_UMASK); fd = Open(\"foo.txt\", O_CREAT|O_TRUNC|O_WRONLY, DEF_MODE); è¿›ç¨‹è°ƒç”¨closeå‡½æ•°æ¥å…³é—­ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶ï¼Œè‹¥æ–‡ä»¶æè¿°ç¬¦å·²å…³é—­å°†å¼•å‘é”™è¯¯ï¼š\n1 2 3 #include \u003cunistd.h\u003e int close(int fd); // Returns: 0 if OK, âˆ’1 on error è¯»å†™æ–‡ä»¶ åº”ç”¨ç¨‹åºè°ƒç”¨readå’Œwriteå‡½æ•°æ¥æ‰§è¡Œè¾“å…¥å’Œè¾“å‡ºï¼š\n1 2 3 4 5 #include \u003cunistd.h\u003e ssize_t read(int fd, void *buf, size_t n); // Returns: number of bytes read if OK, 0 on EOF, âˆ’1 on error ssize_t write(int fd, const void *buf, size_t n); // Returns: number of bytes written if OK, âˆ’1 on error readå‡½æ•°ä»å‚æ•°fdçš„å½“å‰æ–‡ä»¶ä½ç½®å¤åˆ¶æœ€å¤šnä¸ªå­—èŠ‚åˆ°å†…å­˜ä¸­bufæŒ‡å‘çš„ä½ç½®ï¼Œwriteå‡½æ•°åˆ™ä»å†…å­˜ä¸­bufæŒ‡å‘çš„ä½ç½®å¤åˆ¶æœ€å¤šnä¸ªå­—èŠ‚åˆ°å‚æ•°fdçš„å½“å‰ä½ç½®ã€‚ç¤ºä¾‹ç¨‹åºä½¿ç”¨ä¸Šè¿°ä¸¤ç§å‡½æ•°å°†æ ‡å‡†è¾“å…¥ä»¥å­—èŠ‚ä¸ºå•ä½å¤åˆ¶åˆ°æ ‡å‡†è¾“å‡ºï¼š\n1 2 3 4 5 6 7 8 9 #include \"csapp.h\" int main(void) { char c; while(Read(STDIN_FILENO, \u0026c, 1) != 0) Write(STDOUT_FILENO, \u0026c, 1); exit(0); } åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè¯»å†™æ“ä½œä¼ è¾“çš„å­—èŠ‚æ•°å°äºåº”ç”¨ç¨‹åºè¯·æ±‚çš„å­—èŠ‚æ•°ã€‚ä¸è¶³æ•°ï¼ˆShort Countï¼‰çš„äº§ç”Ÿå¹¶ä¸ä»£è¡¨å‘ç”Ÿäº†é”™è¯¯ï¼Œå®ƒå¯èƒ½ç”±å¤šç§åŸå› å¯¼è‡´ï¼š\nè¯»å–æ—¶é‡åˆ° EOFï¼šè‹¥æˆ‘ä»¬å¯¹ä¸€ä¸ª 20 å­—èŠ‚çš„æ–‡ä»¶æ‰§è¡Œread(fd, *buf, 50)ï¼Œé‚£ä¹ˆç¬¬ä¸€æ¬¡è°ƒç”¨å°†è¿”å›ä¸€ä¸ª 20 çš„ä¸è¶³æ•°ï¼Œç¬¬äºŒæ¬¡è°ƒç”¨åˆ™è¿”å› 0ï¼ˆEOFï¼‰ï¼› ä»ç»ˆç«¯è¯»å–æ–‡æœ¬è¡Œï¼šè‹¥æ‰“å¼€çš„æ–‡ä»¶æ˜¯ç»ˆç«¯è®¾å¤‡ï¼ˆå³é”®ç›˜å’Œæ˜¾ç¤ºå™¨ï¼‰ï¼Œé‚£ä¹ˆæ¯æ¬¡readè°ƒç”¨éƒ½å°†ä¼ è¾“ä¸€ä¸ªæ–‡æœ¬è¡Œå¹¶è¿”å›ä¸€ä¸ªä¸æ–‡æœ¬è¡Œå¤§å°ç›¸ç­‰çš„ä¸è¶³æ•°ï¼› è¯»å†™ Socketï¼šè‹¥æ‰“å¼€çš„æ–‡ä»¶æ˜¯ Socketï¼Œé‚£ä¹ˆå†…éƒ¨ç¼“å†²åŒºé™åˆ¶å’Œç½‘ç»œå»¶è¿Ÿå°†ä½¿è¯»å†™æ“ä½œè¿”å›ä¸è¶³æ•°ã€‚ å› æ­¤é™¤é‡åˆ° EOF å¤–ï¼Œè¯»å†™ç£ç›˜æ–‡ä»¶ä¸ä¼šå¯¼è‡´ä¸è¶³æ•°çš„äº§ç”Ÿã€‚ä½†å¦‚æœæˆ‘ä»¬æƒ³è¦æ„å»ºå¥å£®è€Œå¯é çš„ç½‘ç»œåº”ç”¨ç¨‹åºï¼Œå°±å¿…é¡»é‡å¤è°ƒç”¨readå’Œwriteä»¥ä¿è¯æ‰€æœ‰è¯·æ±‚çš„å­—èŠ‚å‡å·²è¢«ä¼ è¾“ã€‚\nä½¿ç”¨ $R_{IO}$ åŒ…å®ç°å¥å£®è¯»å†™ $R_{IO}$ åŒ…ä¸ºåº”ç”¨ç¨‹åºæä¾›äº†æ–¹ä¾¿ã€å¥å£®ä¸”é«˜æ•ˆçš„ I/Oï¼Œå¯ä»¥è§£å†³ç¼–å†™ç½‘ç»œç¨‹åºæ—¶é‡åˆ°çš„ä¸è¶³æ•°é—®é¢˜ï¼š\næ— ç¼“å†²çš„è¾“å…¥/è¾“å…¥å‡½æ•°ï¼šç›´æ¥åœ¨å†…å­˜å’Œæ–‡ä»¶ä¹‹é—´ä¼ è¾“æ•°æ®ï¼Œé€‚ç”¨äºä»ç½‘ç»œä¸­è¯»å†™äºŒè¿›åˆ¶æ•°æ®ï¼› æœ‰ç¼“å†²çš„è¾“å…¥å‡½æ•°ï¼šä»åº”ç”¨ç¨‹åºçº§åˆ«çš„ç¼“å†²åŒºä¸­è¯»å–æ–‡æœ¬è¡Œå’ŒäºŒè¿›åˆ¶æ•°æ®ï¼Œä¸æ ‡å‡† I/Oï¼ˆå¦‚printfï¼‰å‡½æ•°ç±»ä¼¼ã€‚è¯¥å‡½æ•°æ˜¯çº¿ç¨‹å®‰å…¨ï¼ˆThread-safeï¼‰çš„ï¼Œå¹¶ä¸”å¯ä»¥å¯¹åŒä¸€æè¿°ç¬¦ä»»æ„äº¤é”™ï¼ˆInterleaveï¼‰ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä»æè¿°ç¬¦ä¸­è¯»å–ä¸€äº›æ–‡æœ¬è¡Œï¼Œç„¶åè¯»å–ä¸€äº›äºŒè¿›åˆ¶æ•°æ®ï¼Œæœ€åå†è¯»å–ä¸€äº›æ–‡æœ¬è¡Œã€‚ æ— ç¼“å†²çš„è¾“å…¥/è¾“å…¥å‡½æ•° 1 2 3 4 #include \"csapp.h\" ssize_t rio_readn(int fd, void *usrbuf, size_t n); ssize_t rio_writen(int fd, void *usrbuf, size_t n); // Returns: number of bytes transferred if OK, 0 on EOF (rio_readn only), âˆ’1 on error rio_readnå‡½æ•°ä»å‚æ•°fdçš„å½“å‰æ–‡ä»¶ä½ç½®å¤åˆ¶æœ€å¤šnä¸ªå­—èŠ‚åˆ°å†…å­˜ä¸­usrbufæŒ‡å‘çš„ä½ç½®ï¼Œrio_writenå‡½æ•°åˆ™ä»å†…å­˜ä¸­usrbufæŒ‡å‘çš„ä½ç½®å¤åˆ¶æœ€å¤šnä¸ªå­—èŠ‚åˆ°å‚æ•°fdçš„å½“å‰ä½ç½®ã€‚å‰è€…åªæœ‰åœ¨é‡åˆ° EOF æ—¶è¿”å›ä¸è¶³æ•°ï¼Œåè€…åˆ™ä»ä¸è¿”å›ä¸è¶³æ•°ã€‚\nè‹¥ä¸Šè¿°å‡½æ•°è¢«åº”ç”¨ç¨‹åºçš„ä¿¡å·å¤„ç†ç¨‹åºçš„è¿”å›ä¸­æ–­ï¼Œå®ƒä»¬ä¼šé‡æ–°è°ƒç”¨readå’Œwriteå‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 ssize_t rio_readn(int fd, void *usrbuf, size_t n) { size_t nleft = n; ssize_t nread; char *bufp = usrbuf; while (nleft \u003e 0) { if ((nread = read(fd, bufp, nleft)) \u003c 0) { if (errno == EINTR) /* Interrupted by sig handler return */ nread = 0; /* and call read() again */ else return -1; /* errno set by read() */ } else if (nread == 0) break; /* EOF */ nleft -= nread; bufp += nread; } return (n - nleft); /* Return \u003e= 0 */ } ssize_t rio_writen(int fd, void *usrbuf, size_t n) { size_t nleft = n; ssize_t nwritten; char *bufp = usrbuf; while (nleft \u003e 0) { if ((nwritten = read(fd, bufp, nleft)) \u003c 0) { if (errno == EINTR) /* Interrupted by sig handler return */ nwritten = 0; /* and call write() again */ else return -1; /* errno set by write() */ } nleft -= nwritten; bufp += nwritten; } return n; } æœ‰ç¼“å†²çš„è¾“å…¥å‡½æ•° å‡è®¾æˆ‘ä»¬éœ€è¦ç¼–å†™ä¸€ä¸ªè®¡ç®—æ–‡æœ¬æ–‡ä»¶è¡Œæ•°çš„ç¨‹åºï¼Œæœ€ç®€å•çš„æ–¹æ³•ä¾¿æ˜¯è°ƒç”¨readå‡½æ•°æ¯æ¬¡è¯»å–ä¸€ä¸ªå­—èŠ‚å¹¶æ£€æŸ¥æ˜¯å¦æœ‰æ¢è¡Œç¬¦ã€‚ä½†ç”±äºreadæ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œé¢‘ç¹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å°†å¯¼è‡´ç¨‹åºæ•ˆç‡ä½ä¸‹ã€‚\næ›´å¥½çš„æ–¹æ³•æ˜¯è°ƒç”¨åŒ…è£…å‡½æ•°rio_readlinebä»å†…éƒ¨è¯»å–ç¼“å†²åŒºï¼ˆRead Bufferï¼‰å¤åˆ¶æ–‡æœ¬è¡Œï¼Œåªæœ‰å½“ç¼“å†²åŒºä¸ºç©ºæ—¶æ‰è°ƒç”¨readä»¥é‡æ–°å¡«å……ç¼“å†²åŒºã€‚$R_{IO}$ åŒ…è¿˜ä¸ºåŒæ—¶åŒ…å«æ–‡æœ¬è¡Œå’ŒäºŒè¿›åˆ¶æ•°æ®çš„æ–‡ä»¶ï¼ˆå¦‚ HTTP å“åº”ï¼‰æä¾›äº†rio_readnå‡½æ•°çš„æœ‰ç¼“å†²ç‰ˆæœ¬ï¼Œå³rio_readnbï¼š\n1 2 3 4 #include \"csapp.h\" ssize_t rio_readlineb(rio_t *rp, void *usrbuf, size_t maxlen); ssize_t rio_readnb(rio_t *rp, void *usrbuf, size_t n); // Returns: number of bytes read if OK, 0 on EOF, âˆ’1 on error åœ¨è°ƒç”¨ä¸Šè¿°ä¸¤ç§æœ‰ç¼“å†²çš„è¾“å…¥å‡½æ•°å‰ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæ¯ä¸ªæ‰“å¼€æ–‡ä»¶æè¿°ç¬¦è°ƒç”¨ä¸€æ¬¡rio_readinitbã€‚è¯¥å‡½æ•°å°†æè¿°ç¬¦fdä¸åœ°å€rpå¤„çš„è¯»å–ç¼“å†²åŒºï¼ˆç±»å‹ä¸ºrio_tï¼‰ç›¸å…³è”ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 #define RIO_BUFSIZE 8192 typedef struct { int rio_fd; /* Descriptor for this internal buf */ int rio_cnt; /* Unread bytes in internal buf */ char *rio_bufptr; /* Next unread byte in internal buf */ char rio_buf[RIO_BUFSIZE]; /* Internal buffer */ } rio_t; void rio_readinitb(rio_t *rp, int fd) { rp-\u003erio_fd = fd; rp-\u003erio_cnt = 0; rp-\u003erio_bufptr = rp-\u003erio_buf; } $R_{IO}$ åŒ…è¯»å–ä¾‹ç¨‹çš„æ ¸å¿ƒæ˜¯rio_readå‡½æ•°ï¼Œå®ƒå…¶å®æ˜¯readå‡½æ•°çš„æœ‰ç¼“å†²ç‰ˆæœ¬ã€‚è‹¥è¯»å–ç¼“å†²åŒºä¸­çš„æœªè¯»å­—èŠ‚æ•°rp-\u003erio_cntä¸º 0ï¼Œåˆ™åœ¨å¾ªç¯å†…è°ƒç”¨readå‡½æ•°å¯¹å…¶å¡«å……ï¼›è‹¥è¯»å–ç¼“å†²åŒºéç©ºï¼Œåˆ™è°ƒç”¨memcpyå‡½æ•°å°†min(n, rp-\u003erio_cnt)å­—èŠ‚ä»ç¼“å†²åŒºå¤åˆ¶åˆ°usrbufæŒ‡å‘çš„å†…å­˜ä½ç½®ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 static ssize_t rio_read(rio_t *rp, char *usrbuf, size_t n) { int cnt; while (rp-\u003erio_cnt \u003c= 0) { /* Refill if buf is empty */ rp-\u003erio_cnt = read(rp-\u003erio_fd, rp-\u003erio_buf, sizeof(rp-\u003erio_buf)); if (rp-\u003erio_cnt \u003c 0) { if (errno != EINTR) /* Interrupted by sig handler return */ return -1; } else if (rp-\u003erio_cnt == 0) /* EOF */ return 0; else rp-\u003erio_bufptr = rp-\u003erio_buf; /* Reset buffer ptr */ } /* Copy min(n, rp-\u003erio_cnt) bytes from internal buf to user buf */ cnt = n; if (rp-\u003erio_cnt \u003c n) cnt = rp-\u003erio_cnt; memcpy(usrbuf, rp-\u003erio_bufptr, cnt); rp-\u003erio_bufptr += cnt; rp-\u003erio_cnt -= cnt; return cnt; } åœ¨åº”ç”¨ç¨‹åºçœ‹æ¥ï¼Œrio_readå‡½æ•°ä¸readå‡½æ•°å…·æœ‰ç›¸åŒçš„è¯­ä¹‰ï¼šæ‰§è¡Œå‘ç”Ÿé”™è¯¯æ—¶ï¼Œå®ƒè¿”å› -1 å¹¶è®¾ç½® errnoï¼›æ‰§è¡Œé‡åˆ° EOF æ—¶ï¼Œå®ƒè¿”å› 0ï¼›å½“è¯·æ±‚çš„å­—èŠ‚æ•°å¤§äºè¯»å–ç¼“å†²åŒºä¸­çš„æœªè¯»å­—èŠ‚æ•°æ—¶ï¼Œå®ƒè¿”å›ä¸€ä¸ªä¸è¶³æ•°ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡å°†readæ›¿æ¢ä¸ºrio_readæ¥æ„å»ºä¸åŒç±»å‹çš„æœ‰ç¼“å†²è¯»å–å‡½æ•°ã€‚\nå®é™…ä¸Šï¼Œrio_readnbä¸rio_readnå…·æœ‰å®Œå…¨ç›¸åŒçš„ç»“æ„ï¼Œåªä¸è¿‡æˆ‘ä»¬ç”¨rio_readæ›¿æ¢äº†readï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 ssize_t rio_readnb(rio_t *rp, void *usrbuf, size_t n) { size_t nleft = n; ssize_t nread; char *bufp = usrbuf; while (nleft \u003e 0) { if ((nread = rio_read(rp, bufp, nleft)) \u003c 0) return -1; /* errno set by read() */ else if (nread == 0) break; /* EOF */ nleft -= nread; bufp += nread; } return (n - nleft); /* return \u003e= 0 */ } ç±»ä¼¼åœ°ï¼Œrio_readlinebå‡½æ•°ä»æ–‡ä»¶rpä¸­è¯»å–ä¸€ä¸ªæ–‡æœ¬è¡Œå¹¶å°†å…¶å¤åˆ¶åˆ°å†…å­˜ä¸­usrbufæŒ‡å‘çš„ä½ç½®ã€‚å¾ªç¯å†…æ¯æ¬¡å¯¹rio_readçš„è°ƒç”¨éƒ½ä¼šæŠŠè¯»å–ç¼“å†²åŒºä¸­çš„ä¸€ä¸ªå­—èŠ‚å¤åˆ¶åˆ°\u0026cï¼Œç„¶åæ£€æŸ¥å®ƒæ˜¯å¦æ˜¯æ¢è¡Œç¬¦ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 ssize_t rio_readlineb(rio_t *rp, void *usrbuf, size_t maxlen) { int n, rc; char c, *bufp = usrbuf; for (n = 1; n \u003c maxlen; n++) { if ((rc = rio_read(rp, \u0026c, 1)) == 1) { *bufp++ = c; /* Copy rp to user buf */ if (c == '\\n') { n++; break; } } else if (rc == 0) { if (n == 1) return 0; /* EOF, no data read */ else break; /* EOF, some data was read */ } else return -1; /* Error */ } *bufp = 0; return n - 1; } è¯»å–æ–‡ä»¶å…ƒæ•°æ® åº”ç”¨ç¨‹åºè°ƒç”¨statå’Œfstatå‡½æ•°è·å–ä¸€ä¸ªæ–‡ä»¶çš„å…ƒæ•°æ®ï¼š\n1 2 3 4 5 #include \u003cunistd.h\u003e #include \u003csys/stat.h\u003e int stat(const char *filename, struct stat *buf); int fstat(int fd, struct stat *buf); // Returns: 0 if OK, âˆ’1 on error å‡½æ•°statä½¿ç”¨æ–‡ä»¶å*filenameä½œä¸ºè¾“å…¥ï¼Œå°†ä¿¡æ¯å¡«å†™åˆ°statç»“æ„ä½“ä¸­ã€‚fstatä¸ä¹‹ç±»ä¼¼ï¼Œä½†å®ƒçš„å‚æ•°æ˜¯æ–‡ä»¶æè¿°ç¬¦fdã€‚ç»“æ„ä½“statå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬åªéœ€å…³æ³¨å­—æ®µst_modeå’Œst_sizeï¼š\nst_sizeåŒ…å«äº†æ–‡ä»¶çš„å¤§å°ï¼Œè€Œst_modeåˆ™åŒ…å«äº†æ–‡ä»¶çš„è®¿é—®æƒé™å’Œç±»å‹ã€‚\nè¯»å–ç›®å½•å†…å®¹ åº”ç”¨ç¨‹åºè°ƒç”¨opendirå’Œreaddirå‡½æ•°è¯»å–ç›®å½•ä¸­çš„å†…å®¹ï¼š\n1 2 3 4 5 6 7 #include \u003csys/types.h\u003e #include \u003cdirent.h\u003e DIR *opendir(const char *name); // Returns: pointer to handle if OK, NULL on error #include \u003cdirent.h\u003e struct dirent *readdir(DIR *dirp); // Returns: pointer to next directory entry if OK, NULL if no more entries or error å‡½æ•°opendirä»¥ç›®å½•çš„è·¯å¾„åä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªæŒ‡å‘ç›®å½•æµï¼ˆDirectory Streamï¼‰çš„æŒ‡é’ˆã€‚æµæ˜¯å¯¹æœ‰åºé¡¹ç›®åˆ—è¡¨çš„æŠ½è±¡ï¼Œæ­¤å¤„æŒ‡çš„æ˜¯ç›®å½•ä¸­æ¡ç›®çš„åˆ—è¡¨ã€‚å‡½æ•°readdirè¿”å›æŒ‡å‘ç›®å½•æµä¸­ä¸‹ä¸€ä¸ªæ¡ç›®çš„æŒ‡é’ˆï¼Œæ¯ä¸ªæ¡ç›®éƒ½æ˜¯ä¸€ä¸ªdirentç»“æ„ä½“ï¼š\n1 2 3 4 struct dirent { ino_t d_ino; /* inode number */ char d_name[256]; /* Filename */ }; d_nameæ˜¯æ–‡ä»¶åï¼Œd_inoæ˜¯æ–‡ä»¶çš„ inode æ•°ã€‚å½“å‘ç”Ÿé”™è¯¯æ—¶ï¼Œreaddirè¿”å›NULLå¹¶è®¾ç½®errnoã€‚\nå‡½æ•°closedirå…³é—­ç›®å½•æµå¹¶é‡Šæ”¾æ‰€æœ‰ç›¸å…³èµ„æºï¼š\n1 2 3 #include \u003cdirent.h\u003e int closedir(DIR *dirp); // Returns: 0 on success, âˆ’1 on error å…±äº«æ–‡ä»¶ å†…æ ¸ä½¿ç”¨ä¸‰ç§æ•°æ®ç»“æ„æ¥è¡¨ç¤ºæ‰“å¼€çš„æ–‡ä»¶ï¼š\næè¿°ç¬¦è¡¨ï¼ˆDescriptor Tableï¼‰ï¼šæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„æè¿°ç¬¦è¡¨ï¼Œæ¯ä¸ªæ¡ç›®å‡æŒ‡å‘æ‰“å¼€æ–‡ä»¶è¡¨ä¸­çš„æ¡ç›®ï¼Œå…¶ç´¢å¼•æ˜¯è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ï¼› æ‰“å¼€æ–‡ä»¶è¡¨ï¼ˆOpen File Tableï¼‰ï¼šæ‰€æœ‰è¿›ç¨‹å…±äº«ä¸€ä¸ªæ‰“å¼€æ–‡ä»¶è¡¨ï¼Œå®ƒè¡¨ç¤ºäº†æ‰“å¼€æ–‡ä»¶çš„é›†åˆã€‚æ¯ä¸ªæ–‡ä»¶è¡¨æ¡ç›®ç”±å½“å‰æ–‡ä»¶ä½ç½®ï¼ˆä¸‹å›¾ä¸­çš„â€œFile posâ€ï¼‰ã€å½“å‰æŒ‡å‘å®ƒçš„æè¿°ç¬¦è¡¨æ¡ç›®æ•°é‡ï¼ˆä¸‹å›¾ä¸­çš„â€œrefcntâ€ï¼‰å’Œä¸€ä¸ªæŒ‡å‘ v-node è¡¨æ¡ç›®çš„æŒ‡é’ˆã€‚åªæœ‰å½“refcntä¸º 0 æ—¶ï¼Œå†…æ ¸æ‰ä¼šåˆ é™¤å¯¹åº”çš„æ–‡ä»¶è¡¨æ¡ç›®ï¼› v-node è¡¨ï¼ˆV-node Tableï¼‰ï¼šä¸æ‰“å¼€æ–‡ä»¶è¡¨ä¸€æ ·ï¼Œv-node è¡¨ç”±æ‰€æœ‰è¿›ç¨‹å…±äº«ã€‚å…¶ä¸­çš„æ¯ä¸ªæ¡ç›®éƒ½åŒ…å«äº†statç»“æ„ä½“ä¸­çš„å¤§éƒ¨åˆ†ä¿¡æ¯ï¼Œå¦‚st_modeå’Œst_sizeç­‰ã€‚v-node ä¸ i-node çš„åŒºåˆ«è¯¦è§ï¼šInode vs Vnode Differenceã€‚ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæè¿°ç¬¦ 1 å’Œ 4 é€šè¿‡ä¸åŒçš„æ‰“å¼€æ–‡ä»¶è¡¨æ¡ç›®å¼•ç”¨ä¸åŒçš„æ–‡ä»¶ã€‚è¿™æ˜¯æœ€å…¸å‹çš„æƒ…å†µï¼Œæ–‡ä»¶å¹¶æœªå…±äº«ï¼Œæ¯ä¸ªæè¿°ç¬¦å¯¹åº”ä¸€ä¸ªä¸åŒçš„æ–‡ä»¶ã€‚\nå¤šä¸ªæè¿°ç¬¦ä¹Ÿå¯ä»¥é€šè¿‡ä¸åŒçš„æ‰“å¼€æ–‡ä»¶è¡¨æ¡ç›®å¼•ç”¨ç›¸åŒçš„æ–‡ä»¶ï¼Œä¾‹å¦‚å¯¹åŒä¸€æ–‡ä»¶å¤šæ¬¡è°ƒç”¨openå‡½æ•°ï¼š\næè¿°ç¬¦ 1 å’Œ 4 æŒ‡å‘ä¸åŒçš„æ‰“å¼€æ–‡ä»¶è¡¨æ¡ç›®ï¼Œå› æ­¤å…¶æ–‡ä»¶ä½ç½®ä¸åŒã€‚å‡è®¾æ–‡ä»¶foobar.txtä¸­åŒ…å« 6 ä¸ª ASCII å­—ç¬¦foobarï¼Œé‚£ä¹ˆå¦‚ä¸‹ç¤ºä¾‹ç¨‹åºçš„è¾“å‡ºç»“æœä¸ºfï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 #include \"csapp.h\" int main() { int fd1, fd2; char c; fd1 = Open(\"foobar.txt\", O_RDONLY, 0); fd2 = Open(\"foobar.txt\", O_RDONLY, 0); Read(fd1, \u0026c, 1); Read(fd2, \u0026c, 1); printf(\"c = %c\\n\", c); exit(0); } è‹¥çˆ¶è¿›ç¨‹æ‰“å¼€æ–‡ä»¶çš„æ•°æ®ç»“æ„å¦‚ä¸Šå›¾ 10.12 æ‰€ç¤ºï¼Œåˆ™çˆ¶è¿›ç¨‹è°ƒç”¨forkå‡½æ•°åæƒ…å†µå˜ä¸ºï¼š\nå­è¿›ç¨‹å¾—åˆ°çˆ¶è¿›ç¨‹çš„æè¿°ç¬¦è¡¨å‰¯æœ¬ï¼Œä¸¤è€…å…±äº«ç›¸åŒçš„æ‰“å¼€æ–‡ä»¶è¡¨å’Œæ–‡ä»¶ä½ç½®ï¼Œå› æ­¤å¦‚ä¸‹ç¤ºä¾‹ç¨‹åºçš„è¾“å‡ºç»“æœä¸ºoï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 #include \"csapp.h\" int main() { int fd; char c; fd = Open(\"foobar.txt\", O_RDONLY, 0); if (Fork() == 0) { Read(fd, \u0026c, 1); exit(0); } Wait(NULL); Read(fd, \u0026c, 1); printf(\"c = %c\\n\", c); exit(0); } I/O é‡å®šå‘ dup2å‡½æ•°å°†æè¿°ç¬¦è¡¨æ¡ç›®oldfdå¤åˆ¶åˆ°newfdå¹¶è¦†ç›–å…¶åŸå§‹å†…å®¹ã€‚å¦‚æœnewfdå·²ç»æ‰“å¼€ï¼Œåˆ™è¯¥å‡½æ•°åœ¨å¤åˆ¶oldfdä¹‹å‰ä¼šå…ˆå…³é—­newfdï¼š\n1 2 3 #include \u003cunistd.h\u003e int dup2(int oldfd, int newfd); // Returns: nonnegative descriptor if OK, âˆ’1 on error å‡è®¾æŸè¿›ç¨‹çš„æ‰“å¼€æ–‡ä»¶æ•°æ®ç»“æ„å¦‚ä¸Šå›¾ 10.12 æ‰€ç¤ºã€‚æè¿°ç¬¦ 1ï¼ˆæ ‡å‡†è¾“å‡ºï¼‰æŒ‡å‘æ–‡ä»¶ Aï¼ˆå¦‚ç»ˆç«¯ï¼‰ï¼Œæè¿°ç¬¦ 4 æŒ‡å‘æ–‡ä»¶ Bï¼ˆå¦‚ç£ç›˜ä¸Šçš„æ–‡ä»¶ï¼‰ï¼Œæ–‡ä»¶ A å’Œ B çš„refcntå‡ä¸º 1ã€‚é‚£ä¹ˆè¯¥è¿›ç¨‹è°ƒç”¨å‡½æ•°dup2(4, 1)åæƒ…å†µå˜ä¸ºï¼š\næ–‡ä»¶ A è¢«å…³é—­ï¼Œå†…æ ¸ä¼šåˆ é™¤å…¶æ‰“å¼€æ–‡ä»¶è¡¨å’Œ v-node è¡¨æ¡ç›®ã€‚ä¸¤ä¸ªæè¿°ç¬¦å‡æŒ‡å‘æ–‡ä»¶ Bï¼Œå…¶refcntå·²å¢åŠ ä¸º 2ã€‚ä»ç°åœ¨å¼€å§‹ï¼Œä»»ä½•å†™å…¥åˆ°æ ‡å‡†è¾“å‡ºçš„æ•°æ®éƒ½ä¼šè¢«é‡å®šå‘åˆ°æ–‡ä»¶ Bã€‚\næ ‡å‡† I/O C å®šä¹‰äº†ä¸€ç»„æ›´é«˜çº§åˆ«çš„è¾“å…¥å’Œè¾“å‡ºå‡½æ•°ï¼Œå³æ ‡å‡† I/O åº“ï¼Œå®ƒä¸ºç¨‹åºå‘˜æä¾›äº†æ¯” Unix I/O æ›´é«˜çº§åˆ«çš„æ›¿ä»£æ–¹æ¡ˆã€‚libcåº“æä¾›äº†ç”¨äºæ‰“å¼€å’Œå…³é—­æ–‡ä»¶ï¼ˆfopenå’Œfcloseï¼‰ã€è¯»å–å’Œå†™å…¥å­—èŠ‚ï¼ˆfreadå’Œfwriteï¼‰ã€è¯»å–å’Œå†™å…¥å­—ç¬¦ä¸²ï¼ˆfgetså’Œfputsï¼‰ä»¥åŠå¤æ‚çš„æ ¼å¼åŒ– I/Oï¼ˆscanfå’Œprintfï¼‰å‡½æ•°ã€‚\næ ‡å‡† I/O åº“å°†æ‰“å¼€çš„æ–‡ä»¶å»ºæ¨¡ä¸ºæµã€‚å¯¹äºç¨‹åºå‘˜æ¥è¯´ï¼Œæµæ˜¯æŒ‡å‘FILEç±»å‹ç»“æ„ä½“çš„æŒ‡é’ˆã€‚æ¯ä¸ª ANSI C ç¨‹åºéƒ½ä»¥ä¸‰ä¸ªæ‰“å¼€çš„â€‹â€‹æµstdinã€stdoutå’Œstderrå¼€å¤´ï¼Œåˆ†åˆ«ä¸æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯å¯¹åº”ï¼š\n1 2 3 4 #include \u003cstdio.h\u003e extern FILE *stdin; /* Standard input (descriptor 0) */ extern FILE *stdout; /* Standard output (descriptor 1) */ extern FILE *stderr; /* Standard error (descriptor 2) */ FILEç±»å‹çš„æµæ˜¯æ–‡ä»¶æè¿°ç¬¦å’Œæµç¼“å†²åŒºï¼ˆStream Bufferï¼‰çš„æŠ½è±¡ã€‚ä¸ $R_{io}$ è¯»å–ç¼“å†²åŒºç›¸åŒï¼Œæµç¼“å†²åŒºå¯ä»¥æœ€å¤§é™åº¦åœ°å‡å°‘æ˜‚è´µçš„ Linux I/O ç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°ã€‚\næˆ‘ä»¬åº”å½“ä½¿ç”¨å“ªç§ I/O å‡½æ•°ï¼Ÿ Unix I/Oã€æ ‡å‡† I/O å’Œ $R_{io}$ åŒ…å‡½æ•°ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\né‚£ä¹ˆæˆ‘ä»¬åº”å½“ä½¿ç”¨å“ªç§ I/O å‡½æ•°å‘¢ï¼Ÿä»¥ä¸‹æ˜¯ä¸€äº›å»ºè®®ï¼š\nå°½å¯èƒ½ä½¿ç”¨æ ‡å‡† I/O å‡½æ•°ï¼Œå®ƒä»¬æ˜¯åœ¨ç£ç›˜å’Œç»ˆç«¯ä¸Šæ‰§è¡Œ I/O æ“ä½œçš„æœ€ä½³é€‰æ‹©ï¼› ä¸è¦ä½¿ç”¨scanfæˆ–rio_readlinebå‡½æ•°è¯»å–äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå®ƒä»¬æ˜¯ä¸“é—¨ä¸ºè¯»å–æ–‡æœ¬æ–‡ä»¶è®¾è®¡çš„ï¼› å°†æ ‡å‡† I/O å‡½æ•°ç”¨äº Socket æ—¶å¯èƒ½ä¼šå‡ºç°ä¸€äº›ä»¤äººè®¨åŒçš„é—®é¢˜ï¼Œå› æ­¤æˆ‘ä»¬åº”å½“åœ¨ç½‘ç»œç¼–ç¨‹æ—¶ä½¿ç”¨ $R_{io}$ åŒ…å‡½æ•°ã€‚ ","description":"","tags":["OS"],"title":"CSAPP è¯»ä¹¦ç¬”è®°ï¼šç³»ç»Ÿçº§ I/O","uri":"/posts/system-level-io-note/"},{"content":"ä¸ºäº†æ›´åŠ æœ‰æ•ˆåœ°ç®¡ç†å†…å­˜å¹¶å‡å°‘é”™è¯¯çš„å‘ç”Ÿï¼Œç°ä»£ç³»ç»Ÿæä¾›äº†ä¸€ç§å¯¹ä¸»å­˜å‚¨å™¨çš„æŠ½è±¡ï¼Œå³è™šæ‹Ÿå†…å­˜ï¼ˆVirtual Memoryï¼ŒVMï¼‰ã€‚è™šæ‹Ÿå†…å­˜æ˜¯ç¡¬ä»¶å¼‚å¸¸ã€ç¡¬ä»¶åœ°å€è½¬æ¢ã€ä¸»å­˜å‚¨å™¨ã€ç£ç›˜æ–‡ä»¶å’Œå†…æ ¸è½¯ä»¶ä¹‹é—´çš„ä¼˜é›…äº¤äº’ï¼Œå®ƒä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›äº†ä¸€ä¸ªå¤§çš„ã€ç»Ÿä¸€çš„å’Œç§æœ‰çš„åœ°å€ç©ºé—´ã€‚\nè™šæ‹Ÿå†…å­˜æœ‰ä»¥ä¸‹ä¸‰ä¸ªé‡è¦åŠŸèƒ½ï¼š\nå°†ä¸»å­˜å‚¨å™¨ä½œä¸ºç£ç›˜çš„ç¼“å­˜ï¼Œåªä¿ç•™ä¸»å­˜ä¸­çš„æ´»è·ƒåŒºåŸŸå¹¶æ ¹æ®éœ€è¦ä¸æ–­åœ°åœ¨ä¸¤è€…ä¹‹é—´ä¼ è¾“æ•°æ®ï¼› ä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›ç»Ÿä¸€çš„åœ°å€ç©ºé—´ï¼Œä»è€Œç®€åŒ–å†…å­˜ç®¡ç†ï¼› ä¿æŠ¤æ¯ä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸è¢«å…¶ä»–è¿›ç¨‹æ‰€ç ´åã€‚ ç‰©ç†å¯»å€ä¸è™šæ‹Ÿå¯»å€ ä¸»å­˜ä¸­çš„æ¯ä¸ªå­—èŠ‚éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ç‰©ç†åœ°å€ï¼ˆPhysical Addressï¼ŒPAï¼‰ï¼ŒCPU ä½¿ç”¨ç‰©ç†åœ°å€è®¿é—®å†…å­˜çš„æ–¹å¼è¢«ç§°ä¸ºç‰©ç†å¯»å€ï¼ˆPhysical Addressingï¼‰ï¼š\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒCPU ç”Ÿæˆäº†ä¸€ä¸ªæœ‰æ•ˆçš„ç‰©ç†åœ°å€å¹¶é€šè¿‡å­˜å‚¨å™¨æ€»çº¿ä¼ é€’ç»™ä¸»å­˜å‚¨å™¨ï¼Œè¯¦è§ è®¿é—®ä¸»å­˜å‚¨å™¨ã€‚\nCPU ä¹Ÿå¯ä»¥é€šè¿‡è™šæ‹Ÿåœ°å€ï¼ˆVirtual Addressï¼ŒVAï¼‰è®¿é—®ä¸»å­˜ï¼Œåªä¸è¿‡è¯¥åœ°å€åœ¨å‘é€åˆ°ä¸»å­˜ä¹‹å‰éœ€è¦è¢«è½¬æ¢ä¸ºé€‚å½“çš„ç‰©ç†åœ°å€ã€‚è¿™ç§å¯»å€æ–¹å¼è¢«ç§°ä¸ºè™šæ‹Ÿå¯»å€ï¼ˆVirtual Addressingï¼‰ï¼š\nåœ°å€è½¬æ¢ï¼ˆAddress Translation ï¼‰éœ€è¦ CPU ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿä¹‹é—´å¯†åˆ‡åˆä½œï¼Œä½äº CPU èŠ¯ç‰‡ä¸Šçš„å†…å­˜ç®¡ç†å•å…ƒï¼ˆMemory Management Unitï¼ŒMMUï¼‰æ ¹æ® é¡µè¡¨ï¼ˆPage Table) åŠ¨æ€åœ°å°†è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€ã€‚é¡µè¡¨å­˜å‚¨åœ¨ä¸»å­˜ä¸­ï¼Œå…¶å†…å®¹ç”±æ“ä½œç³»ç»Ÿç»´æŠ¤ã€‚\nåœ°å€ç©ºé—´ åœ°å€ç©ºé—´ï¼ˆAddress Spaceï¼‰æ˜¯ä¸€ç»„æœ‰åºçš„éè´Ÿæ•´æ•°åœ°å€ï¼š\n$$\\lbrace0, 1, 2, . . .\\rbrace$$\nå¦‚æœè¿™äº›æ•´æ•°æ˜¯è¿ç»­çš„ï¼Œæˆ‘ä»¬å°±ç§°å…¶ä¸ºçº¿æ€§åœ°å€ç©ºé—´ï¼ˆLinear Address Spaceï¼‰ã€‚åœ¨æ‹¥æœ‰è™šæ‹Ÿå†…å­˜çš„ç³»ç»Ÿä¸­ï¼ŒCPU ä» n ä½çº¿æ€§åœ°å€ç©ºé—´ä¸­ç”Ÿæˆè™šæ‹Ÿåœ°å€ï¼Œè¯¥è™šæ‹Ÿåœ°å€ç©ºé—´å…±æœ‰ N = $2^n$ ä¸ªåœ°å€ï¼š\n$$\\lbrace0,1,2,â€¦,N -1\\rbrace$$\nç°ä»£ç³»ç»Ÿé€šå¸¸æ”¯æŒ 32 ä½æˆ– 64 ä½è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚åŒæ ·åœ°ï¼Œç³»ç»Ÿä¹Ÿæœ‰ä¸€ä¸ªç‰©ç†åœ°å€ç©ºé—´ï¼š\n$$\\lbrace0,1,2,â€¦,M -1\\rbrace$$\nä¸è™šæ‹Ÿåœ°å€ç©ºé—´ä¸åŒï¼ŒM ä¸ä¸€å®šä¸º 2 çš„å¹‚ã€‚ä½†ä¸ºäº†ç®€åŒ–è®¨è®ºï¼Œæˆ‘ä»¬å‡è®¾ M = $2^m$ã€‚\nåœ°å€ç©ºé—´æ˜ç¡®åœ°å°†æ•°æ®å¯¹è±¡ï¼ˆå­—èŠ‚ï¼‰å’Œå…¶å±æ€§ï¼ˆåœ°å€ï¼‰åŒºåˆ†å¼€æ¥ï¼Œå› æ­¤æ¯ä¸ªæ•°æ®å¯¹è±¡éƒ½å¯ä»¥æœ‰å¤šä¸ªç‹¬ç«‹çš„åœ°å€ï¼Œè¿™ä¾¿æ˜¯è™šæ‹Ÿå†…å­˜çš„åŸºæœ¬æ€æƒ³ã€‚ä¸»å­˜ä¸­çš„æ¯ä¸ªå­—èŠ‚éƒ½æœ‰ä¸€ä¸ªä»ç‰©ç†åœ°å€ç©ºé—´ä¸­é€‰æ‹©çš„ç‰©ç†åœ°å€ï¼Œä»¥åŠä¸€ä¸ªä»è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­é€‰æ‹©çš„è™šæ‹Ÿåœ°å€ã€‚\nè™šæ‹Ÿå†…å­˜ä½œä¸ºç¼“å­˜çš„å·¥å…· ä¸å­˜å‚¨å±‚çº§ç»“æ„ä¸­çš„å…¶ä»–ç¼“å­˜ä¸€æ ·ï¼Œç£ç›˜ä¸ä¸»å­˜ä¹‹é—´ä»¥ Block ä¸ºå•ä½ä¼ è¾“æ•°æ®ã€‚è€Œåœ¨è™šæ‹Ÿå†…å­˜ç³»ç»Ÿä¸­ï¼ŒBlock è¢«ç§°ä¸ºè™šæ‹Ÿé¡µé¢ï¼ˆVirtual Pageï¼ŒVPï¼‰ï¼Œå…¶å¤§å°ä¸º P = $2^p$ã€‚ç±»ä¼¼åœ°ï¼Œç‰©ç†å†…å­˜ä¹Ÿå¯ä»¥è¢«åˆ’åˆ†ä¸ºå¤šä¸ªå¤§å°ä¸º P çš„ç‰©ç†é¡µé¢ï¼ˆPhysical Pageï¼ŒPP)ã€‚\nè™šæ‹Ÿé¡µé¢æœ‰ä»¥ä¸‹ä¸‰ç§çŠ¶æ€ï¼š\næœªåˆ†é…ï¼ˆUnallocatedï¼‰ï¼šæ²¡æœ‰è¢«è¿›ç¨‹ç”³è¯·ä½¿ç”¨çš„é¡µé¢ï¼Œä¸å ç”¨ä»»ä½•ç£ç›˜ç©ºé—´ï¼› æœªç¼“å­˜ï¼ˆUncachedï¼‰ï¼šä»…åŠ è½½åˆ°ç£ç›˜è€Œæœªç¼“å­˜åˆ°ä¸»å­˜ä¸­çš„é¡µé¢ï¼› å·²ç¼“å­˜ï¼ˆCachedï¼‰ï¼šå·²ç¼“å­˜åœ¨ä¸»å­˜ä¸­çš„é¡µé¢ã€‚ DRAM ç¼“å­˜ æˆ‘ä»¬å°† CPU å’Œä¸»å­˜ä¹‹é—´çš„ L1ã€L2 å’Œ L3 çº§ç¼“å­˜ç§°ä¸º SRAM ç¼“å­˜ï¼Œè€Œå°†ä¸»å­˜ä¸­ç”¨æ¥ç¼“å­˜è™šæ‹Ÿé¡µé¢çš„ç¼“å­˜ç§°ä¸º DRAM ç¼“å­˜ã€‚\nä¸ SRAM ç¼“å­˜ç›¸æ¯”ï¼ŒDRAM ç¼“å­˜å‘ç”Ÿç¼“å­˜ç¼ºå¤±çš„æˆæœ¬å¾ˆé«˜ï¼ˆéœ€è¦ä»ç£ç›˜ä¸­åŠ è½½æ•°æ®ï¼‰ï¼Œå› æ­¤è™šæ‹Ÿé¡µé¢å¾€å¾€æ¯”è¾ƒå¤§â€”â€”é€šå¸¸ä¸º 4 KB åˆ° 2 MBã€‚DRAM ç¼“å­˜æ˜¯ å…¨å…³è”å‹ çš„ï¼Œè¿™æ ·ä»»ä½•ä¸€ä¸ªè™šæ‹Ÿé¡µé¢éƒ½å¯ä»¥æ”¾åœ¨ä»»ä½•ä¸€ä¸ªç‰©ç†é¡µé¢ä¸­ã€‚\nDue to the large miss penalty, DRAM caches are fully associative; that is, any virtual page can be placed in any physical page.\né¡µè¡¨ é¡µè¡¨æ˜¯ç”±é¡µè¡¨æ¡ç›®ï¼ˆPage Table Entriesï¼ŒPTEsï¼‰ç»„æˆçš„æ•°ç»„ã€‚æ¯ä¸ªè™šæ‹Ÿé¡µé¢åœ¨é¡µè¡¨éƒ½æœ‰ä¸€æ¡ PTEï¼Œå®ƒåœ¨é¡µè¡¨ä¸­çš„åç§»é‡æ˜¯å›ºå®šçš„ã€‚æ¯æ¡ PTE ä¸­éƒ½åŒ…å«äº†ä¸€ä¸ªè¡¨ç¤ºè¯¥è™šæ‹Ÿé¡µé¢æ˜¯å¦å·²ç¼“å­˜çš„æœ‰æ•ˆä½ï¼Œä»¥åŠä¸€ä¸ª n ä½çš„åœ°å€å­—æ®µã€‚è‹¥æœ‰æ•ˆä½ä¸º 1ï¼Œåˆ™åœ°å€å­—æ®µæ˜¯ç¼“å­˜è¯¥é¡µé¢çš„ç‰©ç†é¡µé¢çš„èµ·å§‹åœ°å€ï¼›è‹¥æœ‰æ•ˆä½ä¸º 0 ä¸”åœ°å€å­—æ®µä¸ºç©ºï¼Œåˆ™ä»£è¡¨è¯¥è™šæ‹Ÿé¡µé¢æœªåˆ†é…ï¼›è‹¥æœ‰æ•ˆä½ä¸º 0 ä¸”åœ°å€å­—æ®µéç©ºï¼Œåˆ™åœ°å€å­—æ®µæ˜¯è¯¥é¡µé¢åœ¨ç£ç›˜ä¸Šçš„èµ·å§‹åœ°å€ã€‚\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç³»ç»Ÿä¸­å­˜åœ¨ 8 ä¸ªè™šæ‹Ÿé¡µé¢å’Œ 4 ä¸ªç‰©ç†é¡µé¢ï¼šé¡µé¢ 1ï¼Œ2ï¼Œ4 å’Œ 7 ç¼“å­˜åœ¨ DRAM ä¸­ï¼›é¡µé¢ 3 å’Œ 6 å·²åˆ†é…ä½†æœªç¼“å­˜ï¼›é¡µé¢ 0 å’Œ 5 æœªåˆ†é…ã€‚\nç¼ºé¡µæ•…éšœ æˆ‘ä»¬å°†è®¿é—® DRAM ç¼“å­˜æ—¶å‘ç”Ÿçš„ç¼“å­˜ç¼ºå¤±ç§°ä¸ºç¼ºé¡µæ•…éšœï¼ˆPage Faultï¼‰ã€‚è‹¥ CPU å¼•ç”¨ä¸Šå›¾é¡µé¢ 3 ä¸­çš„æŸä¸ªå­—ï¼Œåœ°å€è½¬æ¢ç¡¬ä»¶ä¼šä»ä¸»å­˜ä¸­è¯»å– PTE 3 ï¼Œç„¶åæ ¹æ®å…¶æœ‰æ•ˆä½åˆ¤æ–­å‡ºè¯¥é¡µé¢æœªç¼“å­˜ã€‚ç¼ºé¡µæ•…éšœå¼‚å¸¸å°†è°ƒç”¨å†…æ ¸ä¸­çš„å¼‚å¸¸å¤„ç†ç¨‹åºï¼Œé€‰æ‹©å—å®³è€…é¡µé¢ï¼ˆVictim Pageï¼‰é€å‡ºä¸»å­˜ã€‚\nåœ¨æœ¬ä¾‹ä¸­ï¼Œå—å®³è€…é¡µé¢ä¸º VP 4ï¼Œå› æ­¤å†…æ ¸ä¼šå…ˆå°† PTE 4 ä¸­çš„æœ‰æ•ˆä½é‡ç½®ä¸º 0ã€‚å¦‚æœè¯¥é¡µé¢å·²å‘ç”Ÿæ›´æ”¹ï¼Œå†…æ ¸è¿˜éœ€è¦å°†å…¶å¤åˆ¶å›ç£ç›˜ã€‚æ¥ä¸‹æ¥ï¼Œå†…æ ¸æŠŠ VP 3 ä»ç£ç›˜å¤åˆ¶åˆ°ä¸»å­˜ä¸­çš„ PP 3ï¼Œå¹¶æ›´æ–° PTE 3 ä¸­çš„æœ‰æ•ˆä½ã€‚ä¸‹å›¾å±•ç¤ºäº†å¼‚å¸¸å¤„ç†ç¨‹åºè¿”å›åç¤ºä¾‹é¡µè¡¨çš„çŠ¶æ€ï¼š\nä¸Šè¿°åœ¨ç£ç›˜å’Œä¸»å­˜ä¹‹é—´ä¼ è¾“é¡µé¢çš„æ´»åŠ¨è¢«ç§°ä¸ºäº¤æ¢ï¼ˆSwappingï¼‰æˆ–è€…åˆ†é¡µï¼ˆPagingï¼‰ã€‚é¡µé¢ä»ç£ç›˜ä¼ è¾“åˆ°ä¸»å­˜è¢«ç§°ä¸ºæ¢å…¥ï¼ˆSwapping In æˆ– Paging Inï¼‰ï¼Œåä¹‹åˆ™ä¸ºæ¢å‡ºï¼ˆSwapping Out æˆ– Paging Outï¼‰ã€‚å°½ç®¡æˆ‘ä»¬å¯ä»¥è¯•å›¾é¢„æµ‹ç¼ºé¡µæ•…éšœå¹¶åœ¨å¼•ç”¨æœªç¼“å­˜çš„é¡µé¢å‰åˆ†é¡µï¼Œä½†ç°ä»£ç³»ç»Ÿå‡åœ¨å¼‚å¸¸å‘ç”Ÿååˆ†é¡µï¼Œå³æŒ‰éœ€åˆ†é¡µï¼ˆDemand Pagingï¼‰ã€‚\nåˆ†é…é¡µé¢ ä¸Šå›¾å±•ç¤ºäº†åˆ†é…ä¸€ä¸ªæ–°çš„è™šæ‹Ÿé¡µé¢ï¼ˆå¦‚è¿›ç¨‹è°ƒç”¨mallocï¼‰åé¡µè¡¨çš„å˜åŒ–ã€‚æ“ä½œç³»ç»Ÿå…ˆåœ¨ç£ç›˜ä¸Šå¼€è¾Ÿç©ºé—´ï¼Œç„¶åæ›´æ–° PTE 5 ä½¿ VP 5 æŒ‡å‘ç£ç›˜ä¸Šæ–°åˆ›å»ºçš„é¡µé¢ã€‚\nè™šæ‹Ÿå†…å­˜ä½œä¸ºå†…å­˜ç®¡ç†çš„å·¥å…· æ“ä½œç³»ç»Ÿä¸ºæ¯ä¸ªè¿›ç¨‹éƒ½ç»´æŠ¤äº†ä¸€ä¸ªå•ç‹¬çš„é¡µè¡¨ï¼Œå› æ­¤æ‰€æœ‰è¿›ç¨‹éƒ½æ‹¥æœ‰è‡ªå·±çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼š\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè¿›ç¨‹ i çš„é¡µè¡¨å°† VP 1 æ˜ å°„åˆ° PP 2ï¼Œå°† VP 2 æ˜ å°„åˆ° PP 7ï¼›è¿›ç¨‹ j çš„é¡µè¡¨å°† VP 1 æ˜ å°„åˆ° PP 7ï¼Œå°† VP 2 æ˜ å°„åˆ° PP 10ã€‚å¤šä¸ªè™šæ‹Ÿé¡µé¢å¯ä»¥æ˜ å°„åˆ°åŒä¸€ä¸ªå…±äº«ç‰©ç†é¡µé¢ã€‚è™šæ‹Ÿå†…å­˜ç³»ç»Ÿç®€åŒ–äº†é“¾æ¥ã€åŠ è½½ã€ä»£ç å’Œæ•°æ®çš„å…±äº«ä»¥åŠåº”ç”¨ç¨‹åºçš„å†…å­˜åˆ†é…ï¼š\nç®€åŒ–é“¾æ¥ï¼šç‹¬ç«‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´å…è®¸æ¯ä¸ªè¿›ç¨‹ä½¿ç”¨ç›¸åŒçš„ å†…å­˜ç»“æ„ï¼Œå› æ­¤é“¾æ¥å™¨æ— éœ€è€ƒè™‘å¯æ‰§è¡Œæ–‡ä»¶çš„ä»£ç å’Œæ•°æ®åœ¨ç‰©ç†å†…å­˜ä¸­çš„å®é™…ä½ç½®ã€‚è¿™ç§ç»Ÿä¸€æ€§æå¤§åœ°ç®€åŒ–äº†é“¾æ¥å™¨çš„è®¾è®¡å’Œå®ç°ï¼› ç®€åŒ–åŠ è½½ï¼šè‹¥è¦å°†ç›®æ ‡æ–‡ä»¶çš„ .text å’Œ .data æ®µåŠ è½½åˆ°ä¸€ä¸ªæ–°è¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸­ï¼ŒåŠ è½½å™¨åªéœ€ä¸ºå®ƒä»¬åˆ†é…è™šæ‹Ÿé¡µé¢ï¼Œç„¶åå°†å…¶æ ‡è®°ä¸ºæœªç¼“å­˜ï¼Œæœ€åå†å°†é¡µè¡¨æ¡ç›®æŒ‡å‘ç›®æ ‡æ–‡ä»¶ä¸­å¯¹åº”çš„ä½ç½®ã€‚å®é™…ä¸ŠåŠ è½½å™¨ä»æœªå°†ä»»ä½•æ•°æ®ä»ç£ç›˜å¤åˆ¶åˆ°ä¸»å­˜ä¸­ï¼Œä»£ç å’Œæ•°æ®åªæœ‰åœ¨è¢«ç¬¬ä¸€æ¬¡å¼•ç”¨æ—¶æ‰ä¼šæŒ‰éœ€åˆ†é¡µï¼› ç®€åŒ–å…±äº«ï¼šæ“ä½œç³»ç»Ÿå¯ä»¥å°†ä¸åŒè¿›ç¨‹ä¸­çš„ä¸åŒè™šæ‹Ÿé¡µé¢æ˜ å°„åˆ°ç›¸åŒçš„ç‰©ç†é¡µé¢ï¼Œä»è€Œå®ç°è¿›ç¨‹ä¹‹é—´ä»£ç å’Œæ•°æ®çš„å…±äº«ï¼› ç®€åŒ–å†…å­˜åˆ†é…ï¼šå½“åº”ç”¨ç¨‹åºç”³è¯·é¢å¤–çš„å†…å­˜æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šä¸ºå…¶åˆ†é…ä¸€å®šæ•°é‡çš„è¿ç»­è™šæ‹Ÿé¡µé¢ï¼Œç„¶åå°†å®ƒä»¬æ˜ å°„åˆ°ä»»æ„ä½ç½®çš„ç‰©ç†é¡µé¢ã€‚è¿™äº›ç‰©ç†é¡µé¢æ— éœ€è¿ç»­ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ç‰©ç†å†…å­˜ä¸­éšæœºåˆ†å¸ƒã€‚ è™šæ‹Ÿå†…å­˜ä½œä¸ºå†…å­˜ä¿æŠ¤çš„å·¥å…· æˆ‘ä»¬å¯ä»¥åœ¨ PTE ä¸­æ·»åŠ ä¸€äº›æƒé™ä½æ¥ç®¡ç†è¿›ç¨‹å¯¹é¡µé¢çš„è®¿é—®ï¼š\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒSUP è¡¨ç¤ºæ˜¯å¦åªæœ‰åœ¨å†…æ ¸æ€è¿è¡Œçš„è¿›ç¨‹æ‰èƒ½è®¿é—®è¯¥é¡µé¢ï¼ŒREAD å’Œ WRITE åˆ™åˆ†åˆ«è¡¨ç¤ºé¡µé¢æ˜¯å¦å¯è¯»å†™ã€‚ä¾‹å¦‚ï¼Œè¿›ç¨‹ i åœ¨ç”¨æˆ·æ€ä¸­è¿è¡Œï¼Œé‚£ä¹ˆå®ƒå¯ä»¥è¯»å– VP 0ï¼Œè¯»å–å’Œå†™å…¥ VP 1ï¼Œä½†æ— æ³•è®¿é—® VP 2ã€‚\nå¦‚æœæŸæ¡æŒ‡ä»¤è¿åäº†ä¸Šè¿°æƒé™ï¼ŒCPU å°±ä¼šè§¦å‘é€šç”¨ä¿æŠ¤æ•…éšœï¼Œå¹¶å°†æ§åˆ¶æƒè½¬ç§»åˆ°å†…æ ¸ä¸­çš„å¼‚å¸¸å¤„ç†ç¨‹åºã€‚è¯¥å¤„ç†ç¨‹åºä¼šå‘é—®é¢˜è¿›ç¨‹å‘é€ä¸€ä¸ª SIGSEGV ä¿¡å·ï¼ŒLinux Shell é€šå¸¸å°†æ­¤å¼‚å¸¸æŠ¥å‘Šä¸ºåˆ†æ®µæ•…éšœï¼ˆSegmentation Faultï¼‰ã€‚\nåœ°å€è½¬æ¢ CPU ä¸­çš„é¡µè¡¨åŸºå€å¯„å­˜å™¨ï¼ˆPage Table Base Register ï¼ŒPTBRï¼‰æŒ‡å‘å½“å‰é¡µè¡¨ï¼Œn ä½çš„è™šæ‹Ÿåœ°å€ç”± p ä½çš„è™šæ‹Ÿé¡µé¢åç§»é‡ï¼ˆVirtual Page Offsetï¼ŒVPOï¼‰å’Œ n-p ä½çš„è™šæ‹Ÿé¡µé¢ç¼–å·ï¼ˆVirtual Page Numberï¼ŒVPNï¼‰ç»„æˆã€‚MMU æ ¹æ® VPN çš„å€¼é€‰æ‹©å¯¹åº”çš„ PTEï¼Œå¦‚ VPN 0 é€‰æ‹© PTE 0ï¼ŒVPN 1 é€‰æ‹© PTE 1ã€‚ç”±äºç‰©ç†é¡µé¢å’Œè™šæ‹Ÿé¡µé¢çš„å¤§å°ç›¸åŒï¼ŒVPO ä¸ç‰©ç†é¡µé¢åç§»é‡ï¼ˆPhysical Page Offsetï¼ŒPPOï¼‰ä¹Ÿå°±ç›¸åŒï¼Œå› æ­¤é¡µè¡¨æ¡ç›®ä¸­çš„ç‰©ç†é¡µé¢ç¼–å·ï¼ˆPhysical Page Numberï¼ŒPPNï¼‰ä¸ VPO å…±åŒç»„æˆäº†è½¬æ¢åçš„ç‰©ç†åœ°å€ã€‚\nä¸Šå›¾å±•ç¤ºäº†é¡µé¢å‘½ä¸­æ—¶çš„ CPU ç¡¬ä»¶æ“ä½œæ­¥éª¤ï¼š\nå¤„ç†å™¨ç”Ÿæˆä¸€ä¸ªè™šæ‹Ÿåœ°å€ VA å¹¶å‘é€åˆ° MMUï¼› MMU ç”Ÿæˆ PTE åœ°å€ PTEA å¹¶å‘é«˜é€Ÿç¼“å­˜æˆ–ä¸»å­˜å‘èµ·è¯·æ±‚ï¼› é«˜é€Ÿç¼“å­˜æˆ–ä¸»å­˜å°† PTE è¿”å›ç»™ MMUï¼› MMU æ„é€ ç‰©ç†åœ°å€ PA å¹¶å°†å…¶å‘é€åˆ°é«˜é€Ÿç¼“å­˜æˆ–ä¸»å­˜ï¼› é«˜é€Ÿç¼“å­˜æˆ–ä¸»å­˜å°†è¯·æ±‚çš„æ•°æ®è¿”å›ç»™å¤„ç†å™¨ã€‚ ä¸Šå›¾å±•ç¤ºäº†ç¼ºé¡µæ•…éšœæ—¶çš„ CPU ç¡¬ä»¶æ“ä½œæ­¥éª¤ï¼š\nå¤„ç†å™¨ç”Ÿæˆä¸€ä¸ªè™šæ‹Ÿåœ°å€ VA å¹¶å‘é€åˆ° MMUï¼› MMU ç”Ÿæˆ PTE åœ°å€ PTEA å¹¶å‘é«˜é€Ÿç¼“å­˜æˆ–ä¸»å­˜å‘èµ·è¯·æ±‚ï¼› é«˜é€Ÿç¼“å­˜æˆ–ä¸»å­˜å°† PTE è¿”å›ç»™ MMUï¼› PTE ä¸­çš„æœ‰æ•ˆä½ä¸º 0ï¼Œå› æ­¤ MMU è§¦å‘å¼‚å¸¸å¹¶å°†æ§åˆ¶æƒè½¬ç§»ç»™å†…æ ¸ä¸­çš„å¼‚å¸¸å¤„ç†ç¨‹åºï¼› å¤„ç†ç¨‹åºä»ç‰©ç†å†…å­˜ä¸­é€‰å–å—å®³è€…é¡µé¢æ¢å‡ºã€‚è‹¥è¯¥é¡µé¢å·²è¢«ä¿®æ”¹ï¼Œåˆ™è¿˜è¦å°†å…¶å¤åˆ¶åˆ°ç£ç›˜ä¸­ï¼› å¤„ç†ç¨‹åºå°†æ–°é¡µé¢æ¢å…¥å¹¶æ›´æ–° PTEï¼› å¤„ç†ç¨‹åºè¿”å›åˆ°åŸæ¥çš„è¿›ç¨‹ï¼Œä¹‹å‰å¼•å‘ç¼ºé¡µæ•…éšœçš„æŒ‡ä»¤é‡æ–°æ‰§è¡Œã€‚æ­¤æ—¶è¿›ç¨‹è¯·æ±‚çš„é¡µé¢å·²ç¼“å­˜ï¼Œå› æ­¤ CPU éšåçš„æ“ä½œä¸é¡µé¢å‘½ä¸­æ—¶ç›¸åŒã€‚ é«˜é€Ÿç¼“å­˜ä¸è™šæ‹Ÿå†…å­˜ å¤§éƒ¨åˆ†åŒæ—¶ä½¿ç”¨è™šæ‹Ÿå†…å­˜å’Œé«˜é€Ÿç¼“å­˜ï¼ˆSRAM ç¼“å­˜ï¼‰çš„ç³»ç»Ÿå‡é‡‡ç”¨ç‰©ç†å¯»å€çš„æ–¹å¼è®¿é—®é«˜é€Ÿç¼“å­˜ã€‚ä¸‹å›¾å±•ç¤ºäº†ä¸¤è€…çš„é›†æˆæ–¹å¼ï¼š\nä½¿ç”¨ TLB åŠ é€Ÿåœ°å€è½¬æ¢ CPU æ¯æ¬¡ç”Ÿæˆè™šæ‹Ÿåœ°å€æ—¶ï¼ŒMMU éƒ½å¿…é¡»å¼•ç”¨ PTE æ‰èƒ½å®Œæˆåœ°å€è½¬æ¢ã€‚å¦‚æœ PTE ä½äºä¸»å­˜è€Œéé«˜é€Ÿç¼“å­˜ä¸­ï¼Œé‚£ä¹ˆåœ°å€è½¬æ¢çš„é€Ÿåº¦å°†å¤§å¤§ä¸‹é™ã€‚å¤§å¤šæ•°ç³»ç»Ÿçš„ MMU ä¸­åŒ…å«äº†ä¸€ä¸ªè¢«ç§°ä¸ºè½¬æ¢åå¤‡ç¼“å†²åŒºï¼ˆTranslation Lookaside Bufferï¼ŒTLBï¼‰çš„å°å‹ PTE ç¼“å­˜ï¼Œå…¶æ¯ä¸ªç¼“å­˜è¡Œä¸­éƒ½æœ‰ä¸€ä¸ªç”±å•æ¡ PTE ç»„æˆçš„ Blockã€‚ç”¨äº é›†åˆé€‰æ‹©å’Œè¡ŒåŒ¹é… çš„ Set Index å’Œ Tag æ˜¯ä»è™šæ‹Ÿåœ°å€çš„ VPN ä¸­æå–çš„ï¼š\nå¦‚æœ TLB æœ‰ T = $2^t$ ä¸ªé›†åˆï¼Œåˆ™ Set Indexï¼ˆTLBIï¼‰ç”± VPN ä¸­ t ä¸ªæœ€ä½ä½ç»„æˆï¼ŒTagï¼ˆTLBTï¼‰ç”± VPN ä¸­çš„å‰©ä½™é«˜ä½ç»„æˆã€‚\nä¸Šå›¾å±•ç¤ºäº† TLB å‘½ä¸­æ—¶çš„ CPU ç¡¬ä»¶æ“ä½œæ­¥éª¤ã€‚ç”±äºåœ°å€è½¬æ¢å‡åœ¨ CPU èŠ¯ç‰‡ä¸Šçš„ MMU ä¸­æ‰§è¡Œï¼Œå› æ­¤é€Ÿåº¦å¾ˆå¿«ï¼š\nCPU ç”Ÿæˆä¸€ä¸ªè™šæ‹Ÿåœ°å€ VAï¼› MMU å‘ TLB å‘é€ VPN ä»¥è¯·æ±‚ PTEï¼› TLB å°† PTE è¿”å›ç»™ MMUï¼› MMU å°†è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€ PA å¹¶å‘é€åˆ°é«˜é€Ÿç¼“å­˜æˆ–ä¸»å­˜ï¼› é«˜é€Ÿç¼“å­˜æˆ–ä¸»å­˜å°†è¯·æ±‚çš„æ•°æ®è¿”å›ç»™å¤„ç†å™¨ã€‚ ä¸Šå›¾å±•ç¤ºäº† TLB æœªå‘½ä¸­æ—¶çš„ CPU ç¡¬ä»¶æ“ä½œæ­¥éª¤ã€‚MMU å¿…é¡»ä»é«˜é€Ÿç¼“å­˜æˆ–ä¸»å­˜ä¸­è·å– PTE å¹¶å°†å…¶å­˜å‚¨åœ¨ TLB ä¸­ï¼Œè¿™å¯èƒ½ä¼šè¦†ç›–ç°æœ‰æ¡ç›®ã€‚\nå¤šçº§é¡µè¡¨ åœ¨ä¹‹å‰çš„è®¨è®ºä¸­ï¼Œæˆ‘ä»¬å‡è®¾ç³»ç»Ÿåªä½¿ç”¨å•çº§é¡µè¡¨è¿›è¡Œåœ°å€è½¬æ¢ã€‚ä½†å¦‚æœåœ°å€ç©ºé—´æœ‰ 32 ä½ï¼Œä¸€ä¸ªé¡µé¢ 4 KB å¹¶ä¸”ä¸€æ¡ PTE 4 å­—èŠ‚ã€‚é‚£ä¹ˆå³ä½¿åº”ç”¨ç¨‹åºåªå¼•ç”¨ä¸€å°éƒ¨åˆ†è™šæ‹Ÿå†…å­˜ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦ä¸€ä¸ª 4 MB çš„é¡µè¡¨å¸¸é©»åœ¨å†…å­˜ä¸­ï¼š\n$$n=32, P=4K=2^{12}, n(PTE)=2^{n-p}=2^{20}=1M$$\næˆ‘ä»¬å¯ä»¥é€šè¿‡å¯¹é¡µè¡¨åˆ†çº§æ¥å‹ç¼©é¡µè¡¨çš„å¤§å°ï¼š\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸€çº§é¡µè¡¨ä¸­æœ‰ 1024 æ¡ PTEï¼Œæ¯æ¡ PTE éƒ½æ˜ å°„åˆ°ä¸€ä¸ªåŒ…å« 1024 ä¸ªè¿ç»­è™šæ‹Ÿé¡µé¢çš„åœ°å€ç©ºé—´å—ã€‚æ¯ä¸ªåœ°å€ç©ºé—´å—çš„å¤§å°ä¸º 1024 * 4 KB = 4 MBï¼Œå› æ­¤ 1024 æ¡ PTE å°±å¯ä»¥è¦†ç›– 32 ä½ï¼ˆ4 MB * 1024 = 4 GB = $2^{32}$ Bï¼‰åœ°å€ç©ºé—´ã€‚\nå¦‚æœåœ°å€ç©ºé—´å—ä¸­çš„æ‰€æœ‰é¡µé¢å‡æœªåˆ†é…ï¼Œåˆ™ä¸€çº§é¡µè¡¨ä¸­å¯¹åº”çš„ PTE ä¸ºç©ºï¼ˆå¦‚ä¸Šå›¾ä¸­çš„ PTE 2ï½7ï¼‰ï¼›å¦‚æœåœ°å€ç©ºé—´å—ä¸­è‡³å°‘æœ‰ä¸€ä¸ªé¡µé¢å·²åˆ†é…ï¼Œé‚£ä¹ˆä¸€çº§é¡µè¡¨ä¸­å¯¹åº”çš„ PTE å°±æŒ‡å‘äºŒçº§é¡µè¡¨ä¸­è¯¥å—çš„èµ·å§‹ä½ç½®ï¼ˆå¦‚ä¸Šå›¾ä¸­çš„ PTE 0ï½1ï¼‰ã€‚äºŒçº§é¡µè¡¨ä¸­çš„æ¯æ¡ PTE éƒ½æ˜ å°„åˆ°ä¸€ä¸ª 4 KB çš„ç‰©ç†å†…å­˜é¡µï¼Œè¿™ä¸æˆ‘ä»¬ä¹‹å‰æŸ¥çœ‹çš„å•çº§é¡µè¡¨ç›¸åŒã€‚\nè‹¥ä¸€çº§é¡µè¡¨ä¸­çš„ PTE ä¸ºç©ºï¼Œé‚£ä¹ˆäºŒçº§é¡µè¡¨å†…å¯¹åº”çš„æ¡ç›®å°±æ— éœ€å­˜åœ¨ã€‚å¤šæ•°åº”ç”¨ç¨‹åºçš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­å¤§éƒ¨åˆ†é¡µé¢æ˜¯æœªåˆ†é…çš„ï¼Œå› æ­¤è¿™å°†æ˜¾è‘—åœ°é™ä½é¡µè¡¨çš„å†…å­˜å ç”¨ã€‚å¦å¤–ï¼Œæˆ‘ä»¬åªéœ€åœ¨ä¸»å­˜ä¸­ç»´æŠ¤ä¸€çº§é¡µè¡¨å’Œè¢«è°ƒç”¨æœ€ä¸ºé¢‘ç¹çš„äºŒçº§é¡µè¡¨ï¼Œå…¶å®ƒçš„äºŒçº§é¡µè¡¨å¯ä»¥ç”±æ“ä½œç³»ç»ŸæŒ‰éœ€åˆ›å»ºå’Œåˆ†é¡µã€‚\nåœ¨ k çº§é¡µè¡¨ä¸­ï¼Œè™šæ‹Ÿåœ°å€è¢«åˆ’åˆ†ä¸º k ä¸ª VPN å’Œä¸€ä¸ª VPOï¼ŒVPN iï¼ˆ1 â‰¤ i â‰¤ kï¼‰æ˜¯ç¬¬ i çº§é¡µè¡¨çš„ç´¢å¼•ã€‚é™¤ç¬¬ k çº§é¡µè¡¨å¤–ï¼Œæ¯ä¸ªé¡µè¡¨ä¸­çš„ PTE å‡æŒ‡å‘ä¸‹ä¸€çº§é¡µè¡¨çš„èµ·å§‹ä½ç½®ï¼Œè€Œç¬¬ k çº§è¡¨å†…çš„æ¯æ¡ PTE åˆ™ä¿å­˜äº†å¯¹åº”ç‰©ç†é¡µé¢çš„ PPNã€‚ä¸å•çº§é¡µè¡¨ä¸€æ ·ï¼ŒPPO ä¸ VPO ç›¸åŒã€‚MMU å¿…é¡»å…ˆè¯·æ±‚ k ä¸ª PTEï¼Œç„¶åæ‰èƒ½ç¡®å®š PPN ä»¥ç”Ÿæˆå®Œæ•´çš„ç‰©ç†åœ°å€ã€‚TLB å¯ä»¥ç¼“å­˜å¤šçº§é¡µè¡¨ä¸­çš„ PTEï¼Œè¿™ä½¿å¾—å¤šçº§é¡µè¡¨çš„åœ°å€è½¬æ¢é€Ÿåº¦å¹¶ä¸æ¯”å•çº§é¡µè¡¨æ…¢å¾ˆå¤šã€‚\nIntel Core i7/Linux å†…å­˜ç³»ç»Ÿ å°½ç®¡åº•å±‚çš„ Haswell å¾®æ¶æ„èƒ½å¤Ÿæ”¯æŒå®Œæ•´çš„ 64 ä½è™šæ‹Ÿå’Œç‰©ç†åœ°å€ç©ºé—´ï¼Œä½†ç›®å‰ Core i7 ä»…æä¾›äº† 48 ä½ (256 TB) çš„è™šæ‹Ÿåœ°å€ç©ºé—´å’Œ 52 ä½ (4 PB ) çš„ç‰©ç†åœ°å€ç©ºé—´ï¼Œä»¥åŠä¸€ä¸ªæ”¯æŒ 32 ä½ (4 GB) è™šæ‹Ÿå’Œç‰©ç†åœ°å€ç©ºé—´çš„å…¼å®¹æ¨¡å¼ã€‚\nCore i7 åœ°å€è½¬æ¢ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒCore i7 ä½¿ç”¨å››çº§é¡µè¡¨ç»“æ„ã€‚CR 3 æ§åˆ¶å¯„å­˜å™¨ä¸­ä¿å­˜äº†ä¸€çº§ (L1) é¡µè¡¨çš„èµ·å§‹ç‰©ç†åœ°å€ï¼Œå…¶å€¼æ˜¯æ¯ä¸ªè¿›ç¨‹ä¸Šä¸‹æ–‡çš„ä¸€éƒ¨åˆ†å¹¶åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶æ¢å¤ã€‚48 ä½çš„è™šæ‹Ÿåœ°å€åŒ…å«äº† 36 ä½çš„ VPN å’Œ 12 ä½ï¼ˆ4 K = $2^{12}$ï¼‰çš„ VPOï¼Œå…¶ä¸­ VPN åˆè¢«åˆ’åˆ†ä¸ºå››ä¸ª 9 ä½çš„åœ°å€ç©ºé—´å—ã€‚\nLinux è™šæ‹Ÿå†…å­˜ç³»ç»Ÿ æ³¨ï¼šæ¯ä¸ªè¿›ç¨‹åœ°å€ç©ºé—´é‡Œçš„å†…æ ¸éƒ¨åˆ†éƒ½æ˜¯ç›¸åŒçš„ï¼Œå› æ­¤ä¸Šå›¾ä¸­çš„â€œDifferent for each processâ€æœ‰è¯¯ã€‚\nLinux å°†è™šæ‹Ÿå†…å­˜åˆ’åˆ†ä¸ºå¤šä¸ªåŒºåŸŸæˆ–æ®µï¼ˆArea æˆ– Segmentï¼‰ï¼Œæ¯ä¸ªåŒºåŸŸéƒ½æ˜¯ä¸€äº›å·²åˆ†é…ä¸”åœ¨æŸäº›æ–¹é¢ç›¸å…³çš„è¿ç»­é¡µé¢ã€‚ä¾‹å¦‚ï¼Œä»£ç æ®µã€æ•°æ®æ®µã€å †ã€å…±äº«åº“æ®µå’Œç”¨æˆ·æ ˆåˆ†åˆ«æ˜¯ä¸åŒçš„åŒºåŸŸã€‚æ¯ä¸ªå·²åˆ†é…çš„é¡µé¢éƒ½å±äºæŸä¸ªåŒºåŸŸï¼Œå› æ­¤ä¸å±äºä»»ä½•åŒºåŸŸçš„é¡µé¢ä¸å­˜åœ¨ä¹Ÿæ— æ³•è¢«è¿›ç¨‹å¼•ç”¨ã€‚åŒºåŸŸæ¦‚å¿µçš„å¼•å…¥ä½¿å¾— Linux å…è®¸è™šæ‹Ÿåœ°å€ç©ºé—´å­˜åœ¨é—´éš™ã€‚\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒLinux å†…æ ¸ä¸ºæ¯ä¸ªè¿›ç¨‹ç»´æŠ¤äº†ä¸€ä¸ªç‹¬ç‰¹çš„æ•°æ®ç»“æ„task_structï¼Œå…¶å­—æ®µåŒ…å«æˆ–æŒ‡å‘å†…æ ¸è¿è¡Œè¯¥è¿›ç¨‹æ‰€éœ€çš„å…¨éƒ¨ä¿¡æ¯ï¼ˆå¦‚ PIDã€ç”¨æˆ·æ ˆæŒ‡é’ˆã€å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶åç§°å’Œç¨‹åºå¯„å­˜å™¨ç­‰ï¼‰ã€‚å…¶ä¸­ï¼Œå­—æ®µmmæŒ‡å‘mm_structï¼Œè¯¥ç»“æ„ä½“æè¿°äº†è™šæ‹Ÿå†…å­˜çš„å½“å‰çŠ¶æ€ã€‚mm_structä¸­çš„pgdå­—æ®µæŒ‡å‘ä¸€çº§é¡µè¡¨çš„èµ·å§‹ä½ç½®ï¼Œå®ƒåœ¨è¿›ç¨‹è¿è¡Œæ—¶è¢«å†…æ ¸å­˜å‚¨åœ¨ CR 3 æ§åˆ¶å¯„å­˜å™¨ä¸­ã€‚è€Œmmapå­—æ®µåˆ™æŒ‡å‘ä¸€ä¸ªç”±vm_area_structsç»„æˆçš„é“¾è¡¨ã€‚æè¿°åŒºåŸŸä¿¡æ¯çš„ç»“æ„ä½“vm_area_structsåŒ…å«ä»¥ä¸‹å­—æ®µï¼š\nvm_startï¼šæŒ‡å‘åŒºåŸŸçš„èµ·ç‚¹ï¼› vm_endï¼šæŒ‡å‘åŒºåŸŸçš„æœ«ç«¯ï¼› vm_protï¼šæè¿°è¯¥åŒºåŸŸä¸­æ‰€æœ‰é¡µé¢çš„è¯»/å†™æƒé™ï¼› vm_flagsï¼šæè¿°è¯¥åŒºåŸŸä¸­çš„é¡µé¢æ˜¯å¦ä¸å…¶ä»–è¿›ç¨‹å…±äº«ï¼› vm_nextï¼šæŒ‡å‘é“¾è¡¨ä¸­ä¸‹ä¸€ä¸ªvm_area_structsã€‚ å¼‚å¸¸å¤„ç†ç¨‹åºå¯ä»¥å°†è™šæ‹Ÿåœ°å€ä¸vm_startå’Œvm_endå­—æ®µæ¯”è¾ƒï¼Œä»è€Œåˆ¤æ–­å®ƒæ˜¯å¦å±äºæŸä¸ªåŒºåŸŸï¼Œå¦‚ä¸Šå›¾ â‘ ã€‚è¿˜å¯ä»¥æ ¹æ®vm_protå­—æ®µåˆ¤æ–­è¿›ç¨‹æ˜¯å¦æœ‰æƒé™è®¿é—®ç›®æ ‡åŒºåŸŸä¸­çš„é¡µé¢ï¼Œå¦‚ä¸Šå›¾ â‘¡ã€‚\nå†…å­˜æ˜ å°„ Linux ä½¿ç”¨å†…å­˜æ˜ å°„ï¼ˆMemory Mappingï¼‰æŠ€æœ¯åˆå§‹åŒ–è™šæ‹Ÿå†…å­˜åŒºåŸŸå¹¶å°†å…¶ä¸ç£ç›˜ä¸Šçš„â€œå¯¹è±¡â€ç›¸å…³è”ã€‚è¯¥â€œå¯¹è±¡â€æœ‰ä¸¤ç§ç±»å‹ï¼š\næ–‡ä»¶ç³»ç»Ÿä¸­çš„å¸¸è§„æ–‡ä»¶ï¼ˆRegular Fileï¼‰ï¼šæ–‡ä»¶è¢«åˆ†æˆå¤šä¸ªä¸é¡µé¢å¤§å°ç›¸åŒçš„ç‰‡æ®µï¼Œè€Œæ¯ä¸ªç‰‡æ®µéƒ½åŒ…å«äº†ä¸€ä¸ªè™šæ‹Ÿé¡µé¢çš„åˆå§‹å†…å®¹ã€‚ç”±äºæ“ä½œç³»ç»Ÿé‡‡ç”¨æŒ‰éœ€åˆ†é¡µçš„ç­–ç•¥ï¼Œå› æ­¤é¡µé¢åœ¨ç¬¬ä¸€æ¬¡è¢« CPU å¼•ç”¨å‰ä¸ä¼šè¢«æ¢å…¥åˆ°ç‰©ç†å†…å­˜ä¸­ã€‚å¦‚æœè™šæ‹Ÿå†…å­˜åŒºåŸŸæ¯”æ–‡ä»¶å¤§ï¼Œåˆ™å¤šä½™éƒ¨åˆ†ç”¨é›¶å¡«å……ï¼› åŒ¿åæ–‡ä»¶ï¼ˆAnonymous Fileï¼‰ï¼šç”±å†…æ ¸åˆ›å»ºï¼Œå…¶å†…å®¹å…¨éƒ¨ä¸ºäºŒè¿›åˆ¶é›¶ã€‚å½“ CPU ç¬¬ä¸€æ¬¡å¼•ç”¨è¯¥åŒºåŸŸå†…çš„è™šæ‹Ÿé¡µé¢æ—¶ï¼Œå†…æ ¸ä¼šå…ˆåœ¨ç‰©ç†å†…å­˜ä¸­é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„å—å®³è€…é¡µé¢ï¼ˆè‹¥è¯¥é¡µé¢å·²è¢«ä¿®æ”¹åˆ™éœ€è¦å°†å…¶æ¢å‡ºï¼‰å¹¶ç”¨äºŒè¿›åˆ¶é›¶å°†å…¶è¦†ç›–ï¼Œç„¶åæ›´æ–°é¡µè¡¨ä½¿è™šæ‹Ÿé¡µé¢æŒ‡å‘è¢«è¦†ç›–åçš„ç‰©ç†é¡µé¢ã€‚æ•´ä¸ªè¿‡ç¨‹ä¸­æ²¡æœ‰æ•°æ®è¢«æ¢å…¥åˆ°ç‰©ç†å†…å­˜ï¼Œå› æ­¤è¯¥åŒºåŸŸå†…çš„é¡µé¢åˆè¢«ç§°ä¸ºé›¶éœ€æ±‚é¡µé¢ï¼ˆDemand-zero Pageï¼‰ã€‚ ä¸€æ—¦æˆ‘ä»¬ä½¿ç”¨å†…å­˜æ˜ å°„åˆå§‹åŒ–ä¸€ä¸ªè™šæ‹Ÿé¡µé¢ï¼Œå®ƒå°±ä¼šåœ¨ç”±å†…æ ¸ç»´æŠ¤çš„äº¤æ¢æ–‡ä»¶ï¼ˆSwap Fileï¼‰ä¸ç‰©ç†å†…å­˜ä¹‹é—´æ¥å›äº¤æ¢ã€‚äº¤æ¢æ–‡ä»¶åˆç§°äº¤æ¢åŒºï¼ˆSwap Areaï¼‰æˆ–äº¤æ¢ç©ºé—´ï¼ˆSwap Spaceï¼‰ï¼Œå®ƒçš„å¤§å°é™åˆ¶äº†å½“å‰è¿è¡Œè¿›ç¨‹æ‰€èƒ½ç”³è¯·çš„è™šæ‹Ÿé¡µé¢æ€»é‡ã€‚\nå›çœ‹å…±äº«ç›®æ ‡æ–‡ä»¶ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸¤è¿›ç¨‹å°†ç›¸åŒçš„ å…±äº«ç›®æ ‡æ–‡ä»¶ æ˜ å°„åˆ°å„è‡ªè™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„ä¸åŒåŒºåŸŸï¼Œè€Œç‰©ç†å†…å­˜ä¸­åªéœ€å­˜åœ¨å•ä¸ªæ–‡ä»¶å‰¯æœ¬ã€‚è¿›ç¨‹ 1 å¯¹è¯¥å…±äº«åŒºåŸŸçš„ä»»ä½•å†™å…¥æ“ä½œéƒ½å¯¹è¿›ç¨‹ 2 å¯è§ï¼Œå¹¶ä¸”è¿™äº›æ›´æ”¹è¿˜ä¼šåŒæ­¥åˆ°ç£ç›˜ä¸Šçš„åŸå§‹æ–‡ä»¶ã€‚\nå¦‚ä¸Šå›¾ (a) æ‰€ç¤ºï¼Œä¸¤è¿›ç¨‹å°†ç§æœ‰ç›®æ ‡æ–‡ä»¶æ˜ å°„åˆ°å„è‡ªè™šæ‹Ÿåœ°å€ç©ºé—´çš„ä¸åŒåŒºåŸŸã€‚è¿›ç¨‹ 1 å¯¹è¯¥ç§æœ‰åŒºåŸŸçš„ä»»ä½•å†™å…¥æ“ä½œéƒ½å¯¹è¿›ç¨‹ 2 ä¸å¯è§ï¼Œå¹¶ä¸”è¿™äº›æ›´æ”¹ä¹Ÿä¸ä¼šåŒæ­¥åˆ°ç£ç›˜ä¸Šçš„åŸå§‹æ–‡ä»¶ã€‚å¦‚ä¸Šå›¾ (b) æ‰€ç¤ºï¼Œå½“è¿›ç¨‹ 2 è¯•å›¾ä¿®æ”¹è¯¥åŒºåŸŸä¸­çš„å†…å®¹æ—¶ï¼Œå†…æ ¸ä¼šåœ¨ç‰©ç†å†…å­˜ä¸­ä¸ºé¡µé¢åˆ›å»ºä¸€ä¸ªæ–°å‰¯æœ¬å¹¶æ›´æ–°é¡µè¡¨æ¡ç›®ä½¿å…¶æŒ‡å‘å®ƒã€‚ç”±äºé¡µé¢å¤åˆ¶å‘ç”Ÿåœ¨å†™å…¥æ“ä½œå‰ï¼Œè¿™ç§æŠ€æœ¯è¢«ç§°ä¸ºå†™æ—¶å¤åˆ¶ï¼ˆCopy-on-Writeï¼‰ï¼Œè¿™äº›åŒºåŸŸåˆ™æ˜¯ç§æœ‰å†™æ—¶å¤åˆ¶çš„ï¼ˆPrivate Copy-on-Writeï¼‰ã€‚\nå›çœ‹ fork å‡½æ•° è¿›ç¨‹è°ƒç”¨ fork å‡½æ•°åï¼Œå†…æ ¸ä¼šä¸ºå­è¿›ç¨‹åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ PID å¹¶ä¸ºå…¶åˆ›å»ºä¸çˆ¶è¿›ç¨‹ç›¸åŒçš„mm_structã€vm_area_structsä»¥åŠé¡µè¡¨ã€‚å½“ä»»æ„è¿›ç¨‹åç»­æ‰§è¡Œå†™å…¥æ“ä½œæ—¶ï¼Œå†…æ ¸å°†ä½¿ç”¨å†™æ—¶å¤åˆ¶æŠ€æœ¯åˆ›å»ºæ–°é¡µé¢ï¼Œè¿™ä¾¿ä¿è¯äº†è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´çš„ç§æœ‰æ€§ã€‚\nå›çœ‹ execve å‡½æ•° å¦‚æœè¿›ç¨‹è°ƒç”¨ execve å‡½æ•°ï¼Œå¦‚execve(\"a.out\", NULL, NULL)ï¼Œåˆ™åŠ è½½å¹¶è¿è¡Œa.outçš„æ­¥éª¤å¦‚ä¸‹ï¼š\nåˆ é™¤å½“å‰è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ç”¨æˆ·åŒºåŸŸçš„vm_area_structsï¼› ä¸ºæ–°ç¨‹åºçš„ä»£ç ã€æ•°æ®ã€bss å’Œå †æ ˆåŒºåŸŸåˆ›å»ºvm_area_structsã€‚è¿™äº›åŒºåŸŸéƒ½æ˜¯ç§æœ‰å†™æ—¶å¤åˆ¶çš„ï¼Œä»£ç å’Œæ•°æ®åŒºåŸŸè¢«æ˜ å°„åˆ°a.outæ–‡ä»¶ä¸­çš„ .text å’Œ .dataï¼Œbss åŒºåŸŸåˆ™è¢«æ˜ å°„åˆ°å¤§å°åŒ…å«åœ¨a.outå†…çš„åŒ¿åæ–‡ä»¶ã€‚å †æ ˆçš„åˆå§‹é•¿åº¦å‡ä¸º 0ï¼Œå…¶é¡µé¢æ˜¯é›¶éœ€æ±‚çš„ï¼› å¦‚æœa.outæ–‡ä»¶é“¾æ¥äº†å…±äº«åº“ï¼Œå¦‚ C æ ‡å‡†åº“libc.soï¼Œé‚£ä¹ˆè¿˜éœ€è¦æŠŠè¿™äº›å¯¹è±¡åŠ¨æ€é“¾æ¥åˆ°ç¨‹åºä¸­ï¼Œå¹¶å°†å…¶æ˜ å°„åˆ°è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„å…±äº«åŒºåŸŸå†…ï¼› ä½¿å½“å‰è¿›ç¨‹ä¸Šä¸‹æ–‡ä¸­çš„ç¨‹åºè®¡æ•°å™¨æŒ‡å‘æ–°ç¨‹åºä»£ç åŒºåŸŸçš„å…¥å£ç‚¹ã€‚ mmap å‡½æ•° 1 2 3 4 5 #include \u003cunistd.h\u003e #include \u003csys/mman.h\u003e void *mmap(void *start, size_t length, int prot, int flags, int fd, off_t offset); // Returns: pointer to mapped area if OK, MAP_FAILED (âˆ’1) on error mmapå‡½æ•°è¯·æ±‚å†…æ ¸åˆ›å»ºä¸€ä¸ªèµ·å§‹åœ°å€ä¸ºå‚æ•°startçš„è™šæ‹Ÿå†…å­˜åŒºåŸŸï¼Œè¯¥åŒºåŸŸæ˜ å°„åˆ°æ–‡ä»¶æè¿°ç¬¦fdæ‰€æŒ‡å®šçš„å¯¹è±¡ã€‚è¿ç»­å¯¹è±¡çš„é•¿åº¦ä¸ºå‚æ•°lengthï¼Œå…¶é¦–éƒ¨åœ¨æ–‡ä»¶ä¸­çš„åç§»é‡ä¸ºå‚æ•°offsetï¼š\nå‚æ•°protä¸­åŒ…å«äº†æè¿°è™šæ‹Ÿå†…å­˜åŒºåŸŸè®¿é—®æƒé™çš„ä½ï¼Œå³vm_area_structsä¸­çš„vm_protï¼š\nPROT_EXECï¼šè¯¥åŒºåŸŸä¸­çš„é¡µé¢åŒ…å«å¯æ‰§è¡ŒæŒ‡ä»¤ï¼› PROT_READï¼šå¯ä»¥é˜…è¯»è¯¥åŒºåŸŸä¸­çš„é¡µé¢ï¼› PROT_WRITEï¼šå¯ä»¥å†™å…¥è¯¥åŒºåŸŸä¸­çš„é¡µé¢ï¼› PROT_NONEï¼šæ— æ³•è®¿é—®è¯¥åŒºåŸŸä¸­çš„é¡µé¢ã€‚ å‚æ•°flagä¸­åŒ…å«äº†æè¿°äº†æ˜ å°„å¯¹è±¡ç±»å‹çš„ä½ï¼š\nMAP_SHAREDï¼šå…±äº«å¯¹è±¡ï¼› MAP_PRIVATEï¼šç§æœ‰å†™æ—¶å¤åˆ¶å¯¹è±¡ï¼› MAP_ANONï¼šåŒ¿åå¯¹è±¡ï¼Œå¯¹åº”çš„è™šæ‹Ÿé¡µé¢æ˜¯é›¶éœ€æ±‚é¡µé¢ã€‚ munmapå‡½æ•°åˆ é™¤èµ·å§‹äºè™šæ‹Ÿåœ°å€startã€é•¿åº¦ä¸ºlengthçš„åŒºåŸŸï¼Œåç»­å¯¹å·²åˆ é™¤åŒºåŸŸçš„å¼•ç”¨ä¼šå¼•å‘åˆ†æ®µæ•…éšœã€‚\n1 2 3 4 #include \u003cunistd.h\u003e #include \u003csys/mman.h\u003e int munmap(void *start, size_t length); // Returns: 0 if OK, âˆ’1 on error åŠ¨æ€å†…å­˜åˆ†é… ç›¸æ¯”äºä½çº§åˆ«çš„mmapå‡½æ•°ï¼ŒC ç¨‹åºå‘˜æ›´å€¾å‘äºåœ¨è¿è¡Œæ—¶è°ƒç”¨åŠ¨æ€å†…å­˜åˆ†é…å™¨ï¼ˆDynamic Memory Allocatorï¼‰æ¥åˆ›å»ºè™šæ‹Ÿå†…å­˜åŒºåŸŸã€‚åŠ¨æ€å†…å­˜åˆ†é…å™¨ä¸ºè¿›ç¨‹ç»´æŠ¤çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸè¢«ç§°ä¸ºå †ï¼ˆHeapï¼‰ï¼Œå…¶ä¸€èˆ¬ç»“æ„ä¸ºï¼š\nå †å‘ä¸Šå¢é•¿ï¼Œå†…æ ¸ä¸ºæ¯ä¸ªè¿›ç¨‹éƒ½ç»´æŠ¤äº†ä¸€ä¸ªæŒ‡å‘å †é¡¶çš„å˜é‡brkã€‚åˆ†é…å™¨å°†å †çœ‹ä½œä¸€ä¸ªåŒ…å«ä¸åŒå°ºå¯¸ Block çš„é›†åˆï¼Œæ¯ä¸ª Block éƒ½æ˜¯ä¸€ä¸ªè¿ç»­çš„è™šæ‹Ÿå†…å­˜å—ã€‚Block æœ‰ä¸¤ç§çŠ¶æ€ï¼Œå·²åˆ†é…ï¼ˆAllocatedï¼‰å’Œç©ºé—²ï¼ˆFreeï¼‰ã€‚æ‰€æœ‰åˆ†é…å™¨å‡æ˜¾å¼åœ°ä¸ºåº”ç”¨ç¨‹åºåˆ†é… Blockï¼Œä½†è´Ÿè´£é‡Šæ”¾å·²åˆ†é… Block çš„å®ä½“å¯èƒ½æœ‰æ‰€ä¸åŒï¼š\næ˜¾å¼åˆ†é…å™¨ï¼šåº”ç”¨ç¨‹åºæ˜¾å¼åœ°é‡Šæ”¾å·²åˆ†é…çš„ Blockã€‚C å’Œ C++ ç¨‹åºåˆ†åˆ«è°ƒç”¨mallocå’Œnewå‡½æ•°è¯·æ±‚ Blockï¼Œè°ƒç”¨freeå’Œdeleteå‡½æ•°é‡Šæ”¾ Blockï¼› éšå¼åˆ†é…å™¨ï¼šåˆ†é…å™¨è‡ªè¡Œé‡Šæ”¾ç¨‹åºä¸å†ä½¿ç”¨çš„å·²åˆ†é… Blockï¼Œè¯¥è¿‡ç¨‹è¢«ç§°ä¸ºåƒåœ¾å›æ”¶ï¼ˆGarbage Collectionï¼‰ã€‚Lispã€ML å’Œ Java ç­‰é«˜çº§è¯­è¨€å‡é‡‡ç”¨è¿™ç§æ–¹æ³•ã€‚ malloc å’Œ free å‡½æ•° 1 2 3 #include \u003cstdlib.h\u003e void *malloc(size_t size); // Returns: pointer to allocated block if OK, NULL on error mallocå‡½æ•°è¯·æ±‚å †ä¸­çš„ä¸€å— Block å¹¶è¿”å›æŒ‡å‘è¯¥ Block çš„æŒ‡é’ˆã€‚Block çš„å¤§å°è‡³å°‘ä¸ºå‚æ•°sizeï¼Œå¹¶å¯èƒ½æ ¹æ®å…¶ä¿å­˜çš„æ•°æ®å¯¹è±¡ç±»å‹è¿›è¡Œé€‚å½“å¯¹é½ã€‚åœ¨ 32 ä½ç¼–è¯‘æ¨¡å¼ä¸‹ï¼ŒBlock çš„åœ°å€å§‹ç»ˆä¸º 8 çš„å€æ•°ï¼Œè€Œåœ¨ 64 ä½ä¸­åˆ™ä¸º 16 çš„å€æ•°ã€‚å¦‚æœæ‰§è¡Œmallocé‡åˆ°é—®é¢˜ï¼Œå¦‚ç¨‹åºè¯·æ±‚çš„ Block å¤§å°è¶…è¿‡äº†å¯ç”¨çš„è™šæ‹Ÿå†…å­˜ï¼Œåˆ™å‡½æ•°è¿”å›NULLå¹¶è®¾ç½® errnoã€‚æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨mallocçš„åŒ…è£…å‡½æ•°callocï¼Œå®ƒä¼šå°†åˆ†é…çš„å†…å­˜åˆå§‹åŒ–ä¸ºé›¶ã€‚ç±»ä¼¼åœ°ï¼Œreallocå‡½æ•°å¯ä»¥æ›´æ”¹å·²åˆ†é… Block çš„å¤§å°ã€‚\n1 2 3 #include \u003cunistd.h\u003e void *sbrk(intptr_t incr); // Returns: old brk pointer on success, âˆ’1 on error sbrkå‡½æ•°å°†å‚æ•°incrä¸å†…æ ¸ä¸­çš„brkæŒ‡é’ˆç›¸åŠ ä»¥å¢å¤§æˆ–ç¼©å°å †ã€‚è‹¥æ‰§è¡ŒæˆåŠŸï¼Œåˆ™è¿”å›brkçš„æ—§å€¼ï¼Œå¦åˆ™å°†è¿”å› -1 å¹¶å°†errnoè®¾ç½®ä¸ºENOMEMã€‚\n1 2 3 #include \u003cstdlib.h\u003e void free(void *ptr); // Returns: nothing freeå‡½æ•°å°†å‚æ•°ptræŒ‡å‘çš„ Block é‡Šæ”¾ï¼Œè€Œè¿™äº› Block å¿…é¡»æ˜¯ç”±mallocã€callocæˆ–reallocåˆ†é…çš„ã€‚è¯¥å‡½æ•°æ²¡æœ‰è¿”å›å€¼ï¼Œå› æ­¤å¾ˆå®¹æ˜“äº§ç”Ÿä¸€äº›ä»¤äººè´¹è§£çš„è¿è¡Œæ—¶é”™è¯¯ã€‚\nä¸Šå›¾å±•ç¤ºäº† C ç¨‹åºå¦‚ä½•ä½¿ç”¨mallocå’Œfreeç®¡ç†ä¸€ä¸ªå¤§å°ä¸º 16 å­—ï¼ˆå­—é•¿ä¸º 4 å­—èŠ‚ï¼‰çš„å †ã€‚å›¾ä¸­çš„æ¯ä¸ªæ–¹æ¡†ä»£è¡¨ä¸€ä¸ªå­—ï¼Œæ¯ä¸ªè¢«ç²—çº¿åˆ†éš”çš„çŸ©å½¢ä»£è¡¨ä¸€ä¸ª Blockã€‚æœ‰é˜´å½±çš„ Block ä»£è¡¨å·²åˆ†é…ï¼Œæ— é˜´å½±çš„ Block åˆ™ä»£è¡¨ç©ºé—²ã€‚\nå¦‚ä¸Šå›¾ (a) æ‰€ç¤ºï¼Œç¨‹åºè¯·æ±‚ä¸€ä¸ª 4 å­—çš„ Blockï¼Œmallocä»ç©ºé—²å—ä¸­åˆ‡å‡ºä¸€ä¸ª 4 å­—çš„ Block å¹¶è¿”å›æŒ‡å‘è¯¥ Block ä¸­ç¬¬ä¸€ä¸ªå­—çš„æŒ‡é’ˆp1ï¼›å¦‚ä¸Šå›¾ (b) æ‰€ç¤ºï¼Œç¨‹åºè¯·æ±‚ä¸€ä¸ª 5 å­—çš„ Blockï¼Œmallocä»ç©ºé—²å—ä¸­åˆ‡å‡ºä¸€ä¸ª 6 å­—çš„ Block ä»¥å®ç°åŒå­—å¯¹é½ï¼›å¦‚ä¸Šå›¾ (c) æ‰€ç¤ºï¼Œç¨‹åºè¯·æ±‚ä¸€ä¸ª 6 å­—çš„ Blockï¼Œmallocä»ç©ºé—²å—ä¸­åˆ‡å‡ºä¸€ä¸ª 6 å­—çš„ Blockï¼›å¦‚ä¸Šå›¾ (d) æ‰€ç¤ºï¼Œç¨‹åºé‡Šæ”¾å›¾ (b) ä¸­åˆ†é…çš„ Blockã€‚freeè¿”å›åï¼ŒæŒ‡é’ˆp2ä¾ç„¶æŒ‡å‘å·²é‡Šæ”¾çš„ Blockï¼Œå› æ­¤ç¨‹åºä¸åº”åœ¨é‡æ–°åˆå§‹åŒ–p2å‰ç»§ç»­ä½¿ç”¨å®ƒï¼›å¦‚ä¸Šå›¾ (e) æ‰€ç¤ºï¼Œç¨‹åºè¯·æ±‚ä¸€ä¸ª 2 å­—çš„ Blockã€‚mallocä»ä¸Šä¸€æ­¥é‡Šæ”¾çš„ Block ä¸­åˆ‡å‡ºä¸€éƒ¨åˆ†å¹¶è¿”å›æŒ‡å‘æ–° Block çš„æŒ‡é’ˆp4ã€‚\nåŠ¨æ€å†…å­˜åˆ†é…çš„åŸå›  åœ¨ç¨‹åºå®é™…è¿è¡Œä¹‹å‰ï¼Œæˆ‘ä»¬å¯èƒ½å¹¶ä¸çŸ¥é“æŸäº›æ•°æ®ç»“æ„çš„å¤§å°ã€‚ç¤ºä¾‹ C ç¨‹åºå°†nä¸ª ASCII æ•´å‹ä»æ ‡å‡†è¾“å…¥è¯»å–åˆ°æ•°ç»„array[MAXN]ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 #include \"csapp.h\" #define MAXN 15213 int array[MAXN]; int main() { int i, n; scanf(\"%d\", \u0026n); if (n \u003e MAXN) app_error(\"Input file too big\"); for (i = 0; i \u003c n; i++) scanf(\"%d\", \u0026array[i]); exit(0); } ç”±äºæˆ‘ä»¬æ— æ³•é¢„æµ‹nçš„å€¼ï¼Œå› æ­¤åªèƒ½å°†æ•°ç»„å¤§å°å†™æ­»ä¸ºMAXNã€‚MAXNçš„å€¼æ˜¯ä»»æ„çš„ï¼Œå¯èƒ½è¶…å‡ºç³»ç»Ÿå¯ç”¨çš„è™šæ‹Ÿå†…å­˜é‡ã€‚å¦å¤–ï¼Œä¸€æ—¦ç¨‹åºæƒ³è¦è¯»å–ä¸€ä¸ªæ¯”MAXNè¿˜å¤§çš„æ–‡ä»¶ï¼Œå”¯ä¸€çš„åŠæ³•å°±æ˜¯å¢å¤§MAXNçš„å€¼å¹¶é‡æ–°ç¼–è¯‘ç¨‹åºã€‚å¦‚æœæˆ‘ä»¬åœ¨è¿è¡Œæ—¶æ ¹æ®nçš„å¤§å°åŠ¨æ€åˆ†é…å†…å­˜ï¼Œä»¥ä¸Šé—®é¢˜ä¾¿è¿åˆƒè€Œè§£ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 #include \"csapp.h\" int main() { int *array, i, n; scanf(\"%d\", \u0026n); array = (int *)Malloc(n * sizeof(int)); for (i = 0; i \u003c n; i++) scanf(\"%d\", \u0026array[i]); free(array); exit(0); } å¯¹åˆ†é…å™¨çš„è¦æ±‚å’Œç›®æ ‡ æ˜¾å¼åˆ†é…å™¨å¿…é¡»åœ¨è‹¥å¹²é™åˆ¶æ¡ä»¶ä¸‹è¿è¡Œï¼š\nå¤„ç†ä»»æ„é¡ºåºçš„è¯·æ±‚ï¼šåˆ†é…å™¨ä¸èƒ½å¯¹mallocå’Œfreeçš„è¯·æ±‚é¡ºåºä½œå‡ºå‡è®¾ã€‚ä¾‹å¦‚ï¼Œåˆ†é…å™¨ä¸èƒ½å‡è®¾æ‰€æœ‰çš„mallocéƒ½ç´§è·Ÿä¸€ä¸ªä¸ä¹‹åŒ¹é…çš„freeï¼› ç«‹å³å“åº”è¯·æ±‚ï¼šåˆ†é…å™¨ä¸å¯ä»¥å¯¹è¯·æ±‚é‡æ–°æ’åºæˆ–ç¼“å†²ï¼ˆBufferï¼‰ä»¥æé«˜æ€§èƒ½ï¼› ä»…ä½¿ç”¨å †ï¼šåˆ†é…å™¨ä½¿ç”¨çš„æ•°æ®ç»“æ„å¿…é¡»å­˜å‚¨åœ¨å †ä¸­ï¼› å¯¹é½ Blockï¼šåˆ†é…å™¨å¿…é¡»å¯¹é½ Block ä»¥ä½¿å…¶èƒ½å¤Ÿå®¹çº³ä»»ä½•ç±»å‹çš„æ•°æ®å¯¹è±¡ï¼› ä¸ä¿®æ”¹å·²åˆ†é…çš„ Blockï¼šåˆ†é…å™¨æ— æ³•ä¿®æ”¹ã€ç§»åŠ¨æˆ–å‹ç¼©å·²åˆ†é…çš„ Blockã€‚ è¡¡é‡åˆ†é…å™¨æ€§èƒ½çš„æŒ‡æ ‡æœ‰ï¼š\nååé‡ï¼ˆThroughputï¼‰ï¼šå•ä½æ—¶é—´å†…å®Œæˆçš„è¯·æ±‚æ•°ï¼› å†…å­˜åˆ©ç”¨ç‡ï¼ˆMemory Utilizationï¼‰ï¼šå³å †å†…å­˜çš„ä½¿ç”¨ç‡ã€‚ æœ€å¤§åŒ–ååé‡å’Œæœ€å¤§åŒ–å†…å­˜åˆ©ç”¨ç‡ä¹‹é—´å­˜åœ¨çŸ›ç›¾ï¼Œå› æ­¤æˆ‘ä»¬åœ¨è®¾è®¡åˆ†é…å™¨æ—¶éœ€è¦æ‰¾åˆ°äºŒè€…çš„å¹³è¡¡ã€‚\nç¢ç‰‡ æˆ‘ä»¬å°†ç©ºé—²å †å†…å­˜æ— æ³•æ»¡è¶³åˆ†é…è¯·æ±‚çš„ç°è±¡ç§°ä¸ºç¢ç‰‡ï¼ˆFragmentationï¼‰ï¼Œå®ƒæ˜¯å†…å­˜åˆ©ç”¨ç‡ä½çš„ä¸»è¦åŸå› ã€‚ç¢ç‰‡æœ‰ä¸¤ç§å½¢å¼ï¼š\nå†…éƒ¨ç¢ç‰‡ï¼ˆInternal Fragmentationï¼‰ï¼šå·²åˆ†é…çš„ Block æ¯”è¿›ç¨‹è¯·æ±‚çš„ Blockï¼ˆå³ Payloadï¼‰å¤§ï¼Œé€šå¸¸å› åˆ†é…å™¨ä¸ºæ»¡è¶³å¯¹é½è¦æ±‚è€Œäº§ç”Ÿï¼› å¤–éƒ¨ç¢ç‰‡ï¼ˆExternal Fragmentationï¼‰ï¼šç©ºé—²å†…å­˜å……è¶³ä½†å´æ²¡æœ‰ç©ºé—²çš„ Block èƒ½å¤Ÿæ»¡è¶³åˆ†é…è¯·æ±‚ã€‚ä¾‹å¦‚å †ä¸­æœ‰ 4 ä¸ªç©ºé—²çš„å­—ä¸”åˆ†å¸ƒåœ¨ä¸¤ä¸ªä¸ç›¸é‚»çš„ Block ä¸Šï¼Œæ­¤æ—¶è‹¥è¿›ç¨‹ç”³è¯·ä¸€ä¸ª 4 å­—çš„ Block å°±ä¼šå‡ºç°å¤–éƒ¨ç¢ç‰‡ã€‚ å†…éƒ¨ç¢ç‰‡å¾ˆå®¹æ˜“é‡åŒ–ï¼Œå› ä¸ºå®ƒåªæ˜¯å·²åˆ†é… Block ä¸ Payload ä¹‹é—´å¤§å°å·®å¼‚çš„æ€»å’Œï¼Œå…¶æ•°é‡ä»…å–å†³äºå…ˆå‰çš„è¯·æ±‚æ¨¡å¼å’Œåˆ†é…å™¨çš„å®ç°æ–¹å¼ï¼›å¤–éƒ¨ç¢ç‰‡åˆ™éš¾ä»¥é‡åŒ–ï¼Œå› ä¸ºå®ƒè¿˜è¦å—åˆ°æœªæ¥è¯·æ±‚æ¨¡å¼çš„å½±å“ã€‚ä¸ºäº†å‡å°‘å¤–éƒ¨ç¢ç‰‡çš„äº§ç”Ÿï¼Œåˆ†é…å™¨åŠ›æ±‚ç»´æŠ¤å°‘é‡è¾ƒå¤§çš„ç©ºé—² Block è€Œéå¤§é‡è¾ƒå°çš„ç©ºé—² Blockã€‚\nåˆ†é…å™¨çš„å®ç°éš¾ç‚¹ æˆ‘ä»¬å¯ä»¥æƒ³è±¡ä¸€ä¸ªç®€å•çš„åˆ†é…å™¨ï¼Œå®ƒå°†å †çœ‹ä½œä¸€ä¸ªå¤§å‹çš„å­—èŠ‚æ•°ç»„ï¼ŒæŒ‡é’ˆpæŒ‡å‘è¯¥æ•°ç»„çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ã€‚å½“è¿›ç¨‹è¯·æ±‚sizeå¤§å°çš„ Block æ—¶ï¼Œmallocå…ˆæŠŠpçš„å½“å‰å€¼ä¿å­˜åœ¨æ ˆä¸­ï¼Œç„¶åå°†å…¶åŠ ä¸Šsizeï¼Œæœ€åè¿”å›pçš„æ—§å€¼ã€‚å½“è¿›ç¨‹æƒ³è¦é‡Šæ”¾ Block æ—¶ï¼Œfreeåˆ™åªæ˜¯ç®€å•åœ°è¿”å›ç»™è°ƒç”¨è€…è€Œä¸åšä»»ä½•äº‹æƒ…ã€‚\nç”±äºmallocå’Œfreeä»…ç”±å°‘é‡æŒ‡ä»¤ç»„æˆï¼Œè¿™ç§åˆ†é…å™¨çš„ååé‡å¾ˆå¤§ã€‚ç„¶è€Œmallocä¸ä¼šé‡ç”¨ä»»ä½• Blockï¼Œå› æ­¤å †å†…å­˜çš„åˆ©ç”¨ç‡éå¸¸ä½ã€‚èƒ½å¤Ÿåœ¨ååé‡å’Œå†…å­˜åˆ©ç”¨ç‡ä¹‹é—´å–å¾—è‰¯å¥½å¹³è¡¡çš„åˆ†é…å™¨å¿…é¡»è€ƒè™‘ä»¥ä¸‹é—®é¢˜ï¼š\nç»„ç»‡ï¼ˆOrganizationï¼‰ï¼šå¦‚ä½•è·Ÿè¸ªç©ºé—²çš„ Blockï¼Ÿ æ”¾ç½®ï¼ˆPlacementï¼‰ï¼šå¦‚ä½•ä»ç©ºé—²çš„ Block ä¸­é€‰æ‹©åˆé€‚çš„æ¥æ”¾ç½®æ–°åˆ†é…çš„ Blockï¼Ÿ åˆ†å‰²ï¼ˆSplittingï¼‰ï¼šå®Œæˆæ”¾ç½®åï¼Œå¦‚ä½•å¤„ç†å‰©ä½™çš„ç©ºé—² Blockï¼Ÿ åˆå¹¶ï¼ˆCoalescingï¼‰ï¼šå¦‚ä½•å¤„ç†åˆšåˆšè¢«é‡Šæ”¾çš„ Blockï¼Ÿ éšå¼ç©ºé—²é“¾è¡¨ å¤§å¤šæ•°åˆ†é…å™¨é€šè¿‡å°†ä¸€äº›æ•°æ®ç»“æ„åµŒå…¥åˆ° Block ä¸­ä»¥åˆ†è¾¨å…¶è¾¹ç•Œå’ŒçŠ¶æ€ï¼Œä¾‹å¦‚ï¼š\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒBlock ç”±ä¸€ä¸ªå•å­—ï¼ˆå››å­—èŠ‚ï¼‰çš„å¤´éƒ¨ï¼ˆHeaderï¼‰ã€æœ‰æ•ˆè´Ÿè½½ï¼ˆPayloadï¼‰å’Œä¸€äº›é¢å¤–å¡«å……ï¼ˆPaddingï¼‰ç»„æˆï¼Œå¤´éƒ¨ä¸­åŒ…å«äº† Block çš„å¤§å°ï¼ˆBlock Sizeï¼‰å’ŒçŠ¶æ€ä¿¡æ¯ï¼ˆAllocated or Freeï¼‰ã€‚å¦‚æœç³»ç»Ÿé‡‡ç”¨åŒå­—å¯¹é½ç­–ç•¥ï¼Œé‚£ä¹ˆæ¯ä¸ª Block çš„å¤§å°å§‹ç»ˆä¸º 8 çš„å€æ•°ï¼Œå…¶äºŒè¿›åˆ¶è¡¨è¾¾çš„å 3 ä½å§‹ç»ˆä¸º 0ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥ä»…åœ¨å¤´éƒ¨ä¸­å­˜å‚¨è¯¥å­—æ®µçš„å‰ 29 ä½ï¼Œå‰©ä½™ 3 ä½ç”¨æ¥å­˜å‚¨å…¶ä»–ä¿¡æ¯ã€‚ä¸Šå›¾ä¸­çš„ä½â€œaâ€ä¾¿æŒ‡ç¤ºäº†æ­¤ Block æ˜¯å·²åˆ†é…çš„è¿˜æ˜¯ç©ºé—²çš„ã€‚å¡«å……çš„å¤§å°æ˜¯ä»»æ„çš„ï¼Œå®ƒå¯èƒ½æ˜¯åˆ†é…å™¨ä¸ºäº†é¿å…å¤–éƒ¨ç¢ç‰‡äº§ç”Ÿè€Œè®¾ç½®çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸ºäº†æ»¡è¶³å¯¹é½è¦æ±‚è€Œå­˜åœ¨çš„ã€‚\nåŸºäºè¿™ç§ Block æ ¼å¼ï¼Œæˆ‘ä»¬å¯ä»¥å°†å †ç»„ç»‡æˆä¸€ç³»åˆ—è¿ç»­çš„å·²åˆ†é… Block å’Œç©ºé—² Blockï¼š\nBlock é€šè¿‡å…¶å¤´éƒ¨ä¸­çš„å¤§å°å­—æ®µéšå¼åœ°é“¾æ¥èµ·æ¥ï¼ˆaddr(next_block) = addr(current_block) + block_sizeï¼‰ï¼Œå› æ­¤æˆ‘ä»¬å°†è¿™ç§å †ç»„ç»‡æ–¹å¼ç§°ä¸ºéšå¼ç©ºé—²é“¾è¡¨ï¼ˆImplicit Free Listï¼‰ï¼Œåˆ†é…å™¨å¿…é¡»éå†å †ä¸­æ‰€æœ‰çš„ Block æ‰èƒ½å¾—åˆ°å…¨éƒ¨ç©ºé—²çš„ Blockã€‚æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªç‰¹æ®Šçš„ Block ä»¥æ ‡è®°å †çš„ç»“å°¾ï¼Œå¦‚ä¸Šå›¾ä¸­çš„ â€œ0/1â€ã€‚éšå¼ç©ºé—²é“¾è¡¨çš„ä¼˜ç‚¹æ˜¯ç®€å•ï¼Œä½†ä»»ä½•æœç´¢ç©ºé—² Block çš„æ“ä½œï¼ˆå¦‚æ”¾ç½®æ–°åˆ†é…çš„ Blockï¼‰çš„æˆæœ¬éƒ½ä¸å †ä¸­ Block çš„æ€»æ•°æˆæ­£æ¯”ã€‚\næ”¾ç½®æ–°åˆ†é…çš„ Block å½“åº”ç”¨ç¨‹åºè¯·æ±‚ä¸€ä¸ª Block æ—¶ï¼Œåˆ†é…å™¨éœ€è¦åœ¨ç©ºé—²é“¾è¡¨ä¸­é€‰å–ä¸€ä¸ªè¶³å¤Ÿå¤§çš„ Block ä»¥å“åº”ã€‚åˆ†é…å™¨æœç´¢ç©ºé—² Block çš„æ–¹å¼ç”±æ”¾ç½®ç­–ç•¥ï¼ˆPlacement Policyï¼‰æ‰€å†³å®šï¼š\nç¬¬ä¸€æ¬¡æ‹Ÿåˆï¼ˆFirst Fitï¼‰ï¼šä»å¤´å¼€å§‹éå†ç©ºé—²é“¾è¡¨å¹¶é€‰æ‹©ç¬¬ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„ Blockï¼› ä¸‹ä¸€æ¬¡æ‹Ÿåˆï¼ˆNext Fitï¼‰ï¼šä»ä¸Šä¸€æ¬¡æœç´¢åœæ­¢çš„åœ°æ–¹å¼€å§‹éå†ç©ºé—²é“¾è¡¨å¹¶é€‰æ‹©ç¬¬ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„ Blockï¼› æœ€ä½³æ‹Ÿåˆï¼ˆBest Fitï¼‰ï¼šéå†æ‰€æœ‰ Block å¹¶é€‰æ‹©æ»¡è¶³æ¡ä»¶ä¸”æœ€å°çš„ Blockã€‚ ç¬¬ä¸€æ¬¡æ‹Ÿåˆçš„ä¼˜ç‚¹æ˜¯è¾ƒå¤§çš„ Block é€šå¸¸å­˜ç•™åœ¨é“¾è¡¨æœ«å°¾ï¼Œä½†ä¸€äº›è¾ƒå°çš„ Block ä¹Ÿä¼šæ•£è½åœ¨é“¾è¡¨å¼€å¤´ï¼Œè¿™å°†å¢åŠ æœç´¢è¾ƒå¤§ Block çš„æ—¶é—´ã€‚å¦‚æœé“¾è¡¨å¼€å¤´å­˜åœ¨å¤§é‡è¾ƒå°çš„ Blockï¼Œä¸‹ä¸€æ¬¡æ‹Ÿåˆå°±æ¯”ç¬¬ä¸€æ¬¡æ‹Ÿåˆå¿«å¾ˆå¤šã€‚ç„¶è€Œç ”ç©¶è¡¨æ˜ï¼Œä¸‹ä¸€æ¬¡æ‹Ÿåˆçš„å†…å­˜åˆ©ç”¨ç‡æ¯”ç¬¬ä¸€æ¬¡æ‹Ÿåˆä½ã€‚æœ€ä½³æ‹Ÿåˆçš„å†…å­˜åˆ©ç”¨ç‡é€šå¸¸æ¯”å…¶ä»–ä¸¤ç§ç­–ç•¥é«˜ï¼Œä½†å¯¹éšå¼ç©ºé—²é“¾è¡¨æ¥è¯´ï¼Œå…¶æœç´¢æ—¶é—´æ˜¾ç„¶è¦æ¯”å®ƒä»¬æ…¢å¾ˆå¤šã€‚\nåˆ†å‰²ç©ºé—²çš„ Block å¦‚æœåˆ†é…å™¨æ‰¾åˆ°äº†åˆé€‚çš„ Block å¹¶å°†æ•´ä¸ª Block åˆ†é…ç»™ç¨‹åºï¼Œå°±æœ‰å¯èƒ½äº§ç”Ÿå†…éƒ¨ç¢ç‰‡ã€‚ä¸ºäº†é¿å…è¿™ä¸€é—®é¢˜ï¼Œåˆ†é…å™¨å¯ä»¥å°†é€‰å–çš„ Block åˆ†æˆä¸€ä¸ªå·²åˆ†é…çš„ Block å’Œä¸€ä¸ªæ–°çš„ç©ºé—² Blockï¼š\nå¦‚å›¾ 9.37 æ‰€ç¤ºï¼Œç¨‹åºè¯·æ±‚ä¸€ä¸ª 3 å­—çš„ Blockï¼Œäºæ˜¯åˆ†é…å™¨å°†å›¾ 9.36 ä¸­ 8 å­—çš„ç©ºé—² Block æ‹†åˆ†ä¸ºä¸¤ä¸ª 4 å­—çš„ Block å¹¶å°†å…¶ä¸­ä¹‹ä¸€åˆ†é…ç»™å®ƒã€‚\nè·å–é¢å¤–çš„å †å†…å­˜ å¦‚æœåˆ†é…å™¨æ— æ³•æ‰¾åˆ°åˆé€‚çš„ Blockï¼Œå®ƒå¯ä»¥å°è¯•å°†ç›¸é‚»çš„ç©ºé—² Block åˆå¹¶ä»¥è·å–æ›´å¤§çš„ Blockã€‚ä½†å¦‚æœä»ç„¶æ— æ³•æ»¡è¶³è¯·æ±‚ï¼Œåˆ†é…å™¨ä¾¿ä¼šè°ƒç”¨sbrkå‡½æ•°å‘å†…æ ¸è¯·æ±‚é¢å¤–çš„å †å†…å­˜å¹¶å°†å…¶è½¬æ¢ä¸ºä¸€ä¸ªæ–°çš„ç©ºé—² Blockã€‚\nåˆå¹¶ç©ºé—²çš„ Block åˆ†é…å™¨é‡Šæ”¾ Block åï¼Œå¯èƒ½ä¼šæœ‰å…¶ä»–ç©ºé—²çš„ Block ä¸ä¹‹ç›¸é‚»ã€‚æ­¤æ—¶å†…å­˜ä¸­å°†äº§ç”Ÿä¸€ç§ç‰¹æ®Šçš„å¤–éƒ¨ç¢ç‰‡ç°è±¡ï¼Œæˆ‘ä»¬ç§°å…¶ä¸ºè™šå‡ç¢ç‰‡ï¼ˆFalse Fagmentationï¼‰ã€‚\nå¦‚å›¾ 9.38 æ‰€ç¤ºï¼Œåˆ†é…å™¨å°†å›¾ 9.37 ä¸­ç¬¬äºŒä¸ª 4 å­— Block é‡Šæ”¾ã€‚å°½ç®¡ä¸¤ä¸ªè¿ç»­ç©ºé—² Block ä¸­å‡æœ‰ 3 å­—çš„æœ‰æ•ˆè´Ÿè½½ï¼Œå®ƒä»¬ä¹Ÿæ— æ³•æ»¡è¶³ä¸€ä¸ª 4 å­—çš„åˆ†é…è¯·æ±‚ã€‚å› æ­¤ï¼Œåˆ†é…å™¨å¿…é¡»å°†ç›¸é‚»ç©ºé—²çš„ Block åˆå¹¶ã€‚\nåˆ†é…å™¨å¯ä»¥åœ¨æ¯æ¬¡é‡Šæ”¾ Block åç«‹å³åˆå¹¶ Blockï¼Œä¹Ÿå¯ä»¥ç­‰åˆ°æŸä¸ªæ—¶åˆ»ï¼Œæ¯”å¦‚åˆ†é…è¯·æ±‚å¤±è´¥æ—¶æ‰åˆå¹¶å †ä¸­æ‰€æœ‰ç©ºé—²çš„ Blockã€‚ç«‹å³åˆå¹¶å¾ˆç®€å•ï¼Œä½†å®ƒä¹Ÿæœ‰å¯èƒ½é€ æˆâ€œé¢ ç°¸â€ï¼Œå³æŸä¸ª Block åœ¨çŸ­æ—¶é—´å†…è¢«å¤šæ¬¡åˆå¹¶å’Œåˆ†å‰²ã€‚\nä½¿ç”¨è¾¹ç•Œæ ‡è®°åˆå¹¶ Block æˆ‘ä»¬æŠŠå³å°†é‡Šæ”¾çš„ Block ç§°ä¸ºå½“å‰ï¼ˆCurrentï¼‰Blockï¼Œå…¶å¤´éƒ¨æŒ‡å‘ä¸‹ä¸€ä¸ª Block çš„å¤´éƒ¨ï¼ˆaddr(next_block) = addr(current_block) + block_sizeï¼‰ã€‚å› æ­¤æˆ‘ä»¬å¾ˆå®¹æ˜“åˆ¤æ–­ä¸‹ä¸€ä¸ª Block æ˜¯å¦ç©ºé—²ï¼Œå¹¶ä¸”åªéœ€å°†å½“å‰ Block å¤´éƒ¨ä¸­çš„å¤§å°å­—æ®µä¸ä¹‹ç›¸åŠ å³å¯å®Œæˆåˆå¹¶ã€‚\nä½†è‹¥è¦åˆå¹¶ä¸Šä¸€ä¸ª Blockï¼Œæˆ‘ä»¬åªèƒ½éå†æ•´ä¸ªé“¾è¡¨ï¼Œå¹¶åœ¨åˆ°è¾¾å½“å‰ Block å‰ä¸æ–­è®°ä¸‹ä¸Šä¸€ä¸ª Block çš„ä½ç½®ã€‚å› æ­¤å¯¹äºéšå¼ç©ºé—²é“¾è¡¨ï¼Œåˆå¹¶ä¸Šä¸€ä¸ª Block çš„æ—¶é—´ä¸å †å†…å­˜çš„å¤§å°æˆæ­£æ¯”ã€‚\næˆ‘ä»¬å¯ä»¥åœ¨æ¯ä¸ª Block æœ«å°¾éƒ½æ·»åŠ ä¸€ä¸ªå¤´éƒ¨çš„å‰¯æœ¬ä»¥ä½¿åˆå¹¶ Block çš„æ—¶é—´å˜ä¸ºå¸¸æ•°ï¼Œè¿™ç§æŠ€æœ¯è¢«ç§°ä¸ºè¾¹ç•Œæ ‡è®°ï¼ˆBoundary Tagsï¼‰ï¼š\nä¸Šä¸€ä¸ª Block çš„å°¾éƒ¨å§‹ç»ˆä¸å½“å‰ Block çš„å¤´éƒ¨ç›¸è·ä¸€ä¸ªå­—é•¿ï¼Œå› æ­¤åˆ†é…å™¨å¯ä»¥é€šè¿‡æ£€æŸ¥ä¸Šä¸€ä¸ª Block çš„å°¾éƒ¨æ¥ç¡®å®šå…¶ä½ç½®å’ŒçŠ¶æ€ã€‚ä¸‹å›¾å±•ç¤ºäº†åˆ†é…å™¨æ˜¯å¦‚ä½•ä½¿ç”¨è¾¹ç•Œæ ‡è®°åˆå¹¶ Block çš„ï¼š\nç”±äºæ¯ä¸ª Block éƒ½åŒ…å«å¤´éƒ¨å’Œå°¾éƒ¨ï¼Œå½“ Block æ•°é‡è¾ƒå¤šæ—¶ï¼Œè¾¹ç•Œæ ‡è®°æ˜¾è‘—åœ°å¢åŠ äº†å†…å­˜çš„å¼€é”€ã€‚è€ƒè™‘åˆ°åˆ†é…å™¨åªæœ‰åœ¨ä¸Šä¸€ä¸ª Block ç©ºé—²æ—¶æ‰éœ€è¦è·å–å…¶å°¾éƒ¨å†…çš„ Block å¤§å°ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†ä¸Šä¸€ä¸ª Block çš„çŠ¶æ€å­˜å‚¨åœ¨å½“å‰ Block å¤´éƒ¨çš„å¤šä½™ä½ä½ä¸­ï¼Œè¿™æ ·å·²åˆ†é…çš„ Block ä¾¿ä¸éœ€è¦å°¾éƒ¨äº†ã€‚\næ˜¾å¼ç©ºé—²é“¾è¡¨ ç”±äºåˆ†é… Block çš„æ—¶é—´ä¸ Block çš„æ€»æ•°æˆæ­£æ¯”ï¼Œéšå¼ç©ºé—²é“¾è¡¨ä¸é€‚ç”¨äºé€šç”¨åˆ†é…å™¨ã€‚æˆ‘ä»¬å¯ä»¥åœ¨æ¯ä¸ªç©ºé—² Block ä¸­åŠ å…¥ä¸€ä¸ªæŒ‡å‘ä¸Šä¸€ä¸ªç©ºé—² Block çš„å‰é©±ï¼ˆPredecessorï¼‰æŒ‡é’ˆå’Œä¸€ä¸ªæŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—² Block çš„åç»§ï¼ˆSuccessorï¼‰æŒ‡é’ˆï¼Œè¿™æ ·å †çš„ç»„ç»‡ç»“æ„å°±å˜æˆäº†ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œæˆ‘ä»¬ç§°å…¶ä¸ºæ˜¾å¼ç©ºé—²é“¾è¡¨ï¼ˆExplicit Free Listï¼‰ã€‚\nå¦‚æœé‡‡ç”¨ç¬¬ä¸€æ¬¡æ‹Ÿåˆç­–ç•¥ï¼Œæ˜¾å¼ç©ºé—²é“¾è¡¨åˆ†é… Block çš„æ—¶é—´ä¸ç©ºé—² Block çš„æ•°é‡æˆæ­£æ¯”ï¼Œè€Œé‡Šæ”¾ Block çš„æ—¶é—´åˆ™å–å†³äºç©ºé—² Block çš„æ’åºæ–¹å¼ï¼š\nåè¿›å…ˆå‡ºï¼ˆLast-in First-outï¼ŒLIFOï¼‰ï¼šå°†åˆšè¢«é‡Šæ”¾çš„ Block æ’å…¥åˆ°é“¾è¡¨å¼€å¤´ï¼Œå› æ­¤é‡Šæ”¾ Block çš„æ—¶é—´ä¸ºå¸¸æ•°ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡è¾¹ç•Œæ ‡è®°ä½¿åˆå¹¶ Block çš„æ—¶é—´ä¹Ÿä¸ºå¸¸æ•°ï¼› æŒ‰åœ°å€é¡ºåºï¼ˆAddress Orderï¼‰ï¼šä½¿é“¾è¡¨ä¸­æ¯ä¸ª Block çš„åœ°å€å‡å°äºå…¶åç»§ Block çš„åœ°å€ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé‡Šæ”¾ Block éœ€è¦ä¸€å®šçš„æ—¶é—´æ¥å¯»æ‰¾åˆé€‚çš„ä½ç½®ï¼Œä½†å †å†…å­˜çš„åˆ©ç”¨ç‡æ¯”åè¿›å…ˆå‡ºé«˜ã€‚ æ˜¾å¼ç©ºé—²é“¾è¡¨çš„ç¼ºç‚¹åœ¨äºæŒ‡é’ˆçš„å¼•å…¥å¢åŠ äº†ç©ºé—² Block çš„å¤§å°ï¼Œè¿™å°†å¢å¤§å†…éƒ¨ç¢ç‰‡å‘ç”Ÿçš„å¯èƒ½æ€§ã€‚\nåˆ†ç¦»å¼ç©ºé—²é“¾è¡¨ æˆ‘ä»¬å¯ä»¥å°†å †ç»„ç»‡æˆå¤šä¸ªç©ºé—²é“¾è¡¨ï¼Œæ¯ä¸ªé“¾è¡¨ä¸­ Block çš„å¤§å°éƒ½å¤§è‡´ç›¸åŒï¼Œè¿™ç§ç»“æ„è¢«ç§°ä¸ºåˆ†ç¦»å¼ç©ºé—²é“¾è¡¨ï¼ˆSegregated Free Listï¼‰ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç»“æ„ï¼Œæˆ‘ä»¬éœ€è¦æŠŠ Block çš„å¤§å°åˆ’åˆ†ä¸ºå¤šä¸ªå¤§å°ç±»ï¼ˆSize Classï¼‰ï¼Œå¦‚ï¼š\n$$\\lbrace1\\rbrace, \\lbrace2\\rbrace, \\lbrace3, 4\\rbrace, \\lbrace5â€“8\\rbrace,â€¦, \\lbrace1025â€“2048\\rbrace, \\lbrace2049â€“4096\\rbrace, \\lbrace4097â€“âˆ\\rbrace$$\nä¹Ÿå¯ä»¥è®©æ¯ä¸ªè¾ƒå°çš„ Block ç‹¬è‡ªæˆä¸ºä¸€ä¸ªå¤§å°ç±»ï¼Œè¾ƒå¤§çš„ Block ä¾ç„¶æŒ‰ 2 çš„å¹‚åˆ’åˆ†ï¼š\n$$\\lbrace1\\rbrace, \\lbrace2\\rbrace, \\lbrace3\\rbrace,â€¦, \\lbrace1024\\rbrace, \\lbrace1025â€“2048\\rbrace, \\lbrace2049â€“4096\\rbrace, \\lbrace4097â€“âˆ\\rbrace$$\næ¯ä¸ªç©ºé—²é“¾è¡¨éƒ½å±äºæŸä¸ªå¤§å°ç±»ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†å †çœ‹æˆä¸€ä¸ªæŒ‰å¤§å°ç±»é€’å¢çš„ç©ºé—²é“¾è¡¨æ•°ç»„ã€‚å½“è¿›ç¨‹è¯·æ±‚ä¸€ä¸ª Block æ—¶ï¼Œåˆ†é…å™¨ä¼šæ ¹æ®å…¶å¤§å°åœ¨é€‚å½“çš„ç©ºé—²é“¾è¡¨ä¸­æœç´¢ã€‚å¦‚æœæ‰¾ä¸åˆ°æ»¡è¶³è¦æ±‚çš„ Blockï¼Œå®ƒä¾¿ä¼šç»§ç»­æœç´¢ä¸‹ä¸€ä¸ªé“¾è¡¨ã€‚\nä¸åŒçš„åˆ†ç¦»å¼ç©ºé—²é“¾è¡¨åœ¨å®šä¹‰å¤§å°ç±»çš„æ–¹å¼ã€åˆå¹¶ Block çš„æ—¶æœºä»¥åŠæ˜¯å¦å…è®¸åˆ†å‰² Block ç­‰æ–¹é¢æœ‰æ‰€ä¸åŒï¼Œå…¶ä¸­æœ€åŸºæœ¬çš„ä¸¤ç§ç±»å‹ä¸ºç®€å•åˆ†ç¦»å­˜å‚¨ï¼ˆSimple Segregated Storageï¼‰å’Œåˆ†ç¦»æ‹Ÿåˆï¼ˆSegregated Fitsï¼‰ã€‚\nåœ¨ç®€å•åˆ†ç¦»å­˜å‚¨ä¸­ï¼Œç©ºé—²é“¾è¡¨å†…æ¯ä¸ª Block çš„å¤§å°å‡ç­‰äºå…¶æ‰€å±å¤§å°ç±»ä¸­æœ€å¤§çš„å…ƒç´ ã€‚å¦‚æŸä¸ªå¤§å°ç±»ä¸º {17-32}ï¼Œåˆ™å…¶å¯¹åº”çš„ç©ºé—²é“¾è¡¨ä¸­ Block çš„å¤§å°éƒ½æ˜¯ 32ã€‚\nå½“è¿›ç¨‹è¯·æ±‚ä¸€ä¸ª Block æ—¶ï¼Œåˆ†é…å™¨é€‰å–æ»¡è¶³è¯·æ±‚çš„ç©ºé—²é“¾è¡¨å¹¶åˆ†é…å…¶ä¸­ç¬¬ä¸€ä¸ª Blockï¼›å½“æŸä¸ª Block è¢«é‡Šæ”¾åï¼Œåˆ†é…å™¨å°†å…¶æ’å…¥åˆ°åˆé€‚çš„ç©ºé—²é“¾è¡¨å‰é¢ã€‚å› æ­¤ï¼Œç®€å•åˆ†ç¦»å­˜å‚¨åˆ†é…å’Œé‡Šæ”¾ Block çš„æ—¶é—´å‡ä¸ºå¸¸é‡ã€‚\nä½¿ç”¨åˆ†ç¦»å¼ç©ºé—²é“¾è¡¨çš„åˆ†é…å™¨åªä¼šåœ¨å †ä¸­æŸä¸ªç‰¹å®šéƒ¨åˆ†æœç´¢ç©ºé—² Blockï¼Œå› æ­¤å…¶ååé‡è¾ƒå¤§ï¼›å¯¹åˆ†ç¦»å¼ç©ºé—²é“¾è¡¨ä½¿ç”¨ç¬¬ä¸€æ¬¡æ‹Ÿåˆçš„å†…å­˜åˆ©ç”¨ç‡ä¸å¯¹æ•´ä¸ªå †ä½¿ç”¨æœ€ä½³æ‹Ÿåˆçš„å†…å­˜åˆ©ç”¨ç‡è¿‘ä¼¼ï¼Œå› æ­¤å…¶å†…å­˜åˆ©ç”¨ç‡è¾ƒé«˜ã€‚å¤§å¤šæ•°é«˜æ€§èƒ½çš„åˆ†é…å™¨å‡é‡‡ç”¨åˆ†ç¦»å¼ç©ºé—²é“¾è¡¨ï¼Œå¦‚ C æ ‡å‡†åº“æä¾›çš„ GNU mallocã€‚\nåƒåœ¾å›æ”¶ åƒåœ¾å›æ”¶å™¨ï¼ˆGarbage Collectorï¼‰æ˜¯ä¸€ç§åŠ¨æ€å­˜å‚¨åˆ†é…å™¨ï¼Œå®ƒä¼šè‡ªåŠ¨é‡Šæ”¾ç¨‹åºä¸å†éœ€è¦çš„ Blockï¼ˆåƒåœ¾ï¼‰ã€‚\nåŸºæœ¬æ€æƒ³ åƒåœ¾å›æ”¶å™¨å°†å†…å­˜çœ‹ä½œä¸€ä¸ªæœ‰å‘å¯è¾¾æ€§å›¾ï¼š\nå›¾ä¸­çš„èŠ‚ç‚¹è¢«åˆ†ä¸ºä¸€ç»„æ ¹èŠ‚ç‚¹ï¼ˆRoot Nodesï¼‰å’Œä¸€ç»„å †èŠ‚ç‚¹ï¼ˆHeap Nodesï¼‰ï¼Œæ¯ä¸ªå †èŠ‚ç‚¹éƒ½å¯¹åº”äºä¸€ä¸ªå †ä¸­å·²åˆ†é…çš„ Blockã€‚æœ‰å‘è¾¹ $p \\rarr q$ è¡¨ç¤º Block $p$ ä¸­çš„æŸä¸ªä½ç½®æŒ‡å‘ Block $q$ ä¸­çš„æŸä¸ªä½ç½®ã€‚æ ¹èŠ‚ç‚¹å¯¹åº”äºä¸åœ¨å †ä¸­å´åŒ…å«äº†æŒ‡å‘å †çš„æŒ‡é’ˆçš„ä½ç½®ï¼Œè¿™äº›ä½ç½®å¯ä»¥æ˜¯å¯„å­˜å™¨ã€æ ˆä¸­çš„å˜é‡æˆ–å¯è¯»å†™æ•°æ®åŒºåŸŸä¸­çš„å…¨å±€å˜é‡ã€‚\nå¦‚æœæ ¹èŠ‚ç‚¹ä¸å †èŠ‚ç‚¹ä¹‹é—´å­˜åœ¨ä¸€æ¡æœ‰å‘è·¯å¾„ï¼Œæˆ‘ä»¬å°±ç§°è¯¥å †èŠ‚ç‚¹æ˜¯å¯è¾¾çš„ï¼ˆReachableï¼‰ã€‚åœ¨ä»»ä½•æ—¶åˆ»ï¼Œä¸å¯è¾¾çš„èŠ‚ç‚¹éƒ½ä¸ç¨‹åºä¸å†ä½¿ç”¨çš„ Block å¯¹åº”ã€‚åƒåœ¾å›æ”¶å™¨å®šæœŸé‡Šæ”¾ä¸å¯è¾¾èŠ‚ç‚¹å¹¶å°†å…¶è¿”å›åˆ°ç©ºé—²é“¾è¡¨ã€‚\nML å’Œ Java ç­‰è¯­è¨€çš„åƒåœ¾å›æ”¶å™¨å¯¹åº”ç”¨ç¨‹åºä½¿ç”¨æŒ‡é’ˆçš„æ–¹å¼è¿›è¡Œäº†ä¸¥æ ¼çš„é™åˆ¶ï¼Œå› æ­¤å®ƒå¯ä»¥ç»´æŠ¤ä¸€ä¸ªç²¾ç¡®çš„å¯è¾¾æ€§å›¾ï¼Œä»è€Œå›æ”¶æ‰€æœ‰çš„åƒåœ¾ã€‚è€Œ C å’Œ C++ ç­‰è¯­è¨€çš„åƒåœ¾å›æ”¶å™¨åˆ™æ— æ³•ä¿è¯å¯è¾¾æ€§å›¾çš„ç²¾ç¡®æ€§ï¼Œä¸€äº›ä¸å¯è¾¾çš„èŠ‚ç‚¹å¯èƒ½è¢«é”™è¯¯åœ°è¯†åˆ«ä¸ºå¯è¾¾çš„ï¼Œæˆ‘ä»¬ç§°å…¶ä¸ºä¿å®ˆåƒåœ¾å›æ”¶å™¨ï¼ˆConservative Garbage Collectorï¼‰ã€‚\nåƒåœ¾å›æ”¶å™¨å¯ä»¥æŒ‰éœ€æä¾›æœåŠ¡ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºå•ç‹¬çš„è¿›ç¨‹ä¸åº”ç”¨ç¨‹åºå¹¶è¡Œè¿è¡Œï¼Œä¸æ–­æ›´æ–°å¯è¾¾æ€§å›¾å¹¶å›æ”¶åƒåœ¾ï¼š\nMark\u0026Sweep ç®—æ³• Mark\u0026Sweep æ˜¯å¸¸ç”¨çš„åƒåœ¾å›æ”¶ç®—æ³•ä¹‹ä¸€ï¼Œå®ƒåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š\næ ‡è®°ï¼ˆMarkï¼‰é˜¶æ®µï¼šæ ‡è®°æ‰€æœ‰å¯è¾¾çš„æ ¹èŠ‚ç‚¹åä»£ã€‚é€šå¸¸æˆ‘ä»¬å°† Block å¤´éƒ¨çš„å¤šä½™ä½ä½ä¹‹ä¸€ç”¨äºæŒ‡ç¤ºè¯¥ Block æ˜¯å¦è¢«æ ‡è®°ï¼› æ¸…é™¤ï¼ˆSweepï¼‰é˜¶æ®µï¼šé‡Šæ”¾æ‰€æœ‰æœªæ ‡è®°ä¸”å·²åˆ†é…çš„ Blockã€‚ ä¸ºäº†æ›´å¥½åœ°ç†è§£ Mark\u0026Sweep ç®—æ³•ï¼Œæˆ‘ä»¬ä½œå‡ºä»¥ä¸‹å‡è®¾ï¼š\nptrï¼šç”±typedef void *ptrå®šä¹‰çš„ç±»å‹ï¼› ptr isPtr(ptr p)ï¼šè‹¥pæŒ‡å‘å·²åˆ†é… Block ä¸­çš„æŸä¸ªå­—ï¼Œåˆ™è¿”å›æŒ‡å‘è¯¥ Block èµ·å§‹ä½ç½®çš„æŒ‡é’ˆbï¼Œå¦åˆ™è¿”å›NULLï¼› int blockMarked(ptr b)ï¼šå¦‚æœè¯¥ Block å·²è¢«æ ‡è®°åˆ™è¿”å›trueï¼› int blockAllocated(ptr b)ï¼šå¦‚æœè¯¥ Block å·²åˆ†é…åˆ™è¿”å›trueï¼› void markBlock(ptr b)ï¼šæ ‡è®° Blockï¼› int length(ptr b)ï¼šè¿”å› Block é™¤å¤´éƒ¨å¤–çš„å­—é•¿ï¼› void unmarkBlock(ptr b)ï¼šå°† Block çš„çŠ¶æ€ä»å·²æ ‡è®°è½¬æ¢ä¸ºæœªæ ‡è®°ï¼› ptr nextBlock(ptr b)ï¼šè¿”å›æŒ‡å‘ä¸‹ä¸€ä¸ª Block çš„æŒ‡é’ˆã€‚ é‚£ä¹ˆæ­¤ç®—æ³•å°±å¯ä»¥ç”¨ä¸‹å›¾ä¸­çš„ä¼ªç è¡¨ç¤ºï¼š\nåœ¨æ ‡è®°é˜¶æ®µï¼Œåƒåœ¾å›æ”¶å™¨ä¸ºæ¯ä¸ªæ ¹èŠ‚ç‚¹è°ƒç”¨ä¸€æ¬¡markå‡½æ•°ã€‚è‹¥pæœªæŒ‡å‘å·²åˆ†é…ä¸”æœªæ ‡è®°çš„ Blockï¼Œåˆ™è¯¥å‡½æ•°ç›´æ¥è¿”å›ã€‚å¦åˆ™ï¼Œå®ƒæ ‡è®°è¯¥ Block å¹¶å°†å…¶ä¸­çš„æ¯ä¸ªå­—ä½œä¸ºå‚æ•°é€’å½’åœ°è°ƒç”¨è‡ªèº«ï¼ˆmark(b[i])ï¼‰ã€‚æ­¤é˜¶æ®µç»“æŸæ—¶ï¼Œä»»ä½•æœªæ ‡è®°ä¸”å·²åˆ†é…çš„ Block éƒ½æ˜¯ä¸å¯è¾¾çš„ï¼›åœ¨æ‰«æé˜¶æ®µï¼Œåƒåœ¾å›æ”¶å™¨åªè°ƒç”¨ä¸€æ¬¡sweepå‡½æ•°ã€‚è¯¥å‡½æ•°éå†å †ä¸­çš„æ¯ä¸€ä¸ª Blockï¼Œé‡Šæ”¾æ‰€æœ‰å·²åˆ†é…ä¸”æœªæ ‡è®°çš„ Blockã€‚\nä¸Šå›¾ä¸­çš„æ¯ä¸ªæ–¹æ¡†ä»£è¡¨ä¸€ä¸ªå­—ï¼Œæ¯ä¸ªè¢«ç²—çº¿åˆ†éš”çš„çŸ©å½¢ä»£è¡¨ä¸€ä¸ª Blockï¼Œè€Œæ¯ä¸ª Block éƒ½æœ‰ä¸€ä¸ªå•å­—çš„å¤´éƒ¨ã€‚æœ€åˆï¼Œå †ä¸­æœ‰ 6 ä¸ªå·²åˆ†é…ä¸”æœªæ ‡è®°çš„ Blockã€‚Block 3 ä¸­åŒ…å«æŒ‡å‘ Block 1 çš„æŒ‡é’ˆï¼ŒBlock 4 ä¸­åŒ…å«æŒ‡å‘ Block 3 å’Œ 6 çš„æŒ‡é’ˆã€‚æ ¹èŠ‚ç‚¹æŒ‡å‘ Block 4ï¼Œå› æ­¤ Block 1ã€3ã€4 å’Œ 6 ä»æ ¹èŠ‚ç‚¹å¯è¾¾ï¼Œå®ƒä»¬ä¼šè¢«åƒåœ¾å›æ”¶å™¨æ ‡è®°ã€‚åœ¨æ‰«æé˜¶æ®µå®Œæˆåï¼Œå‰©ä½™ä¸å¯è¾¾çš„ Block 2 å’Œ 5 å°†è¢«é‡Šæ”¾ã€‚\n","description":"","tags":["OS"],"title":"CSAPP è¯»ä¹¦ç¬”è®°ï¼šè™šæ‹Ÿå†…å­˜","uri":"/posts/virtual-memory-note/"},{"content":"é“¾æ¥ï¼ˆLinkingï¼‰æ˜¯å°†å„éƒ¨åˆ†ä»£ç å’Œæ•°æ®æ”¶é›†å¹¶ç»„æˆå•ä¸ªæ–‡ä»¶çš„è¿‡ç¨‹ï¼Œè¯¥æ–‡ä»¶å¯ä»¥è¢«åŠ è½½ï¼ˆå¤åˆ¶ï¼‰åˆ°å†…å­˜ä¸­æ‰§è¡Œã€‚é“¾æ¥å¯ä»¥åœ¨ç¼–è¯‘æ—¶ï¼ˆå³æºä»£ç è¢«ç¿»è¯‘æˆæœºå™¨ä»£ç æ—¶ï¼‰æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥åœ¨åŠ è½½æ—¶ï¼ˆå³ç¨‹åºè¢«åŠ è½½åˆ°å†…å­˜å¹¶ç”±åŠ è½½å™¨æ‰§è¡Œæ—¶ï¼‰æ‰§è¡Œï¼Œç”šè‡³è¿˜å¯ä»¥åœ¨è¿è¡Œæ—¶ç”±åº”ç”¨ç¨‹åºæ‰§è¡Œã€‚åœ¨ç°ä»£ç³»ç»Ÿä¸­ï¼Œèƒ½å¤Ÿè‡ªåŠ¨æ‰§è¡Œé“¾æ¥çš„ç¨‹åºè¢«ç§°ä¸ºé“¾æ¥å™¨ï¼ˆLinkerï¼‰ã€‚\né“¾æ¥å™¨æ”¯æŒå•ç‹¬ç¼–è¯‘ï¼ˆSeparate Compilationï¼‰ï¼Œå› æ­¤åœ¨è½¯ä»¶å¼€å‘ä¸­èµ·ç€è‡³å…³é‡è¦çš„ä½œç”¨ã€‚ä¸å…¶å°†å¤§å‹åº”ç”¨ç¨‹åºç»„ç»‡ä¸ºä¸€ä¸ªå•ä¸€çš„å¤§å—æºæ–‡ä»¶ï¼Œä¸å¦‚å°†å…¶åˆ†è§£ä¸ºä¸€äº›æ›´å°ã€æ›´æ˜“äºç®¡ç†å¹¶ä¸”å¯ä»¥å•ç‹¬ä¿®æ”¹å’Œç¼–è¯‘çš„æ¨¡å—ã€‚ä¸€æ—¦æˆ‘ä»¬ä¿®æ”¹äº†å…¶ä¸­çš„æŸä¸ªæ¨¡å—ï¼Œåªéœ€é‡æ–°ç¼–è¯‘è¯¥æ¨¡å—å¹¶å°†å…¶é“¾æ¥åˆ°åº”ç”¨ç¨‹åºï¼Œä¸å¿…å†æ¬¡ç¼–è¯‘å…¶ä»–æ–‡ä»¶ã€‚\nç¼–è¯‘å™¨é©±åŠ¨ å¤§å¤šæ•°ç¼–è¯‘ç³»ç»Ÿéƒ½æä¾›äº†ä¸€ä¸ªç¼–è¯‘å™¨é©±åŠ¨ï¼ˆCompiler Driverï¼‰ï¼Œå®ƒå¯ä»¥æ ¹æ®ç”¨æˆ·éœ€æ±‚è°ƒç”¨è¯­è¨€é¢„å¤„ç†å™¨ï¼ˆLanguage Preprocessorï¼‰ã€ç¼–è¯‘å™¨ã€æ±‡ç¼–å™¨å’Œé“¾æ¥å™¨ç­‰ã€‚ä¾‹å¦‚è¦åœ¨ GNU ç¼–è¯‘ç³»ç»Ÿä¸­æ„å»ºä¸‹åˆ—ç¨‹åºï¼Œæˆ‘ä»¬å¯ä»¥ ä½¿ç”¨å‘½ä»¤gcc -Og -o prog main.c sum.c:\nç¼–è¯‘å™¨é©±åŠ¨å°†ç¤ºä¾‹ç¨‹åºä» ASCII æºæ–‡ä»¶è½¬æ¢ä¸ºå¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶æ—¶çš„è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\né¦–å…ˆï¼Œé©±åŠ¨è¿è¡Œ C é¢„å¤„ç†å™¨ï¼ˆC Preprocessorï¼ŒCPPï¼‰ï¼Œå°†æºæ–‡ä»¶main.cè½¬æ¢ä¸º ASCII ä¸­é—´æ–‡ä»¶main.iï¼›æ¥ä¸‹æ¥ï¼Œé©±åŠ¨è¿è¡Œ C ç¼–è¯‘å™¨ (C Compilerï¼ŒCC)ï¼Œå°†main.iè½¬æ¢ä¸º ASCII æ±‡ç¼–è¯­è¨€æ–‡ä»¶main.sï¼›ç„¶åï¼Œé©±åŠ¨è¿è¡Œæ±‡ç¼–å™¨ï¼Œå°†main.sè½¬æ¢ä¸ºäºŒè¿›åˆ¶å¯é‡å®šä½ï¼ˆRelocatableï¼‰ç›®æ ‡æ–‡ä»¶main.oï¼ˆsum.oçš„ç”Ÿæˆè¿‡ç¨‹ç›¸åŒï¼‰ï¼›æœ€åï¼Œé©±åŠ¨è¿è¡Œé“¾æ¥å™¨ï¼Œå°†main.oã€sum.oå’Œä¸€äº›å¿…è¦çš„ç³»ç»Ÿç›®æ ‡æ–‡ä»¶ç»„åˆï¼Œåˆ›å»ºäºŒè¿›åˆ¶å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶progã€‚\né™æ€é“¾æ¥ é™æ€é“¾æ¥å™¨ï¼ˆStatic Linkerï¼‰å°†å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶å’Œå‘½ä»¤è¡Œå‚æ•°ä½œä¸ºè¾“å…¥ï¼Œç”Ÿæˆå®Œå…¨é“¾æ¥çš„å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ã€‚å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ç”±å„ç§ä»£ç å’Œæ•°æ®ç»„æˆï¼ŒæŒ‡ä»¤ã€åˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œæœªåˆå§‹åŒ–çš„å˜é‡åˆ†åˆ«å¤„äºä¸åŒéƒ¨åˆ†ã€‚\né“¾æ¥å™¨éœ€è¦å®Œæˆä¸¤ä¸ªä¸»è¦ä»»åŠ¡ï¼š\nç¬¦å·è§£æï¼ˆSymbol Resolutionï¼‰ï¼šç›®æ ‡æ–‡ä»¶å®šä¹‰å¹¶å¼•ç”¨ç¬¦å·ï¼Œæ¯ä¸ªç¬¦å·å¯¹åº”ä¸€ä¸ªå‡½æ•°ã€å…¨å±€å˜é‡æˆ–é™æ€å˜é‡ï¼ˆå³ä½¿ç”¨staticå£°æ˜çš„ä»»ä½•å˜é‡ï¼‰ã€‚ç¬¦å·è§£æçš„ç›®çš„æ˜¯å°†æ¯ä¸ªç¬¦å·å¼•ç”¨ä¸ä¸€ä¸ªç¬¦å·å®šä¹‰ç›¸å…³è”ï¼› é‡å®šä½ï¼ˆRelocationï¼‰ï¼šç¼–è¯‘å™¨å’Œæ±‡ç¼–å™¨ç”Ÿæˆçš„ä»£ç å’Œæ•°æ®æ®µæ˜¯ä»åœ°å€ 0 å¼€å§‹çš„ï¼Œé“¾æ¥å™¨ä¼šé‡å®šä½æ‰€æœ‰çš„ç¬¦å·å®šä¹‰å¹¶ä¿®æ”¹å…¶å¯¹åº”çš„ç¬¦å·å¼•ç”¨ã€‚ ç›®æ ‡æ–‡ä»¶åªæ˜¯å­—èŠ‚å—çš„é›†åˆï¼Œå…¶ä¸­å¯èƒ½åŒ…å«ä»£ç ã€æ•°æ®æˆ–æŒ‡å¯¼é“¾æ¥å™¨å’ŒåŠ è½½å™¨çš„æ•°æ®ç»“æ„ã€‚é“¾æ¥å™¨å°†å„ä¸ªå—è¿æ¥åœ¨ä¸€èµ·ï¼Œç¡®å®šæ•´ä¸ªå—çš„è¿è¡Œæ—¶ä½ç½®ï¼Œå¹¶ä¿®æ”¹ä»£ç å’Œæ•°æ®å—ä¸­çš„ä¸åŒä½ç½®ã€‚ç¼–è¯‘å™¨å’Œæ±‡ç¼–å™¨åœ¨ç”Ÿæˆç›®æ ‡æ–‡ä»¶æ—¶å·²ç»å®Œæˆäº†å¤§éƒ¨åˆ†å·¥ä½œï¼Œå› è€Œé“¾æ¥å™¨å¯¹ç›®æ ‡æœºå™¨çš„äº†è§£ç”šå°‘ã€‚\nç›®æ ‡æ–‡ä»¶ ç›®æ ‡æ–‡ä»¶ï¼ˆObject Fileï¼‰æœ‰ä¸‰ç§å½¢å¼ï¼š\nå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ï¼šåŒ…å«äºŒè¿›åˆ¶ä»£ç å’Œæ•°æ®ï¼Œå¯ä»¥åœ¨ç¼–è¯‘æ—¶ä¸å…¶ä»–å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ç»„åˆä»¥åˆ›å»ºå¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ï¼› å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ï¼šåŒ…å«äºŒè¿›åˆ¶ä»£ç å’Œæ•°æ®å½¢å¼ï¼Œå¯ç›´æ¥è¢«å¤åˆ¶åˆ°å†…å­˜ä¸­æ‰§è¡Œï¼› å…±äº«ç›®æ ‡æ–‡ä»¶ï¼šä¸€ç§ç‰¹æ®Šç±»å‹çš„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ï¼Œå¯ä»¥åœ¨åŠ è½½æ—¶æˆ–è¿è¡Œæ—¶è¢«åŠ è½½åˆ°å†…å­˜ä¸­å¹¶åŠ¨æ€é“¾æ¥ã€‚ å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ å…¸å‹çš„ ELFï¼ˆExecutable and Linkable Formatï¼‰å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶æ ¼å¼å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nELF å¤´ï¼ˆELF Headerï¼‰ï¼šå¼€å¤´æ˜¯ä¸€ä¸ªè¡¨å¾ç³»ç»Ÿå­—é•¿ï¼ˆWord Sizeï¼‰å’Œå­—èŠ‚é¡ºåºï¼ˆByte Orderingï¼‰çš„ 16 å­—èŠ‚åºåˆ—ã€‚å…¶ä½™éƒ¨åˆ†åŒ…æ‹¬ ELF å¤´çš„å¤§å°ã€ç›®æ ‡æ–‡ä»¶çš„ç±»å‹ï¼ˆå¦‚å¯é‡å®šä½ã€å¯æ‰§è¡Œæˆ–å…±äº«ï¼‰ã€æœºå™¨ç±»å‹ï¼ˆå¦‚ x86-64ï¼‰ã€èŠ‚å¤´è¡¨ï¼ˆSection Header Tableï¼‰çš„æ–‡ä»¶åç§»é‡ä»¥åŠå…¶ä¸­æ¡ç›®çš„å¤§å°å’Œæ•°é‡ï¼› èŠ‚å¤´è¡¨ï¼šæè¿°äº†ç›®æ ‡æ–‡ä»¶ä¸­æ¯ä¸ª Section çš„ä½ç½®å’Œå¤§å°ï¼› Sectionï¼šä½äº ELF å¤´å’ŒèŠ‚å¤´è¡¨ä¹‹é—´ï¼ŒåŒ…æ‹¬ï¼š .textï¼šç¼–è¯‘åç¨‹åºçš„æœºå™¨ç ï¼› .rodataï¼šåªè¯»æ•°æ®ï¼Œä¾‹å¦‚printfä¸­çš„æ ¼å¼å­—ç¬¦ä¸²ï¼ŒSwitch è¯­å¥çš„ è·³è½¬è¡¨ ç­‰ï¼› .dataï¼šå·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ã€‚éé™æ€å±€éƒ¨å˜é‡åœ¨è¿è¡Œæ—¶ä½äºæ ˆä¸­ï¼Œä¸ä¼šå‡ºç°åœ¨ .data æˆ– .bss ä¸­ï¼› .bssï¼šæœªåˆå§‹åŒ–çš„é™æ€å˜é‡ï¼Œä»¥åŠåˆå§‹åŒ–ä¸º 0 çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ã€‚æ­¤ Section åªæ˜¯ä¸€ä¸ªå ä½ç¬¦ï¼Œåœ¨ç›®æ ‡æ–‡ä»¶ä¸­ä¸å ç”¨å®é™…ç©ºé—´ï¼Œå› æ­¤å¯ä»¥æå‡ç©ºé—´æ•ˆç‡ã€‚è¿™äº›å˜é‡åœ¨è¿è¡Œæ—¶è¢«åˆ†é…åˆ°å†…å­˜ä¸­ï¼Œåˆå§‹å€¼ä¸ºé›¶ï¼› .symtab ï¼šä¸€ä¸ªä¿å­˜äº†åœ¨ç¨‹åºä¸­è¢«å®šä¹‰å’Œå¼•ç”¨çš„å‡½æ•°å’Œå…¨å±€å˜é‡ä¿¡æ¯çš„ç¬¦å·è¡¨ï¼ˆSymbol Tableï¼‰ã€‚ä¸ç¼–è¯‘å™¨ä¸­çš„ç¬¦å·è¡¨ä¸åŒï¼Œ.symtab ä¸­çš„ç¬¦å·è¡¨ä¸åŒ…å«ä»»ä½•å±€éƒ¨å˜é‡ï¼› .rel.textï¼šå½“é“¾æ¥å™¨å°†ç›®æ ‡æ–‡ä»¶ä¸å…¶ä»–æ–‡ä»¶ç»„åˆæ—¶ï¼Œ.text ä¸­çš„è®¸å¤šä½ç½®éƒ½éœ€è¦è¢«ä¿®æ”¹ï¼Œè€Œ .rel.text ä¸­åˆ™ä¿å­˜äº†ä¸ä¹‹ç›¸å…³çš„é‡å®šä½ä¿¡æ¯ã€‚é€šå¸¸ï¼Œä»»ä½•è°ƒç”¨å¤–éƒ¨å‡½æ•°æˆ–å¼•ç”¨å…¨å±€å˜é‡çš„æŒ‡ä»¤éƒ½éœ€è¦è¢«ä¿®æ”¹ï¼Œè€Œè°ƒç”¨å±€éƒ¨å‡½æ•°çš„æŒ‡ä»¤åˆ™ä¸å˜ã€‚å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ä¸€èˆ¬ä¸éœ€è¦é‡å®šä½ä¿¡æ¯ï¼Œå› æ­¤è¿™éƒ¨åˆ†å¯ä»¥çœç•¥ï¼› .rel.dataï¼šè¢«å¼•ç”¨æˆ–å®šä¹‰çš„ä»»ä½•å…¨å±€å˜é‡çš„é‡å®šä½ä¿¡æ¯ã€‚é€šå¸¸ï¼Œæ‰€æœ‰åˆå§‹å€¼ä¸ºå…¨å±€å˜é‡åœ°å€æˆ–å¤–éƒ¨å®šä¹‰å‡½æ•°åœ°å€çš„å·²åˆå§‹åŒ–å…¨å±€å˜é‡éƒ½éœ€è¦è¢«ä¿®æ”¹ï¼› .debugï¼šè°ƒè¯•ç¬¦å·è¡¨ï¼Œä»…åœ¨ä½¿ç”¨-gé€‰é¡¹è°ƒç”¨ç¼–è¯‘å™¨é©±åŠ¨æ—¶å‡ºç°ï¼› .lineï¼šåŸå§‹ç¨‹åºä¸­è¡Œå·ä¸ .text ä¸­æœºå™¨ä»£ç æŒ‡ä»¤ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œä»…åœ¨ä½¿ç”¨-gé€‰é¡¹è°ƒç”¨ç¼–è¯‘å™¨é©±åŠ¨æ—¶å‡ºç°ï¼› .strtabï¼šä¸€ä¸ªä»¥NULLç»“å°¾ï¼ŒåŒ…å« .symtab å’Œ .debug ä¸­çš„ç¬¦å·è¡¨ä»¥åŠ Section åç§°çš„å­—ç¬¦ä¸²åºåˆ—ã€‚ ç¬¦å·å’Œç¬¦å·è¡¨ æ¯ä¸ªç›®æ ‡æ–‡ä»¶éƒ½æœ‰ä¸€ä¸ªç¬¦å·è¡¨ï¼Œå…¶ä¸­åŒ…å«äº†è¯¥æ–‡ä»¶æ‰€å®šä¹‰å’Œå¼•ç”¨çš„ç¬¦å·ä¿¡æ¯ã€‚ç¬¦å·æœ‰ä»¥ä¸‹ä¸‰ç§ï¼š\nå…¨å±€ç¬¦å·ï¼ˆGlobal Symbolsï¼‰ï¼šç”±è¯¥æ–‡ä»¶å®šä¹‰å¹¶ä¸”å¯ä»¥è¢«å…¶ä»–æ–‡ä»¶å¼•ç”¨çš„ç¬¦å·ï¼› å¤–éƒ¨ç¬¦å·ï¼ˆExternalsï¼‰ï¼šè¢«è¯¥æ–‡ä»¶å¼•ç”¨ä½†ç”±å…¶ä»–æ–‡ä»¶å®šä¹‰çš„ç¬¦å·ï¼› å±€éƒ¨ç¬¦å·ï¼ˆLocal Symbolsï¼‰ï¼šç”±è¯¥æ–‡ä»¶å®šä¹‰ä¸”æ— æ³•è¢«å…¶ä»–æ–‡ä»¶å¼•ç”¨çš„ç¬¦å·ï¼Œå³ä½¿ç”¨staticå£°æ˜çš„å‡½æ•°å’Œå˜é‡ã€‚ ä¸ŠèŠ‚æåˆ°ï¼Œéé™æ€å±€éƒ¨å˜é‡åœ¨è¿è¡Œæ—¶ä½äºæ ˆä¸­ï¼Œä¸é“¾æ¥å™¨æ— å…³ã€‚è€Œé™æ€å±€éƒ¨å˜é‡åˆ™ä¿å­˜åœ¨ .data æˆ– .bss ä¸­ï¼Œç¼–è¯‘å™¨ä¼šåœ¨ç¬¦å·è¡¨ä¸­ä¸ºå…¶åˆ›å»ºåç§°å”¯ä¸€çš„å±€éƒ¨ç¬¦å·ã€‚ä¾‹å¦‚åŒä¸€æ–‡ä»¶ä¸­çš„ä¸¤ä¸ªå‡½æ•°éƒ½å®šä¹‰äº†é™æ€å±€éƒ¨å˜é‡xï¼š\n1 2 3 4 5 6 7 8 9 10 int f() { static int x = 0; return x; } int g() { static int x = 1; return x; } é‚£ä¹ˆç¼–è¯‘å™¨å¯èƒ½å°†x.1ä½œä¸ºå‡½æ•°f()ä¸­çš„å˜é‡ç¬¦å·ï¼Œå°†x.2ä½œä¸ºå‡½æ•°g()ä¸­çš„å˜é‡ç¬¦å·å‘é€ç»™æ±‡ç¼–å™¨ã€‚æ±‡ç¼–å™¨ä½¿ç”¨æ¥æ”¶åˆ°çš„.sæ–‡ä»¶ä¸­çš„ç¬¦å·æ„å»ºç¬¦å·è¡¨ï¼Œå…¶ä¸­æ¯ä¸ªæ¡ç›®çš„æ•°æ®ç»“æ„ä¸ºï¼š\nnameï¼šç¬¦å·ååœ¨å­—ç¬¦ä¸²è¡¨ .strtab ä¸­çš„åç§»é‡ï¼› valueï¼šå¯¹äºå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶æ˜¯ç¬¦å·åœ¨å…¶ Section ä¸­çš„åç§»é‡ï¼Œå¯¹äºå¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶æ˜¯ç¬¦å·çš„è¿è¡Œæ—¶åœ°å€ï¼› sizeï¼šç¬¦å·çš„å¤§å°ï¼› typeï¼šç¬¦å·çš„ç±»å‹ï¼› bindingï¼šç¬¦å·æ˜¯å±€éƒ¨çš„è¿˜æ˜¯å…¨å±€çš„ï¼› sectionï¼šç¬¦å·æ‰€åœ¨çš„ Section åœ¨èŠ‚å¤´è¡¨ä¸­çš„ç´¢å¼•ã€‚ å€¼å¾—ä¸€æçš„æ˜¯ï¼Œæœ‰ä¸‰ä¸ªä¼ª Section åœ¨èŠ‚å¤´è¡¨ä¸­æ²¡æœ‰æ¡ç›®ï¼š\nABSï¼šä¸åº”é‡å®šä½çš„ç¬¦å·ï¼› UNDEFï¼šåœ¨æ­¤æ–‡ä»¶ä¸­å¼•ç”¨ä½†åœ¨å…¶ä»–æ–‡ä»¶ä¸­å®šä¹‰çš„ç¬¦å·ï¼› COMMONï¼šæœªåˆå§‹åŒ–çš„å…¨å±€ç¬¦å·ã€‚ ä¸Šè¿°ä¸‰ä¸ª Section ä»…å­˜åœ¨äºå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ï¼Œåœ¨å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ä¸­å¹¶ä¸å­˜åœ¨ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ READELF å·¥å…·é˜…è¯»ç›®æ ‡æ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œç¤ºä¾‹ç¨‹åº main.c ç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶ç¬¦å·è¡¨æ¡ç›®å¦‚ä¸‹ï¼š\nREADELF é€šè¿‡æ•´æ•°ç´¢å¼• Ndx æ ‡è¯†æ¯ä¸ª Sectionï¼Œ1 è¡¨ç¤º .textï¼Œ3 è¡¨ç¤º .dataã€‚å…¨å±€ç¬¦å·mainå’Œarrayåˆ†åˆ«ä½äºä¸Šè¿°ä¸¤ä¸ª Section é¦–éƒ¨ï¼Œå› æ­¤å…¶åç§»é‡valueå‡ä¸º 0ã€‚å¤–éƒ¨ç¬¦å·sumæœªåœ¨æœ¬æ–‡ä»¶ä¸­å®šä¹‰ï¼Œä½äº UNDEFã€‚\nç¬¦å·è§£æ é“¾æ¥å™¨å°†æ¯ä¸ªç¬¦å·å¼•ç”¨ä¸ç¬¦å·è¡¨ä¸­çš„ç¬¦å·å®šä¹‰ç›¸å…³è”ä»¥å®Œæˆç¬¦å·è§£æï¼ˆSymbol Resolutionï¼‰ã€‚å½“ç¼–è¯‘å™¨é‡åˆ°æœªåœ¨å½“å‰æ–‡ä»¶ä¸­å®šä¹‰çš„ç¬¦å·æ—¶ï¼Œå®ƒä¼šå‡è®¾è¯¥ç¬¦å·å·²åœ¨å…¶ä»–æ–‡ä»¶ä¸­å®šä¹‰ï¼Œç„¶åç”Ÿæˆå¯¹åº”çš„ç¬¦å·è¡¨æ¡ç›®ã€‚å¦‚æœé“¾æ¥å™¨æ— æ³•åœ¨ä»»ä½•è¾“å…¥æ–‡ä»¶ä¸­æ‰¾åˆ°è¯¥ç¬¦å·çš„å®šä¹‰ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šç»ˆæ­¢é“¾æ¥ã€‚\nä¸åŒæ–‡ä»¶å¯èƒ½å®šä¹‰äº†ç›¸åŒåç§°çš„å…¨å±€ç¬¦å·ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œé“¾æ¥å™¨è¦ä¹ˆç›´æ¥æŠ¥é”™ï¼Œè¦ä¹ˆé€‰å–å…¶ä¸­ä¹‹ä¸€ã€‚\nC++ å’Œ Java å…è®¸é‡è½½åç§°ç›¸åŒä½†å‚æ•°åˆ—è¡¨ä¸åŒçš„æ–¹æ³•ã€‚ç¼–è¯‘å™¨ä¼šå°†æ¯ä¸ªæ–¹æ³•å’Œå‚æ•°åˆ—è¡¨ç»„åˆä¸ºä¸€ä¸ªå”¯ä¸€çš„åç§°ï¼Œè¿™æ ·é“¾æ¥å™¨å°±å¯ä»¥åŒºåˆ†å®ƒä»¬ã€‚ä¾‹å¦‚ï¼ŒFoo::bar(int, long)ä¼šè¢«ç¼–ç ä¸ºbar__3Fooilã€‚å…¶ä¸­ï¼Œ3 ä»£è¡¨ç±»å Foo çš„å­—ç¬¦æ•°ï¼Œi å’Œ l åˆ™åˆ†åˆ«ä»£è¡¨å‚æ•°åˆ—è¡¨ä¸­çš„intå’Œlongã€‚\nè§£æåç§°é‡å¤çš„ç¬¦å· Linux ç¼–è¯‘ç³»ç»Ÿä¼šåœ¨ç¼–è¯‘æ—¶å°†å…¨å±€ç¬¦å·åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼šå‡½æ•°å’Œå·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡æ˜¯å¼ºç¬¦å·ï¼Œæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡æ˜¯å¼±ç¬¦å·ã€‚æ±‡ç¼–å™¨å°†ç¬¦å·çš„å¼ºå¼±ä¿¡æ¯éšå¼åœ°ç¼–ç åˆ°ç›®æ ‡æ–‡ä»¶çš„ç¬¦å·è¡¨ä¸­ã€‚\né“¾æ¥å™¨è§£æåç§°é‡å¤çš„ç¬¦å·çš„è§„åˆ™ä¸ºï¼š\nä¸å…è®¸å¤šä¸ªå¼ºç¬¦å·åç§°é‡å¤ï¼› è‹¥ä¸€ä¸ªå¼ºç¬¦å·å’Œå¤šä¸ªå¼±ç¬¦å·åç§°é‡å¤ï¼Œé€‰æ‹©å¼ºç¬¦å·ï¼› è‹¥å¤šä¸ªå¼±ç¬¦å·åç§°é‡å¤ï¼Œä»ä¸­ä»»é€‰å…¶ä¸€ã€‚ æ³¨ï¼šæœ€æ–°ç‰ˆæœ¬çš„ GCCï¼ˆå¦‚ GCC 10ï¼‰é»˜è®¤ä½¿ç”¨æ ‡è¯†ä½-fno-commonï¼Œå› æ­¤è‹¥ç¨‹åºåŒ…å«å¤šä¸ªåç§°é‡å¤çš„å¼±ç¬¦å·å°†å¼•å‘é“¾æ¥é”™è¯¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 /* foo3.c */ #include \u003cstdio.h\u003e void f(void); int x = 15213; int main() { f(); printf(\"x = %d\\n\", x); return 0; } /* bar3.c */ int x; void f() { x = 15212; } ç¤ºä¾‹ç¨‹åºä¸­ï¼Œæ–‡ä»¶bar3.cä¸­çš„å‡½æ•°fæ˜¯å¼ºç¬¦å·ï¼Œæ–‡ä»¶foo3.cä¸­çš„å‡½æ•°fæ˜¯å¼±ç¬¦å·ï¼Œå› æ­¤ä¸»å‡½æ•°çš„è¾“å‡ºxçš„å€¼ä¸º 15212ã€‚\nä¸Šæ–‡æåˆ°ï¼Œæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ä¿å­˜åœ¨ COMMON ä¸­ï¼Œè€Œæœªåˆå§‹åŒ–çš„é™æ€å˜é‡ï¼Œä»¥åŠåˆå§‹åŒ–ä¸º 0 çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ä¿å­˜åœ¨ .bss ä¸­ã€‚è¿™æ˜¯å› ä¸ºå‰è€…æ˜¯å¼±ç¬¦å·ï¼Œç¼–è¯‘å™¨æ— æ³•çŸ¥æ™“å…¶ä»–æ–‡ä»¶ä¸­æ˜¯å¦å®šä¹‰äº†ç›¸åŒåç§°çš„å˜é‡ï¼Œå¿…é¡»å°†å…¶åˆ†é…åˆ° COMMON ä¸­å¹¶éšåç”±é“¾æ¥å™¨å¤„ç†ã€‚å·²åˆå§‹åŒ–ä¸º 0 çš„å…¨å±€å˜é‡æ˜¯å¼ºç¬¦å·ï¼Œæ ¹æ®ç¬¬äºŒæ¡è§£æè§„åˆ™ï¼Œè¯¥å˜é‡ä¸€å®šæ˜¯å”¯ä¸€çš„ï¼Œå› æ­¤ç¼–è¯‘å™¨å¯ä»¥å®‰å¿ƒåœ°æŠŠå®ƒæ”¾åˆ° .bss ä¸­ã€‚é™æ€å˜é‡æ— æ³•è¢«å…¶ä»–æ–‡ä»¶å¼•ç”¨ï¼Œè‡ªç„¶ä¹Ÿæ— éœ€æ‹…å¿ƒåç§°é‡å¤çš„é—®é¢˜ã€‚\nä¸é™æ€åº“é“¾æ¥ ç¼–è¯‘ç³»ç»Ÿå°†ä¸€äº›ç›¸å…³çš„ç›®æ ‡æ¨¡å—æ‰“åŒ…åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œè¯¥æ–‡ä»¶è¢«ç§°ä¸ºé™æ€åº“ï¼ˆStatic Libraryï¼‰ã€‚åœ¨æ„å»ºå¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶æ—¶ï¼Œé“¾æ¥å™¨ä»…å¤åˆ¶é™æ€åº“ä¸­è¢«åº”ç”¨ç¨‹åºå¼•ç”¨çš„ç›®æ ‡æ¨¡å—ï¼Œä»è€Œå‡å°äº†ç£ç›˜å’Œå†…å­˜ä¸­å¯æ‰§è¡Œæ–‡ä»¶çš„å¤§å°ã€‚é™æ€åº“ä¸ºæˆ‘ä»¬æä¾›äº† I/Oã€å­—ç¬¦ä¸²æ“ä½œå’Œæ•°å­¦è¿ç®—ç­‰æ ‡å‡†å‡½æ•°ã€‚\nåœ¨ Linux ç³»ç»Ÿä¸­ï¼Œé™æ€åº“ä»¥ç‰¹å®šçš„æ–‡ä»¶æ ¼å¼ï¼ˆåç¼€ä¸º.aï¼‰å­˜å‚¨åœ¨ç£ç›˜ä¸Šã€‚åº”ç”¨ç¨‹åºå¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­æŒ‡å®šæ–‡ä»¶åæ¥ä½¿ç”¨é™æ€åº“ä¸­å®šä¹‰çš„ä»»ä½•å‡½æ•°ï¼ˆå®é™…ä¸Šï¼ŒC ç¼–è¯‘å™¨é©±åŠ¨æ€»æ˜¯å°†libc.aä¼ é€’ç»™é“¾æ¥å™¨ï¼‰ï¼Œå¦‚ï¼š\n1 linux\u003e gcc main.c /usr/lib/libm.a /usr/lib/libc.a æˆ‘ä»¬ä½¿ç”¨ AR å‘½ä»¤å°†ä¸‹åˆ—ç¨‹åºæ‰“åŒ…ä¸ºé™æ€åº“æ–‡ä»¶libvector.aï¼š\n1 2 linux\u003e gcc -c addvec.c multvec.c linux\u003e ar rcs libvector.a addvec.o multvec.o æ¥ä¸‹æ¥å†ç¼–å†™ä¸€ä¸ªç¨‹åºmain2.cè°ƒç”¨è¯¥é™æ€åº“ï¼Œå¤´æ–‡ä»¶vector.hå®šä¹‰äº†åº“æ–‡ä»¶ä¸­çš„å‡½æ•°åŸå‹ï¼š\næœ€åä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ç¼–è¯‘å¹¶é“¾æ¥main2.oå’Œlibvector.aï¼š\n1 2 linux\u003e gcc -c main2.c linux\u003e gcc -static -o prog2c main2.o ./libvector.a -staticå‚æ•°è¡¨ç¤ºé“¾æ¥å™¨åº”å½“æ„å»ºä¸€ä¸ªå®Œå…¨é“¾æ¥çš„å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å¯ä»¥è¢«åŠ è½½åˆ°å†…å­˜ä¸­è¿è¡Œè€Œæ— éœ€è¿›ä¸€æ­¥åœ°é“¾æ¥ã€‚å®Œæ•´çš„é“¾æ¥æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\né™æ€åº“çš„ç¬¦å·è§£æ ç¬¦å·è§£ææ—¶ï¼Œé“¾æ¥å™¨ä¼šæŒ‰ç…§ä»å·¦åˆ°å³çš„é¡ºåºä¾æ¬¡æ‰«æå‘½ä»¤è¡Œä¸­çš„ç›®æ ‡æ–‡ä»¶å’Œé™æ€åº“ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒE ä¸ºå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶çš„é›†åˆï¼ŒU ä¸ºè¢«å¼•ç”¨ä½†è¿˜æœªæ‰¾åˆ°å®šä¹‰çš„ç¬¦å·ï¼ŒD ä¸ºå·²æ‰«æè¿‡çš„æ–‡ä»¶å®šä¹‰çš„ç¬¦å·ï¼Œå¼€å§‹æ—¶ä¸‰è€…å‡ä¸ºç©ºã€‚\nè‹¥å‘½ä»¤è¡Œä¸­çš„è¾“å…¥æ–‡ä»¶ä¸ºå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ï¼Œåˆ™é“¾æ¥å™¨å°†å…¶æ·»åŠ åˆ° E ä¸­å¹¶æ›´æ–° U å’Œ D ä¸­çš„ç¬¦å·ï¼› è‹¥å‘½ä»¤è¡Œä¸­çš„è¾“å…¥æ–‡ä»¶ä¸ºé™æ€åº“ï¼Œåˆ™é“¾æ¥å™¨ä¼šå°† U ä¸­çš„ç¬¦å·ä¸è¯¥é™æ€åº“ä¸­å®šä¹‰çš„ç¬¦å·ç›¸åŒ¹é…ã€‚åŒ¹é…æˆåŠŸçš„æ¨¡å—ä¼šè¢«æ·»åŠ åˆ° E ä¸­ï¼Œéšåé“¾æ¥å™¨æ›´æ–° U å’Œ D ä¸­çš„ç¬¦å·ã€‚å½“ U å’Œ D ä¸­çš„ç¬¦å·ä¸å†æ”¹å˜æ—¶ï¼ŒåŒ¹é…ç»“æŸï¼Œä»»ä½•ä¸åœ¨ E ä¸­çš„é™æ€åº“æ¨¡å—éƒ½å°†è¢«ç›´æ¥ä¸¢å¼ƒï¼› è‹¥æ‰«æå…¨éƒ¨å®Œæˆæ—¶ U ä¸ºç©ºï¼Œåˆ™é“¾æ¥å™¨åˆå¹¶å¹¶é‡å®šä½ E ä¸­æ‰€æœ‰çš„ç›®æ ‡æ–‡ä»¶ä»¥æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶ã€‚å¦åˆ™ï¼Œé“¾æ¥å™¨å°†æŠ¥é”™å¹¶ç»ˆæ­¢ã€‚ é“¾æ¥å™¨çš„è¿™ç§è¡Œä¸ºé™åˆ¶äº†å‘½ä»¤è¡Œä¸­çš„æ–‡ä»¶é¡ºåºã€‚å¦‚æœå®šä¹‰ç¬¦å·çš„é™æ€åº“å‡ºç°åœ¨å¼•ç”¨è¯¥ç¬¦å·çš„ç›®æ ‡æ–‡ä»¶ä¹‹å‰ï¼Œé“¾æ¥å°±ä¼šå¤±è´¥ã€‚\né‡å®šä½ ç¬¦å·è§£æå®Œæˆåï¼Œé“¾æ¥å™¨ä¼šå°†ä»£ç ä¸­çš„æ¯ä¸ªç¬¦å·å¼•ç”¨ä¸ä¸€ä¸ªç¬¦å·å®šä¹‰ç›¸å…³è”ã€‚æ¥ä¸‹æ¥ï¼Œé“¾æ¥å™¨å¼€å§‹å¯¹ç›®æ ‡æ–‡ä»¶é‡å®šä½ï¼š\né‡å®šä½ Section å’Œç¬¦å·å®šä¹‰ï¼šé“¾æ¥å™¨å°†æ‰€æœ‰è¾“å…¥æ¨¡å—ä¸­ç›¸åŒç±»å‹çš„ Section åˆå¹¶ä¸ºä¸€ä¸ªæ–°çš„èšåˆ Sectionï¼Œç„¶åå°†è¿è¡Œæ—¶åœ°å€åˆ†é…ç»™æ¯ä¸ª Section å’Œç¬¦å·ï¼› åœ¨ Section å†…é‡å®šä½ç¬¦å·å¼•ç”¨ï¼šé“¾æ¥å™¨ä¿®æ”¹ä»£ç å’Œæ•°æ®æ®µä¸­çš„æ¯ä¸ªç¬¦å·å¼•ç”¨ï¼Œä½¿å…¶æŒ‡å‘æ­£ç¡®çš„è¿è¡Œæ—¶åœ°å€ã€‚ é‡å®šä½æ¡ç›® æ±‡ç¼–å™¨åœ¨ç”Ÿæˆç›®æ ‡æ–‡ä»¶æ—¶ï¼Œå¹¶ä¸çŸ¥æ™“ä»£ç ã€æ•°æ®å’Œå¼•ç”¨çš„å¤–éƒ¨ç¬¦å·åœ¨å†…å­˜ä¸­çš„æœ€ç»ˆä½ç½®ã€‚å®ƒåªä¼šä¸ºæ¯ä¸ªå¼•ç”¨ç”Ÿæˆä¸€ä¸ªé‡å®šä½æ¡ç›®ï¼ˆRelocation Entryï¼‰ï¼ŒæŒ‡å¯¼é“¾æ¥å™¨å¦‚ä½•ä¿®æ”¹å®ƒä»¬ã€‚ä¸Šæ–‡æåˆ°ï¼Œä»£ç çš„é‡å®šä½æ¡ç›®æ”¾åœ¨ .rel.text ä¸­ï¼Œæ•°æ®çš„é‡å®šä½æ¡ç›®åˆ™æ”¾åœ¨ .rel.data ä¸­ã€‚\nELF é‡å®šä½æ¡ç›®çš„æ•°æ®ç»“æ„ä¸ºï¼š\n1 2 3 4 5 6 typedef struct { long offset; /* Offset of the reference to relocate */ long type:32, /* Relocation type */ symbol:32; /* Symbol table index */ long addend; /* Constant part of relocation expression */ } Elf64_Rela; offsetæ˜¯è¢«ä¿®æ”¹çš„å¼•ç”¨åœ¨å…¶ Section ä¸­çš„åç§»é‡ï¼›symbolæ˜¯å¼•ç”¨æŒ‡å‘çš„ç¬¦å·åœ¨ç¬¦å·è¡¨ä¸­çš„ç´¢å¼•ï¼›typeå‘ŠçŸ¥é“¾æ¥å™¨å¦‚ä½•ä¿®æ”¹å¼•ç”¨ï¼›addendæ˜¯ä¸€ä¸ªæœ‰ç¬¦å·å¸¸é‡ï¼ŒæŸäº›ç±»å‹çš„é‡å®šä½ä½¿ç”¨å®ƒæ¥åç½®è¢«ä¿®æ”¹çš„å¼•ç”¨å€¼ã€‚\næœ€åŸºæœ¬çš„ä¸¤ç§é‡å®šä½ç±»å‹ä¸ºï¼š\nR_X86_64_PC32ï¼šä½¿ç”¨ 32 ä½ PC ç›¸å¯¹åœ°å€é‡å®šä½å¼•ç”¨ã€‚å½“ CPU æ‰§è¡Œä¸€æ¡ä½¿ç”¨ PC ç›¸å¯¹åœ°å€çš„æŒ‡ä»¤æ—¶ï¼Œå®ƒä¼šå°†æŒ‡ä»¤ä¸­çš„ç›®æ ‡åœ°å€ä¸ PC å½“å‰å€¼ï¼ˆå³ä¸‹ä¸€æ¡æŒ‡ä»¤åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼‰ç›¸åŠ å¾—åˆ°æœ‰æ•ˆåœ°å€ï¼ˆåœ¨ è·³è½¬æŒ‡ä»¤ ä¸€èŠ‚ä¸­æˆ‘ä»¬è®¨è®ºè¿‡è¿™ä¸€é—®é¢˜ï¼‰ï¼› R_X86_64_32ï¼šä½¿ç”¨ 32 ä½ç»å¯¹åœ°å€é‡å®šä½å¼•ç”¨ã€‚CPU ç›´æ¥ä½¿ç”¨æŒ‡ä»¤ä¸­çš„ç›®æ ‡åœ°å€ä½œä¸ºæœ‰æ•ˆåœ°å€ï¼Œæ— éœ€è¿›ä¸€æ­¥åœ°ä¿®æ”¹ã€‚ é‡å®šä½ç¬¦å·å¼•ç”¨ é‡å®šä½ç®—æ³•çš„ä¼ªç å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\né“¾æ¥å™¨éå†æ¯ä¸ª Sectionï¼ˆsï¼‰ä¸­çš„æ¯ä¸ªé‡å®šä½æ¡ç›®ï¼ˆrï¼‰ï¼Œsæ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼Œræ˜¯ä¸Šä¸€èŠ‚ä»‹ç»çš„Elf64_Relaç±»å‹çš„ç»“æ„ä½“ï¼Œ*refptræ˜¯æŒ‡ä»¤ä¸­çš„ç›®æ ‡åœ°å€ã€‚å‡è®¾è¯¥ç®—æ³•è¿è¡Œæ—¶ï¼Œé“¾æ¥å™¨å·²ç»ä¸ºæ¯ä¸ª Section å’Œæ¯ä¸ªç¬¦å·é€‰æ‹©äº†è¿è¡Œæ—¶åœ°å€ADDR(s)å’ŒADDR(r.symbol)ã€‚\næˆ‘ä»¬ä½¿ç”¨å‘½ä»¤objdump -dx main.oå¾—åˆ°æ±‡ç¼–å™¨ä¸º ç¤ºä¾‹ç¨‹åº main.c ç”Ÿæˆçš„æœºå™¨ç å’Œé‡å®šä½æ¡ç›®ï¼š\né‡å®šä½æ¡ç›®ï¼ˆå›¾ä¸­ç¬¬ 5 è¡Œå’Œç¬¬ 7 è¡Œï¼‰å‘ŠçŸ¥é“¾æ¥å™¨å¯¹ç¬¦å·arrayçš„å¼•ç”¨ä½¿ç”¨ç»å¯¹åœ°å€é‡å®šä½ï¼Œè€Œå¯¹ç¬¦å·sum()çš„å¼•ç”¨åˆ™ä½¿ç”¨ PC ç›¸å¯¹åœ°å€é‡å®šä½ã€‚\nPC ç›¸å¯¹åœ°å€é‡å®šä½ å¦‚ä¸Šå›¾ç¬¬ 6 è¡Œæ‰€ç¤ºï¼šæŒ‡ä»¤callqåœ¨å…¶ Section ä¸­çš„åç§»é‡ä¸º 0xeï¼Œå®ƒåŒ…å«ä¸€ä¸ªä¸€å­—èŠ‚çš„æŒ‡ä»¤ç  0xe8 å’Œä¸€ä¸ªç”¨äºæŒ‡å‘sum()çš„ 32 ä½ PC ç›¸å¯¹å¼•ç”¨çš„å ä½ç¬¦ã€‚è¯¥å¼•ç”¨å¯¹åº”çš„é‡å®šä½æ¡ç›®ä¸ºï¼š\n1 2 3 4 r.offset = 0xf r.symbol = sum r.type = R_X86_64_PC32 r.addend = -4 ä¸Šè¿°å­—æ®µå‘Šè¯‰é“¾æ¥å™¨éœ€è¦ä¿®æ”¹ä»åç§»é‡ 0xf å¼€å§‹çš„ 32 ä½ PC ç›¸å¯¹å¼•ç”¨ï¼Œä½¿å…¶åœ¨è¿è¡Œæ—¶æŒ‡å‘sum()ã€‚ å‡è®¾ADDR(s) = ADDR(.text) = 0x4004d0ï¼ŒADDR(r.symbol) = ADDR(sum) = 0x4004e8ï¼Œé‚£ä¹ˆé¦–å…ˆæˆ‘ä»¬å¯ä»¥è®¡ç®—å¾—åˆ°è¯¥å¼•ç”¨çš„è¿è¡Œæ—¶åœ°å€ä¸ºï¼š\n1 2 3 refaddr = ADDR(s) + r.offset = 0x4004d0 + 0xf = 0x4004df ç„¶åæ ¹æ®ä¸ŠèŠ‚ä¸­çš„ç®—æ³•æ›´æ–°å¼•ç”¨ä½¿å…¶æŒ‡å‘sum()ï¼š\n1 2 3 *refptr = (unsigned) (ADDR(r.symbol) + r.addend - refaddr) = (unsigned) (0x4004e8 + (-4) - 0x4004df) = (unsigned) (0x5) æŒ‡ä»¤callqçš„è¿è¡Œæ—¶åœ°å€ä¸º 0x4004deï¼ˆ0x4004df -1ï¼‰ã€‚å½“ CPU æ‰§è¡Œè¯¥æŒ‡ä»¤æ—¶ï¼ŒPC ä¸­çš„å€¼ä¸ºè¯¥æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ 0x4004e3ï¼ˆ0x4004de + (0xe - 9)ï¼‰ã€‚CPU å°†è¯¥å€¼å‹å…¥æ ˆä¸­ï¼Œç„¶ååŠ ä¸Š 0x5ï¼ˆå³*refptrï¼‰ï¼Œå°±å¾—åˆ°äº†sum()çš„åœ°å€ 0x4004e8ã€‚\nç»å¯¹åœ°å€é‡å®šä½ å¦‚ä¸Šå›¾ä¸­çš„ç¬¬å››è¡Œæ‰€ç¤ºï¼šæŒ‡ä»¤movå°†æ•°ç»„åœ°å€æ‹·è´åˆ°å¯„å­˜å™¨ %edi ä¸­ï¼Œå®ƒåœ¨ Section ä¸­çš„åç§»é‡ä¸º 0x9ï¼ŒåŒ…å«ä¸€ä¸ªä¸€å­—èŠ‚çš„æŒ‡ä»¤ç  0xbf å’Œä¸€ä¸ªç”¨äºæŒ‡å‘arrayçš„ 32 ä½ç»å¯¹å¼•ç”¨çš„å ä½ç¬¦ã€‚è¯¥å¼•ç”¨çš„é‡å®šä½æ¡ç›®ä¸ºï¼š\n1 2 3 4 r.offset = 0xa r.symbol = array r.type = R_X86_64_32 r.addend = 0 ä¸Šè¿°å­—æ®µå‘Šè¯‰é“¾æ¥å™¨éœ€è¦ä¿®æ”¹ä»åç§»é‡ 0xa å¼€å§‹çš„ 32 ä½ PC ç»å¯¹å¼•ç”¨ï¼Œä½¿å…¶åœ¨è¿è¡Œæ—¶æŒ‡å‘arrayã€‚ å‡è®¾ADDR(r.symbol) = ADDR(array) = 0x601018ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ ¹æ®ä¸ŠèŠ‚ä¸­çš„ç®—æ³•æ›´æ–°è¯¥å¼•ç”¨ä¸ºï¼š\n1 2 3 *refptr = (unsigned) (ADDR(r.symbol) + r.addend) = (unsigned) (0x601018 + 0) = (unsigned) (0x601018) ä¸‹å›¾å±•ç¤ºäº†æœ€ç»ˆç”Ÿæˆçš„å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ä¸­çš„ .text å’Œ .dataï¼š\nåŠ è½½å™¨åœ¨åŠ è½½æ—¶å°†è¿™äº› Section ä¸­çš„å­—èŠ‚ç›´æ¥æ‹·è´åˆ°å†…å­˜ä¸­ï¼Œæ— éœ€ä»»ä½•ä¿®æ”¹ä¾¿å¯ä»¥æ‰§è¡Œå…¶ä¸­çš„æŒ‡ä»¤ã€‚\nå¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ ELF å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶çš„ç»“æ„å¦‚ä¸‹ï¼š\nELF å¤´æè¿°äº†æ–‡ä»¶çš„æ•´ä½“æ ¼å¼ï¼Œå¹¶åŒ…å«äº†ç¨‹åºåœ¨è¿è¡Œæ—¶æ‰§è¡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚.init å®šä¹‰äº†ä¸€ä¸ªåä¸º_initçš„å‡½æ•°ï¼Œå®ƒå°†è¢«ç¨‹åºçš„åˆå§‹åŒ–ä»£ç æ‰€è°ƒç”¨ã€‚å…¶ä½™ Section ä¸å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ç±»ä¼¼ï¼Œåªä¸è¿‡å®ƒä»¬å·²è¢«é‡å®šä½åˆ°è¿è¡Œæ—¶çš„å†…å­˜åœ°å€ã€‚æ­£å› å¦‚æ­¤ï¼Œè¯¥æ–‡ä»¶ä¸­æ²¡æœ‰ .rel.text å’Œ .rel.dataã€‚\nå¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶çš„è¿ç»­å—ä¸è¿ç»­å†…å­˜æ®µä¹‹é—´çš„æ˜ å°„å…³ç³»ç”±ç¨‹åºå¤´è¡¨ï¼ˆProgram Header Tableï¼‰æè¿°ï¼š\nç¬¬ä¸€ä¸ªå†…å­˜æ®µå…·æœ‰è¯»å–å’Œæ‰§è¡Œæƒé™ï¼Œä»å†…å­˜åœ°å€ 0x400000 å¼€å§‹ï¼Œå¤§å°ä¸º 0x69c ä¸ªå­—èŠ‚ã€‚è¯¥å†…å­˜æ®µæ˜¯ç”±å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶çš„å‰ 0x69c ä¸ªå­—èŠ‚ï¼ˆåç§»é‡ä¸º 0ï¼‰åˆå§‹åŒ–å¾—åˆ°çš„ï¼ŒåŒ…å«äº† ELF å¤´ã€ç¨‹åºå¤´è¡¨ã€.initã€.text å’Œ .rodataã€‚\nç¬¬äºŒä¸ªå†…å­˜æ®µå…·æœ‰è¯»å–å’Œå†™å…¥æƒé™ï¼Œä»å†…å­˜åœ°å€ 0x600df8 å¼€å§‹ï¼Œå¤§å°ä¸º 0x230 ä¸ªå­—èŠ‚ã€‚è¯¥å†…å­˜æ®µå¯¹åº”äº†å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ä¸­åç§»é‡ä¸º 0xdf8 çš„ 0x228 ä¸ªå­—èŠ‚ï¼ŒåŒ…å«äº† .data å’Œ .bssï¼ˆä¸¤è€…å¤§å°ä¹‹å·®çš„ 8 ä¸ªå­—èŠ‚å³ä¿å­˜åœ¨ .bss å¹¶å°†åœ¨è¿è¡Œæ—¶åˆå§‹åŒ–ä¸º 0 çš„æ•°æ®ï¼‰ã€‚\nå¯¹äºæ¯ä¸ªå†…å­˜æ®µï¼Œé“¾æ¥å™¨å¿…é¡»é€‰æ‹©ä¸€ä¸ªèµ·å§‹åœ°å€ vaddrï¼Œä½¿å¾—ï¼š\n$$vaddr\\space mod\\space align = off\\space mod\\space align$$\nå…¶ä¸­ï¼Œoff æ˜¯è¯¥å†…å­˜æ®µä¸­ç¬¬ä¸€ä¸ª Section åœ¨ç›®æ ‡æ–‡ä»¶ä¸­çš„åç§»é‡ï¼Œalign æ˜¯ç¨‹åºå¤´è¡¨ä¸­æŒ‡å®šçš„å¯¹é½æ–¹å¼ã€‚è¿™ç§å¯¹é½è¦æ±‚æ˜¯ä¸€ç§ä¼˜åŒ–ï¼Œå®ƒå¯ä»¥ä½¿ç›®æ ‡æ–‡ä»¶è¢«æ›´åŠ æœ‰æ•ˆåœ°åŠ è½½åˆ°å†…å­˜ä¸­ã€‚\nåŠ è½½å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ ä¸‹å›¾å±•ç¤ºäº† Linux ç¨‹åºçš„è¿è¡Œæ—¶å†…å­˜ç»“æ„ï¼š\nåŠ è½½å™¨é¦–å…ˆæ ¹æ®ç¨‹åºå¤´è¡¨å°†å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ä¸­çš„å—å¤åˆ¶åˆ°å†…å­˜ä¸­çš„ä»£ç å’Œæ•°æ®æ®µï¼Œç„¶åè·³è½¬åˆ°ç¨‹åºå…¥å£ï¼Œå³_start_å‡½æ•°ï¼ˆåœ¨ç³»ç»Ÿç›®æ ‡æ–‡ä»¶crt1.oä¸­å®šä¹‰ï¼‰çš„åœ°å€ã€‚è¯¥å‡½æ•°å†è°ƒç”¨libc.soä¸­å®šä¹‰çš„ç³»ç»Ÿå¯åŠ¨å‡½æ•°__libc_start_mainï¼Œç”±å®ƒåˆå§‹åŒ–æ‰§è¡Œç¯å¢ƒï¼Œè°ƒç”¨ç”¨æˆ·çº§çš„ä¸»å‡½æ•°å¹¶å¤„ç†å…¶è¿”å›ã€‚\nä½¿ç”¨å…±äº«åº“åŠ¨æ€é“¾æ¥ é™æ€åº“ä¼šè¢«å®šæœŸç»´æŠ¤å’Œæ›´æ–°ï¼Œå› æ­¤ç¨‹åºå‘˜éœ€è¦çŸ¥æ™“å…¶å˜åŠ¨å¹¶å°†é‡æ–°é“¾æ¥ç¨‹åºã€‚æ­¤å¤–ï¼Œå‡ ä¹æ‰€æœ‰ C ç¨‹åºéƒ½ä¼šä½¿ç”¨ä¸€äº›æ ‡å‡† I/O å‡½æ•°ï¼Œä¾‹å¦‚printfã€‚è¿™äº›å‡½æ•°çš„ä»£ç å°†åœ¨è¿è¡Œæ—¶è¢«å¤åˆ¶åˆ°æ¯ä¸ªè¿›ç¨‹çš„ä»£ç æ®µä¸­ï¼Œä»è€Œå¯¼è‡´ä¸¥é‡çš„å†…å­˜æµªè´¹ã€‚\nå…±äº«åº“ï¼ˆShared Librariesï¼‰å¯ä»¥è§£å†³ä¸Šè¿°é™æ€åº“çš„ç¼ºç‚¹ã€‚å®ƒæ˜¯ä¸€ç§å¯ä»¥åœ¨åŠ è½½æ—¶æˆ–è¿è¡Œæ—¶äºä»»æ„å†…å­˜åœ°å€åŠ è½½å¹¶ä¸ç¨‹åºé“¾æ¥çš„ç›®æ ‡æ¨¡å—ï¼Œè¯¥è¿‡ç¨‹è¢«ç§°ä¸ºåŠ¨æ€é“¾æ¥ï¼ˆDynamic Linkingï¼‰ã€‚å…±äº«åº“åœ¨ Linux ç³»ç»Ÿä¸­ä»¥.soä¸ºåç¼€ï¼Œè€Œåœ¨ Windows ç³»ç»Ÿä¸­åˆ™è¢«ç§°ä¸º DLLï¼ˆDynamic Linking Librariesï¼‰ã€‚\nåœ¨ä»»æ„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªå…±äº«åº“éƒ½åªæœ‰ä¸€ä¸ª.soæ–‡ä»¶ã€‚ä¸é™æ€åº“ä¸åŒçš„æ˜¯ï¼Œè¯¥æ–‡ä»¶ä¸­çš„ä»£ç å’Œæ•°æ®å¯ä»¥è¢«å¼•ç”¨è¯¥åº“çš„æ‰€æœ‰å¯æ‰§è¡Œæ–‡ä»¶å…±äº«ï¼Œè€Œä¸éœ€è¦å¤åˆ¶åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­ã€‚ç¤ºä¾‹ç¨‹åº çš„åŠ¨æ€é“¾æ¥è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\næˆ‘ä»¬ä½¿ç”¨å¦‚ä¸‹æŒ‡ä»¤å°† addvec.c å’Œ multvec.c æ„å»ºä¸ºå…±äº«åº“æ–‡ä»¶libvector.so:\n1 linux\u003e gcc -shared -fpic -o libvector.so addvec.c multvec.c å…¶ä¸­ï¼Œ-fpicæŒ‡ç¤ºç¼–è¯‘å™¨ç”Ÿæˆ ä¸ä½ç½®æ— å…³ä»£ç ï¼ˆPosition-Independent Codeï¼‰ï¼Œè€Œ-sharedåˆ™æŒ‡ç¤ºé“¾æ¥å™¨åˆ›å»ºå…±äº«ç›®æ ‡æ–‡ä»¶ã€‚ä¸€æ—¦å…±äº«åº“æ–‡ä»¶åˆ›å»ºæˆåŠŸï¼Œå°±å¯ä»¥å°†å…¶é“¾æ¥åˆ°ç¤ºä¾‹ç¨‹åºä¸­ï¼š\n1 inux\u003e gcc -o prog2l main2.c ./libvector.so æˆ‘ä»¬éœ€è¦æ˜ç¡®çš„æ˜¯ï¼Œlibvector.soçš„ä»»æ„ä»£ç å’Œæ•°æ®éƒ½æ²¡æœ‰è¢«å¤åˆ¶åˆ°å¯æ‰§è¡Œæ–‡ä»¶prog2lä¸­ã€‚é“¾æ¥å™¨åªä¼šå¤åˆ¶ä¸€äº›é‡å®šä½å’Œç¬¦å·è¡¨ä¿¡æ¯ï¼Œå®ƒä»¬å°†åœ¨åŠ è½½æ—¶ç”¨äºè§£æå¼•ç”¨äº†å…±äº«åº“çš„ç¬¦å·ã€‚\nåŠ è½½å™¨éšåè¯»å–å¯æ‰§è¡Œæ–‡ä»¶ä¸­åŒ…å«çš„åŠ¨æ€é“¾æ¥å™¨è·¯å¾„ï¼ŒåŠ è½½å¹¶è¿è¡Œå®ƒã€‚åŠ¨æ€é“¾æ¥å™¨ä¹Ÿæ˜¯ä¸€ä¸ªå…±äº«åº“æ–‡ä»¶ï¼Œå¦‚ Linux ç³»ç»Ÿçš„ld-linux.soã€‚å®ƒé€šè¿‡æ‰§è¡Œä»¥ä¸‹é‡å®šä½æ“ä½œæ¥å®Œæˆé“¾æ¥ï¼š\nå°†libc.soçš„ä»£ç å’Œæ•°æ®é‡å®šä½åˆ°æŸä¸ªå†…å­˜æ®µï¼› å°†libvector.soä¸­çš„ä»£ç å’Œæ•°æ®é‡å®šä½åˆ°å¦ä¸€ä¸ªå†…å­˜æ®µï¼› å°†prog2lä¸­æ‰€æœ‰å¼•ç”¨äº†å…±äº«åº“çš„ç¬¦å·é‡å®šä½ã€‚ æœ€ç»ˆï¼ŒåŠ¨æ€é“¾æ¥å™¨å°†æ§åˆ¶æƒè½¬ç§»ç»™åº”ç”¨ç¨‹åºï¼Œå…±äº«åº“çš„ä½ç½®ä¸ä¼šåœ¨ç¨‹åºæ‰§è¡ŒæœŸé—´æ”¹å˜ã€‚\nä»åº”ç”¨ç¨‹åºä¸­åŠ è½½å’Œé“¾æ¥å…±äº«åº“ åº”ç”¨ç¨‹åºè¿˜å¯ä»¥åœ¨è¿è¡Œæ—¶è¯·æ±‚åŠ¨æ€é“¾æ¥å™¨åŠ è½½å’Œé“¾æ¥å…±äº«åº“ï¼Œå…¶åº”ç”¨åœºæ™¯åŒ…æ‹¬ï¼šWindows åº”ç”¨ç¨‹åºçš„å¼€å‘äººå‘˜ä½¿ç”¨å…±äº«åº“æ¥åˆ†å‘è½¯ä»¶æ›´æ–°ï¼›ç°ä»£ Web æœåŠ¡å™¨ä½¿ç”¨åŠ¨æ€é“¾æ¥æœ‰æ•ˆåœ°æ›´æ–°æˆ–æ·»åŠ åŠŸèƒ½ã€‚\nLinux ç³»ç»Ÿä¸ºåº”ç”¨ç¨‹åºæä¾›äº†ä¸€äº›ç®€å•æ¥å£ä»¥å®ç°ä¸Šè¿°åŠŸèƒ½ï¼š\n1 2 3 #include \u003cdlfcn.h\u003e void *dlopen(const char *filename, int flag); // Returns: pointer to handle if OK, NULL on error å‡½æ•°dlopenåŠ è½½å¹¶é“¾æ¥å…±äº«åº“æ–‡ä»¶filenameï¼Œå‚æ•°flagå¯ä»¥æ˜¯RTLD_GLOBALã€RTLD_NOWå’ŒRTLD_LAZYä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªï¼ˆè¯¦è§ dlopenï¼‰ã€‚\n1 2 3 #include \u003cdlfcn.h\u003e void *dlsym(void *handle, char *symbol); // Returns: pointer to symbol if OK, NULL on error ç±»ä¼¼çš„æ¥å£å‡½æ•°è¿˜æœ‰ dlsymã€dlclose å’Œ dlerrorã€‚ç¤ºä¾‹ç¨‹åº å±•ç¤ºäº†åº”ç”¨ç¨‹åºæ˜¯å¦‚ä½•è°ƒç”¨å®ƒä»¬æ¥åŠ¨æ€é“¾æ¥å…±äº«åº“çš„ã€‚\nä¸ä½ç½®æ— å…³ä»£ç  ç°ä»£ç³»ç»Ÿåœ¨ç¼–è¯‘å…±äº«åº“æ—¶ä¼šç”Ÿæˆä¸€ç§æ— éœ€é‡å®šä½å³å¯è¢«åŠ è½½åˆ°å†…å­˜ä¸­ä»»æ„ä½ç½®çš„ä»£ç ï¼Œå³ä¸ä½ç½®æ— å…³ä»£ç ï¼ˆPosition-Independent Codeï¼ŒPICï¼‰ï¼Œè¿™æ ·å…±äº«åº“å°±èƒ½è¢«å¤šä¸ªæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹åŒæ—¶å¼•ç”¨ã€‚\nPIC æ•°æ®å¼•ç”¨ ç¼–è¯‘å™¨åœ¨ PIC æ•°æ®æ®µçš„å¼€å¤´åˆ›å»ºäº†ä¸€ä¸ªå…¨å±€åç§»é‡è¡¨ï¼ˆGlobal Offset Tableï¼ŒGOTï¼‰ï¼Œå…¶ä¸­çš„æ¯ä¸ªæ¡ç›®éƒ½å¯¹åº”ä¸€ä¸ªè¢«ç›®æ ‡æ¨¡å—å¼•ç”¨çš„å…¨å±€ç¬¦å·ã€‚ç¼–è¯‘å™¨è¿˜ä¼šä¸ºè¿™äº›æ¡ç›®ç”Ÿæˆé‡å®šä½è®°å½•ã€‚åŠ è½½æ—¶ï¼ŒåŠ¨æ€é“¾æ¥å™¨é‡å®šä½æ¯ä¸ª GOT æ¡ç›®ï¼Œä½¿å…¶åŒ…å«è¢«å¼•ç”¨ç¬¦å·çš„ç»å¯¹åœ°å€ã€‚æ¯ä¸ªå¼•ç”¨äº†å…¨å±€ç¬¦å·çš„ç›®æ ‡æ¨¡å—éƒ½æœ‰è‡ªå·±çš„ GOTã€‚\nä¸‹å›¾å±•ç¤ºäº†ç¤ºä¾‹å…±äº«åº“libvector.soä¸­çš„ GOTï¼š\næ— è®ºæˆ‘ä»¬åœ¨ä½•å¤„åŠ è½½å…±äº«æ¨¡å—ï¼Œå…¶æ•°æ®æ®µä¸ä»£ç æ®µä¹‹é—´çš„è·ç¦»å§‹ç»ˆç›¸åŒã€‚å› æ­¤ï¼Œä»£ç æ®µä¸­çš„addlä¸æ•°æ®æ®µä¸­çš„ GOT[3] ä¹‹é—´çš„åç§»é‡æ˜¯ä¸€ä¸ªè¿è¡Œæ—¶å¸¸é‡ã€‚å½“å‡½æ•°addvecå¼•ç”¨å…¨å±€å˜é‡addcntæ—¶ï¼Œå…ˆé€šè¿‡0x2008b9(%rip)è®¡ç®—å¾—åˆ° GOT[3] çš„åœ°å€ï¼Œç„¶åä»ä¸­è¯»å–åŠ è½½æ—¶è¢«åŠ¨æ€é“¾æ¥å™¨èµ‹äºˆçš„addcntçš„ç»å¯¹åœ°å€ã€‚\nPIC å‡½æ•°è°ƒç”¨ PIC å‡½æ•°è°ƒç”¨çš„è¿è¡Œæ—¶åœ°å€æ˜¯åœ¨è¯¥å‡½æ•°ç¬¬ä¸€æ¬¡è¢«è°ƒç”¨æ—¶ç¡®å®šçš„ï¼Œè¿™ç§æŠ€æœ¯è¢«ç§°ä¸ºå»¶è¿Ÿç»‘å®šï¼ˆLazy Bindingï¼‰ã€‚å½“åº”ç”¨ç¨‹åºå¯¼å…¥äº†ä¸€ä¸ªåŒ…å«æˆç™¾ä¸Šåƒä¸ªå‡½æ•°çš„å…±äº«åº“ï¼ˆå¦‚libc.soï¼‰ï¼Œå´åªè°ƒç”¨å…¶ä¸­ä¸€å°éƒ¨åˆ†çš„å‡½æ•°æ—¶ï¼Œè¿™ç§æŠ€æœ¯å¯ä»¥å¤§å¤§å‡å°‘åŠ è½½æ—¶ä¸å¿…è¦çš„é‡å®šä½æ“ä½œã€‚\nå»¶è¿Ÿç»‘å®šæ˜¯é€šè¿‡ GOT å’Œè¿‡ç¨‹é“¾æ¥è¡¨ï¼ˆProcedure Linkage Tableï¼ŒPLTï¼‰å…±åŒå®ç°çš„ã€‚åªè¦ç›®æ ‡æ¨¡å—è°ƒç”¨äº†å…±äº«åº“ä¸­å®šä¹‰çš„å‡½æ•°ï¼Œé‚£ä¹ˆå®ƒå°±æœ‰è‡ªå·±çš„ GOT å’Œ PLTã€‚ä¸Šæ–‡æåˆ°ï¼ŒGOT æ˜¯æ•°æ®æ®µçš„ä¸€éƒ¨åˆ†ï¼Œè€Œ PLT åˆ™æ˜¯ä»£ç æ®µçš„ä¸€éƒ¨åˆ†ã€‚\nGOT å’Œ PLT åœ¨è¿è¡Œæ—¶ååŒå·¥ä½œè§£æå‡½æ•°åœ°å€çš„è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nå¯æ‰§è¡Œæ–‡ä»¶ä¸­æ¯ä¸ªå¯¹å…±äº«åº“å‡½æ•°çš„è°ƒç”¨éƒ½ä¸ PLT æ•°ç»„ä¸­çš„æ¡ç›®å¯¹åº”ã€‚å…¶ä¸­ï¼ŒPLT[0] æ˜¯è·³è½¬åˆ°åŠ¨æ€é“¾æ¥å™¨çš„ç‰¹æ®Šæ¡ç›®ï¼ŒPLT[1] å¯¹åº”ç³»ç»Ÿå¯åŠ¨å‡½æ•°__libc_start_mainã€‚ä» PLT[2] å¼€å§‹çš„æ¡ç›®å¯¹åº”ç”¨æˆ·ä»£ç è°ƒç”¨çš„å‡½æ•°ï¼Œå¦‚å›¾ä¸­çš„addvecã€‚\nå½“ä¸ PLT ä¸€èµ·ä½¿ç”¨æ—¶ï¼ŒGOT [0] å’Œ GOT[1] åŒ…å«äº†åŠ¨æ€è¿æ¥å™¨åœ¨è§£æå‡½æ•°åœ°å€æ—¶æ‰€éœ€çš„ä¿¡æ¯ï¼ŒGOT[2] æ˜¯åŠ¨æ€é“¾æ¥å™¨çš„å…¥å£ç‚¹ã€‚å…¶ä½™çš„æ¯ä¸ªæ¡ç›®å‡å¯¹åº”äºä¸€ä¸ªåœ¨è¿è¡Œæ—¶éœ€è¦è¢«è§£æåœ°å€çš„è°ƒç”¨å‡½æ•°ï¼Œä»¥åŠä¸€ä¸ª PLT æ¡ç›®ã€‚ä¾‹å¦‚ï¼ŒGOT[4] å’Œ PLT[2] ä¸addvecå¯¹åº”ã€‚\nç¨‹åºç¬¬ä¸€æ¬¡è°ƒç”¨addvecå¹¶è§£æå…¶åœ°å€çš„è¿‡ç¨‹å¦‚ä¸Šå›¾ï¼ˆaï¼‰æ‰€ç¤ºï¼š\nPLT[2] æ˜¯è¯¥å‡½æ•°çš„å…¥å£ï¼Œç¨‹åºé¦–å…ˆè°ƒç”¨å®ƒï¼› PLT[2] ä¸­çš„ç¬¬ä¸€æ¡æŒ‡ä»¤é—´æ¥è·³è½¬åˆ° GOT[4]ã€‚ç”±äºæœ€åˆæ¯ä¸ª GOT æ¡ç›®éƒ½æŒ‡å‘å¯¹åº” PLT æ¡ç›®ä¸­çš„ç¬¬äºŒæ¡æŒ‡ä»¤ï¼Œå› æ­¤æ§åˆ¶æƒå°†è½¬ç§»åˆ° PLT[2] ä¸­çš„ç¬¬äºŒæ¡æŒ‡ä»¤ï¼› PLT[2] ä¸­çš„ç¬¬äºŒæ¡æŒ‡ä»¤å°†addvecçš„ ID 0x1 å‹å…¥æ ˆä¸­ï¼Œç¬¬ä¸‰æ¡æŒ‡ä»¤è·³è½¬åˆ° PLT[0]ï¼› PLT[0] ä¸­çš„ç¬¬ä¸€æ¡æŒ‡ä»¤å°† *GOT[1] å‹å…¥æ ˆä¸­ï¼Œç¬¬äºŒæ¡æŒ‡ä»¤é€šè¿‡ GOT[2] é—´æ¥è·³è½¬åˆ°åŠ¨æ€é“¾æ¥å™¨ã€‚åŠ¨æ€é“¾æ¥å™¨æ ¹æ®è¢«å‹å…¥æ ˆä¸­çš„ä¸¤ä¸ªæ¡ç›®ç¡®å®šaddvecçš„è¿è¡Œæ—¶åœ°å€å¹¶ç”¨å®ƒè¦†ç›– GOT[4]ï¼Œæœ€ç»ˆå°†æ§åˆ¶æƒè½¬ç§»ç»™addvecã€‚ ç¨‹åºå†æ¬¡è°ƒç”¨addvecçš„è¿‡ç¨‹å¦‚ä¸Šå›¾ï¼ˆbï¼‰æ‰€ç¤ºï¼š\nç¨‹åºä¾ç„¶é¦–å…ˆè°ƒç”¨ PLT[2]ï¼› æ­¤æ—¶ GOT[4] æŒ‡å‘äº†addvecï¼Œå› æ­¤æ§åˆ¶æƒå°†è¢«ç›´æ¥è½¬ç§»åˆ°è¯¥å‡½æ•°ã€‚ åº“æ’å…¥ åº“æ’å…¥ï¼ˆLibrary Interpositioningï¼‰èƒ½å¤Ÿæ‹¦æˆªç¨‹åºå¯¹å…±äº«åº“å‡½æ•°çš„è°ƒç”¨ï¼Œå¹¶æ‰§è¡Œç”¨æˆ·è‡ªå®šä¹‰çš„ä»£ç ã€‚åŸºäºè¿™é¡¹æŠ€æœ¯ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—åº“å‡½æ•°çš„è°ƒç”¨æ¬¡æ•°ï¼ŒéªŒè¯å¹¶è·Ÿè¸ªå…¶è¾“å…¥å’Œè¾“å‡ºçš„å€¼ï¼Œç”šè‡³å°†å…¶æ›¿æ¢ä¸ºå®Œå…¨ä¸åŒçš„å‡½æ•°ã€‚\nåº“æ’å…¥çš„åŸºæœ¬æ€æƒ³æ˜¯åˆ›å»ºä¸€ä¸ªä¸åº“å‡½æ•°åŸå‹ç›¸åŒçš„åŒ…è£…å‡½æ•°ï¼Œç„¶åâ€œæ¬ºéª—â€ç³»ç»Ÿè°ƒç”¨åŒ…è£…å‡½æ•°è€Œéåº“å‡½æ•°ã€‚é€šå¸¸ï¼ŒåŒ…è£…å‡½æ•°ä¼šæ‰§è¡Œè‡ªå·±çš„é€»è¾‘ï¼Œè°ƒç”¨åº“å‡½æ•°å¹¶å°†å…¶è¿”å›å€¼ä¼ é€’ç»™è°ƒç”¨è€…ã€‚\nåº“æ’å…¥å¯ä»¥åœ¨ç¼–è¯‘æ—¶ã€é“¾æ¥æ—¶ä»¥åŠè¿è¡Œæ—¶ä½¿ç”¨ã€‚\n","description":"","tags":["OS"],"title":"CSAPP è¯»ä¹¦ç¬”è®°ï¼šé“¾æ¥","uri":"/posts/linking-note/"},{"content":"å‰è¨€ Thanos å·²æˆä¸ºç›®å‰ Kubernetes é›†ç¾¤ç›‘æ§çš„æ ‡å‡†è§£å†³æ–¹æ¡ˆä¹‹ä¸€ã€‚å®ƒåŸºäº Prometheus ä¹‹ä¸Šï¼Œå¯ä»¥ä¸ºæˆ‘ä»¬æä¾›ï¼š\nå…¨å±€çš„æŒ‡æ ‡æŸ¥è¯¢è§†å›¾ è¿‘ä¹æ— é™çš„æ•°æ®ä¿ç•™æœŸé™ åŒ…å« Prometheus åœ¨å†…æ‰€æœ‰ç»„ä»¶çš„é«˜å¯ç”¨æ€§ åœ¨æ‹Ÿå®šç›‘æ§æ–¹æ¡ˆä¹‹å‰ï¼Œé˜…è¯»ä¸€äº›æˆç†Ÿçš„ ç”¨æˆ·æ¡ˆä¾‹ æ˜¯ååˆ†å¿…è¦çš„ã€‚è¿™äº›åšæ–‡é¦–å…ˆåˆ†æäº†å„è‡ªå›¢é˜Ÿçš„é›†ç¾¤ç°çŠ¶ä»¥åŠå½“å‰ç›‘æ§æ–¹æ¡ˆéš¾ä»¥è§£å†³çš„ç—›ç‚¹ï¼Œå†å¯¹ç›®å‰æµè¡Œçš„å‡ ç§æŠ€æœ¯æ ˆè¿›è¡Œå¯¹æ¯”ï¼Œæœ€åä»‹ç»æŠ•å…¥ç”Ÿäº§ä½¿ç”¨çš„éƒ¨ç½²æ–¹æ¡ˆï¼Œå› æ­¤éå¸¸å€¼å¾—ä¸€è¯»ã€‚\nä¸è¿‡ï¼Œç”±äº Thanos çš„ç»„ä»¶ä¼—å¤šï¼Œä¸”æ¯ç§ç»„ä»¶éƒ½æœ‰è¾ƒå¤šå‚æ•°éœ€è¦é…ç½®ã€‚å¯¹äºåˆšæ¥è§¦ Thanos çš„ç”¨æˆ·æ¥è¯´ï¼Œå¯èƒ½éš¾ä»¥å¿«é€Ÿä¸Šæ‰‹ã€‚è€ƒè™‘åˆ°ä¸Šè¿°åšæ–‡å‡æœªç»™å‡ºç»„ä»¶çš„å…·ä½“é…ç½®ä¿¡æ¯ï¼Œè€Œå®˜æ–¹æä¾›çš„ éƒ¨ç½²æ¸…å• åˆç¨æ˜¾å¤æ‚å¹¶ç¼ºå°‘è¯¦ç»†è¯´æ˜ã€‚å› æ­¤æœ¬æ–‡å°†ä»‹ç»ä¸€ä¸ªä½¿ç”¨ Thanos å®ç°å¤šé›†ç¾¤ï¼ˆç§Ÿæˆ·ï¼‰ç›‘æ§çš„ç®€å• Demoï¼Œå¸Œæœ›èƒ½å¯¹è¯•å›¾å°é²œ Thanos çš„ç”¨æˆ·æœ‰æ‰€å¸®åŠ©ã€‚å®ƒå®ç°äº†ä»¥ä¸‹åŠŸèƒ½ï¼š\nèƒ½å¤Ÿç›‘æ§å¤šä¸ªé›†ç¾¤ï¼Œå¹¶æä¾›ä¸€ä¸ªå…¨å±€çš„æŒ‡æ ‡æŸ¥è¯¢è§†å›¾ï¼› æ¯ä¸ªé›†ç¾¤éƒ½å¯¹åº”äº†ä¸€ä¸ªå”¯ä¸€çš„ç§Ÿæˆ· IDï¼Œå¯ä»¥é€šè¿‡ç§Ÿæˆ·æ ‡ç­¾åŒºåˆ†ä¸åŒé›†ç¾¤çš„æŒ‡æ ‡æ•°æ®ï¼› å¦‚æœæŸä¸ªç§Ÿæˆ·åˆ›å»ºäº†æ–°çš„é›†ç¾¤ï¼Œåªéœ€åœ¨æ–°é›†ç¾¤ä¸­éƒ¨ç½² Prometheus å¹¶é…ç½®è¿œç¨‹å†™å…¥ï¼› ç®€å•çš„å‘Šè­¦è§„åˆ™å’Œå‘Šè­¦æ¶ˆæ¯æ¨é€ã€‚ Sidecar vs. Receiver Thanos æ”¯æŒ Sidecar å’Œ Receiver ä¸¤ç§éƒ¨ç½²æ¨¡å¼ã€‚å®ƒä»¬å„æœ‰åˆ©å¼Šï¼Œéœ€è¦æˆ‘ä»¬æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œå–èˆã€‚\nSidecar é€šå¸¸æ¯éš” 2 å°æ—¶æ‰ä¼šæŠŠ Prometheus é‡‡é›†åˆ°çš„æŒ‡æ ‡ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨ä¸­ï¼Œå› æ­¤ Query æŸ¥è¯¢è¿‘æœŸæ•°æ®æ—¶éœ€è¦å‘æ‰€æœ‰ Sidecar å‘èµ·è¯·æ±‚å¹¶åˆå¹¶è¿”å›ç»“æœã€‚ä½†è¿™å¹¶éæ˜¯ Thanos å›¢é˜Ÿå¼•å…¥ Receiver çš„å†³å®šæ€§å› ç´ ã€‚\nReceiver is only recommended for uses for whom pushing is the only viable solution, for example, analytics use cases or cases where the data ingestion must be client initiated, such as software as a service type environments.\næŒ‰ç…§æ–‡æ¡£ä¸­çš„è¯´æ³•ï¼ŒReceiver åªæ¨èç”¨äºå¤šç§Ÿæˆ·ä»¥åŠ Prometheus é…ç½®å—é™çš„åœºæ™¯ä¸‹ï¼Œæ¯”å¦‚ï¼š\nç§Ÿæˆ·ä½¿ç”¨æŸäº› SaaS æœåŠ¡å¯¹é›†ç¾¤è¿›è¡Œç›‘æ§ï¼Œå¦‚ Openshift Operator éƒ¨ç½²çš„ Prometheusï¼› ç”±äºå®‰å…¨æˆ–æƒé™é—®é¢˜ï¼Œç›‘æ§å›¢é˜Ÿæ— æ³•åœ¨è¢«ç›‘æ§é›†ç¾¤ä¸­é…ç½® Sidecarï¼› è¢«ç›‘æ§é›†ç¾¤éƒ¨ç½²çš„æ˜¯éå®¹å™¨åŒ–éƒ¨ç½²çš„ Prometheusã€‚ è¿™æ˜¯å› ä¸º Receiver ä¼šæš‚å­˜å¤šä¸ª Prometheus å®ä¾‹çš„ TSDBï¼Œå½“æ•°æ®é‡è¾ƒå¤§æ—¶å¯èƒ½ä¼šå‘ç”Ÿ OOMã€‚å¦å¤–æ ¹æ® å®˜æ–¹æ–‡æ¡£ï¼Œå¼€å¯è¿œç¨‹å†™å…¥è¿˜å°†å¢åŠ  Prometheus çº¦ 25% çš„å†…å­˜ä½¿ç”¨ã€‚\næˆ‘ä»¬å¹¶éä¸€å®šè¦åœ¨ Receiver å’Œ Sidecar ä¹‹é—´åšå‡ºæŠ‰æ‹©ï¼Œæ¯”å¦‚ Lastpass å°±é‡‡ç”¨äº† Sidecar ä¸ Receiver æ··åˆéƒ¨ç½²çš„æ–¹å¼ï¼š\nç”±äºæˆ‘ä»¬çš„ Demo ä¼˜å…ˆè€ƒè™‘å®ç°çš„ç®€å•æ€§ä»¥åŠå¯¹å¤šç§Ÿæˆ·çš„æ”¯æŒï¼Œå¯¹èµ„æºå ç”¨å’Œæ€§èƒ½çš„è¦æ±‚å¹¶ä¸é«˜ï¼Œå› æ­¤å†³å®šé€‰ç”¨ Receiver æ¨¡å¼ã€‚\nå¿«é€Ÿå¼€å§‹ Thanos ç‰ˆæœ¬ï¼šv0.24.0 Kubernetes ç‰ˆæœ¬ï¼šv1.16.9-aliyun.1 ç¯å¢ƒï¼šé˜¿é‡Œäº‘ ACK 1 2 3 git clone https://github.com/koktlzz/thanos-k8s-deployment.git cd thanos-k8s-deployment kubectl apply -k overlays/aliclound/ éƒ¨ç½² Prometheus 1 2 3 4 5 6 git clone https://github.com/coreos/kube-prometheus.git cd kube-prometheus kubectl create -f manifests/setup # wait for namespaces and CRDs to become available, then kubectl create -f manifests/ åœ¨å›½å†…ç¯å¢ƒæ‹‰å– k8s.gcr.io ä¸Šçš„é•œåƒå¯èƒ½ä¼šå¤±è´¥ï¼Œéœ€è¦å°†é•œåƒåç§°æ”¹ä¸º bitnami/kube-state-metrics:2.3.0 å’Œ willdockerhub/prometheus-adapter:v0.9.0ã€‚\nä¸º Prometheus å®ä¾‹é…ç½®è¿œç¨‹å†™å…¥ ä½¿ç”¨kubectl edit -n monitoring prometheus k8så‘½ä»¤å¼€å¯ Prometheus çš„è¿œç¨‹å†™å…¥ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # local cluster spec: remoteWrite: - url: http://thanos-receiver.thanos.svc.cluster.local:19291/api/v1/receive # cluster kazusa spec: remoteWrite: - url: http://thanos-receiver.uuid.cn-shanghai.alicontainer.com/api/v1/receive headers: THANOS-TENANT: kazusa # cluster setsuna spec: remoteWrite: - url: http://thanos-receiver.uuid.cn-shanghai.alicontainer.com/api/v1/receive headers: THANOS-TENANT: setsuna ä¸€æ®µæ—¶é—´åå°†åœ¨ Query UIï¼ˆkubectl get ingresses -n thanos | grep querierï¼‰ä¸­çœ‹åˆ°ä¸‰ä¸ªé›†ç¾¤ï¼ˆç§Ÿæˆ·ï¼‰çš„å®ä¾‹ï¼š\næ¶æ„è¯´æ˜ æŒ‡æ ‡æ•°æ®æµå‘ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç›‘æ§é›†ç¾¤ï¼ˆLocalï¼‰ä»¥åŠä¸¤ä¸ªå¤–éƒ¨é›†ç¾¤ï¼ˆKazusa å’Œ Setsunaï¼‰ä¸­çš„ Prometheus å‡å°†æŒ‡æ ‡æ•°æ®å†™å…¥åˆ°è½¯ç§Ÿæˆ·ï¼ˆsoft-tenantï¼‰çš„ Receiver ä¸­ã€‚è€Œç”±äº Kazusa å’Œ Setsuna çš„ Prometheus è¿˜åœ¨è¿œç¨‹å†™å…¥ä¸­é…ç½®äº† HTTP å¤´éƒ¨ï¼Œå› æ­¤è½¯ç§Ÿæˆ· Receiver ä¼šæ ¹æ®å…¶ä¸­çš„ç§Ÿæˆ· ID å°†å…¶è½¬å‘åˆ°å¯¹åº”çš„ç¡¬ç§Ÿæˆ· Receiver ä¸­ã€‚\næˆ‘ä»¬å¯ä»¥åœ¨ Receiver å®¹å™¨æŒ‚è½½çš„ Hashring é…ç½®æ–‡ä»¶ä¸­æ‰¾åˆ°æ¯ä¸ªç§Ÿæˆ· Receiver çš„endpointsï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 [root@master1 thanos]# kubectl exec -n thanos thanos-receiver-default-0 -- cat /etc/prometheus/hashring-config/hashrings.json | jq [ { \"hashring\": \"hashring-setsuna\", \"tenants\": [ \"setsuna\" ], \"endpoints\": [ \"thanos-receiver-setsuna-0.thanos-receiver-setsuna.thanos.svc.cluster.local:10901\" ] }, { \"hashring\": \"hashring-kazusa\", \"tenants\": [ \"kazusa\" ], \"endpoints\": [ \"thanos-receiver-kazusa-0.thanos-receiver-kazusa.thanos.svc.cluster.local:10901\", \"thanos-receiver-kazusa-1.thanos-receiver-kazusa.thanos.svc.cluster.local:10901\", \"thanos-receiver-kazusa-2.thanos-receiver-kazusa.thanos.svc.cluster.local:10901\" ] }, { \"hashring\": \"default\", \"endpoints\": [ \"thanos-receiver-default-0.thanos-receiver-default.thanos.svc.cluster.local:10901\" ] } ] å®é™…ä¸Šè¯¥æ–‡ä»¶æ¥è‡ªäº Configmapthanos-receiver-hashring-generated-configï¼Œå®ƒæ˜¯ç”± Thanos-Receive-Controller è¯»å–å½“å‰é›†ç¾¤ä¸­çš„ Receiver å®ä¾‹å¹¶æ ¹æ® Configmap thanos-receiver-hashring-config åŠ¨æ€ç”Ÿæˆçš„ã€‚\nReceiver ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œä½œä¸ºæ•°æ®åˆ†å‘ç­–ç•¥çš„åŸå› è¯¦è§ï¼šThanos Receiver - why does it need consistent hashing?\nReceiver çš„å¯æ‰©å±•æ€§å’Œé«˜å¯ç”¨æ€§ å‡è®¾ Kazusa é›†ç¾¤ä¸­çš„å·¥ä½œè´Ÿè½½æ¯”è¾ƒå¤šï¼Œå…¶æŒ‡æ ‡æ•°æ®é‡ä¹Ÿæ¯”è¾ƒå¤§ã€‚ä¸ºäº†é˜²æ­¢æ¥æ”¶ Kazusa é›†ç¾¤æŒ‡æ ‡æ•°æ®çš„ Receiver å‘ç”Ÿ OOMï¼Œæˆ‘ä»¬å¢åŠ å…¶ Statefulset çš„ å‰¯æœ¬æ•°ã€‚\nä¸Šä¸€èŠ‚æåˆ°ï¼ŒæŒ‡æ ‡æ•°æ®æ˜¯è½¯ç§Ÿæˆ· Receiver æ ¹æ® Hashring é…ç½®åˆ†å‘åˆ°ç¡¬ç§Ÿæˆ· Receiver çš„ã€‚è¿™æ„å‘³ç€å³ä½¿æˆ‘ä»¬å°† Kazusa çš„ Receiver æ‰©å±•åˆ°ä¸‰ä¸ªï¼Œæ•°æ®ä¹Ÿä¸ä¼šåœ¨æŸå° Receiver å®•æœºååˆ†å‘åˆ°å…¶ä»–å¯ç”¨çš„ Receiver ä¸­ã€‚å› æ­¤æˆ‘ä»¬è¿˜è¦ä¸ºæ•°æ®è®¾ç½® å‰¯æœ¬ï¼Œä»è€Œå®ç°é«˜å¯ç”¨ã€‚Receiver çš„å‰¯æœ¬åŒ…å« receiver_replica æ ‡ç­¾ï¼ŒQuery å¯ä»¥æ ¹æ®å®ƒæ¥å¯¹æ•°æ® å»é‡ã€‚\nå…³äº Receiver çš„å¯æ‰©å±•æ€§å’Œé«˜å¯ç”¨æ€§ï¼Œè¯¦è§ Turn It Up to a Million: Ingesting Millions of Metrics with Thanos Receive.\nHeadless Service æˆ‘ä»¬ä¸ºæ¯ä¸ªç§Ÿæˆ·çš„ Receiver éƒ½åˆ›å»ºäº†å„è‡ªçš„ Headless Serviceï¼Œè¿™æ · Query å°±å¯ä»¥é€šè¿‡ DNS çš„ SRV è®°å½•åŠ¨æ€å‘ç°æ‰€æœ‰çš„ Receiver å®ä¾‹ï¼š\n1 2 3 - --store=dnssrv+_grpc._tcp.thanos-receiver-default.thanos.svc.cluster.local - --store=dnssrv+_grpc._tcp.thanos-receiver-kazusa.thanos.svc.cluster.local - --store=dnssrv+_grpc._tcp.thanos-receiver-setsuna.thanos.svc.cluster.local å¦‚æœå°†å…¶æ”¹ä¸º ClusterIP ç±»å‹ï¼ŒStore API çš„ grpc è¯·æ±‚å°†é€šè¿‡è½®è¯¢å‘å¾€å…¶ä¸­ä¸€å° Receiver å®ä¾‹ã€‚å› æ­¤ï¼ŒåŒä¸€æ—¶é—´å†…åªæœ‰ä¸€å° Kazusa Receiver å¯ä»¥è¢« Query å‘ç°ï¼š\nå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç”¨äºå¤„ç†æŒ‡æ ‡æ•°æ®çš„å†™å…¥è¯·æ±‚çš„ Service æ˜¯ ClusterIP ç±»å‹çš„ã€‚\nFuture Work æœ¬æ–‡ä»‹ç»çš„ Demo ä»…ä¾›è¯»è€…å‚è€ƒï¼Œè‹¥æƒ³è¦å°†å…¶æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ï¼Œè¿˜éœ€è¦è€ƒè™‘ä»¥ä¸‹æ–¹é¢ï¼š\nä¸ºè½¯ç§Ÿæˆ· Receiver å‘é›†ç¾¤å¤–éƒ¨æš´éœ²çš„ Ingress é…ç½® TLS è¯ä¹¦æ ¡éªŒï¼› ä¸Šæ–‡æåˆ°ï¼Œå¼€å¯è¿œç¨‹å†™å…¥å°†å¢åŠ  Prometheus çš„å†…å­˜ä½¿ç”¨ï¼Œæˆ‘ä»¬åº”å½“æ ¹æ® Remote Write Tuning å’Œ How to troubleshoot remote write issues in Prometheus ä¸­çš„å»ºè®®å¯¹å…¶å‚æ•°è¿›è¡Œè°ƒä¼˜ï¼› é»˜è®¤æƒ…å†µä¸‹ï¼ŒReceiver æ¯éš”ä¸¤å°æ—¶å‘å¯¹è±¡å­˜å‚¨ä¸Šä¼ ä¸€æ¬¡ Blockï¼Œåº”ä¸ºå…¶å¢åŠ æŒä¹…åŒ–ä»¥é¿å…æ•°æ®ä¸¢å¤±ï¼› æŒä¹…åŒ– Compactor å’Œ Storegateway çš„æ•°æ®ç›®å½•å¯ä»¥å‡å°‘å…¶é‡å¯æ—¶é—´ï¼Œå­˜å‚¨ç©ºé—´çš„å¤§å°å¯ä»¥å‚è€ƒ Slack ä¸­çš„ è®¨è®ºï¼› éƒ¨ç½²å‰æ ¹æ®æŒ‡æ ‡æ•°æ®é‡è¯„ä¼° Receiver çš„ Requestã€Limit ä»¥åŠå‰¯æœ¬æ•°ï¼Œé˜²æ­¢å…¶å› æ•°æ®é‡è¿‡å¤§è€Œå¯¼è‡´ OOMï¼› æ­¤ Demo ä½¿ç”¨ Ruler è¿›è¡Œå…¨å±€å‘Šè­¦ï¼Œå¯èƒ½å› æŸ¥è¯¢è¶…æ—¶è€Œå‘ç”Ÿ æŠ¥è­¦å¤±æ•ˆã€‚ å‚è€ƒæ–‡çŒ® Multi cluster monitoring with Thanos Â· Banzai Cloud\nThanos Remote Write\nAchieve Multi-tenancy in Monitoring with Prometheus \u0026 Thanos Receiver\nAdopting Thanos at Lastpass\n","description":"","tags":["Prometheus","Thanos"],"title":"ä½¿ç”¨ Thanos å®ç°å¤šé›†ç¾¤ï¼ˆç§Ÿæˆ·ï¼‰ç›‘æ§","uri":"/posts/thanos-receiver-deployment-demo/"},{"content":"åœ¨è®¡ç®—æœºçš„è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œç¨‹åºè®¡æ•°å™¨ä¾æ¬¡æŒ‡å‘ä¸€ç³»åˆ—çš„å€¼ï¼š$a_0, a_1, â€¦, a_n$ã€‚å…¶ä¸­ï¼Œ$a_k$ æ˜¯å…¶å¯¹åº”æŒ‡ä»¤ $I_k$ çš„åœ°å€ã€‚ä» $a_k$ åˆ° $a_{k+1}$ çš„è½¬æ¢è¢«ç§°ä¸ºæ§åˆ¶è½¬ç§»ï¼ˆControl Transferï¼‰ï¼Œä¸€ç³»åˆ—çš„æ§åˆ¶è½¬ç§»åˆ™è¢«ç§°ä¸ºå¤„ç†å™¨çš„æ§åˆ¶æµï¼ˆControl Flowï¼‰ã€‚\næœ€ç®€å•çš„æ§åˆ¶æµä¾¿æ˜¯ç¨‹åºä¸­çš„æŒ‡ä»¤æŒ‰é¡ºåºæ‰§è¡Œï¼Œå³ $I_k$ ä¸ $I_{k+1}$ åœ¨å†…å­˜ä¸­ç›¸é‚»ã€‚ä¸è¿‡ï¼Œè¿™ç§â€œå¹³æ»‘â€çš„æ§åˆ¶æµé€šå¸¸å› æŒ‡ä»¤çš„è·³è½¬ã€è°ƒç”¨å’Œè¿”å›è€Œçªç„¶æ”¹å˜ï¼Œæ­¤æ—¶ $I_k$ ä¾¿ä¸å†ä¸ $I_{k+1}$ ç›¸é‚»ã€‚\nç¨‹åºå†…éƒ¨çš„çŠ¶æ€æ˜¯ç”±ç¨‹åºå˜é‡è¡¨ç¤ºçš„ï¼Œæ§åˆ¶æµä½¿å¾—ç¨‹åºå¯ä»¥å¯¹å…¶æ›´æ–°åšå‡ºååº”ã€‚ä½†ç³»ç»Ÿè¿˜å¿…é¡»èƒ½å¤Ÿåº”å¯¹è‡ªèº«çŠ¶æ€çš„å˜åŒ–ï¼Œå®ƒä»¬æ— æ³•è¢«å†…éƒ¨ç¨‹åºå˜é‡æ•è·ï¼Œç”šè‡³ä¸ä¸€å®šä¸ç¨‹åºçš„æ‰§è¡Œæœ‰å…³ã€‚æ¯”å¦‚ï¼Œæ•°æ®åŒ…åœ¨åˆ°è¾¾ç½‘ç»œé€‚é…å™¨åéœ€è¦è¢«å­˜å‚¨åˆ°å†…å­˜ä¸­ï¼›ç¨‹åºè¯·æ±‚ç£ç›˜ä¸­çš„æ•°æ®æ—¶éœ€è¦å¾—çŸ¥å…¶ä½•æ—¶å¯ç”¨ï¼›çˆ¶è¿›ç¨‹å¿…é¡»åœ¨å…¶å­è¿›ç¨‹ç»ˆæ­¢æ—¶æ”¶åˆ°é€šçŸ¥ç­‰ã€‚\nç°ä»£ç³»ç»Ÿé€šè¿‡å¼‚å¸¸æ§åˆ¶æµï¼ˆExceptional Control Flowï¼ŒECFï¼‰æ¥å¤„ç†ä¸Šè¿°æƒ…å†µï¼Œå®ƒåº”ç”¨äºè®¡ç®—æœºç³»ç»Ÿçš„æ‰€æœ‰çº§åˆ«ä¸­ã€‚\nå¼‚å¸¸ å¼‚å¸¸ï¼ˆExceptionï¼‰æ˜¯ä¸ºäº†å“åº”å¤„ç†å™¨çŠ¶æ€æ”¹å˜è€Œåœ¨æ§åˆ¶æµä¸­çªç„¶å‘ç”Ÿçš„å˜åŒ–ï¼Œå…¶åŸºæœ¬æ€æƒ³å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nå¤„ç†å™¨çŠ¶æ€çš„å˜åŒ–è¢«ç§°ä¸ºäº‹ä»¶ï¼ˆEventï¼‰ï¼Œå®ƒå¯èƒ½ä¸å½“å‰æŒ‡ä»¤ï¼ˆ$I_{curr}$ï¼‰çš„æ‰§è¡Œç›´æ¥ç›¸å…³ï¼Œæ¯”å¦‚ç®—æœ¯æº¢å‡ºæˆ–é™¤æ•°ä¸ºé›¶ï¼›ä¹Ÿå¯èƒ½ä¸å½“å‰æŒ‡ä»¤çš„æ‰§è¡Œæ— å…³ï¼Œæ¯”å¦‚ç³»ç»Ÿè®¡æ—¶å™¨å…³é—­æˆ– I/O è¯·æ±‚å®Œæˆã€‚\nå¼‚å¸¸å¤„ç† å¼‚å¸¸å¤„ç†æ¶‰åŠåˆ°è½¯ä»¶å’Œç¡¬ä»¶çš„å¯†åˆ‡åˆä½œï¼Œå› æ­¤å¾ˆå®¹æ˜“å°†ä¸åŒç»„ä»¶æ‰§è¡Œçš„å·¥ä½œç›¸æ··æ·†ã€‚ç³»ç»Ÿä¸­æ¯ç§å¯èƒ½çš„å¼‚å¸¸éƒ½å¯¹åº”äº†ä¸€ä¸ªå”¯ä¸€çš„éè´Ÿæ•´æ•°ï¼Œå³å¼‚å¸¸æ•°å­—ï¼ˆException Numberï¼‰ã€‚å½“è®¡ç®—æœºç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šåˆå§‹åŒ–ä¸€ä¸ªè·³è½¬è¡¨ï¼Œä¹Ÿç§°å¼‚å¸¸è¡¨ï¼ˆException Tableï¼‰ã€‚å¼‚å¸¸æ•°å­—æ˜¯å¼‚å¸¸è¡¨çš„ç´¢å¼•ï¼Œå…¶ä¸­çš„æ¯ä¸ªæ¡ç›® k å‡åŒ…å«äº†å¼‚å¸¸ k çš„å¤„ç†ç¨‹åºåœ°å€ï¼š\nå½“å¤„ç†å™¨æ£€æµ‹åˆ°äº‹ä»¶çš„å‘ç”Ÿæ—¶ï¼Œé¦–å…ˆå°†ç¡®å®šå¼‚å¸¸æ•°å­—ï¼Œç„¶åæ ¹æ®å¼‚å¸¸è¡¨è°ƒç”¨å¯¹åº”çš„å¼‚å¸¸å¤„ç†ç¨‹åºã€‚\nå¼‚å¸¸ä¸è¿‡ç¨‹è°ƒç”¨ç±»ä¼¼ï¼Œä½†ä¹Ÿæœ‰ä¸€äº›é‡è¦åŒºåˆ«ï¼š\nå¼‚å¸¸çš„è¿”å›åœ°å€è¦ä¹ˆæ˜¯å½“å‰æŒ‡ä»¤ï¼ˆ$I_{curr}$ï¼‰ï¼Œè¦ä¹ˆæ˜¯ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼ˆ$I_{next}$ï¼‰ï¼› å¤„ç†å™¨è¿˜ä¼šå°†ä¸€äº›é¢å¤–çš„å¤„ç†å™¨çŠ¶æ€ä¿¡æ¯å‹å…¥æ ˆä¸­ã€‚å½“å¤„ç†ç¨‹åºè¿”å›åï¼Œè¿™äº›ä¿¡æ¯æ˜¯é‡å¯è¢«ä¸­æ–­ç¨‹åºæ‰€å¿…éœ€çš„ï¼› å¼‚å¸¸å¤„ç†ç¨‹åºåœ¨å†…æ ¸æ€è¿è¡Œï¼Œå› æ­¤å¯ä»¥è®¿é—®æ‰€æœ‰ç³»ç»Ÿèµ„æºã€‚ å¼‚å¸¸çš„åˆ†ç±» ä¸­æ–­ ä¸­æ–­ï¼ˆInterruptï¼‰å¼‚æ­¥å‘ç”Ÿï¼Œå› ä¸ºå®ƒæ˜¯ç”±å¤„ç†å™¨å¤–éƒ¨çš„ I/O è®¾å¤‡å‘å‡ºçš„ä¿¡å·äº§ç”Ÿçš„ã€‚\nå½“å‰æŒ‡ä»¤æ‰§è¡Œå®Œæ¯•åï¼Œå¤„ç†å™¨æ³¨æ„åˆ°ä¸­æ–­å¼•è„šå˜é«˜ï¼Œäºæ˜¯ä»ç³»ç»Ÿæ€»çº¿è¯»å–å¼‚å¸¸æ•°å­—ï¼Œç„¶åè°ƒç”¨å¯¹åº”çš„ä¸­æ–­å¤„ç†ç¨‹åºã€‚å½“å¤„ç†ç¨‹åºè¿”å›æ—¶ï¼Œå®ƒå°†æ§åˆ¶æƒè¿”å›ç»™ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚éšåç¨‹åºç»§ç»­æ‰§è¡Œï¼Œå°±å¥½åƒä¸­æ–­ä»æœªå‘ç”Ÿè¿‡ä¸€æ ·ã€‚\nå…¶ä½™å‡ ç§å¼‚å¸¸ä½œä¸ºå½“å‰æŒ‡ä»¤çš„æ‰§è¡Œç»“æœåŒæ­¥å‘ç”Ÿï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºæ•…éšœæŒ‡ä»¤ï¼ˆFaulting Instructionï¼‰ã€‚\né™·é˜±å’Œç³»ç»Ÿè°ƒç”¨ ä¸ä¸­æ–­å¤„ç†ç¨‹åºä¸€æ ·ï¼Œé™·é˜±ï¼ˆTrapï¼‰å¤„ç†ç¨‹åºä¹Ÿå°†æ§åˆ¶è¿”å›ç»™ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚å…¶æœ€é‡è¦çš„ç”¨é€”æ˜¯åœ¨ç”¨æˆ·ç¨‹åºå’Œå†…æ ¸ä¹‹é—´æä¾›æ¥å£ï¼Œå³ç³»ç»Ÿè°ƒç”¨ï¼ˆSystem Callï¼‰ã€‚\nç”¨æˆ·ç¨‹åºé€šè¿‡ç³»ç»Ÿè°ƒç”¨å‘å†…æ ¸è¯·æ±‚æœåŠ¡ï¼Œå¦‚è¯»å–æ–‡ä»¶ï¼ˆreadï¼‰ã€åˆ›å»ºæ–°è¿›ç¨‹ï¼ˆforkï¼‰ã€åŠ è½½æ–°ç¨‹åºï¼ˆexecveï¼‰å’Œç»ˆæ­¢å½“å‰è¿›ç¨‹ï¼ˆexitï¼‰ç­‰ã€‚\nåœ¨ç¨‹åºå‘˜çœ‹æ¥ï¼Œç³»ç»Ÿè°ƒç”¨å’Œå¸¸è§„å‡½æ•°æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚ä½†å¸¸è§„å‡½æ•°è¿è¡Œåœ¨ç”¨æˆ·æ€ï¼Œå› æ­¤å…¶å¯æ‰§è¡Œçš„æŒ‡ä»¤ç±»å‹å—é™ï¼Œä¹Ÿåªèƒ½è®¿é—®ç”¨æˆ·æ ˆã€‚è€Œç³»ç»Ÿè°ƒç”¨è¿è¡Œåœ¨å†…æ ¸æ€ï¼Œèƒ½å¤Ÿæ‰§è¡Œç‰¹æƒæŒ‡ä»¤å¹¶è®¿é—®å†…æ ¸æ ˆã€‚\næ•…éšœ æ•…éšœï¼ˆFaultingï¼‰æ˜¯ç”±ä¸€äº›é”™è¯¯çŠ¶å†µå¼•èµ·çš„å¼‚å¸¸ï¼Œè€Œè¿™äº›é”™è¯¯æƒ…å†µæœ‰å¯èƒ½è¢«å¤„ç†ç¨‹åºä¿®æ­£ï¼Œå¦åˆ™å°†è¿”å›åˆ°å†…æ ¸ä¸­çš„ä¸­æ­¢ä¾‹ç¨‹ï¼ˆå›¾ä¸­çš„â€œabortâ€ï¼‰ï¼š\nä¸­æ­¢ ä¸æ•…éšœç›¸æ¯”ï¼Œå¼•å‘ä¸­æ­¢ï¼ˆAbortï¼‰çš„é”™è¯¯çŠ¶å†µæ— æ³•æŒ½æ•‘ã€‚é€šå¸¸æ˜¯ç¡¬ä»¶å‡ºç°é—®é¢˜ï¼Œå¦‚ RAM ä½æŸåå¼•èµ·çš„å¥‡å¶æ ¡éªŒé”™è¯¯ã€‚ä¸­æ­¢å¤„ç†ç¨‹åºæ°¸è¿œä¸ä¼šå°†æ§åˆ¶æƒè¿”å›ç»™åº”ç”¨ç¨‹åºï¼š\nLinux/x86-64 ç³»ç»Ÿä¸­çš„å¼‚å¸¸ Exception Number Description Exception Class 0 Divide Error Fault 13 General Protection Fault Fault 14 Page Fault Fault 18 Machine Check Abort 32-255 OS-defined Exception Interrupt or Trap æ•…éšœå’Œä¸­æ­¢ é™¤æ³•æ•…éšœï¼ˆDivide Errorï¼‰ï¼šå½“åº”ç”¨ç¨‹åºå°è¯•é™¤ä»¥ 0 æˆ–é™¤æ³•æŒ‡ä»¤çš„ç»“æœå¯¹ç›®æ ‡æ“ä½œæ•°æ¥è¯´å¤ªå¤§æ—¶ï¼Œå°±ä¼šå‘ç”Ÿé™¤æ³•æ•…éšœã€‚Unix ä¸ä¼šè¯•å›¾çº æ­£é™¤æ³•æ•…éšœï¼Œè€Œæ˜¯ç›´æ¥ä¸­æ­¢ç¨‹åºï¼› ä¸€èˆ¬ä¿æŠ¤æ•…éšœï¼ˆGeneral Protection Faultï¼‰ï¼šä¸€èˆ¬ä¿æŠ¤æ•…éšœå‡ºç°çš„åŸå› æœ‰å¾ˆå¤šï¼Œé€šå¸¸æ˜¯ç¨‹åºå¼•ç”¨äº†æœªå®šä¹‰çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸï¼Œæˆ–è¯•å›¾å‘åªè¯»æ–‡æœ¬æ®µå†™å…¥ã€‚Linux ä¸ä¼šè¯•å›¾çº æ­£è¯¥æ•…éšœï¼Œè€Œ Shell ä¸€èˆ¬å°†å…¶æŠ¥å‘Šä¸ºåˆ†æ®µæ•…éšœï¼ˆSegmentation Faultsï¼‰ï¼› ç¼ºé¡µæ•…éšœï¼ˆPage Faultï¼‰ï¼šç¨‹åºå¼•ç”¨ä¸åœ¨å†…å­˜è€Œåœ¨ç£ç›˜ä¸Šçš„è™šæ‹Ÿé¡µé¢ä¼šå¯¼è‡´ç¼ºé¡µæ•…éšœã€‚å¤„ç†ç¨‹åºå°†ç£ç›˜ä¸Šåˆé€‚çš„è™šæ‹Ÿå†…å­˜é¡µé¢æ˜ å°„åˆ°ç‰©ç†å†…å­˜é¡µé¢ï¼Œç„¶åé‡æ–°æ‰§è¡Œæ•…éšœæŒ‡ä»¤ï¼› æœºå™¨æ£€æŸ¥ï¼ˆMachine Checkï¼‰ï¼šä¸€æ—¦ç³»ç»Ÿåœ¨æ‰§è¡ŒæŒ‡ä»¤æœŸé—´æ£€æµ‹åˆ°è‡´å‘½çš„ç¡¬ä»¶é”™è¯¯ï¼Œä¾¿ä¼šå‘ç”Ÿæœºå™¨æ£€æŸ¥ã€‚å¤„ç†ç¨‹åºæ°¸è¿œä¸ä¼šå°†æ§åˆ¶æƒè¿”å›ç»™åº”ç”¨ç¨‹åºã€‚ ç³»ç»Ÿè°ƒç”¨ ä¸Šå›¾ä¸­çš„æ¯ä¸ªç³»ç»Ÿè°ƒç”¨éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ•°å­—ï¼Œå¯¹åº”äº†å†…æ ¸ä¸­è·³è½¬è¡¨çš„åç§»é‡ã€‚æ³¨æ„ï¼Œè¯¥è·³è½¬è¡¨ä¸ä¸Šæ–‡æåˆ°çš„å¼‚å¸¸è¡¨ä¸åŒã€‚\nC æ ‡å‡†åº“ä¸ºå¤§å¤šæ•°ç³»ç»Ÿè°ƒç”¨æä¾›äº†ä¸€ç»„åŒ…è£…å‡½æ•°ï¼ˆWrapper Functionï¼‰ï¼Œå®ƒä»¬æ¯”ç›´æ¥ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨æ›´åŠ æ–¹ä¾¿ã€‚ç³»ç»Ÿè°ƒç”¨åŠå…¶ç›¸å…³çš„åŒ…è£…å‡½æ•°è¢«ç»Ÿç§°ä¸ºç³»ç»Ÿçº§å‡½æ•°ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç³»ç»Ÿçº§å‡½æ•°writeä»£æ›¿printfï¼š\n1 2 3 4 5 int main() { write(1, \"hello, world\\n\", 13); _exit(0); } X86-64 ç³»ç»Ÿé€šè¿‡syscallæŒ‡ä»¤ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ï¼Œå…¶æ‰€æœ‰å‚æ•°å‡é€šè¿‡å¯„å­˜å™¨ä¼ é€’ã€‚æŒ‰ç…§æƒ¯ä¾‹ï¼Œå¯„å­˜å™¨ %rax ä¿å­˜ç³»ç»Ÿè°ƒç”¨ç¼–å·ï¼Œå¯„å­˜å™¨ %rdiã€%rsiã€%rdxã€%r10ã€%r8 å’Œ %r9 ä¾æ¬¡ä¿å­˜å„å‚æ•°çš„å€¼ã€‚ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼å°†å†™å…¥åˆ°å¯„å­˜å™¨ %rax ä¸­ï¼Œè‹¥ä¸ºè´Ÿåˆ™è¡¨ç¤ºå‘ç”Ÿäº†ä¸è´Ÿerrnoç›¸å…³çš„é”™è¯¯ã€‚å› æ­¤ï¼Œä¸Šé¢çš„ç¨‹åºå¯ä»¥ç›´æ¥ç”¨æ±‡ç¼–è¯­è¨€è¡¨ç¤ºä¸ºï¼š\nè¿›ç¨‹ è¿›ç¨‹æ˜¯æ­£åœ¨æ‰§è¡Œçš„ç¨‹åºçš„å®ä¾‹ï¼Œç³»ç»Ÿä¸­çš„æ¯ä¸ªç¨‹åºéƒ½åœ¨è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œã€‚ä¸Šä¸‹æ–‡ç”±ç¨‹åºæ­£ç¡®è¿è¡Œæ‰€éœ€çš„çŠ¶æ€ç»„æˆï¼ŒåŒ…æ‹¬å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ç¨‹åºä»£ç å’Œæ•°æ®ã€æ ˆã€é€šç”¨å¯„å­˜å™¨ä¸­çš„å†…å®¹ã€ç¨‹åºè®¡æ•°å™¨ã€ç¯å¢ƒå˜é‡ä»¥åŠæ‰“å¼€ æ–‡ä»¶æè¿°ç¬¦ ã€‚\nè¿›ç¨‹ä¸ºåº”ç”¨æä¾›äº†ä¸¤ä¸ªå…³é”®æŠ½è±¡ï¼š\nä¸€ä¸ªç‹¬ç«‹çš„é€»è¾‘æ§åˆ¶æµï¼Œè®©æˆ‘ä»¬äº§ç”Ÿç¨‹åºç‹¬å å¤„ç†å™¨çš„é”™è§‰ï¼› ä¸€ä¸ªç§æœ‰çš„åœ°å€ç©ºé—´ï¼Œè®©æˆ‘ä»¬äº§ç”Ÿç¨‹åºç‹¬å å†…å­˜çš„é”™è§‰ã€‚ é€»è¾‘æ§åˆ¶æµ è¿›ç¨‹è½®æµä½¿ç”¨å¤„ç†å™¨ã€‚æ¯ä¸ªè¿›ç¨‹æ‰§è¡Œå…¶æµç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œç„¶ååœ¨å…¶ä»–è¿›ç¨‹æ‰§è¡Œæ—¶è¢«æŠ¢å ï¼ˆå³æš‚æ—¶æŒ‚èµ·ï¼‰ã€‚\nå¹¶å‘æµ æ‰§è¡Œæ—¶é—´é‡å çš„ä¸¤ä¸ªé€»è¾‘æ§åˆ¶æµè¢«ç§°ä¸ºå¹¶å‘æµï¼ˆConcurrent Flowï¼‰ï¼Œå®ƒä»¬å¹¶å‘è¿è¡Œã€‚å¦‚ä¸Šå›¾ 8.12 æ‰€ç¤ºï¼Œè¿›ç¨‹ A å’Œ è¿›ç¨‹ B å¹¶å‘è¿è¡Œï¼Œä½†è¿›ç¨‹ B å’Œè¿›ç¨‹ C åˆ™ä¸æ˜¯ã€‚\nå¹¶å‘æµçš„æ¦‚å¿µä¸å¤„ç†å™¨çš„æ ¸æ•°ä»¥åŠè®¡ç®—æœºçš„æ•°é‡æ— å…³ï¼Œåªè¦ä¸¤ä¸ªé€»è¾‘æ§åˆ¶æµåœ¨æ—¶é—´ä¸Šé‡å ï¼Œé‚£ä¹ˆå®ƒä»¬ä¾¿æ˜¯å¹¶å‘çš„ã€‚å¦‚æœä¸¤ä¸ªé€»è¾‘æ§åˆ¶æµåœ¨ä¸åŒçš„å¤„ç†å™¨å†…æ ¸æˆ–è®¡ç®—æœºä¸ŠåŒæ—¶è¿è¡Œï¼Œæˆ‘ä»¬å°±ç§°å®ƒä»¬ä¸ºå¹¶è¡Œæµï¼ˆParallel Flowï¼‰ã€‚æ˜¾ç„¶ï¼Œå¹¶è¡Œæµæ˜¯å¹¶å‘æµçš„å­é›†ã€‚\nç§æœ‰åœ°å€ç©ºé—´ è¿›ç¨‹ä¸ºç¨‹åºæä¾›äº†ç‹¬äº«çš„ç§æœ‰åœ°å€ç©ºé—´ï¼Œä¸ç©ºé—´å†…ç‰¹å®šåœ°å€ç›¸å…³çš„å†…å­˜å­—èŠ‚é€šå¸¸ä¸èƒ½è¢«å…¶ä»–ä»»ä½•è¿›ç¨‹è¯»å–æˆ–å†™å…¥ã€‚å°½ç®¡ç§æœ‰åœ°å€ç©ºé—´çš„å†…å®¹ä¸åŒï¼Œä½†å…¶å…·æœ‰ç›¸åŒçš„ç»„ç»‡ç»“æ„ï¼ˆå›¾ä¸­çš„â€œ%espâ€åº”ä¸ºâ€œ%rspâ€ï¼‰ï¼š\nåœ°å€ç©ºé—´åº•éƒ¨æ˜¯ä¸ºç”¨æˆ·ç¨‹åºä¿ç•™çš„ï¼Œä»£ç æ®µæ€»æ˜¯ä»åœ°å€ 0x400000 å¼€å§‹ã€‚åœ°å€ç©ºé—´é¡¶éƒ¨æ˜¯ä¸ºå†…æ ¸ä¿ç•™çš„ï¼ŒåŒ…å«äº†å†…æ ¸ä¸ºè¿›ç¨‹æ‰§è¡ŒæŒ‡ä»¤ï¼ˆå¦‚ç³»ç»Ÿè°ƒç”¨ï¼‰æ—¶ä½¿ç”¨çš„ä»£ç ã€æ•°æ®å’Œæ ˆã€‚\nç”¨æˆ·æ€å’Œå†…æ ¸æ€ å¤„ç†å™¨é€šè¿‡ä¿å­˜åœ¨æ§åˆ¶å¯„å­˜å™¨ä¸­çš„æ¨¡å¼ä½ï¼ˆMode Bitï¼‰æ¥è¯†åˆ«è¿›ç¨‹å½“å‰äº«æœ‰çš„ç‰¹æƒã€‚å½“æ¨¡å¼ä½è¢«è®¾ç½®æ—¶ï¼Œè¿›ç¨‹è¿è¡Œåœ¨å†…æ ¸æ€ï¼ˆKernel Modeï¼‰ï¼Œåä¹‹åˆ™è¿è¡Œåœ¨ç”¨æˆ·æ€ï¼ˆUser Modeï¼‰ã€‚åœ¨å†…æ ¸æ€ä¸­è¿è¡Œçš„ç¨‹åºå¯ä»¥æ‰§è¡ŒæŒ‡ä»¤é›†ä¸­çš„ä»»æ„æŒ‡ä»¤ï¼Œå¹¶ä¸”èƒ½å¤Ÿè®¿é—®ç³»ç»Ÿä¸­çš„ä»»æ„ä½ç½®ã€‚è€Œåœ¨ç”¨æˆ·æ€ä¸­è¿è¡Œçš„ç¨‹åºåˆ™å—åˆ°é™åˆ¶ï¼Œåªèƒ½ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨é—´æ¥åœ°è®¿é—®å†…æ ¸ä»£ç å’Œæ•°æ®ã€‚\nåº”ç”¨ç¨‹åºçš„è¿›ç¨‹åªèƒ½é€šè¿‡å¼‚å¸¸æ¥ä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ã€‚å½“å¼‚å¸¸å‘ç”Ÿä¸”æ§åˆ¶è½¬ç§»åˆ°å¼‚å¸¸å¤„ç†ç¨‹åºæ—¶ï¼Œå¤„ç†å™¨åˆ‡æ¢åˆ°å†…æ ¸æ€ã€‚éšåå¼‚å¸¸å¤„ç†ç¨‹åºåœ¨å†…æ ¸æ€ä¸­è¿è¡Œï¼Œå¤„ç†å™¨å°†åœ¨å®ƒè¿”å›æ—¶åˆ‡æ¢å›ç”¨æˆ·æ€ã€‚\nä¸Šä¸‹æ–‡åˆ‡æ¢ åœ¨è¿›ç¨‹æ‰§è¡ŒæœŸé—´ï¼Œå†…æ ¸å¯ä»¥æš‚æ—¶æŒ‚èµ·å½“å‰è¿›ç¨‹å¹¶é‡å¯å…ˆå‰è¢«æŠ¢å çš„è¿›ç¨‹ï¼Œè¿™ä¸€è¡Œä¸ºè¢«ç§°ä¸ºè°ƒåº¦ï¼ˆSchedulingï¼‰ã€‚å†…æ ¸è°ƒåº¦æ–°è¿›ç¨‹æ˜¯é€šè¿‡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆContext Switchï¼‰æœºåˆ¶æ¥å®ç°çš„ï¼Œè¯¥æœºåˆ¶ï¼š\nä¿å­˜å½“å‰è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ï¼› æ¢å¤ä¹‹å‰è¢«æŠ¢å è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ï¼› å°†æ§åˆ¶æƒè½¬ç§»ç»™æ–°è¿›ç¨‹ã€‚ ç¨‹åºæ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ—¶å¯èƒ½ä¼šå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚æ¯”å¦‚ç³»ç»Ÿè°ƒç”¨readéœ€è¦è®¿é—®ç£ç›˜ä¸­çš„æ•°æ®ï¼Œå†…æ ¸å¯ä»¥é€šè¿‡ä¸Šä¸‹æ–‡åˆ‡æ¢æ¥è°ƒåº¦å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿™æ ·å°±æ— éœ€ç­‰å¾…æ•°æ®ä»ç£ç›˜åŠ è½½åˆ°å†…å­˜ä¸­ã€‚\nç³»ç»Ÿè°ƒç”¨é”™è¯¯å¤„ç† å½“æ‰§è¡Œ Unix ç³»ç»Ÿçº§å‡½æ•°é‡åˆ°é”™è¯¯æ—¶ï¼Œå®ƒä»¬ä¼šè¿”å› -1 å¹¶è®¾ç½®å…¨å±€æ•´å‹å˜é‡errnoçš„å€¼ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨ç¨‹åºä¸­æ£€æŸ¥è°ƒç”¨æ˜¯å¦å‘ç”Ÿé”™è¯¯ï¼Œå¦‚ï¼š\n1 2 3 4 5 if ((pid = fork()) \u003c 0) { fprintf(stderr, \"fork error: %s\\n\", strerror(errno)); exit(0); } å…¶ä¸­ï¼Œstrerrorå‡½æ•°ä¼šæ ¹æ®errnoçš„å€¼è¿”å›ç›¸å…³çš„æ–‡æœ¬å­—ç¬¦ä¸²ã€‚æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªé”™è¯¯æŠ¥å‘Šï¼ˆError-reportingï¼‰å‡½æ•°ä»¥ç®€åŒ–ä¸Šè¿°ä»£ç ï¼š\n1 2 3 4 5 6 7 8 void unix_error(char *msg) /* Unix-style error */ { fprintf(stderr, \"%s: %s\\n\", msg, strerror(errno)); exit(0); } if ((pid = fork()) \u003c 0) unix_error(\"fork error\"); å½“ç„¶è¿˜å¯ä»¥è¿›ä¸€æ­¥åœ°å°†ä»£ç ç®€åŒ–ä¸ºä¸€ä¸ªé”™è¯¯å¤„ç†ï¼ˆError-handlingï¼‰å‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 9 pid_t Fork(void) { pid_t pid; if ((pid = fork()) \u003c 0) unix_error(\"Fork error\"); return pid; } pid = Fork(); è¿™æ ·æˆ‘ä»¬ä¾¿èƒ½å¤Ÿä½¿ç”¨åŒ…è£…å‡½æ•°Forkä»£æ›¿forkåŠå…¶é”™è¯¯æ£€æŸ¥ä»£ç ã€‚æœ¬ä¹¦ä½¿ç”¨çš„åŒ…è£…å‡½æ•°å‡å®šä¹‰åœ¨ csapp.h å’Œ csapp.c ä¸­ã€‚\nè¿›ç¨‹æ§åˆ¶ è·å–è¿›ç¨‹ ID æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€ä¸”å¤§äº 0 çš„è¿›ç¨‹ IDï¼ˆPIDï¼‰ã€‚å‡½æ•°getpidè¿”å›è°ƒç”¨è¿›ç¨‹çš„ PIDï¼Œè€Œå‡½æ•°getppidåˆ™è¿”å›åˆ›å»ºè°ƒç”¨è¿›ç¨‹çš„è¿›ç¨‹ï¼ˆå³çˆ¶è¿›ç¨‹ï¼‰ çš„ PIDã€‚\n1 2 3 4 #include \u003csys/types.h\u003e #include \u003cunistd.h\u003e pid_t getpid(void); pid_t getppid(void); äºŒè€…è¿”å›å€¼çš„ç±»å‹å‡ä¸ºpid_tï¼Œå®ƒåœ¨ Linux ç³»ç»Ÿçš„sys/types.hæ–‡ä»¶ä¸­è¢«å®šä¹‰ä¸ºintã€‚\nåˆ›å»ºå’Œç»ˆæ­¢è¿›ç¨‹ åœ¨ç¨‹åºå‘˜çœ‹æ¥ï¼Œè¿›ç¨‹æœ‰ä¸‰ç§çŠ¶æ€ï¼š\nè¿è¡Œï¼ˆRunningï¼‰ï¼šè¯¥è¿›ç¨‹è¦ä¹ˆåœ¨ CPU ä¸­æ‰§è¡Œï¼Œè¦ä¹ˆåœ¨ç­‰å¾…å†…æ ¸è°ƒåº¦ï¼› åœæ­¢ï¼ˆStoppedï¼‰ï¼šè¿›ç¨‹æ‰§è¡Œæš‚åœï¼Œå¹¶ä¸”ä¸ä¼šè¢«è°ƒåº¦ï¼› ç»ˆæ­¢ï¼ˆTerminatedï¼‰ï¼šè¿›ç¨‹æ°¸ä¹…åœ°åœæ­¢ã€‚ å‡½æ•°exitä¼šä»¥å‚æ•°statusä½œä¸ºé€€å‡ºçŠ¶æ€ç»ˆæ­¢è¿›ç¨‹ï¼š\n1 2 #include \u003cstdlib.h\u003e void exit(int status); çˆ¶è¿›ç¨‹å¯ä»¥è°ƒç”¨forkå‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„å­è¿›ç¨‹ï¼š\n1 2 3 #include \u003csys/types.h\u003e #include \u003cunistd.h\u003e pid_t fork(void); å­è¿›ç¨‹å°†è·å¾—ä¸€ä¸ªä¸çˆ¶è¿›ç¨‹ç›¸åŒä½†ç‹¬ç«‹çš„ç”¨æˆ·çº§è™šæ‹Ÿå†…å­˜ç©ºé—´å‰¯æœ¬ï¼ŒåŒ…æ‹¬ä»£ç ã€æ•°æ®ã€å †ã€å…±äº«åº“å’Œç”¨æˆ·æ ˆç­‰ã€‚å®ƒè¿˜ä¼šå¾—åˆ°ä¸çˆ¶è¿›ç¨‹ç›¸åŒçš„æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦å‰¯æœ¬ï¼Œå› æ­¤èƒ½å¤Ÿè¯»å†™ä»»æ„çˆ¶è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ã€‚çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¹‹é—´æœ€æ˜¾è‘—çš„åŒºåˆ«ä¾¿æ˜¯ PID ä¸åŒã€‚\nå‡½æ•°forkæ‰§è¡Œä¸€æ¬¡å´è¿”å›ä¸¤æ¬¡ï¼šåœ¨çˆ¶è¿›ç¨‹ä¸­è¿”å›å­è¿›ç¨‹çš„ PIDï¼Œåœ¨å­è¿›ç¨‹ä¸­è¿”å› 0ã€‚ç”±äºå­è¿›ç¨‹çš„ PID å§‹ç»ˆå¤§äº 0 ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿”å›å€¼åˆ¤æ–­ç¨‹åºåœ¨å“ªä¸ªè¿›ç¨‹ä¸­æ‰§è¡Œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 #include \"csapp.h\" int main() { pid_t pid; int x = 1; pid = Fork(); if (pid == 0) { /* Child */ printf(\"child : x=%d\\n\", ++x); exit(0); } /* Parent */ printf(\"parent: x=%d\\n\", --x); exit(0); } è¯¥ç¨‹åºç¼–è¯‘åè¿è¡Œçš„å¯èƒ½ç»“æœä¸ºï¼š\n1 2 3 linux\u003e ./fork parent: x=0 child : x=2 ä»ç»“æœæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼šçˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹å¹¶å‘æ‰§è¡Œï¼Œæˆ‘ä»¬æ°¸è¿œæ— æ³•é¢„æµ‹å…¶æ‰§è¡Œé¡ºåºï¼›å­è¿›ç¨‹çš„åœ°å€ç©ºé—´æ˜¯çˆ¶è¿›ç¨‹çš„å‰¯æœ¬ï¼Œå› æ­¤å½“ç¬¬å…­è¡Œçš„å‡½æ•°Forkè¿”å›æ—¶ï¼Œä¸¤è¿›ç¨‹ä¸­çš„å±€éƒ¨å˜é‡xå‡ä¸º 1ï¼›ä¸¤è¿›ç¨‹å¯¹å˜é‡çš„æ›´æ”¹äº’ä¸å½±å“ï¼Œæ‰€ä»¥æœ€ç»ˆè¾“å‡ºçš„å€¼ä¸åŒã€‚\nç»˜åˆ¶è¿›ç¨‹å›¾ï¼ˆProcess Graphï¼‰å¯¹ç†è§£forkå‡½æ•°å¾ˆæœ‰å¸®åŠ©ï¼Œå¦‚ï¼š\nå›æ”¶å­è¿›ç¨‹ è¿›ç¨‹ç»ˆæ­¢åï¼Œå†…æ ¸ä¸ä¼šç«‹å³å°†å…¶ç§»é™¤ã€‚å®ƒéœ€è¦è¢«å…¶çˆ¶è¿›ç¨‹å›æ”¶ï¼ˆReapï¼‰ï¼Œå¦åˆ™å°†æˆä¸ºåƒµå°¸ï¼ˆZombieï¼‰è¿›ç¨‹ã€‚å½“çˆ¶è¿›ç¨‹å›æ”¶å…¶ç»ˆæ­¢çš„å­è¿›ç¨‹æ—¶ï¼Œå†…æ ¸å°†å­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€ä¼ é€’ç»™çˆ¶è¿›ç¨‹ï¼Œç„¶åå†ä¸¢å¼ƒå®ƒã€‚\nå¦‚æœçˆ¶è¿›ç¨‹ç»ˆæ­¢ï¼Œå†…æ ¸ä¼šå®‰æ’initè¿›ç¨‹ï¼ˆPID ä¸º 1ï¼‰â€œæ”¶å…»â€å­¤å„¿è¿›ç¨‹ï¼›å¦‚æœçˆ¶è¿›ç¨‹åœ¨ç»ˆæ­¢å‰æ²¡æœ‰å›æ”¶åƒµå°¸å­è¿›ç¨‹ï¼Œé‚£ä¹ˆåˆ™ç”±initè¿›ç¨‹å›æ”¶å®ƒä»¬ã€‚\nè¿›ç¨‹é€šè¿‡è°ƒç”¨å‡½æ•°waitpidç­‰å¾…å…¶å­è¿›ç¨‹ç»ˆæ­¢æˆ–åœæ­¢ï¼š\n1 2 3 4 #include \u003csys/types.h\u003e #include \u003csys/wait.h\u003e pid_t waitpid(pid_t pid, int *statusp, int options); // Returns: PID of child if OK, 0 (if WNOHANG), or âˆ’1 on error é»˜è®¤æƒ…å†µä¸‹ï¼ˆå‚æ•°optionsä¸º 0 æ—¶ï¼‰ï¼Œå‡½æ•°waitpidä¼šæš‚åœè°ƒç”¨è¿›ç¨‹ï¼Œç›´è‡³å…¶ç­‰å¾…é›†ï¼ˆWait Setï¼‰ä¸­çš„æŸä¸ªå­è¿›ç¨‹ç»ˆæ­¢ã€‚è¯¥å‡½æ•°å§‹ç»ˆè¿”å›ç¬¬ä¸€ä¸ªç»ˆæ­¢çš„å­è¿›ç¨‹ PIDã€‚æ­¤æ—¶ï¼Œç»ˆæ­¢çš„å­è¿›ç¨‹å·²è¢«å›æ”¶ï¼Œå†…æ ¸ä»ç³»ç»Ÿä¸­åˆ é™¤äº†å®ƒçš„æ‰€æœ‰ç—•è¿¹ã€‚\nè‹¥å‚æ•°pid_tå¤§äº 0 ï¼Œåˆ™ç­‰å¾…é›†ä¸­åªæœ‰ä¸€ä¸ª PID ä¸è¯¥å‚æ•°ç›¸ç­‰çš„å­è¿›ç¨‹ã€‚è‹¥å‚æ•°pid_tç­‰äº -1ï¼Œåˆ™ç­‰å¾…é›†åŒ…å«è°ƒç”¨è¿›ç¨‹çš„æ‰€æœ‰å­è¿›ç¨‹ã€‚\næˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹å‚æ•°optionsçš„å€¼æ¥æ”¹å˜å‡½æ•°waitpidçš„è¡Œä¸ºï¼š\nWNOHANGï¼šå¦‚æœç­‰å¾…é›†ä¸­çš„å­è¿›ç¨‹è¿˜æœªç»ˆæ­¢ï¼Œåˆ™ç«‹å³è¿”å› 0ï¼› WUNTRACEDï¼šæš‚åœè°ƒç”¨è¿›ç¨‹æ‰§è¡Œï¼Œç›´åˆ°ç­‰å¾…é›†ä¸­çš„è¿›ç¨‹ç»ˆæ­¢æˆ–åœæ­¢ï¼ˆé»˜è®¤æƒ…å†µä¸‹ä»…è¿”å›ç»ˆæ­¢çš„å­è¿›ç¨‹ PIDï¼‰ï¼› WCONTINUEDï¼šæš‚åœè°ƒç”¨è¿›ç¨‹æ‰§è¡Œï¼Œç›´åˆ°ç­‰å¾…é›†ä¸­çš„è¿›ç¨‹ç»ˆæ­¢æˆ–ç­‰å¾…é›†ä¸­åœæ­¢çš„è¿›ç¨‹æ”¶åˆ° SIGCONT ä¿¡å·æ¢å¤ã€‚ è‹¥å‚æ•°statuspä¸ä¸ºNULLï¼Œé‚£ä¹ˆwaitpidè¿˜ä¼šå°†è¿”å›çš„å­è¿›ç¨‹çŠ¶æ€ä¿¡æ¯ç¼–ç åˆ°statusä¸­ï¼ˆ*statusp = statusï¼‰ã€‚wait.hæ–‡ä»¶å®šä¹‰äº†å‡ ä¸ªç”¨äºè§£é‡Šå‚æ•°statusçš„å®ï¼š\nWIFEXITED(status)ï¼šå¦‚æœå­è¿›ç¨‹æ­£å¸¸ç»ˆæ­¢ï¼ˆæ¯”å¦‚è°ƒç”¨exitæˆ–è¿”å›ï¼‰ï¼Œåˆ™è¿”å›Trueï¼› WEXITSTATUS(status)ï¼šå¦‚æœWIFEXITED()è¿”å›Trueï¼Œåˆ™è¿”å›ç»ˆæ­¢å­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€ï¼› WIFSIGNALED(status)ï¼šå¦‚æœå­è¿›ç¨‹ç”±äºæœªæ•è·çš„ä¿¡å·è€Œç»ˆæ­¢ï¼Œåˆ™è¿”å›Trueï¼› WTERMSIG(status)ï¼šå¦‚æœWIFSIGNALED()è¿”å›Trueï¼Œåˆ™è¿”å›å¯¼è‡´å­è¿›ç¨‹ç»ˆæ­¢çš„ä¿¡å·ç¼–å·ï¼› WIFSTOPPED(status)ï¼šå¦‚æœè¿”å›çš„å­è¿›ç¨‹å½“å‰å·²åœæ­¢ï¼Œåˆ™è¿”å›Trueï¼› WSTOPSIG(status)ï¼šå¦‚æœWIFSTOPPED()è¿”å›Trueï¼Œåˆ™è¿”å›å¯¼è‡´å­è¿›ç¨‹åœæ­¢çš„ä¿¡å·ç¼–å·ï¼› WIFCONTINUED(status)ï¼šå¦‚æœå­è¿›ç¨‹æ”¶åˆ° SIGCONT ä¿¡å·åæ¢å¤ï¼Œåˆ™è¿”å›Trueã€‚ å¦‚æœè°ƒç”¨è¿›ç¨‹æ²¡æœ‰å­è¿›ç¨‹ï¼Œwaitpidå°†è¿”å› -1 å¹¶å°†å…¨å±€å˜é‡errnoè®¾ä¸ºECHILDï¼›å¦‚æœwaitpidè¢«ä¿¡å·ä¸­æ–­ï¼Œåˆ™è¿”å› -1 å¹¶å°†å…¨å±€å˜é‡errnoè®¾ä¸ºEINTRã€‚\nå‡½æ•°waitæ˜¯waitpidçš„ç®€åŒ–ç‰ˆæœ¬ï¼Œwait(\u0026status)ç­‰æ•ˆäºwaitpid(-1, \u0026status, 0)ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 #include \"csapp.h\" #define N 2 int main() { int status, i; pid_t pid; /* Parent creates N children */ for (i = 0; i \u003c N; i++) if ((pid = Fork()) == 0) /* child */ exit(100 + i); /* Parent reaps N children in no particular order */ while ((pid = waitpid(-1, \u0026status, 0)) \u003e 0) { if (WIFEXITED(status)) printf(\"child %d terminated normally with exit status=%d\\n\", pid, WEXITSTATUS(status)); else printf(\"child %d terminated abnormally\\n\", pid); } /* The only normal termination is if there are no more children */ if (errno != ECHILD) unix_error(\"waitpid error\"); exit(0); } å¦‚ç¤ºä¾‹ç¨‹åºæ‰€ç¤ºï¼Œçˆ¶è¿›ç¨‹é¦–å…ˆè°ƒç”¨Forkåˆ›å»ºäº†ä¸¤ä¸ªé€€å‡ºçŠ¶æ€å”¯ä¸€çš„å­è¿›ç¨‹ï¼ˆexit(100+i)ï¼‰ã€‚ éšååœ¨ While å¾ªç¯çš„æµ‹è¯•æ¡ä»¶ä¸­é€šè¿‡waitpidç­‰å¾…å…¶æ‰€æœ‰çš„å­è¿›ç¨‹ç»ˆæ­¢ï¼Œå¹¶æ‰“å°å­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€ã€‚æœ€ç»ˆæ‰€æœ‰çš„å­è¿›ç¨‹å‡è¢«å›æ”¶ï¼Œwaitpidè¿”å› -1 ä¸”å°†å…¨å±€å˜é‡errnoè®¾ä¸ºECHILDï¼Œå‡½æ•°æ‰§è¡Œå®Œæ¯•ã€‚\nåœ¨ Linux ç³»ç»Ÿä¸Šè¿è¡Œè¯¥ç¨‹åºæ—¶ï¼Œå®ƒä¼šäº§ç”Ÿä»¥ä¸‹è¾“å‡ºï¼š\n1 2 3 linux\u003e ./waitpid1 child 22966 terminated normally with exit status=100 child 22967 terminated normally with exit status=101 å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œçˆ¶è¿›ç¨‹å›æ”¶å­è¿›ç¨‹çš„é¡ºåºæ˜¯éšæœºçš„ã€‚æˆ‘ä»¬å¯ä»¥å¯¹ä¸Šè¿°ç¨‹åºè¿›è¡Œä¸€å®š ä¿®æ”¹ï¼Œä»è€Œä½¿å…¶æŒ‰å­è¿›ç¨‹çš„ PID é¡ºåºè¾“å‡ºã€‚\nè®©è¿›ç¨‹ä¼‘çœ  å‡½æ•°sleepå¯ä»¥è®©è¿›ç¨‹æš‚åœæ‰§è¡Œä¸€æ®µæ—¶é—´ï¼š\n1 2 3 #include \u003cunistd.h\u003e unsigned int sleep(unsigned int secs); // Returns: seconds left to sleep å¦‚æœè¯·æ±‚çš„æš‚åœæ—¶é—´å·²ç»è¿‡å»ï¼Œåˆ™å‡½æ•°è¿”å› 0ï¼›å¦‚æœè¯¥è¿›ç¨‹è¢«ä¿¡å·ä¸­æ–­ï¼Œåˆ™è¿”å›å‰©ä½™çš„æš‚åœæ—¶é—´ã€‚\nå‡½æ•°pauseä¼šä½¿è°ƒç”¨è¿›ç¨‹è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œç›´è‡³æ”¶åˆ°ä¿¡å·ã€‚è¯¥å‡½æ•°å§‹ç»ˆè¿”å› -1:\n1 2 #include \u003cunistd.h\u003e int pause(void); åŠ è½½å¹¶è¿è¡Œç¨‹åº å‡½æ•°execveåœ¨å½“å‰è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­åŠ è½½å¹¶è¿è¡Œä¸€ä¸ªæ–°ç¨‹åºï¼š\n1 2 #include \u003cunistd.h\u003e int execve(const char *filename, const char *argv[], const char *envp[]); å‚æ•°filenameæ˜¯åŠ è½½å¹¶è¿è¡Œçš„å¯æ‰§è¡Œæ–‡ä»¶åç§°ï¼Œargvå’Œenvpåˆ™åˆ†åˆ«æ˜¯å‚æ•°å’Œç¯å¢ƒå˜é‡åˆ—è¡¨ã€‚å‡½æ•°execveé€šå¸¸æ²¡æœ‰è¿”å›å€¼ï¼Œä»…åœ¨å‡ºç°é”™è¯¯æ—¶è¿”å› -1ã€‚\nå˜é‡argvæŒ‡å‘ä¸€ä¸ªä»¥NULLä¸ºç»“å°¾çš„æŒ‡é’ˆæ•°ç»„ï¼Œå…¶ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æŒ‡å‘ä¸€ä¸ªå‚æ•°å­—ç¬¦ä¸²ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œargv[0]æ˜¯å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶åç§°ï¼›å˜é‡envpä¹ŸæŒ‡å‘ä¸€ä¸ªä»¥NULLç»“å°¾çš„æŒ‡é’ˆæ•°ç»„ï¼Œå…¶ä¸­çš„æ¯ä¸ªå…ƒç´ å‡æŒ‡å‘ä¸€ä¸ªç¯å¢ƒå˜é‡å­—ç¬¦ä¸²ï¼Œæ¯ä¸ªå­—ç¬¦ä¸²éƒ½æ˜¯ä¸€ä¸ªname=valueå½¢å¼çš„é”®å€¼å¯¹ã€‚ä¸¤è€…çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š\nexecveåŠ è½½æ–‡ä»¶ååï¼Œä¼šè°ƒç”¨å¯åŠ¨ä»£ç ã€‚ å¯åŠ¨ä»£ç è®¾ç½®æ ˆå¹¶å°†æ§åˆ¶æƒä¼ é€’ç»™æ–°ç¨‹åºçš„mainå‡½æ•°ï¼Œå…¶åŸå‹ä¸ºï¼š\n1 int main(int argc, char *argv[], char *envp[]); mainå‡½æ•°æ‰§è¡Œæ—¶çš„ç”¨æˆ·æ ˆç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä»æ ˆåº•åˆ°æ ˆé¡¶åˆ†åˆ«æ˜¯ï¼šç¯å¢ƒå˜é‡å­—ç¬¦ä¸²ã€å‚æ•°å­—ç¬¦ä¸²ã€æŒ‡å‘ç¯å¢ƒå˜é‡å­—ç¬¦ä¸²çš„æŒ‡é’ˆæ•°ç»„å’ŒæŒ‡å‘å‚æ•°å­—ç¬¦ä¸²çš„æŒ‡é’ˆæ•°ç»„ã€‚è¯¥å‡½æ•°çš„ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä¿å­˜åœ¨ä¸åŒçš„å¯„å­˜å™¨ä¸­ï¼šå‚æ•°argcç»™å‡ºæ•°ç»„argv[]ä¸­çš„éç©ºæŒ‡é’ˆæ•°é‡ï¼›å‚æ•°argvæŒ‡å‘æ•°ç»„argv[]ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ ï¼›å‚æ•°envpåˆ™æŒ‡å‘æ•°ç»„envp[]ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼š\nLinux æä¾›äº†å‡ ä¸ªç”¨äºæ“ä½œç¯å¢ƒå˜é‡æ•°ç»„çš„å‡½æ•°ï¼š\n1 2 3 4 #include \u003cstdlib.h\u003e char *getenv(const char *name); int setenv(const char *name, const char *newvalue, int overwrite); void unsetenv(const char *name); å¦‚æœæ•°ç»„ä¸­åŒ…å«ä»¥å‚æ•°nameä¸ºé”®çš„å­—ç¬¦ä¸²ï¼Œåˆ™å‡½æ•°getenvè¿”å›å…¶å¯¹åº”çš„å€¼ï¼Œå‡½æ•°unsetenvåˆ é™¤è¯¥å­—ç¬¦ä¸²ï¼Œå‡½æ•°setenvå°†å€¼æ›¿æ¢ä¸ºå‚æ•°newvalueï¼ˆoverwriteéé›¶æ—¶ï¼‰ï¼›å¦‚æœä¸å­˜åœ¨ä»¥nameä¸ºé”®çš„å­—ç¬¦ä¸²ï¼Œåˆ™å‡½æ•°setenvä¼šå°†name=newvalueæ·»åŠ åˆ°æ•°ç»„ä¸­ã€‚\nä½¿ç”¨ fork å’Œ execve è¿è¡Œç¨‹åº Unix shell å’Œ Web æœåŠ¡å™¨ç­‰ç¨‹åºå¤§é‡ä½¿ç”¨äº†forkå’Œexecveå‡½æ•°ã€‚æœ¬ä¹¦æä¾›äº†ä¸€ä¸ªç®€å•çš„ shell ç¨‹åºï¼Œå…¶ç¼ºé™·åœ¨äºæ²¡æœ‰å›æ”¶ä»»ä½•åå°è¿è¡Œçš„å­è¿›ç¨‹ã€‚æˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸‹ä¸€èŠ‚ä»‹ç»çš„ä¿¡å·æ¥è§£å†³è¿™ä¸€é—®é¢˜ã€‚\nä¿¡å· ä¿¡å·ï¼ˆSignalï¼‰æ˜¯ä¸€ç§é«˜çº§çš„å¼‚å¸¸æ§åˆ¶æµï¼Œå®ƒå…è®¸è¿›ç¨‹å’Œå†…æ ¸å°†æŸäº›ç±»å‹çš„ç³»ç»Ÿäº‹ä»¶é€šçŸ¥ç»™å…¶ä»–è¿›ç¨‹ã€‚Linux æ”¯æŒçš„ä¿¡å·ç±»å‹å¤šè¾¾ä¸‰åç§ï¼š\nä½çº§åˆ«çš„ç¡¬ä»¶å¼‚å¸¸ç”±å†…æ ¸ä¸­çš„å¼‚å¸¸å¤„ç†ç¨‹åºå¤„ç†ï¼Œé€šå¸¸ä¸ä¼šå¯¹ç”¨æˆ·è¿›ç¨‹å¯è§ï¼Œè€Œä¿¡å·åˆ™å¯ä»¥å°†æ­¤ç±»å¼‚å¸¸æš´éœ²ç»™ç”¨æˆ·è¿›ç¨‹ã€‚å¦‚æœä¸€ä¸ªè¿›ç¨‹è¯•å›¾é™¤ä»¥ 0ï¼Œå†…æ ¸å°±ä¼šå‘å®ƒå‘é€ä¸€ä¸ª SIGFPEï¼ˆç¼–å· 8ï¼‰ä¿¡å·ã€‚\nä¿¡å·æœ¯è¯­ å‘é€ä¿¡å·åˆ°ç›®æ ‡è¿›ç¨‹éœ€è¦å®Œæˆä¸¤ä¸ªæ­¥éª¤ï¼š\nå‘é€ï¼ˆä¼ é€’ï¼‰ä¿¡å·ï¼šå†…æ ¸é€šè¿‡æ›´æ–°ç›®æ ‡è¿›ç¨‹ä¸Šä¸‹æ–‡ä¸­çš„æŸäº›çŠ¶æ€æ¥å‘ç›®æ ‡è¿›ç¨‹å‘é€ä¿¡å·ã€‚å‘é€ä¿¡å·çš„åŸå› æœ‰ä¸¤ç§ï¼šâ‘  å†…æ ¸æ£€æµ‹åˆ°ç³»ç»Ÿäº‹ä»¶çš„å‘ç”Ÿï¼Œå¦‚è¢« 0 é™¤é”™è¯¯æˆ–å­è¿›ç¨‹ç»ˆæ­¢ç­‰ï¼›â‘¡ è¿›ç¨‹è°ƒç”¨äº†killå‡½æ•°ï¼ˆå°†åœ¨ä¸‹ä¸€èŠ‚ä»‹ç»ï¼‰ã€‚è¿›ç¨‹å¯ä»¥å‘è‡ªå·±å‘é€ä¿¡å·ï¼› æ¥æ”¶ä¿¡å·ï¼šå½“å†…æ ¸å¼ºåˆ¶ç›®æ ‡è¿›ç¨‹ä»¥æŸç§æ–¹å¼å¯¹ä¿¡å·åšå‡ºå“åº”æ—¶ï¼Œå®ƒä¾¿æ¥æ”¶åˆ°äº†ä¿¡å·ã€‚è¯¥è¿›ç¨‹å¯ä»¥é€šè¿‡æ‰§è¡Œç”¨æˆ·çº§åˆ«çš„ä¿¡å·å¤„ç†ç¨‹åºï¼ˆSignal Handlerï¼‰æ¥å¿½ç•¥ã€ç»ˆæ­¢æˆ–æ•è·ä¿¡å·ã€‚ å·²å‘é€ä½†è¿˜æœªæ¥æ”¶çš„ä¿¡å·è¢«ç§°ä¸ºå¾…å¤„ç†ä¿¡å·ï¼ˆPending Signalï¼‰ã€‚åœ¨ä»»æ„æ—¶é—´ç‚¹ï¼Œç›¸åŒç±»å‹çš„å¾…å¤„ç†ä¿¡å·æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªã€‚è¿™æ„å‘³ç€å¦‚æœä¸€ä¸ªè¿›ç¨‹å·²ç»æœ‰ä¸€ä¸ªç±»å‹ä¸º k çš„å¾…å¤„ç†ä¿¡å·ï¼Œé‚£ä¹ˆåç»­æ‰€æœ‰å‘é€ç»™è¯¥è¿›ç¨‹çš„ k ç±»å‹ä¿¡å·éƒ½å°†è¢«ä¸¢å¼ƒã€‚è¿›ç¨‹è¿˜å¯ä»¥é€‰æ‹©æ€§åœ°é˜»å¡ï¼ˆBlockï¼‰æŸäº›ä¿¡å·çš„æ¥æ”¶ã€‚\nå‘é€ä¿¡å· è¿›ç¨‹ç»„ æ¯ä¸ªè¿›ç¨‹éƒ½å±äºä¸€ä¸ªè¿›ç¨‹ç»„ï¼ˆProcess Groupï¼‰ï¼Œå®ƒç”±ä¸€ä¸ªæ­£æ•´æ•°çš„è¿›ç¨‹ç»„ ID æ‰€æ ‡è¯†ã€‚getpgrpå‡½æ•°è¿”å›å½“å‰è¿›ç¨‹çš„è¿›ç¨‹ç»„ IDï¼š\n1 2 #include \u003cunistd.h\u003e pid_t getpgrp(void); é»˜è®¤æƒ…å†µä¸‹ï¼Œå­è¿›ç¨‹ä¸å…¶çˆ¶è¿›ç¨‹å±äºåŒä¸€ä¸ªè¿›ç¨‹ç»„ã€‚è¿›ç¨‹å¯ä»¥é€šè¿‡setpgidå‡½æ•°æ”¹å˜è‡ªå·±æˆ–å¦ä¸€ä¸ªè¿›ç¨‹çš„è¿›ç¨‹ç»„ï¼š\n1 2 #include \u003cunistd.h\u003e int setpgid(pid_t pid, pid_t pgid); è¯¥å‡½æ•°ä¼šæŠŠè¿›ç¨‹pidçš„è¿›ç¨‹ç»„æ›´æ”¹ä¸ºpgidã€‚è‹¥å°†å‚æ•°pidæˆ–pgidè®¾ä¸º 0ï¼Œåˆ™ç›¸å½“äºä½¿ç”¨è°ƒç”¨è¿›ç¨‹çš„ PID ä½œä¸ºå‚æ•°ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœè¿›ç¨‹ 15213 è°ƒç”¨å‡½æ•°setpgid(0, 0)ï¼Œé‚£ä¹ˆå°†ä¼šåˆ›å»ºä¸€ä¸ªè¿›ç¨‹ç»„ ID ä¸º 15213 çš„æ–°è¿›ç¨‹ç»„ï¼Œå¹¶ä½¿è¯¥è¿›ç¨‹åŠ å…¥æ­¤ç»„ã€‚\nä»é”®ç›˜å‘é€ä¿¡å· Unix Shell ä½¿ç”¨ä»»åŠ¡ï¼ˆJobï¼‰è¡¨ç¤ºå•ä¸ªå‘½ä»¤è¡Œï¼ˆå¦‚ls | sortï¼‰åˆ›å»ºçš„è¿›ç¨‹ï¼ŒåŒä¸€æ—¶é—´å†…åªèƒ½æœ‰ä¸€ä¸ªå‰å°ä»»åŠ¡å’Œå¤šä¸ªåå°ä»»åŠ¡ã€‚\nåœ¨é”®ç›˜ä¸Šè¾“å…¥ Ctrl+C ä¼šä½¿å†…æ ¸å‘å‰å°è¿›ç¨‹ç»„ä¸­çš„æ‰€æœ‰è¿›ç¨‹å‘é€ SIGINT ä¿¡å·ï¼Œè¿™å°†ç»ˆæ­¢å‰å°ä»»åŠ¡ã€‚åŒæ ·ï¼Œè¾“å…¥ Ctrl+Z ä¼šä½¿å†…æ ¸å‘å‰å°è¿›ç¨‹ç»„ä¸­çš„æ‰€æœ‰è¿›ç¨‹å‘é€ SIGTSTP ä¿¡å·ï¼Œè¿™å°†åœæ­¢ï¼ˆæŒ‚èµ·ï¼‰å‰å°ä»»åŠ¡ã€‚\nä½¿ç”¨ kill å‡½æ•°å‘é€ä¿¡å· è¿›ç¨‹å¯ä»¥è°ƒç”¨killå‡½æ•°å‘å…¶ä»–è¿›ç¨‹ï¼ˆåŒ…æ‹¬å…¶è‡ªèº«ï¼‰å‘é€ä¿¡å·ï¼š\n1 2 3 4 #include \u003csys/types.h\u003e #include \u003csignal.h\u003e int kill(pid_t pid, int sig); // Returns: 0 if OK, âˆ’1 on error è‹¥å‚æ•°pidå¤§äº 0ï¼Œåˆ™è¯¥å‡½æ•°å°†ç¼–å·ä¸ºsigçš„ä¿¡å·å‘é€ç»™è¿›ç¨‹pidï¼›è‹¥å‚æ•°pidç­‰äº 0ï¼Œåˆ™è¯¥å‡½æ•°å°†ä¿¡å·å‘é€ç»™è°ƒç”¨è¿›ç¨‹æ‰€åœ¨è¿›ç¨‹ç»„ä¸­çš„æ‰€æœ‰è¿›ç¨‹ï¼›å¦‚æœå‚æ•°pidå°äº 0ï¼Œåˆ™è¯¥å‡½æ•°å°†ä¿¡å·å‘é€ç»™è¿›ç¨‹ç»„ ID ä¸º|pid|çš„è¿›ç¨‹ç»„ä¸­çš„æ‰€æœ‰è¿›ç¨‹ã€‚\nä½¿ç”¨ alarm å‡½æ•°å‘é€ä¿¡å· è¿›ç¨‹å¯ä»¥è°ƒç”¨alarmå‡½æ•°å‘è‡ªå·±å‘é€ SIGALRM ä¿¡å·ï¼š\n1 2 3 #include \u003cunistd.h\u003e unsigned int alarm(unsigned int secs); // Returns: remaining seconds of previous alarm, or 0 if no previous alarm å†…æ ¸å°†åœ¨secsç§’åå‘è°ƒç”¨è¿›ç¨‹å‘é€ SIGALRM ä¿¡å·ï¼Œå–æ¶ˆæ‰€æœ‰ä¹‹å‰è®¾ç½®çš„alarmï¼Œå¹¶è¿”å›å…¶å‰©ä½™çš„ç§’æ•°ã€‚\næ¥æ”¶ä¿¡å· å½“å†…æ ¸å°†è¿›ç¨‹ p ä»å†…æ ¸æ€åˆ‡æ¢åˆ°ç”¨æˆ·æ€æ—¶ï¼Œå®ƒä¼šæ£€æŸ¥ p æœªé˜»å¡ä¸”æœªå¤„ç†ï¼ˆPending \u0026 ~Blockedï¼‰çš„ä¿¡å·é›†ã€‚é€šå¸¸è¯¥é›†åˆä¸ºç©ºï¼Œå†…æ ¸å°†æ§åˆ¶æƒè½¬ç§»ç»™ p çš„é€»è¾‘æ§åˆ¶æµä¸­çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚ä½†å¦‚æœè¯¥é›†åˆéç©ºï¼Œå†…æ ¸å°±ä¼šé€‰æ‹©ä¿¡å·é›†ä¸­çš„æŸä¸ªä¿¡å· k å¹¶å¼ºåˆ¶ p æ¥æ”¶å®ƒã€‚ä¿¡å·å°†è§¦å‘è¿›ç¨‹å®Œæˆä¸€äº›åŠ¨ä½œï¼ˆActionï¼‰ï¼Œé¢„å®šä¹‰çš„é»˜è®¤åŠ¨ä½œæœ‰ï¼š\nè¿›ç¨‹ç»ˆæ­¢ï¼› è¿›ç¨‹ç»ˆæ­¢å¹¶è½¬å‚¨æ ¸å¿ƒï¼ˆDump Coreï¼Œå³å°†ä»£ç å’Œæ•°æ®å†…å­˜æ®µçš„é•œåƒå†™å…¥ç£ç›˜ï¼‰ï¼› è¿›ç¨‹åœæ­¢ï¼ˆæš‚åœï¼‰ï¼Œç›´åˆ°æ¥æ”¶ SIGCONT ä¿¡å·é‡æ–°å¯åŠ¨ï¼› è¿›ç¨‹å¿½ç•¥è¯¥ä¿¡å·ã€‚ æ¯ç§ä¿¡å·çš„é»˜è®¤åŠ¨ä½œè§ å›¾ 8.26ã€‚é™¤ SIGSTOP å’Œ SIGKILL ä¿¡å·å¤–ï¼Œè¿›ç¨‹è¿˜å¯ä»¥é€šè¿‡å‡½æ•°signalä¿®æ”¹ä¿¡å·çš„é»˜è®¤åŠ¨ä½œï¼š\n1 2 3 4 #include \u003csignal.h\u003e typedef void (*sighandler_t)(int); sighandler_t signal(int signum, sighandler_t handler); // Returns: pointer to previous handler if OK, SIG_ERR on error (does not set errno) è‹¥å‚æ•°handlerä¸ºSIG_IGNï¼Œåˆ™signumç±»å‹çš„ä¿¡å·å°†ä¼šè¢«å¿½ç•¥ï¼›è‹¥å‚æ•°handlerä¸ºSIG_DFLï¼Œåˆ™signumç±»å‹çš„ä¿¡å·çš„åŠ¨ä½œå°†æ¢å¤ä¸ºé»˜è®¤ï¼›è‹¥å‚æ•°handlerä¸ºç”¨æˆ·å®šä¹‰çš„ä¿¡å·å¤„ç†ç¨‹åºåœ°å€ï¼Œåˆ™è¿›ç¨‹æ¥æ”¶åˆ°signumç±»å‹çš„ä¿¡å·åä¼šè°ƒç”¨è¯¥ç¨‹åºï¼Œè¿™ç§æ–¹æ³•è¢«ç§°ä¸ºå®‰è£…å¤„ç†ç¨‹åºï¼ˆInstalling Handlerï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè°ƒç”¨å¤„ç†ç¨‹åºè¢«ç§°ä¸ºæ•è·ä¿¡å·ï¼ˆCatching Signalï¼‰ï¼Œæ‰§è¡Œå¤„ç†ç¨‹åºè¢«ç§°ä¸ºå¤„ç†ä¿¡å·ï¼ˆHandling Signalï¼‰ã€‚\nå¦‚æœæˆ‘ä»¬åœ¨ç¤ºä¾‹ç¨‹åºè¿è¡Œæ—¶æŒ‰ä¸‹ Ctrl+Cï¼Œè¯¥è¿›ç¨‹å°±ä¸ä¼šç›´æ¥ç»ˆæ­¢è€Œæ˜¯è¾“å‡ºä¸€æ®µä¿¡æ¯åæ‰ç»ˆæ­¢ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 #include \"csapp.h\" void handler(int sig) /* SIGINT handler */ { printf(\"Caught SIGINT\\n\"); exit(0); } int main() { /* Install the SIGINT handler */ if (signal(SIGINT, handler) == SIG_ERR) unix_error(\"signal error\"); Pause(); /* Wait for the receipt of a signal */ exit(0); } ä¿¡å·å¤„ç†ç¨‹åºè¿˜å¯ä»¥è¢«å…¶ä»–å¤„ç†ç¨‹åºä¸­æ–­ï¼ˆä¿¡å· $s \\ne t$ï¼‰ï¼š\né˜»å¡ä¿¡å· Linux ä¸ºé˜»å¡ä¿¡å·æä¾›äº†æ˜¾å¼å’Œéšå¼çš„å®ç°æœºåˆ¶ï¼š\néšå¼ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œå†…æ ¸ä¼šé˜»å¡ä»»ä½•ä¸å¤„ç†ç¨‹åºå½“å‰æ­£åœ¨å¤„ç†çš„ä¿¡å·ç±»å‹ç›¸åŒçš„æœªå¤„ç†ä¿¡å·ã€‚æ¯”å¦‚ä¸Šå›¾ 8.31 ä¸­ï¼Œè‹¥ä¿¡å· $t$ çš„ç±»å‹ä¸ $s$ ç›¸åŒï¼Œåˆ™ $t$ å°†åœ¨å¤„ç†ç¨‹åº $S$ è¿”å›å‰æŒç»­æŒ‚èµ·ï¼› æ˜¾å¼ï¼šåº”ç”¨ç¨‹åºå¯ä»¥è°ƒç”¨sigprocmaskç­‰å‡½æ•°é˜»å¡ä¿¡å·æˆ–è§£é™¤ä¿¡å·çš„é˜»å¡ã€‚ 1 2 3 4 5 6 7 8 9 10 #include \u003csignal.h\u003e int sigprocmask(int how, const sigset_t *set, sigset_t *oldset); int sigemptyset(sigset_t *set); int sigfillset(sigset_t *set); int sigaddset(sigset_t *set, int signum); int sigdelset(sigset_t *set, int signum); // Returns: 0 if OK, âˆ’1 on error int sigismember(const sigset_t *set, int signum); // Returns: 1 if member, 0 if not, âˆ’1 on error sigprocmaskå‡½æ•°å¯ä»¥æ”¹å˜å½“å‰é˜»å¡ä¿¡å·çš„é›†åˆï¼ˆè®¾ä¸ºblockedï¼‰ï¼Œå…·ä½“è¡Œä¸ºå–å†³äºå‚æ•°howçš„å€¼ï¼š\nSIG_BLOCKï¼šå°†å‚æ•°setä¸­çš„ä¿¡å·é˜»å¡ï¼ˆblocked = blocked | setï¼‰ï¼› SIG_UNBLOCKï¼šä¸ºsetä¸­çš„ä¿¡å·è§£é™¤é˜»å¡ï¼ˆblocked = blocked \u0026 ~setï¼‰ï¼› SIG_SETMASKï¼šå°†é˜»å¡ä¿¡å·é›†åˆè®¾ä¸ºsetï¼ˆblocked = setï¼‰ã€‚ å¦‚æœå‚æ•°oldsetéç©ºï¼Œåˆ™å…ˆå‰blockedçš„å€¼ä¼šå­˜å‚¨åœ¨oldsetä¸­ã€‚\né™¤æ­¤ä¹‹å¤–ï¼Œå‡½æ•°sigemptysetå°†setåˆå§‹åŒ–ä¸ºç©ºé›†ï¼›sigfillsetå°†æ‰€æœ‰ä¿¡å·åŠ å…¥åˆ°setä¸­ï¼›sigaddsetå°†ç¼–å·ä¸ºsignumçš„ä¿¡å·åŠ å…¥åˆ°setä¸­ï¼›sigdelsetå°†ç¼–å·ä¸ºsignumçš„ä¿¡å·ä»setä¸­åˆ é™¤ï¼›å¦‚æœsignumä¿¡å·åœ¨setä¸­ï¼Œåˆ™å‡½æ•°sigismemberè¿”å› 1ï¼Œå¦åˆ™è¿”å› 0ã€‚\nç¤ºä¾‹ç¨‹åºæš‚æ—¶é˜»å¡äº† SIGINT ä¿¡å·çš„æ¥æ”¶ï¼š\n1 2 3 4 5 6 7 8 9 10 sigset_t mask, prev_mask; sigemptyset(\u0026mask); sigaddset(\u0026mask, SIGINT); /* Block SIGINT and save previous blocked set */ sigprocmask(SIG_BLOCK, \u0026mask, \u0026prev_mask); // Code region that will not be interrupted by SIGINT /* Restore previous blocked set, unblocking SIGINT */ sigprocmask(SIG_SETMASK, \u0026prev_mask, NULL); ç¼–å†™ä¿¡å·å¤„ç†ç¨‹åº å®‰å…¨çš„ä¿¡å·å¤„ç† å¦‚æœå¤„ç†ç¨‹åºå’Œä¸»ç¨‹åºå¹¶å‘åœ°è®¿é—®åŒä¸€ä¸ªå…¨å±€æ•°æ®ç»“æ„ï¼Œå°±ä¼šå‘ç”Ÿä¸å¯é¢„çŸ¥çš„ä¸¥é‡é—®é¢˜ã€‚å› æ­¤æˆ‘ä»¬åœ¨ç¼–å†™ä¿¡å·å¤„ç†ç¨‹åºæ—¶åº”å½“éµå¾ªä»¥ä¸‹å®ˆåˆ™ï¼š\nä½¿ä¿¡å·å¤„ç†ç¨‹åºå°½å¯èƒ½çš„ç®€å•ï¼› ä»…è°ƒç”¨å¼‚æ­¥ä¿¡å·å®‰å…¨ï¼ˆAsync-Signal-Safeï¼‰çš„å‡½æ•°ã€‚è¿™ç§å‡½æ•°ä¸€èˆ¬åªè®¿é—®å±€éƒ¨å˜é‡ï¼Œæˆ–è€…ä¸ä¼šè¢«å…¶ä»–ä¿¡å·å¤„ç†ç¨‹åºä¸­æ–­ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè®¸å¤šå¸¸ç”¨çš„å‡½æ•°ï¼Œå¦‚printfã€sprintfã€mallocå’Œexitç­‰å¹¶éå¼‚æ­¥ä¿¡å·å®‰å…¨ã€‚è°ƒç”¨writeå‡½æ•°æ˜¯ä¿¡å·å¤„ç†ç¨‹åºç”Ÿæˆè¾“å‡ºçš„å”¯ä¸€å®‰å…¨æ–¹æ³•ï¼› ä¿å­˜å¹¶æ¢å¤å˜é‡errnoï¼šè®¸å¤š Linux å¼‚æ­¥ä¿¡å·å®‰å…¨å‡½æ•°è¿”å›é”™è¯¯æ—¶ä¼šè®¾ç½®å˜é‡errnoçš„å€¼ï¼Œå› æ­¤å¯èƒ½ä¼šå¹²æ‰°ç¨‹åºä¸­å…¶ä»–ä¾èµ–errnoçš„éƒ¨åˆ†ã€‚å½“å¤„ç†ç¨‹åºæœ‰è¿”å›æ—¶ï¼Œæˆ‘ä»¬åº”å½“åœ¨è°ƒç”¨å‰å°†errnoä¿å­˜åˆ°å±€éƒ¨å˜é‡ä¸­ï¼Œå¹¶åœ¨è¿”å›å‰æ¢å¤å…¶å€¼ï¼› è®¿é—®å…¨å±€æ•°æ®ç»“æ„æ—¶é˜»å¡æ‰€æœ‰ä¿¡å·ï¼› å‡è®¾ä¸»ç¨‹åºå’Œä¿¡å·å¤„ç†ç¨‹åºå…±äº«å…¨å±€å˜é‡gï¼Œå¤„ç†ç¨‹åºæ›´æ–°gçš„å€¼ï¼Œä¸»ç¨‹åºå®šæœŸè¯»å–gçš„å€¼ã€‚ä¼˜åŒ–çš„ç¼–è¯‘å™¨ä¼šä»å¯„å­˜å™¨ä¸­è¯»å–å·²ç¼“å­˜çš„gï¼Œå› æ­¤ä¸»å‡½æ•°ä¸­çš„gå¯èƒ½æ°¸è¿œä¸å˜ï¼Œå¹¶ä¸”æ¯æ¬¡å¯¹gçš„å¼•ç”¨ä¹Ÿéƒ½æ˜¯å®‰å…¨çš„ã€‚è‹¥ä½¿ç”¨volatileå£°æ˜å…¨å±€å˜é‡ï¼Œå¦‚volatile int g;ï¼Œé‚£ä¹ˆå½“ä»£ç å¼•ç”¨gæ—¶ï¼Œç¼–è¯‘å™¨å°±ä¼šä»å†…å­˜ä¸­è¯»å–å…¶å€¼ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åº”å½“ä¸´æ—¶é˜»å¡ä¿¡å·ä»¥ä¿æŠ¤å¯¹gçš„è®¿é—®ï¼› åœ¨å¸¸è§çš„è®¾è®¡ä¸­ï¼Œå¤„ç†ç¨‹åºé€šè¿‡å†™å…¥å…¨å±€æ ‡è¯†ï¼ˆFlagï¼‰æ¥è®°å½•ä¿¡å·çš„æ¥æ”¶ã€‚è‹¥ä½¿ç”¨sig_atomic_tç±»å‹å£°æ˜æ ‡è¯†ï¼Œå¦‚volatile sig_atomic_t flag;ï¼Œé‚£ä¹ˆä¾¿å¯ä»¥ä¿è¯flagå†™å…¥çš„åŸå­æ€§ï¼ˆAtomic/Uninterruptibleï¼‰ã€‚ æ­£ç¡®çš„ä¿¡å·å¤„ç† ä¸Šæ–‡æåˆ°ï¼Œçˆ¶è¿›ç¨‹å¿…é¡»å›æ”¶å­è¿›ç¨‹ä»¥é¿å…åœ¨ç³»ç»Ÿä¸­ç•™ä¸‹åƒµå°¸è¿›ç¨‹ï¼Œä½†æˆ‘ä»¬ä¹Ÿå¸Œæœ›çˆ¶è¿›ç¨‹å¯ä»¥åœ¨å­è¿›ç¨‹è¿è¡Œæ—¶è‡ªç”±åœ°æ‰§è¡Œå…¶ä»–ä»»åŠ¡ã€‚å› æ­¤æˆ‘ä»¬ä½¿ç”¨ SIGCHILD å¤„ç†ç¨‹åºæ¥å›æ”¶å­è¿›ç¨‹ï¼Œè€Œä¸æ˜¯æ˜¾å¼åœ°è°ƒç”¨waitpidç­‰å¾…å­è¿›ç¨‹ç»ˆæ­¢ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 #include \"csapp.h\" void handler1(int sig) { pid_t pid; if ((pid = waitpid(-1, NULL, 0)) \u003c 0) unix_error(\"waitpid error\"); printf(\"Handler reaped child %d\\n\", (int)pid); Sleep(2); return; } int main() { int i, n; char buf[MAXBUF]; if (signal(SIGCHLD, handler1) == SIG_ERR) unix_error(\"signal error\"); /* Parent creates children */ for (i = 0; i \u003c 3; i++) { if (Fork() == 0) { fprintf(\"Hello from child %d\\n\", (int)getpid()); Sleep(1); exit(0); } } /* Parent waits for terminal input and then processes it */ if ((n = read(STDIN_FILENO, buf, sizeof(buf))) \u003c 0) unix_error(\"read\"); printf(\"Parent processing input\\n\"); while (1) ; exit(0); } ç¤ºä¾‹ç¨‹åºä¸­ï¼Œçˆ¶è¿›ç¨‹å®‰è£…äº†å¤„ç†ç¨‹åºhandler1å¹¶åˆ›å»ºä¸‰ä¸ªå­è¿›ç¨‹ã€‚å®ƒç­‰å¾…æ¥è‡ªç»ˆç«¯çš„è¾“å…¥ï¼Œç„¶åè¿›å…¥ While å¾ªç¯ã€‚æ¯å½“ä¸€ä¸ªå­è¿›ç¨‹ç»ˆæ­¢æ—¶ï¼Œå†…æ ¸å°†å‘é€ä¸€ä¸ª SIGCHLD ä¿¡å·é€šçŸ¥çˆ¶è¿›ç¨‹ã€‚çˆ¶è¿›ç¨‹æ•è·ä¿¡å·åå›æ”¶å­è¿›ç¨‹ï¼Œè¾“å‡ºä¸€æ®µä¿¡æ¯ç„¶åè¿”å›ã€‚\nåœ¨ Linux ä¸Šè¿è¡Œè¯¥ç¨‹åºå¾—åˆ°çš„è¾“å‡ºç»“æœä¸ºï¼š\n1 2 3 4 5 6 7 8 linux\u003e ./signal1 Hello from child 14073 Hello from child 14074 Hello from child 14075 Handler reaped child Handler reaped child CR Parent processing input çˆ¶è¿›ç¨‹åˆ›å»ºäº†ä¸‰ä¸ªå­è¿›ç¨‹ï¼Œç„¶è€Œå´åªå›æ”¶äº†ä¸¤ä¸ªï¼Œè¿™æ˜¯å› ä¸ºåŒä¸€æ—¶é—´å†…ç›¸åŒç±»å‹çš„æœªå¤„ç†ä¿¡å·æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªã€‚ä¿¡å·å¤„ç†ç¨‹åºåœ¨å¤„ç†ç¬¬ä¸€ä¸ªä¿¡å·æ—¶ï¼Œç¬¬äºŒä¸ªä¿¡å·åˆ°è¾¾å¹¶è¢«æ·»åŠ åˆ°æœªå¤„ç†ä¿¡å·é›†ä¸­ã€‚ç”±äºå·²æœ‰ä¸€ä¸ªæœªå¤„ç†çš„ SIGCHLD ä¿¡å·ï¼Œæ­¤æ—¶è‹¥ç¬¬ä¸‰ä¸ªä¿¡å·åˆ°è¾¾ä¾¿ä¼šè¢«ç›´æ¥ä¸¢å¼ƒã€‚å½“å¤„ç†ç¨‹åºè¿”å›åï¼Œå†…æ ¸å‘ç°ç¬¬äºŒä¸ªä¿¡å·è¿˜æœªå¤„ç†ï¼Œäºæ˜¯å¼ºåˆ¶çˆ¶è¿›ç¨‹æ¥æ”¶è¯¥ä¿¡å·å¹¶é‡æ–°æ‰§è¡Œå¤„ç†ç¨‹åºã€‚ç­‰åˆ°å¤„ç†ç¨‹åºå†æ¬¡è¿”å›ï¼Œçˆ¶è¿›ç¨‹å°±ä¸å†æœ‰ä»»ä½•æœªå¤„ç†çš„ SIGCHLD ä¿¡å·äº†ã€‚\næˆ‘ä»¬å¯ä»¥è®©å¤„ç†ç¨‹åºåœ¨è¢«è°ƒç”¨æ—¶å°½å¯èƒ½å¤šåœ°å›æ”¶å­è¿›ç¨‹ä»¥è§£å†³è¿™ä¸€é—®é¢˜ï¼š\n1 2 3 4 5 6 7 8 9 10 11 void handler2(int sig) { pid_t pid; while ((pid = waitpid(-1, NULL, WNOHANG)) \u003e 0) printf(\"Handler reaped child %d\\n\", (int)pid); if (errno != ECHILD) unix_error(\"waitpid error\"); Sleep(2); return; } å¯ç§»æ¤çš„ä¿¡å·å¤„ç† ä¸åŒçš„ç³»ç»Ÿæœ‰ç€ä¸åŒçš„ä¿¡å·å¤„ç†è¯­ä¹‰ï¼Œå› æ­¤ Posix æ ‡å‡†å®šä¹‰äº†sigactionå‡½æ•°ï¼Œå®ƒå…è®¸ç”¨æˆ·åœ¨å®‰è£…ä¿¡å·å¤„ç†ç¨‹åºæ—¶æ˜ç¡®åœ°æŒ‡å®šä»–ä»¬æƒ³è¦çš„è¯­ä¹‰ï¼š\n1 2 3 4 #include \u003csignal.h\u003e int sigaction(int signum, struct sigaction *act, struct sigaction *oldact); // Returns: 0 if OK, âˆ’1 on error ç„¶è€Œsigactionå‡½æ•°ååˆ†ç¬¨é‡ï¼Œå› æ­¤æˆ‘ä»¬å¸¸ä½¿ç”¨å®ƒçš„åŒ…è£…å‡½æ•°Signalï¼š\n1 2 3 4 5 6 7 8 9 10 11 handler_t *Signal(int signum, handler_t *handler) { struct sigaction action, old_action; action.sa_handler = handler; sigemptyset(\u0026action.sa_mask); /* Block sigs of type being handled */ action.sa_flags = SA_RESTART; /* Restart syscalls if possible */ if (sigaction(signum, \u0026action, \u0026old_action) \u003c 0) unix_error(\"Signal error\"); return (old_action.sa_handler); } é¿å…å¹¶å‘é”™è¯¯ ä¸Šæ–‡æåˆ°ï¼Œæˆ‘ä»¬æ°¸è¿œæ— æ³•é¢„æµ‹ä¸¤ä¸ªåŒæ­¥ï¼ˆå¹¶å‘ï¼‰è¿è¡Œçš„å‡½æ•°çš„è°ƒç”¨é¡ºåºã€‚å¦‚æœè°ƒç”¨é¡ºåºä¼šå½±å“ç»“æœçš„æ­£ç¡®æ€§ï¼Œé‚£ä¹ˆè¿™ç§é”™è¯¯å°±è¢«ç§°ä¸ºç«äº‰ï¼ˆRaceï¼‰ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡é˜»å¡ç›¸å…³ä¿¡å·æ¥é¿å…è¿™ä¸€é—®é¢˜ã€‚\næ˜¾å¼ç­‰å¾…ä¿¡å· æœ‰æ—¶å€™ä¸»ç¨‹åºéœ€è¦æ˜¾å¼ç­‰å¾…æŸä¸ªä¿¡å·å¤„ç†ç¨‹åºè¿è¡Œå®Œæ¯•ã€‚ä¾‹å¦‚ Linux Shell åˆ›å»ºå‰å°ä»»åŠ¡åï¼Œå¿…é¡»ç­‰å¾…ä»»åŠ¡ç»ˆæ­¢å¹¶è¢« SIGCHLD å¤„ç†ç¨‹åºå›æ”¶ï¼Œç„¶åæ‰èƒ½æ¥æ”¶ä¸‹ä¸€æ¡ç”¨æˆ·å‘½ä»¤ã€‚ç¤ºä¾‹ç¨‹åºå±•ç¤ºäº†å…¶åŸºæœ¬æ€æƒ³ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 #include \"csapp.h\" volatile sig_atomic_t pid; void sigchld_handler(int s) { int olderrno = errno; pid = waitpid(-1, NULL, 0); errno = olderrno; } void sigint_handler(int s) { } int main(int argc, char **argv) { sigset_t mask, prev; Signal(SIGCHLD, sigchld_handler); Signal(SIGINT, sigint_handler); Sigemptyset(\u0026mask); Sigaddset(\u0026mask, SIGCHLD); while (1) { Sigprocmask(SIG_BLOCK, \u0026mask, \u0026prev); /* Block SIGCHLD */ if (Fork() == 0) /* Child */ exit(0); /* Parent */ pid = 0; Sigprocmask(SIG_SETMASK, \u0026prev, NULL); /* Unblock SIGCHLD */ /* Wait for SIGCHLD to be received (wasteful) */ while (!pid) ; /* Do some work after receiving SIGCHLD */ printf(\".\"); } exit(0); } çˆ¶è¿›ç¨‹å…ˆä¸ºä¿¡å· SIGCHLD å’Œ SIGINT å®‰è£…å¤„ç†ç¨‹åºï¼Œç„¶ååˆ›å»ºå­è¿›ç¨‹å¹¶å°†å…¨å±€å˜é‡pidè®¾ä¸º 0ï¼Œæœ€åè¿›å…¥è‡ªæ—‹å¾ªç¯ï¼ˆwhile (!pid)ï¼‰ã€‚å­è¿›ç¨‹ç»ˆæ­¢åï¼Œpidå˜ä¸ºé 0ï¼Œäºæ˜¯çˆ¶è¿›ç¨‹é€€å‡ºè‡ªæ—‹å¾ªç¯ã€‚ä¸ºäº†é˜²æ­¢çˆ¶è¿›ç¨‹è¿›å…¥è‡ªæ—‹å¾ªç¯å‰æ¥æ”¶åˆ° SIGCHLD ï¼Œæˆ‘ä»¬éœ€è¦åœ¨åˆ›å»ºå­è¿›ç¨‹ä¹‹å‰é˜»å¡è¯¥ä¿¡å·ã€‚\nè¿™æ®µä»£ç æ˜¯æ­£ç¡®çš„ï¼Œä½†è‡ªæ—‹å¾ªç¯ä¼šæµªè´¹å¤„ç†å™¨èµ„æºã€‚æˆ‘ä»¬å¯ä»¥å°†å…¶æ”¹ä¸ºï¼š\n1 2 while (!pid) /* Race! */ pause(); é—®é¢˜åœ¨äºï¼šå¦‚æœçˆ¶è¿›ç¨‹åœ¨ While çš„æ¡ä»¶æµ‹è¯•ä¹‹åè€Œpauseçš„æ‰§è¡Œä¹‹å‰æ¥æ”¶åˆ° SIGCHLDï¼Œé‚£ä¹ˆç¨‹åºå°±ä¼šæ°¸è¿œä¼‘çœ ã€‚æˆ‘ä»¬è¿˜å¯ä»¥å°†pauseæ”¹ä¸ºsleepï¼š\n1 2 while (!pid) /* Too slow! */ sleep(1); è¿™æ ·è™½ç„¶é¿å…äº†ç«äº‰é—®é¢˜ï¼Œä½†ä¼šå¢åŠ ç¨‹åºçš„è¿è¡Œæ—¶é—´ã€‚æ­£ç¡®çš„è§£å†³æ–¹æ¡ˆæ˜¯è°ƒç”¨å‡½æ•°sigsuspendï¼š\n1 2 3 #include \u003csignal.h\u003e int sigsuspend(const sigset_t *mask); // Returns: -1 è¯¥å‡½æ•°ä½¿ç”¨å‚æ•°maskæ›¿æ¢å½“å‰çš„é˜»å¡ä¿¡å·é›†åˆï¼Œç„¶åæš‚åœè¿›ç¨‹ç›´è‡³å…¶æ¥æ”¶ä¿¡å·ã€‚å¦‚æœè¯¥ä¿¡å·çš„åŠ¨ä½œæ˜¯ç»ˆæ­¢è¿›ç¨‹ï¼Œåˆ™è¿›ç¨‹ç»ˆæ­¢ä¸”ä¸ä»sigsuspendè¿”å›ï¼›å¦‚æœè¯¥ä¿¡å·çš„åŠ¨ä½œæ˜¯è¿è¡Œä¸€ä¸ªå¤„ç†ç¨‹åºï¼Œåˆ™sigsuspendåœ¨å¤„ç†ç¨‹åºè¿”å›åè¿”å›ï¼Œå¹¶å°†é˜»å¡ä¿¡å·é›†åˆçš„çŠ¶æ€æ¢å¤ã€‚\nå®é™…ä¸Šå®ƒç­‰æ•ˆäºä¸‹åˆ—å‡½æ•°ç»„åˆçš„åŸå­æ€§ï¼ˆAtomicï¼Œå³ä¸å¯ä¸­æ–­ï¼‰ç‰ˆæœ¬ï¼š\n1 2 3 sigprocmask(SIG_SETMASK, \u0026mask, \u0026prev); pause(); sigprocmask(SIG_SETMASK, \u0026prev, NULL); å› æ­¤æˆ‘ä»¬å¯ä»¥å°†ç¤ºä¾‹å‡½æ•°ä¿®æ”¹ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 while (1) { Sigprocmask(SIG_BLOCK, \u0026mask, \u0026prev); /* Block SIGCHLD */ if (Fork() == 0) /* Child */ exit(0); /* Wait for SIGCHLD to be received */ pid = 0; while (!pid) sigsuspend(\u0026prev); /* Optionally unblock SIGCHLD */ Sigprocmask(SIG_SETMASK, \u0026prev, NULL); /* Do some work after receiving SIGCHLD */ printf(\".\"); } éæœ¬åœ°è·³è½¬ C æä¾›äº†ä¸€ç§ç”¨æˆ·çº§åˆ«çš„å¼‚å¸¸æ§åˆ¶æµï¼Œå³éæœ¬åœ°è·³è½¬ï¼ˆNonlocal Jumpï¼‰ã€‚å®ƒæ— éœ€å®Œæˆæ­£å¸¸çš„è°ƒç”¨/è¿”å›åºåˆ—ï¼Œå°±å¯ä»¥å°†æ§åˆ¶æƒä»ä¸€ä¸ªå‡½æ•°ç›´æ¥è½¬ç§»åˆ°å¦ä¸€ä¸ªå½“å‰æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°ã€‚éæœ¬åœ°è·³è½¬æ˜¯é€šè¿‡setjmpå’Œlongjmpå‡½æ•°å®ç°çš„ï¼š\n1 2 3 4 5 6 7 8 #include \u003csetjmp.h\u003e int setjmp(jmp_buf env); int sigsetjmp(sigjmp_buf env, int savesigs); // Returns: 0 from setjmp, nonzero from longjmps void longjmp(jmp_buf env, int retval); void siglongjmp(sigjmp_buf env, int retval); // Never returns setjmpå‡½æ•°å°†å½“å‰è°ƒç”¨ç¯å¢ƒï¼ˆCalling Environmentï¼ŒåŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ã€æ ˆæŒ‡é’ˆå’Œé€šç”¨å¯„å­˜å™¨ç­‰ï¼‰ï¼Œä¿å­˜åœ¨å‚æ•°envæŒ‡å®šçš„ç¼“å†²åŒºä¸­å¹¶è¿”å› 0ã€‚longjmpå‡½æ•°ä¼šä»envç¼“å†²åŒºæ¢å¤è°ƒç”¨ç¯å¢ƒï¼Œç„¶åè§¦å‘æœ€è¿‘è°ƒç”¨çš„setjmpå‡½æ•°çš„è¿”å›ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œsetjmpä¼šè¿”å›ä¸€ä¸ªéé›¶å€¼retvalã€‚åœ¨ä¿¡å·å¤„ç†ç¨‹åºä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨sigsetjmpå’Œsiglongjmpä»£æ›¿å®ƒä»¬ã€‚\néå±€éƒ¨è·³è½¬çš„ä¸€ä¸ªé‡è¦åº”ç”¨æ˜¯å¯ä»¥åœ¨æ£€æµ‹åˆ°æŸäº›é”™è¯¯æ¡ä»¶æ—¶ï¼Œä»æ·±åº¦åµŒå¥—çš„å‡½æ•°è°ƒç”¨ä¸­ç«‹å³è¿”å›ã€‚æˆ‘ä»¬ä½¿ç”¨éæœ¬åœ°è·³è½¬ç›´æ¥è¿”å›åˆ°å¸¸è§çš„é”™è¯¯å¤„ç†ç¨‹åºï¼Œæ— éœ€è´¹åŠ›åœ°å±•å¼€æ ˆï¼ˆUnwind Stackï¼‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 #include \"csapp.h\" jmp_buf buf; int error1 = 0; int error2 = 1; void foo(void), bar(void); int main() { switch (setjmp(buf)) { case 0: foo(); break; case 1: printf(\"Detected an error1 condition in foo\\n\"); break; case 2: printf(\"Detected an error2 condition in foo\\n\"); break; default: printf(\"Unknown error condition in foo\\n\"); } exit(0); } /* Deeply nested function foo */ void foo(void) { if (error1) longjmp(buf, 1); bar(); } void bar(void) { if (error2) longjmp(buf, 2); } ç¤ºä¾‹ç¨‹åºä¸­ä¸»å‡½æ•°é¦–å…ˆè°ƒç”¨setjmpä¿å­˜å½“å‰è°ƒç”¨ç¯å¢ƒï¼Œç„¶åä¾æ¬¡è°ƒç”¨å‡½æ•°fooå’Œbarã€‚ ä¸€æ—¦å‡½æ•°æ‰§è¡Œå‘ç”Ÿé”™è¯¯ï¼Œå®ƒä»¬ä¼šç«‹å³é€šè¿‡longjmpä»setjmpè¿”å›ã€‚setjmpçš„éé›¶è¿”å›å€¼è¡¨ç¤ºé”™è¯¯çš„ç±»å‹ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨ä»£ç ä¸­çš„æŸå¤„å¯¹å…¶è¿›è¡Œå¤„ç†ã€‚\néå±€éƒ¨è·³è½¬çš„å¦ä¸€ä¸ªé‡è¦åº”ç”¨æ˜¯ä»ä¿¡å·å¤„ç†ç¨‹åºè·³è½¬åˆ°ç‰¹å®šä»£ç ä½ç½®ï¼Œè€Œä¸æ˜¯åƒå¾€å¸¸é‚£æ ·è¿”å›åˆ°å› ä¿¡å·ä¸­æ–­çš„æŒ‡ä»¤ã€‚\n","description":"","tags":["OS"],"title":"CSAPP è¯»ä¹¦ç¬”è®°ï¼šå¼‚å¸¸æ§åˆ¶æµ","uri":"/posts/exception-control-flow-note/"},{"content":"å­˜å‚¨ç³»ç»Ÿï¼ˆMemory Systemï¼‰åŒ…å«å¤šä¸ªå±‚çº§ï¼ˆHierarchyï¼‰ï¼Œæ¯ä¸ªå±‚çº§çš„å­˜å‚¨è®¾å¤‡ï¼ˆStorage Deviceï¼‰å…·æœ‰ä¸åŒçš„å®¹é‡ã€æˆæœ¬å’Œè®¿é—®é€Ÿåº¦ã€‚å±‚çº§è¶Šä½ï¼Œå­˜å‚¨è®¾å¤‡çš„å®¹é‡å°±è¶Šå¤§ï¼Œæˆæœ¬ä¹Ÿè¶Šä½ï¼Œä½†è®¿é—®é€Ÿåº¦å´è¶Šæ…¢ã€‚å­˜å‚¨ç³»ç»Ÿçš„å±‚çº§ç»“æ„å¯¹åº”ç”¨æ€§èƒ½æœ‰ç€æ˜¾è‘—çš„å½±å“ï¼Œå…¶ä¸­æœ€ä¸ºé‡è¦çš„ä¾¿æ˜¯ CPU ä¸ä¸»å­˜å‚¨å™¨ä¹‹é—´çš„é«˜é€Ÿç¼“å­˜ã€‚\nå­˜å‚¨æŠ€æœ¯ éšæœºå­˜å–å­˜å‚¨å™¨ éšæœºå­˜å–å­˜å‚¨å™¨ï¼ˆRandom Access Memoryï¼ŒRAMï¼‰æœ‰ä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯é™æ€ï¼ˆStaticï¼‰çš„ SRAM å’Œ åŠ¨æ€ï¼ˆDynamicï¼‰çš„ DRAMã€‚å…¶ä¸­ï¼ŒSRAM çš„è®¿é—®é€Ÿåº¦æ¯” DRAM æ›´å¿«ï¼Œä¸è¿‡å…¶æˆæœ¬æ˜æ˜¾æ›´é«˜ã€‚SRAM ç”¨äº CPU èŠ¯ç‰‡å†…å¤–çš„ç¼“å­˜ï¼Œè€Œ DRAM åˆ™ç”¨äºä¸»å­˜å‚¨å™¨å’Œå›¾å½¢ç³»ç»Ÿä¸­çš„å¸§ç¼“å­˜ï¼ˆFrame Bufferï¼‰ã€‚\nSRAM SRAM å°†æ¯ä¸ªä½å­˜å‚¨åœ¨ä¸€ä¸ªåŒç¨³æ€ï¼ˆBistableï¼‰çš„å­˜å‚¨å•å…ƒä¸­ï¼Œæ¯ä¸ªå•å…ƒæ˜¯ç”±ä¸€ä¸ªå…­æ™¶ä½“ç®¡ç”µè·¯å®ç°çš„ï¼Œå…¶ç»“æ„ç±»ä¼¼äºä¸‹å›¾ä¸­çš„å€’è½¬æ‘†é”¤ï¼š\nè¯¥ç”µè·¯å°†æ°¸è¿œå¤„äºä¸¤ç§ç”µå‹é…ç½®ï¼ˆçŠ¶æ€ï¼‰ä¹‹ä¸€ã€‚ä»»ä½•å…¶ä»–çš„çŠ¶æ€éƒ½æ˜¯ä¸ç¨³å®šçš„ï¼Œå°†ä¼šå¿«é€Ÿåœ°æœå‘å…¶ä¸­ä¸€ä¸ªç¨³å®šçš„çŠ¶æ€ç§»åŠ¨ã€‚å› æ­¤åªè¦ SRAM é€šç”µï¼Œå°±ä¼šæ°¸ä¹…åœ°ä¿å­˜å…¶å€¼è€Œä¸å—ä¸€äº›æ‰°åŠ¨ï¼ˆå¦‚ç”µå™ªå£°ï¼‰çš„å½±å“ã€‚\nDRAM DRAM å°†æ¯ä¸€ä½å­˜å‚¨ä¸ºä¸€ä¸ªç”µå®¹ä¸Šçš„ç”µè·ï¼Œå…¶å­˜å‚¨å•å…ƒå¯¹ä»»ä½•æ‰°åŠ¨éƒ½ååˆ†æ•æ„Ÿã€‚ç”µæµæ³„éœ²ä¼šå¯¼è‡´ DRAM å•å…ƒåœ¨å¤§çº¦ 10 åˆ° 100 æ¯«ç§’çš„æ—¶é—´å†…å¤±å»ç”µè·ï¼Œå› æ­¤å­˜å‚¨ç³»ç»Ÿå¿…é¡»å®šæœŸåœ°é€šè¿‡è¯»å–å¹¶é‡å†™æ¥åˆ·æ–°å…¶ä¸­çš„æ¯ä¸€ä½ã€‚\nä¼ ç»Ÿçš„ DRAM DRAM èŠ¯ç‰‡ä¸Šçš„ä½å¯ä»¥è¢«åˆ’åˆ†ä¸º $d$ ä¸ªè¶…çº§å•å…ƒï¼ˆSupercellï¼‰ï¼Œæ¯ä¸ªè¶…çº§å•å…ƒåŒ…å« $w$ ä¸ª DRAM å•å…ƒï¼Œå› æ­¤ä¸€ä¸ª $d \\times w$ çš„ DRAM èƒ½å¤Ÿå­˜å‚¨ $dw$ ä½çš„ä¿¡æ¯ã€‚ä¸‹å›¾å±•ç¤ºäº†ä¸€ä¸ª 16 $\\times$ 8 çš„ DRAM èŠ¯ç‰‡ç»“æ„ï¼š\n16 ä¸ªè¶…çº§å•å…ƒè¢«æ’åˆ—æˆä¸€ä¸ª 4 $\\times$ 4 çš„çŸ©é˜µï¼Œå›¾ä¸­æ ‡ä¸ºé˜´å½±çš„è¶…çº§å•å…ƒåœ°å€ä¸º (2, 1)ã€‚ä¿¡æ¯é€šè¿‡å¤–éƒ¨è¿æ¥å™¨ï¼ˆä¹Ÿç§° Pinï¼‰æµå…¥æˆ–æµå‡ºèŠ¯ç‰‡ï¼Œæ¯ä¸ª Pin éƒ½å¯ä»¥æºå¸¦ä¸€ä½ä¿¡å·ã€‚ä¸Šå›¾ä¸­åŒ…å«äº†å…«ä¸ªä¼ è¾“ä¿¡æ¯çš„dataPinï¼Œä»¥åŠä¸¤ä¸ªæºå¸¦è¶…çº§å•å…ƒåœ°å€çš„addrPinã€‚\næ¯ä¸ª DRAM èŠ¯ç‰‡éƒ½è¿æ¥äº†ä¸€ä¸ªè¢«ç§°ä¸ºå­˜å‚¨æ§åˆ¶å™¨ï¼ˆMemory Controllerï¼‰çš„ç”µè·¯ï¼Œå®ƒå¯ä»¥ä¸€æ¬¡ä¼ è¾“ $w$ ä½çš„æ•°æ®ã€‚ä¸ºäº†è¯»å–è¶…çº§å•å…ƒ (i, j) ä¸­çš„å†…å®¹ï¼Œå­˜å‚¨æ§åˆ¶å™¨ä¼šå‘ DRAM å‘é€è¡Œåœ°å€ i å’Œ åˆ—åœ°å€ j çš„å¯»å€è¯·æ±‚ï¼Œåˆ†åˆ«è¢«ç§°ä¸º RASï¼ˆRow Access Strobeï¼‰è¯·æ±‚å’Œ CASï¼ˆColumn Access Strobeï¼‰è¯·æ±‚ã€‚è¯¦ç»†çš„è¯»å–è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nå­˜å‚¨æ§åˆ¶å™¨é¦–å…ˆå‘é€è¡Œåœ°å€è¯·æ±‚ï¼ŒDRAM ä¼šå°†æ•´ä¸ªç¬¬ 2 è¡Œæ‹·è´åˆ°å†…éƒ¨çš„è¡Œç¼“å†²åŒºï¼ˆå›¾ä¸­çš„â€œInternal Row Bufferâ€ï¼‰ä¸­ã€‚ç„¶åå­˜å‚¨æ§åˆ¶å™¨å†å‘é€åˆ—åœ°å€è¯·æ±‚ï¼ŒDRAM å°†ä»è¡Œç¼“å†²åŒºä¸­æ‹·è´è¶…çº§å•å…ƒ (2, 1) çš„å€¼è¿”å›ç»™å­˜å‚¨æ§åˆ¶å™¨ã€‚\nåªè¦å¯¹å­˜å‚¨æ§åˆ¶å™¨è¯»å– DRAM çš„è¿‡ç¨‹æœ‰æ‰€äº†è§£ï¼Œæˆ‘ä»¬å°±èƒ½æ˜ç™½è¶…çº§å•å…ƒçš„æ’åˆ—æ–¹å¼ä¸ºä»€ä¹ˆæ˜¯çŸ©é˜µè€Œéä¸€ç»´çº¿æ€§æ•°ç»„ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼ŒDRAM åŒ…å«äº† 16 ä¸ªè¶…çº§å•å…ƒã€‚å¦‚æœæŒ‰ä¸€ç»´æ•°ç»„æ’åˆ—ï¼Œåˆ™è¶…çº§å•å…ƒçš„åœ°å€èŒƒå›´ä¸º 0 åˆ° 15ï¼Œå› æ­¤å°±éœ€è¦å››ä¸ª Pinï¼ˆå³å››ä½ï¼‰æ¥è¿›è¡Œå¯»å€ã€‚å½“ç„¶ï¼ŒçŸ©é˜µæ’åˆ—æ–¹å¼ä¹Ÿæœ‰ä¸€å®šç¼ºç‚¹ã€‚å­˜å‚¨æ§åˆ¶å™¨è¯»å–è¶…çº§å•å…ƒéœ€è¦åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼Œä»è€Œå¢åŠ äº†è®¿é—®æ—¶é—´ã€‚\nå­˜å‚¨æ¨¡å— DRAM èŠ¯ç‰‡è¢«å°è£…åœ¨å­˜å‚¨æ¨¡å—ï¼ˆMemory Modulesï¼‰ä¸­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nç¤ºä¾‹çš„å­˜å‚¨æ¨¡å—åŒ…å« 8 ä¸ª 8M $\\times$ 8 DRAM èŠ¯ç‰‡ï¼Œèƒ½å¤Ÿå­˜å‚¨ 64 MB çš„æ•°æ®ã€‚æ¯ä¸ªè¶…çº§å•å…ƒå­˜å‚¨ä¸»å­˜å‚¨å™¨ä¸­çš„ä¸€å­—èŠ‚ï¼ˆå…«ä½ï¼‰ä¿¡æ¯ï¼Œå…«ä¸ªè¶…çº§å•å…ƒå°±å¯ä»¥è¡¨ç¤ºä¸€ä¸ªåœ°å€ä¸ºâ€œAâ€çš„ 64 ä½ Wordã€‚å­˜å‚¨æ§åˆ¶å™¨é¦–å…ˆå°†åœ°å€â€œAâ€è½¬æ¢ä¸ºè¶…çº§å•å…ƒåœ°å€ (i, j)ï¼Œç„¶åå°†å…¶å‘é€åˆ°å­˜å‚¨æ¨¡å—ä¸­ã€‚å­˜å‚¨æ¨¡å—ä¼šå‘æ‰€æœ‰çš„ DRAM å¹¿æ’­åœ°å€ i å’Œ jï¼Œä»è€Œå¾—åˆ°æ¯ä¸ª DRAM ä¸­è¶…çº§å•å…ƒ (i, j) çš„å†…å®¹ã€‚å­˜å‚¨æ¨¡å—ä¸­çš„ç”µè·¯ä¼šå°†ç»“æœæ•´åˆä¸ºä¸€ä¸ª 64 ä½çš„ Wordï¼Œæœ€ç»ˆè¿”å›ç»™å­˜å‚¨æ§åˆ¶å™¨ã€‚\næ”¹è¿›çš„ DRAM æˆ‘ä»¬å¯ä»¥å¯¹ä¼ ç»Ÿçš„ DRAM è¿›è¡Œä¼˜åŒ–ä»¥æå‡å…¶è®¿é—®é€Ÿåº¦ï¼š\nFPMï¼ˆFast Page Modeï¼‰DRAMï¼šä¼ ç»Ÿ DRAM å°†æ•´è¡Œæ•°æ®æ‹·è´åˆ°ç¼“å†²åŒºä¸­ï¼Œä½¿ç”¨å…¶ä¸­ä¸€ä¸ªå¹¶ä¸¢å¼ƒå‰©ä½™çš„è¶…çº§å•å…ƒã€‚FPM DRAM å¯ä»¥è¿ç»­è®¿é—®åŒä¸€è¡Œçš„è¶…çº§å•å…ƒï¼Œå› æ­¤é€Ÿåº¦æ›´å¿«ã€‚ä¾‹å¦‚è¯»å–ä¸€è¡Œä¸­çš„å››ä¸ªè¶…çº§å•å…ƒï¼Œä¼ ç»Ÿ DRAM éœ€è¦å‘é€å››æ¬¡ RAS è¯·æ±‚å’Œå››æ¬¡ CAS è¯·æ±‚ï¼Œè€Œ FPM DRAM åˆ™åªéœ€è¦ä¸€æ¬¡ RAS è¯·æ±‚å’Œå››æ¬¡ CAS è¯·æ±‚ï¼› EDOï¼ˆExtended Data Outï¼‰ DRAMï¼šé€šè¿‡å‡å°‘å‘é€ CAS ä¿¡å·çš„æ—¶é—´é—´éš”æ¥å¯¹ FPM DRAM è¿›è¡Œä¼˜åŒ–ï¼› SDRAMï¼ˆSynchronous DRAMï¼‰ï¼šä¸Šæ–‡æåŠçš„æ‰€æœ‰ DRAM éƒ½æ˜¯å¼‚æ­¥ï¼ˆAsynchronousï¼‰åœ°å‘å­˜å‚¨æ§åˆ¶å™¨å‘é€ä¿¡å·çš„ï¼Œå› æ­¤åŒæ­¥çš„ SDRAM ä¼ è¾“æ•°æ®çš„é€Ÿç‡æ›´å¿«ï¼› DDDRï¼ˆDouble Data-Rate Synchronousï¼‰DRAMï¼šä½¿ç”¨æ—¶é’Ÿè¾¹ç¼˜ï¼ˆClock Edgeï¼‰ä½œä¸ºæ§åˆ¶ä¿¡å·æ¥å°† SDRAM çš„é€Ÿåº¦æå‡ä¸€å€ï¼› VRAMï¼ˆVideo RAMï¼‰ï¼šå¸¸ç”¨äºå›¾å½¢ç³»ç»Ÿçš„å¸§ç¼“å­˜ï¼Œå…¶æœ¬è´¨ä¸ FPM DRAM ç±»ä¼¼ã€‚åŒºåˆ«åœ¨äº VRAM é€šè¿‡ä¾æ¬¡å¯¹å†…éƒ¨ç¼“å†²åŒºçš„å†…å®¹ç§»ä½æ¥è¾“å‡ºæ•°æ®ï¼Œå¹¶ä¸”å¯ä»¥å¹¶è¡Œåœ°è¯»å†™å†…å­˜ã€‚ éæ˜“å¤±æ€§å­˜å‚¨å™¨ éæ˜“å¤±æ€§å­˜å‚¨å™¨ï¼ˆNonvolatile Memoryï¼‰åœ¨æ–­ç”µåè¿˜ä¼šç»§ç»­ä¿ç•™å…¶å­˜å‚¨çš„ä¿¡æ¯ã€‚å³ä½¿æœ‰äº›éæ˜“å¤±æ€§å­˜å‚¨å™¨æ˜¯å¯è¯»å†™çš„ï¼Œä½†ç”±äºå†å²åŸå› ï¼Œå®ƒä»¬è¢«ç»Ÿä¸€ç§°ä¸º ROMï¼ˆRead-only Memoryï¼‰ã€‚ä¸åŒç§ç±» ROM çš„åŒºåˆ«åœ¨äºå…¶èƒ½å¤Ÿè¢«é‡æ–°ç¼–ç¨‹ï¼ˆå†™å…¥ï¼‰çš„æœ€å¤§æ¬¡æ•°ï¼Œä»¥åŠå†™å…¥çš„å®ç°æœºåˆ¶ã€‚\nPROMï¼ˆProgrammable ROMï¼‰ï¼šåªèƒ½è¢«ç¼–ç¨‹ä¸€æ¬¡ï¼› EPROMï¼ˆErasable programmable ROMï¼‰ï¼šå¯ä»¥è¢«æ“¦é™¤å’Œé‡æ–°ç¼–ç¨‹çº¦ 1000 æ¬¡ï¼› EEPROMï¼ˆElectrically Erasable PROMï¼‰ï¼šä¸ EPROM ç›¸æ¯”ï¼Œä¸éœ€è¦å•ç‹¬çš„ç‰©ç†ç¼–ç¨‹è®¾å¤‡ï¼Œä½†åªå¯ä»¥é‡æ–°ç¼–ç¨‹ 105 æ¬¡ï¼› é—ªå­˜ï¼ˆFlash Memoryï¼‰ï¼šåŸºäº EEPROM çš„ä¸€é¡¹é‡è¦å­˜å‚¨æŠ€æœ¯ï¼ŒSSD å°±æ˜¯é€šè¿‡é—ªå­˜å®ç°çš„ã€‚ å­˜å‚¨åœ¨ ROM ä¸­çš„ç¨‹åºé€šå¸¸ç§°ä¸ºå›ºä»¶ï¼ˆFirmwareï¼‰ã€‚ä¸€äº›ç³»ç»Ÿä¼šåœ¨å›ºä»¶ä¸­æä¾›ç®€å•çš„è¾“å…¥/è¾“å‡ºåŠŸèƒ½ï¼Œæ¯”å¦‚ PC çš„ BIOSï¼ˆBasic Input/Output Systemï¼‰ã€‚\nè®¿é—®ä¸»å­˜å‚¨å™¨ æ•°æ®é€šè¿‡å…±äº«çš„ç”µæ°”ç®¡é“åœ¨ CPU å’Œ DRAM ä¸»å­˜å‚¨å™¨ä¹‹é—´æµåŠ¨ï¼Œè¿™äº›ç®¡é“è¢«ç§°ä¸ºæ€»çº¿ï¼ˆBusï¼‰ã€‚æ•°æ®ä¼ è¾“çš„è¿‡ç¨‹ç”±ä¸€ç³»åˆ—çš„æ€»çº¿äº‹åŠ¡ï¼ˆBus Transactionï¼‰ç»„æˆï¼Œå…¶ä¸­è¯»äº‹åŠ¡å°†æ•°æ®ä»ä¸»å­˜åŠ è½½åˆ° CPU ä¸­ï¼Œå†™äº‹åŠ¡åˆ™å°†æ•°æ®ä» CPU ä¼ è¾“åˆ°ä¸»å­˜ä¸­ã€‚\næ€»çº¿æ˜¯ä¸€ç»„å¯ä»¥ä¼ è¾“åœ°å€ã€æ•°æ®å’Œæ§åˆ¶ä¿¡å·çš„å¹¶è¡Œçº¿çš„é›†åˆï¼Œå…¶ä¸­æ§åˆ¶æ€»çº¿è´Ÿè´£åŒæ­¥äº‹åŠ¡å¹¶è¯†åˆ«å½“å‰æ­£åœ¨æ‰§è¡Œäº‹åŠ¡çš„ç±»å‹ã€‚ä¸‹å›¾å±•ç¤ºäº†è®¡ç®—æœºç³»ç»Ÿä¸­çš„æ€»çº¿ç»“æ„ï¼š\nå›¾ä¸­çš„â€œI/O Bridgeâ€æ˜¯ä¸€ç»„èŠ¯ç‰‡çš„é›†åˆï¼ŒåŒ…å«äº†ä¸Šæ–‡ä¸­æåˆ°çš„å­˜å‚¨æ§åˆ¶å™¨ã€‚å®ƒä¼šå°†ç³»ç»Ÿæ€»çº¿ï¼ˆå›¾ä¸­çš„â€œSystem busâ€ï¼‰çš„ç”µä¿¡å·è½¬æ¢ä¸ºå­˜å‚¨å™¨æ€»çº¿ï¼ˆå›¾ä¸­çš„â€œMemory busâ€ï¼‰çš„ç”µä¿¡å·ï¼Œåä¹‹äº¦ç„¶ã€‚å½“ CPU æ‰§è¡Œæ•°æ®è¯»å–æŒ‡ä»¤æ—¶ï¼Œå…¶èŠ¯ç‰‡ä¸Šçš„æ€»çº¿æ¥å£ï¼ˆBus Interfaceï¼‰ç”µè·¯ä¼šåœ¨æ€»çº¿ä¸Šåˆå§‹åŒ–ä¸€ä¸ªè¯»äº‹åŠ¡ï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼š\nå†™äº‹åŠ¡çš„è¿‡ç¨‹ä¸ä¹‹ç±»ä¼¼ï¼š\nç£ç›˜å­˜å‚¨ ç£ç›˜ï¼ˆDiskï¼‰æ˜¯ä¸»åŠ›å­˜å‚¨è®¾å¤‡ï¼Œå¯ä»¥å®¹çº³æˆç™¾ä¸Šåƒ GB çš„æ•°æ®ï¼Œä½†å…¶è¯»å†™é€Ÿåº¦å´è¿œè¿œä½äº RAMã€‚æœ¬èŠ‚ä¸­çš„ç£ç›˜ä¸»è¦æŒ‡çš„æ˜¯æ—‹è½¬ç£ç›˜ï¼Œå¹¶ä¸æ¶‰åŠ SSDã€‚\nç£ç›˜æ„é€  ç£ç›˜æ˜¯ç”±ç›˜ç‰‡ï¼ˆPlatterï¼‰ç»„æˆçš„ï¼Œæ¯ä¸ªç›˜ç‰‡éƒ½æœ‰ä¸¤ä¸ªç›˜é¢ï¼ˆSurfaceï¼‰ã€‚ä¸‹å›¾ 6.9(a) å±•ç¤ºäº†ä¸€ä¸ªå…¸å‹ç›˜é¢çš„ç»“æ„ï¼š\næ¯ä¸ªç›˜é¢å‡ç”±ä¸€ç»„è¢«ç§°ä¸ºç£é“ï¼ˆTrackï¼‰çš„åŒå¿ƒç¯æ„æˆï¼Œæ¯æ¡ç£é“åˆå¯ä»¥è¢«åˆ’åˆ†ä¸ºå¤šä¸ªæ‰‡åŒºï¼ˆSectionï¼‰ã€‚æ¯ä¸ªæ‰‡åŒºä¸­éƒ½å­˜å‚¨äº†æ•°é‡ç›¸åŒçš„æ•°æ®ä½ï¼ˆé€šå¸¸ä¸º 512 å­—èŠ‚ï¼‰ï¼Œå®ƒä»¬ä¹‹é—´çš„é—´éš™ï¼ˆGapï¼‰åˆ™åªä¿å­˜æ‰‡åŒºçš„æ ‡è¯†ã€‚\nå¦‚ä¸Šå›¾ 6.9(b) æ‰€ç¤ºï¼ŒæŸ±é¢ï¼ˆCylinderï¼‰æ˜¯æ‰€æœ‰ç›˜é¢ä¸Šä¸ä¸»è½´ï¼ˆSpindleï¼‰ç­‰è·çš„ç£é“çš„é›†åˆã€‚\nç£ç›˜å®¹é‡ ç£ç›˜çš„å®¹é‡ç”±ä»¥ä¸‹ä¸‰ä¸ªå‚æ•°å†³å®šï¼š\nè®°å½•å¯†åº¦ï¼ˆ$bits/in$ï¼‰ï¼šä¸€è‹±å¯¸é•¿åº¦çš„ç£é“ä¸­å­˜å‚¨çš„ä½æ•°ï¼› è½¨é“å¯†åº¦ï¼ˆ$tracks/in$ï¼‰ï¼šä»ä¸»è½´ä¸­å¿ƒå¤„å»¶ä¼¸ä¸€è‹±å¯¸åŠå¾„å†…çš„ç£é“æ•°é‡ï¼› é¢å¯†åº¦ï¼ˆ$bits/in^2$ï¼‰ï¼šè®°å½•å¯†åº¦å’Œè½¨é“å¯†åº¦çš„ä¹˜ç§¯ã€‚ åœ¨ä»¥å‰çš„ç£ç›˜ä¸­ï¼Œæ¯æ¡ç£é“ä¸Šçš„æ‰‡åŒºæ•°é‡æ˜¯ç›¸åŒçš„ã€‚è¿™æ ·å½“é¢å¯†åº¦ä¸Šå‡ä¹‹åï¼Œé—´éš™å°±ä¼šè¶Šæ¥è¶Šå¤§ï¼Œä»è€Œé€ æˆæµªè´¹ã€‚å› æ­¤ç°ä»£å¤§å®¹é‡ç£ç›˜ä½¿ç”¨å¤šåŒºè®°å½•ï¼ˆMultiple Zone Recordingï¼‰æŠ€æœ¯ï¼Œä»¤å¤–éƒ¨ç£é“åŒ…å«çš„æ‰‡åŒºæ•°é‡å¤§äºå†…éƒ¨ç£é“ã€‚\nç£ç›˜æ“ä½œ ç£ç›˜ä½¿ç”¨è¿æ¥åœ¨ä¼ åŠ¨è‡‚ï¼ˆActuator Armï¼‰æœ«ç«¯çš„è¯»/å†™å¤´æ¥è¿›è¡Œè¯»å†™æ“ä½œï¼š\nä¼ åŠ¨è‡‚æ²¿è‡ªèº«æ—‹è½¬è½´ä¸æ–­ç§»åŠ¨ï¼Œå¯ä»¥å°†è¯»/å†™å¤´å®šä½åˆ°ä»»æ„ç£é“ä¸Šï¼Œè¿™ä¸€æ“ä½œè¢«ç§°ä¸ºå¯»é“ï¼ˆSeekï¼‰ã€‚å¦‚ä¸Šå›¾ 6.10(b) æ‰€ç¤ºï¼Œæ‹¥æœ‰å¤šä¸ªç›˜ç‰‡çš„ç£ç›˜çš„æ¯ä¸ªç£é¢éƒ½æœ‰å…¶å¯¹åº”çš„è¯»/å†™å¤´ã€‚ä¸è¿‡åœ¨ä»»ä½•æ—¶åˆ»ï¼Œæ‰€æœ‰çš„è¯»/å†™å¤´å‡å¤„åœ¨ç›¸åŒçš„æŸ±é¢ä¸Šã€‚ä¼ åŠ¨è‡‚çš„ç§»åŠ¨é€Ÿåº¦éå¸¸å¿«ï¼Œå³ä½¿æ˜¯å¾®å°çš„ç°å°˜ä¹Ÿä¼šå¹²æ‰°åˆ°è¯»/å†™å¤´çš„å¯»é“ï¼Œå› æ­¤ç£ç›˜éœ€è¦è¢«å¯†å°åŒ…è£…ã€‚\nç£ç›˜ä»¥æ‰‡åŒºå¤§å°çš„å—ä¸ºå•å…ƒè¿›è¡Œè¯»å†™ï¼Œå…¶è®¿é—®æ—¶é—´å—ä¸‰ä¸ªä¸»è¦å› ç´ çš„å½±å“ï¼š\nå¯»é“æ—¶é—´ï¼šå³ç§»åŠ¨ä¼ åŠ¨è‡‚æ‰€éœ€çš„æ—¶é—´ï¼› æ—‹è½¬å»¶æ—¶ï¼šå½“è¯»/å†™å¤´å®šä½åˆ°ç›®æ ‡ç£é“ä¸Šæ—¶ï¼Œç£ç›˜è¿˜éœ€è¦å°†ç›®æ ‡æ‰‡åŒºçš„é¦–ä¸ªä½æ—‹è½¬åˆ°è¯»/å†™å¤´ä¸‹ï¼Œæ‰€éœ€çš„æ—¶é—´è¢«ç§°ä¸ºæ—‹è½¬å»¶æ—¶ï¼› ä¼ è¾“æ—¶é—´ï¼šç£ç›˜è¯»å†™ç›®æ ‡æ‰‡åŒºå†…å®¹æ‰€éœ€çš„æ—¶é—´ï¼Œç”±ç£ç›˜æ—‹è½¬é€Ÿåº¦å’Œæ¯æ¡ç£é“ä¸­çš„æ‰‡åŒºæ•°é‡æ‰€å†³å®šã€‚ ç›¸æ¯”å…¶ä»–ä¸¤ä¸ªå› ç´ ï¼Œä¼ è¾“æ—¶é—´å°åˆ°å¯ä»¥å¿½ç•¥ã€‚è€Œå¯»é“æ—¶é—´å’Œæ—‹è½¬å»¶æ—¶å¤§è‡´ç›¸ç­‰ï¼Œå› æ­¤å¯ä»¥ç”¨ä¸¤å€çš„å¯»é“æ—¶é—´æ¥ä¼°ç®—ç£ç›˜çš„è®¿é—®æ—¶é—´ã€‚\nç£ç›˜çš„é€»è¾‘å— ä¸ºäº†å‘æ“ä½œç³»ç»Ÿéšè—ç£ç›˜æ„é€ çš„å¤æ‚æ€§ï¼Œç°ä»£ç£ç›˜å°†è‡ªèº«ç®€åŒ–ä¸ºä¸€ä¸ªç”± B ä¸ªé€»è¾‘å—ç»„æˆçš„åºåˆ—ã€‚æ¯ä¸ªé€»è¾‘å—çš„å°ºå¯¸ä¸æ‰‡åŒºå¤§å°ç›¸åŒï¼Œç¼–å·ä¸º 0ï¼Œ1ï¼Œâ€¦ ï¼ŒB - 1ã€‚ç£ç›˜æ§åˆ¶å™¨ï¼ˆDisk Controllerï¼‰è´Ÿè´£ç»´æŠ¤é€»è¾‘å—ç¼–å·ä¸å®é™…ç‰©ç†ç£ç›˜æ‰‡åŒºä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œå®ƒä¼šå°†æ“ä½œç³»ç»Ÿè¯»å–çš„ç›®æ ‡é€»è¾‘å—ç¼–å·è½¬æ¢ä¸ºå”¯ä¸€æ ‡è¯†ç‰©ç†æ‰‡åŒºçš„ä¸‰å…ƒç»„ï¼ˆç£é¢ï¼Œç£é“å’Œæ‰‡åŒºï¼‰ã€‚è¯»å–åˆ°çš„ä¿¡æ¯å°†é¦–å…ˆä¿å­˜åœ¨ç£ç›˜æ§åˆ¶å™¨çš„ç¼“å†²åŒºä¸­ï¼Œç„¶åå†æ‹·è´åˆ°ä¸»å­˜ã€‚\nè¿æ¥çš„ I/O è®¾å¤‡ æ˜¾å¡ã€æ˜¾ç¤ºå™¨ã€é¼ æ ‡ã€é”®ç›˜å’Œç£ç›˜ç­‰è¾“å…¥/è¾“å‡º (I/O) è®¾å¤‡ä½¿ç”¨ I/O æ€»çº¿è¿æ¥åˆ° CPU å’Œä¸»å­˜å‚¨å™¨ä¸Šï¼š\nè®¿é—®ç£ç›˜ CPU ä»ç£ç›˜ä¸­è¯»å–æ•°æ®çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š\nCPU ä½¿ç”¨ Memory-mapped I/O æŠ€æœ¯å‘ I/O è®¾å¤‡å‘é€æŒ‡ä»¤ï¼Œå¦‚ä¸Šå›¾ä¸­ (a) æ‰€ç¤ºã€‚ç³»ç»Ÿä¼šåœ¨åœ°å€ç©ºé—´ä¸­ä¿ç•™ä¸€å—åœ°å€åŒºç”¨äºä¸ I/O è®¾å¤‡çš„é€šä¿¡ï¼Œå…¶ä¸­çš„åœ°å€è¢«ç§°ä¸º I/O Portã€‚æ¯ä¸ªè¿æ¥åˆ°æ€»çº¿ä¸Šçš„è®¾å¤‡éƒ½ä¼šè¢«æ˜ å°„åˆ°ä¸€ä¸ªæˆ–å¤šä¸ª I/O Portã€‚\nCPU å°†å‘é€ä¸‰ä¸ªæŒ‡ä»¤åˆ°ç›®æ ‡ I/O Port æ¥åˆå§‹åŒ–è¯»å–æ“ä½œï¼š\nå‘ŠçŸ¥ç£ç›˜å¯åŠ¨è¯»å–çš„å‘½ä»¤ ç›®æ ‡æ•°æ®æ‰€åœ¨é€»è¾‘å—çš„ç¼–å· æ•°æ®å­˜å‚¨çš„ä¸»å­˜åœ°å€ åœ¨å‘å‡ºè¯·æ±‚ä¹‹åï¼ŒCPU é€šå¸¸ä¼šåœ¨ç£ç›˜è¯»å–æ—¶è¿›è¡Œå…¶ä»–å·¥ä½œã€‚å¦‚ä¸Šå›¾ä¸­ (b) æ‰€ç¤ºï¼Œè®¾å¤‡è‡ªè¡Œæ‰§è¡Œè¯»å†™æ€»çº¿äº‹åŠ¡ï¼Œæ— éœ€ CPU çš„å‚ä¸ï¼Œè¿™ä¸€è¿‡ç¨‹è¢«ç§°ä¸º DMAï¼ˆDirect Memory Access ï¼‰ã€‚å½“æ•°æ®å­˜å‚¨åœ¨ä¸»å­˜ä¸­ä¹‹åï¼Œç£ç›˜æ§åˆ¶å™¨ä¾¿ä¼šå‘ CPU å‘é€ä¸­æ–­ä¿¡å·ä»¥é€šçŸ¥ç£ç›˜è¯»å–å®Œæˆï¼Œå¦‚ä¸Šå›¾ä¸­ (c) æ‰€ç¤ºã€‚\nSSD å›ºæ€ç¡¬ç›˜ï¼ˆSolid State Diskï¼ŒSSDï¼‰æ˜¯ä¸€ç§åŸºäºé—ªå­˜çš„å­˜å‚¨æŠ€æœ¯ï¼Œå…¶åŸºæœ¬ç†å¿µå¦‚ä¸‹ï¼š\nSSD ç”±ä¸€ä¸ªæˆ–å¤šä¸ªé—ªå­˜èŠ¯ç‰‡ä»¥åŠé—ªå­˜è½¬æ¢å±‚ï¼ˆFlash Translation Layerï¼‰ç»„æˆï¼Œå‰è€…ä»£æ›¿äº†æ—‹è½¬ç£ç›˜ä¸­çš„æœºæ¢°é©±åŠ¨å™¨ï¼Œåè€…åˆ™ä¸ç£ç›˜æ§åˆ¶å™¨çš„ä½œç”¨ç›¸åŒã€‚\né—ªå­˜ä¸­åŒ…å«äº† B ä¸ª Blockï¼Œæ¯ä¸ª Block åˆå¯ä»¥åˆ†æˆ P ä¸ª Pageã€‚Page çš„å¤§å°é€šå¸¸åœ¨ 512 å­—èŠ‚åˆ° 4 KB ä¹‹é—´ï¼Œè€Œä¸€ä¸ª Block ä¸€èˆ¬ç”± 32 åˆ° 128 ä¸ª Page ç»„æˆï¼Œå› æ­¤ Block çš„å¤§å°ä¸º 16 KB åˆ° 512 KBã€‚\nSSD ä»¥ Page ä¸ºå•ä½è¿›è¡Œè¯»å†™ï¼Œå¹¶ä¸”åªæœ‰å½“ Page æ‰€åœ¨çš„æ•´ä¸ª Block è¢«æ“¦é™¤ï¼ˆå³æ‰€æœ‰ä½å‡ç½®ä¸º 1ï¼‰åæ‰èƒ½å‘å…¶å†™å…¥ã€‚ä¸è¿‡ï¼Œåªè¦ä¸€ä¸ª Block è¢«æ“¦é™¤ï¼Œå…¶ä¸­çš„æ¯ä¸€ä¸ª Page éƒ½å¯ä»¥è¢«å†™å…¥ä¸€æ¬¡è€Œæ— éœ€å†æ¬¡æ“¦é™¤ã€‚Block ä¼šåœ¨å¤§çº¦ 100,000 æ¬¡é‡å¤å†™å…¥åå‘ç”Ÿç£¨æŸï¼Œæ— æ³•å†è¢«ä½¿ç”¨ã€‚\nSSD çš„éšæœºå†™å…¥é€Ÿåº¦æ¯”è¯»å–æ…¢ï¼Œè¿™æ˜¯å› ä¸ºæ“¦é™¤ Block éœ€è¦ç›¸å¯¹è¾ƒé•¿çš„æ—¶é—´ã€‚å¦å¤–ï¼Œå¦‚æœå†™æ“ä½œå°è¯•ä¿®æ”¹å·²æœ‰æ•°æ®çš„ Pageï¼Œé‚£ä¹ˆå°±å¿…é¡»å…ˆå°†åŒä¸€ Block ä¸­å…¶ä»–ä»»ä½•åŒ…å«æœ‰ç”¨æ•°æ®çš„ Page å¤åˆ¶åˆ°å¦ä¸€ä¸ªå·²è¢«æ“¦é™¤çš„ Block ä¸­ã€‚\nç›¸æ¯”äºæ—‹è½¬ç£ç›˜ï¼ŒSSD çš„éšæœºè®¿é—®é€Ÿåº¦æ›´å¿«ï¼Œæ¶ˆè€—çš„åŠŸç‡æ›´ä½ï¼ŒåŒæ—¶ä¹Ÿæ›´åŠ åšå›ºã€‚\nå±€éƒ¨æ€§ ä¼˜ç§€çš„è®¡ç®—æœºç¨‹åºé€šå¸¸è¡¨ç°å‡ºè‰¯å¥½çš„å±€éƒ¨æ€§ï¼ˆLocalityï¼‰ï¼Œå³ç¨‹åºå¤šæ¬¡å¼•ç”¨ç›¸åŒçš„æ•°æ®æˆ–æœ€è¿‘å¼•ç”¨æ•°æ®é™„è¿‘çš„æ•°æ®ã€‚å‰è€…è¢«ç§°ä¸ºæ—¶é—´å±€éƒ¨æ€§ï¼ˆTemporal Localityï¼‰ï¼Œåè€…åˆ™è¢«ç§°ä¸ºç©ºé—´å±€éƒ¨æ€§ï¼ˆSpatial Localityï¼‰ã€‚\nå±€éƒ¨æ€§åœ¨ç°ä»£è®¡ç®—æœºç³»ç»Ÿçš„å¤šä¸ªå±‚çº§ä¸­éƒ½æœ‰ç€å¹¿æ³›çš„åº”ç”¨ã€‚å¦‚åœ¨ç¡¬ä»¶çº§åˆ«ï¼Œæˆ‘ä»¬å¼•å…¥é«˜é€Ÿç¼“å­˜æ¥åŠ å¿«å¯¹ä¸»å­˜å‚¨å™¨çš„è®¿é—®é€Ÿåº¦ã€‚åœ¨æ“ä½œç³»ç»Ÿçº§åˆ«ï¼Œä¸»å­˜å‚¨å™¨å¯ä»¥ç¼“å­˜ç£ç›˜æ–‡ä»¶ç³»ç»Ÿä¸­æœ€è¿‘ä½¿ç”¨çš„ Blockã€‚åœ¨åº”ç”¨ç¨‹åºçº§åˆ«ï¼ŒWeb æµè§ˆå™¨ä¼šå°†æœ€è¿‘è¯·æ±‚çš„æ–‡æ¡£ç¼“å­˜åˆ°æœ¬åœ°ç£ç›˜ä¸Šã€‚\nå¼•ç”¨ç¨‹åºæ•°æ®çš„å±€éƒ¨æ€§ å˜é‡sumåœ¨æ¯æ¬¡å¾ªç¯ä¸­éƒ½è¢«å¼•ç”¨ä¸€æ¬¡ï¼Œå› æ­¤ä¸Šå›¾ä¸­çš„ä¸¤ä¸ªå‡½æ•°éƒ½å…·æœ‰ä¼˜ç§€çš„æ—¶é—´å±€éƒ¨æ€§ã€‚è€Œå¯¹æ•°ç»„å…ƒç´ a[i][j]æ¥è¯´ï¼Œç¬¬ä¸€ä¸ªå‡½æ•°sumarrayrowsä¼šæŒ‰ç…§å…¶åœ¨å†…å­˜ä¸­å­˜å‚¨çš„é¡ºåºä¾æ¬¡è¯»å–ï¼Œæ‰€ä»¥å¾ªç¯çš„ç©ºé—´å±€éƒ¨æ€§ä¹Ÿååˆ†è‰¯å¥½ã€‚æˆ‘ä»¬å°†æ¯éš” k ä¸ªå…ƒç´ è®¿é—®è¿ç»­å‘é‡çš„æ¨¡å¼ç§°ä¸º stride-k å¼•ç”¨ï¼Œç©ºé—´å±€éƒ¨æ€§éšç€ k çš„å¢åŠ è€Œé™ä½ã€‚æ˜¾ç„¶ï¼Œé‡‡ç”¨ stride-2 å¼•ç”¨æ¨¡å¼çš„å‡½æ•°sumarraycolsçš„ç©ºé—´å±€éƒ¨æ€§è¾ƒå·®ã€‚\nè·å–æŒ‡ä»¤çš„å±€éƒ¨æ€§ æˆ‘ä»¬è¿˜å¯ä»¥è¯„ä¼° CPU è¯»å–å†…å­˜ä¸­ç¨‹åºæŒ‡ä»¤çš„å±€éƒ¨æ€§ã€‚å¾ªç¯ä½“ä¸­çš„æŒ‡ä»¤ä¼šæŒ‰ç…§å­˜å‚¨é¡ºåºä¾æ¬¡æ‰§è¡Œï¼Œå› æ­¤å¾ªç¯å…·æœ‰è‰¯å¥½çš„ç©ºé—´å±€éƒ¨æ€§ã€‚ç”±äºå¾ªç¯ä½“ä¸­çš„æŒ‡ä»¤ä¼šè¢«å¤šæ¬¡è¿­ä»£æ‰§è¡Œï¼Œæ‰€ä»¥ç¨‹åºçš„æ—¶é—´å±€éƒ¨æ€§ä¹Ÿå¾ˆä¼˜ç§€ã€‚ä¸ç¨‹åºæ•°æ®ç›¸æ¯”ï¼ŒæŒ‡ä»¤åœ¨è¿è¡Œæ—¶å¾ˆå°‘è¢«ä¿®æ”¹ã€‚\nå­˜å‚¨ç³»ç»Ÿå±‚çº§ æˆ‘ä»¬å¯ä»¥å°†å­˜å‚¨åœ¨å®¹é‡å¤§è€Œè®¿é—®é€Ÿåº¦æ…¢çš„è®¾å¤‡ä¸­çš„æ•°æ®å¯¹è±¡æš‚å­˜åˆ°å®¹é‡ç›¸å¯¹è¾ƒå°ä½†è®¿é—®é€Ÿåº¦æ›´å¿«çš„åŒºåŸŸä¸­ï¼Œè¿™ä¾¿æ˜¯ç¼“å­˜ï¼ˆCacheï¼‰ã€‚ä¸‹å›¾å±•ç¤ºäº†å­˜å‚¨ç³»ç»Ÿå±‚çº§ä¸­çš„ç¼“å­˜æ¦‚å¿µï¼š\nä¸åŒå±‚çº§çš„è®¾å¤‡ä¹‹é—´ä»¥ Block ä¸ºå•ä½ä¼ è¾“æ•°æ®ï¼Œæ¯ä¸ª Block éƒ½æœ‰å”¯ä¸€çš„åœ°å€æˆ–åç§°ã€‚ç›¸é‚»å±‚çº§è®¾å¤‡ä¹‹é—´çš„ Block çš„å¤§å°ä¸€èˆ¬æ˜¯å›ºå®šçš„ï¼Œä½†ä¹Ÿå¯ä»¥æ˜¯å˜åŒ–çš„ï¼ˆå¦‚å­˜å‚¨åœ¨ Web æœåŠ¡å™¨ä¸Šçš„ HTML æ–‡ä»¶ï¼‰ã€‚ä¸åŒå±‚çº§ä½¿ç”¨çš„ Block å¤§å°å„ä¸ç›¸åŒï¼Œå¦‚ L0 å’Œ L1 ä¹‹é—´çš„ Block é€šå¸¸ä¸ºä¸€ä¸ª Wordï¼Œè€Œ L1 å’Œ L2 ä¹‹é—´çš„ Block åˆ™ä¸ºå››åˆ°å…«ä¸ª Wordã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå±‚çº§è¶Šä½çš„è®¾å¤‡è®¿é—®é€Ÿåº¦è¶Šæ…¢ï¼Œå› æ­¤å…¶ä½¿ç”¨çš„ Block ä¹Ÿä¼šè¶Šå¤§ã€‚\nç¼“å­˜å‘½ä¸­ä¸ç¼ºå¤± å½“ç¨‹åºéœ€è¦è®¿é—®å­˜å‚¨åœ¨ç¬¬ k + 1 çº§è®¾å¤‡ä¸­çš„æ•°æ®å¯¹è±¡ d æ—¶ï¼Œä¼šé¦–å…ˆä»ç¬¬ k çº§è®¾å¤‡ä¸­æŸ¥æ‰¾ã€‚å¦‚æœ d æ°å¥½ç¼“å­˜åœ¨ç¬¬ k çº§è®¾å¤‡ä¸­ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¾¿ç§°ç¼“å­˜å‘½ä¸­ï¼ˆCache Hitsï¼‰ã€‚åä¹‹åˆ™ä¸ºç¼“å­˜ç¼ºå¤±ï¼ˆCache Missesï¼‰ï¼Œç¬¬ k çº§è®¾å¤‡ä¼šä»ç¬¬ k + 1 çº§è®¾å¤‡ä¸­è·å– d æ‰€åœ¨çš„ Blockã€‚å¦‚æœæ­¤æ—¶ç¬¬ k çº§è®¾å¤‡å·²æ»¡ï¼Œåˆ™ç°æœ‰çš„ Block å°†ä¼šè¢«è¦†ç›–ï¼ˆé©±é€ï¼‰ã€‚Block çš„é©±é€ç­–ç•¥ï¼ˆReplacement Policyï¼‰æœ‰å¤šç§ï¼Œæ¯”å¦‚éšæœºæ›¿æ¢å’Œ LRUï¼ˆLeast Recently Usedï¼‰ã€‚LRU ç­–ç•¥ä¼šå°†è¢«è®¿é—®æ—¶é—´æ®ç°åœ¨æœ€ä¹…è¿œçš„ Block é©±é€ã€‚\nç¼“å­˜ç¼ºå¤±æœ‰å¤šç§ä¸åŒç±»å‹ã€‚å¦‚æœç¼“å­˜ä¸ºç©ºï¼Œåˆ™è®¿é—®ä»»ä½•æ•°æ®å¯¹è±¡éƒ½å°†å‘ç”Ÿç¼“å­˜ç¼ºå¤±ï¼Œæˆ‘ä»¬ç§°å…¶ä¸ºå¼ºåˆ¶ç¼ºå¤±ï¼ˆCompulsory Missesï¼‰æˆ–å†·ç¼ºå¤±ï¼ˆCold Missesï¼‰ã€‚\næ¯å½“å‡ºç°ç¼“å­˜ç¼ºå¤±æ—¶ï¼Œç¬¬ k çº§ç¼“å­˜ä¼šæ ¹æ®å…¶æ”¾ç½®ç­–ç•¥ï¼ˆPlacement Policyï¼‰å°†ç¬¬ k + 1 çº§ç¼“å­˜ä¸­çš„ Block æ‹·è´åˆ°æŒ‡å®šä½ç½®å¤„ã€‚Block çš„æ”¾ç½®ç­–ç•¥åŒæ ·æœ‰å¤šç§ï¼Œæœ€ç®€å•çš„ä¾¿æ˜¯éšæœºæ”¾ç½®ã€‚å®ƒçš„ç¼ºç‚¹ååˆ†æ˜æ˜¾ï¼Œå› ä¸ºè¢«éšæœºæ”¾ç½®çš„ Block çš„å¯»å€æˆæœ¬å¾ˆé«˜ã€‚æˆ‘ä»¬å¯ä»¥å°†ç¬¬ k + 1 çº§ç¼“å­˜ä¸­çš„ Block i æ”¾ç½®åœ¨ç¬¬ k çº§ç¼“å­˜ä¸­çš„ Block i mod n å¤„ï¼Œè¯¥ç­–ç•¥è¢«ç§°ä¸ºæ˜ å°„æ”¾ç½®ã€‚è‹¥ n ä¸º 4ï¼Œåˆ™ä¸Šå›¾ä¸­ç¬¬ k + 1 çº§ç¼“å­˜ä¸­çš„ Block 0ã€4ã€8 å’Œ 12 å°†è¢«æ˜ å°„åˆ°ç¬¬ k çº§ç¼“å­˜ä¸­çš„ Block 0ï¼Œè€Œç¬¬ k + 1 çº§ç¼“å­˜ä¸­çš„ Block 1ã€5ã€9 å’Œ 13 åˆ™å°†è¢«æ˜ å°„åˆ°ç¬¬ k çº§ç¼“å­˜ä¸­çš„ Block 1ã€‚\næ˜ å°„æ”¾ç½®çš„ç¼ºç‚¹æ˜¯å®¹æ˜“å¯¼è‡´å†²çªç¼ºå¤±ï¼ˆConflict Missesï¼‰ã€‚å¦‚æœç¨‹åºä¾æ¬¡è¯·æ±‚ç¬¬ k + 1 çº§ç¼“å­˜ä¸­çš„ Block 0ã€4ã€8 å’Œ 12ï¼Œç”±äºå®ƒä»¬å‡è¢«æ˜ å°„åˆ°ç¬¬ k çº§ç¼“å­˜ä¸­çš„ Block 0ï¼Œå› æ­¤å³ä½¿ç¼“å­˜è¶³ä»¥å®¹çº³å››ä¸ª Blockï¼Œä¹Ÿå°†è¿ç»­å‘ç”Ÿç¼“å­˜ç¼ºå¤±ã€‚\nç¨‹åºé€šå¸¸åˆ†å¤šä¸ªé˜¶æ®µï¼ˆå¦‚å¾ªç¯ï¼‰è¿è¡Œï¼Œå…¶ä¸­æ¯ä¸ªé˜¶æ®µéƒ½ä¼šè®¿é—®ä¸€äº›æ’å®šçš„ Block é›†åˆï¼ˆå³å·¥ä½œé›†ï¼‰ã€‚å¦‚æœå·¥ä½œé›†ï¼ˆWorking Setï¼‰è¶…è¿‡äº†ç¼“å­˜çš„å¤§å°ï¼Œé‚£ä¹ˆå°±å°†å‘ç”Ÿå®¹é‡ç¼ºå¤±ï¼ˆCapacity Missesï¼‰ã€‚\nç¼“å­˜ç®¡ç† ä¸åŒçº§åˆ«çš„ç¼“å­˜ç®¡ç†æ˜¯ç”±ç¡¬ä»¶ã€è½¯ä»¶æˆ–ä¸¤è€…çš„ç»„åˆå®ç°çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nç¼“å­˜çš„å®ç°ç»†èŠ‚ å‡è®¾å­˜åœ¨ä¸€ä¸ªç®€å•çš„å­˜å‚¨ç³»ç»Ÿå±‚çº§ç»“æ„ï¼Œåœ¨ CPU å’Œä¸»å­˜å‚¨å™¨ä¹‹é—´åªæœ‰ä¸€ä¸ª L1 çº§çš„é«˜é€Ÿç¼“å­˜ã€‚æˆ‘ä»¬å°†é€šè¿‡è¯¥æ¨¡å‹ä»‹ç»ç¼“å­˜çš„å…·ä½“å®ç°ç»†èŠ‚ã€‚\né€šç”¨ç¼“å­˜ç®¡ç† å‡è®¾æˆ‘ä»¬æ¨¡å‹ä¸­çš„æ¯ä¸ªå†…å­˜åœ°å€éƒ½æœ‰ $m$ ä½ï¼Œåˆ™å…±æœ‰ $M = 2^m$ ä¸ªå”¯ä¸€åœ°å€ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç¼“å­˜æ˜¯ä¸€ä¸ªåŒ…å«äº† $S = 2^s$ ä¸ªç¼“å­˜é›†ï¼ˆCache Setï¼‰çš„æ•°ç»„ï¼Œæ¯ä¸ªç¼“å­˜é›†ç”± E ä¸ªç¼“å­˜è¡Œï¼ˆCache Lineï¼‰ç»„æˆã€‚æ¯ä¸ªç¼“å­˜è¡Œä¸­éƒ½æœ‰ä¸€ä¸ªåŒ…å«äº† $B = 2^b$ å­—èŠ‚æ•°æ®çš„ Blockï¼Œä¸€ä¸ªæ ‡è¯†è¯¥è¡Œæ˜¯å¦å­˜å‚¨äº†æœ‰æ•ˆä¿¡æ¯çš„æœ‰æ•ˆä½ï¼ˆå›¾ä¸­çš„â€œValidâ€ï¼‰ï¼Œä»¥åŠ $t$ ä½ï¼ˆ$t = m -(b + s)$ï¼‰å”¯ä¸€æ ‡è¯†è¡Œå†… Block çš„æ ‡è®°ä½ï¼ˆå›¾ä¸­çš„â€œTagâ€ï¼‰ã€‚\nç¼“å­˜çš„ç»“æ„é€šå¸¸å¯ä»¥ç”¨å…ƒç¥– (S, E, B, m) æ¥è¡¨å¾ï¼Œå…¶å®¹é‡ä¸º $C = S \\times E \\times B$ã€‚\nç›´æ¥æ˜ å°„ç¼“å­˜ ç¼“å­˜å¯ä»¥æ ¹æ® E çš„æ•°é‡è¿›è¡Œåˆ†ç±»ï¼ŒE ä¸º 1 çš„ç¼“å­˜è¢«ç§°ä¸ºç›´æ¥æ˜ å°„ç¼“å­˜ã€‚å½“ CPU æƒ³è¦è¯»å–å†…å­˜ä¸­çš„æŸä¸ª Word æ—¶ï¼Œç›´æ¥æ˜ å°„ç¼“å­˜å°†é€šè¿‡ä»¥ä¸‹æ­¥éª¤ç¡®å®šç¼“å­˜æ˜¯å¦å‘½ä¸­ä»¥åŠæå–è¯·æ±‚çš„ Wordï¼š\né›†åˆé€‰æ‹©ï¼ˆSet Selectionï¼‰ è¡ŒåŒ¹é…ï¼ˆLine Matchingï¼‰ å­—æå–ï¼ˆWord Extractionï¼‰ æˆ‘ä»¬å¯ä»¥å°†ç¼“å­˜çœ‹æˆä¸€ä¸ªä»¥ Set Index ä¸ºç´¢å¼•çš„ç¼“å­˜é›†æ•°ç»„ï¼Œç¤ºä¾‹ä¸­çš„ Set Index ä¸º $0001_2$ï¼Œå› æ­¤å°†é€‰æ‹©ç¼“å­˜é›† 1ã€‚\nå¦‚æœæœ‰æ•ˆä½ä¸º 1 ä¸”ç¼“å­˜è¡Œä¸­çš„æ ‡è®°ä½ä¸åœ°å€ä¸­çš„æ ‡è®°ä½ç›¸åŒ¹é…ï¼Œåˆ™ç¼“å­˜å‘½ä¸­ã€‚åŒæ ·ï¼Œæˆ‘ä»¬å¯ä»¥å°† Block çœ‹ä½œä¸€ä¸ªä»¥ Block Offset ä¸ºç´¢å¼•çš„å­—èŠ‚æ•°ç»„ã€‚ç¤ºä¾‹ä¸­çš„ Block Offset ä¸º $100_2$ï¼Œå› æ­¤ç›®æ ‡ Word çš„èµ·å§‹å­—èŠ‚ä¸º 4ï¼Œå³ä¸Šå›¾ä¸­çš„â€œ$w_0$â€ã€‚\nå¦‚æœå‡ºç°ç¼“å­˜ç¼ºå¤±ï¼Œåˆ™ç¼“å­˜å°†ä»ä»¥ä¸‹ä¸€çº§è®¾å¤‡ä¸­æ£€ç´¢è¯·æ±‚çš„ Blockï¼Œç„¶åå­˜å‚¨åœ¨å…¶ Set Index æŒ‡å®šçš„ç¼“å­˜é›†ä¸­ã€‚è‹¥å½“å‰ç¼“å­˜å·²æ»¡ï¼Œè€ƒè™‘åˆ°ç›´æ¥æ˜ å°„ç¼“å­˜çš„ç¼“å­˜é›†ä¸­åªæœ‰ä¸€ä¸ªç¼“å­˜è¡Œï¼Œå› æ­¤å¯¹åº”çš„ç¼“å­˜è¡Œå°†è¢«æ›¿æ¢ã€‚\nç¼“å­˜å®ç°ç¤ºä¾‹ å‡è®¾ä¸€ä¸ªç›´æ¥æ˜ å°„ç¼“å­˜æœ‰å››ä¸ªç¼“å­˜é›†ï¼Œæ¯ä¸ª Block ä¸¤ä¸ªå­—èŠ‚ã€‚åœ°å€å‡ä¸ºå››ä½ï¼Œæ¯ä¸ª Word éƒ½åªæœ‰ä¸€ä¸ªå­—èŠ‚ï¼š\nç´¢å¼•ä½ï¼ˆå›¾ä¸­çš„â€œIndex Bitsâ€ï¼‰å’Œæ ‡è®°ä½å”¯ä¸€æ ‡è¯†äº†å†…å­˜ä¸­çš„æ¯ä¸ª Blockï¼› ä¸åŒçš„ Block å¯ä»¥è¢«æ˜ å°„åˆ°ç›¸åŒçš„ç¼“å­˜é›†ï¼Œå¦‚ Block 0 å’Œ 4ï¼› ä¸ç›¸åŒç¼“å­˜é›†æ˜ å°„çš„ Block æ˜¯é€šè¿‡æ ‡è®°ä½è¿›è¡ŒåŒºåˆ†çš„ï¼Œå¦‚ Block 0 çš„æ ‡è®°ä½ä¸º 0ï¼Œè€Œ Block 1 çš„æ ‡è®°ä½ä¸º 1ã€‚ è‹¥ CPU æƒ³è¦è¯»å–å†…å­˜ä¸­çš„æŸäº› Wordï¼Œä¸Šè¿°ç¼“å­˜å°†ä¼šå¼€å±•ä¸€ç³»åˆ—çš„å·¥ä½œã€‚ä¸è¿‡åœ¨å¼€å§‹æ—¶ï¼Œç¼“å­˜æ˜¯ç©ºçš„ï¼š\nSet Valid tag block[0] Block[1] 0 0 1 0 2 0 3 0 å½“ CPU è¯»å–åœ°å€ 0 å¤„çš„ Word æ—¶ï¼Œç¼“å­˜å°†ä»ä¸»å­˜å‚¨å™¨ä¸­è·å– Block 0 å¹¶æŠŠå®ƒå­˜å‚¨åœ¨ Set 0 ä¸­ï¼š\nSet Valid tag block[0] Block[1] 0 1 0 m[0] m[1] 1 0 2 0 3 0 æ­¤åå¦‚æœ CPU æƒ³è¦è¯»å–åœ°å€ 1 å¤„çš„ Wordï¼Œå°±æ˜¾ç„¶ä¼šå‘ç”Ÿç¼“å­˜å‘½ä¸­ã€‚è€Œå½“ CPU è¯»å–åœ°å€ 13 å¤„çš„ Word æ—¶ï¼Œç¼“å­˜å°†ä»ä¸»å­˜å‚¨å™¨ä¸­è·å– Block 6 å¹¶æŠŠå®ƒå­˜å‚¨åœ¨ Set 2 ä¸­ï¼š\nSet Valid tag block[0] Block[1] 0 1 0 m[0] m[1] 1 0 2 0 m[12] m[13] 3 0 å½“ CPU è¯»å–åœ°å€ 8 å¤„çš„ Word æ—¶ï¼Œå³ä½¿ Set 0 ä¸­çš„æœ‰æ•ˆä½ä¸º 1ï¼Œä½† Tag å¹¶ä¸åŒ¹é…ï¼Œå› æ­¤å°†å‘ç”Ÿç¼“å­˜ç¼ºå¤±ã€‚ç¼“å­˜ä»ä¸»å­˜å‚¨å™¨ä¸­è·å– Block 4 å¹¶è¦†ç›–ä¹‹å‰çš„ç¼“å­˜è¡Œï¼Œä¸€æ—¦ CPU æƒ³è¦å†æ¬¡è¯»å–åœ°å€ 0 å¤„çš„ Word å°±ä¼šå‡ºç°å†²çªç¼ºå¤±ã€‚\nSet Valid tag block[0] Block[1] 0 1 0 m[8] m[9] 1 0 2 0 m[12] m[13] 3 0 å†²çªç¼ºå¤± ç›´æ¥æ˜ å°„ç¼“å­˜çš„å†²çªç¼ºå¤±åœ¨ç¨‹åºè®¿é—®é•¿åº¦ä¸º 2 çš„å¹‚çš„æ•°ç»„æ—¶ç»å¸¸å‡ºç°ï¼Œå¦‚ï¼š\n1 2 3 4 5 6 7 8 float dotprod(float x[8], float y[8]) { float sum = 0.0; int i; for (i = 0; i \u003c 8; i++) sum += x[i] * y[i]; return sum; } è¯¥ç¨‹åºå…·æœ‰è‰¯å¥½çš„å±€éƒ¨æ€§ï¼Œä½†åœ¨ç›´æ¥æ˜ å°„ç¼“å­˜ä¸­å´å¾ˆå®¹æ˜“å‘ç”Ÿå†²çªç¼ºå¤±ã€‚å‡è®¾ç¼“å­˜æœ‰ä¸¤ä¸ªç¼“å­˜é›†ï¼Œæ¯ä¸ª Block å­˜å‚¨ 16 å­—èŠ‚çš„æ•°æ®ã€‚é‚£ä¹ˆç¼“å­˜çš„å®¹é‡ä¾¿ä¸º 32 å­—èŠ‚ï¼Œå¯ä»¥å®Œæ•´åœ°ä¿å­˜æ•´ä¸ªæ•°ç»„ã€‚æ•°ç»„x[8]å’Œy[8]ä¸­çš„å…ƒç´ ä¸ç¼“å­˜é›†çš„æ˜ å°„å…³ç³»å¦‚ä¸‹ï¼š\nç”±äºä¸¤æ•°ç»„ä¸­ç´¢å¼•ç›¸åŒçš„å…ƒç´ å‡è¢«æ˜ å°„åˆ°ç›¸åŒçš„ç¼“å­˜é›†ï¼Œå› æ­¤æ¯å½“å¾ªç¯ä¸­çš„æŒ‡ä»¤è¯»å–æ•°ç»„å…ƒç´ æ—¶å°±ä¼šå‘ç”Ÿå†²çªç¼ºå¤±ã€‚æˆ‘ä»¬å°†è¿™ç§æƒ…å†µç§°ä¸ºé¢ ç°¸ï¼ˆThrashingï¼‰ï¼Œå³ç¼“å­˜é‡å¤åŠ è½½å¹¶é©±é€ç›¸åŒç¼“å­˜é›†ä¸­çš„ Blockã€‚\nä¸€ç§ç®€å•çš„è§£å†³æ–¹æ¡ˆæ˜¯åœ¨æ¯ä¸ªæ•°ç»„æœ«å°¾å¡«å……è‹¥å¹²å­—èŠ‚ã€‚å¦‚å°†æ•°ç»„x[8]é‡æ–°å£°æ˜ä¸ºx[12]ï¼Œåˆ™æ˜ å°„å…³ç³»å°±å˜æˆäº†ï¼š\næ˜¾ç„¶ï¼Œæ­¤æ—¶x[i]ä¸y[i]è¢«æ˜ å°„åˆ°äº†ä¸åŒçš„ç¼“å­˜é›†ï¼Œé¢ ç°¸å°†ä¸å†å‡ºç°ã€‚\nç»†å¿ƒçš„è¯»è€…å¯èƒ½ä¼šæƒ³åˆ°ï¼Œä¸ºä»€ä¹ˆ Set index åœ¨åœ°å€çš„ä¸­é—´ä½è€Œéé«˜ä½ï¼Ÿå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè‹¥ Set index ä½äºåœ°å€çš„é«˜ä½ï¼Œé‚£ä¹ˆä¸€äº›è¿ç»­çš„ Block å°†è¢«æ˜ å°„åˆ°ç›¸åŒçš„ç¼“å­˜é›†ã€‚å› æ­¤åªè¦ç¨‹åºæŒ‰é¡ºåºè¯»å–æ•°ç»„ä¸­çš„å…ƒç´ ï¼Œç¼“å­˜å°±ä¼šå‘ç”Ÿé¢ ç°¸ã€‚\né›†å…³è”å‹ç¼“å­˜ é›†å…³è”å‹ç¼“å­˜ï¼ˆSet Associative Cachesï¼‰ä¸­çš„æ¯ä¸ªç¼“å­˜é›†å¯ä»¥åŒ…å«å¤šä¸ªç¼“å­˜è¡Œã€‚æˆ‘ä»¬é€šå¸¸å°†åŒ…å« E ï¼ˆ1 \u003c E \u003c C/Bï¼‰ä¸ªç¼“å­˜è¡Œçš„ç¼“å­˜ç§°ä¸º E-è·¯ï¼ˆE-wayï¼‰é›†å…³è”å‹ç¼“å­˜ï¼Œä¸‹å›¾åˆ™æ˜¯ä¸€ä¸ªäºŒè·¯é›†å…³è”å‹ç¼“å­˜çš„ç»“æ„ï¼š\nå…¶è¯»å– Word çš„æ­¥éª¤ä¸ç›´æ¥æ˜ å°„ç¼“å­˜ç±»ä¼¼ï¼ŒåŒºåˆ«ä¸»è¦åœ¨äºè¡ŒåŒ¹é…ä¸Šã€‚é›†å…³è”å‹ç¼“å­˜å¿…é¡»æ£€æŸ¥å¤šè¡Œçš„æœ‰æ•ˆä½å’Œæ ‡è®°ä½æ˜¯å¦ä¸è¯·æ±‚çš„ Word ç›¸åŒ¹é…ï¼š\nä¸€æ—¦å‘ç”Ÿç¼“å­˜ç¼ºå¤±ï¼Œç¼“å­˜å°†é¦–å…ˆä»ä¸»å­˜å‚¨å™¨ä¸­æå–æ‰€éœ€çš„ Blockã€‚å¦‚æœæ­¤æ—¶ç¼“å­˜ä¸­æ²¡æœ‰ç©ºè¡Œï¼Œåˆ™å¿…é¡»æ ¹æ®ç­–ç•¥æ›¿æ¢å·²æœ‰çš„ç¼“å­˜è¡Œã€‚æœ€ç®€å•çš„æ–¹æ³•ä¾¿æ˜¯éšæœºæ›¿æ¢ï¼Œä½†æˆ‘ä»¬åº”å½“åˆ©ç”¨å±€éƒ¨æ€§å°½å¯èƒ½åœ°å‡å°è¢«æ›¿æ¢çš„è¡Œæœªæ¥å†æ¬¡è¢«ä½¿ç”¨çš„å¯èƒ½ã€‚é™¤äº†ä¸Šæ–‡æåˆ°çš„ LRU ä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é‡‡ç”¨ LFUï¼ˆLeast Frequently Usedï¼‰ç­–ç•¥ï¼Œæ›¿æ¢è¿‡å»æŸä¸ªæ—¶é—´æ®µå†…è¢«å¼•ç”¨æ¬¡æ•°æœ€å°‘çš„è¡Œã€‚\nå…¨å…³è”å‹ç¼“å­˜ å…¨å…³è”å‹ç¼“å­˜ï¼ˆFully Associative Cachesï¼‰åªæœ‰ä¸€ä¸ªç¼“å­˜é›†ï¼Œå…¶ä¸­åŒ…å«å¤šä¸ªç¼“å­˜è¡Œï¼ˆE = C/Bï¼‰ï¼š\nå…¶è¯»å– Word çš„æ­¥éª¤ä¸å…¶ä»–ä¸¤ç§ç¼“å­˜ç±»ä¼¼ï¼Œä¸è¿‡ Word çš„åœ°å€å°†ä¸åŒ…å« Set Indexï¼š\nå¯¹äºå…¨å…³è”å‹ç¼“å­˜ï¼Œç¼“å­˜ç”µè·¯å¿…é¡»å¹¶è¡Œåœ°åŒ¹é…å¤šè¡Œæ ‡è®°ä½ã€‚å› æ­¤å®ç°ä¸€ä¸ªå®¹é‡å¤§ä¸”é€Ÿåº¦å¿«çš„å…¨å…³è”å‹ç¼“å­˜æ˜¯ååˆ†å›°éš¾è€Œåˆæ˜‚è´µçš„ï¼Œå®ƒä»…é€‚ç”¨äºå°å‹ç¼“å­˜ã€‚\nç¼“å­˜çš„å†™å…¥ ç›¸æ¯”äºè¯»å–ï¼Œå†™å…¥çš„æƒ…å†µè¦æ›´åŠ å¤æ‚ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜è¦è€ƒè™‘å¦‚ä½•æ›´æ–°ä½çº§åˆ«ç¼“å­˜ä¸­çš„å‰¯æœ¬ã€‚æœ€ç®€å•çš„æ–¹æ³•ä¾¿æ˜¯ç›´æ¥å†™å…¥ï¼ˆWrite-throughï¼‰ï¼Œä½†è¿™æ ·æ¯æ¬¡å†™å…¥æ“ä½œéƒ½ä¼šæ¶ˆè€—æ€»çº¿çš„æµé‡ã€‚å¦ä¸€ç§æ–¹æ³•è¢«ç§°ä¸ºå›å†™ï¼ˆWrite-backï¼‰ï¼Œå³åªæœ‰å½“æ›´æ–°çš„ Block è¢«é©±é€æ—¶æ‰å‘ä½çº§åˆ«å†™å…¥ã€‚ä¸è¿‡å›å†™ä¹Ÿä¼šå¢åŠ ç³»ç»Ÿçš„å¤æ‚æ€§ï¼Œç¼“å­˜å¿…é¡»ä¸ºæ¯ä¸ªç¼“å­˜è¡Œç»´æŠ¤ä¸€ä¸ªè„ä½ï¼ˆDirty Bitï¼‰ï¼Œä»¥æ ‡è¯†è¯¥ Block æ˜¯å¦å·²è¢«ä¿®æ”¹ã€‚\nè¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯å¦‚ä½•å¤„ç†å†™å…¥æ—¶çš„ç¼“å­˜ç¼ºå¤±ã€‚ä¸€ç§æ–¹æ³•æ˜¯å°†ç›®æ ‡ Block ä»ä½çº§åˆ«åŠ è½½åˆ°ç¼“å­˜ä¸­åå†è¿›è¡Œæ›´æ–°ï¼Œè¢«ç§°ä¸ºå†™åˆ†é…ï¼ˆWrite-allocateï¼‰ã€‚è¯¥æ–¹æ³•è¯•å›¾åˆ©ç”¨å†™å…¥çš„ç©ºé—´å±€éƒ¨æ€§ï¼Œä½†ç¼ºç‚¹æ˜¯åªè¦å‘ç”Ÿç¼“å­˜ç¼ºå¤±å°±å¿…é¡»ä¼ è¾“ Blockã€‚å¦ä¸€ç§æ–¹æ³•ä¼šç»•è¿‡ç¼“å­˜ç›´æ¥åœ¨ä½çº§åˆ«ä¸­ä¿®æ”¹ç›®æ ‡ Blockï¼Œè¢«ç§°ä¸ºæ— å†™åˆ†é…ï¼ˆNo-write-allocateï¼‰ã€‚ç›´æ¥å†™å…¥é€šå¸¸ä½¿ç”¨æ— å†™åˆ†é…ï¼Œè€Œå›å†™åˆ™ä½¿ç”¨å†™åˆ†é…ã€‚\nå¯¹äºè¯•å›¾ç¼–å†™ç¼“å­˜å‹å¥½å‹ä»£ç çš„ç¨‹åºå‘˜æ¥è¯´ï¼Œæˆ‘ä»¬æ¨èé‡‡ç”¨å›å†™å’Œå†™åˆ†é…çš„å¤„ç†æ–¹å¼ã€‚å°¤å…¶æ˜¯åœ¨ä½çº§åˆ«çš„ç¼“å­˜ï¼ˆå¦‚è™šæ‹Ÿå†…å­˜ï¼‰ä¸­ï¼Œä¼ è¾“æ•°æ®çš„æ—¶é—´è¾ƒé•¿ï¼Œå› æ­¤æ›´å®¹æ˜“ä½“ç°å‡ºå›å†™çš„ä¼˜åŠ¿ã€‚\nçœŸå®ç¼“å­˜å±‚çº§å‰–æ ä¸Šå›¾ä¸­çš„â€œi-cacheâ€ä»£è¡¨ä¿å­˜æŒ‡ä»¤çš„ç¼“å­˜ï¼Œâ€œd-cacheâ€ä»£è¡¨ä¿å­˜ç¨‹åºæ•°æ®çš„ç¼“å­˜ï¼Œè€Œâ€œunified cacheâ€åˆ™ä»£è¡¨æ—¢å­˜å‚¨æŒ‡ä»¤åˆå­˜å‚¨æ•°æ®çš„ç¼“å­˜ã€‚æœ‰è¶£çš„æ˜¯ï¼Œæ‰€æœ‰çš„ SRAM ç¼“å­˜éƒ½åœ¨ CPU èŠ¯ç‰‡ä¸­ã€‚\nç¼“å­˜å‚æ•°å¯¹æ€§èƒ½çš„å½±å“ ç¼“å­˜çš„æ€§èƒ½æŒ‡æ ‡ä¸»è¦æœ‰ï¼š\nç¼ºå¤±ç‡ï¼ˆMiss Rateï¼‰ï¼š# missed / # references å‘½ä¸­ç‡ï¼ˆHit Rateï¼‰ï¼š1 - Miss Rate å‘½ä¸­æ—¶é—´ï¼ˆHit Timeï¼‰ï¼šCPU ä»ç¼“å­˜ä¸­è¯»å–ä¸€ä¸ª Word æ‰€éœ€çš„æ—¶é—´ ç¼ºå¤±æƒ©ç½šï¼ˆMiss Penaltyï¼‰ï¼šå› ä¸ºç¼“å­˜ç¼ºå¤±è€Œå¢åŠ çš„è¯»å–æ—¶é—´ ç¼“å­˜çš„ä¸åŒå‚æ•°å¯¹å…¶æ€§èƒ½çš„å½±å“ä¸ºï¼š\nç¼“å­˜å®¹é‡ï¼šæ›´å¤§çš„ç¼“å­˜å¯ä»¥å¢åŠ å‘½ä¸­ç‡ï¼Œä½†ä¹Ÿä¼šå¢åŠ å‘½ä¸­æ—¶é—´ï¼› Block çš„å¤§å°ï¼šæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ç©ºé—´å±€éƒ¨æ€§ï¼Œé€šè¿‡å¢å¤§ Block æ¥æå‡å‘½ä¸­ç‡ã€‚ä½†åœ¨ç¼“å­˜å®¹é‡ä¸€å®šçš„æƒ…å†µä¸‹ï¼ŒBlock è¶Šå¤§ï¼Œç¼“å­˜è¡Œçš„æ•°é‡å°±è¶Šå°‘ã€‚æ­¤å¤–ï¼Œæ›´å¤§çš„ Block è¿˜ä¼šå¢åŠ æ•°æ®ä¼ è¾“çš„æ—¶é—´ï¼› å…³è”æ€§ï¼ˆç¼“å­˜è¡Œçš„æ•°é‡ï¼‰ï¼šæ›´å¤šçš„ç¼“å­˜è¡Œå¯ä»¥é¿å…å› å†²çªç¼ºå¤±è€Œå¯¼è‡´çš„é¢ ç°¸ï¼Œä½†ç»´æŠ¤æ›´å¤šçš„ç¼“å­˜è¡Œä¹Ÿéœ€è¦å¤§é‡æˆæœ¬ã€‚ ç¼–å†™ç¼“å­˜å‹å¥½å‹ä»£ç  ç¼–å†™ç¼“å­˜å‹å¥½å‹ä»£ç çš„ä¸¤ä¸ªåŸºæœ¬å‡†åˆ™å¦‚ä¸‹ï¼š\nå…³æ³¨æ ¸å¿ƒç¨‹åºçš„å†…éƒ¨å¾ªç¯å¹¶å¿½ç•¥å…¶ä»–éƒ¨åˆ†ï¼› å‡å°‘æ¯ä¸ªå†…éƒ¨å¾ªç¯ä¸­ç¼“å­˜ç¼ºå¤±çš„æ•°é‡ã€‚ å…¶ä¸­ç¬¬äºŒä¸ªå‡†åˆ™åˆå¯ä»¥æ ¹æ®å±€éƒ¨æ€§åˆ†ä¸ºä¸¤æ–¹é¢ï¼š\næœ€å¤§åŒ–ç©ºé—´å±€éƒ¨æ€§ï¼šé‡‡ç”¨ stride-1 æ¨¡å¼ï¼ŒæŒ‰æ•°æ®å¯¹è±¡åœ¨å†…å­˜ä¸­å­˜å‚¨çš„é¡ºåºä¾æ¬¡è¯»å–ï¼› æœ€å¤§åŒ–æ—¶é—´å±€éƒ¨æ€§ï¼šä¸€æ—¦ä»å†…å­˜ä¸­è¯»å–äº†æŸä¸ªæ•°æ®å¯¹è±¡ï¼Œå°±å°½å¯èƒ½å¤šåœ°ä½¿ç”¨å®ƒã€‚ ç¼“å­˜å¯¹ç¨‹åºæ€§èƒ½çš„å½±å“ ","description":"","tags":["OS"],"title":"CSAPP è¯»ä¹¦ç¬”è®°ï¼šå­˜å‚¨ç³»ç»Ÿçš„å±‚çº§ç»“æ„","uri":"/posts/the-memory-hierarchy-note/"},{"content":"æˆ‘ä»¬å°†å¤„ç†å™¨æ”¯æŒçš„æŒ‡ä»¤åŠå…¶å¯¹åº”çš„å­—èŠ‚ç¼–ç æ–¹å¼ç§°ä¸ºæŒ‡ä»¤é›†æ¶æ„ï¼ˆInstruction Set Architectureï¼ŒISAï¼‰ã€‚ä¸åŒçš„å¤„ç†å™¨ç³»åˆ—ï¼Œä¾‹å¦‚ Intel IA32/x86-64ï¼ŒIBM/Freescale Power å’Œ ARM ç­‰ï¼Œå‡ä½¿ç”¨ä¸åŒçš„ ISAã€‚ä¸ºä¸€ç§æœºå™¨ç¼–è¯‘å¾—åˆ°çš„ç¨‹åºï¼Œæ— æ³•åœ¨ ISA ä¸åŒçš„æœºå™¨ä¸Šè¿è¡Œã€‚\nISA åœ¨ç¼–è¯‘å™¨çš„ç¼–å†™è€…å’Œå¤„ç†å™¨çš„è®¾è®¡è€…ä¹‹é—´æä¾›äº†ä¸€ä¸ªæŠ½è±¡å±‚ã€‚ç¼–è¯‘å™¨çš„ç¼–å†™è€…åªéœ€è¦çŸ¥é“å…è®¸ä½¿ç”¨å“ªäº›æŒ‡ä»¤ä»¥åŠå®ƒä»¬æ˜¯å¦‚ä½•ç¼–ç çš„ï¼Œè€Œå¤„ç†å™¨çš„è®¾è®¡è€…åˆ™éœ€è¦åˆ›å»ºèƒ½å¤Ÿæ‰§è¡Œè¿™äº›æŒ‡ä»¤çš„æœºå™¨ã€‚\nåœ¨ä¼ ç»Ÿçš„ ISA æ¨¡å‹ä¸­ï¼Œæ¯æ¡æŒ‡ä»¤é¡ºåºæ‰§è¡Œã€‚è€Œç°ä»£å¤„ç†å™¨åˆ™ä¼šåŒæ—¶æ‰§è¡Œå¤šæ¡æŒ‡ä»¤çš„ä¸åŒéƒ¨åˆ†ï¼Œä»è€Œè·å¾—æ¯”æ¯æ¬¡åªæ‰§è¡Œä¸€æ¡æŒ‡ä»¤æ›´é«˜çš„æ€§èƒ½ã€‚ä¸è¿‡æˆ‘ä»¬è¿˜éœ€è¦å¼•å…¥ä¸€ä¸ªç‰¹æ®Šæœºåˆ¶ï¼Œç¡®ä¿å¤„ç†å™¨çš„è®¡ç®—ç»“æœä¸é¡ºåºæ‰§è¡Œç›¸åŒã€‚\nåœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬ä»¿ç…§ x86-64 åˆ›å»ºäº†ä¸€ä¸ªç®€å•çš„æŒ‡ä»¤é›†ï¼Œç§°å…¶ä¸ºâ€œY86-64â€ã€‚åŒæ—¶ä½¿ç”¨ HCLï¼ˆHardware Control Languageï¼‰æ¥æè¿°ç¡¬ä»¶ç³»ç»Ÿçš„æ§åˆ¶éƒ¨åˆ†å’Œå¤„ç†å™¨è®¾è®¡ï¼Œå®ƒçš„ä½œç”¨ç±»ä¼¼äº Verilog HDLï¼ˆHardware Description Languageï¼‰ã€‚\nY86-64 æŒ‡ä»¤é›†æ¶æ„ ç¨‹åºå‘˜å¯è§çŠ¶æ€ Y86-64 ç¨‹åºä¸­çš„æ¯æ¡æŒ‡ä»¤éƒ½å¯ä»¥è¯»å–å’Œä¿®æ”¹å¤„ç†å™¨çŠ¶æ€çš„æŸäº›éƒ¨åˆ†ï¼Œå³ç¨‹åºå‘˜å¯è§çŠ¶æ€ã€‚æ­¤å¤„çš„â€œç¨‹åºå‘˜â€æ—¢æŒ‡ç”¨æ±‡ç¼–ä»£ç ç¼–å†™ç¨‹åºçš„äººï¼ŒåˆæŒ‡ç”Ÿæˆæœºå™¨ä»£ç çš„ç¼–è¯‘å™¨ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nY86-64 ä¸­çš„ç¨‹åºå‘˜å¯è§çŠ¶æ€åŒ…æ‹¬ 15 ä¸ªèƒ½å¤Ÿå­˜å‚¨ 64 ä½æ•°æ®çš„å¯„å­˜å™¨ã€3 ä¸ªå•ä½ï¼ˆSingel Bitï¼‰æ¡ä»¶ç ã€ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿå†…å­˜å’Œè¡¨ç¤ºç¨‹åºæ‰§è¡Œæ•´ä½“çŠ¶æ€çš„çŠ¶æ€ç ï¼ˆå›¾ä¸­çš„â€œStatâ€ï¼‰ã€‚\nY86-64 æŒ‡ä»¤ Y86-64 æŒ‡ä»¤æ˜¯ x86-64 æŒ‡ä»¤çš„å­é›†ï¼Œä»…åŒ…å«äº† 8 å­—èŠ‚çš„æ•´æ•°è¿ç®—ï¼Œä»¥åŠæ›´å°‘çš„å¯»å€å’Œè¿ç®—æ¨¡å¼ã€‚ç”±äºæˆ‘ä»¬çš„æ•°æ®å‡ä¸º 8 å­—èŠ‚ï¼Œå› æ­¤å¯ä»¥æ— æ­§ä¹‰åœ°å°†å®ƒä»¬ç§°ä¸ºå­—ï¼ˆWordï¼‰ã€‚\nx86-64 ä¸­çš„movqæŒ‡ä»¤è¢«åˆ†æˆäº†å››ä¸ªä¸åŒçš„ Y86-64 æŒ‡ä»¤ï¼širmovqã€rrmovqã€mrmovqå’Œrmmovqã€‚å…¶ä¸­ï¼Œiä»£è¡¨ç«‹å³æ•°ï¼Œrä»£è¡¨å¯„å­˜å™¨ï¼Œmä»£è¡¨å†…å­˜ã€‚\nä¸Šå›¾è¿˜ç¼ºå°‘äº†éƒ¨åˆ†ä¿¡æ¯ï¼Œæ¯”å¦‚æ•´å‹æ“ä½œæŒ‡ä»¤OPqå®é™…ä¸ŠåŒ…å«äº†å››ä¸ªæŒ‡ä»¤ï¼šaddqã€subqã€andqå’Œxorqï¼Œå®ƒä»¬ä¼šæ ¹æ®è®¡ç®—ç»“æœæ”¹å˜ä¸‰ä¸ªæ¡ä»¶ç çš„å€¼ã€‚å¦å¤–ï¼Œè¯¥ç±»æŒ‡ä»¤å’Œæ¡ä»¶åˆ†æ”¯æŒ‡ä»¤jXXä»¥åŠæ¡ä»¶ç§»åŠ¨æŒ‡ä»¤cmovXXç¼–ç ä¸­çš„ $f_n$ å°†éšæŒ‡ä»¤çš„å…·ä½“åç§°å˜åŒ–ï¼š\ncallã€retã€nopã€pushqå’ŒpopqæŒ‡ä»¤çš„ä½œç”¨å’Œ x86-64 ä¸­çš„ç±»ä¼¼ï¼Œè€ŒhaltæŒ‡ä»¤åˆ™å¯¹åº”äº† x86-64 ä¸­çš„hltã€‚x86-64 ä¸å…è®¸ç¨‹åºä½¿ç”¨htlæŒ‡ä»¤ï¼Œå› ä¸ºå®ƒä¼šä½¿æ•´ä¸ªç³»ç»Ÿæš‚åœæ“ä½œã€‚ä¸è¿‡åœ¨ Y86-64 ä¸­ï¼ŒhaltæŒ‡ä»¤ä¼šä½¿å¤„ç†å™¨åœæ­¢å¹¶å°†çŠ¶æ€ç ç½®ä¸º HLTã€‚\næŒ‡ä»¤ç¼–ç  ä¸Šä¸€èŠ‚çš„å›¾ä¸­è¿˜å±•ç¤ºäº†ä¸åŒæŒ‡ä»¤çš„å­—èŠ‚ç¼–ç ï¼Œå…¶é•¿åº¦èŒƒå›´åœ¨ä¸€åˆ°åå­—èŠ‚ä¹‹é—´ï¼Œå…¶ä¸­çš„é¦–ä¸ªå­—èŠ‚æ ‡è¯†äº†å…¶ç±»å‹ã€‚å¯„å­˜å™¨å­˜å‚¨åœ¨ CPU ä¸­çš„å¯„å­˜å™¨æ–‡ä»¶ï¼ˆä¸€ä¸ªå°å‹çš„ RAMï¼‰ä¸­ï¼Œä¸‹å›¾ä¸­çš„å¯„å­˜å™¨ ID å°±æ˜¯å®ƒä»¬çš„åœ°å€ï¼š\nå¯„å­˜å™¨ ID å°†æ›¿æ¢æŒ‡ä»¤ç¼–ç ä¸­çš„ $r_A$ å’Œ $r_B$ã€‚x86-64 ä¸­æ¡ä»¶åˆ†æ”¯å’Œè·³è½¬æŒ‡ä»¤çš„ç›®çš„åœ°å€æ˜¯ç›¸å¯¹äºç¨‹åºè®¡æ•°å™¨ï¼ˆPC-Relativeï¼‰çš„ï¼Œè¿™æ ·å¯ä»¥ä½¿ç¨‹åºç¼–ç æ›´åŠ ç´§å‡‘ï¼ŒåŒæ—¶ä»£ç åœ¨å†…å­˜ä¸­ç§»åŠ¨æ—¶ä¹Ÿæ— éœ€æ›´æ”¹æ‰€æœ‰åˆ†æ”¯ç›®æ ‡çš„åœ°å€ã€‚ç”±äºæˆ‘ä»¬æ›´åŠ å…³å¿ƒè®¾è®¡çš„ç®€æ´æ€§ï¼Œå› æ­¤ Y86-64 é‡‡ç”¨ç»å¯¹åœ°å€ã€‚\nä¸¾ä¾‹æ¥è¯´ï¼Œåœ¨ä¸€å°å°ç«¯æ³•æœºå™¨ä¸Šï¼ŒæŒ‡ä»¤rmmovq %rsp, 0x123456789abcd(%rdx)çš„å­—èŠ‚ç¼–ç ä¸º4042cdab896745230100ã€‚å…¶ä¸­ï¼ŒæŒ‡ä»¤ç±»å‹rmmovqå¯¹åº”çš„å­—èŠ‚ä¸º40ï¼Œå¯„å­˜å™¨ %rsp å’Œ %rdx åˆ†åˆ«å¯¹åº”4å’Œ2ã€‚å‰©ä¸‹çš„ç«‹å³æ•°å°†é¦–å…ˆå¡«å……ä¸ºå…«å­—èŠ‚çš„000123456789abcdï¼Œç„¶ååå‘è¿½åŠ åˆ°æŒ‡ä»¤å°¾éƒ¨ã€‚\nä»»ä½•æŒ‡ä»¤é›†ä¸­çš„å­—èŠ‚ç¼–ç éƒ½å¿…é¡»ä¸æŒ‡ä»¤åºåˆ—å”¯ä¸€å¯¹åº”ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦æˆ‘ä»¬çŸ¥é“äº†æŒ‡ä»¤å­—èŠ‚ç¼–ç ä¸­çš„é¦–ä¸ªå­—èŠ‚ï¼Œå°±èƒ½ç¡®å®šå®Œæ•´çš„æŒ‡ä»¤åºåˆ—ã€‚åä¹‹å¦‚æœæˆ‘ä»¬æ— æ³•å¾—çŸ¥å­—èŠ‚åºåˆ—çš„èµ·å§‹ä½ç½®ï¼Œé‚£ä¹ˆä¹Ÿå°±æ— æ³•å°†å…¶æ‹†åˆ†ä¸ºå¤šä¸ªå•ç‹¬çš„æŒ‡ä»¤ã€‚\nY86-64 å¼‚å¸¸ Y86-64 ä¸­çš„çŠ¶æ€ç  Stat å¦‚ä¸‹ï¼š\næˆ‘ä»¬æ²¡æœ‰å¼•å…¥å¼‚å¸¸å¤„ç†ç¨‹åºï¼ˆException Handlerï¼‰ï¼Œåªæ˜¯ç®€å•åœ°è®©å¤„ç†å™¨åœ¨é‡åˆ°ä»»ä½•å¼‚å¸¸æ—¶åœæ­¢æ‰§è¡ŒæŒ‡ä»¤ã€‚\nY86-64 ç¨‹åº ç¤ºä¾‹ C ç¨‹åºå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 long sum(long *start, long count) { long sum = 0; while (count) { sum += *start; start++; count--; } return sum; } int main() { long array[4] = {0x000d000d000d, 0x00c000c000c0, 0x0b000b000b00, 0xa000a000a000}; sum(array, 4); return 0; } ä¸ä¹‹å¯¹åº”çš„ Y86-64 æ±‡ç¼–ä»£ç ä¸ºï¼š\nä»ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºå®ƒä¸ x86-64 æ±‡ç¼–ä»£ç çš„åŒºåˆ«ï¼š\nç”±äºæˆ‘ä»¬çš„ç®—æœ¯è¿ç®—æ— æ³•ç›´æ¥ä½¿ç”¨ç«‹å³æ•°ï¼Œå› æ­¤éœ€è¦å…ˆå°†å…¶æ‹·è´åˆ°å¯„å­˜å™¨ä¸­ï¼ˆç¬¬ 24ï½25 è¡Œï¼‰ï¼› æˆ‘ä»¬éœ€è¦å…ˆä»å†…å­˜ä¸­è¯»å–å€¼ï¼ˆç¬¬ 30 è¡Œï¼‰ï¼Œç„¶åå†å°†å…¶ä¸å¯„å­˜å™¨ä¸­çš„å€¼ç›¸åŠ ï¼ˆç¬¬ 31 è¡Œï¼‰ã€‚è€Œ x86-64 ä¸­åªéœ€è¦ä½¿ç”¨ä¸€ä¸ªaddqæŒ‡ä»¤ï¼› æˆ‘ä»¬çš„subqæŒ‡ä»¤ï¼ˆç¬¬ 33 è¡Œï¼‰åœ¨æ‰§è¡Œå‡æ³•è¿ç®—çš„åŒæ—¶è¿˜ä¼šä¿®æ”¹æ¡ä»¶ç ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨ä¸å¼•å…¥testqçš„æƒ…å†µä¸‹ç›´æ¥ä½¿ç”¨æ¡ä»¶è·³è½¬æŒ‡ä»¤jneï¼ˆç¬¬ 35 è¡Œï¼‰ã€‚ä¸è¿‡ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨è¿›å…¥å¾ªç¯ä¹‹å‰ä½¿ç”¨andqæŒ‡ä»¤åˆå§‹åŒ–æ¡ä»¶ç çš„å€¼ï¼ˆç¬¬ 27 è¡Œï¼‰ã€‚ æ±‡ç¼–å™¨ä¼šæ ¹æ®ä¸Šå›¾ä¸­ä»¥.å¼€å¤´çš„æŒ‡ä»¤è°ƒæ•´å…¶ç”Ÿæˆçš„ä»£ç åœ°å€ï¼Œå¦‚æŒ‡ä»¤.pos 0ï¼ˆç¬¬ 2 è¡Œï¼‰è¡¨ç¤ºä»£ç çš„èµ·å§‹åœ°å€ä¸º 0ã€‚æŒ‡ä»¤irmovq stack, %rspä¼šåˆå§‹åŒ–æ ˆæŒ‡é’ˆï¼Œå…¶åœ°å€æ˜¯ç”±æœ€åä¸¤è¡ŒæŒ‡ä»¤å£°æ˜çš„ã€‚è¿è¡Œæ—¶æ ˆå°†ä»0x200å¼€å§‹å‘è¾ƒä½çš„åœ°å€å¤„å¢é•¿ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¿è¯å®ƒä¸ä¼šè¦†ç›–åˆ°å…¶ä»–çš„ç¨‹åºæ•°æ®ã€‚ç¨‹åºçš„ç¬¬ 8 åˆ° 13 è¡Œå£°æ˜äº†ä¸€ä¸ªå››å­—æ•°ç»„ï¼Œ.align 8æŒ‡ä»¤å°†ä½¿å®ƒåœ¨ 8 å­—èŠ‚è¾¹ç•Œä¸Šå¯¹é½ã€‚\nä¸€äº› Y86-64 æŒ‡ä»¤ç»†èŠ‚ æŒ‡ä»¤pushq %rspå‹å…¥æ ˆçš„å€¼å¯èƒ½æ˜¯å¯„å­˜å™¨ %rsp çš„åŸå§‹å€¼ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯æ ˆæŒ‡é’ˆå‡å°‘åçš„å€¼ã€‚è€ŒæŒ‡ä»¤popq %rspä»æ ˆä¸­å¼¹å‡ºçš„å€¼å¯èƒ½æ˜¯ç›´æ¥ä»å†…å­˜ä¸­è¯»å–çš„ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯æ ˆæŒ‡é’ˆå¢åŠ åå†è¯»å–çš„ã€‚ä¸ºäº†é¿å…æ··æ·†ï¼Œæˆ‘ä»¬éœ€è¦è§„å®šä¸Šè¿°ä¸¤ä¸ªæŒ‡ä»¤å‡é‡‡ç”¨å‰è€…çš„æ–¹å¼ã€‚\né€»è¾‘è®¾è®¡å’Œ HCL åœ¨ç¡¬ä»¶è®¾è®¡ä¸­ï¼Œç”µå­ç”µè·¯ç”¨äºè®¡ç®—ä½å‡½æ•°ï¼ˆFunction on Bitsï¼‰å¹¶å°†ä½å­˜å‚¨åœ¨ä¸åŒçš„å­˜å‚¨å™¨å…ƒç´ ï¼ˆMemory Elementï¼‰ä¸­ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨é«˜ç”µå‹ï¼ˆçº¦ 1.0 Vï¼‰æ¥è¡¨ç¤ºé€»è¾‘å€¼ 1ï¼Œä½¿ç”¨ä½ç”µå‹ï¼ˆçº¦ 0.0 Vï¼‰æ¥è¡¨ç¤ºé€»è¾‘å€¼ 0ã€‚\næ•°å­—ç³»ç»Ÿä¸»è¦ç”±ä»¥ä¸‹ä¸‰ä¸ªéƒ¨åˆ†æ„æˆï¼š\nè®¡ç®—ä½å‡½æ•°çš„ç»„åˆé€»è¾‘ï¼ˆCombinational Logicï¼‰ å­˜å‚¨ä½çš„å­˜å‚¨å™¨å…ƒç´  æ§åˆ¶å­˜å‚¨å…ƒç´ æ›´æ–°çš„æ—¶é’Ÿä¿¡å·ï¼ˆClock Signalï¼‰ é€»è¾‘é—¨ é€»è¾‘é—¨æ˜¯æ•°å­—ç”µè·¯çš„åŸºæœ¬è®¡ç®—å…ƒç´ ï¼Œå…¶è¾“å‡ºç­‰äºè¾“å…¥çš„ä½è¿›è¡Œå¸ƒå°”è¿ç®—åçš„ç»“æœã€‚ä¸Šå›¾å±•ç¤ºäº†ç”¨äºå¸ƒå°”å‡½æ•°ANDã€ORå’ŒNOTçš„æ ‡å‡†ç¬¦å·ï¼Œé€»è¾‘é—¨çš„ä¸‹æ–¹åˆ™æ˜¯å¯¹åº”çš„ HCL è¡¨è¾¾å¼\u0026\u0026ã€||å’Œ!ã€‚é€»è¾‘é—¨åªå¯¹å•ä¸ªä½è¿›è¡Œæ“ä½œè€Œéæ•´ä¸ªå­—ï¼Œå› æ­¤æˆ‘ä»¬ä¸ä½¿ç”¨ C ä¸­çš„ä½çº§è¿ç®—ç¬¦\u0026ã€|å’Œ~ã€‚\nç»„åˆç”µè·¯å’Œ HCL å¸ƒå°”è¡¨è¾¾å¼ å¤šä¸ªé€»è¾‘é—¨ç»„æˆçš„ç½‘ç»œè¢«ç§°ä¸ºç»„åˆç”µè·¯ï¼Œå…¶æ„å»ºæ–¹å¼æœ‰ä»¥ä¸‹è¦æ±‚ï¼š\næ¯ä¸ªé€»è¾‘é—¨çš„è¾“å…¥å¿…é¡»æ˜¯ï¼š æ•´ä¸ªç³»ç»Ÿçš„è¾“å…¥ä¹‹ä¸€ï¼ˆå³ä¸»è¾“å…¥ï¼‰ æŸä¸ªå­˜å‚¨å™¨å…ƒç´ çš„è¾“å‡º æŸä¸ªé€»è¾‘é—¨çš„è¾“å‡º ä¸¤ä¸ªæˆ–å¤šä¸ªé€»è¾‘é—¨çš„è¾“å‡ºä¸èƒ½è¿æ¥åˆ°ä¸€èµ· ç½‘ç»œä¸èƒ½æ˜¯ä¸€ä¸ªå›è·¯ï¼ˆAcyclicï¼‰ ä¸‹å›¾å±•ç¤ºäº†ä¸€ä¸ªå¤šè·¯å¤ç”¨å™¨ï¼ˆMultiplexorï¼ŒMUXï¼‰çš„ç»„åˆç”µè·¯ï¼š\nè¾“å…¥çš„æ•°æ®ä¿¡å·æ˜¯ä½ a å’Œ bï¼Œæ§åˆ¶ä¿¡å·æ˜¯ä½ sã€‚å½“ s ä¸º 1 æ—¶ï¼Œè¾“å‡ºå°†ç­‰äº aã€‚è€Œå½“ s ä¸º 0 æ—¶ï¼Œè¾“å‡ºåˆ™ä¸º bã€‚è¾“å‡ºä¿¡å·çš„ HCL è¡¨è¾¾å¼ä¸ºï¼šbool out = (s \u0026\u0026 a) || (!s \u0026\u0026 b);\nHCL è¡¨è¾¾å¼å’Œ C ä¸­çš„é€»è¾‘è¡¨è¾¾å¼ä¹‹é—´å­˜åœ¨ä¸€äº›å·®å¼‚ï¼š\né€»è¾‘é—¨å’Œ HCL çš„è¾“å‡ºä¼šåŠ¨æ€åœ°éšè¾“å…¥çš„å˜åŒ–è€Œå˜åŒ–ï¼Œè€Œ C ä¸­çš„è¡¨è¾¾å¼åªä¼šåœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­è¿ç®—ï¼› C ä¸­çš„é€»è¾‘è¡¨è¾¾å¼å…è®¸ä½¿ç”¨ä»»æ„æ•´å‹å‚æ•°ï¼Œè€Œ HCL è¡¨è¾¾å¼åªèƒ½å¯¹ä½å€¼ 0 å’Œ 1 è¿›è¡Œè¿ç®—ï¼› C ä¸­çš„é€»è¾‘è¡¨è¾¾å¼å¯èƒ½åªä¼šæ‰§è¡Œéƒ¨åˆ†è¿ç®—ã€‚ä¾‹å¦‚è¡¨è¾¾å¼(a \u0026\u0026 !a) \u0026\u0026 func(b,c)ï¼Œç”±äº(a \u0026\u0026 !a)ä¸€å®šä¸º 0ï¼Œæ•´ä¸ªè¡¨è¾¾å¼çš„å€¼ä¹Ÿä¸º 0ï¼Œå› æ­¤ä¸ä¼šè®¡ç®—func(b,c)çš„å€¼ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒHCL æ²¡æœ‰ä»»ä½•çš„éƒ¨åˆ†è¯„ä¼°è§„åˆ™ã€‚ To be continued â€¦\n","description":"","tags":["ISA"],"title":"CSAPP è¯»ä¹¦ç¬”è®°ï¼šå¤„ç†å™¨æ¶æ„","uri":"/posts/processor-architecture-note/"},{"content":" åŸæ–‡é“¾æ¥ï¼šFabian Reinartz. Writing a Time Series Database from Scratch. fabxc.org, 2017.\nPrometheus æ˜¯ä¸€ä¸ªåŒ…å«äº†è‡ªå®šä¹‰æ—¶é—´åºåˆ—æ•°æ®åº“çš„ç›‘æ§ç³»ç»Ÿï¼Œå…¶æŸ¥è¯¢è¯­è¨€ã€æ“ä½œæ¨¡å‹ä»¥åŠä¸€äº›æ¦‚å¿µæ€§å†³ç­–ä½¿å¾—å®ƒæ˜“äºä¸ Kubernetes é›†æˆã€‚ç„¶è€Œï¼ŒKubernetes é›†ç¾¤ä¸­çš„å·¥ä½œè´Ÿè½½æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œæœ‰å¯èƒ½ç»™å®ƒå¸¦æ¥ä¸€å®šçš„å‹åŠ›ã€‚å› æ­¤ï¼Œæˆ‘ä»¬è‡´åŠ›äºæé«˜ Prometheus åœ¨è¿™äº›è¿è¡Œç€é«˜åº¦åŠ¨æ€æˆ–ç¬æ€æœåŠ¡çš„ç¯å¢ƒä¸­çš„æ€§èƒ½ã€‚\nè¿‡å»ï¼Œå•å° Prometheus æœåŠ¡å™¨æ¯ç§’èƒ½å¤Ÿæ‹‰å–å¤šè¾¾ä¸€ç™¾ä¸‡ä¸ªæ ·æœ¬ï¼ˆSampleï¼‰ï¼Œå¹¶ä¸”åªå ç”¨éå¸¸å°‘çš„ç£ç›˜ç©ºé—´ã€‚è™½ç„¶å®ƒçš„æ€§èƒ½ååˆ†å“è¶Šï¼Œä½†ä»æœ‰æ”¹è¿›ç©ºé—´ã€‚å› æ­¤æˆ‘æå‡ºäº†ä¸€ç§å…¨æ–°çš„å­˜å‚¨ç³»ç»Ÿè®¾è®¡ï¼Œå®ƒå¯ä»¥è§£å†³å½“å‰æ–¹æ¡ˆçš„ç—›ç‚¹ï¼Œè®© Prometheus å…·å¤‡å¤„ç†æ›´å¤§è§„æ¨¡æ•°æ®çš„èƒ½åŠ›ã€‚\né—®é¢˜ï¼Œé—®é¢˜å’Œé—®é¢˜ç©ºé—´ é¦–å…ˆï¼Œæˆ‘ä»¬ç®€è¦ä»‹ç» Prometheus éœ€è¦å®Œæˆçš„ä»»åŠ¡åŠå…¶å¼•å‘çš„å…³é”®é—®é¢˜ã€‚å¯¹äºæ¯ä¸ªæ–¹é¢ï¼Œæˆ‘ä»¬éƒ½ä¼šè®¨è®ºå½“å‰æ–¹æ¡ˆåšå¾—å¥½çš„åœ°æ–¹ï¼Œä»¥åŠåšå¾—ä¸å¥½äºŸå¾…æ–°æ–¹æ¡ˆè§£å†³çš„åœ°æ–¹ã€‚\næ—¶é—´åºåˆ—æ•°æ® Prometheus éšæ—¶é—´ä¸æ–­é‡‡é›†æ•°æ®ç‚¹ï¼š\n1 identifier -\u003e (t0, v0), (t1, v1), (t2, v2), (t3, v3), .... æ¯ä¸ªæ•°æ®ç‚¹éƒ½æ˜¯ä¸€ä¸ªç”±æ—¶é—´æˆ³å’Œæ•°å€¼ç»„æˆçš„å…ƒç»„ã€‚å…¶ä¸­ï¼Œæ—¶é—´æˆ³æ˜¯ä¸€ä¸ªæ•´å‹ï¼Œè€Œæ•°å€¼åˆ™æ˜¯ 64 ä½æµ®ç‚¹æ•°ã€‚ä¸€ç³»åˆ—å¸¦æœ‰ä¸¥æ ¼å•è°ƒé€’å¢æ—¶é—´æˆ³çš„æ•°æ®ç‚¹è¢«ç§°ä¸º Seriesï¼Œå®ƒå¯ä»¥ç”±å«æœ‰æŒ‡æ ‡åç§°å’Œæ ‡ç­¾å­—å…¸çš„æ ‡è¯†ç¬¦ï¼ˆIdentifierï¼‰æ¥å¯»å€ã€‚ä¸€ç»„å…¸å‹çš„ Series æ ‡è¯†ç¬¦å¦‚ä¸‹ï¼š\n1 2 3 requests_total{path=\"/status\", method=\"GET\", instance=â€10.0.0.1:80â€} requests_total{path=\"/status\", method=\"POST\", instance=â€10.0.0.3:80â€} requests_total{path=\"/\", method=\"GET\", instance=â€10.0.0.2:80â€} æŒ‡æ ‡åç§°ä¹Ÿå¯ä»¥è¢«è§†ä¸ºä¸€ä¸ªæ ‡ç­¾ï¼Œå¦‚_name_ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å¯¹è¿™ç§è¡¨è¾¾æ–¹å¼è¿›è¡Œç®€åŒ–ã€‚åœ¨æŸ¥è¯¢æ—¶å®ƒå¯èƒ½ä¼šè¢«ç‰¹æ®Šå¤„ç†ï¼Œä½†å­˜å‚¨æ—¶åˆ™ä¸å…¶ä»–æ ‡ç­¾æ— å¼‚ã€‚\n1 2 3 {__name__=\"requests_total\", path=\"/status\", method=\"GET\", instance=â€10.0.0.1:80â€} {__name__=\"requests_total\", path=\"/status\", method=\"POST\", instance=â€10.0.0.3:80â€} {__name__=\"requests_total\", path=\"/\", method=\"GET\", instance=â€10.0.0.2:80â€} å½“æŸ¥è¯¢æ—¶é—´åºåˆ—æ•°æ®æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šæ ¹æ®æ ‡ç­¾é€‰æ‹©æ‰€éœ€çš„ Seriesã€‚ä¸€ä¸ªæœ€ç®€å•çš„ä¾‹å­ï¼Œ{__name__=\"requests_total\"}ä¼šæŸ¥è¯¢å±äºrequests_totalæŒ‡æ ‡çš„æ‰€æœ‰ Seriesï¼ŒPrometheus å°†æ‹‰å–æŒ‡å®šæ—¶é—´çª—å£å†…çš„æ•°æ®ç‚¹ã€‚\næœ‰æ—¶å€™æˆ‘ä»¬è¿˜å¸Œæœ›ä¸€æ¬¡æŸ¥è¯¢èƒ½å¤Ÿé€‰å–æ»¡è¶³å¤šä¸ªæ ‡ç­¾é€‰æ‹©å™¨çš„ Seriesï¼Œæˆ–è€…åœ¨æ ‡ç­¾åŒ¹é…ä¸­ä½¿ç”¨æ¯”ç­‰å¼æ›´åŠ å¤æ‚çš„æ¡ä»¶ã€‚ä¾‹å¦‚ï¼Œå¦å®š(method!=\"GET\")æˆ–æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…(method=\"PUT|POST\")ã€‚\næœ¬èŠ‚ä»‹ç»çš„å†…å®¹åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå®šä¹‰äº† Prometheus å­˜å‚¨å’Œè°ƒç”¨æ•°æ®çš„æ–¹å¼ã€‚\nå‚ç›´å’Œæ°´å¹³ åœ¨ç®€åŒ–çš„è§†å›¾ä¸­ï¼Œæ‰€æœ‰æ•°æ®ç‚¹éƒ½åˆ†å¸ƒåœ¨ä¸€ä¸ªäºŒç»´å¹³é¢ä¸Šã€‚å…¶ä¸­ï¼Œæ°´å¹³ç»´åº¦ä»£è¡¨æ—¶é—´ï¼Œå‚ç›´ç»´åº¦ä»£è¡¨ Series çš„æ ‡è¯†ç¬¦ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 series ^ â”‚ . . . . . . . . . . . . . . . . . . . . . . {__name__=\"request_total\", method=\"GET\"} â”‚ . . . . . . . . . . . . . . . . . . . . . . {__name__=\"request_total\", method=\"POST\"} â”‚ . . . . . . . â”‚ . . . . . . . . . . . . . . . . . . . ... â”‚ . . . . . . . . . . . . . . . . . . . . . â”‚ . . . . . . . . . . . . . . . . . . . . . {__name__=\"errors_total\", method=\"POST\"} â”‚ . . . . . . . . . . . . . . . . . {__name__=\"errors_total\", method=\"GET\"} â”‚ . . . . . . . . . . . . . . â”‚ . . . . . . . . . . . . . . . . . . . ... â”‚ . . . . . . . . . . . . . . . . . . . . v \u003c-------------------- time ---------------------\u003e è¿™äº›æ•°æ®ç‚¹æ˜¯ç”± Prometheus å‘¨æœŸæ€§åœ°æ‹‰å–ä¸€ç»„ Series çš„å½“å‰å€¼è€Œå¾—åˆ°çš„ã€‚ç”±äºè¯¥æ“ä½œå¯¹æ¯ä¸ªæ•°æ®æºå®ä½“ï¼ˆå³ Targetï¼‰å‡ç‹¬ç«‹å®Œæˆï¼Œå› æ­¤ Prometheus çš„å†™å…¥æ¨¡å¼æ˜¯å®Œå…¨å‚ç›´ä¸”é«˜åº¦å¹¶å‘çš„ã€‚\nå‡è®¾æˆ‘ä»¬çš„æ•°æ®è§„æ¨¡ä¸ºï¼šå•ä¸ª Prometheus å®ä¾‹ä»æ•°ä¸‡ä¸ª Target ä¸­é‡‡é›†æ•°æ®ç‚¹ï¼Œè€Œæ¯ä¸ª Target åˆæš´éœ²æˆç™¾ä¸Šåƒä¸ªä¸åŒçš„ Seriesã€‚åœ¨è¿™ç§æ•°æ®é‡è¾¾åˆ°ç™¾ä¸‡çº§åˆ«çš„æƒ…å†µä¸‹ï¼Œæ‰¹é‡å†™å…¥æ˜¯å¿…éœ€çš„ã€‚\nå¯¹äºæ—‹è½¬ç£ç›˜æ¥è¯´ï¼Œéšæœºå†™å…¥æ•°æ®éå¸¸ç¼“æ…¢ï¼Œå› ä¸ºå®ƒéœ€è¦ä¸æ–­ç§»åŠ¨ç£å¤´æ¥å¯»å€ã€‚è€Œå¯¹äº SSDï¼Œå°½ç®¡å…¶éšæœºå†™æ“ä½œå¾ˆå¿«ï¼Œä½†æ˜¯å®ƒåªèƒ½ä»¥ 4KiB æˆ–æ›´å¤§çš„ Page ä¸ºå•ä½å†™å…¥ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå†™å…¥ä¸€ä¸ª 16 å­—èŠ‚çš„æ ·æœ¬å…¶å®ç›¸å½“äºå†™å…¥ä¸€ä¸ªå®Œæ•´çš„ 4KiB Pageã€‚è¿™ç§ç°è±¡å±äºå†™æ”¾å¤§ï¼ˆWrite Amplificationï¼‰çš„ä¸€éƒ¨åˆ†ï¼Œå°†ä¼šå¯¼è‡´ SSD çš„ç£¨æŸå’Œæ€§èƒ½ä¸‹é™ï¼Œç”šè‡³åœ¨å‡ å¤©æˆ–å‡ å‘¨å†…æ‘§æ¯ä½ çš„ç£ç›˜ã€‚æœ‰å…³è¯¥é—®é¢˜çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¯ä»¥å‚è€ƒç³»åˆ—æ–‡ç«  Coding for SSDsã€‚ç»¼ä¸Šæ‰€è¿°ï¼Œæ— è®ºå¯¹äºæ—‹è½¬ç£ç›˜è¿˜æ˜¯ SSDï¼Œé¡ºåºå†™å…¥å’Œæ‰¹é‡å†™å…¥å‡æ˜¯æœ€ç†æƒ³çš„æ¨¡å¼ï¼Œè¿™æ˜¯æˆ‘ä»¬å¿…é¡»åšæŒçš„åŸåˆ™ã€‚\næŸ¥è¯¢æ¨¡å¼åˆ™ä¸å†™å…¥æ¨¡å¼å®Œå…¨ä¸åŒã€‚æˆ‘ä»¬å¯ä»¥æŸ¥è¯¢ä¸€ä¸ª Series ä¸­çš„å•ä¸ªæ•°æ®ç‚¹ï¼Œä¸€ä¸‡ä¸ª Series ä¸­çš„å•ä¸ªæ•°æ®ç‚¹ï¼Œä¸€ä¸ª Series ä¸­ä¸€å‘¨å†…çš„æ•°æ®ç‚¹ä»¥åŠä¸€ä¸‡ä¸ª Series ä¸­ä¸€å‘¨å†…çš„æ•°æ®ç‚¹ç­‰ç­‰ã€‚åœ¨äºŒç»´æ•°æ®å¹³é¢ä¸­ï¼ŒæŸ¥è¯¢çš„æ•°æ®ç‚¹æ—¢ä¸æ˜¯å®Œå…¨å‚ç›´æˆ–å®Œå…¨æ°´å¹³çš„ï¼Œè€Œæ˜¯ä¸¤è€…çš„çŸ©å½¢ç»„åˆã€‚\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Recording rules æ¥æ”¹å–„æ‰§è¡Œå¸¸ç”¨æŸ¥è¯¢è¯­å¥æ—¶é‡åˆ°çš„æ€§èƒ½é—®é¢˜ï¼Œä½†å®ƒå¯¹ä¸´æ—¶æ€§çš„æŸ¥è¯¢å¹¶ä¸èµ·ä½œç”¨ã€‚\nè¯‘è€…æ³¨ï¼šå…³äº Recording rulesï¼Œé™¤äº†åŸæ–‡ç»™å‡ºçš„æ–‡æ¡£é“¾æ¥å¤–ï¼Œè¿˜å¯ä»¥å‚é˜… Today I Learned: Prometheus Recording Rules ä¸€æ–‡ã€‚\nå½“ Prometheus æ‰¹é‡å†™å…¥æ—¶ï¼Œæ¯ä¸ªæ‰¹æ¬¡ï¼ˆBatchï¼‰çš„æ•°æ®ç‚¹åˆ†å¸ƒåœ¨å‚ç›´æ–¹å‘ä¸Šçš„å¤šä¸ª Series ä¸­ã€‚è€Œå¦‚æœæˆ‘ä»¬æŸ¥è¯¢æŸä¸ªæ—¶é—´çª—å£å†…çš„æŸä¸ª Series çš„æ•°æ®ç‚¹æ—¶ï¼Œä¸ä»…å¾ˆéš¾æ‰¾å‡ºæ¯ä¸ªç‚¹åœ¨ç£ç›˜ä¸Šçš„ä½ç½®ï¼Œè¿˜å¿…é¡»ä»ç£ç›˜ä¸Šéšæœºè¯»å–æ•°æ®ã€‚æ¯æ¬¡æŸ¥è¯¢å¯èƒ½æ¶‰åŠåˆ°æ•°ç™¾ä¸‡ä¸ªæ ·æœ¬ï¼Œå³ä½¿åœ¨æœ€å¿«çš„ SSD ä¸Šè¿›è¡Œä¹Ÿå¾ˆæ…¢ã€‚è™½ç„¶æ¯æ¬¡æŸ¥è¯¢è¯·æ±‚çš„æ ·æœ¬å¤§å°å¯èƒ½åªæœ‰ 16 å­—èŠ‚ï¼Œä½†è¯»å–æ“ä½œä¼šä»ç£ç›˜ä¸Šæ£€ç´¢æ›´å¤šçš„æ•°æ®ã€‚å¯¹äº SSD æ˜¯ä¸€ä¸ª Pageï¼Œè€Œå¯¹äº HDD åˆ™æ˜¯æ•´ä¸ªæ‰‡åŒºã€‚æ— è®ºå¦‚ä½•ï¼Œæˆ‘ä»¬éƒ½åœ¨æµªè´¹å®è´µçš„ååé‡ã€‚\nå› æ­¤åœ¨ç†æƒ³æƒ…å†µä¸‹ï¼ŒåŒä¸€ä¸ª Series ä¸­çš„æ ·æœ¬æŒ‰é¡ºåºå­˜å‚¨ã€‚è¿™æ ·åªè¦æˆ‘ä»¬çŸ¥é“æŸä¸ª Series çš„èµ·å§‹ä½ç½®ï¼Œå°±å¯ä»¥å¿«é€Ÿè®¿é—®å®ƒæ‰€æœ‰çš„æ•°æ®ç‚¹ï¼Œä»è€Œå‡å°‘è¯»å–æ“ä½œçš„æ¬¡æ•°ã€‚\nå°†æ•°æ®å†™å…¥ç£ç›˜çš„ç†æƒ³æ¨¡å¼å’Œèƒ½å¤Ÿæ˜¾è‘—æå‡æŸ¥è¯¢æ•ˆç‡çš„è®¾è®¡ä¹‹é—´æ˜¾ç„¶å­˜åœ¨ç€å¼ºçƒˆçš„çŸ›ç›¾ï¼Œè¿™æ˜¯æˆ‘ä»¬çš„æ—¶åºæ•°æ®åº“å¿…é¡»è§£å†³çš„æ ¹æœ¬é—®é¢˜ã€‚\nè¯‘è€…æ³¨ï¼šåŸæ–‡ä¸ºï¼šâ€œThereâ€™s obviously a strong tension between the ideal pattern for writing collected data to disk and the layout that would be significantly more efficient for serving queries. It is the fundamental problem our TSDB has to solve.â€ è¯‘è€…ä¸ç¡®å®šæ­¤å¤„çš„ tension è¯¥å¦‚ä½•ç¿»è¯‘ï¼ŒçŒœæµ‹åŸæ–‡ä½œè€…å¯èƒ½æ˜¯æƒ³è¡¨è¾¾ä¸€ç§ç±»ä¼¼ trade-off çš„æ¦‚å¿µã€‚å› ä¸ºä¸Šæ–‡æåˆ°ï¼Œåœ¨ç†æƒ³çš„å†™å…¥æ¨¡å¼ä¸­ï¼Œæ•°æ®ç‚¹æ˜¯å‚ç›´åˆ†å¸ƒçš„ã€‚è€Œé€šå¸¸æŸ¥è¯¢å¾—åˆ°æ•°æ®ç‚¹å´æ˜¯æ°´å¹³ï¼Œç”šè‡³æ˜¯çŸ©å½¢çš„ã€‚\nå½“å‰è§£å†³æ–¹æ¡ˆ æ˜¯æ—¶å€™çœ‹çœ‹ Prometheus å½“å‰çš„å­˜å‚¨ç³»ç»Ÿï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸º â€œV2â€ï¼‰æ˜¯å¦‚ä½•è§£å†³è¿™ä¸€é—®é¢˜çš„ã€‚æˆ‘ä»¬ä¸ºæ¯ä¸ª Series åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œå…¶ä¸­æ‰€æœ‰çš„æ ·æœ¬å‡æŒ‰æ—¶é—´é¡ºåºæ’åˆ—ã€‚ç”±äºæ¯éš”å‡ ç§’å°±å°†æ ·æœ¬è¿½åŠ å†™å…¥åˆ°è¿™äº›æ–‡ä»¶æœ«å°¾çš„æˆæœ¬å¾ˆé«˜ï¼Œæˆ‘ä»¬å…ˆå°†æ ·æœ¬ç¼“å­˜åˆ°å†…å­˜ä¸­çš„ Chunkã€‚æ¯ä¸ª Series éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ Chunkï¼Œå¾… Chunk è¢«å†™æ»¡ï¼ˆå³å¤§å°è¾¾åˆ° 1 KiBï¼‰ä¹‹åå†æ·»åŠ åˆ°æ–‡ä»¶å°¾éƒ¨ã€‚è¿™ç§æ–¹æ¡ˆæ—¢å®ç°äº†æ‰¹é‡å†™å…¥ï¼Œåˆå°†æ ·æœ¬æŒ‰é¡ºåºå­˜å‚¨ï¼Œè§£å†³äº†å¾ˆå¤šé—®é¢˜ã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒåŒä¸€ä¸ª Series ä¸­ç›¸é‚»æ ·æœ¬çš„æ•°å€¼å˜åŒ–è¾ƒå°ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨éå¸¸é«˜æ•ˆçš„æ•°æ®å‹ç¼©æ ¼å¼ã€‚ä¸€ç¯‡å…³äº Gorilla TSDB çš„ è®ºæ–‡ ä»‹ç»äº†ä¸€ç§ç±»ä¼¼åŸºäº Chunk çš„æ–¹æ³•å’Œå‹ç¼©æ ¼å¼ï¼Œèƒ½å¤Ÿå°† 16 å­—èŠ‚çš„æ ·æœ¬æ•°æ®å‹ç¼©åˆ°å¹³å‡ 1.37 å­—èŠ‚ã€‚V2 ç‰ˆæœ¬çš„å­˜å‚¨ç³»ç»Ÿä½¿ç”¨å¤šç§å‹ç¼©æ ¼å¼ï¼Œå…¶ä¸­å°±åŒ…æ‹¬ Gorilla çš„å˜ä½“ã€‚\nå°½ç®¡åŸºäº Chunk çš„æ–¹æ³•å¾ˆæ£’ï¼Œä½†ä¸ºæ¯ä¸ª Series ç»´æŠ¤ä¸€ä¸ªç‹¬ç«‹æ–‡ä»¶å°†ç»™ V2 å­˜å‚¨ç³»ç»Ÿå¸¦æ¥å¾ˆå¤šéº»çƒ¦ï¼š\nå®é™…ä¸Šæˆ‘ä»¬æ‰€éœ€çš„æ–‡ä»¶æ•°é‡è¿œæ¯”å½“å‰æ”¶é›†åˆ°çš„ Series å¤šå¾—å¤šï¼ŒåŸå› å‚è§ Series Churn ç« èŠ‚ã€‚ä¸Šç™¾ä¸‡ä¸ªæ–‡ä»¶è¿Ÿæ—©ä¼šè€—å°½æˆ‘ä»¬æ–‡ä»¶ç³»ç»Ÿä¸Šæ‰€æœ‰çš„ inodesï¼Œåªèƒ½é€šè¿‡é‡æ–°æ ¼å¼åŒ–ç£ç›˜æ¥æ¢å¤ã€‚ å³ä½¿æˆ‘ä»¬å¼•å…¥äº† Chunkï¼Œæ¯ç§’ä¹Ÿä¼šæœ‰æ•°åƒä¸ª Chunk è¢«å†™æ»¡å¹¶å‡†å¤‡æŒä¹…åŒ–ï¼Œè¿™æ„å‘³ç€æ¯ç§’å‘ç”Ÿæ•°åƒæ¬¡ç‹¬ç«‹çš„ç£ç›˜å†™å…¥ã€‚è™½ç„¶å¯ä»¥é€šè¿‡å°†ä¸€ä¸ª Series ä¸­å‡ ä¸ªå·²å®Œæˆçš„ Chunk æ‰¹é‡è½ç›˜æ¥æ”¹å–„è¿™ä¸€é—®é¢˜ï¼Œä½†è¿™æ ·åšåè€Œå¢åŠ äº†ç­‰å¾…æŒä¹…åŒ–çš„ Chunk æ•°é‡ï¼Œå› æ­¤ä¼šå ç”¨æ›´å¤šçš„å†…å­˜ã€‚ ä¸ºäº†è¯»å†™è€Œä¿æŒæ‰€æœ‰æ–‡ä»¶å‡å¤„äºæ‰“å¼€çŠ¶æ€æ˜¯ä¸å¯è¡Œçš„ã€‚å°½ç®¡çº¦ 99%çš„æ•°æ®åœ¨ 24 å°æ—¶åå°±ä¸å†è¢«æŸ¥è¯¢ï¼Œä½†åªè¦æŸ¥è¯¢åˆ°å·²æŒä¹…åŒ–çš„æ ·æœ¬ï¼Œå°±å¿…é¡»æ‰“å¼€æ•°åƒä¸ªæ–‡ä»¶ç„¶åå°†ç»“æœè¯»å…¥å†…å­˜ä¸­ï¼Œæœ€åå†å…³é—­å®ƒä»¬ã€‚å› ä¸ºè¿™ç§æ“ä½œæå¤§åœ°æé«˜äº†æŸ¥è¯¢çš„å»¶æ—¶ï¼ŒPrometheus å°†ç¼“å­˜æ›´å¤šçš„ Chunk ï¼Œä»è€Œå¯¼è‡´ èµ„æºæ¶ˆè€— ç« èŠ‚ä¸­æåˆ°çš„é—®é¢˜ã€‚ æœ€åæˆ‘ä»¬å¿…é¡»åˆ é™¤æ—§æ•°æ®ã€‚å®ƒä»¬å­˜å‚¨åœ¨æ•°ç™¾ä¸‡ä¸ªæ–‡ä»¶çš„å¤´éƒ¨ä¸­ï¼Œå› æ­¤åˆ é™¤å…¶å®æ˜¯ä¸€ç§å†™å…¥å¯†é›†å‹æ“ä½œã€‚æ­¤å¤–ï¼Œéå†æ•°ç™¾ä¸‡ä¸ªæ–‡ä»¶å¹¶å¯¹å…¶è¿›è¡Œåˆ†æé€šå¸¸éœ€è¦æ•°ä¸ªå°æ—¶ï¼Œå¯èƒ½åˆšä¸€å®Œæˆå°±ä¸å¾—ä¸é‡æ–°å¼€å§‹ã€‚æ²¡é”™ï¼Œåˆ é™¤æ—§æ–‡ä»¶è¿˜å°†è¿›ä¸€æ­¥åœ°å¯¼è‡´ SSD çš„å†™æ”¾å¤§ã€‚ å½“å‰ç´¯ç§¯çš„ Chunk å‡å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå¦‚æœ Prometheus å‘ç”Ÿå´©æºƒæ•°æ®å°±ä¼šä¸¢å¤±ã€‚ä¸ºäº†é¿å…è¿™ä¸€æƒ…å†µï¼Œå†…å­˜çŠ¶æ€å°†å‘¨æœŸæ€§åœ°ä¿å­˜ï¼ˆCheckpointï¼‰åˆ°ç£ç›˜ä¸­ã€‚ç„¶è€Œï¼Œå®Œæˆ Checkpoint çš„æ‰€éœ€æ—¶é—´å¯èƒ½è¿œæ¯”æˆ‘ä»¬èƒ½å¤Ÿæ¥å—çš„æ•°æ®ä¸¢å¤±æ—¶é—´çª—å£è¿˜é•¿ã€‚åŒæ—¶æ¢å¤ Checkpoint ä¸€èˆ¬é•¿è¾¾å‡ åˆ†é’Ÿï¼Œä½¿ Prometheus çš„é‡å¯å‘¨æœŸå˜å¾—éå¸¸æ¼«é•¿ã€‚ ç°æœ‰è®¾è®¡çš„å…³é”®æ¦‚å¿µæ˜¯ Chunkï¼Œæˆ‘ä»¬å½“ç„¶å¸Œæœ›ä¿ç•™å®ƒã€‚å°†æœ€æ–°çš„ Chunk å§‹ç»ˆä¿æŒåœ¨å†…å­˜ä¸­ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è®¾è®¡ï¼Œæ¯•ç«Ÿè¿‘æœŸçš„æ•°æ®æŸ¥è¯¢é¢‘ç‡æœ€é«˜ã€‚ä¸è¿‡ï¼Œä¸ºæ¯ä¸ª Series éƒ½åˆ›å»ºä¸€ä¸ªæ–‡ä»¶çš„æ–¹æ¡ˆçœ‹èµ·æ¥å¹¶ä¸åˆç†ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿæ‰¾åˆ°æ–°çš„æ–¹æ¡ˆä»£æ›¿å®ƒã€‚\nSeries Churn åœ¨ Prometheus ä¸­ï¼ŒSeries Churn è¡¨ç¤ºä¸€ç»„ Series å˜å¾—ä¸æ´»è·ƒã€‚å³æ–°çš„æ•°æ®ç‚¹ä¸å†ç”±å®ƒä»¬æ¥æ”¶ï¼Œè€Œæ˜¯å…³è”åˆ°ä¸€ç»„æ–°å‡ºç°çš„ Seriesã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå¾®æœåŠ¡æš´éœ²çš„æ‰€æœ‰ Series éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„â€œå®ä¾‹â€æ ‡ç­¾ã€‚å¦‚æœæˆ‘ä»¬å¯¹è¯¥å¾®æœåŠ¡è¿›è¡Œæ»šåŠ¨æ›´æ–°å¹¶å°†æ¯ä¸ªå®ä¾‹æ›¿æ¢ä¸ºæ–°ç‰ˆæœ¬ï¼ŒSeries Churn å°±ä¼šå‘ç”Ÿã€‚åœ¨æ›´åŠ åŠ¨æ€çš„ç¯å¢ƒä¸­ï¼Œè¿™ç§ç°è±¡ç”šè‡³å¯èƒ½æ¯å°æ—¶å°±å‡ºç°ä¸€æ¬¡ã€‚é›†ç¾¤ç¼–æ’ç³»ç»Ÿï¼ˆå¦‚ Kubernetesï¼‰å…è®¸åº”ç”¨è¿ç»­åœ°è‡ªåŠ¨æ‰©å±•å’Œé¢‘ç¹åœ°æ»šåŠ¨æ›´æ–°ï¼Œå› æ­¤æ¯å¤©å¯èƒ½å°†æœ‰ä¸Šä¸‡ä¸ªå®ä¾‹ä»¥åŠç›¸å…³çš„ Series è¢«åˆ›å»ºã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 series ^ â”‚ . . . . . . â”‚ . . . . . . â”‚ . . . . . . â”‚ . . . . . . . â”‚ . . . . . . . â”‚ . . . . . . . â”‚ . . . . . . â”‚ . . . . . . â”‚ . . . . . â”‚ . . . . . â”‚ . . . . . v \u003c-------------------- time ---------------------\u003e ç”±äº Series Churn çš„å­˜åœ¨ï¼Œå³ä½¿æ•´ä¸ªåŸºç¡€æ¶æ„çš„è§„æ¨¡ä¿æŒä¸å˜ï¼ŒSeries æ•°é‡ä¹Ÿä¼šéšæ—¶é—´çº¿æ€§å¢é•¿ã€‚è™½ç„¶ Prometheus èƒ½å¤Ÿæ”¶é›†å¤šè¾¾ 1000 ä¸‡ä¸ª Series çš„æ•°æ®ï¼Œä½†è¦è®©å®ƒä»åäº¿ä¸ª Series ä¸­æŸ¥æ‰¾æ•°æ®è¿˜æ˜¯ååˆ†å›°éš¾çš„ã€‚\nå½“å‰è§£å†³æ–¹æ¡ˆ V2 å­˜å‚¨ç³»ç»Ÿä¸ºå½“å‰å­˜å‚¨çš„æ‰€æœ‰ Series åˆ†é…äº†ä¸€ä¸ªåŸºäº LevelDB çš„ç´¢å¼•ã€‚å®ƒå…è®¸æŸ¥è¯¢åŒ…å«ç»™å®šæ ‡ç­¾å¯¹çš„ Seriesï¼Œä½†ç¼ºå°‘ä¸€ç§å¯æ‰©å±•çš„æ–¹å¼æ¥å¯¹ä¸åŒæ ‡ç­¾é€‰æ‹©çš„ç»“æœè¿›è¡Œç»„åˆã€‚\nä¾‹å¦‚ï¼Œé€šè¿‡æ ‡ç­¾__name__=\"requests_total\"é€‰å–æ‰€æœ‰çš„ Series ååˆ†é«˜æ•ˆï¼Œä½†ä½¿ç”¨instance=\"A\" AND __name__=\"requests_total\"å°±ä¼šé‡åˆ°æ‰©å±•èƒ½åŠ›çš„é—®é¢˜ã€‚ç¨åæˆ‘ä»¬å°†å†æ¬¡è®¨è®ºå¯¼è‡´è¿™ç§ç°è±¡çš„åŸå› ï¼Œä»¥åŠæƒ³è¦æ”¹å–„æŸ¥è¯¢æ€§èƒ½æ‰€å¿…é¡»åšå‡ºçš„è°ƒæ•´ã€‚\nè¿™ä¸ªé—®é¢˜å®é™…ä¸Šæ˜¯æˆ‘ä»¬å¯»æ‰¾æ›´å¥½çš„å­˜å‚¨ç³»ç»Ÿçš„æœ€åˆåŸå› ï¼ŒPrometheus éœ€è¦ä¸€ç§æ›´åŠ å®Œå–„çš„ç´¢å¼•æ–¹æ³•ä»¥ä»æ•°äº¿ä¸ª Series ä¸­å¿«é€Ÿæœç´¢æ•°æ®ã€‚\nèµ„æºæ¶ˆè€— å½“å°è¯•æ‰©å±• Prometheusï¼ˆæˆ–å…¶ä»–ä»»ä½•ä¸œè¥¿ï¼‰æ—¶ï¼Œèµ„æºæ¶ˆè€—æ˜¯è´¯ç©¿å§‹ç»ˆçš„ä¸»é¢˜ä¹‹ä¸€ã€‚ä½†æ˜¯ï¼ŒçœŸæ­£å›°æ‰°ç”¨æˆ·çš„å¹¶éæ˜¯ç»å¯¹çš„èµ„æºä¸è¶³ã€‚å®é™…ä¸Šï¼ŒPrometheus é€šå¸¸èƒ½å¤Ÿæ»¡è¶³ç”¨æˆ·æ‰€éœ€çš„ååé‡ï¼Œé—®é¢˜åœ¨äºå…¶é¢å¯¹å˜åŒ–æ—¶çš„ä¸ç¨³å®šæ€§å’Œä¸å¯é¢„çŸ¥æ€§ã€‚V2 å­˜å‚¨ç³»ç»Ÿä¸ºæ ·æœ¬æ•°æ®ç¼“æ…¢åœ°åˆ›å»º Chunkï¼Œå†…å­˜ä½¿ç”¨é‡éšæ—¶é—´çš„æ¨ç§»è€ŒæŒç»­ä¸Šå‡ã€‚å¾… Chunk å†™æ»¡åï¼Œå®ƒä»¬ä¼šè¢«å†™å…¥ç£ç›˜å¹¶ä»å†…å­˜ä¸­é©±é€ã€‚æœ€ç»ˆï¼ŒPrometheus çš„å†…å­˜ä½¿ç”¨é‡å°†è¾¾åˆ°ä¸€ä¸ªç¨³å®šçš„çŠ¶æ€ã€‚ä½†æ˜¯ä¸€æ—¦ç›‘æ§çš„ç¯å¢ƒå‘ç”Ÿå˜åŒ–â€”â€”æ‰©å±•åº”ç”¨æˆ–æ»šåŠ¨æ›´æ–°æ—¶ï¼ŒSeries Churn å°±ä¼šå¢åŠ å†…å­˜ã€CPU å’Œç£ç›˜çš„ä½¿ç”¨ã€‚\nå¦‚æœå˜åŒ–æŒç»­è¿›è¡Œï¼Œèµ„æºæ¶ˆè€—å°†å†æ¬¡è¾¾åˆ°ä¸€ä¸ªç¨³å®šçš„çŠ¶æ€ï¼Œä¸è¿‡æ˜æ˜¾è¦æ¯”é™æ€ç¯å¢ƒä¸­çš„é«˜ã€‚è¿‡æ¸¡å‘¨æœŸé€šå¸¸é•¿è¾¾æ•°ä¸ªå°æ—¶ï¼Œå› æ­¤æˆ‘ä»¬å¾ˆéš¾ç¡®å®šæœ€å¤§çš„èµ„æºä½¿ç”¨é‡ã€‚\nä¸ºæ¯ä¸ª Series ç»´æŠ¤ä¸€ä¸ªæ–‡ä»¶çš„æ–¹æ¡ˆä¹Ÿä¼šä½¿å•ä¸ªæŸ¥è¯¢æ“ä½œå¾ˆå®¹æ˜“ç»ˆæ­¢ Prometheus çš„è¿›ç¨‹ã€‚å½“æŸ¥è¯¢æœªè¢«ç¼“å­˜çš„æ•°æ®æ—¶ï¼Œä¸ä¹‹å…³è”çš„ Series æ–‡ä»¶éœ€è¦è¢«æ‰“å¼€å¹¶å°†åŒ…å«ç›¸å…³æ•°æ®ç‚¹çš„ Chunk è¯»å…¥å†…å­˜ã€‚å¦‚æœæ•°æ®é‡è¶…è¿‡äº†å†…å­˜é…é¢ï¼ŒPrometheus å°±ä¼šå›  OOM è€Œç›¸å½“ä¸é›…åœ°é€€å‡ºã€‚åŠ è½½çš„æ•°æ®å¯ä»¥åœ¨æŸ¥è¯¢ç»“æŸåé‡Šæ”¾ï¼Œä½†ä¸ºäº†åç»­èƒ½å¤Ÿæ›´å¿«åœ°æŸ¥è¯¢ç›¸åŒæ•°æ®ï¼Œé€šå¸¸è¦ç¼“å­˜æ›´é•¿çš„æ—¶é—´ã€‚\næˆ‘ä»¬åœ¨ä¸Šæ–‡ä¸­æåˆ°äº† SSD çš„å†™æ”¾å¤§ï¼Œä»¥åŠ Prometheus æ˜¯å¦‚ä½•é€šè¿‡æ‰¹é‡å†™å…¥æ¥è§£å†³è¿™ä¸€é—®é¢˜çš„ã€‚å°½ç®¡å¦‚æ­¤ï¼Œåœ¨ä¸€äº›åœºæ™¯ä¸­â€”â€”å¦‚å†™å…¥çš„æ‰¹æ¬¡å¤ªå°æˆ–è€…æ•°æ®æ²¡æœ‰ä¸ Page çš„è¾¹ç•Œç²¾ç¡®å¯¹é½ï¼Œå†™æ”¾å¤§è¿˜æ˜¯ä¼šäº§ç”Ÿã€‚æˆ‘ä»¬å·²ç»åœ¨ä¸€äº›è§„æ¨¡è¾ƒå¤§çš„ Prometheus æœåŠ¡å™¨ä¸Šè§‚æµ‹åˆ°äº†ç¡¬ä»¶å¯¿å‘½ç¼©çŸ­çš„ç°è±¡ï¼Œè™½ç„¶è¿™å¯¹å†™å…¥ååé‡è¾ƒé«˜çš„æ•°æ®åº“åº”ç”¨æ¥è¯´æ˜¯æ­£å¸¸çš„ï¼Œä½†è¿˜æ˜¯åº”å½“æ€è€ƒå¦‚ä½•ç¼“è§£å®ƒã€‚\né‡æ–°å¼€å§‹ åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å¯¹ Prometheus éœ€è¦è§£å†³çš„é—®é¢˜ã€V2 å­˜å‚¨ç³»ç»Ÿçš„è®¾è®¡æ–¹æ¡ˆåŠå…¶ç¼ºç‚¹æœ‰äº†å……åˆ†çš„äº†è§£ã€‚è®¸å¤š V2 å­˜å‚¨ç³»ç»Ÿå­˜åœ¨çš„ä¸è¶³å¯ä»¥é€šè¿‡ä¸€äº›ä¼˜åŒ–å’Œéƒ¨åˆ†é‡æ–°è®¾è®¡æ¥æ”¹å–„ï¼Œä½†ä¸ºäº†è®©äº‹æƒ…å˜å¾—æ›´æœ‰è¶£ï¼ˆå½“ç„¶ä¹Ÿç»è¿‡äº†ä»”ç»†è¯„ä¼°ï¼‰ï¼Œæˆ‘å†³å®šä»é›¶å¼€å§‹ç¼–å†™ä¸€ä¸ªå®Œæ•´çš„æ—¶åºæ•°æ®åº“ã€‚\nå­˜å‚¨æ¨¡å¼å°†ç›´æ¥å½±å“åˆ° Prometheus çš„æ€§èƒ½å’Œèµ„æºæ¶ˆè€—ç­‰å…³é”®é—®é¢˜ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»ä¸ºæ•°æ®æ‰¾åˆ°æ­£ç¡®çš„ç®—æ³•é›†å’Œç£ç›˜è®¾è®¡æ–¹æ¡ˆã€‚è¿™å°±æ˜¯æˆ‘èƒ½å¤Ÿå…èµ°å¼¯è·¯è€Œç›´æ¥æ‰¾åˆ°è§£å†³æ–¹æ¡ˆçš„åŸå› ã€‚\nV3â€”â€”å®è§‚è®¾è®¡ å½“æˆ‘ä»¬åœ¨ Prometheus çš„æ•°æ®ç›®å½•ä¸‹ä½¿ç”¨treeå‘½ä»¤æ—¶ï¼Œå°±å¯ä»¥çœ‹åˆ° V3 å­˜å‚¨ç³»ç»Ÿçš„å®è§‚å±‚çº§ç»“æ„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 $ tree ./data ./data â”œâ”€â”€ b-000001 â”‚ â”œâ”€â”€ chunks â”‚ â”‚ â”œâ”€â”€ 000001 â”‚ â”‚ â”œâ”€â”€ 000002 â”‚ â”‚ â””â”€â”€ 000003 â”‚ â”œâ”€â”€ index â”‚ â””â”€â”€ meta.json â”œâ”€â”€ b-000004 â”‚ â”œâ”€â”€ chunks â”‚ â”‚ â””â”€â”€ 000001 â”‚ â”œâ”€â”€ index â”‚ â””â”€â”€ meta.json â”œâ”€â”€ b-000005 â”‚ â”œâ”€â”€ chunks â”‚ â”‚ â””â”€â”€ 000001 â”‚ â”œâ”€â”€ index â”‚ â””â”€â”€ meta.json â””â”€â”€ b-000006 â”œâ”€â”€ meta.json â””â”€â”€ wal â”œâ”€â”€ 000001 â”œâ”€â”€ 000002 â””â”€â”€ 000003 æœ€ä¸Šå±‚ç›®å½•æ˜¯ä¸€ç³»åˆ—ç»è¿‡ç¼–å·çš„ Blockï¼Œå…¶å‰ç¼€å‡ä¸ºb-ã€‚æ¯ä¸ª Block ä¸­éƒ½æœ‰ä¸€ä¸ªç´¢å¼•æ–‡ä»¶indexå’Œä¸€ä¸ªåŒ…å«è‹¥å¹²ç¼–å·æ–‡ä»¶çš„chunksç›®å½•ï¼Œè¯¥ç›®å½•ä¸­ä¿å­˜äº†å¤šä¸ª Series æ•°æ®ç‚¹çš„åŸå§‹ Chunkã€‚å’Œ V2 å­˜å‚¨ç³»ç»Ÿä¸€æ ·ï¼Œè¿™ç§è®¾è®¡å¯ä»¥å‡å°‘è¯»å–ä¸€ä¸ªæ—¶é—´çª—å£å†…çš„ Series æ•°æ®çš„æ€§èƒ½å¼€é”€ï¼Œå¹¶æ”¯æŒä½¿ç”¨ç›¸åŒçš„é«˜æ•ˆå‹ç¼©ç®—æ³•ã€‚åŸºäº Chunk çš„ç†å¿µå·²ç»è¢«è¯æ˜æ˜¯è¡Œä¹‹æœ‰æ•ˆçš„ï¼Œå› æ­¤æˆ‘ä»¬å°†æ²¿ç”¨ä¸‹å»ã€‚ä¸è¿‡ï¼Œç°åœ¨çš„å­˜å‚¨ç³»ç»Ÿä¸å†æ˜¯æ¯ä¸ªæ–‡ä»¶å¯¹åº”ä¸€ä¸ª Seriesï¼Œè€Œæ˜¯ç”±å‡ ä¸ªæ–‡ä»¶ä¿å­˜å¤šä¸ª Series çš„ Chunkã€‚\nç´¢å¼•æ–‡ä»¶indexçš„å­˜åœ¨ä¸è¶³ä¸ºå¥‡ã€‚è®©æˆ‘ä»¬å‡è®¾å®ƒæ‹¥æœ‰è¯¸å¤šé»‘é­”æ³•ï¼Œå¯ä»¥ç”¨äºæŸ¥æ‰¾æ ‡ç­¾åŠå…¶å¯èƒ½çš„å€¼ã€æ•´ä¸ªæ—¶é—´åºåˆ—ä»¥åŠå­˜å‚¨æ•°æ®ç‚¹çš„ Chunkã€‚\nä½†ä¸ºä»€ä¹ˆè¦è®¾è®¡æˆè‹¥å¹²ä¸ªåŒ…å«ç´¢å¼•å’Œå¤šä¸ª Chunk æ–‡ä»¶çš„ç›®å½•ï¼Ÿä¸ºä»€ä¹ˆæœ€åä¸€ä¸ª Block ä¸­è¿˜å­˜åœ¨ä¸€ä¸ªwalç›®å½•ï¼Ÿåªè¦ç†è§£äº†è¿™ä¸¤ç‚¹ï¼Œå°±èƒ½è§£å†³æˆ‘ä»¬ 90%çš„é—®é¢˜ã€‚\nå¤šä¸ªå°å‹æ•°æ®åº“ æˆ‘ä»¬å°†äºŒç»´æ•°æ®å¹³é¢åœ¨æ°´å¹³ç»´åº¦ï¼ˆå³æ—¶é—´ï¼‰ä¸Šåˆ’åˆ†ä¸ºå¤šä¸ªäº’ä¸é‡å çš„ Blockï¼Œæ¯ä¸ª Block å‡è¡¨ç°ä¸ºä¸€ä¸ªåŒ…å«å…¶æ—¶é—´çª—å£å†…æ‰€æœ‰ Series æ•°æ®çš„ç‹¬ç«‹æ•°æ®åº“ã€‚å› æ­¤ï¼ŒBlock ä¸­å­˜åœ¨è‡ªèº«çš„ç´¢å¼•å’Œå¤šä¸ª Chunk æ–‡ä»¶ã€‚\næ¯ä¸ªå·²æŒä¹…åŒ–çš„ Block éƒ½æ˜¯ä¸å¯æ”¹å˜çš„ï¼Œä½†æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªå¯å˜çš„ Blockï¼ˆå³ä¸Šå›¾ä¸­çš„â€œMutable Blockâ€ï¼‰æ¥æ¥æ”¶æ–°çš„æ ·æœ¬æ•°æ®ã€‚è¯¥ Block æ˜¯ä¸€ä¸ªèƒ½å¤Ÿé«˜æ•ˆæ›´æ–°æ•°æ®ç»“æ„çš„å†…å­˜æ•°æ®åº“ï¼Œå¹¶æœ‰ç€ä¸å·²æŒä¹…åŒ–çš„ Block ç›¸åŒçš„æŸ¥è¯¢ç‰¹æ€§ã€‚ä¸ºäº†é˜²æ­¢æ•°æ®ä¸¢å¤±ï¼Œæ‰€æœ‰åˆšé‡‡é›†åˆ°çš„æ•°æ®éƒ½ä¼šå¦å¤–å†™å…¥ä¸´æ—¶çš„é¢„å†™æ—¥å¿—ï¼ˆWrite Ahead Logï¼‰ä¸­ã€‚å®ƒå®é™…ä¸Šå°±æ˜¯walç›®å½•ä¸­çš„ä¸€ç»„æ–‡ä»¶ï¼Œå¯ä»¥åœ¨ Prometheus é‡å¯æ—¶æ¢å¤åŸæœ‰çš„å†…å­˜æ•°æ®åº“ã€‚\nç°åœ¨æˆ‘ä»¬å¯ä»¥æ ¹æ®æ¯ä¸ª Block å¯¹åº”çš„æ—¶é—´èŒƒå›´å°†æŸ¥è¯¢è¯·æ±‚åˆ†å‘åˆ°å„ä¸ª Block ä¸­ï¼Œæœ€ç»ˆçš„æŸ¥è¯¢ç»“æœæ˜¯ç”±æ¯ä¸ª Block çš„è¿”å›å€¼åˆå¹¶è€Œæˆçš„ã€‚\nè¿™ç§è®¾è®¡çš„ä¼˜åŠ¿åœ¨äºï¼š\nå½“æŸ¥è¯¢æŸä¸€æ—¶é—´èŒƒå›´å†…çš„æ•°æ®æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ˜“åœ°å¿½ç•¥è¯¥æ—¶é—´èŒƒå›´å¤–çš„æ‰€æœ‰ Blockã€‚éšç€æŸ¥è¯¢å¼€å§‹æ—¶æ£€ç´¢çš„æ•°æ®é›†æ•°é‡çš„å‡å°‘ï¼Œ Series Churn å¸¦æ¥çš„é—®é¢˜è¿åˆƒè€Œè§£ï¼› å½“ä¸€ä¸ª Block å†™æ»¡åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é¡ºåºå†™å¤šä¸ªå¤§æ–‡ä»¶çš„æ–¹å¼ä»å†…å­˜æ•°æ®åº“ä¸­æŒä¹…åŒ–æ•°æ®ã€‚è¿™æ · Prometheus å°±é¿å…äº†ä»»ä½•çš„å†™æ”¾å¤§é—®é¢˜ï¼Œå¹¶ä¸”èƒ½åœ¨ SSD å’Œ HDD ä¸Šè¡¨ç°å¾—åŒæ ·å‡ºè‰²ï¼› æˆ‘ä»¬ä¿ç•™äº† V2 å­˜å‚¨ç³»ç»Ÿä¸­çš„ä¼˜ç‚¹ï¼Œå³æŸ¥è¯¢æœ€ä¸ºé¢‘ç¹çš„ Chunk å§‹ç»ˆä¿å­˜åœ¨å†…å­˜ä¸­ï¼› æˆ‘ä»¬ä¸å†éœ€è¦ä¸ºäº†æ•°æ®å¯¹é½è€Œé™åˆ¶ Chunk çš„å¤§å°ä¸ºå›ºå®šçš„ 1KiBï¼Œç°åœ¨å¯ä»¥é€‰æ‹©å¯¹äºå•ä¸ªæ•°æ®ç‚¹å’Œæ‰€é€‰å‹ç¼©æ ¼å¼æœ€åˆé€‚çš„ä»»æ„å¤§å°ï¼› åˆ é™¤æ—§æ•°æ®çš„å¼€é”€å˜å¾—å¾ˆå°å¹¶ä¸”èƒ½å¤Ÿå¿«é€Ÿå®Œæˆï¼Œå› ä¸ºæˆ‘ä»¬åªéœ€è¦ç®€å•åœ°åˆ é™¤ä¸€ä¸ªç›®å½•ã€‚è¦çŸ¥é“åœ¨ V2 å­˜å‚¨ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬å¿…é¡»åˆ†æå’Œé‡å†™å¤šè¾¾æ•°äº¿ä¸ªæ–‡ä»¶ï¼Œå¯èƒ½éœ€è¦èŠ±è´¹æ•°ä¸ªå°æ—¶ã€‚ æ¯ä¸ª Block ä¸­è¿˜å­˜æœ‰ä¸€ä¸ªmeta.jsonæ–‡ä»¶ï¼Œå®ƒåªä¿å­˜ä¸€äº›ä¸ Block ç›¸å…³çš„å¯è¯»ä¿¡æ¯ï¼Œå› æ­¤æˆ‘ä»¬ä¾¿å¯ä»¥è½»æ¾äº†è§£å­˜å‚¨çŠ¶æ€ä»¥åŠ Block ä¸­åŒ…å«çš„æ•°æ®ã€‚\nè¯‘è€…æ³¨ï¼šä» Prometheus v2.19.0 å¼€å§‹ï¼ŒMutable Block ä¾¿ä¸å†å…¨éƒ¨å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œè¯¦è§ï¼šPrometheus TSDB (Part 1): The Head Blockã€‚\nmmap æ—¢ç„¶å·²æŒä¹…åŒ–çš„æ•°æ®ä»æ•°ç™¾ä¸‡ä¸ªå°æ–‡ä»¶å˜æˆäº†è‹¥å¹²ä¸ªå¤§æ–‡ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½å¤Ÿä»¥å¾ˆä½çš„å¼€é”€ä¿æŒæ‰€æœ‰æ–‡ä»¶å‡å¤„äºæ‰“å¼€çŠ¶æ€ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å¼•å…¥ç³»ç»Ÿè°ƒç”¨ mmapï¼Œå°†æ–‡ä»¶å†…å®¹é€æ˜åœ°æ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜åŒºåŸŸä¸­ã€‚mmap æœ‰äº›ç±»ä¼¼äºäº¤æ¢åˆ†åŒºï¼ˆSwap Spaceï¼‰ï¼Œåªä¸è¿‡æˆ‘ä»¬æ‰€æœ‰çš„æ•°æ®éƒ½å·²ç»åœ¨ç£ç›˜ä¸Šäº†ï¼Œåœ¨æ•°æ®æ¢å‡ºå†…å­˜æ—¶ä¸ä¼šå‘ç”Ÿå†™å…¥ã€‚\nè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥æŠŠæ•°æ®åº“ä¸­çš„æ‰€æœ‰å†…å®¹éƒ½è§†ä¸ºåœ¨å†…å­˜ä¸­ï¼Œè€Œå®é™…ä¸Šå´æ²¡æœ‰å ç”¨ä»»ä½•ç‰©ç†å†…å­˜ï¼ˆRAMï¼‰ã€‚åªæœ‰æˆ‘ä»¬è®¿é—®æ•°æ®åº“æ–‡ä»¶ä¸­æŒ‡å®šçš„å­—èŠ‚èŒƒå›´æ—¶ï¼Œæ“ä½œç³»ç»Ÿæ‰ä¼šä»ç£ç›˜ä¸­æ‡’åŠ è½½ Pageã€‚æˆ‘ä»¬è®©æ“ä½œç³»ç»Ÿæ¥è´Ÿè´£æ‰€æœ‰å·²æŒä¹…åŒ–æ•°æ®çš„å†…å­˜ç®¡ç†ï¼Œå› ä¸ºå®ƒå¯¹æ•´ä¸ªæœºå™¨å’Œå…¶ä¸­çš„è¿›ç¨‹æœ‰ç€å…¨é¢çš„äº†è§£ã€‚ä¸ºäº†å¤„ç†æŸ¥è¯¢è¯·æ±‚ï¼Œæ›´å¤šçš„æ•°æ®å°†è¢«ç¼“å­˜åˆ°å†…å­˜ä¸­ï¼Œä½†å®ƒä»¬ä¼šåœ¨å†…å­˜å‹åŠ›è¾ƒå¤§æ—¶è¢«æ“ä½œç³»ç»Ÿé©±é€ã€‚å¦‚æœæœºå™¨ä¸­è¿˜æœ‰å†…å­˜æœªè¢«ä½¿ç”¨ï¼ŒPrometheus ç”šè‡³å¯ä»¥æŠŠæ•´ä¸ªæ•°æ®åº“ç¼“å­˜åˆ°å†…å­˜ä¸­ã€‚è€Œä¸€æ—¦å¦ä¸€ä¸ªåº”ç”¨éœ€è¦ä½¿ç”¨è¿™éƒ¨åˆ†å†…å­˜ï¼ŒPrometheus ä¾¿ä¼šç«‹åˆ»è¿”è¿˜ç»™å®ƒã€‚\nå› æ­¤ï¼ŒæŸ¥è¯¢æ¯” RAM å®¹é‡æ›´å¤šçš„å·²æŒä¹…åŒ–æ•°æ®å¾ˆå®¹æ˜“å¯¼è‡´è¿›ç¨‹çš„ OOMã€‚å†…å­˜ä¸­ç¼“å­˜çš„å¤§å°å˜å¾—å®Œå…¨è‡ªé€‚åº”ï¼Œåªæœ‰åœ¨éœ€è¦å“åº”æŸ¥è¯¢è¯·æ±‚æ—¶æ‰ä¼šåŠ è½½æ•°æ®ã€‚\næ®æˆ‘æ‰€çŸ¥ï¼Œå¦‚ä»Šå¤§å¤šæ•°çš„æ•°æ®åº“å‡é‡‡ç”¨è¿™ç§è®¾è®¡ã€‚å¦‚æœç£ç›˜æ ¼å¼å…è®¸ï¼Œè¿™æ˜¯ä¸€ç§ç†æƒ³çš„å·¥ä½œæ¨¡å¼â€”â€”é™¤éæœ‰äººæœ‰ä¿¡å¿ƒåœ¨ç®¡ç†è¿›ç¨‹æ–¹é¢èƒœè¿‡æ“ä½œç³»ç»Ÿã€‚\nå‹ç¼© å­˜å‚¨ç³»ç»Ÿå¿…é¡»å®šæœŸâ€œåˆ‡å‰²â€å‡ºä¸€ä¸ªæ–°çš„ Blockï¼Œç„¶åå°†å‰ä¸€ä¸ª Block å†™å…¥åˆ°ç£ç›˜ä¸­ã€‚åªæœ‰å½“å®ƒæˆåŠŸæŒä¹…åŒ–åï¼Œå¯¹åº”çš„é¢„å†™æ—¥å¿—æ–‡ä»¶æ‰èƒ½è¢«åˆ é™¤ã€‚\næ¯ä¸ª Block è¦†ç›–çš„æ—¶é—´èŒƒå›´ä¸èƒ½å¤ªé•¿ï¼ˆé»˜è®¤è®¾ç½®ä¸ºä¸¤å°æ—¶ï¼‰ï¼Œå¦åˆ™å°†å ç”¨è¿‡å¤šå†…å­˜ã€‚ä½†æŸ¥è¯¢å¤šä¸ª Block æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»æŠŠæ¯ä¸ªè¿”å›ç»“æœåˆå¹¶åˆ°ä¸€èµ·ã€‚è¿™ç§æ“ä½œæ˜¾ç„¶ä¼šæ¶ˆè€—æ€§èƒ½ï¼Œå› æ­¤ Block è¦†ç›–çš„æ—¶é—´èŒƒå›´ä¹Ÿä¸èƒ½å¤ªçŸ­ã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒæŸ¥è¯¢ä¸€å‘¨å†…æ•°æ®æ‰€éœ€è¦åˆå¹¶çš„ Block æ•°é‡ä¸åº”è¶…è¿‡ 80 ä¸ªã€‚\nä¸ºäº†åŒæ—¶å®ç°è¿™ä¸¤ç‚¹ï¼Œæˆ‘ä»¬å¯¹ Block è¿›è¡Œå‹ç¼©ï¼Œå³å°†ä¸€ä¸ªæˆ–å¤šä¸ª Block ä¸­çš„æ•°æ®å†™å…¥åˆ°ä¸€ä¸ªæœ‰å¯èƒ½æ›´å¤§çš„ Block ä¸­ã€‚Prometheus åœ¨å‹ç¼©è¿‡ç¨‹ä¸­è¿˜ä¼šä¿®æ”¹ç°æœ‰æ•°æ®ï¼Œæ¯”å¦‚åˆ é™¤å·²è¢«æ ‡è®°ä¸ºå³å°†åˆ é™¤çš„æ•°æ®ï¼Œæˆ–è€…ä¸ºäº†æé«˜æŸ¥è¯¢æ€§èƒ½è€Œé‡æ–°æ„å»ºæ ·æœ¬çš„ Chunkã€‚\nåœ¨ä¸Šå›¾ä¸­ï¼Œå‡ ä¸ª Block è¢«é¡ºåºç¼–å·ä¸º [1, 2, 3, 4]ã€‚Block 1ã€2 å’Œ 3 å¯ä»¥è¢«å‹ç¼©åˆ°ä¸€èµ·ï¼Œå˜æˆ [1, 4]ã€‚ä¹Ÿå¯ä»¥å°†å®ƒä»¬ä¸¤ä¸¤å‹ç¼©ï¼Œå˜æˆ [1, 3]ã€‚æ‰€æœ‰æ—¶é—´åºåˆ—æ•°æ®ä»ç„¶å­˜åœ¨ï¼Œä½†ç°åœ¨ Block çš„æ€»æ•°å‡å°‘äº†ã€‚è¿™æ ·æŸ¥è¯¢æ—¶éœ€è¦è¢«åˆå¹¶çš„è¿”å›ç»“æœå°±æ›´å°‘ï¼Œä»è€Œæ˜¾ç€åœ°é™ä½äº†åˆå¹¶æ“ä½œçš„å¼€é”€ã€‚\nä¿ç•™ åœ¨ V2 å­˜å‚¨ç³»ç»Ÿä¸­ï¼Œåˆ é™¤æ—§æ•°æ®æ˜¯ä¸€ä¸ªéå¸¸ç¼“æ…¢çš„è¿‡ç¨‹ï¼Œå¹¶ä¸”ä¼šèŠ±è´¹å¤§é‡çš„ CPUã€å†…å­˜å’Œç£ç›˜èµ„æºã€‚è€Œç°åœ¨ï¼Œæˆ‘ä»¬åªéœ€è¦åˆ é™¤é‚£äº›åœ¨æŒ‡å®šä¿ç•™æ—¶é—´çª—å£å†…æ²¡æœ‰æ•°æ®çš„ Block ç›®å½•å³å¯ã€‚ä¸‹æ–¹ç¤ºä¾‹ä¸­ï¼ŒBlock 1 å¯ä»¥è¢«å®‰å…¨åœ°åˆ é™¤ï¼ŒBlock 2 åˆ™å¿…é¡»ç­‰åˆ°å®ƒå®Œå…¨è¶…å‡ºä¿ç•™è¾¹ç•Œï¼ˆRetention Boundaryï¼‰åæ‰èƒ½è¢«åˆ é™¤ï¼š\néšç€æ—§æ•°æ®çš„ä¸æ–­ç§¯ç´¯ï¼Œå‹ç¼©åçš„ Block ä¼šå˜å¾—è¶Šæ¥è¶Šå¤§ã€‚æˆ‘ä»¬å¿…é¡»ä¸ºå…¶æœ€å¤§å€¼è®¾ç½®ä¸Šé™ï¼Œå¦åˆ™å®ƒå°†å¢é•¿åˆ°åŒ…å«æ•´ä¸ªæ•°æ®åº“ï¼Œä»è€Œå¾ˆéš¾è¢«åˆ é™¤ã€‚å¯¹äºåƒä¸Šå›¾ä¸­ Block 2 è¿™æ ·çš„è·¨è¶Šä¿ç•™è¾¹ç•Œçš„ Blockï¼Œè¿™ç§åšæ³•ä¹Ÿé™åˆ¶äº†ç»´æŠ¤å®ƒä»¬æ‰€éœ€çš„ç£ç›˜å¼€é”€ã€‚å½“ Block çš„æœ€å¤§å°ºå¯¸è¢«è®¾ä¸ºä¿ç•™æ—¶é—´çª—å£çš„ 10%æ—¶ï¼Œç»´æŠ¤ Block 2 çš„æˆæœ¬ä¹Ÿä¼šå—åˆ°åŒæ ·çš„é™åˆ¶ã€‚\næ€»ä¹‹ï¼Œåˆ é™¤æ—§æ•°æ®çš„å¼€é”€ä»éå¸¸æ˜‚è´µå˜æˆäº†å‡ ä¹å…è´¹ã€‚\nå¦‚æœä½ å·²ç»è¯»åˆ°è¿™é‡Œå¹¶æŒæ¡ä¸€äº›æ•°æ®åº“çŸ¥è¯†ï¼Œå¯èƒ½ä¼šæœ‰è¿™æ ·çš„ç–‘é—®ï¼šâ€œè¿™äº›è®¾è®¡æ˜¯å…¨æ–°çš„å—ï¼Ÿâ€â€”â€”å®é™…ä¸Šå¹¶éå¦‚æ­¤ï¼Œç”šè‡³å¯èƒ½åšå¾—æ›´å¥½ã€‚\nåœ¨å†…å­˜ä¸­æ‰¹é‡å¤„ç†æ•°æ®ã€åœ¨é¢„å†™æ—¥å¿—ä¸­è®°å½•æ“ä½œä»¥åŠå‘¨æœŸæ€§åœ°å°†æ•°æ®è½ç›˜çš„è®¾è®¡æ¨¡å¼åœ¨å¦‚ä»Šæ— å¤„ä¸åœ¨ï¼Œä½¿ç”¨è¿™ç§æ–¹æ¡ˆçš„çŸ¥åå¼€æºé¡¹ç›®æœ‰ LevelDBã€Cassandraã€InfluxDB ä»¥åŠ HBase ç­‰ã€‚å…³é”®åœ¨äºä¸è¦å‘æ˜åŠ£è´¨çš„è½®å­ï¼Œè€Œæ˜¯å¯¹å·²è¢«è¯æ˜æœ‰æ•ˆçš„æ–¹æ³•æ·±å…¥ç ”ç©¶ï¼Œå¹¶ä»¥æ­£ç¡®çš„æ–¹å¼åº”ç”¨å®ƒä»¬ã€‚\nå½“ç„¶ï¼Œæˆ‘ä»¬è¿˜æœ‰æœºä¼šåœ¨ Prometheus ä¸­åŠ å…¥è‡ªå·±çš„â€œé­”æ³•â€ã€‚\nç´¢å¼• æˆ‘ä»¬æ”¹è¿›å­˜å‚¨ç³»ç»Ÿçš„åˆè¡·æ˜¯å¸Œæœ›è§£å†³ Series Churn å¸¦æ¥çš„é—®é¢˜ï¼Œè€ŒåŸºäº Block çš„è®¾è®¡åˆ™å‡å°‘äº†æŸ¥è¯¢æ—¶æ¶‰åŠçš„ Series æ•°é‡ï¼ˆè®¾ä¸º nï¼‰ã€‚ç„¶è€Œå¯¹äºæ—¶é—´å¤æ‚åº¦ä¸º $O(n^2)$ çš„æŸ¥è¯¢æ“ä½œï¼Œå‡å°‘ n çš„æ•°é‡æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ã€‚å¦‚æœä»¥å‰æŸ¥è¯¢æ€§èƒ½å¾ˆå·®ï¼Œé‚£ä¹ˆç°åœ¨ä¾ç„¶ä¼šå¾ˆç³Ÿç³•ã€‚\nå®é™…ä¸Šï¼Œå¤§å¤šæ•°æŸ¥è¯¢æ“ä½œçš„å“åº”éƒ½å¾ˆå¿«ã€‚å¯ä¸€æ—¦æ—¶é—´è·¨åº¦è¾ƒå¤§ï¼Œå³ä½¿åªæŸ¥è¯¢å‡ ä¸ª Series ä¹Ÿä¼šå¾ˆæ…¢ã€‚åœ¨å¼€å±•æ‰€æœ‰å·¥ä½œå‰ï¼Œæˆ‘æœ€åˆçš„æƒ³æ³•ä¾¿æ˜¯ä¸ºè¿™ä¸ªé—®é¢˜æ‰¾åˆ°ä¸€ä¸ªè§£å†³æ–¹æ¡ˆã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ›´åŠ å¼ºå¤§çš„ å€’æ’ç´¢å¼•ã€‚\nå€’æ’ç´¢å¼•å¯ä»¥åŸºäºæ•°æ®å†…å®¹çš„å­é›†æ¥ä¸ºæˆ‘ä»¬æä¾›å¿«é€ŸæŸ¥æ‰¾çš„èƒ½åŠ›ã€‚ç®€è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸éå†å…¨éƒ¨ Series çš„æƒ…å†µä¸‹ï¼Œæ‰¾åˆ°æ‰€æœ‰åŒ…å«æ ‡ç­¾app=\"nginx\"çš„ Seriesã€‚\nä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæ¯ä¸ª Series åˆ†é…ä¸€ä¸ªç‹¬æœ‰çš„ IDã€‚å®ƒå¯ä»¥åœ¨å¸¸é‡æ—¶é—´ï¼Œå³ $O(1)$ å†…è¢«æ£€ç´¢å‡ºæ¥ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒID æ˜¯æˆ‘ä»¬çš„æ­£æ’ç´¢å¼•ï¼ˆForward Indexï¼‰ã€‚\nç¤ºä¾‹ï¼šå¦‚æœåŒ…å«æ ‡ç­¾app=\"nginx\"çš„ Series ID ä¸º 10ã€29 å’Œ 10ï¼Œé‚£ä¹ˆæ ‡ç­¾â€œnginxâ€çš„å€’æ’ç´¢å¼•å°±æ˜¯ä¸€ä¸ªç®€å•çš„æ•°ç»„ [10, 29, 9]ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥å¿«é€Ÿæ£€ç´¢æ‰€æœ‰åŒ…å«è¯¥æ ‡ç­¾çš„ Seriesã€‚å³ä½¿è¿˜æœ‰å…¶ä»– 200 äº¿ä¸ª Seriesï¼Œä¹Ÿä¸ä¼šå½±å“è¿™æ¬¡æŸ¥è¯¢çš„é€Ÿåº¦ã€‚\nç®€å•æ¥è¯´ï¼Œå¦‚æœ n æ˜¯ Series æ€»æ•°ï¼Œm æ˜¯ç»™å®šæŸ¥è¯¢ç»“æœçš„å¤§å°ï¼Œé‚£ä¹ˆæŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦å°±ä» $O(n)$ å˜æˆäº† $O(m)$ã€‚é€šå¸¸ m è¦æ¯” n å°å¾ˆå¤šï¼Œå› æ­¤æŸ¥è¯¢æ€§èƒ½å°†æ˜¾è‘—æå‡ã€‚\nå®é™…ä¸Šï¼Œè¿™ä¸€è®¾è®¡ä¸ V2 å­˜å‚¨ç³»ç»Ÿä¸­æ‰€é‡‡ç”¨çš„å€’æ’ç´¢å¼•å‡ ä¹ç›¸åŒï¼Œä¹Ÿæ˜¯åœ¨æ•°ç™¾ä¸‡ä¸ª Series ä¸­å®ç°é«˜æ€§èƒ½æŸ¥è¯¢çš„æœ€ä½è¦æ±‚ã€‚æ•é”çš„è¯»è€…å¯èƒ½å·²ç»å‘ç°ï¼Œåœ¨æœ€åçš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªæ ‡ç­¾å­˜åœ¨äºæ‰€æœ‰çš„ Series ä¸­ï¼Œé‚£ä¹ˆå¤æ‚åº¦åˆå˜æˆäº† $O(n)$ã€‚å…¶å®è¿™æ˜¯åˆç†çš„ï¼Œå› ä¸ºå¦‚æœæŸ¥è¯¢æ¶‰åŠåˆ°å…¨éƒ¨æ•°æ®ï¼Œè‡ªç„¶éœ€è¦æ›´é•¿çš„æ—¶é—´ã€‚ä¸è¿‡ï¼Œä¸€æ—¦æˆ‘ä»¬ä½¿ç”¨æ›´åŠ å¤æ‚çš„æŸ¥è¯¢è¯­å¥ï¼Œå°±ä¼šé¢ä¸´ä¸€äº›æ–°çš„é—®é¢˜ã€‚\næ ‡ç­¾çš„ç»„åˆ ä¸€ä¸ªæ ‡ç­¾ä¸æ•°ç™¾ä¸‡ä¸ª Series å…³è”æ˜¯å¾ˆå¸¸è§çš„ã€‚å‡è®¾ä¸€ä¸ªå¾®æœåŠ¡\"foo\"æ°´å¹³æ‰©å±•ä¸ºæ•°ç™¾ä¸ªå®ä¾‹ï¼Œå…¶ä¸­æ¯ä¸ªå®ä¾‹åˆæœ‰æ•°åƒä¸ªåŒ…å«æ ‡ç­¾app=\"foo\"çš„ Seriesã€‚é€šå¸¸æˆ‘ä»¬ä¸ä¼šæŸ¥è¯¢æ‰€æœ‰çš„ Seriesï¼Œè€Œæ˜¯ä½¿ç”¨å¤šä¸ªæ ‡ç­¾çš„ç»„åˆæ¥å¯¹è¿”å›ç»“æœè¿›è¡Œä¸€å®šçš„é™åˆ¶ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡__name__=\"requests_total\" AND app=\"foo\"æ¥è·å–æœåŠ¡å®ä¾‹æ¥æ”¶çš„è¯·æ±‚æ•°ã€‚\nä¸ºäº†æ‰¾åˆ°æ»¡è¶³ä¸¤ä¸ªæ ‡ç­¾é€‰æ‹©å™¨çš„æ‰€æœ‰ Seriesï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—ä¸¤ä¸ªæ ‡ç­¾å¯¹åº”çš„å€’æ’ç´¢å¼•æ•°ç»„çš„äº¤é›†ï¼Œå…¶ç»“æœé€šå¸¸æ¯”å•ç‹¬çš„å€’æ’ç´¢å¼•æ•°ç»„å°å‡ ä¸ªæ•°é‡çº§ã€‚åœ¨æœ€åçš„æƒ…å†µä¸‹ï¼Œæ¯ä¸ªå€’æ’ç´¢å¼•æ•°ç»„çš„é•¿åº¦å‡ä¸º nï¼Œé‚£ä¹ˆåœ¨ä¸¤ä¸ªæ•°ç»„ä¸­é€šè¿‡åµŒå¥—è¿­ä»£å–äº¤é›†çš„æ—¶é—´å¤æ‚åº¦å°±ä¸º $O(n^2)$ã€‚å…¶ä»–ç±»ä¼¼çš„æŸ¥è¯¢æ“ä½œï¼Œå¦‚app=\"foo\" OR app=\"bar\"ï¼Œä¹Ÿä¼šèŠ±è´¹åŒæ ·çš„å¼€é”€ã€‚å½“æˆ‘ä»¬å‘æŸ¥è¯¢è¯­å¥ä¸­æ·»åŠ æ›´å¤šçš„æ ‡ç­¾é€‰æ‹©å™¨æ—¶ï¼Œæ—¶é—´å¤æ‚åº¦ä¼šå‘ˆæŒ‡æ•°å¢é•¿ï¼š$O(n^3)$ã€$O(n^4)$ã€$O(n^5)$ â€¦ $O(n^k)$ã€‚\nå¹¸è¿çš„æ˜¯ï¼Œåªéœ€è¦ä¸€ä¸ªå°å°çš„æ”¹åŠ¨å°±å¯ä»¥è§£å†³æˆ‘ä»¬çš„é—®é¢˜ã€‚å¦‚æœå€’æ’ç´¢å¼•æ•°ç»„ä¸­çš„ ID éƒ½å·²è¢«æ’åºï¼Œé‚£ä¹ˆä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ\n1 2 3 4 __name__=\"requests_total\" -\u003e [ 999, 1000, 1001, 2000000, 2000001, 2000002, 2000003 ] app=\"foo\" -\u003e [ 1, 3, 10, 11, 12, 100, 311, 320, 1000, 1001, 10002 ] intersection =\u003e [ 1000, 1001 ] æˆ‘ä»¬åœ¨æ¯ä¸ªæ•°ç»„çš„èµ·å§‹å…ƒç´ å¤„æ”¾ç½®ä¸€ä¸ªæ¸¸æ ‡ï¼Œå…¶ä¸­æ•°å­—è¾ƒå°çš„ä¼šä¸æ–­å‰è¿›ã€‚å½“ä¸¤ä¸ªæ¸¸æ ‡å¯¹åº”çš„æ•°å­—ç›¸ç­‰æ—¶ï¼Œæˆ‘ä»¬å°±æŠŠå®ƒæ·»åŠ åˆ°ç»“æœä¸­å¹¶åŒæ—¶æ¨è¿›ä¸¤ä¸ªæ¸¸æ ‡ã€‚ç”±äºæ¸¸æ ‡åªä¼šåœ¨å…¶æ‰€åœ¨çš„æ•°ç»„ä¸­ç§»åŠ¨ï¼Œå› æ­¤å…¶éå†å…¨éƒ¨æ•°ç»„çš„æ—¶é—´å¤æ‚åº¦ä¸º $O(2n) = O(n)$ã€‚\nå¯¹ä¸¤ä¸ªä»¥ä¸Šçš„å€’æ’ç´¢å¼•æ•°ç»„å–äº¤é›†çš„è¿‡ç¨‹ä¸ä¹‹ç±»ä¼¼ã€‚å½“æ ‡ç­¾å¢é•¿åˆ° k ä¸ªæ—¶ï¼Œæ—¶é—´å¤æ‚åº¦åªä¼šå˜ä¸º $O(n * k)$ï¼Œè€Œä¸æ˜¯ $O(n^k)$ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„æ”¹è¿›ã€‚\næœ¬æ–‡ä»‹ç»çš„æ˜¯å…¸å‹æœç´¢ç´¢å¼•çš„ä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬ï¼Œå‡ ä¹æ‰€æœ‰çš„ å…¨æ–‡æœç´¢å¼•æ“ éƒ½åœ¨ä½¿ç”¨å®ƒã€‚æ¯ä¸ª Series çš„æ ‡è¯†ç¬¦éƒ½è¢«è§†ä¸ºä¸€ä¸ªç®€çŸ­çš„â€œdocumentâ€ï¼Œè€Œæ¯ä¸ªæ ‡ç­¾ï¼ˆåç§°åŠ ä¸Šå›ºå®šçš„å€¼ï¼‰åˆ™æ˜¯å…¶ä¸­çš„ä¸€ä¸ªâ€œwordâ€ã€‚æˆ‘ä»¬å¯ä»¥å¿½ç•¥ä¸€äº›æœç´¢å¼•æ“ä¸­å¸¸ç”¨çš„çš„ç´¢å¼•é™„åŠ æ•°æ®ï¼Œæ¯”å¦‚ word çš„ä½ç½®å’Œé¢‘ç‡ã€‚\nå®é™…ä¸Šè¿˜æœ‰å¾ˆå¤šæŠ€æœ¯å¯ä»¥å¯¹å€’æ’ç´¢å¼•è¿›è¡Œå‹ç¼©ï¼Œä½†å®ƒä»¬å„æœ‰ä¼˜ç¼ºç‚¹ã€‚è€ƒè™‘åˆ°æˆ‘ä»¬çš„ document å¾ˆå°ï¼Œå¹¶ä¸” word åœ¨å„ä¸ª Series ä¸­çš„é‡å¤ç‡å¾ˆé«˜ï¼Œå› æ­¤å‹ç¼©å…¶å®æ— å…³ç´§è¦ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªçœŸå®ä¸–ç•Œçš„æ•°æ®é›†ä¸­å¤§çº¦æœ‰ 440 ä¸‡ä¸ª Seriesï¼Œæ¯ä¸ª Series å¤§çº¦æœ‰ 12 ä¸ªæ ‡ç­¾ï¼Œä½†å…¶ä¸­å”¯ä¸€çš„æ ‡ç­¾å´ä¸è¶…è¿‡ 5000 ä¸ªã€‚æœ€åˆç‰ˆæœ¬çš„å­˜å‚¨ç³»ç»Ÿæ²¡æœ‰é‡‡ç”¨å‹ç¼©ï¼Œåªæ˜¯åšäº†ä¸€äº›ç®€å•ä¼˜åŒ–ä»¥è·³è¿‡å¤§èŒƒå›´æ²¡æœ‰äº¤é›†çš„ IDã€‚\nè®© ID å§‹ç»ˆæŒ‰é¡ºåºæ’åˆ—å¹¶éçœ‹èµ·æ¥é‚£ä¹ˆç®€å•ã€‚ä¾‹å¦‚ï¼ŒV2 å­˜å‚¨ç³»ç»Ÿå°†å“ˆå¸Œå€¼ä½œä¸º ID åˆ†é…ç»™æ–°çš„ Seriesï¼Œè¿™æ ·æˆ‘ä»¬å°±æ— æ³•æœ‰æ•ˆåœ°å¯¹å€’æ’ç´¢å¼•è¿›è¡Œæ’åºã€‚\nå¦ä¸€ä¸ªè‰°å·¨çš„ä»»åŠ¡æ˜¯åœ¨æ•°æ®è¢«åˆ é™¤æˆ–æ›´æ–°æ—¶ä¿®æ”¹ç´¢å¼•ã€‚é€šå¸¸æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯åœ¨ä¿è¯æ•°æ®åº“å¯æŸ¥è¯¢ä¸”ä¸€è‡´çš„åŒæ—¶ï¼Œé‡æ–°è®¡ç®—å¹¶é‡å†™å®ƒä»¬ã€‚V3 å­˜å‚¨ç³»ç»Ÿä¸ºæ¯ä¸ª Block éƒ½åˆ†é…äº†ä¸€ä¸ªç‹¬ç«‹çš„ç´¢å¼•ã€‚å¯¹äºå·²æŒä¹…åŒ–çš„ Blockï¼Œå…¶ç´¢å¼•åªæœ‰åœ¨å‹ç¼©æ—¶æ‰ä¼šè¢«é‡å†™ã€‚è€Œå¯¹äºå†…å­˜ä¸­å¯å˜çš„ Blockï¼Œå…¶ç´¢å¼•åˆ™éœ€è¦è¢«æŒç»­æ›´æ–°ã€‚\nåŸºå‡†æµ‹è¯• æˆ‘ä»¬ä½¿ç”¨ æµ‹è¯•å·¥å…· å°† Prometheus éƒ¨ç½²åœ¨ AWS ä¸Šçš„ Kubernetes é›†ç¾¤ä¸­ï¼Œå…¶ä¸­åŒ…å«ä¸¤ä¸ª 1.5.2 ç‰ˆæœ¬ï¼ˆV2 å­˜å‚¨ç³»ç»Ÿï¼‰å’Œä¸¤ä¸ª 2.0 ç‰ˆæœ¬ï¼ˆV3 å­˜å‚¨ç³»ç»Ÿï¼‰çš„å®ä¾‹ã€‚ä¸ºäº†æ¨¡æ‹Ÿ Series Churnï¼Œå¾®æœåŠ¡ä¼šå®šæœŸç§»é™¤æ—§çš„ Pod å¹¶åˆ›å»ºæ–°çš„ Pod ä»¥ç”Ÿæˆæ›´å¤šæ–°çš„ Seriesã€‚æœåŠ¡æ‰©å±•é¢‘ç‡å’ŒæŸ¥è¯¢è´Ÿè½½è¿œè¿œè¶…è¿‡äº†å¦‚ä»Šç”Ÿäº§ç¯å¢ƒä¸­çš„çœŸå®æƒ…å†µï¼Œå› æ­¤å¯ä»¥ç¡®ä¿ V3 å­˜å‚¨ç³»ç»Ÿèƒ½å¤Ÿåº”å¯¹æœªæ¥çš„æ•°æ®è§„æ¨¡ã€‚ä¾‹å¦‚ï¼Œåœ¨æˆ‘ä»¬çš„æµ‹è¯•ç¯å¢ƒä¸­å¾®æœåŠ¡æ¯éš” 15 åˆ†é’Ÿå°±è¦æ›´æ¢è‡ªèº« 60% çš„å®ä¾‹ã€‚è€Œåœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿™ç§æƒ…å†µæ¯å¤©åªä¼šå‘ç”Ÿä¸€åˆ°äº”æ¬¡ã€‚Prometheus æ¯ç§’ä» 850 ä¸ª Target ä¸­é‡‡é›†çº¦ 110000 ä¸ªæ ·æœ¬ï¼Œæ¯æ¬¡æ¶‰åŠå¤šè¾¾ 50 ä¸‡ä¸ª Seriesã€‚åŸºå‡†æµ‹è¯•çš„ç»“æœå¦‚ä¸‹ï¼š\n$$Heap \\space memory \\space usage \\space in \\space GB$$\næˆ‘ä»¬å¯ä»¥å‘ç°è¢«æŸ¥è¯¢çš„ Prometheus å®ä¾‹æ¶ˆè€—æ›´å¤šçš„å†…å­˜ï¼Œå¹¶ä¸” 2.0 ç‰ˆæœ¬çš„å †å†…å­˜ä½¿ç”¨é‡æ¯” 1.5 ç‰ˆæœ¬å‡å°‘äº†ä¸‰åˆ°å››å€ä¹‹å¤šã€‚åœ¨æµ‹è¯•å¼€å§‹å 6 å°æ—¶å·¦å³ï¼Œ1.5 ç‰ˆæœ¬çš„ Prometheus å®ä¾‹è¾¾åˆ°äº†å³°å€¼ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬å°†æ•°æ®çš„ä¿ç•™æœŸé™è®¾ç½®ä¸ºäº† 6 å°æ—¶ï¼Œè€Œ V2 å­˜å‚¨ç³»ç»Ÿä¸­åˆ é™¤æ•°æ®çš„å·¨å¤§å¼€é”€å¯¼è‡´äº†èµ„æºæ¶ˆè€—çš„ä¸Šå‡ã€‚\n$$CPU \\space usage \\space in \\space cores/second$$\nCPU ä½¿ç”¨ç‡çš„çŠ¶å†µä¸å†…å­˜ç±»ä¼¼ï¼Œåªä¸è¿‡æŸ¥è¯¢æ“ä½œå¯¹å…¶çš„å½±å“æ›´å¤§ã€‚æ€»ä½“æ¥çœ‹ï¼Œæ–°çš„å­˜å‚¨ç³»ç»Ÿä¸­ CPU çš„ä½¿ç”¨ç‡æ¯”åŸæ¥å‡å°‘äº†ä¸‰åˆ°åå€ã€‚\n$$Disk \\space writes \\space in \\space MB/second$$\næˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™å¼ å›¾æ¸…æ¥šåœ°çœ‹åˆ° Prometheus 1.5 æ˜¯å¦‚ä½•å¯¼è‡´ SSD ç£¨æŸçš„ã€‚æ¯å½“ä¸€ä¸ª Chunk è¢«æŒä¹…åŒ–åˆ° Series å¯¹åº”çš„æ–‡ä»¶ä¸­ï¼Œæˆ–åˆ é™¤æ—§æ•°æ®å¹¶é‡å†™æ–‡ä»¶æ—¶ï¼Œç£ç›˜çš„å†™å…¥é€Ÿç‡å°±ä¼šå¤§å¹…ä¸Šå‡ã€‚è€Œ Prometheus 2.0 æ¯ç§’åªä¼šå‘é¢„å†™æ—¥å¿—ä¸­å†™å…¥çº¦ 1MB å­—èŠ‚ï¼Œå†™å…¥é€Ÿç‡åªæœ‰åœ¨ Block è¢«æŒä¹…åŒ–æ—¶æ‰ä¼šå‡ºç°å³°å€¼ã€‚æ–°çš„è®¾è®¡æ–¹æ¡ˆæˆåŠŸåœ°å‡å°‘äº†çº¦ 97%ï½99%çš„ç£ç›˜å†™å…¥ã€‚\n$$Disk \\space size \\space in \\space GB$$\nè™½ç„¶ä¸¤ä¸ªç‰ˆæœ¬çš„ Prometheus ä½¿ç”¨çš„å‹ç¼©ç®—æ³•è¿‘ä¹ç›¸åŒï¼Œä½† Series Churn çš„å­˜åœ¨å¯¼è‡´äº†ä¸¤è€…å ç”¨ç£ç›˜ç©ºé—´çš„å·¨å¤§å·®å¼‚ã€‚\n$$99th \\space percentile \\space query \\space latency \\space in \\space seconds$$\nåœ¨ Prometheus 1.5 ä¸­ï¼ŒæŸ¥è¯¢å»¶è¿Ÿéšç€ Series æ•°é‡çš„ä¸æ–­ä¸Šå‡è¶Šæ¥è¶Šé«˜ã€‚å½“æ•°æ®è¾¾åˆ°ä¿ç•™æœŸé™å¹¶å¼€å§‹åˆ é™¤æ—§çš„ Series æ—¶ï¼ŒæŸ¥è¯¢å»¶è¿Ÿä¾¿åˆä¼šè¶‹äºå¹³ç¨³ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒPrometheus 2.0 çš„æŸ¥è¯¢å»¶è¿Ÿä»ä¸€å¼€å§‹å°±ä¿æŒä¸å˜ã€‚\n$$Ingested \\space samples/second$$\nä¸¤ä¸ª Prometheus 2.0 å®ä¾‹çš„æ ·æœ¬é‡‡é›†ç‡å®Œå…¨å»åˆï¼Œå¹¶åœ¨æ•°å°æ—¶åå¼€å§‹å˜å¾—ä¸ç¨³å®šã€‚è¿™å¹¶éæ˜¯ Prometheus è‡ªèº«çš„é—®é¢˜ï¼Œè€Œæ˜¯é›†ç¾¤ä¸­èŠ‚ç‚¹çš„è´Ÿè½½è¿‡é«˜è€Œå¯¼è‡´çš„ã€‚å¯¹äº Prometheus 1.5ï¼Œå³ä½¿èŠ‚ç‚¹ä»æœ‰å¯ç”¨çš„ CPU å’Œå†…å­˜èµ„æºï¼Œå®ƒçš„æ ·æœ¬é‡‡é›†ç‡ä¹Ÿä¼šå›  Series Churn è€Œå¤§å¤§é™ä½ã€‚\nåŸºå‡†æµ‹è¯•çš„ç»“æœè¡¨æ˜ï¼ŒPrometheus 2.0 åœ¨äº‘æœåŠ¡å™¨ä¸Šçš„è¡¨ç°è¿œè¿œè¶…å‡ºäº†æœ€åˆè®¾è®¡æ—¶çš„é¢„æœŸã€‚ä¸è¿‡å…¶æˆåŠŸä¸å¦è¿˜æ˜¯è¦å–å†³äºç”¨æˆ·çš„åé¦ˆï¼Œè€ŒéåŸºå‡†æµ‹è¯•ä¸­çš„æ•°å­—ã€‚\næ€»ç»“ å¯¹äº Prometheus æ¥è¯´ï¼Œå¤„ç†å¤§è§„æ¨¡ Seriesï¼ˆå³ High Cardinalityï¼‰å’Œç‹¬ç«‹æ ·æœ¬çš„ååé‡æ˜¯ä¸€é¡¹é¢‡ä¸ºè‰°å·¨çš„ä»»åŠ¡ã€‚ä¸è¿‡ï¼Œæ–°çš„å­˜å‚¨ç³»ç»Ÿä¼¼ä¹å·²ç»å‡†å¤‡å¥½åº”å¯¹æœªæ¥çš„æŒ‘æˆ˜ã€‚\nä½¿ç”¨ V3 å­˜å‚¨ç³»ç»Ÿçš„ Prometheus 2.0 çš„ç¬¬ä¸€ä¸ª Alpha ç‰ˆæœ¬ å·²ç»å¯ä¾›æµ‹è¯•ï¼Œé¢„è®¡ä¼šå‡ºç°ä¸€äº›å´©æºƒã€æ­»é”å’Œå…¶ä»– Bugã€‚\nå­˜å‚¨ç³»ç»Ÿè‡ªèº«çš„ä»£ç å¯ä»¥åœ¨ä¸€ä¸ªç‹¬ç«‹çš„ é¡¹ç›® ä¸­æ‰¾åˆ°ã€‚å®ƒå…¶å®ä¸ Prometheus æ— å…³ï¼Œå› æ­¤å¯ä»¥å¹¿æ³›ç”¨äºå…¶ä»–éœ€è¦é«˜æ•ˆæœ¬åœ°å­˜å‚¨çš„æ—¶åºæ•°æ®åº“åº”ç”¨ä¸­ã€‚\nè¯‘è€…æ³¨ï¼šæœ¬æ–‡ä»å®è§‚çš„è§’åº¦ä»‹ç»äº† Prometheus éœ€è¦è§£å†³çš„é—®é¢˜ï¼Œä»¥åŠ 1.X ç‰ˆæœ¬ï¼ˆV2 å­˜å‚¨ç³»ç»Ÿï¼‰å’Œ 2.X ç‰ˆæœ¬ï¼ˆV3 å­˜å‚¨ç³»ç»Ÿï¼‰çš„è®¾è®¡ç†å¿µã€‚æƒ³è¦äº†è§£å…¶å®ç°ç»†èŠ‚ï¼Œé™¤äº†é˜…è¯»æºç å¤–è¿˜å¯ä»¥å‚è€ƒä»¥ä¸‹å†…å®¹ï¼š\nå…³äº Promtheus ä¸­çš„å†…å­˜æ•°æ®åº“ï¼šPrometheus TSDB (Part 1): The Head Blockï¼›\nå…³äºé¢„å†™æ—¥å¿—å’Œ Checkpointï¼šPrometheus TSDB (Part 2): WAL and Checkpointï¼›Write-Ahead Logï¼›\nå…³äº mmapï¼šPrometheus TSDB (Part 3): Memory Mapping of Head Chunks from Diskï¼›Why mmap is faster than system callsï¼›\nå…³äºç´¢å¼•ï¼šPrometheus TSDB (Part 4): Persistent Block and its Indexï¼›\nå…³äºæŸ¥è¯¢ï¼šPrometheus TSDB (Part 5): Queriesï¼›\nå…³äºå‹ç¼©å’Œä¿ç•™ï¼šPrometheus TSDB (Part 6): Compaction and Retentionï¼›Time-series compression algorithms, explainedï¼›\nä¸€äº›è§†é¢‘ï¼šPromCon 2017: Storing 16 Bytes at Scale - Fabian Reinartzï¼›æŠ€æœ¯åˆ†äº«ï¼šPrometheus æ˜¯æ€ä¹ˆå­˜å‚¨æ•°æ®çš„ï¼ˆé™ˆçš“ï¼‰ï¼›\n","description":"","tags":["Prometheus","TSDB"],"title":"ã€è¯‘ã€‘ä»é›¶å¼€å§‹ç¼–å†™ä¸€ä¸ªæ—¶åºæ•°æ®åº“","uri":"/posts/writing-a-time-series-database-from-scratch/"},{"content":"å‰è¨€ OpenShift 4.X ç‰ˆæœ¬è¦æ±‚å®‰è£…åœ¨æ“ä½œç³»ç»Ÿä¸º CoreOS çš„æœºå™¨ä¸Šï¼Œå› æ­¤ å®˜æ–¹æ–‡æ¡£ ç»™å‡ºäº†ä½¿ç”¨ PXE æˆ– IPXE å¼•å¯¼ CoreOS ç³»ç»Ÿçš„æ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥å‚è€ƒå…¶æ“ä½œæµç¨‹ï¼Œå°†ä¸€å° CentOS 7.X çš„æœºå™¨æ”¹å†™ä¸º CoreOS ç³»ç»Ÿï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š\nä» é•œåƒä¸‹è½½é¡µ ä¸‹è½½å®‰è£…æ‰€éœ€ç‰ˆæœ¬çš„ kernelã€initramfs å’Œ rootfs æ–‡ä»¶ï¼Œå¹¶å°† rootfs å’Œç‚¹ç«æ–‡ä»¶ï¼ˆ*.ignï¼‰ä¸Šä¼ åˆ°è‡ªå»ºçš„ HTTP æœåŠ¡å™¨ä¸Šï¼›\nå°† kernel å’Œ initramfs æ–‡ä»¶æ‹·è´åˆ° CentOS 7.X æœºå™¨çš„ /boot ç›®å½•ä¸‹ï¼›\næ ¹æ®éœ€æ±‚ä¿®æ”¹ /boot/grub2 ç›®å½•ä¸‹çš„ grub.cfg æ–‡ä»¶ï¼›\né‡å¯æœºå™¨ã€‚\nå¯¹äºæ“ä½œç³»ç»Ÿåˆå­¦è€…ï¼ˆæ¯”å¦‚æˆ‘ï¼‰æ¥è¯´ï¼Œå¾ˆéš¾æƒ³è±¡ä»…ä¾é æ·»åŠ å’Œä¿®æ”¹æ–‡ä»¶å°±èƒ½æ”¹å˜ä¸€å°è®¡ç®—æœºçš„æ“ä½œç³»ç»Ÿã€‚ä¸ºäº†è§£å…¶å®ç°åŸç†ï¼Œæˆ‘ä»¬å°†å¯¹ Linux çš„å¯åŠ¨æµç¨‹è¿›è¡Œè®¨è®ºï¼Œå¹¶ä»ä¸­è¯´æ˜ä¸Šè¿°æ“ä½œæ˜¯å¦‚ä½•å½±å“æ“ä½œç³»ç»Ÿçš„ã€‚\nLinux å¯åŠ¨æµç¨‹ å¯åŠ¨ä¸€å° Linux æœºå™¨çš„è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šBoot å’Œ Startupã€‚å…¶ä¸­ï¼ŒBoot èµ·å§‹äºè®¡ç®—æœºå¯åŠ¨ï¼Œåœ¨å†…æ ¸åˆå§‹åŒ–å®Œæˆä¸” systemd è¿›ç¨‹å¼€å§‹åŠ è½½åç»“æŸã€‚ç´§æ¥ç€ï¼Œ Startup æ¥ç®¡ä»»åŠ¡ï¼Œä½¿è®¡ç®—æœºè¾¾åˆ°ä¸€ä¸ªç”¨æˆ·å¯æ“ä½œçš„çŠ¶æ€ã€‚\nBoot é˜¶æ®µ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒBoot é˜¶æ®µåˆå¯ä»¥ç»†åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š\nBIOS POST Boot Loader å†…æ ¸åˆå§‹åŒ– BIOS POST å¼€æœºè‡ªæ£€ï¼ˆPower On Self Testï¼ŒPOSTï¼‰æ˜¯ åŸºæœ¬è¾“å…¥è¾“å‡ºç³»ç»Ÿï¼ˆBasic I/O Systemï¼ŒBIOSï¼‰çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯å¯åŠ¨ Linux æœºå™¨çš„ç¬¬ä¸€ä¸ªæ­¥éª¤ã€‚å…¶å·¥ä½œå¯¹è±¡æ˜¯è®¡ç®—æœºç¡¬ä»¶ï¼Œå› æ­¤å¯¹äºä»»ä½•æ“ä½œç³»ç»Ÿéƒ½æ˜¯ç›¸åŒçš„ã€‚POST æ£€æŸ¥ç¡¬ä»¶çš„åŸºæœ¬å¯æ“ä½œæ€§ï¼Œè‹¥å¤±è´¥åˆ™ Boot è¿‡ç¨‹å°†ä¼šè¢«ç»ˆæ­¢ã€‚\nPOST æ£€æŸ¥å®Œæ¯•åä¼šå‘å‡ºä¸€ä¸ª BIOS ä¸­æ–­è°ƒç”¨ INT 13Hï¼Œå®ƒå°†åœ¨ä»»ä½•å¯è¿æ¥ä¸”å¯å¼•å¯¼çš„ç£ç›˜ä¸Šæœç´¢å«æœ‰æœ‰æ•ˆå¼•å¯¼è®°å½•çš„å¼•å¯¼æ‰‡åŒºï¼ˆBoot Sectorï¼‰ï¼Œé€šå¸¸æ˜¯ ä¸»å¼•å¯¼æ‰‡åŒºã€‚å¼•å¯¼æ‰‡åŒºä¸­çš„ä¸»å¼•å¯¼è®°å½•ï¼ˆMaster Boot Recordï¼ŒMBRï¼‰å°†è¢«åŠ è½½åˆ° RAM ä¸­ï¼Œç„¶åæ§åˆ¶æƒå°±ä¼šè½¬ç§»åˆ°å…¶æ‰‹ä¸­ã€‚\nBoot Loader å¤§å¤šæ•° Linux å‘è¡Œç‰ˆä½¿ç”¨ä¸‰ç§ Boot Loader ç¨‹åºï¼šGRUB1ã€GRUB2 å’Œ LILOï¼Œå…¶ä¸­ GRUB2 æ˜¯æœ€æ–°ä¸”ä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„ã€‚GRUB2 ä»£è¡¨â€œGRand Unified Bootloader, version 2â€ï¼Œå®ƒèƒ½å¤Ÿå®šä½æ“ä½œç³»ç»Ÿå†…æ ¸å¹¶å°†å…¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚GRUB2 è¿˜å…è®¸ç”¨æˆ·é€‰æ‹©ä»å‡ ç§ä¸åŒçš„å†…æ ¸ä¸­å¼•å¯¼è®¡ç®—æœºï¼Œå¦‚æœæ›´æ–°çš„å†…æ ¸ç‰ˆæœ¬å‡ºç°å…¼å®¹æ€§é—®é¢˜ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¢å¤åˆ°å…ˆå‰å†…æ ¸ç‰ˆæœ¬ã€‚\nGRUB1 çš„å¼•å¯¼è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼šstage 1ã€stage 1.5 å’Œ stage 2ã€‚è™½ç„¶ GRUB2 ä¸­å¹¶æ²¡æœ‰ stage çš„æ¦‚å¿µï¼Œä½†ä¸¤è€…çš„å·¥ä½œæ–¹å¼åŸºæœ¬ç›¸åŒã€‚ä¸ºäº†æ–¹ä¾¿è¯´æ˜ï¼Œæˆ‘ä»¬åœ¨è®¨è®º GRUB2 æ—¶å°†æ²¿ç”¨ GRUB1 ä¸­ stage çš„è¯´æ³•ã€‚\nstage 1 ä¸Šæ–‡æåˆ°ï¼ŒBIOS ä¸­æ–­è°ƒç”¨ä¼šå®šä½ä¸»å¼•å¯¼æ‰‡åŒºï¼Œå…¶ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nä¸»å¼•å¯¼è®°å½•é¦–éƒ¨çš„å¼•å¯¼ä»£ç ä¾¿æ˜¯ stage 1 æ–‡ä»¶ boot.imgï¼Œå®ƒå’Œ stage 1.5 æ–‡ä»¶ core.img å‡ä½äº /boot/grub2/i386-pc ç›®å½•ä¸‹ï¼š\n1 2 3 [root@bastion ~]# du -b /boot/grub2/i386-pc/*.img 512 /boot/grub2/i386-pc/boot.img 26664 /boot/grub2/i386-pc/core.img å®ƒçš„ä½œç”¨æ˜¯æ£€æŸ¥åˆ†åŒºè¡¨æ˜¯å¦æ­£ç¡®ï¼Œç„¶åå®šä½å’ŒåŠ è½½ stage 1.5 æ–‡ä»¶ã€‚446 å­—èŠ‚çš„ boot.img æ”¾ä¸ä¸‹èƒ½å¤Ÿè¯†åˆ«æ–‡ä»¶ç³»ç»Ÿçš„ä»£ç ï¼Œåªèƒ½é€šè¿‡è®¡ç®—æ‰‡åŒºçš„åç§»é‡æ¥å¯»æ‰¾ï¼Œå› æ­¤ core.img å¿…é¡»ä½äºä¸»å¼•å¯¼è®°å½•å’Œé©±åŠ¨å™¨çš„ç¬¬ä¸€ä¸ªåˆ†åŒºï¼ˆPartitionï¼‰ä¹‹é—´ã€‚ç¬¬ä¸€ä¸ªåˆ†åŒºä»æ‰‡åŒº 63 å¼€å§‹ï¼Œä¸ä½äºæ‰‡åŒº 0 çš„ä¸»å¼•å¯¼è®°å½•ä¹‹é—´æœ‰ 62 ä¸ªæ‰‡åŒºï¼ˆæ¯ä¸ª 512 å­—èŠ‚ï¼‰ï¼Œæœ‰è¶³å¤Ÿçš„ç©ºé—´å­˜å‚¨å¤§å°ä¸è¶³ 30000 å­—èŠ‚çš„ core.img æ–‡ä»¶ã€‚å½“ core.img æ–‡ä»¶åŠ è½½åˆ° RAM åï¼Œæ§åˆ¶æƒä¹Ÿéšä¹‹è½¬ç§»ã€‚\nstage 1.5 ç›¸æ¯”äºåªèƒ½è¯»å–åŸå§‹æ‰‡åŒºçš„ LILOï¼ŒGRUB1 å’Œ GRUB2 å‡å¯è¯†åˆ«æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™ä¾èµ–äº stage 1.5 æ–‡ä»¶ä¸­å†…ç½®çš„æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨ç¨‹åºã€‚å¦‚æœä½ æ‹¥æœ‰ä¸€å°ä»ç„¶ä½¿ç”¨ GRUB1 å¼•å¯¼çš„ CentOS 6.X æœºå™¨ï¼Œé‚£ä¹ˆä¾¿å¯ä»¥åœ¨ /boot/grub/ ç›®å½•ä¸‹æ‰¾åˆ°è¿™äº›é€‚é…ä¸åŒæ–‡ä»¶ç³»ç»Ÿçš„ stage 1.5 æ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 [root@centos6.5 ~]# du -b /boot/grub/* | grep stage1_5 13380 /boot/grub/e2fs_stage1_5 12620 /boot/grub/fat_stage1_5 11748 /boot/grub/ffs_stage1_5 11756 /boot/grub/iso9660_stage1_5 13268 /boot/grub/jfs_stage1_5 11956 /boot/grub/minix_stage1_5 14412 /boot/grub/reiserfs_stage1_5 12024 /boot/grub/ufs2_stage1_5 11364 /boot/grub/vstafs_stage1_5 13964 /boot/grub/xfs_stage1_5 GRUB2 ä¸­çš„ core.img ä¸ä»…æ•´åˆäº†ä¸Šè¿°æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨ï¼Œè¿˜æ–°å¢äº†èœå•å¤„ç†ç­‰æ¨¡å—ï¼Œè¿™ä¹Ÿæ˜¯å…¶ä¼˜äº GRUB1 çš„åœ°æ–¹ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ GNU GRUB Manual 2.06: Images ä¸­æ‰¾åˆ°å¯¹å„ç§ GRUB é•œåƒæ–‡ä»¶çš„è¯¦ç»†ä»‹ç»ã€‚\næ—¢ç„¶ core.img æ–‡ä»¶å¯ä»¥è¯†åˆ«æ–‡ä»¶ç³»ç»Ÿï¼Œé‚£ä¹ˆå®ƒå°±èƒ½å¤Ÿæ ¹æ®å®‰è£…æ—¶ç¡®å®šçš„ç³»ç»Ÿè·¯å¾„å®šä½å’ŒåŠ è½½ stage 2 æ–‡ä»¶ã€‚åŒæ ·ï¼Œå½“ stage 2 æ–‡ä»¶åŠ è½½åˆ° RAM åï¼Œæ§åˆ¶æƒä¹Ÿéšä¹‹è½¬ç§»ã€‚\nstage 2 stage 2 æ–‡ä»¶å¹¶éæ˜¯ä¸€ä¸ª .img çš„é•œåƒï¼Œè€Œæ˜¯ä¸€äº›è¿è¡Œæ—¶å†…æ ¸æ¨¡å—ï¼š\n1 2 3 4 5 6 7 8 9 10 11 [root@bastion ~]# ls /boot/grub2/i386-pc/ | grep .mod | head acpi.mod adler32.mod affs.mod afs.mod ahci.mod all_video.mod aout.mod appendedsig.mod appended_signature_test.mod archelp.mod å®ƒä»¬çš„ä»»åŠ¡æ˜¯æ ¹æ® grub.cfg æ–‡ä»¶çš„é…ç½®å®šä½å’ŒåŠ è½½å†…æ ¸æ–‡ä»¶ï¼Œç„¶åå°†æ§åˆ¶æƒè½¬äº¤ç»™ Linux å†…æ ¸ã€‚grub.cfg æ–‡ä»¶å­˜æ”¾åœ¨ /boot/grub2 ç›®å½•ä¸‹ï¼š\n1 2 3 4 5 6 [root@bastion ~]# head /boot/grub2/grub.cfg -n 5 # # DO NOT EDIT THIS FILE # # It is automatically generated by grub2-mkconfig using templates # from /etc/grub.d and settings from /etc/default/grub é€šè¿‡è¯¥æ–‡ä»¶çš„æ³¨é‡Šæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå®ƒå®é™…ä¸Šæ˜¯ç”± grub2-mkconfig å‘½ä»¤ä½¿ç”¨ /etc/grub.d ç›®å½•ä¸‹çš„ä¸€äº›æ¨¡æ¿æ–‡ä»¶å¹¶æ ¹æ® /etc/default/grub æ–‡ä»¶ä¸­çš„è®¾ç½®ç”Ÿæˆçš„ï¼š\n1 2 [root@bastion ~]# ls /etc/grub.d/ 00_header 00_tuned 01_users 10_linux 20_linux_xen 20_ppc_terminfo 30_os-prober 40_custom 41_custom README 40_custom å’Œ 41_custom æ–‡ä»¶å¸¸ç”¨äºç”¨æˆ·å¯¹ GRUB2 é…ç½®çš„ä¿®æ”¹ï¼Œå®é™…ä¸Šæˆ‘ä»¬å¯¹æœºå™¨çš„æ“ä½œä¹Ÿæ˜¯ä»è¿™é‡Œå¼€å§‹çš„ã€‚ä¸ºäº†è®© GRUB2 åœ¨æœºå™¨å¯åŠ¨æ—¶é€‰æ‹© CoreOS ç³»ç»Ÿå†…æ ¸è€Œéé»˜è®¤çš„ CentOSï¼Œéœ€è¦åœ¨åŸå§‹ 40_custom æ–‡ä»¶æœ«å°¾æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š\n1 2 3 4 5 menuentry 'coreos' { set root='hd0,msdos1' linux16 /rhcos-live-kernel-x86_64 coreos.inst=yes coreos.inst.install_dev=vda rd.neednet=1 console=tty0 console=ttyS0 coreos.live.rootfs_url=http://{{HTTP-Server-Path}}/rhcos-live-rootfs.x86_64.img coreos.inst.ignition_url=http://{{HTTP-Server-Path}}/master.ign ip=dhcp initrd16 /rhcos-live-initramfs.x86_64.img } æ‰€ç¤ºçš„ Menuentry ç”±ä¸‰æ¡ Shell å‘½ä»¤ç»„æˆï¼š\nset root='hd0,msdos1' linux16 /rhcos-live-kernel-x86_64 ... initrd16 /rhcos-live-initramfs.x86_64.img ç¬¬ä¸€æ¡å‘½ä»¤æŒ‡å®šäº† GRUB2 çš„æ ¹ç›®å½•ï¼Œä¹Ÿå°±æ˜¯ /boot æ‰€åœ¨åˆ†åŒºåœ¨è®¡ç®—æœºç¡¬ä»¶ä¸Šçš„ä½ç½®ã€‚æ—¢ç„¶æˆ‘ä»¬å·²ç»å°†å†…æ ¸æ–‡ä»¶æ‹·è´åˆ°äº† /boot ç›®å½•ä¸‹ï¼Œé‚£ä¹ˆèƒ½å¤Ÿè¯†åˆ«æ–‡ä»¶ç³»ç»Ÿçš„ GRUB2 ä¾¿å¯ä»¥å®šä½å’ŒåŠ è½½å®ƒã€‚æœ¬ä¾‹ä¸­hdä»£è¡¨ç¡¬ç›˜ï¼ˆHard Driveï¼‰ï¼Œ0ä»£è¡¨ç¬¬ä¸€å—ç¡¬ç›˜ï¼Œmosdosä»£è¡¨åˆ†åŒºæ ¼å¼ï¼Œ1ä»£è¡¨ç¬¬ä¸€ä¸ªåˆ†åŒºã€‚è¯¦ç»†çš„ç¡¬ä»¶å‘½åè§„èŒƒè§ Naming Conventionã€‚\nç¬¬äºŒæ¡å‘½ä»¤å°†ä»rhcos-live-kernel-x86_64ï¼ˆCoreOS ç³»ç»Ÿçš„å†…æ ¸æ–‡ä»¶ï¼‰ä¸­ä»¥ 16 ä½æ¨¡å¼åŠ è½½ Linux å†…æ ¸æ˜ åƒï¼Œå¹¶é€šè¿‡coreos.live.rootfs_urlå’Œcoreos.inst.ignition_urlå‚æ•°æŒ‡å®šæ ¹æ–‡ä»¶ç³»ç»Ÿï¼ˆRootfsï¼‰çš„é•œåƒæ–‡ä»¶å’Œç‚¹ç«æ–‡ä»¶çš„ä¸‹è½½é“¾æ¥ã€‚ip=dhcpä»£è¡¨è¯¥è®¡ç®—æœºç½‘ç»œå°†ç”± DHCP æœåŠ¡å™¨åŠ¨æ€é…ç½®ï¼Œä¹Ÿå¯ä»¥æŒ‰ip={{HostIP}}::{{Gateway}}:{{Genmask}}:{{Hostname}}::none nameserver={{DNSServer}}çš„æ ¼å¼å†™å…¥é™æ€é…ç½®ã€‚\nç¬¬ä¸‰æ¡å‘½ä»¤å°†ä»rhcos-live-initramfs.x86_64.imgä¸­åŠ è½½ RAM Filesystemã€‚GRUB2 è¯»å–çš„å†…æ ¸æ–‡ä»¶å®é™…ä¸ŠåªåŒ…å«äº†å†…æ ¸çš„æ ¸å¿ƒæ¨¡å—ï¼Œç¼ºå°‘ç¡¬ä»¶é©±åŠ¨æ¨¡å—çš„å®ƒæ— æ³•å®Œæˆ rootfs çš„æŒ‚è½½ã€‚ç„¶è€Œè¿™äº›ç¡¬ä»¶é©±åŠ¨æ¨¡å—ä½äº /lib/modules/$(uname -r)/kernel/ ç›®å½•ä¸‹ï¼Œå¿…é¡»åœ¨ rootfs æŒ‚è½½å®Œæ¯•åæ‰èƒ½è¢«è¯†åˆ«å’ŒåŠ è½½ã€‚ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼Œinitramfsï¼ˆå‰èº«ä¸º initrdï¼‰åº”è¿è€Œç”Ÿã€‚å®ƒæ˜¯ä¸€ä¸ªåŒ…å«äº†å¿…è¦é©±åŠ¨æ¨¡å—çš„ä¸´æ—¶ rootfsï¼Œå†…æ ¸å¯ä»¥ä»ä¸­åŠ è½½æ‰€éœ€çš„é©±åŠ¨ç¨‹åºã€‚å¾…çœŸæ­£çš„ rootfs æŒ‚è½½å®Œæ¯•åï¼Œå®ƒä¾¿ä¼šä»å†…å­˜ä¸­ç§»é™¤ã€‚\né™¤æ­¤ä¹‹å¤–æˆ‘ä»¬è¿˜éœ€è¦å°† /etc/default/grub æ–‡ä»¶ä¸­çš„ GRUB_DEFAULT=saved ä¿®æ”¹ä¸º GRUB_DEFAULT=â€œcoreosâ€ï¼Œä½¿å…¶ä¸ 40_custom æ–‡ä»¶ä¸­çš„menuentry 'coreos'å¯¹åº”ã€‚æœ€åä½¿ç”¨å‘½ä»¤grub2-mkconfig -o /boot/grub2/grub.cfgæ¥é‡æ–°ç”Ÿæˆä¸€ä»½ grub.cfg æ–‡ä»¶ï¼Œè¿™æ ·è®¡ç®—æœºé‡å¯å GRUB2 å°±ä¼šæ ¹æ®æˆ‘ä»¬çš„é…ç½®å»åŠ è½½ CoreOS ç³»ç»Ÿçš„å†…æ ¸äº†ã€‚\nè‡³æ­¤æˆ‘ä»¬å·²ç»æ˜ç™½äº†ä¸ºä»€ä¹ˆâ€œä»…ä¾é æ·»åŠ å’Œä¿®æ”¹æ–‡ä»¶å°±èƒ½æ”¹å˜ä¸€å°è®¡ç®—æœºçš„æ“ä½œç³»ç»Ÿâ€ï¼Œä½†è®¡ç®—æœºæƒ³è¦è¾¾åˆ°ç”¨æˆ·å¯æ“ä½œçŠ¶æ€è¿˜è¿œä¸æ­¢äºæ­¤ã€‚è®©æˆ‘ä»¬å†æ¥çœ‹çœ‹å†…æ ¸è¢«åŠ è½½åˆ°å†…å­˜åå‘ç”Ÿäº†ä»€ä¹ˆã€‚\nå†…æ ¸åˆå§‹åŒ– ä¸åŒå†…æ ¸åŠå…¶ç›¸å…³æ–‡ä»¶ä½äº /boot ç›®å½•ä¸­ï¼Œå‡ä»¥ vmlinuz å¼€å¤´ï¼š\n1 2 3 4 [root@bastion ~]# ls /boot/ | grep vmlinuz vmlinuz-0-rescue-20210623110808105647395700239158 vmlinuz-4.18.0-305.12.1.el8_4.x86_64 vmlinuz-4.18.0-305.3.1.el8.x86_64 å†…æ ¸é€šè¿‡å‹ç¼©è‡ªèº«æ¥èŠ‚çœå­˜å‚¨ç©ºé—´ï¼Œæ‰€ä»¥å½“é€‰å®šçš„å†…æ ¸è¢«åŠ è½½åˆ°å†…å­˜ä¸­åï¼Œå®ƒé¦–å…ˆéœ€è¦è¿›è¡Œè§£å‹ç¼©ï¼ˆExtractingï¼‰ã€‚ä¸€æ—¦è§£å‹å®Œæˆï¼Œå†…æ ¸ä¾¿ä¼šå¼€å§‹åŠ è½½ systemd å¹¶å°†æ§åˆ¶æƒç§»äº¤ç»™å®ƒã€‚\nStartup é˜¶æ®µ systemd æ˜¯æ‰€æœ‰è¿›ç¨‹ä¹‹çˆ¶ï¼Œå®ƒè´Ÿè´£ä½¿è®¡ç®—æœºè¾¾åˆ°å¯ä»¥å®Œæˆç”Ÿäº§å·¥ä½œçš„çŠ¶æ€ã€‚å…¶åŠŸèƒ½æ¯”è¿‡å»çš„ init ç¨‹åºè¦ä¸°å¯Œå¾—å¤šï¼ŒåŒ…æ‹¬æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿã€å¯åŠ¨å’Œç®¡ç†è®¡ç®—æœºæ‰€éœ€çš„ç³»ç»ŸæœåŠ¡ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥å°†ä¸€äº›åº”ç”¨ï¼ˆå¦‚ Dockerï¼‰ä»¥ systemd çš„æ–¹å¼å¯åŠ¨ï¼Œä½†å®ƒä»¬ä¸ Linux çš„å¯åŠ¨æ— å…³ï¼Œå› æ­¤ä¸åœ¨æœ¬æ–‡çš„è®¨è®ºèŒƒå›´ä¹‹å†…ã€‚\né¦–å…ˆï¼Œsystemd æ ¹æ® /etc/fstab æ–‡ä»¶ä¸­çš„é…ç½®æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿã€‚ç„¶åè¯»å– /etc ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…æ‹¬å…¶è‡ªèº«çš„é…ç½®æ–‡ä»¶ /etc/systemd/system/default.targetã€‚è¯¥æ–‡ä»¶æŒ‡å®šäº† systemd éœ€è¦å¼•å¯¼è®¡ç®—æœºåˆ°è¾¾çš„æœ€ç»ˆç›®æ ‡å’ŒçŠ¶æ€ï¼Œå®é™…ä¸Šæ˜¯ä¸€ä¸ªè½¯é“¾æ¥ï¼š\n1 2 [root@bastion ~]# ls /etc/systemd/system/default.target -l lrwxrwxrwx. 1 root root 37 Oct 17 2019 /etc/systemd/system/default.target -\u003e /lib/systemd/system/multi-user.target åœ¨æˆ‘ä½¿ç”¨çš„ bastion æœåŠ¡å™¨ä¸Šï¼Œå®ƒæŒ‡å‘çš„æ˜¯ multi-user.targetï¼›å¯¹äºå¸¦æœ‰å›¾å½¢åŒ–ç•Œé¢çš„æ¡Œé¢å·¥ä½œç«™ï¼Œå®ƒé€šå¸¸æŒ‡å‘ graphics.targetï¼›è€Œå¯¹äºå•ç”¨æˆ·æ¨¡å¼çš„æœºå™¨ï¼Œå®ƒå°†æŒ‡å‘ emergency.targetã€‚target ç­‰æ•ˆäºè¿‡å» SystemV ä¸­çš„ è¿è¡Œçº§åˆ«ï¼ˆRunlevelï¼‰ï¼Œå®ƒæä¾›äº†åˆ«åä»¥å®ç°å‘åå…¼å®¹æ€§ï¼š\nSystemV Runlevel systemd target systemd target alias Description halt.target åœ¨ä¸å…³é—­ç”µæºçš„æƒ…å†µä¸‹ä¸­æ­¢ç³»ç»Ÿã€‚ 0 poweroff.target runlevel0.target ä¸­æ­¢ç³»ç»Ÿå¹¶å…³é—­ç”µæºã€‚ s emergency.target å•ç”¨æˆ·æ¨¡å¼ã€‚ æ²¡æœ‰æœåŠ¡æ­£åœ¨è¿è¡Œï¼Œä¹ŸæœªæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿã€‚ä»…åœ¨ä¸»æ§åˆ¶å°ä¸Šè¿è¡Œä¸€ä¸ªç´§æ€¥ Shellï¼Œä¾›ç”¨æˆ·ä¸ç³»ç»Ÿäº¤äº’ã€‚ 1 rescue.target runlevel1.target ä¸€ä¸ªåŸºæœ¬ç³»ç»Ÿã€‚æ–‡ä»¶ç³»ç»Ÿå·²æŒ‚è½½ï¼Œåªè¿è¡Œæœ€åŸºæœ¬çš„æœåŠ¡å’Œä¸»æ§åˆ¶å°ä¸Šçš„ç´§æ€¥ Shellã€‚ 2 runlevel2.target å¤šç”¨æˆ·æ¨¡å¼ã€‚è™½ç„¶è¿˜æ²¡æœ‰ç½‘ç»œè¿æ¥ï¼Œä½†ä¸ä¾èµ–ç½‘ç»œçš„æ‰€æœ‰é GUI æœåŠ¡éƒ½å·²è¿è¡Œã€‚ 3 multi-user.target runlevel3.target æ‰€æœ‰æœåŠ¡éƒ½åœ¨è¿è¡Œï¼Œä½†åªèƒ½ä½¿ç”¨å‘½ä»¤è¡Œç•Œé¢ï¼ˆCLIï¼‰ã€‚ 4 runlevel4.target ç”¨æˆ·è‡ªå®šä¹‰ 5 graphical.target runlevel5.target æ‰€æœ‰æœåŠ¡éƒ½åœ¨è¿è¡Œï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨å›¾å½¢åŒ–ç•Œé¢ï¼ˆGUIï¼‰ã€‚ 6 reboot.target runlevel6.target é‡å¯ç³»ç»Ÿ æ¯ä¸ª target éƒ½åœ¨å…¶é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šäº†ä¸€ç»„ä¾èµ–ï¼Œç”± systemd è´Ÿè´£å¯åŠ¨ã€‚è¿™äº›ä¾èµ–æ˜¯ Linux è¾¾åˆ°æŸä¸ªè¿è¡Œçº§åˆ«æ‰€å¿…é¡»çš„æœåŠ¡ï¼ˆServiceï¼‰ã€‚æ¢å¥è¯è¯´ï¼Œå½“ä¸€ä¸ª target é…ç½®æ–‡ä»¶ä¸­çš„æ‰€æœ‰ service éƒ½å·²æˆåŠŸåŠ è½½ï¼Œé‚£ä¹ˆç³»ç»Ÿå°±è¾¾åˆ°äº†è¯¥ target å¯¹åº”çš„è¿è¡Œçº§åˆ«ã€‚\nä¸‹å›¾å±•ç¤ºäº† systemd å¯åŠ¨è¿‡ç¨‹ä¸­å„ target å’Œ service å®ç°çš„ä¸€èˆ¬é¡ºåºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 cryptsetup-pre.target veritysetup-pre.target | (various low-level v API VFS mounts: (various cryptsetup/veritysetup devices...) mqueue, configfs, | | debugfs, ...) v | | cryptsetup.target | | (various swap | | remote-fs-pre.target | devices...) | | | | | | | | | v | v local-fs-pre.target | | | (network file systems) | swap.target | | v v | | | v | remote-cryptsetup.target | | | (various low-level (various mounts and | remote-veritysetup.target | | | services: udevd, fsck services...) | | remote-fs.target | | tmpfiles, random | | | / | | seed, sysctl, ...) v | | / | | | local-fs.target | | / | | | | | | / \\____|______|_______________ ______|___________/ | / \\ / | / v | / sysinit.target | / | | / ______________________/|\\_____________________ | / / | | | \\ | / | | | | | | / v v | v | | / (various (various | (various | |/ timers...) paths...) | sockets...) | | | | | | | | v v | v | | timers.target paths.target | sockets.target | | | | | | v | v \\_______ | _____/ rescue.service | \\|/ | | v v | basic.target rescue.target | | | ________v____________________ | / | \\ | | | | | v v v | display- (various system (various system | manager.service services services) | | required for | | | graphical UIs) v v | | multi-user.target emergency.service | | | | \\_____________ | _____________/ v \\|/ emergency.target v graphical.target å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæƒ³è¦åˆ°è¾¾åˆ°æŸä¸ª targetï¼Œå…¶ä¾èµ–çš„æ‰€æœ‰ target å’Œ service å°±å¿…é¡»å·²å®ŒæˆåŠ è½½ã€‚å¦‚å®ç° sysinit.targetï¼Œéœ€è¦å…ˆæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿï¼ˆlocal-fs.targetï¼‰ã€è®¾ç½®äº¤æ¢æ–‡ä»¶ï¼ˆswap.targetï¼‰ã€åˆå§‹åŒ– udev ï¼ˆvarious low-level servicesï¼‰å’Œè®¾ç½®åŠ å¯†æœåŠ¡ï¼ˆcryptsetup.targetï¼‰ç­‰ã€‚ä¸è¿‡ï¼ŒåŒä¸€ä¸ª target çš„ä¸åŒä¾èµ–é¡¹å¯ä»¥å¹¶è¡Œæ‰§è¡Œã€‚\nå½“è®¡ç®—æœºè¾¾åˆ° multi-user.target æˆ– graphical.target æ—¶ï¼Œå®ƒçš„æ¼«æ¼«å¯åŠ¨ä¹‹è·¯å°±èµ°åˆ°äº†å°½å¤´ã€‚ä½†ä¸ºäº†æ»¡è¶³ç”¨æˆ·å¤šæ ·çš„éœ€æ±‚ï¼Œå®ƒæ‰€é¢ä¸´çš„æŒ‘æˆ˜å…¶å®æ‰åˆšåˆšå¼€å§‹ã€‚\nFuture Work å‰è¨€æåˆ° RedHat å®˜æ–¹ç»™å‡ºäº† IPXE/PXE å¼•å¯¼ CoreOS ç³»ç»Ÿçš„æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™é¡¹æŠ€æœ¯åˆæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ MBR åªæœ‰ 446 ä¸ªå­—èŠ‚ï¼Œå¯ä¸ºä»€ä¹ˆ boot.img æ–‡ä»¶å´æœ‰ 512 ä¸ªå­—èŠ‚ï¼Ÿ ç›®å‰å·²ç»æœ‰è¶Šæ¥è¶Šå¤šçš„è®¡ç®—æœºä½¿ç”¨ UEFI å’Œ GPT æ¥ä»£æ›¿ BIOS å’Œ MBRï¼Œå…¶ä¼˜åŠ¿ä½“ç°åœ¨å“ªï¼Ÿ æˆ‘ä»¬è¯¥å¦‚ä½•ç†è§£ systemd çš„é…ç½®æ–‡ä»¶ï¼Ÿå¦‚ä½•ä½¿ç”¨ systemd éƒ¨ç½²æˆ‘ä»¬çš„åº”ç”¨ï¼Ÿ å‚è€ƒæ–‡çŒ® Creating Red Hat Enterprise Linux CoreOS (RHCOS) machines by PXE or iPXE Booting\nBIOS - Wikipedia\nINT 13H - Wikipedia\nä¸»å¼•å¯¼è®°å½• - Wikipedia\nAn Introduction To the Linux Boot and Startup Processes\nGNU GRUB Manual 2.06\nBootup(7) - Linux manual page\n","description":"","tags":["OS","Linux","CoreOs"],"title":"é€šè¿‡å®‰è£… CoreOS ç³»ç»Ÿäº†è§£ Linux å¯åŠ¨æµç¨‹","uri":"/posts/understand-linux-boot-process-by-installing-coreos/"},{"content":"åœ¨ä½¿ç”¨é«˜çº§è¯­è¨€ï¼Œå¦‚ Cã€Java ç¼–ç¨‹æ—¶ï¼Œæˆ‘ä»¬æ— æ³•äº†è§£ç¨‹åºåœ¨æœºå™¨çº§åˆ«çš„å®ç°ã€‚è€Œä½¿ç”¨æ±‡ç¼–è¯­è¨€ç¼–å†™ç¨‹åºæ—¶ï¼Œç¨‹åºå‘˜åˆ™åªèƒ½å¼•ç”¨ä½çº§æŒ‡ä»¤ã€‚ç”±é«˜çº§è¯­è¨€ç¼–å†™çš„ç¨‹åºå¯ä»¥åœ¨å¤šç§ä¸åŒçš„æœºå™¨ä¸Šç¼–è¯‘è¿è¡Œï¼Œè€Œæ±‡ç¼–è¯­è¨€åˆ™ä¸æœºå™¨ç‰¹æ€§é«˜åº¦ç›¸å…³ã€‚\nå°½ç®¡ç¼–è¯‘å™¨å®Œæˆäº†ç”Ÿæˆæ±‡ç¼–ä»£ç çš„å¤§éƒ¨åˆ†å·¥ä½œï¼Œä½†é˜…è¯»å’Œç†è§£æ±‡ç¼–è¯­è¨€å¯¹äºç¨‹åºå‘˜æ¥è¯´ä»æ˜¯ä¸€é¡¹é‡è¦çš„æŠ€èƒ½ï¼š\nThose who say â€œI understand the general principles, I donâ€™t want to bother learning the detailsâ€ are deluding themselves.\nIntel å¤„ç†å™¨å†å² ç¨‹åºç¼–ç  æœºå™¨çº§ä»£ç  æœºå™¨çº§ç¨‹åºçš„æ ¼å¼å’Œè¡Œä¸ºæ˜¯ç”±æŒ‡ä»¤é›†æ¶æ„ï¼ˆInstruction Set Architectureï¼ŒISAï¼‰å®šä¹‰çš„ï¼Œå®ƒåŒ…æ‹¬å¤„ç†å™¨çŠ¶æ€ã€æŒ‡ä»¤æ ¼å¼ä»¥åŠæ¯æ¡æŒ‡ä»¤å¯¹çŠ¶æ€çš„å½±å“ã€‚å¤§å¤šæ•° ISAï¼ŒåŒ…æ‹¬ x86-64ï¼Œéƒ½å°†ç¨‹åºçš„è¡Œä¸ºæè¿°ä¸ºæ¯æ¡æŒ‡ä»¤æŒ‰é¡ºåºæ‰§è¡Œï¼Œä¸”ä¸€æ¡æŒ‡ä»¤åœ¨ä¸‹ä¸€æ¡æŒ‡ä»¤å¼€å§‹ä¹‹å‰å®Œæˆã€‚è™½ç„¶å¤„ç†å™¨ç¡¬ä»¶å¯ä»¥åŒæ—¶æ‰§è¡Œè®¸å¤šæŒ‡ä»¤ï¼Œä½†å®ƒé‡‡ç”¨äº†å®‰å…¨æªæ–½ä»¥ç¡®ä¿å…¶æ•´ä½“è¡Œä¸ºä¸ ISA è§„å®šçš„æ“ä½œé¡ºåºç›¸åŒ¹é…ã€‚\næ±‡ç¼–ä»£ç éå¸¸æ¥è¿‘äºŒè¿›åˆ¶æ ¼å¼çš„æœºå™¨ä»£ç ï¼Œä½†å…¶æ–‡æœ¬æ ¼å¼æ›´å…·å¯è¯»æ€§ã€‚ä¸€äº›å¯¹ç¨‹åºå‘˜éšè—çš„å¤„ç†å™¨çŠ¶æ€åœ¨æ±‡ç¼–ä»£ç ä¸­æ˜¯å¯è§çš„ï¼š\nç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰ï¼šåœ¨ x86-64 ä¸­è¢«ç§°ä¸º %ripï¼Œä»£è¡¨å³å°†æ‰§è¡Œçš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ¨å­˜å‚¨å™¨ä¸­çš„åœ°å€ï¼› æ•´æ•°å¯„å­˜å™¨æ–‡ä»¶ï¼ˆRegister Fileï¼‰ï¼šæœ€å¤šå¯ä»¥å­˜å‚¨ 64 ä½çš„åœ°å€ï¼ˆä¸ C ä¸­çš„æŒ‡é’ˆå¯¹åº”ï¼‰æˆ–æ•´æ•°æ•°æ®ã€‚ä¸€äº›å¯„å­˜å™¨ç”¨äºè®°å½•ç¨‹åºçŠ¶æ€çš„å…³é”®éƒ¨åˆ†ï¼Œè€Œå…¶ä»–å¯„å­˜å™¨åˆ™ç”¨äºä¿å­˜ä¸´æ—¶æ•°æ®ï¼Œä¾‹å¦‚ è¿‡ç¨‹ ä¸­çš„å‚æ•°å’Œå±€éƒ¨å˜é‡ä»¥åŠå‡½æ•°è¿”å›å€¼ï¼› æ¡ä»¶ç å¯„å­˜å™¨ï¼ˆCondition Code Registersï¼‰ï¼šä¿å­˜äº†æœ€è¿‘ä¸€æ¬¡æ‰§è¡Œçš„ç®—æœ¯æˆ–é€»è¾‘æŒ‡ä»¤çš„çŠ¶æ€ä¿¡æ¯ï¼Œç”¨äºå®ç°æ§åˆ¶æµæˆ–æ•°æ®æµä¸­æ¡ä»¶çš„æ”¹å˜ï¼Œä¾‹å¦‚ If è¯­å¥å’Œ While è¯­å¥ï¼› å‘é‡å¯„å­˜å™¨ï¼ˆVector Registersï¼‰ï¼šæ¯ä¸ªéƒ½å¯ä»¥ä¿å­˜ä¸€ä¸ªæˆ–å¤šä¸ªæ•´æ•°æˆ–æµ®ç‚¹æ•°å€¼ã€‚ è™½ç„¶ C æä¾›äº†ä¸€ä¸ªæ¨¡å‹ï¼Œè®©æˆ‘ä»¬å¯ä»¥åœ¨å†…å­˜ä¸­å£°æ˜å’Œåˆ†é…ä¸åŒæ•°æ®ç±»å‹çš„å¯¹è±¡ã€‚ä½†æœºå™¨çº§ä»£ç åªä¼šç®€å•åœ°å°†å†…å­˜è§†ä¸ºä¸€ä¸ªæŒ‰å­—èŠ‚å¯»å€çš„æ•°ç»„ï¼Œå› æ­¤ C ä¸­çš„èšåˆæ•°æ®ç±»å‹ï¼ˆå¦‚æ•°ç»„å’Œç»“æ„ä½“ï¼‰åœ¨æœºå™¨çº§ä»£ç ä¸­ä¼šè¡¨ç¤ºä¸ºè¿ç»­çš„å­—èŠ‚é›†åˆã€‚ç”šè‡³å¯¹äºæ ‡é‡æ•°æ®ç±»å‹ï¼ˆå¦‚intã€charã€floatå’Œboolç­‰ï¼‰ï¼Œæ±‡ç¼–ä»£ç ä¹Ÿä¸ä¼šåŒºåˆ†æœ‰ç¬¦å·å’Œæ— ç¬¦å·æ•´æ•°ã€ä¸åŒç±»å‹çš„æŒ‡é’ˆä»¥åŠæŒ‡é’ˆå’Œæ•´æ•°ã€‚\nç¨‹åºçš„å¯æ‰§è¡Œæœºå™¨çº§ä»£ç ã€æ“ä½œç³»ç»Ÿæ‰€éœ€çš„ä¸€äº›ä¿¡æ¯ã€ç”¨äºç®¡ç†è¿‡ç¨‹è°ƒç”¨å’Œè¿”å›çš„è¿è¡Œæ—¶æ ˆä»¥åŠç”¨æˆ·è¯·æ±‚çš„å †å†…å­˜ï¼ˆå¦‚ä½¿ç”¨åº“å‡½æ•°mallocï¼‰å…±åŒæ„æˆäº†ç¨‹åºå†…å­˜ã€‚å®ƒä½¿ç”¨è™šæ‹Ÿåœ°å€å¯»å€ï¼Œä¸è¿‡åªæœ‰éƒ¨åˆ†è™šæ‹Ÿåœ°å€çš„èŒƒå›´æœ‰æ•ˆã€‚ä¾‹å¦‚ï¼Œx86-64 æœºå™¨çš„è™šæ‹Ÿåœ°å€å¿…é¡»å°†å‰ 16 ä½è®¾ç½®ä¸º 0ï¼Œå› æ­¤å…¶æœ‰æ•ˆèŒƒå›´åŒ…å« $2^{48}$ ï¼ˆ64 TBï¼‰å­—èŠ‚ã€‚\nå•ä¸ªæœºå™¨æŒ‡ä»¤ä»…æ‰§è¡Œä¸€äº›åŸºæœ¬çš„æ“ä½œï¼Œå¦‚å°†å­˜å‚¨åœ¨å¯„å­˜å™¨ä¸­çš„ä¸¤ä¸ªæ•°å­—ç›¸åŠ ã€åœ¨å†…å­˜å’Œå¯„å­˜å™¨ä¹‹é—´ä¼ è¾“æ•°æ®ä»¥åŠæœ‰æ¡ä»¶åœ°è·³è½¬åˆ°æ–°çš„æŒ‡ä»¤åœ°å€ã€‚ç¼–è¯‘å™¨å¿…é¡»ç”Ÿæˆè¿™æ ·çš„æŒ‡ä»¤åºåˆ—æ¥å®ç°ç¨‹åºç»“æ„ï¼Œä¾‹å¦‚ç®—æœ¯è¡¨è¾¾å¼æ±‚å€¼ã€å¾ªç¯æˆ–è¿‡ç¨‹è°ƒç”¨å’Œè¿”å›ã€‚\nä»£ç ç¤ºä¾‹ ç¤ºä¾‹ C ç¨‹åºæ–‡ä»¶mstore.cä¸­åŒ…å«å¦‚ä¸‹ä»£ç ï¼š\n1 2 3 4 5 long mult2(long, long); void multstore(long x, long y, long *dest) { long t = mult2(x, y); *dest = t; } ä½¿ç”¨gcc -Og -S mstore.cå‘½ä»¤å³å¯ç”Ÿæˆæ±‡ç¼–ä»£ç æ–‡ä»¶mstore.sï¼Œå…¶ä¸­çš„-Ogä»£è¡¨å¯¹ä»£ç è¿›è¡Œä¼˜åŒ–ã€‚æ±‡ç¼–ä»£ç ä¸­æœ‰å¤šç§å£°æ˜ï¼ŒåŒ…æ‹¬ï¼š\næ¯ä¸€è¡Œç¼©è¿›çš„ä»£ç éƒ½å¯¹åº”ç€ä¸€æ¡æœºå™¨æŒ‡ä»¤ï¼Œå›¾ä¸­çš„è“è‰²æ³¨è§£åˆ™æ ‡ç¤ºäº†æŒ‡ä»¤çš„ä½œç”¨ï¼Œå¦‚pushqä»£è¡¨å°†å¯„å­˜å™¨%rbxä¸­çš„å†…å®¹å‹å…¥ç¨‹åºæ ˆã€‚åŸç¨‹åºä¸­å±€éƒ¨å˜é‡åç§°ä»¥åŠæ•°æ®ç±»å‹çš„æ‰€æœ‰ä¿¡æ¯éƒ½å·²è¢«åˆ é™¤ï¼Œéšåæˆ‘ä»¬å¯ä»¥åœ¨ Linux ç³»ç»Ÿä¸­æ‰§è¡Œä¸‹åˆ—å‘½ä»¤ï¼š\n1 2 gcc -Og -c mstore.c objdump -d mstore.o ç¬¬ä¸€æ¡å‘½ä»¤å°†ç”ŸæˆäºŒè¿›åˆ¶æ ¼å¼çš„ç›®æ ‡ä»£ç æ–‡ä»¶mstore.oï¼Œç¬¬äºŒæ¡å‘½ä»¤åˆ™æ˜¯è¿›è¡Œåæ±‡ç¼–ï¼Œå³å°†æœºå™¨çº§ä»£ç è½¬æ¢ä¸ºä¸€ç§ä¸æ±‡ç¼–è¯­è¨€æ ¼å¼ç±»ä¼¼çš„ä»£ç ã€‚å›¾ä¸­çš„è¡Œå·å’Œæ–œä½“æ³¨é‡Šæ˜¯ä¸ºäº†æ–¹ä¾¿è¯´æ˜åŠ å…¥çš„ï¼Œå·¦ä¾§æœ‰ 6 ç»„åå…­è¿›åˆ¶å­—èŠ‚åºåˆ—ï¼Œæ¯ä¸ªéƒ½æ˜¯ä¸€æ¡æŒ‡ä»¤ï¼Œå³ä¾§åˆ™æ˜¾ç¤ºäº†ç­‰æ•ˆçš„æ±‡ç¼–ä»£ç ï¼š\nx86-64 æŒ‡ä»¤çš„é•¿åº¦èŒƒå›´ä¸º 1 åˆ° 15 ä¸ªå­—èŠ‚ï¼Œå¸¸ç”¨çš„å’Œ æ“ä½œæ•° è¾ƒå°‘çš„æŒ‡ä»¤æ¯”ä¸å¤ªå¸¸ç”¨æˆ–æ“ä½œæ•°è¾ƒå¤šçš„æŒ‡ä»¤éœ€è¦æ›´å°‘çš„å­—èŠ‚æ•°ï¼› ä»ç»™å®šçš„èµ·å§‹ä½ç½®å¼€å§‹ï¼Œåæ±‡ç¼–ç¨‹åºå°†å­—èŠ‚å”¯ä¸€åœ°è§£ç ä¸ºæœºå™¨æŒ‡ä»¤ã€‚ä¾‹å¦‚ï¼Œåªæœ‰æŒ‡ä»¤pushq %rbxä»¥å­—èŠ‚å€¼ 53 å¼€å¤´ï¼› åæ±‡ç¼–ç¨‹åºåªæ˜¯æ ¹æ®æœºå™¨çº§ä»£ç æ–‡ä»¶ä¸­çš„å­—èŠ‚åºåˆ—æ¥ç¡®å®šæ±‡ç¼–ä»£ç ï¼Œä¸éœ€è¦è®¿é—®æºä»£ç æˆ–æ±‡ç¼–ä»£ç ï¼› åæ±‡ç¼–ç¨‹åºä½¿ç”¨çš„æŒ‡ä»¤å‘½åè§„åˆ™ä¸ GCC ç”Ÿæˆçš„æ±‡ç¼–ä»£ç ç•¥æœ‰ä¸åŒï¼Œå¦‚è®¸å¤šæŒ‡ä»¤ä¸­çš„åç¼€qè¢«çœç•¥äº†ã€‚è¿™äº›åç¼€æ˜¯å°ºå¯¸æŒ‡ç¤ºç¬¦ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹å¯ä»¥çœç•¥ã€‚è€Œåæ±‡ç¼–å™¨åœ¨callå’ŒretæŒ‡ä»¤ä¸­æ·»åŠ äº†åç¼€qï¼Œå®ƒä»¬åŒæ ·æ˜¯å¯ä»¥çœç•¥çš„ã€‚ æƒ³è¦ç”Ÿæˆå®é™…çš„å¯æ‰§è¡Œä»£ç è¿˜éœ€è¦åœ¨ä¸€ç»„åŒ…å«mainå‡½æ•°çš„ç›®æ ‡ä»£ç æ–‡ä»¶ä¸Šè¿è¡Œé“¾æ¥å™¨ï¼ˆLinkerï¼‰ï¼Œå‡è®¾ main.c æ–‡ä»¶å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 #include \u003cstdio.h\u003e void multstore(long, long, long *); int main() { long d; multstore(2, 3, \u0026d); printf(\"2 * 3 --\u003e %ld\\n\", d); return 0; } long mult2(long a, long b) { long s = a * b; return s; } é‚£ä¹ˆé€šè¿‡gcc -Og -o prog main.c mstore.cå‘½ä»¤ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶progçš„å¤§å°å°±è¶…è¿‡äº†mstore.oï¼Œå› ä¸ºå®ƒè¿˜åŒ…å«äº†ç”¨äºå¯åŠ¨å’Œç»ˆæ­¢ç¨‹åºä»¥åŠä¸æ“ä½œç³»ç»Ÿäº¤äº’çš„ä»£ç ã€‚åŒæ ·å¯¹progæ–‡ä»¶ä½¿ç”¨objdumpå‘½ä»¤è¿›è¡Œåæ±‡ç¼–ï¼Œå…¶è¾“å‡ºç»“æœåŒ…å«å¦‚ä¸‹ä»£ç ï¼š\nä¸ç¬¬ä¸€æ¬¡åæ±‡ç¼–çš„ç»“æœç›¸æ¯”ï¼ŒåŒºåˆ«ä¸»è¦åœ¨ï¼š\né“¾æ¥å™¨ç§»åŠ¨äº†ä»£ç çš„ä½ç½®ï¼Œå› æ­¤å›¾ä¸­å·¦ä¾§çš„åœ°å€ä¸åŒï¼› é“¾æ¥å™¨çš„ä¸€é¡¹ä»»åŠ¡æ˜¯å°†å‡½æ•°è°ƒç”¨ä¸å…¶å¯æ‰§è¡Œä»£ç çš„ä½ç½®è¿›è¡ŒåŒ¹é…ã€‚åœ¨ä¸Šå›¾ç¬¬ 4 è¡Œï¼Œé“¾æ¥å™¨å¡«å……äº†callqæŒ‡ä»¤åœ¨è°ƒç”¨å‡½æ•°mult2æ—¶åº”è¯¥ä½¿ç”¨çš„åœ°å€ï¼› ä¸Šå›¾ç¬¬ 8ï¼Œ9 è¡Œå¡«å……çš„ä»£ç å¯¹ç»“æœæ²¡æœ‰ä»»ä½•å½±å“ï¼Œnopæ„ä¸ºâ€œNo Operationâ€ã€‚æ’å…¥å®ƒä»¬æ˜¯ä¸ºäº†å°†å‡½æ•°çš„ä»£ç å¢åŠ åˆ° 16 å­—èŠ‚ï¼Œè¿™æ ·å¯ä»¥æ›´å¥½åœ°æ”¾ç½®ä¸‹ä¸€ä¸ªä»£ç å—ï¼Œä»è€Œæå‡å­˜å‚¨å™¨çš„ç³»ç»Ÿæ€§èƒ½ã€‚ æ•°æ®æ ¼å¼ Intel ç”¨æœ¯è¯­â€œå­—â€ï¼ˆWordï¼‰æ¥è¡¨ç¤º 16 ä½æ•°æ®ç±»å‹ï¼Œå› æ­¤ 32 ä½æ•°è¢«ç§°ä¸ºâ€œåŒå­—â€ï¼ˆDouble Wordsï¼‰ï¼Œ64 ä½æ•°è¢«ç§°ä¸ºâ€œå››å­—â€ï¼ˆQuad Wordsï¼‰ã€‚åœ¨ x86-64 æœºå™¨ä¸Š C çš„åŸå§‹æ•°æ®ç±»å‹å¤§å°å¦‚ä¸‹ï¼š\nC declaration Intel data type Assembly-code suffix Size(bytes) char Byte b 1 short Word w 2 int Double word l 4 long Quad word q 8 char * Quad word q 8 float Single precision s 4 double Double precision l 8 å¤§å¤šæ•°ç”± GCC ç”Ÿæˆçš„æ±‡ç¼–ä»£ç éƒ½æœ‰ä¸€ä¸ªè¡¨ç¤ºæ“ä½œæ•°å¤§å°çš„å•å­—ç¬¦åç¼€ï¼Œå¦‚æ•°æ®ç§»åŠ¨æŒ‡ä»¤æœ‰å››ç§å˜ä½“ï¼šmovbï¼ˆç§»åŠ¨å­—èŠ‚ï¼‰ã€movwï¼ˆç§»åŠ¨å­—ï¼‰ã€movlï¼ˆç§»åŠ¨åŒå­—ï¼‰å’Œmovqï¼ˆç§»åŠ¨å››å­—ï¼‰ã€‚å€¼å¾—ä¸€ææ˜¯ï¼Œåç¼€â€œlâ€å³å¯ä»¥è¡¨ç¤º 4 å­—èŠ‚æ•´æ•°åˆè¡¨ç¤º 8 å­—èŠ‚åŒç²¾åº¦æµ®ç‚¹æ•°ã€‚è¿™å¹¶ä¸ä¼šå¼•èµ·æ­§ä¹‰ï¼Œå› ä¸ºæ¶‰åŠåˆ°æµ®ç‚¹æ•°çš„ä»£ç ä½¿ç”¨ä¸€ç»„ä¸æ•´æ•°å®Œå…¨ä¸åŒçš„æŒ‡ä»¤å’Œå¯„å­˜å™¨ã€‚\nè®¿é—®ä¿¡æ¯ ä¸Šæ–‡æåˆ°ï¼Œx86-64 æœºå™¨çš„ CPU ä¸­åŒ…å« 16 ä¸ªé€šç”¨çš„æ•´æ•°å¯„å­˜å™¨ï¼Œå‡å¯ä»¥å­˜å‚¨ 64 ä½çš„æ•´æ•°æˆ–æŒ‡é’ˆæ•°æ®ï¼š\nå›¾ä¸­æ‰€æœ‰å¯„å­˜å™¨çš„åç§°å‡ä»¥ %r å¼€å¤´ï¼Œå®ƒä»¬çš„æ¼”å˜é¡ºåºæ˜¯ä»å³å¾€å·¦çš„ã€‚å‰ 8 ä¸ªå¯„å­˜å™¨ï¼Œå³ %ax åˆ° %spï¼Œæ˜¯æœ€åˆçš„ 8086 æœºå™¨ä½¿ç”¨çš„ 8 ä¸ª 16 ä½å¯„å­˜å™¨ã€‚éšç€ IA32 çš„å‡ºç°ï¼Œå®ƒä»¬è¢«æ‰©å±•ä½ 32 ä½ï¼Œå³ %eax åˆ° %espã€‚ç›®å‰çš„ x86-64 æœºå™¨å°†å…¶è¿›ä¸€æ­¥åœ°æ‰©å±•ä¸º 64 ä½ï¼Œå³ %rax åˆ° %rspã€‚åŒæ—¶è¿˜æ–°æ·»åŠ äº† 8 ä¸ªå¯„å­˜å™¨ï¼Œå³ %r8 åˆ° %r15ã€‚å›¾ä¸­å³ä¾§çš„æ³¨é‡Šè¯´æ˜äº†å„ä¸ªå¯„å­˜å™¨åœ¨å…¸å‹ç¨‹åºä¸­æ‰®æ¼”çš„è§’è‰²ï¼Œå…¶ä¸­æœ€ç‹¬ç‰¹çš„æ˜¯æ ˆæŒ‡é’ˆ %rspï¼Œå®ƒç”¨äºæŒ‡ç¤ºè¿è¡Œæ—¶æ ˆçš„ç»“æŸä½ç½®ã€‚\næŒ‡ä»¤å¯ä»¥å¯¹å­˜å‚¨åœ¨å¯„å­˜å™¨ä½ä½å­—èŠ‚ä¸­çš„ä¸åŒå¤§å°çš„æ•°æ®è¿›è¡Œæ“ä½œã€‚å­—èŠ‚çº§æ“ä½œå¯ä»¥è®¿é—®æœ€ä½æœ‰æ•ˆå­—èŠ‚ï¼Œ16 ä½æ“ä½œå¯ä»¥è®¿é—®æœ€ä½æœ‰æ•ˆ 2 ä¸ªå­—èŠ‚ï¼Œ32 ä½æ“ä½œå¯ä»¥è®¿é—®æœ€ä½æœ‰æ•ˆ 4 ä¸ªå­—èŠ‚ï¼Œ64 ä½æ“ä½œåˆ™å¯ä»¥è®¿é—®æ•´ä¸ªå¯„å­˜å™¨ã€‚\næ“ä½œæ•° å¤§å¤šæ•°æŒ‡ä»¤éƒ½æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæ“ä½œæ•°ï¼ˆOperandï¼‰ï¼ŒæŒ‡å®šäº†æ‰§è¡Œæ“ä½œæ—¶ä½¿ç”¨çš„æºæ•°æ®å’Œç»“æœæ”¾ç½®çš„ä½ç½®ã€‚x86-64 æœºå™¨æ”¯æŒçš„æ“ä½œæ•°æ ¼å¼å¦‚ä¸‹ï¼š\næºæ•°æ®æ—¢å¯ä»¥ä»¥å¸¸æ•°å½¢å¼ç»™å‡ºï¼Œä¹Ÿå¯ä»¥ä»å¯„å­˜å™¨æˆ–å†…å­˜ä¸­è¯»å–ï¼Œç»“æœåˆ™å­˜å‚¨åœ¨å¯„å­˜å™¨æˆ–å†…å­˜ä¸­ã€‚å› æ­¤æ“ä½œæ•°æœ‰ä¸‰ç§å¯èƒ½çš„ç±»å‹ï¼š\nç«‹å³æ•°ï¼ˆImmediateï¼‰ï¼šå³å¸¸æ•°å€¼ï¼Œä¹¦å†™æ–¹å¼ä¸º $ ç¬¦å·åé¢è·Ÿä¸€ä¸ªæ•´æ•°ï¼› å¯„å­˜å™¨ï¼ˆRegisterï¼‰ï¼šå¯„å­˜å™¨ä¸­çš„å†…å®¹ã€‚æˆ‘ä»¬ä½¿ç”¨ $r_a$ è¡¨ç¤ºä»»æ„å¯„å­˜å™¨ $a$ï¼Œä½¿ç”¨ $R[r_a]$ æ¥è¡¨ç¤ºå®ƒçš„å€¼ï¼› å†…å­˜ï¼ˆMemoryï¼‰å¼•ç”¨ï¼šæ ¹æ®è®¡ç®—å‡ºçš„åœ°å€ï¼ˆä¹Ÿç§°æœ‰æ•ˆåœ°å€ï¼‰æ¥è®¿é—®æŸä¸ªå†…å­˜ä½ç½®ã€‚ä½¿ç”¨ $M_b[Addr]$ è¡¨ç¤ºåœ¨å†…å­˜ä¸­ä»åœ°å€ $Addr$ å¼€å§‹ $b$ å­—èŠ‚çš„å¼•ç”¨ï¼Œå³ä¸‹è§’æ ‡ $b$ å¯ä»¥çœç•¥ã€‚ æœ€é€šç”¨çš„å†…å­˜å¼•ç”¨æ–¹å¼åœ¨ä¸Šè¡¨åº•éƒ¨ï¼š$M[Imm + R[r_b] + R[r_i]\\times s]$ï¼Œå¸¸ç”¨äºå¼•ç”¨æ•°ç»„å…ƒç´ ã€‚\nå‡è®¾ä¸‹åˆ—å€¼å­˜å‚¨åœ¨å†…å­˜æˆ–å¯„å­˜å™¨ä¸­æŒ‡å®šçš„åœ°å€å¤„ï¼š\né‚£ä¹ˆä»¥ä¸‹æ“ä½œæ•°å­˜å‚¨çš„å€¼åˆ†åˆ«ä¸ºï¼š\n%raxï¼š0x100 0x104ï¼šåœ°å€ä¸º 0x104ï¼Œå€¼ä¸º 0xAB $0x108ï¼š0x108ï¼ˆç«‹å³æ•°ï¼‰ (%rax)ï¼šåœ°å€ä¸º 0x100ï¼Œå€¼ä¸º 0xFF 9(%rax,%rdx)ï¼šåœ°å€ä¸º 9 + 0x100 + 0x3 = 0x10Cï¼Œå€¼ä¸º 0x11 260(%rcx,%rdx)ï¼š260 å³åå…­è¿›åˆ¶æ•° 0x104ï¼Œå› æ­¤åœ°å€ä¸º 0x104 + 0x1 + 0x3 = 0x108ï¼Œå€¼ä¸º 0x13 0xFC(,%rcx,4)ï¼šåœ°å€ä¸º 0xFC + 0x1 * 4 = 0x100ï¼Œå€¼ä¸º 0xFF %rax,%rdx,4ï¼šåœ°å€ä¸ºï¼š0x100 + 0x3 * 4 = 0x10Cï¼Œå€¼ä¸º 0x11 æ•°æ®ç§»åŠ¨æŒ‡ä»¤ åœ¨æ‰€æœ‰æœºå™¨æŒ‡ä»¤ä¸­ä½¿ç”¨æœ€ä¸ºé¢‘ç¹çš„ä¾¿æ˜¯æ•°æ®ç§»åŠ¨æŒ‡ä»¤ï¼Œå®ƒä»¬è´Ÿè´£å°†æ•°æ®ä»ä¸€å¤„ç§»åŠ¨åˆ°å¦ä¸€å¤„ã€‚æˆ‘ä»¬å°†æ“ä½œç›¸åŒä½†æ“ä½œæ•°å°ºå¯¸ä¸åŒçš„æŒ‡ä»¤åˆ’åˆ†ä¸ºåŒä¸€ä¸ªæŒ‡ä»¤ç±»ï¼ˆInstruction Classesï¼‰ï¼Œä¸‹è¡¨åˆ—å‡ºçš„ä¾¿æ˜¯ MOV æŒ‡ä»¤ç±»ä¸­çš„å„ç§æ“ä½œï¼š\nä¸Šè¡¨ä¸­çš„ S ä»£è¡¨ æºåœ°å€ï¼ˆSourceï¼‰ï¼ŒD ä»£è¡¨ç›®çš„åœ°å€ï¼ˆDestinationï¼‰ï¼ŒI ä»£è¡¨ç«‹å³æ•°ï¼ŒR ä»£è¡¨å¯„å­˜å™¨ã€‚å…¶ä¸­ï¼Œç§»åŠ¨æŒ‡ä»¤ä¸èƒ½å°†ä¸€ä¸ªä½äºå†…å­˜ä¸­çš„æ•°æ®ç›´æ¥ç§»åŠ¨åˆ°å†…å­˜ä¸­çš„å¦ä¸€ä¸ªä½ç½®ï¼Œå¿…é¡»ç»è¿‡ä¸€ä¸ªå¯„å­˜å™¨ä¸­è½¬ã€‚æ­¤å¤–ï¼Œå½“movlæŒ‡ä»¤çš„ç›®çš„åœ°å€ä¸ºä¸€ä¸ªå¯„å­˜å™¨æ—¶ï¼Œå®ƒä¸ä»…ä¼šæŠŠç›®çš„å¯„å­˜å™¨çš„è¾ƒä½å››ä½æ›´æ–°ä¸ºæºæ•°æ®ï¼Œè¿˜ä¼šå°†è¾ƒé«˜å››ä½çš„å­—èŠ‚å…¨éƒ¨ç½® 0ã€‚æœ€åï¼ŒmovabsqæŒ‡ä»¤åªèƒ½å°†å¯„å­˜å™¨ä½œä¸ºæ•°æ®çš„ç›®çš„åœ°å€ã€‚ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œå·¦è¾¹ä¸ºé¡ºåºæ‰§è¡Œçš„ç§»åŠ¨æŒ‡ä»¤ï¼Œå³è¾¹ä¸ºå¯„å­˜å™¨ %rax ä¸­å­—èŠ‚çš„å˜åŒ–æƒ…å†µï¼š\n1 2 3 4 5 movabsq $0x0011223344556677, %rax %rax = 0011223344556677 movb $-1, %al %rax = 00112233445566FF movw $-1, %ax %rax = 001122334455FFFF movl $-1, %eax %rax = 00000000FFFFFFFF movq $-1, %rax %rax = FFFFFFFFFFFFFFFF è¿˜æœ‰ä¸¤ç±»æ•°æ®ç§»åŠ¨æŒ‡ä»¤å¯ä»¥å°†è¾ƒå°å°ºå¯¸çš„æºæ•°æ®ç§»åŠ¨åˆ°è¾ƒå¤§å°ºå¯¸çš„ç›®çš„å¯„å­˜å™¨ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š\nä¸¤è€…ä¸åŒçš„æ˜¯ï¼ŒmovzæŒ‡ä»¤å°†ç›®çš„å¯„å­˜å™¨çš„å‰©ä½™å­—èŠ‚å‡å¡«å……ä¸º 0ï¼ˆé›¶æ‰©å±•ï¼‰ï¼ŒmovsæŒ‡ä»¤åˆ™å°†å…¶å¡«å……ä¸ºæºæ“ä½œæ•°çš„æœ€é«˜æœ‰æ•ˆä½ï¼ˆç¬¦å·æ‰©å±•ï¼‰ã€‚ç›¸æ¯”äºç¬¦å·æ‰©å±•ï¼Œé›¶æ‰©å±•ç¼ºå°‘äº†æŒ‡ä»¤movzlqã€‚è¿™æ˜¯å› ä¸ºä¸Šæ–‡æåˆ°ï¼Œä½¿ç”¨movlæŒ‡ä»¤ç§»åŠ¨æ•°æ®åˆ°å¯„å­˜å™¨æ—¶ï¼Œä¼šå°†é«˜ä½å…¨éƒ¨ç½®ä¸º 0ï¼Œå…¶æ•ˆæœä¸é›¶æ‰©å±•æ— å¼‚ã€‚å¦å¤–ï¼Œç¬¦å·æ‰©å±•è¿˜å¤šäº†ä¸€ä¸ªæŒ‡ä»¤cltqã€‚å®ƒæ²¡æœ‰æ“ä½œæ•°ï¼Œå®é™…ä¸Šç­‰æ•ˆäºmovslq %eax, %raxã€‚\nåœ¨ C ä¸­ï¼Œå¯¹æŒ‡é’ˆè§£å¼•ç”¨ï¼ˆDereference Pointerï¼Œ*pï¼‰ä¼šå°†æŒ‡é’ˆæ‹·è´åˆ°å¯„å­˜å™¨ä¸­ï¼Œç„¶åå°†è¯¥å¯„å­˜å™¨ä½œä¸ºå†…å­˜åœ°å€çš„å¼•ç”¨ã€‚ä¸€ä¸ªç®€å•çš„ C ç¨‹åºå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 long exchange(long *xp, long y) { long x = *xp; *xp = y; return x; } ä¸ä¹‹ç­‰æ•ˆçš„æ±‡ç¼–ä»£ç ä¸ºï¼š\n1 2 3 4 5 ; xp in %rdi, y in %rsi exchange: movq (%rdi), %rax movq %rsi, (%rdi) ret æœ€åä¸¤ä¸ªæ•°æ®ç§»åŠ¨æŒ‡ä»¤åˆ†åˆ«æ˜¯å°†æ•°æ®å‹å…¥ç¨‹åºæ ˆï¼ˆStackï¼‰çš„pushå’Œå°†æ•°æ®ä»ç¨‹åºæ ˆä¸­å¼¹å‡ºçš„popï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š\nåœ¨ x86-64 ä¸­ï¼Œç¨‹åºæ ˆå­˜å‚¨åœ¨å†…å­˜ä¸­çš„æŸäº›åŒºåŸŸä¸­ï¼Œå…¶ç‰¹æ€§ä¸ºåè¿›å…ˆå‡ºï¼ˆLast-in, First-outï¼‰ã€‚ä¹ æƒ¯ä¸Šæˆ‘ä»¬å°†æ ˆé¡¶ç”»åœ¨åº•ç«¯ï¼Œè€Œæ ˆé¡¶å…ƒç´ çš„åœ°å€ï¼ˆç”±æ ˆæŒ‡é’ˆ %rsp ä¿å­˜ï¼‰æ˜¯æ•´ä¸ªæ ˆä¸­æœ€å°çš„ï¼š\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæƒ³è¦å°†ä¸€ä¸ªå››å­—æ•°æ®å‹å…¥æ ˆä¸­ï¼Œé¦–å…ˆè¦æŠŠæ ˆæŒ‡é’ˆå‡ 8ï¼Œç„¶åä»¤æºæ•°æ®å€¼æˆä¸ºæ–°çš„æ ˆé¡¶å…ƒç´ ã€‚å› æ­¤æŒ‡ä»¤pushq %raxå°±ç­‰æ•ˆäºï¼š\n1 2 3 ; subq ä¸ºå‡æ³•è¿ç®—ï¼Œä¸‹ä¸€èŠ‚ä¼šè¿›è¡Œä»‹ç» subq $8, \u0026rsp movq %rax, (%rsp) åŒæ ·ï¼Œè‹¥æƒ³å°†æ ˆé¡¶çš„å››å­—æ•°æ®å¼¹å‡ºæ ˆï¼Œé¦–å…ˆè¦æŠŠæ ˆé¡¶å…ƒç´ çš„å€¼æ‹·è´åˆ°å¯„å­˜å™¨ä¸­ï¼Œç„¶åå†æŠŠæ ˆæŒ‡é’ˆåŠ  8ã€‚å› æ­¤æŒ‡ä»¤popq %rdxå°±ç­‰æ•ˆäºï¼š\n1 2 3 movq (%rsp), %rdx ; addq ä¸ºåŠ æ³•è¿ç®—ï¼Œä¸‹ä¸€èŠ‚ä¼šè¿›è¡Œä»‹ç» addq $8, %rsp ç®—æœ¯å’Œé€»è¾‘æ“ä½œ ä¸‹å›¾åˆ—å‡ºäº†ä¸€äº› x86-64 ä¸­çš„æ•´æ•°ç®—æœ¯å’Œé€»è¾‘æ“ä½œï¼Œå…¶ä¸­é™¤äº†leaqå¤–ç»™å‡ºçš„éƒ½æ˜¯æŒ‡ä»¤ç±»ï¼š\nä»¥ä¸Šæ“ä½œå¯åˆ†ä¸ºå››ç±»ï¼šåŠ è½½æœ‰æ•ˆåœ°å€ï¼ˆLoad Effective Addressï¼‰ã€ä¸€å…ƒï¼ˆUnaryï¼‰ã€äºŒå…ƒï¼ˆBinaryï¼‰å’Œç§»ä½ï¼ˆShiftsï¼‰ã€‚ä¸€å…ƒæ“ä½œåªæœ‰ä¸€ä¸ªæ“ä½œæ•°ï¼Œè€ŒäºŒå…ƒæ“ä½œåˆ™æœ‰ä¸¤ä¸ªã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°†åˆ†åˆ«ä»‹ç»å®ƒä»¬ã€‚\nåŠ è½½æœ‰æ•ˆåœ°å€ åŠ è½½æœ‰æ•ˆåœ°å€çš„æŒ‡ä»¤åä¸ºleaqï¼Œå…¶å®è´¨æ˜¯movqæŒ‡ä»¤çš„ä¸€ç§å˜ä½“ã€‚å®ƒä¼šä»å†…å­˜ä¸­è¯»å–æºæ“ä½œæ•°çš„åœ°å€æ‹·è´åˆ°å¯„å­˜å™¨ä¸­ï¼Œæœ‰æ—¶å€™ä¹Ÿç”¨äºå®ç°ä¸€äº›ç®€å•çš„è¿ç®—ã€‚ä¾‹å¦‚å¯„å­˜å™¨ %rdx ä¸­å­˜å‚¨çš„å€¼ä¸º xï¼Œé‚£ä¹ˆæŒ‡ä»¤leaq 7(%rdx, %rdx, 4), %raxçš„ä½œç”¨ä¾¿æ˜¯å°†å¯„å­˜å™¨ %rax çš„å€¼è®¾ä¸º 5x+7ã€‚è™½ç„¶leaqæŒ‡ä»¤åœ¨æ‰§è¡Œè¿ç®—æ–¹é¢çš„èƒ½åŠ›æ˜¯æœ‰é™çš„ï¼Œä½†æ˜¯ä¸åŠ æ³•å’Œä¹˜æ³•æŒ‡ä»¤ç›¸æ¯”ï¼Œå®ƒçš„æ€§èƒ½æ›´åŠ å‡ºè‰²ã€‚\nä¸€å…ƒå’ŒäºŒå…ƒæ“ä½œ ä¸€å…ƒæ“ä½œåªæœ‰ä¸€ä¸ªæ“ä½œæ•°ï¼Œå› æ­¤æºåœ°å€å’Œç›®çš„åœ°å€ç›¸åŒã€‚å¦‚æ“ä½œincq (%rsp)å¯ä»¥å°†ç¨‹åºæ ˆé¡¶å¢åŠ  8 ä¸ªå­—èŠ‚çš„å…ƒç´ ï¼Œç±»ä¼¼äº C ä¸­çš„è‡ªå¢è¿ç®—ç¬¦++ã€‚\näºŒå…ƒæ“ä½œç±»ä¼¼äº C ä¸­çš„èµ‹å€¼è¿ç®—ç¬¦ï¼ˆAssignment Operatorï¼‰ï¼Œå¦‚x -= yã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œæ“ä½œsubq %rax, %rdxä¼šå°†å¯„å­˜å™¨ %rdx ä¸­çš„å€¼å‡å»å¯„å­˜å™¨ %rax ä¸­çš„å€¼ã€‚ç¬¬ä¸€ä¸ªæ“ä½œæ•°å¯ä»¥æ˜¯ç«‹å³æ•°ã€å¯„å­˜å™¨æˆ–å†…å­˜ä¸­çš„ä½ç½®ï¼Œç¬¬äºŒä¸ªæ“ä½œæ•°åˆ™åªèƒ½æ˜¯å¯„å­˜å™¨æˆ–å†…å­˜ä¸­çš„ä½ç½®ã€‚ä¸ MOV ç±»æŒ‡ä»¤ç›¸åŒï¼ŒäºŒå…ƒæ“ä½œçš„ä¸¤ä¸ªæ“ä½œæ•°ä¸èƒ½åŒæ—¶ä¸ºå†…å­˜ä¸­çš„ä½ç½®ã€‚\nç§»ä½æ“ä½œ ç§»ä½æ“ä½œçš„ç¬¬ä¸€ä¸ªæ“ä½œç¬¦ä¸ºä½æ•°ï¼Œå¯ä»¥æ˜¯ç«‹å³æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯å•å­—èŠ‚çš„å¯„å­˜å™¨ï¼ˆé€šå¸¸ä½¿ç”¨å¯„å­˜å™¨ %clï¼‰ã€‚ç¬¬äºŒä¸ªæ“ä½œæ•°ä¸ºç§»ä½çš„å€¼ã€‚å¯ä»¥æ˜¯å¯„å­˜å™¨æˆ–å†…å­˜ä¸­çš„ä½ç½®ã€‚å¯¹äºå³ç§»è¿ç®—æ¥è¯´ï¼ŒSAR ä»£è¡¨ç®—æœ¯å³ç§»ï¼ŒSHR åˆ™ä»£è¡¨é€»è¾‘å³ç§»ã€‚\nç‰¹æ®Šç®—æ•°æ“ä½œ ä¸¤ä¸ª 64 ä½æ•´å‹çš„ç§¯éœ€è¦ç”¨ 128 ä½æ¥è¡¨ç¤ºï¼Œå› æ­¤ Intel å¼•å…¥äº† 16 å­—èŠ‚å•ä½â€œå…«å­—â€ï¼ˆOct Wordï¼‰æ¥è§£å†³è¿™ä¸€é—®é¢˜ã€‚ä¸‹è¡¨å±•ç¤ºäº†ä¸€äº›æ”¯æŒè¿ç®—ç»“æœä¸ºå…«å­—çš„æ“ä½œï¼š\næˆ‘ä»¬åœ¨æ™®é€šç®—æ•°æ“ä½œå’Œç‰¹æ®Šç®—æ•°æ“ä½œä¸­å‡å‘ç°äº†imulqæŒ‡ä»¤ã€‚ç¬¬ä¸€ç§å±äº IMUL ç±»ï¼Œæœ‰ä¸¤ä¸ªæ“ä½œæ•°ã€‚å…¶è®¡ç®—ç»“æœä¸º 64 ä½ï¼ˆè‹¥è¶…è¿‡ 64 ä½ï¼Œåˆ™æˆªæ–­é«˜ä½ï¼‰ï¼Œç­‰æ•ˆäºç¬¬äºŒç« ä»‹ç»çš„ æ— ç¬¦å·ä¹˜æ³• å’Œ äºŒè¿›åˆ¶è¡¥ç ä¹˜æ³•ã€‚ç¬¬äºŒç§å³æ˜¯ä¸Šè¡¨ä¸­çš„ç‰¹æ®Šç®—æ•°æ“ä½œï¼Œåªæœ‰ä¸€ä¸ªæ“ä½œæ•°ï¼Œå› æ­¤ç¼–è¯‘å™¨å¯ä»¥æ ¹æ®æ“ä½œæ•°çš„æ•°é‡åŒºåˆ†å®ƒä»¬ã€‚\nç”¨äºæœ‰ç¬¦å·ä¹˜æ³•çš„æ“ä½œè¢«ç§°ä¸ºimulqï¼Œç”¨äºæ— ç¬¦å·ä¹˜æ³•çš„åˆ™ä¸ºmulqã€‚ä¸¤è€…çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå¯„å­˜å™¨ %raxï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºæºæ“ä½œæ•°ã€‚è®¡ç®—ç»“æœä¸­è¾ƒé«˜ 64 ä½å°†å­˜å‚¨åœ¨å¯„å­˜å™¨ %rdx ä¸­ï¼Œè¾ƒä½ 64 ä½åˆ™å­˜å‚¨åœ¨å¯„å­˜å™¨ %rax ä¸­ã€‚\n1 2 3 4 5 #include \u003cinttypes.h\u003e typedef unsigned __int128 uint128_t void store_uprod(uint128_t *dest, uint64_t x, uint64_t y){ *dest = x * (uint128_t)y; } ç¤ºä¾‹ C ç¨‹åºåœ¨å°ç«¯æ³•æœºå™¨ä¸Šå¯è½¬åŒ–ä¸ºå¦‚ä¸‹çš„æ±‡ç¼–ä»£ç ï¼š\n1 2 3 4 5 6 ; dest in %rdi, x in %rsi, y in %rdx store_uprod movq %rsi, %rax mulq %rdx movq %rax, (%rdi) movq %rdx, 8(%rdi) æ™®é€šç®—æ•°æ“ä½œä¸­æ²¡æœ‰æä¾›é™¤æ³•æˆ–ä½™æ•°è¿ç®—ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨ç‰¹æ®Šç®—æ•°æ“ä½œidivqå’Œdivqã€‚ä¸ä¹˜æ³•ç±»ä¼¼ï¼Œè¢«é™¤æ•°çš„è¾ƒé«˜ 64 ä½å°†å­˜å‚¨åœ¨å¯„å­˜å™¨ %rdx ä¸­ï¼Œè¾ƒä½ 64 ä½å­˜å‚¨åœ¨å¯„å­˜å™¨ %rax ä¸­ã€‚é™¤æ•°ä¸ºæ“ä½œæ•°ï¼Œå•†ä¿å­˜åœ¨å¯„å­˜å™¨ %rax ä¸­ï¼Œä½™æ•°åˆ™ä¿å­˜åœ¨å¯„å­˜å™¨ %rdx ä¸­ã€‚å¦‚æœè¢«é™¤æ•°åªæœ‰ 64 ä½ï¼Œé‚£ä¹ˆå°±åº”å½“å°†å¯„å­˜å™¨ %rdx å…¨éƒ¨ç½®ä¸º 0ï¼ˆæ— ç¬¦å·è¿ç®—ï¼‰æˆ–ç¬¦å·ä½ï¼ˆæœ‰ç¬¦å·è¿ç®—ï¼‰ã€‚åè€…å¯ä»¥ä½¿ç”¨cqtoæ“ä½œå®ç°ï¼Œå®ƒä¼šä»å¯„å­˜å™¨ %rax ä¸­è¯»å–ç¬¦å·ä½ï¼Œç„¶åå°†å…¶æ‹·è´åˆ°å¯„å­˜å™¨ %rdx å†…çš„æ¯ä¸€ä½ä¸­ã€‚\næ§åˆ¶ ä¸Šæ–‡ä¸­ä»‹ç»çš„æ“ä½œåªè€ƒè™‘äº†é¡ºåºæ‰§è¡Œçš„ä»£ç ï¼Œå¯¹äº C ä¸­çš„ Ifã€Forã€While å’Œ Switch è¯­å¥ï¼Œå®ƒä»¬è¿˜éœ€è¦æ ¹æ®æ•°æ®æ£€éªŒçš„ç»“æœæ¥å†³å®šä»£ç æ‰§è¡Œçš„é¡ºåºã€‚æœºå™¨çº§ä»£ç æä¾›äº†ä¸¤ç§åŸºæœ¬æœºåˆ¶æ¥å®ç°è¿™ç§æ¡ä»¶è¡Œä¸ºï¼ˆConditional Behaviorï¼‰ï¼Œä¸€ç§æ ¹æ®æ£€éªŒç»“æœæ”¹å˜æ§åˆ¶æµï¼ˆControl Flowï¼‰ï¼Œå¦ä¸€ç§åˆ™æ”¹å˜æ•°æ®æµï¼ˆData Flowï¼‰ã€‚\næ¡ä»¶ç  ä¸Šæ–‡æåˆ°ï¼ŒCPU ç»´æŠ¤äº†ä¸€ç»„å•å­—èŠ‚çš„æ¡ä»¶ç å¯„å­˜å™¨ï¼Œå®ƒä»¬è®°å½•äº†æœ€è¿‘ä¸€æ¬¡ç®—æ•°æˆ–é€»è¾‘æ“ä½œç»“æœçš„æŸäº›å±æ€§ï¼š\nCFï¼ˆCarry Flagï¼‰ï¼šè¿›ä½æ ‡è¯†ï¼Œè®°å½•æœ€é«˜æœ‰æ•ˆä½æ˜¯å¦å‘ç”Ÿè¿›ä½ï¼Œç”¨äºæ£€æµ‹æ— ç¬¦å·æ•°æ“ä½œçš„æº¢å‡ºï¼› ZFï¼ˆZero Flagï¼‰ï¼šé›¶æ ‡è¯†ï¼Œè®°å½•ç»“æœæ˜¯å¦ä¸º 0ï¼› SFï¼ˆSign Flagï¼‰ï¼šç¬¦å·æ ‡è¯†ï¼Œè®°å½•ç»“æœæ˜¯å¦ä¸ºè´Ÿå€¼ï¼› OFï¼ˆOverflow Flagï¼‰ï¼šæº¢å‡ºæ ‡è¯†ï¼Œè®°å½•æ˜¯å¦å‘ç”ŸäºŒè¿›åˆ¶è¡¥ç æº¢å‡ºã€‚ ä¸‹åˆ—ä¸¤ä¸ªæŒ‡ä»¤ç±»å¯ä»¥åœ¨ä¸æ”¹å˜ä»»ä½•å…¶ä»–å¯„å­˜å™¨çš„æƒ…å†µä¸‹è®¾ç½®æ¡ä»¶ç ï¼Œå¦‚æŒ‡ä»¤testq %rax, %raxå¯ä»¥æ£€æµ‹å¯„å­˜å™¨ %rax å­˜å‚¨çš„å€¼æ˜¯æ­£æ•°ã€è´Ÿæ•°è¿˜æ˜¯é›¶ï¼š\nç›¸æ¯”äºç›´æ¥è¯»å–ï¼Œæˆ‘ä»¬æ›´å¸¸ç”¨ä»¥ä¸‹ä¸‰ç§æ–¹å¼ä½¿ç”¨æ¡ä»¶ç ï¼š\næ ¹æ®æ¡ä»¶ç çš„ç»„åˆå°†å•ä¸ªå­—èŠ‚è®¾ç½®ä¸º 0 æˆ– 1ï¼› æœ‰æ¡ä»¶åœ°è·³è½¬åˆ°ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†ï¼› æœ‰æ¡ä»¶åœ°ä¼ è¾“æ•°æ®ã€‚ ä¸‹åˆ—æ“ä½œæŒ‡ä»¤ä¾¿å¯ä»¥å®ç°ä¸Šè¿°ç¬¬ä¸€ç§æ–¹å¼ã€‚æ³¨æ„ï¼Œæ­¤å¤„çš„æŒ‡ä»¤åç¼€ä»£è¡¨çš„å¹¶éæ˜¯ä¸åŒçš„æ“ä½œæ•°å¤§å°ï¼Œè€Œæ˜¯ä¸åŒçš„æ¡ä»¶åˆ¤æ–­ã€‚å¦‚æŒ‡ä»¤setlå’Œsetbåˆ†åˆ«ä»£è¡¨ set less å’Œ set belowï¼š\nå¦‚ä¸‹æ±‡ç¼–ä»£ç é¦–å…ˆæ¯”è¾ƒäº†å˜é‡aå’Œbçš„å¤§å°ï¼Œç„¶åæ ¹æ®ç»“æœæŠŠå¯„å­˜å™¨ %eax çš„æœ€ä½å­—èŠ‚ï¼ˆå³å¯„å­˜å™¨ %alï¼‰ç½®ä¸º 0 æˆ– 1ã€‚movzblæŒ‡ä»¤çš„ä½œç”¨æ˜¯å°†å¯„å­˜å™¨ %eax çš„é«˜ä½ä¸‰ä¸ªå­—èŠ‚ä»¥åŠå¯„å­˜å™¨ %rax çš„é«˜ä½å››ä¸ªå­—èŠ‚å…¨éƒ¨æ¸…é›¶ï¼š\n1 2 3 4 5 6 7 ; int comp(data_t a, data_t b) ; a in rdi%, b in rsi% comp: cmpq %rsi, %rdi setl %al movzbl %al, %eax ret è·³è½¬æŒ‡ä»¤ è·³è½¬æŒ‡ä»¤å¯ä»¥è®©ç¨‹åºè½¬åˆ°ä¸€ä¸ªå…¨æ–°çš„ä½ç½®ç»§ç»­æ‰§è¡Œï¼Œè¯¥ä½ç½®åœ¨æ±‡ç¼–ä»£ç ä¸­ä½¿ç”¨æ ‡ç­¾ï¼ˆLabelï¼‰æ¥æŒ‡å®šã€‚\n1 2 3 4 5 movq $0, %rax jmp .L1 movq (rax%), %rdx .L1: popq %rdx ç¤ºä¾‹ C ç¨‹åºä¸­ï¼ŒæŒ‡ä»¤jmp .L1å°†ä½¿ç¨‹åºè·³è¿‡movqæŒ‡ä»¤ï¼Œå¼€å§‹æ‰§è¡Œpopqæ“ä½œã€‚ ä¸‹å›¾å±•ç¤ºäº†ä¸åŒçš„è·³è½¬æŒ‡ä»¤ï¼š\nâ€‹\njmpæŒ‡ä»¤æ—¢å¯ä»¥æ˜¯ç›´æ¥è·³è½¬ï¼Œä¹Ÿå¯ä»¥æ˜¯é—´æ¥è·³è½¬ã€‚ç›´æ¥è·³è½¬çš„ç›®æ ‡ä½¿ç”¨æ ‡ç­¾æŒ‡å®šï¼Œè€Œé—´æ¥è·³è½¬çš„ç›®æ ‡åˆ™éœ€è¦ä»å¯„å­˜å™¨æˆ–å†…å­˜ä¸­è¯»å–ã€‚ä¸Šå›¾ä¸­çš„å…¶ä½™æŒ‡ä»¤å‡ä¸ºæ¡ä»¶è·³è½¬ï¼Œå®ƒä»¬æ ¹æ®æ¡ä»¶åˆ¤æ–­çš„ç»“æœæ¥å†³å®šæ˜¯å¦æ‰§è¡Œè·³è½¬æ“ä½œã€‚æ³¨æ„ï¼Œæ¡ä»¶è·³è½¬å‡ä¸ºç›´æ¥è·³è½¬ã€‚\nåœ¨ç”Ÿæˆæœºå™¨ä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œæ±‡ç¼–å™¨å’Œé“¾æ¥å™¨ä¼šç¡®å®šè·³è½¬ç›®æ ‡ï¼ˆå³ç›®æ ‡æŒ‡ä»¤çš„åœ°å€ï¼‰ï¼Œå¹¶ç¼–ç ä¸ºè·³è½¬æŒ‡ä»¤çš„ä¸€éƒ¨åˆ†ã€‚å…¶ä½¿ç”¨çš„ç¼–ç æ–¹å¼æœ‰å¤šç§ï¼Œä½†å¤§å¤šæ•°ä¸ç¨‹åºè®¡æ•°å™¨ç›¸å…³ï¼Œå³æ¯”è¾ƒç›®æ ‡æŒ‡ä»¤çš„åœ°å€å’Œç´§æŒ¨ç€è·³è½¬æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ä¹‹é—´çš„å·®å¼‚ã€‚è¿™æ ·çš„è¯´æ³•æœ‰äº›ç»•å£ï¼Œæˆ‘ä»¬ä»¥ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥è¯´æ˜ï¼š\n1 2 3 4 5 6 7 8 movq %rdi%, %rax jmp .L2 .L3 sarq %rax .L2 testq %rax, %rax jg .L3 rep; ret è¯¥æ±‡ç¼–ä»£ç åŒ…å«äº†ä¸¤ä¸ªè·³è½¬æŒ‡ä»¤ï¼Œç¬¬ä¸€ä¸ªè·³è½¬åˆ°äº†æ›´é«˜çš„åœ°å€å¤„ï¼Œç¬¬äºŒä¸ªåˆ™ç›¸åã€‚è€Œä¸‹å›¾æ˜¯å¯¹ä¸Šè¿°ä»£ç æ±‡ç¼–ç„¶åå†è¿›è¡Œåæ±‡ç¼–åçš„ç»“æœï¼š\nåœ¨å³ä¾§æ³¨é‡Šä¸­ï¼Œç¬¬ä¸€ä¸ªè·³è½¬æŒ‡ä»¤ä¸º +0x8ï¼Œç¬¬äºŒä¸ªè·³è½¬æŒ‡ä»¤ä¸º +0x5ã€‚å†çœ‹å·¦ä¾§æŒ‡ä»¤çš„å­—èŠ‚ç¼–ç ï¼Œç¬¬ä¸€ä¸ªæŒ‡ä»¤çš„ç›®æ ‡è¢«ç¼–ç ä¸º 0x03ï¼Œå°†å…¶åŠ ä¸Šä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ 0x5ï¼Œå°±å¾—åˆ°äº†è·³è½¬ç›®æ ‡æŒ‡ä»¤çš„åœ°å€ï¼Œå³ç¬¬å››è¡ŒæŒ‡ä»¤çš„åœ°å€ 0x8ã€‚åŒæ ·ï¼Œç¬¬äºŒä¸ªæŒ‡ä»¤çš„ç›®æ ‡æ˜¯ä½¿ç”¨å•å­—èŠ‚äºŒè¿›åˆ¶è¡¥ç è¡¨ç¤ºçš„ 0xf8ï¼ˆå³åè¿›åˆ¶æ•° -8ï¼‰ï¼Œå°†å…¶åŠ ä¸Šä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ 0xdï¼Œå°±å¾—åˆ°äº†ç¬¬ä¸‰è¡ŒæŒ‡ä»¤çš„åœ°å€ 0x5ã€‚\nå½“ç›®æ ‡ä»£ç æ–‡ä»¶ç»è¿‡é“¾æ¥å™¨å¤„ç†åï¼Œè¿™äº›æŒ‡ä»¤ä¼šè¢«é‡æ–°åˆ†é…åœ°å€ã€‚ä¸è¿‡ç¬¬äºŒè¡Œå’Œç¬¬äº”è¡Œè·³è½¬ç›®æ ‡çš„ç¼–ç ä¾ç„¶ä¸å˜ï¼Œè¿™ç§æ–¹å¼èƒ½å¤Ÿè®©æŒ‡ä»¤ç¼–ç æ›´åŠ ç´§å‡‘ï¼š\nä½¿ç”¨æ¡ä»¶æ§åˆ¶å®ç°æ¡ä»¶åˆ†æ”¯ è‹¥æƒ³å°† C ä¸­çš„æ¡ä»¶è¡¨è¾¾å¼è½¬åŒ–ä¸ºæœºå™¨ä»£ç ï¼Œé€šå¸¸ä½¿ç”¨æ¡ä»¶è·³è½¬å’Œæ— æ¡ä»¶è·³è½¬çš„ç»„åˆã€‚ä¸€ä¸ªç®€å•çš„ C ç¨‹åºåŠå…¶ç¼–è¯‘å¾—åˆ°çš„æ±‡ç¼–ä»£ç åˆ†åˆ«å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 long absdiff(long x, long y) { long result; if (x \u003c y) result = y - x; else result = x - y; } 1 2 3 4 5 6 7 8 9 10 11 12 ; long absdiff(long x, long y) ; x in %rdi, y in %rsi absdiff: cmpq %rsi, %rdi jge .L2 movq %rsi, %rax subq %rdi, %rax ret .L2 movq %rdi, %rax subq %rsi, %rax ret å®é™…ä¸Šè¯¥æ±‡ç¼–ä»£ç çš„æ§åˆ¶æµï¼ˆControl Flowï¼‰æ›´åƒæ˜¯ä½¿ç”¨ Goto è¯­å¥å°†ç¤ºä¾‹ C ç¨‹åºæ”¹å†™åå¾—åˆ°çš„ç»“æœï¼Œå³å…ˆæ¯”è¾ƒä¸¤æ•°å¤§å°ï¼Œç„¶åæ ¹æ®ç»“æœå†³å®šæ˜¯å¦è·³è½¬ï¼š\n1 2 3 4 5 6 7 8 9 10 11 long gotodiff(long x, long y) { long result; if (x \u003e= y) goto x_ge_y; result = y - x; return result; x_ge_y: result = x - y; return result; } è®©æˆ‘ä»¬æ¨å¹¿åˆ°ä¸€èˆ¬æƒ…å†µã€‚å‡è®¾ C ä¸­çš„ If-else è¯­å¥æ¨¡æ¿ä¸ºï¼š\n1 2 3 4 if (test-expr) then-statement else else-statement é‚£ä¹ˆç¼–è¯‘ç”Ÿæˆçš„æ±‡ç¼–ä»£ç çš„æ§åˆ¶æµä¾¿å¯ä»¥ç”¨å¦‚ä¸‹ C ç¨‹åºæè¿°ï¼š\n1 2 3 4 5 6 7 8 t = test-expr; if (!t) goto false; then-statement goto done; false: else-statement done: ä½¿ç”¨æ¡ä»¶ç§»åŠ¨å®ç°æ¡ä»¶åˆ†æ”¯ ä½¿ç”¨æ¡ä»¶æ§åˆ¶å®ç°æ¡ä»¶åˆ†æ”¯è™½ç„¶ç®€å•æœ‰æ•ˆï¼Œä½†åœ¨ç°ä»£å¤„ç†å™¨ä¸Šä½¿ç”¨å¯èƒ½ååˆ†ä½æ•ˆï¼Œæˆ‘ä»¬æ›´å€¾å‘äºä½¿ç”¨ä¸€äº›ç®€å•çš„æ¡ä»¶ç§»åŠ¨æŒ‡ä»¤ã€‚ä¸Šä¸€èŠ‚ä¸­çš„ C ç¨‹åºå¯ä»¥æ”¹å†™ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 long cmovdiff(long x, long y) { long rval = y - x; long eval = x - y; long ntest = x \u003e= y; /* Line below requires single instruction: */ if (ntest) rval = eval; return rval; } è¿™æ®µä»£ç é¦–å…ˆè®¡ç®—y-xå’Œx-yï¼Œåˆ†åˆ«å‘½åä¸ºå˜é‡rvalå’Œå˜é‡evalã€‚ç„¶åæµ‹è¯•xæ˜¯å¦å¤§äºæˆ–ç­‰äºyï¼Œå¦‚æœæ˜¯ï¼Œåˆ™åœ¨è¿”å›rvalä¹‹å‰å°†evalèµ‹å€¼ç»™rvalã€‚ç¼–è¯‘å™¨å¯ä»¥å‚è€ƒè¿™ç§æ§åˆ¶æµç”Ÿæˆæ±‡ç¼–ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 ; long absdiff(long x, long y) ; x in %rdi, y in %rsi absdiff: movq %rsi, %rax subq %rdi, %rax movq %rdi, %rdx subq %rsi, %rdx cmpq %rsi, %rdi cmovge %rdx, %rax ret ä¸Šè¿°ä»£ç ä¸­çš„comovgeå°±æ˜¯ä¸€ä¸ªæ¡ä»¶ç§»åŠ¨æŒ‡ä»¤ï¼Œåªæœ‰cmpqæŒ‡ä»¤åˆ¤æ–­ä¸€ä¸ªå€¼å¤§äºæˆ–ç­‰äºï¼ˆå¦‚åç¼€ ge æ‰€ç¤ºï¼‰å¦ä¸€ä¸ªå€¼æ—¶ï¼Œå®ƒæ‰ä¼šå°†æ•°æ®ä»æºå¯„å­˜å™¨ä¼ è¾“åˆ°ç›®æ ‡å¯„å­˜å™¨ã€‚\næˆ‘ä»¬å¿…é¡»äº†è§£ç°ä»£å¤„ç†å™¨çš„è¿è¡Œæ–¹å¼ï¼Œæ‰èƒ½æ˜ç™½ä¸ºä»€ä¹ˆåŸºäºæ¡ä»¶ç§»åŠ¨çš„ä»£ç æ•ˆç‡èƒœè¿‡æ¡ä»¶æ§åˆ¶ã€‚ä¸€æ¡æŒ‡ä»¤éœ€è¦å¤„ç†å™¨é€šè¿‡ä¸€ç³»åˆ—çš„æ­¥éª¤è¿›è¡Œå¤„ç†ï¼Œæ¯ä¸ªæ­¥éª¤åªæ‰§è¡Œæ‰€è¯¥æŒ‡ä»¤çš„ä¸€å°éƒ¨åˆ†ï¼ˆä¾‹å¦‚ï¼Œä»å†…å­˜ä¸­è·å–æŒ‡ä»¤ï¼Œç¡®å®šæŒ‡ä»¤ç±»å‹ã€ä»å†…å­˜è¯»å–ã€æ‰§è¡Œç®—æœ¯è¿ç®—ã€å†™å…¥å†…å­˜å’Œæ›´æ–°ç¨‹åºè®¡æ•°å™¨ç­‰ï¼‰ã€‚ä¸ºäº†å®ç°é«˜æ€§èƒ½ï¼Œè¿™æ¡æµæ°´çº¿ï¼ˆPipeliningï¼‰éœ€è¦å°†æŒ‡ä»¤çš„æ­¥éª¤é‡å ã€‚ä¾‹å¦‚ï¼Œåœ¨æ‰§è¡Œå‰ä¸€æ¡æŒ‡ä»¤çš„ç®—æœ¯è¿ç®—çš„åŒæ—¶æå–ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚æƒ³è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œå¤„ç†å™¨éœ€è¦èƒ½å¤Ÿæå‰ç¡®å®šå³å°†æ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—ï¼Œä»¥ä¿è¯æµæ°´çº¿ä¸Šå……æ»¡æŒ‡ä»¤ã€‚\nå½“å¤„ç†å™¨é‡åˆ°æ¡ä»¶è·³è½¬ï¼ˆå³åˆ†æ”¯ï¼‰æ—¶ï¼Œå®ƒå°†é‡‡ç”¨å¤æ‚çš„é€»è¾‘æ¥é¢„æµ‹è·³è½¬æŒ‡ä»¤æ˜¯å¦è§¦å‘ã€‚å¦‚æœé¢„æµ‹ç»“æœè¶³å¤Ÿå¯é ï¼ˆç°ä»£å¾®å¤„ç†å™¨è¯•å›¾è¾¾åˆ° 90% çš„æˆåŠŸç‡ï¼‰ï¼Œæµæ°´çº¿å°±å¯ä»¥ä¿æŒæŒ‡ä»¤å……æ»¡ã€‚ä½†æ˜¯ï¼Œé”™è¯¯çš„é¢„æµ‹å°†å¯¼è‡´å¤„ç†å™¨ä¸å¾—ä¸ä¸¢å¼ƒå®ƒåœ¨æœªæ¥æŒ‡ä»¤ä¸Šå·²ç»å®Œæˆçš„å¤§éƒ¨åˆ†å·¥ä½œï¼Œä½¿ç¨‹åºæ€§èƒ½ä¸¥é‡ä¸‹é™ã€‚\nç¤ºä¾‹ä»£ç ä¸­x \u003e= yçš„åˆ¤æ–­ç»“æœæ˜¾ç„¶æ˜¯éš¾ä»¥é¢„æµ‹çš„ï¼Œè¿™ç§æƒ…å†µä¸‹ä½¿ç”¨æ¡ä»¶æ§åˆ¶ä»£ç çš„æ•ˆç‡å¾ˆä½ã€‚è€Œæ¡ä»¶ç§»åŠ¨ä»£ç å…ˆè®¡ç®—å‡ºæ‰€æœ‰å¯èƒ½çš„ç»“æœï¼Œå†æ ¹æ®æ¡ä»¶åˆ¤æ–­å†³å®šè¿”å›å€¼ã€‚è¿™æ ·æ§åˆ¶æµä¾¿ä¸å†ä¾èµ–æ•°æ®ï¼Œå¤„ç†å™¨ä¹Ÿå°±æ›´å®¹æ˜“ä¿æŒå…¶æµæ°´çº¿çš„å®Œæ•´æ€§ï¼Œä»è€Œæå‡æ‰§è¡Œæ•ˆç‡ã€‚å…¨éƒ¨çš„æ¡ä»¶ç§»åŠ¨æŒ‡ä»¤å¦‚ä¸‹ï¼š\nç¼–è¯‘å™¨å¯ä»¥ä»ç›®æ ‡å¯„å­˜å™¨çš„åç§°æ¨æ–­æ¡ä»¶ç§»åŠ¨æŒ‡ä»¤çš„æ“ä½œæ•°é•¿åº¦ï¼Œå› æ­¤ç›¸åŒçš„æŒ‡ä»¤åç§°å¯ç”¨äºä¸åŒçš„æ“ä½œæ•°é•¿åº¦ã€‚æˆ‘ä»¬åŒæ ·æŠŠæ¡ä»¶åˆ†æ”¯æ¨å¹¿åˆ°ä¸€èˆ¬æƒ…å†µï¼Œä½¿ç”¨ C ç¨‹åºæ¥æè¿°æ¡ä»¶ç§»åŠ¨çš„æ§åˆ¶æµï¼š\n1 2 3 4 5 v = then - expr; ve = else - expr; t = test - expr; if (!t) v = ve; å½“ç„¶ï¼Œä½¿ç”¨æ¡ä»¶ç§»åŠ¨æ¥å®ç°æ¡ä»¶åˆ†æ”¯æ˜¯ä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹çš„ã€‚å› ä¸ºæ— è®ºåˆ¤æ–­ç»“æœå¦‚ä½•ï¼Œæˆ‘ä»¬éƒ½ä¼šå…¨éƒ¨æ‰§è¡Œ then-expr å’Œ else-exprã€‚ä¸€æ—¦æŸä¸€ä¸ªåˆ†æ”¯ä¸­çš„æŒ‡ä»¤å‘ç”Ÿé”™è¯¯ï¼Œå°†å½±å“æ•´ä¸ªç¨‹åºçš„å¯ç”¨æ€§ã€‚å¦å¤–ï¼Œå¦‚æœ then-expr æˆ– else-expr éœ€è¦å¤§é‡è®¡ç®—ï¼Œè€Œå¯¹åº”çš„æ¡ä»¶åˆä¸æˆç«‹æ—¶ï¼Œå¤„ç†å™¨æ‰€åšçš„å·¥ä½œå°±å®Œå…¨ç™½è´¹äº†ã€‚ä¸è¿‡æ€»ä½“æ¥è¯´ï¼Œæ¡ä»¶ç§»åŠ¨çš„æ€§èƒ½è¿˜æ˜¯é«˜äºæ¡ä»¶æ§åˆ¶çš„ï¼Œè¿™ä¹Ÿæ˜¯ GCC ç¼–è¯‘å™¨ä½¿ç”¨å®ƒçš„åŸå› ã€‚\nå¾ªç¯ Do-While å‡è®¾ C ä¸­çš„ Do-While è¯­å¥æ¨¡æ¿ä¸ºï¼š\n1 2 3 do body-statement while (text-expr); æˆ‘ä»¬å¯ä»¥å°†å…¶è½¬åŒ–ä¸º Goto è¯­å¥å’Œ If-else è¯­å¥çš„ç»„åˆï¼š\n1 2 3 4 5 loop: body-statement t = text-expr; if (t) goto loop; å®é™…ä¸Šæ±‡ç¼–ä»£ç æ­£æ˜¯ç”¨è¿™ç§æ–¹å¼æ¥å®ç° Do-While è¯­å¥çš„æ§åˆ¶æµ ã€‚ç¤ºä¾‹å‡½æ•°fact_doåŠå…¶ç¼–è¯‘å¾—åˆ°çš„æ±‡ç¼–ä»£ç åˆ†åˆ«å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 long fact_do(long n) { long result = 1; do { result *= n; n = n - 1; } while (n \u003e 1); return result; } 1 2 3 4 5 6 7 8 9 10 ; long fact_do(long n) ; n in %rdi fact_do: movl $1, %eax .L2: imulq %rdi, %rax subq $1, %rdi cmpq $1, %rdi jq .L2 rep; ret While å‡è®¾ C ä¸­çš„ While è¯­å¥æ¨¡æ¿ä¸ºï¼š\n1 2 while (text-expr); body-statement æˆ‘ä»¬æœ‰ä¸¤ç§æ–¹æ³•å°†å…¶è½¬åŒ–ä¸º Goto è¯­å¥å’Œ If-else è¯­å¥çš„ç»„åˆã€‚ç¬¬ä¸€ç§è¢«ç§°ä¸º Jump-to-Middleï¼Œé€šè¿‡ä¸€ä¸ªéæ¡ä»¶è·³è½¬åœ¨å¾ªç¯çš„ç»“æŸæ‰§è¡Œæ¡ä»¶åˆ¤æ–­ï¼š\n1 2 3 4 5 6 7 goto test; loop: body-statement test: t = text-expr; if (t) goto loop; å½“ GCC çš„ä¼˜åŒ–å‚æ•°æŒ‡å®šä¸º-Ogæ—¶ï¼Œæ±‡ç¼–ä»£ç å°±ä¼šç”¨è¿™ç§æ–¹æ³•æ¥å®ç° While è¯­å¥çš„æ§åˆ¶æµ ã€‚ç¤ºä¾‹å‡½æ•°fact_whileåŠå…¶ç¼–è¯‘å¾—åˆ°çš„æ±‡ç¼–ä»£ç åˆ†åˆ«å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 long fact_while(long n) { long result = 1; while (n \u003e 1) { result *= n; n = n - 1; } return result; } 1 2 3 4 5 6 7 8 9 10 11 12 ; long fact_while(long n) ; n in %rdi fact_while: movl $1, %eax jmp .L5 .L6: imulq %rdi, %rax subq $1, %rdi .L5: cmpq $1, %rdi jg .L6 rep; ret ç¬¬äºŒç§æ–¹æ³•è¢«ç§°ä¸º Guarded-Doï¼Œå³é¦–å…ˆå°†ä»£ç è½¬åŒ–ä¸º Do-While å¾ªç¯ï¼Œå¦‚æœæ¡ä»¶åˆ¤æ–­å¤±è´¥åˆ™é€šè¿‡æ¡ä»¶ç§»åŠ¨æŒ‡ä»¤è·³è¿‡å¾ªç¯ï¼š\n1 2 3 4 5 6 7 8 9 t = test-expr; if (!t) goto done; loop: body-statement t = test-expr; if (t) goto loop; done: å½“ GCC çš„ä¼˜åŒ–å‚æ•°æŒ‡å®šä¸ºæ›´é«˜çº§åˆ«çš„-O1æ—¶ï¼Œæ±‡ç¼–ä»£ç å°±ä¼šç”¨è¿™ç§æ–¹æ³•æ¥å®ç° While è¯­å¥çš„æ§åˆ¶æµ ã€‚ä¸Šé¢æåˆ°çš„å‡½æ•°fact_whileä½¿ç”¨ Guarded-Do ç¼–è¯‘å¾—åˆ°çš„æ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 ; long fact_while(long n) ; n in %rdi fact_while cmpq $1, %rdi jle .L7 movl $1, %eax .L6: imulq %rdi, %rax subq $1, %rdi cmpq $1, %rdi jne .L6 rep; ret .L7 movl $1, %eax ret For å‡è®¾ C ä¸­çš„ For è¯­å¥æ¨¡æ¿ä¸ºï¼š\n1 2 for (init-expr; test-expr; update-expr) body-statement æ˜¾ç„¶å¯ä»¥å°†å…¶è½¬åŒ–ä¸ºç­‰æ•ˆçš„ While è¯­å¥ï¼š\n1 2 3 4 5 init-expr; while (test-expr) { body-statement update-expr; } å› æ­¤ï¼Œæˆ‘ä»¬ä¾ç„¶å¯ä»¥ä½¿ç”¨ä¸¤ç§æ–¹æ³•æ¥å°†å…¶è½¬åŒ–ä¸º Goto è¯­å¥å’Œ If-else è¯­å¥çš„ç»„åˆã€‚\nJump-to-Middleï¼š\n1 2 3 4 5 6 7 8 9 init-expr; goto test; loop: body-statement update-expr; test: t = test-expr; if (t) goto loop; Guarded-Doï¼š\n1 2 3 4 5 6 7 8 9 10 11 init-expr; t = test-expr; if (!t) goto done; loop: body-statement update-expr; t = test-expr; if (t) goto loop; done: åŒæ ·åœ°ï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ®ç»™å®šçš„ä¼˜åŒ–å‚æ•°ä½¿ç”¨å¯¹åº”çš„æ§åˆ¶æµæ¥ç”Ÿæˆæ±‡ç¼–ä»£ç ã€‚\nSwitch GCC ä¼šæ ¹æ® Switch è¯­å¥ä¸­ Case çš„æ•°é‡å’Œ Case å€¼çš„ç¨€ç–æ€§ï¼ˆSparsityï¼‰å†³å®šç¼–è¯‘æ–¹æ³•ã€‚å½“å­˜åœ¨å¤šç§ Caseï¼ˆä¾‹å¦‚å››ä¸ªæˆ–æ›´å¤šï¼‰ï¼Œä¸”å®ƒä»¬è·¨è¶Šçš„å€¼èŒƒå›´è¾ƒå°æ—¶ä¼šä½¿ç”¨ä¸€ç§åä¸ºè·³è½¬è¡¨ï¼ˆJump Tableï¼‰çš„æ•°æ®ç»“æ„æ¥å®ç°ã€‚è·³è½¬è¡¨æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„å…ƒç´ åˆ†åˆ«æ˜¯ Switch è¯­å¥ä¸­æ¯ä¸ª Case å¯¹åº”çš„ä»£ç å—åœ°å€ã€‚\nä¸€ä¸ªç®€å•çš„ C ç¨‹åºåŠå…¶é€šè¿‡ GCC ç¼–è¯‘åå¾—åˆ°çš„æ±‡ç¼–ä»£ç åˆ†åˆ«å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 void switch_eg(long x, long n, long *dest) { long val = x; switch (n) { case 100: val *= 13; break; case 102: val += 10; /* Fall through */ case 103: val += 11; break; case 104: case 106: val *= val; break; default: val = 0; break; } *dest = val; } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 ; void switch_eg(long x, long n, long *dest) ; x in %rdi, n in %rsi, dest in %rdx switch_eg: subq $100, %rsi cmpq $6, %rsi ja .L8 jmp *.L4(,%rsi,8) .L3: leaq (%rdi,%rdi,2), %rax leaq (%rdi,%rax,4), %rdi jmp .L2 .L5: addq $10, %rdi .L6: addq $11, %rdi jmp .L2 .L7: imulq %rdi, %rdi jmp .L2 .L8: movl $0, %edi .L2: movq %rdi, (%rdx) ret ä¸ºäº†ä¾¿äºç†è§£ï¼Œæˆ‘ä»¬ç”¨ C æ¥æè¿°å…¶å®ç°ï¼ˆè¿ç®—ç¬¦\u0026\u0026ä¼šä¸ºä»£ç å—çš„ä½ç½®åˆ›å»ºæŒ‡é’ˆï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 void switch_eg_impl(long x, long n, long *dest) { /* Table of code pointers */ static void *jt[7] = { \u0026\u0026loc_A, \u0026\u0026loc_def, \u0026\u0026loc_B, \u0026\u0026loc_C, \u0026\u0026loc_D, \u0026\u0026loc_def, \u0026\u0026loc_D}; unsigned long index = n - 100; long val; if (index \u003e 6) goto loc_def; /* Multiway branch */ goto *jt[index]; loc_A: /* Case 100 */ val = x * 13; goto done; loc_B: /* Case 102 */ val = x + 10; loc_C: /* Case 103 */ val = x + 11; goto done; loc_D: /* Case 104, 106 */ val = x * x; goto done; loc_def: /* Default case */ val = 0; done: *dest = val; } å…¶ä¸­çš„goto *jt[index]å°±ç›¸å½“äºæ±‡ç¼–ä»£ç ä¸­ç¬¬äº”è¡Œçš„jmp *.L4(,%rsi,8)ã€‚å®ƒæ˜¯ä¸€ä¸ªé—´æ¥è·³è½¬æŒ‡ä»¤ï¼Œå…¶æ“ä½œæ•°.L4(,%rsi,8)æŒ‡å®šäº†ç”±å¯„å­˜å™¨ %rsi ç´¢å¼•çš„å†…å­˜åœ°å€ï¼ˆæˆ‘ä»¬å°†åœ¨åç»­ç« èŠ‚è®¨è®ºæ•°ç»„æ˜¯å¦‚ä½•è½¬åŒ–ä¸ºæœºå™¨ä»£ç çš„ï¼‰ã€‚\nåœ¨æ±‡ç¼–ä»£ç ä¸­ï¼Œè·³è½¬è¡¨å°†è¢«è¡¨ç¤ºä¸ºï¼š\nåœ¨åä¸º.rodataçš„åªè¯»ç›®æ ‡ä»£ç æ®µä¸­ï¼ŒåŒ…å«äº†ç”±ä¸ƒä¸ªquadï¼ˆå…«å­—èŠ‚ï¼‰ç»„æˆçš„åºåˆ—ï¼Œæ¯ä¸ªquadçš„å€¼ä¸ºæ±‡ç¼–ä»£ç æ ‡ç­¾ï¼ˆå¦‚.L3ï¼‰æ‰€å¯¹åº”çš„æŒ‡ä»¤åœ°å€ã€‚\nè¿‡ç¨‹ è¿‡ç¨‹ï¼ˆProcedureï¼‰åœ¨ä¸åŒçš„ç¼–ç¨‹è¯­è¨€ä¸­æœ‰ä¸åŒçš„å«æ³•ï¼Œå¦‚å‡½æ•°ï¼ˆFunctionï¼‰ã€æ–¹æ³•ï¼ˆMethodï¼‰ã€å­ç¨‹åºï¼ˆSubroutineï¼‰å’Œå¤„ç†å™¨ï¼ˆHandlerï¼‰ç­‰ï¼Œä¸è¿‡å®ƒä»¬éƒ½æä¾›äº†ä¸€ç§æ‰“åŒ…ä»£ç çš„æ–¹æ³•ã€‚è¯¥ä»£ç ä½¿ç”¨ä¸€ç»„å‚æ•°å’Œå¯é€‰çš„è¿”å›å€¼æ¥å®ç°æŸäº›åŠŸèƒ½ï¼Œå¹¶å¯ä»¥åœ¨ç¨‹åºçš„ä¸åŒä½ç½®è°ƒç”¨ã€‚\nå‡è®¾è¿‡ç¨‹ P è°ƒç”¨äº†è¿‡ç¨‹ Qï¼ŒQ æ‰§è¡Œå®Œæ¯•åè¿”å› Pã€‚é‚£ä¹ˆï¼š\nä¼ é€’æ§åˆ¶ï¼šåœ¨è°ƒç”¨ Q æ—¶ç¨‹åºè®¡æ•°å™¨å¿…é¡»è®¾ç½®ä¸ºå…¶ä»£ç åœ°å€ï¼ŒåŒæ—¶åœ¨è¿”å› P æ—¶ä¹Ÿè¦ç½®ä¸º P çš„ä»£ç åœ°å€ï¼› ä¼ é€’å‚æ•°ï¼šP å¿…é¡»èƒ½å‘ Q æä¾›ä¸€ä¸ªæˆ–å¤šä¸ªå‚æ•°ï¼Œåä¹‹ Q å¿…é¡»èƒ½å°†å€¼è¿”å›ç»™ Pï¼› åˆ†é…å’Œé‡Šæ”¾å†…å­˜ï¼šåœ¨è°ƒç”¨ Q ä¹‹å‰å¯èƒ½éœ€è¦ä¸ºå…¶å±€éƒ¨å˜é‡åˆ†é…å†…å­˜ç©ºé—´ï¼Œå¹¶åœ¨è¿”å›æ—¶é‡Šæ”¾ã€‚ è¿è¡Œæ—¶æ ˆ å½“è¿‡ç¨‹æ‰€éœ€çš„å­˜å‚¨ç©ºé—´è¶…è¿‡å¯„å­˜å™¨æ‰€èƒ½å®¹çº³çš„èŒƒå›´æ—¶ï¼Œå®ƒä¾¿ä¼šåœ¨è¿è¡Œæ—¶æ ˆä¸Šåˆ†é…ç©ºé—´ã€‚ä¸Šå›¾ä¸ºè¿è¡Œæ—¶æ ˆçš„ä¸€èˆ¬ç»“æ„ï¼Œä¸»è¦ç”±æ‰§è¡Œè¿‡ç¨‹ Q å’Œè°ƒç”¨è¿‡ç¨‹ P æ‰€éœ€çš„å¸§ï¼ˆFrameï¼‰ç»„æˆã€‚æ¯ä¸ªè¿‡ç¨‹å¯ä»¥åœ¨å…¶æ ˆå¸§å†…ä¿å­˜å¯„å­˜å™¨çš„å€¼ï¼ˆå›¾ä¸­çš„â€œSaved Registersâ€ï¼‰ï¼Œä¸ºå±€éƒ¨å˜é‡åˆ†é…ç©ºé—´ï¼ˆå›¾ä¸­çš„â€œLocal Variablesâ€ï¼‰ï¼Œä»¥åŠä¸ºå…¶è°ƒç”¨çš„è¿‡ç¨‹è®¾ç½®å‚æ•°ï¼ˆå›¾ä¸­çš„â€œArgumentâ€ï¼‰ç­‰ã€‚å½“ P è°ƒç”¨ Q æ—¶ï¼Œå®ƒä¼šå°†è¿”å›åœ°å€ï¼ˆå›¾ä¸­â€œReturn Addressâ€ï¼‰å‹å…¥æ ˆä¸­ã€‚è¿™æ ·å½“ Q è¿”å›æ—¶ï¼Œç¨‹åºä¾¿çŸ¥é“åº”è¯¥åœ¨å“ªé‡Œæ¢å¤æ‰§è¡Œ Pã€‚\nä¸è¿‡å‡ºäºå¯¹æ—¶é—´å’Œç©ºé—´æ•ˆç‡çš„è€ƒè™‘ï¼Œç¨‹åºåªä¼šä¸ºè¿‡ç¨‹åˆ†é…å®ƒä»¬å¿…é¡»çš„æ ˆå¸§ã€‚ä¾‹å¦‚æŸä¸ªè¿‡ç¨‹çš„å‚æ•°ä¸è¶³ 6 ä¸ªï¼Œé‚£ä¹ˆå®ƒä»¬å°†å…¨éƒ¨å­˜å‚¨åœ¨å¯„å­˜å™¨ä¸­è€Œéè¿è¡Œæ—¶æ ˆï¼ˆå›¾ä¸­çš„å‚æ•°åŒºæ˜¯ä» Argument 7 å¼€å§‹çš„ï¼‰ã€‚è®¸å¤šè¿‡ç¨‹çš„å±€éƒ¨å˜é‡å¾ˆå°‘ä¸”ä¸è°ƒç”¨å…¶ä»–è¿‡ç¨‹ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦è¿è¡Œæ—¶æ ˆã€‚\næ¥ä¸‹æ¥æˆ‘ä»¬ä¼šå¯¹è¿è¡Œæ—¶æ ˆä¸­çš„å„ä¸ªåŒºåŸŸè¿›è¡Œæ›´ä¸ºæ·±å…¥åœ°è®¨è®ºã€‚\nä¼ é€’æ§åˆ¶ åœ¨æ±‡ç¼–ä»£ç ä¸­ï¼Œè¿‡ç¨‹é—´è°ƒç”¨æ˜¯é€šè¿‡æŒ‡ä»¤callå’Œretæ¥å®ç°çš„ã€‚å…¶ä¸­ï¼ŒæŒ‡ä»¤call Qä¼šå°†ç¨‹åºè®¡æ•°å™¨è®¾ç½®ä¸ºè¿‡ç¨‹ Q ä»£ç çš„èµ·å§‹åœ°å€ï¼Œå¹¶å°†è¿”å›åœ°å€ A å‹å…¥æ ˆä¸­ã€‚æŒ‡ä»¤retåˆ™ä¼šå°†åœ°å€ A ä»æ ˆä¸­å¼¹å‡ºï¼Œç„¶åå°†ç¨‹åºè®¡æ•°å™¨è®¾ç½®ä¸º Aã€‚å®é™…ä¸Šï¼Œåœ°å€ A å°±æ˜¯ç´§è·Ÿåœ¨callæŒ‡ä»¤ä¹‹åçš„æŒ‡ä»¤çš„åœ°å€ã€‚\nä¸‹å›¾è¯´æ˜äº† ä»£ç ç¤ºä¾‹ ä¸­ä¸»å‡½æ•°è°ƒç”¨multstoreåè¿”å›çš„è¿‡ç¨‹ä¸­è¿è¡Œæ—¶æ ˆçš„å˜åŒ–æƒ…å†µï¼š\nå…¶å¯¹åº”çš„åæ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š\nå½“ä¸»å‡½æ•°è°ƒç”¨å‡½æ•°multstoreæ—¶ï¼Œç¨‹åºè®¡æ•°å™¨ %rip ä¸­çš„å€¼ä¸ºcallæŒ‡ä»¤çš„åœ°å€ 0x400563ã€‚è¯¥æŒ‡ä»¤å°†è¿”å›åœ°å€ 0x400568 å‹å…¥æ ˆä¸­å¹¶è·³è½¬åˆ°å‡½æ•°multstoreä¸­çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ï¼Œå…¶åœ°å€ä¸º 0x0400540ã€‚ éšåå‡½æ•°multstoreç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°é‡åˆ°åœ°å€ 0x40054d å¤„çš„retæŒ‡ä»¤ã€‚ è¯¥æŒ‡ä»¤å°†è¿”å›åœ°å€ 0x400568 ä»æ ˆä¸­å¼¹å‡ºå¹¶è·³è½¬åˆ°è¯¥åœ°å€å¯¹åº”çš„æŒ‡ä»¤ï¼Œä¸»å‡½æ•°å¾—ä»¥ç»§ç»­æ‰§è¡Œã€‚\nä¼ é€’å‚æ•° åœ¨ x86-64 æœºå™¨ä¸Šï¼Œæœ€å¤šå¯ä»¥é€šè¿‡å¯„å­˜å™¨ä¼ é€’å…­ä¸ªå‚æ•°ï¼š\nç¬¬ä¸ƒä¸ªåŠä¹‹åçš„å‚æ•°å°†å­˜å‚¨åœ¨è¿è¡Œæ—¶æ ˆä¸­ã€‚ä¸€ä¸ªç®€å•çš„ C ç¨‹åºåŠå…¶é€šè¿‡ GCC ç¼–è¯‘åå¾—åˆ°çš„æ±‡ç¼–ä»£ç åˆ†åˆ«å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 void proc(long a1, long *a1p, int a2, int *a2p, short a3, short *a3p, char a4, char *a4p) { *a1p += a1; *a2p += a2; *a3p += a3; *a4p += a4; } è™½ç„¶å‚æ•°a4çš„ç±»å‹ä¸ºcharï¼Œä½†ç¨‹åºåˆ†åˆ«é€šè¿‡8(%rsp)å’Œ16(%rsp)æ¥å¯¹å®ƒå’ŒæŒ‡é’ˆç±»å‹çš„a4pè¿›è¡Œå¯»å€ï¼Œè¯´æ˜ä¸¤è€…å‡å ç”¨äº†æ ˆä¸­ 8 ä¸ªå­—èŠ‚çš„ç©ºé—´ã€‚å‚æ•°çš„æ ˆå¸§ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nå±€éƒ¨å˜é‡ æŸäº›æƒ…å†µä¸‹ï¼Œå±€éƒ¨å˜é‡å¿…é¡»å­˜å‚¨åœ¨è¿è¡Œæ—¶æ ˆä¸­ï¼š\næ²¡æœ‰è¶³å¤Ÿçš„å¯„å­˜å™¨æ¥å­˜å‚¨å±€éƒ¨å˜é‡ï¼› ç¨‹åºéœ€è¦å¯¹å±€éƒ¨å˜é‡è¿›è¡Œå–åœ°å€ï¼ˆ\u0026ï¼‰æ“ä½œï¼› å±€éƒ¨å˜é‡çš„ç±»å‹ä¸ºæ•°ç»„æˆ–ç»“æ„ä½“ï¼ˆæˆ‘ä»¬å°†åœ¨åç»­çš„ç« èŠ‚ä¸­è®¨è®ºè¿™ç§æƒ…å†µï¼‰ã€‚ ç¤ºä¾‹å‡½æ•°call_procçš„ä»£ç å¦‚ä¸‹ï¼Œå…¶ä¸­è°ƒç”¨çš„å‡½æ•°procåœ¨ä¸Šä¸€èŠ‚ä¸­å·²æœ‰ä»‹ç»ï¼š\n1 2 3 4 5 6 7 8 9 long call_proc() { long x1 = 1; int x2 = 2; short x3 = 3; char x4 = 4; proc(x1, \u0026x1, x2, \u0026x2, x3, \u0026x3, x4, \u0026x4); return (x1 + x2) * (x3 - x4); } è¯¥ C ç¨‹åºç”Ÿæˆçš„æ±‡ç¼–ä»£ç ååˆ†å†—é•¿ï¼Œä½†å€¼å¾—æˆ‘ä»¬è®¤çœŸé˜…è¯»å’Œç ”ç©¶ï¼š\nå›¾ä¸­â€œSet up arguments to procâ€é˜¶æ®µå¯¹åº”çš„æ ˆå¸§ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå±€éƒ¨å˜é‡x1åˆ°x4å­˜å‚¨åœ¨æ ˆä¸­ä¸”æœ‰ç€ä¸åŒçš„å¤§å°ï¼Œåˆ†åˆ«å ç”¨å­—èŠ‚ 24-31ã€20-23ã€18-19 å’Œ 17ã€‚æŒ‡å‘è¿™äº›å‚æ•°çš„æŒ‡é’ˆå‡é€šè¿‡æŒ‡ä»¤leaqç”Ÿæˆï¼Œåˆ†åˆ«å¯¹åº”æ±‡ç¼–ä»£ç ä¸­çš„ç¬¬ 7ã€10ã€12 å’Œ 14 è¡Œã€‚å‰å…­ä¸ªå‚æ•°é€šè¿‡å¯„å­˜å™¨ä¼ é€’ï¼Œè€Œç¬¬ä¸ƒä¸ªå’Œç¬¬å…«ä¸ªå‚æ•°åˆ™å­˜å‚¨åœ¨æ ˆä¸­ï¼Œç›¸å¯¹äºæ ˆæŒ‡é’ˆ %rsp çš„åç§»é‡ä¸º 0 å’Œ 8ã€‚\nå½“ç¨‹åºæ‰§è¡Œåˆ°â€œCall procâ€é˜¶æ®µæ—¶ï¼Œç”±äºè°ƒç”¨äº†å‡½æ•°procï¼Œå› æ­¤è¿”å›åœ°å€éœ€è¦è¢«å‹å…¥åˆ°æ ˆé¡¶ã€‚æ­¤æ—¶çš„æ ˆå¸§ç»“æ„å’Œä¸Šä¸€èŠ‚å±•ç¤ºçš„ç›¸åŒï¼Œç¬¬ä¸ƒä¸ªå‚æ•°å’Œç¬¬å…«ä¸ªå‚æ•°ç›¸å¯¹äºæ ˆæŒ‡é’ˆ %rsp çš„åç§»é‡åˆ†åˆ«å˜ä¸ºäº† 8 å’Œ 16ã€‚\nè¢«ä¿å­˜çš„å¯„å­˜å™¨ å½“ä¸€ä¸ªè¿‡ç¨‹ï¼ˆè°ƒç”¨è€…ï¼‰åœ¨è°ƒç”¨å¦ä¸€ä¸ªè¿‡ç¨‹ï¼ˆè¢«è°ƒç”¨è€…ï¼‰æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»ä¿è¯è¢«è°ƒç”¨è€…çš„æ‰§è¡Œä¸ä¼šå½±å“åˆ°è°ƒç”¨è€…åç»­è®¡åˆ’ä½¿ç”¨çš„å¯„å­˜å™¨å€¼ã€‚å› æ­¤ï¼Œx86-64 è§„å®šå¯„å­˜å™¨ %rbxã€%rbp å’Œ %r12â€“%r15 ä¸ºè¢«è°ƒç”¨è€…ä¿å­˜ï¼ˆCallee-savedï¼‰å¯„å­˜å™¨ã€‚è¢«è°ƒç”¨è€…é€šè¿‡å°†ä¸Šè¿°å¯„å­˜å™¨ä¸­çš„å€¼å‹å…¥æ ˆä¸­ï¼Œç„¶ååœ¨è¿”å›æ—¶å°†åŸå§‹å€¼å¼¹å‡ºä»¥å®ç°è°ƒç”¨å‰åå¯„å­˜å™¨çš„å€¼ä¸å˜ã€‚é™¤æ ˆæŒ‡é’ˆ %rsp ä»¥å¤–çš„å…¶ä»–å¯„å­˜å™¨åˆ™ä¸ºè°ƒç”¨è€…ä¿å­˜ï¼ˆCaller-savedï¼‰å¯„å­˜å™¨ï¼Œç”±äºè¢«è°ƒç”¨è€…å¯ä»¥éšæ„ä¿®æ”¹å…¶ä¸­çš„å€¼ï¼Œå› æ­¤è°ƒç”¨è€…æœ‰è´£ä»»ä¿å­˜è°ƒç”¨ä¹‹å‰çš„æ•°æ®ã€‚\né€’å½’ x86-64 å…è®¸è¿‡ç¨‹ä»¥é€’å½’ï¼ˆRecursiveï¼‰çš„æ–¹å¼è°ƒç”¨è‡ªèº«ï¼Œè¿™æ˜¯å› ä¸ºæ¯ä¸ªè¿‡ç¨‹åœ¨è¿è¡Œæ—¶æ ˆä¸Šçš„ç©ºé—´æ˜¯ç§æœ‰çš„ï¼Œå› æ­¤å¤šä¸ªæœªå®Œæˆè°ƒç”¨çš„å±€éƒ¨å˜é‡ä¸ä¼šäº’ç›¸å¹²æ‰°ã€‚é€’å½’è°ƒç”¨å®è´¨ä¸Šå’Œè°ƒç”¨ä¸€ä¸ªå…¶ä»–è¿‡ç¨‹æ²¡æœ‰åŒºåˆ«ã€‚\næ•°ç»„ å¯¹äºé•¿åº¦ä¸º L çš„æ•°æ®ç±»å‹ T å’Œæ•´å‹å¸¸é‡ Nï¼Œå£°æ˜T A[N]ä»£è¡¨ï¼š\nå†…å­˜ä¸­å°†ä¸ºå…¶åˆ†é… L * N å¤§å°çš„ç©ºé—´ï¼› æ•°ç»„åç§° A ä¸ºæŒ‡å‘æ•°ç»„å¤´éƒ¨ï¼ˆè®¾ä¸º$x_A$ï¼‰çš„æŒ‡é’ˆï¼Œä»»æ„æ•°ç»„å…ƒç´  i çš„åœ°å€ä¸º $x_A$ + L * iã€‚ åœ¨ x86-64 ä¸­ï¼Œå†…å­˜å¼•ç”¨æŒ‡ä»¤çš„è®¾è®¡æ—¨åœ¨ç®€åŒ–å¯¹æ•°ç»„å…ƒç´ çš„è®¿é—®ã€‚ä¾‹å¦‚intç±»å‹çš„æ•°ç»„E[i]ï¼ŒEçš„åœ°å€å­˜å‚¨åœ¨å¯„å­˜å™¨ %rdx ä¸­ï¼Œi åˆ™å­˜å‚¨åœ¨å¯„å­˜å™¨ %rcx ä¸­ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æŒ‡ä»¤movl(%rdx, %rcx, 4), %eaxæ¥å°†ç›®æ ‡æ•°ç»„å…ƒç´ æ‹·è´åˆ°å¯„å­˜å™¨ %eax ä¸­ã€‚\nC å…è®¸æˆ‘ä»¬å¯¹æŒ‡é’ˆè¿›è¡Œè®¡ç®—ã€‚å‡è®¾æŒ‡é’ˆpæŒ‡å‘ä¸€ä¸ªé•¿åº¦ä¸º Lã€æ•°æ®ç±»å‹ä¸º T çš„æ•°ç»„ä¸”å…¶å€¼ä¸º $x_p$ï¼Œåˆ™è¡¨è¾¾å¼p + içš„å€¼ä¸º $x_p$ + L * iã€‚è¿›ä¸€æ­¥åœ°ï¼Œä»»æ„æ•°ç»„å…ƒç´ A[i]å°±ç­‰æ•ˆäºè¡¨è¾¾å¼*(A + i)ã€‚\nè¿˜æ˜¯ä»¥æ•°ç»„E[i]ä¸ºä¾‹ï¼Œä¸€äº›æŒ‡é’ˆç®—æ•°è¡¨è¾¾å¼çš„ç»“æœå’Œå¯¹åº”çš„æ±‡ç¼–æŒ‡ä»¤å¦‚ä¸‹ï¼š\næœ€åä¸€ä¸ªä¾‹å­è¡¨æ˜ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—åŒä¸€æ•°æ®ç»“æ„ä¸­ä¸¤ä¸ªæŒ‡é’ˆçš„å·®å€¼ã€‚å…¶ç»“æœçš„æ•°æ®ç±»å‹ä¸ºlongï¼Œ å€¼ä¸ºä¸¤ä¸ªåœ°å€çš„å·®å€¼é™¤ä»¥æ•°æ®ç±»å‹çš„é•¿åº¦ã€‚\nå¤šç»´æ•°ç»„ å¤šç»´æ•°ç»„å¯ä»¥è½¬åŒ–ä¸ºä¸€èˆ¬æ•°ç»„çš„å½¢å¼ï¼Œä¾‹å¦‚å£°æ˜int A[5][3]å°±ç­‰æ•ˆä¸ºï¼š\n1 2 typedef int row3_t[3]; row3_t A[5]; æ•°æ®ç±»å‹row3_tæ˜¯ä¸€ä¸ªåŒ…å«ä¸‰ä¸ªæ•´å‹çš„æ•°ç»„ï¼Œè€Œæ•°ç»„Aåˆ™åŒ…å«äº”ä¸ªè¿™æ ·çš„å…ƒç´ ã€‚æˆ‘ä»¬å°†å…¶æ¨å¹¿åˆ°ä¸€èˆ¬æƒ…å†µï¼Œè‹¥ä¸€ä¸ªæ•°ç»„å£°æ˜ä¸ºT D[R][C]ï¼Œåˆ™æ•°ç»„å…ƒç´ D[i][j]åœ¨å†…å­˜ä¸­çš„åœ°å€ä¸ºï¼š\n$$\\tag{3.1} \\And D[i][j] = x_D + L(C * i + j)$$\nå…¶ä¸­ï¼Œ$x_D$ ä¸ºæ•°ç»„åœ°å€ï¼ŒL ä¸ºæ•°ç»„å…ƒç´ çš„é•¿åº¦ã€‚\nä¸€ä¸ª 5 X 3 çš„æ•´å‹æ•°ç»„Aï¼Œå…¶ä»»æ„æ•°ç»„å…ƒç´  A[i][j] çš„åœ°å€ç”¨æ±‡ç¼–ä»£ç çš„è¡¨ç¤ºç»“æœä¸ºï¼š\n1 2 3 4 5 6 7 ; A in %rdi, i in % rsi and j in %rdx ; Compute 3i leaq (%rsi, %rsi, 2), %rax ; Compute A + 12i leaq (%rdi, %rax, 4), %rax ; Read from M[A + 12i + 4j] movl (%rax, %rdx, 4), %rax å®šé•¿æ•°ç»„ ç¼–è¯‘å™¨å¯ä»¥å¯¹ä¸€äº›æ“ä½œå®šé•¿å¤šç»´æ•°ç»„çš„ä»£ç è¿›è¡Œä¼˜åŒ–ã€‚ä¾‹å¦‚ç¤ºä¾‹ C ç¨‹åºæ‰§è¡ŒçŸ©é˜µè¿ç®—ï¼š\n1 2 3 4 5 6 7 8 9 10 11 #define N 16 typedef int fix_matrix[N][N]; /* Compute i,k of fixed matrix product */ int fix_prod_ele(fix_matrix A, fix_matrix B, long i, long k) { long j; int result = 0; for (j = 0; j \u003c N; j++) result += A[i][j] * B[j][k]; return result; } å®ƒå¯ä»¥è¢«ä¼˜åŒ–ä¸ºä¸‹åˆ—ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 #define N 16 typedef int fix_matrix[N][N]; /* Compute i,k of fixed matrix product */ fix_prod_ele_opt(fix_matrix A, fix_matrix B, long i, long k) { int *Aptr = \u0026A[i][0]; /* Points to elements in row i of A */ int *Bptr = \u0026B[0][k]; /* Points to elements in column k of B */ int *Bend = \u0026B[N][k]; /* Marks stopping point for Bptr */ int result = 0; do { /* No need for initial test */ result += *Aptr * *Bptr; /* Add next product to sum */ Aptr++; /* Move Aptr to next column */ Bptr += N; /* Move Bptr to next row */ } while (Bptr != Bend); /* Test for stopping point */ return result; } æ¯”è¾ƒä¸¤è€…æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œä¼˜åŒ–ä»£ç æ²¡æœ‰ä½¿ç”¨ç´¢å¼• jï¼Œå¹¶å°†æ‰€æœ‰çš„æ•°ç»„å¼•ç”¨éƒ½è½¬æ¢ä¸ºäº†æŒ‡é’ˆå¼•ç”¨ã€‚å…¶ä¸­ï¼ŒAptræŒ‡å‘çŸ©é˜µ A ä¸­ç¬¬ i è¡Œä¸­çš„è¿ç»­å…ƒç´ ï¼ŒBptræŒ‡å‘çŸ©é˜µ B ä¸­ç¬¬ k åˆ— ä¸­çš„è¿ç»­å…ƒç´ ã€‚Bendåˆ™æŒ‡å‘çŸ©é˜µ B ä¸­ç¬¬ k åˆ—ä¸­çš„ç¬¬ N + 1 ä¸ªå…ƒç´ ï¼Œå®ƒå°±ç­‰äºå¾ªç¯ç»“æŸæ—¶Bptrçš„å€¼ã€‚\nå˜é•¿æ•°ç»„ C åªæ”¯æŒå¯ä»¥åœ¨ç¼–è¯‘æ—¶ç¡®å®šé•¿åº¦çš„å¤šç»´æ•°ç»„(ä¸€ç»´å¯èƒ½é™¤å¤–ï¼‰ï¼Œå£°æ˜å¯å˜å¤§å°çš„æ•°ç»„æ—¶å¿…é¡»ä½¿ç”¨mallocæˆ–callocç­‰å‡½æ•°æ¥åˆ†é…æ•°ç»„çš„å­˜å‚¨ç©ºé—´ï¼Œå¹¶ä¸”éœ€è¦é€šè¿‡è¡Œä¸»ç´¢å¼•ï¼ˆRow-major Indexingï¼‰å°†å¤šç»´æ•°ç»„çš„æ˜ å°„æ˜¾å¼åœ°ç¼–ç ä¸ºä¸€ç»´æ•°ç»„ï¼ˆå°±åƒ å…¬å¼ 3.1 åšçš„é‚£æ ·ï¼‰ã€‚\næˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªå‡½æ•°æ¥è®¿é—® n Ã— n æ•°ç»„çš„å…ƒç´ A[i][j]ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n1 2 3 4 int var_ele(long n, int A[n][n], long i, long j) { return A[i][j]; } å‚æ•°nå¿…é¡»åœ¨å‚æ•°A[n][n]ä¹‹å‰ï¼Œè¿™æ ·å‡½æ•°åœ¨å¤„ç†æ•°ç»„æ—¶æ‰èƒ½å¤Ÿæ˜ç¡®å…¶ç»´åº¦ã€‚è¯¥ç¨‹åºç» GCC ç¼–è¯‘å¾—åˆ°çš„æ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 ; int var_ele(long n, int A[n][n], long i, long j) ; n in %rdi, A in %rsi, i in %rdx, j in %rcx var_ele: ï¼› Compute n * i imulq %rdx, %rdi ; Compute A + 4(n * i) leaq (%rsi,%rdi,4), %rax ; Read from M[A + 4(n * i) + j] movl (%rax,%rcx,4), %eax ret æ•°ç»„å…ƒç´ A[i][j]åœ°å€çš„è®¡ç®—æ–¹å¼ä¸å®šé•¿å¤šç»´æ•°ç»„ç±»ä¼¼ï¼Œå³ $x_A + 4(n * i) + 4j = x_A + 4(n * i + j)$ã€‚åŒºåˆ«ä¹‹å¤„åœ¨äºï¼š\nç”±äºæ·»åŠ äº†å˜é‡nï¼Œå¯„å­˜å™¨çš„ä½¿ç”¨æ–¹å¼ä¸åŒï¼› ä½¿ç”¨äº†ä¹˜æ³•æŒ‡ä»¤imulqè€Œä¸æ˜¯leaqæ¥è®¡ç®—n * iï¼Œå› æ­¤ç¨‹åºçš„æ€§èƒ½å°†ä¼šä¸‹é™ã€‚ æ— è®ºæ•°ç»„çš„é•¿åº¦æ˜¯å¦ä¸ºå¸¸é‡ï¼Œç¼–è¯‘å™¨éƒ½ä¼šå¯¹æ“ä½œå¤šç»´æ•°ç»„çš„ä»£ç è¿›è¡Œä¸€å®šä¼˜åŒ–ã€‚è™½ç„¶äºŒè€…å®ç°çš„ç»†èŠ‚æœ‰æ‰€å·®å¼‚ï¼Œä½†å…¶å®—æ—¨æ˜¯ä¸€è‡´çš„ï¼šé¿å…ç›´æ¥ä½¿ç”¨ å…¬å¼ 3.1 è€Œå¯¼è‡´çš„ä¹˜æ³•è¿ç®—ã€‚\nå¼‚æ„æ•°æ®ç»“æ„ ç»“æ„ä½“ ç»“æ„ä½“ï¼ˆStructureï¼‰çš„æ¯ä¸ªéƒ¨åˆ†éƒ½å­˜å‚¨åœ¨è¿ç»­çš„å†…å­˜ç©ºé—´ä¸­ï¼ŒæŒ‡å‘ç»“æ„ä½“çš„æŒ‡é’ˆæ˜¯å…¶ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åœ°å€ã€‚ä¸€ä¸ªç®€å•çš„ç»“æ„ä½“å£°æ˜å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 struct rec { int i; int j; int a[2]; int *p; }; è¯¥ç»“æ„ä½“åŒ…å«äº†å››ä¸ªå­—æ®µï¼šä¸¤ä¸ªå››å­—èŠ‚çš„intå˜é‡ï¼Œä¸€ä¸ªä¸¤å…ƒç´ çš„intå‹æ•°ç»„å’Œä¸€ä¸ªå…«å­—èŠ‚çš„intå‹æŒ‡é’ˆï¼Œå…±å ç”¨ 24 å­—èŠ‚çš„å†…å­˜ç©ºé—´ï¼š\næ±‡ç¼–ä»£ç å¯ä»¥é€šè¿‡åœ¨ç»“æ„ä½“åœ°å€ä¸Šæ·»åŠ é€‚å½“çš„åç§»é‡æ¥è®¿é—®ç»“æ„ä½“ä¸­çš„ä»»æ„å­—æ®µã€‚å‡è®¾structure rec *ç±»å‹çš„å˜é‡rå­˜å‚¨åœ¨å¯„å­˜å™¨ %rdi ä¸­ï¼Œé‚£ä¹ˆä¸‹åˆ—ä»£ç å°†å…ƒç´ r -\u003e iï¼Œå³(*r).iï¼Œæ‹·è´åˆ°r -\u003e jï¼š\n1 2 movl (%rdi), %eax movl %eax, 4(%rdi) åŒæ ·ï¼Œå¦‚æœæˆ‘ä»¬è¦è·å–ç»“æ„ä½“ä¸­æ•°ç»„å…ƒç´ rec.a[i]çš„åœ°å€\u0026(r -\u003e a[i])ï¼Œåªéœ€ï¼š\n1 2 ; r in %rdi, i in %rdi leaq 8(%rdi, %rsi, 4), %rax å¦‚ä¸Šè¿°æ±‡ç¼–ä»£ç æ‰€ç¤ºï¼Œç¨‹åºå¯¹ç»“æ„ä½“å­—æ®µçš„é€‰æ‹©æ˜¯åœ¨ç¼–è¯‘æ—¶å®Œæˆçš„ï¼Œå› æ­¤æœºå™¨ä»£ç ä¸­ä¸å«æœ‰ä»»ä½•æœ‰å…³å­—æ®µå£°æ˜æˆ–å­—æ®µåç§°çš„ä¿¡æ¯ã€‚\nè”åˆä½“ è”åˆä½“ï¼ˆUnionsï¼‰çš„å£°æ˜å’Œè¯­æ³•ä¸ç»“æ„ä½“ç›¸åŒï¼Œä½†å…¶ä¸åŒå­—æ®µå‡å¼•ç”¨ç›¸åŒçš„å†…å­˜ç©ºé—´ã€‚ä¾‹å¦‚ä¸€ä¸ªç»“æ„ä½“å’Œä¸€ä¸ªè”åˆä½“çš„å£°æ˜å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 struct S3 { char c; int i[2]; double v; }; union U3 { char c; int i[2]; double v; }; é‚£ä¹ˆS3å’ŒU3å„ä¸ªå­—æ®µçš„åç§»é‡å’Œæ€»æ•°æ®é•¿åº¦ä¸ºï¼š\nType c i v Size S3 0 4 16 24 U3 0 0 0 8 å¯¹äºç±»å‹ä¸ºunion U3 *çš„æŒ‡é’ˆpï¼Œè¡¨è¾¾å¼p -\u003e cï¼Œp -\u003e i[0]å’Œp -\u003e véƒ½å°†å¼•ç”¨è”åˆä½“çš„èµ·å§‹åœ°å€ã€‚è”åˆä½“çš„é•¿åº¦ç­‰äºå…¶æ‰€æœ‰å­—æ®µä¸­æœ€å¤§çš„æ•°æ®é•¿åº¦ï¼Œè€Œç»“æ„ä½“åˆ™ç­‰äºå…¶æ‰€æœ‰å­—æ®µé•¿åº¦çš„å’Œã€‚æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€èŠ‚ æ•°æ®å¯¹é½ ä¸­ä»‹ç»ä¸ºä»€ä¹ˆiåœ¨S3ä¸­çš„åç§»é‡æ˜¯ 4 è€Œä¸æ˜¯ 1ï¼Œä»¥åŠvçš„åç§»é‡æ˜¯ 16ï¼Œè€Œä¸æ˜¯ 9 æˆ– 12ã€‚\nå¦‚æœä¸€ä¸ªæ•°æ®ç»“æ„ä¸­çš„ä¸¤ä¸ªå­—æ®µæ˜¯äº’æ–¥ï¼ˆMutually Exclusiveï¼‰çš„ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è”åˆä½“æ¥å‡å°‘ç©ºé—´æµªè´¹ã€‚å‡å¦‚å­˜åœ¨ä¸€ä¸ªäºŒå‰æ ‘ï¼Œå…¶æ¯ä¸ªå¶èŠ‚ç‚¹ï¼ˆLeaf nodeï¼‰éƒ½æœ‰ä¸¤ä¸ªåŒç²¾åº¦æµ®ç‚¹å€¼ï¼Œæ¯ä¸ªå†…éƒ¨èŠ‚ç‚¹ï¼ˆInternal nodeï¼‰éƒ½æœ‰ä¸¤ä¸ªæŒ‡å‘å­èŠ‚ç‚¹çš„æŒ‡é’ˆã€‚é‚£ä¹ˆä½¿ç”¨ç»“æ„ä½“å®ç°è¯¥æ•°æ®ç»“æ„çš„ä»£ç ä¸ºï¼š\n1 2 3 4 5 6 7 8 struct node_s { // for internal node struct node_s *left; struct node_s *right; // for leaf node double data[2]; }; è¿™æ ·æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦å ç”¨ 32 å­—èŠ‚çš„ç©ºé—´ï¼Œå…¶ä¸­åªæœ‰ä¸€åŠä¼šè¢«èŠ‚ç‚¹çœŸæ­£ä½¿ç”¨ã€‚è€Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨è”åˆä½“æ¥å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 union node_u { struct { union node_u *left; union node_u *right; } internal; double data[2]; }; åˆ™æ¯ä¸ªèŠ‚ç‚¹å°±åªéœ€å ç”¨ 16 ä¸ªå­—èŠ‚çš„ç©ºé—´ã€‚å¯¹äºç±»å‹ä¸ºunion node_u *çš„æŒ‡é’ˆnï¼Œå¶èŠ‚ç‚¹å¯ä»¥ç”¨n -\u003e data[0]å’Œn -\u003e data[1]æ¥è¡¨ç¤ºï¼Œè€Œå†…éƒ¨èŠ‚ç‚¹æŒ‡å‘çš„å­èŠ‚ç‚¹å¯ä»¥ç”¨n -\u003e internal.leftå’Œn -\u003e internal.rightæ¥è¡¨ç¤ºã€‚\nè”åˆä½“è¿˜å¯ç”¨äºè®¿é—®ä¸åŒæ•°æ®ç±»å‹çš„ä½æ¨¡å¼ã€‚å‡è®¾æˆ‘ä»¬éœ€è¦å°†ä¸€ä¸ªdoubleç±»å‹çš„å˜é‡å¼ºåˆ¶è½¬æ¢ä¸ºunsigned longï¼Œåˆ™å¯ä»¥ç”¨ä»¥ä¸‹æ–¹æ³•å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 unsigned long double2bits(double d) { union { double d; unsigned long u; } temp; temp.d = d; return temp.u; }; è¯¥ä»£ç å°†ä¸¤ç§æ•°æ®ç±»å‹å‡å­˜å‚¨åœ¨è”åˆä½“tempä¸­ï¼Œä½¿å…¶æœ‰ç€ç›¸åŒçš„ä½çº§è¡¨è¾¾ï¼Œä»è€Œå®ç°äº†ç±»å‹è½¬æ¢ã€‚\næ•°æ®å¯¹é½ è®¸å¤šè®¡ç®—æœºç³»ç»Ÿè¦æ±‚ç¨‹åºå¯¹è±¡çš„åœ°å€å¿…é¡»æ˜¯æŸä¸ªå€¼ï¼ˆé€šå¸¸ä¸º 2ï¼Œ4 æˆ– 8ï¼‰çš„å€æ•°ï¼Œå…¶ç›®çš„æ˜¯ç®€åŒ–å¤„ç†å™¨å’Œå†…å­˜ç³»ç»Ÿä¹‹é—´çš„ç¡¬ä»¶æ¥å£è®¾è®¡ã€‚å‡è®¾ä¸€ä¸ªå¤„ç†å™¨æ¯æ¬¡éƒ½ä»å†…å­˜ä¸­è¯»å– 8 ä¸ªå­—èŠ‚ï¼Œè€Œä¸€ä¸ªdoubleç±»å‹çš„æ•°æ®åœ°å€ä¸º 8 çš„å€æ•°ï¼Œé‚£ä¹ˆå®ƒå°±å¯ä»¥è¢«ä¸€æ¬¡å†…å­˜è®¿é—®æ“ä½œè¯»å–æˆ–å†™å…¥ã€‚å¦åˆ™ï¼Œå®ƒä¼šè¢«æ‹†åˆ†ä¸ºä¸¤ä¸ª 8 å­—èŠ‚çš„å†…å­˜å—ï¼Œå¯¼è‡´å¤„ç†å™¨æ“ä½œæ¬¡æ•°çš„å¢åŠ ã€‚\næ— è®ºæ•°æ®å¯¹é½æ˜¯å¦å®ç°ï¼Œx86-64 çš„ç¡¬ä»¶éƒ½å°†æ­£å¸¸å·¥ä½œã€‚ä½†æ˜¯ Intel å»ºè®®å¯¹é½æ•°æ®ä»¥æé«˜å†…å­˜ç³»ç»Ÿæ€§èƒ½ï¼Œå…¶è§„åˆ™ä¸ºï¼šä»»ä½• K å­—èŠ‚å¯¹è±¡çš„åœ°å€å¿…é¡»ä¸º K çš„å€æ•°ï¼š\nK Types 1 char 2 short 4 int, float 8 long, double, char * ç¼–è¯‘å™¨ä¼šåœ¨æ±‡ç¼–ä»£ç ä¸­æ”¾ç½®æŒ‡ä»¤ï¼ŒæŒ‡ç¤ºå…¨å±€æ•°æ®æ‰€éœ€çš„å¯¹é½æ–¹å¼ã€‚æ¯”å¦‚æˆ‘ä»¬åœ¨ä»‹ç»è·³è½¬è¡¨æ—¶ï¼Œç¤ºä¾‹ä»£ç ä¸­çš„.align 8å°±ä»£è¡¨è¯¥æŒ‡ä»¤åé¢çš„æ•°æ®åœ°å€å‡ä¸º 8 çš„å€æ•°ã€‚å¯¹äºæ¶‰åŠåˆ°ç»“æ„ä½“çš„ä»£ç ï¼Œç¼–è¯‘å™¨å¯èƒ½è¿˜éœ€è¦åœ¨å­—æ®µåˆ†é…ç©ºé—´æ—¶æ’å…¥é—´éš™ä»¥å®ç°æ•°æ®å¯¹é½ã€‚ä¸€ä¸ªç®€å•ç»“æ„ä½“çš„å£°æ˜å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 struct S1 { int i; char c; int j; }; ç¼–è¯‘å™¨å®é™…ä¸ºå…¶åˆ†é…çš„å†…å­˜ç©ºé—´ä¸ºï¼š\nå³ç„¶å„å­—æ®µçš„åç§»é‡å‡ä¸º 4 çš„å€æ•°ï¼Œé‚£ä¹ˆåªè¦èµ·å§‹åœ°å€ä¹Ÿä¸º 4 çš„å€æ•°ï¼Œè¯¥ç»“æ„ä½“ä¾¿å®ç°äº†æ•°æ®å¯¹é½ã€‚\næœºå™¨çº§ä»£ç ä¸­æ§åˆ¶å’Œæ•°æ®çš„ç»„åˆ ç†è§£æŒ‡é’ˆ æŒ‡é’ˆä¸æ˜¯æœºå™¨ä»£ç çš„ä¸€éƒ¨åˆ†ï¼Œè€Œæ˜¯ C æä¾›çš„ä¸€ç§ç”¨æ¥å¸®åŠ©ç¨‹åºå‘˜é¿å…å¯»å€é”™è¯¯çš„æŠ½è±¡ï¼› æ¯ä¸ªæŒ‡é’ˆéƒ½æœ‰ä¸€ä¸ªå…³è”çš„ç±»å‹ã€‚ç‰¹æ®Šçš„æŒ‡é’ˆç±»å‹void *ä»£è¡¨é€šç”¨ï¼ˆèŒƒå‹ï¼‰æŒ‡é’ˆï¼Œå¯ä»¥æ˜¾å¼æˆ–éšå¼åœ°è½¬æ¢ä¸ºæœ‰å…³è”ç±»å‹çš„æŒ‡é’ˆï¼› æ¯ä¸ªæŒ‡é’ˆéƒ½æœ‰ä¸€ä¸ªå€¼ï¼Œå…¶å€¼ä¸ºæŒ‡å®šç±»å‹çš„æŸä¸ªå¯¹è±¡çš„åœ°å€ã€‚è‹¥æŒ‡é’ˆçš„å€¼ä¸ºNULL(0)ï¼Œåˆ™ä»£è¡¨å®ƒæ²¡æœ‰æŒ‡å‘ä»»ä½•åœ°æ–¹ï¼› æŒ‡é’ˆæ˜¯æ“ä½œç¬¦\u0026åˆ›å»ºçš„ï¼Œåœ¨æœºå™¨ä»£ç ä¸­å¸¸ç”¨leaqæŒ‡ä»¤å®ç°ï¼› ä½¿ç”¨æ“ä½œç¬¦*æ¥å¯¹æŒ‡é’ˆè§£å¼•ç”¨ï¼› æ•°ç»„å’ŒæŒ‡é’ˆä¹‹é—´å…³ç³»å¯†åˆ‡ï¼› æŒ‡é’ˆå¯ä»¥è¢«å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œä½†ä¸ä¼šæ”¹å˜å…¶å€¼ï¼› æŒ‡é’ˆä¹Ÿå¯ä»¥æŒ‡å‘å‡½æ•°ï¼Œä½¿ç¨‹åºå¯ä»¥åœ¨å…¶ä»–åœ°æ–¹è°ƒç”¨ä»£ç ï¼Œå…¶å€¼ä¸ºå‡½æ•°çš„æœºå™¨ä»£ç ä¸­ç¬¬ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚ ä¾‹å¦‚ä¸€ä¸ªå‡½æ•°çš„åŸå‹ä¸ºï¼š\n1 int fun(int x, int *p); æˆ‘ä»¬å¯ä»¥å£°æ˜ä¸€ä¸ªæŒ‡é’ˆæ¥æŒ‡å‘å®ƒï¼š\n1 2 int (*fp)(int, int *) fp = fun; è¿™æ ·ä¾¿å¯ä»¥ä½¿ç”¨æŒ‡é’ˆæ¥è°ƒç”¨è¯¥å‡½æ•°ï¼š\n1 2 int y =1; int result = fp(3, \u0026y); å†…å­˜å¼•ç”¨è¶Šç•Œå’Œç¼“å†²åŒºæº¢å‡º C ä¸ä¼šå¯¹æ•°ç»„å¼•ç”¨åšä»»ä½•çš„è¾¹ç•Œæ£€æŸ¥ï¼Œè¿™å¯èƒ½å¯¼è‡´å­˜å‚¨åœ¨æ ˆä¸­çš„æ•°æ®å› å†™å…¥è¶Šç•Œï¼ˆOut-of-Boundsï¼‰çš„æ•°ç»„å…ƒç´ è€ŒæŸåã€‚å¦‚æœç¨‹åºéšåä»¥è¿™ç§çŠ¶æ€é‡æ–°åŠ è½½å¯„å­˜å™¨æˆ–æ‰§è¡ŒretæŒ‡ä»¤ï¼Œäº‹æƒ…å¯èƒ½ä¼šå˜å¾—ååˆ†ä¸¥é‡ã€‚\nä¸€ç§å¸¸è§çš„çŠ¶æ€æŸååŸå› è¢«ç§°ä¸ºç¼“å­˜åŒºæº¢å‡ºï¼ˆBuffer Overflowï¼‰ï¼Œæ¯”è¾ƒå…¸å‹çš„ä¾‹å­æ˜¯å­—ç¬¦ä¸²çš„é•¿åº¦è¶…è¿‡äº†æ ˆä¸­ä¸ºå…¶åˆ†é…çš„å­—ç¬¦æ•°ç»„ç©ºé—´ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 /* Implementation of library function gets() */ char *gets(char *s) { int c; char *dest = s; while ((c = getchar()) != '\\n' \u0026\u0026 c != EOF) *dest++ = c; if (c == EOF \u0026\u0026 dest == s) /* No characters read */ return NULL; *dest++ = '\\0'; /* Terminate string */ return s; } /* Read input line and write it back */ void echo() { char buf[8]; /* Way too small! */ gets(buf); puts(buf); } ä¸ŠåŠéƒ¨åˆ†ä»£ç å±•ç¤ºäº†åº“å‡½æ•°getsçš„å®ç°è¿‡ç¨‹ï¼šå®ƒé¦–å…ˆä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–ä¸€è¡Œå­—ç¬¦ä¸²ï¼Œå½“é‡åˆ°æ¢è¡Œç¬¦æˆ–æŸäº›é”™è¯¯æ¡ä»¶æ—¶åœæ­¢ï¼›ç„¶åå®ƒå°†è¯»å–å†…å®¹å¤åˆ¶åˆ°å‚æ•°sæŒ‡å‘çš„ä½ç½®ä¸Šï¼Œå¹¶ä»¥å­—ç¬¦NULLç»“å°¾ã€‚getsçš„é—®é¢˜åœ¨äºå…¶æ— æ³•ç¡®å®šæ˜¯å¦åˆ†é…äº†è¶³å¤Ÿçš„ç©ºé—´æ¥ä¿å­˜è¯»å–åˆ°çš„å­—ç¬¦ä¸²ã€‚è€Œåœ¨ä¸‹åŠéƒ¨åˆ†çš„å‡½æ•°echoä¸­ï¼Œæˆ‘ä»¬æ•…æ„å°†ç¼“å†²åŒºåšå¾—éå¸¸å°ï¼ˆåªæœ‰ 8 ä¸ªå­—èŠ‚ï¼‰ï¼Œå› æ­¤ä»»ä½•è¶…è¿‡ 7 ä¸ªå­—ç¬¦çš„å­—ç¬¦ä¸²éƒ½ä¼šå¯¼è‡´è¶Šç•Œå†™å…¥ã€‚éšç€å­—ç¬¦ä¸²é•¿åº¦çš„å¢åŠ ï¼Œå—åˆ°å½±å“çš„æ ˆåŒºåŸŸä¼šè¶Šæ¥è¶Šå¤šï¼š\nCharacter Typed Additional Corrupted State 0-7 None 8-23 Unused Stack Space 24-31 Return Address 32+ Saved State in Caller ç¼–è¯‘å™¨ä¸ºå‡½æ•°echoåˆ†é…äº† 24 ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼Œå› æ­¤è¯»å–å°‘äº 23 ä¸ªå­—ç¬¦çš„å†…å®¹ä¸ä¼šå‘ç”Ÿä¸¥é‡åæœã€‚ä½†ä¸€æ—¦è¶…å‡ºè¿™ä¸ªèŒƒå›´ï¼Œè¿”å›æŒ‡é’ˆçš„å€¼å’Œå…¶ä»–ä¿å­˜çš„çŠ¶æ€å°±ä¼šè¢«ç ´åï¼ŒretæŒ‡ä»¤å°†å¯¼è‡´ç¨‹åºè·³è½¬åˆ°ä¸€ä¸ªå®Œå…¨ä¸å¯é¢„çŸ¥çš„ä½ç½®ã€‚\né˜»æ­¢ç¼“å†²åŒºæº¢å‡ºæ”»å‡» ç¼“å†²åŒºæº¢å‡ºç”šè‡³ä¼šå¯¼è‡´è®¡ç®—æœºå—åˆ°ç½‘ç»œæ”»å‡»ï¼Œå±å®³ç³»ç»Ÿå®‰å…¨ã€‚å—åˆ°æ”»å‡»çš„ç¨‹åºä¼šæ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ŒåŒ…å«ä¸€äº›å¯æ‰§è¡Œä»£ç çš„å­—èŠ‚ç¼–ç ï¼ˆä¹Ÿç§°æ¼æ´åˆ©ç”¨ä»£ç ï¼‰ï¼Œä»¥åŠä¸€äº›é¢å¤–å­—èŠ‚ã€‚åªè¦é¢å¤–å­—èŠ‚èƒ½å¤Ÿå°†è¿”å›åœ°å€è¦†ç›–ä¸ºæŒ‡å‘æ¼æ´åˆ©ç”¨ä»£ç çš„æŒ‡é’ˆï¼Œç¨‹åºæ‰§è¡ŒretæŒ‡ä»¤æ—¶å°±ä¼šè·³è½¬åˆ°æ¼æ´åˆ©ç”¨ä»£ç ã€‚ç°ä»£ç¼–è¯‘å™¨å’Œæ“ä½œç³»ç»Ÿå·²ç»å¼€å§‹å¼•å…¥ä¸€äº›æœºåˆ¶æ¥æŠµå¾¡è¿™ç§æ”»å‡»ã€‚\néšæœºåŒ–æ ˆ åªè¦æˆ‘ä»¬åœ¨ç¨‹åºå¼€å§‹è¿è¡Œæ—¶åœ¨æ ˆä¸Šåˆ†é… 0 åˆ° n ä¸ªå­—èŠ‚ä¹‹é—´çš„éšæœºç©ºé—´ï¼ˆä¾‹å¦‚ä½¿ç”¨åˆ†é…å‡½æ•°allocaï¼‰ï¼Œå°±å¯ä»¥è®©ç›¸åŒçš„ä»£ç åœ¨å¤šæ¬¡è¿è¡Œä¸­ä½¿ç”¨ä¸åŒçš„æ ˆåœ°å€ã€‚åˆ†é…çš„ç©ºé—´èŒƒå›´ n éœ€è¦è¶³å¤Ÿå¤§ï¼Œä»¥ä¾¿æ ˆåœ°å€èƒ½å¤Ÿå‘ç”Ÿè¶³å¤Ÿçš„å˜åŒ–ã€‚ä½†åˆè¦è¶³å¤Ÿå°ï¼Œå¦åˆ™ç¨‹åºå°†æµªè´¹å¤ªå¤šçš„å†…å­˜ç©ºé—´ã€‚\nä¸è¿‡æ”»å‡»è€…å¯ä»¥åœ¨å®é™…çš„æ¼æ´åˆ©ç”¨ä»£ç å‰åŠ å…¥ä¸€é•¿ä¸²çš„nopæŒ‡ä»¤ï¼Œä»è€Œæš´åŠ›æ”»å…‹éšæœºåŒ–æ ˆã€‚å› æ­¤éšæœºåŒ–æ ˆå¯ä»¥å¢åŠ æˆåŠŸæ”»å‡»ç³»ç»Ÿæ‰€éœ€çš„å·¥ä½œé‡ï¼Œä½†ä¸èƒ½æä¾›å¯é å®Œå–„çš„ä¿éšœã€‚\næ ˆæŸåæ£€æµ‹ æˆ‘ä»¬è¿˜å¯ä»¥åœ¨å±€éƒ¨ç¼“å†²åŒºå’Œæ ˆçš„å‰©ä½™éƒ¨åˆ†ä¹‹é—´æ’å…¥ä¸€ä¸ªé‡‘ä¸é›€å€¼ï¼ˆCanaryï¼‰æ¥æ£€æµ‹æ ˆæ˜¯å¦æŸåï¼š\né™åˆ¶å¯æ‰§è¡Œä»£ç åŒºåŸŸ æœ€åï¼Œæˆ‘ä»¬å¯ä»¥é™åˆ¶åªæœ‰ä¿å­˜äº†ç¼–è¯‘å™¨ç”Ÿæˆçš„ä»£ç çš„é‚£éƒ¨åˆ†å†…å­˜åŒºåŸŸæ˜¯å¯æ‰§è¡Œçš„ï¼Œå…¶ä»–éƒ¨åˆ†è¢«é™åˆ¶ä¸ºåªè¯»æˆ–åªå†™ã€‚\næ”¯æŒå¯å˜å¤§å°çš„æ ˆå¸§ åœ¨ä¹‹å‰æˆ‘ä»¬ä»‹ç»çš„æ±‡ç¼–ä»£ç ä¸­ï¼Œç¼–è¯‘å™¨ä¸ºç¨‹åºåˆ†é…çš„è¿è¡Œæ—¶æ ˆå¤§å°éƒ½æ˜¯ç¡®å®šçš„ã€‚è€Œæœ‰äº›ç¨‹åºåˆ™éœ€è¦å¤§å°å¯å˜çš„è¿è¡Œæ—¶æ ˆï¼Œä¾‹å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 long vframe(long n, long idx, long *q) { long i; long *p[n]; p[0] = \u0026i; for (i = 1; i \u003c n; i++) p[i] = q; return *p[idx]; } å‡½æ•°vframeå£°æ˜äº†ä¸€ä¸ªå˜é•¿çš„æŒ‡é’ˆæ•°ç»„*p[n]ï¼Œå°†åœ¨æ ˆä¸­å ç”¨8nä¸ªå­—èŠ‚çš„ç©ºé—´ã€‚ç”±äºnçš„å€¼æ˜¯ç”±å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°ç»™å‡ºçš„ï¼Œå› æ­¤ç¼–è¯‘å™¨æ— æ³•ç¡®å®šè¦ä¸ºè¯¥å‡½æ•°çš„è¿è¡Œæ—¶æ ˆåˆ†é…å¤šå°‘ç©ºé—´ã€‚å¦å¤–ï¼Œç¨‹åºæ¶‰åŠäº†å¯¹å±€éƒ¨å˜é‡iåœ°å€çš„å¼•ç”¨ï¼Œæ‰€ä»¥è¯¥å˜é‡å¿…é¡»å­˜å‚¨åœ¨æ ˆä¸­ã€‚å½“å‡½æ•°è¿”å›æ—¶ï¼Œè¿è¡Œæ—¶æ ˆéœ€è¦è¢«å›æ”¶ï¼Œæ ˆæŒ‡é’ˆå°†æŒ‡å‘å­˜å‚¨è¿”å›åœ°å€çš„ä½ç½®ã€‚\nä¸ºäº†ç®¡ç†å¯å˜å¤§å°çš„æ ˆå¸§ï¼Œx86-64 ä½¿ç”¨å¯„å­˜å™¨ %rbp ä½œä¸ºå¸§æŒ‡é’ˆï¼ˆåˆç§°åŸºæŒ‡é’ˆï¼ŒBase Pointerï¼‰ã€‚æ ˆå¸§ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nä¸Šæ–‡æåˆ°ï¼Œ%rbp æ˜¯ä¸€ä¸ªè¢«è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨ï¼Œå› æ­¤å…¶åŸå€¼å°†è¢«ä¿å­˜åœ¨æ ˆä¸­ï¼ˆå›¾ä¸­çš„â€œSaved %rbpâ€ï¼‰ã€‚åœ¨ç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œ%rbp ä¼šä¸€ç›´æŒ‡å‘è¿™ä¸ªä½ç½®ã€‚ä¸€äº›å›ºå®šé•¿åº¦çš„å±€éƒ¨å˜é‡ï¼Œæ¯”å¦‚iï¼Œå°±å¯ä»¥æ ¹æ®å…¶ç›¸å¯¹äº %rbp çš„åç§»é‡æ¥å¼•ç”¨ã€‚å‡½æ•°ç¼–è¯‘åç”Ÿæˆçš„éƒ¨åˆ†æ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š\nå‡½æ•°é¦–å…ˆå°† %rbp å‹å…¥æ ˆä¸­ï¼Œç„¶åå°†å…¶ç½®ä¸ºå½“å‰è¿è¡Œæ—¶æ ˆçš„åœ°å€ï¼ˆæ±‡ç¼–ä»£ç ç¬¬ 2 åˆ° 3 è¡Œï¼‰ã€‚æ¥ä¸‹æ¥åœ¨æ ˆä¸Šåˆ†é…äº† 16 ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼Œæ ˆæŒ‡é’ˆæŒ‡å‘å›¾ä¸­ s1 çš„ä½ç½®ã€‚å‰ 8 ä¸ªå­—èŠ‚ç”¨äºå­˜å‚¨å±€éƒ¨å˜é‡iï¼Œå 8 ä¸ªå­—èŠ‚å¹¶æœªä½¿ç”¨ã€‚ç„¶åå®ƒå¼€å§‹ä¸ºæ•°ç»„*p[n]åˆ†é…ç©ºé—´ï¼Œæ ˆæŒ‡é’ˆæŒ‡å‘å›¾ä¸­ s2 çš„ä½ç½®ã€‚å…¶ç›¸å¯¹äº s1 çš„åç§»é‡æ˜¯é€šè¿‡æ±‡ç¼–ä»£ç ç¬¬ 5 åˆ° 7 è¡Œè®¡ç®—å¾—åˆ°çš„ï¼š\n$$ (8n + 22) \\And (-16)= \\begin{cases} 8n + 8 \u0026\\text n ä¸ºå¥‡æ•° \\cr 8n + 16 \u0026\\text n ä¸ºå¶æ•° \\end{cases} $$\nç”±äºè¯¥ç»“æœæ˜¯ 16 çš„å€æ•°ï¼Œå› æ­¤å®ç°äº†æ•°æ®å¯¹é½ã€‚æ±‡ç¼–ä»£ç ç¬¬ 8 åˆ° 10 è¡Œå°†å›¾ä¸­ p çš„å€¼ç½®ä¸ºæœ€æ¥è¿‘ s2 çš„ 8 çš„å€æ•°ï¼Œæœ€ç»ˆç”±å¯„å­˜å™¨ %rcx ä¸­çš„å€¼ä½œä¸º*p[n]çš„èµ·å§‹åœ°å€ã€‚å‡è®¾ n ä¸º 5 æˆ– 6ï¼Œs1 çš„å€¼ä¸º 2065 æˆ– 2064ï¼Œåˆ™å›¾ä¸­å„å€¼ä¸ºï¼š\nn s1 s2 p e1 e2 5 2065 2017 2024 1 7 6 2064 2000 2000 16 0 åœ¨å‡½æ•°æ‰§è¡Œç»“æŸå‰ï¼Œæ±‡ç¼–ä»£ç ç¬¬ 20 è¡Œçš„leaveæŒ‡ä»¤å°†å¸§æŒ‡é’ˆæ¢å¤åŸå€¼ã€‚ç›¸å½“äºæ‰§è¡Œäº†ä»¥ä¸‹ä¸¤æ¡æŒ‡ä»¤ï¼š\n1 2 3 4 5 ; Set stack pointer to beginning of frame movq %rbp, %rsp ; Restore saved %rbp and set stack ptr ; to end of callerâ€™s frame popq %rbp æµ®ç‚¹ä»£ç  å¤„ç†å™¨çš„æµ®ç‚¹æ¶æ„å†³å®šäº†æ“ä½œæµ®ç‚¹æ•°çš„ç¨‹åºä¸æœºå™¨çº§ä»£ç ä¹‹é—´çš„æ˜ å°„æ–¹å¼ï¼ŒåŒ…æ‹¬ä»¥ä¸‹æ–¹é¢ï¼š\næµ®ç‚¹æ•°æ˜¯è¢«å¦‚ä½•è¢«å­˜å‚¨å’Œè®¿é—®çš„ï¼› æ“ä½œæµ®ç‚¹æ•°çš„æŒ‡ä»¤ï¼› æµ®ç‚¹æ•°å¦‚ä½•ä½œä¸ºå‚æ•°ä¼ é€’ç»™å‡½æ•°ä»¥åŠå¦‚ä½•ä½œä¸ºç»“æœè¿”å›ï¼› åœ¨å‡½æ•°è°ƒç”¨æ—¶å¦‚ä½•ä¿å­˜å¯„å­˜å™¨ä¸­çš„å€¼ã€‚ æˆ‘ä»¬çš„å†…å®¹åŸºäº AVX2ï¼ˆAdcanced Vector Extensions2ï¼‰æ‰©å±•ï¼Œå¯ä»¥åœ¨ GCC ç¼–è¯‘æ—¶åŠ å…¥-mavx2å‚æ•°ä»¥ç”Ÿæˆè¿™ç§æ¶æ„çš„ä»£ç ã€‚\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒAVX æ¶æ„å…è®¸æµ®ç‚¹æ•°å­˜å‚¨åœ¨ 16 ä¸ª YMM å¯„å­˜å™¨ä¸­ï¼Œæ¯ä¸ªé•¿åº¦å‡ä¸º 256 ä½ï¼ˆ32 å­—èŠ‚ï¼‰ã€‚åœ¨å¯¹æ ‡é‡æ•°æ®è¿›è¡Œæ“ä½œæ—¶ï¼Œè¿™äº›å¯„å­˜å™¨åªä¼šä¿å­˜æµ®ç‚¹å‹æ•°æ®ã€‚è€Œå¯¹äºfloatç±»å‹å’Œdoubleç±»å‹ï¼Œåˆ†åˆ«åªæœ‰è¾ƒä½çš„ 32 ä½å’Œ 64 ä½è¢«ä½¿ç”¨ã€‚æ±‡ç¼–ä»£ç é€šè¿‡ XMM å¯„å­˜å™¨ï¼ˆå³å›¾ä¸­çš„â€œ%xmm0â€ï½â€œ%xmm15â€ï¼‰çš„åç§°æ¥å¼•ç”¨å®ƒä»¬ï¼Œæ¯ä¸ª XMM å¯„å­˜å™¨æ˜¯å…¶å¯¹åº”çš„ YMM å¯„å­˜å™¨çš„ä½ 128 ä½ï¼ˆ16 å­—èŠ‚ï¼‰ã€‚\næµ®ç‚¹æ•°çš„ç§»åŠ¨å’Œè½¬æ¢æ“ä½œ ä¸‹å›¾å±•ç¤ºäº†ä¸€ç»„åœ¨å†…å­˜å’Œ XMM å¯„å­˜å™¨ä¹‹é—´å’Œåœ¨ä¸¤ä¸ª XMM å¯„å­˜å™¨ä¹‹é—´ä¸è¿›è¡Œç±»å‹è½¬æ¢çš„ä¼ è¾“æ•°æ®æµ®ç‚¹æ•°æŒ‡ä»¤ï¼š\nå‰å››ä¸ªæŒ‡ä»¤æ¶‰åŠåˆ°å¯¹å†…å­˜çš„å¼•ç”¨ï¼Œæˆ‘ä»¬ç§°å…¶ä¸º Scalar æŒ‡ä»¤ã€‚å®ƒä»¬æ“ä½œçš„å¯¹è±¡æ˜¯å•ç‹¬çš„æ•°å€¼ï¼Œåªä¼šæ”¹å˜ç›®çš„å¯„å­˜å™¨ä½ä½çš„å››å­—èŠ‚æˆ–å…«å­—èŠ‚ã€‚è€Œåä¸¤ä¸ªæŒ‡ä»¤åˆ™å±äº Packed æŒ‡ä»¤ï¼Œå®ƒä»¬ä¼šæ›´æ–°ç›®çš„å¯„å­˜å™¨ä¸­å…¨éƒ¨çš„å†…å®¹ã€‚\næµ®ç‚¹æ•°å’Œæ•´å‹ä¹‹é—´è¿›è¡Œè½¬æ¢çš„æ“ä½œæŒ‡ä»¤ä¸ºï¼š\nåœ¨ C å’Œå¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œæµ®ç‚¹æ•°è½¬æ¢ä¸ºæ•´å‹æ—¶ä¼šå…ˆè¿›è¡Œæˆªæ–­æ“ä½œï¼Œå°†æ•°å€¼å‘é›¶èˆå…¥ã€‚è€Œæ•´å‹è½¬åŒ–ä¸ºæµ®ç‚¹æ•°æ—¶ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šå¿½ç•¥ç¬¬äºŒä¸ªæºæ“ä½œæ•°ï¼Œå› ä¸ºå®ƒåªå½±å“ç»“æœçš„é«˜ä½å­—èŠ‚ã€‚å› æ­¤ï¼Œé€šå¸¸æƒ…å†µä¸‹ç¬¬äºŒä¸ªæºæ“ä½œæ•°å’Œç›®çš„æ“ä½œæ•°æ˜¯ç›¸åŒçš„ã€‚\næœ€ååˆ™æ˜¯ä¸¤ç§æµ®ç‚¹æ•°ä¹‹é—´çš„ç±»å‹è½¬æ¢ã€‚å‡è®¾å¯„å­˜å™¨ %xmm0 çš„ä½ä½å››å­—èŠ‚ä¿å­˜äº†ä¸€ä¸ªå•ç²¾åº¦æµ®ç‚¹å€¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¾ˆå®¹æ˜“ä½¿ç”¨æŒ‡ä»¤vcvtss2sd %xmm0, %xmm0, %xmm0æ¥æŠŠå®ƒè½¬æ¢ä¸ºåŒç²¾åº¦æµ®ç‚¹å€¼ç„¶åå†å­˜å‚¨äºå¯„å­˜å™¨ %xmm0 çš„ä½ä½å…«å­—èŠ‚ä¸­ã€‚ç„¶è€Œå®é™…ä¸Š GCC ç”Ÿæˆçš„æ±‡ç¼–ä»£ç ä¸ºï¼š\n1 2 3 4 ; Replicate first vector element vunpcklps %xmm0, %xmm0, %xmm0 ; Convert two vector elements to double vcvtps2pd %xmm0, %xmm0 æŒ‡ä»¤vunpcklpsä¼šäº¤é”™ä¸¤ä¸ª XMM å¯„å­˜å™¨ä¸­çš„å€¼ï¼Œå¹¶å°†å®ƒä»¬å­˜å‚¨åœ¨ç¬¬ä¸‰ä¸ªå¯„å­˜å™¨ä¸­ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœä¸¤ä¸ªæºå¯„å­˜å™¨ä¸­çš„å€¼åˆ†åˆ«ä¸º$[s_3, s_2, s_1, s_0]$å’Œ$[d_3, d_2, d_1, d_0]$ï¼Œé‚£ä¹ˆç›®æ ‡å¯„å­˜å™¨çš„å€¼å°±æ˜¯$[s_1, d_1, s_0, d_0 ]$ã€‚åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œä¸‰ä¸ªæ“ä½œæ•°ä½¿ç”¨ç›¸åŒçš„å¯„å­˜å™¨ï¼Œå› æ­¤å¦‚æœå¯„å­˜å™¨ %xmm0 ä¸­çš„åŸå§‹å€¼ä¸º$[x_3, x_2, x_1, x_0]$ï¼Œåˆ™è¯¥æŒ‡ä»¤å°†æ›´æ–°å…¶å€¼ä¸º$[x_1, x_1, x_0, x_0]$ã€‚\næŒ‡ä»¤vcvtps2pdå°†æº XMM å¯„å­˜å™¨ä¸­çš„ä¸¤ä¸ªä½ä½å•ç²¾åº¦å€¼æ‰©å±•ä¸ºç›®çš„ XMM å¯„å­˜å™¨ä¸­çš„ä¸¤ä¸ªåŒç²¾åº¦å€¼ã€‚è®¾ $dx_0$ ä¸ºå°† $x_0$ è½¬æ¢ä¸ºåŒç²¾åº¦çš„ç»“æœï¼Œé‚£ä¹ˆè¯¥æŒ‡ä»¤å°†å¾—å‡ºå€¼$[dx_0, dx_0]$ã€‚ç»¼ä¸Šï¼Œè¿™ä¸¤æ¡æŒ‡ä»¤çš„æœ€ç»ˆæ•ˆæœæ˜¯å°†å¯„å­˜å™¨ %xmm0 ä¸­ä½ä½å››å­—èŠ‚ä¸­çš„åŸå§‹å•ç²¾åº¦å€¼è½¬æ¢ä¸ºåŒç²¾åº¦å€¼ï¼Œå¹¶å°†å®ƒçš„ä¸¤ä¸ªå‰¯æœ¬å­˜å‚¨åœ¨å¯„å­˜å™¨ %xmm0 ä¸­ã€‚\nåŒæ ·ï¼ŒGCC ä¸ºåŒç²¾åº¦å€¼è½¬æ¢ä¸ºå•ç²¾åº¦ç”Ÿæˆç±»ä¼¼çš„æ±‡ç¼–ä»£ç ï¼š\n1 2 3 4 ; Replicate first vector element vmovddup %xmm0, %xmm0 ; Convert two vector elements to single vcvtpd2psx %xmm0, %xmm0 å‡è®¾å¯„å­˜å™¨ %xmm0 ä¸­åŒ…å«äº†ä¸¤ä¸ªåŒç²¾åº¦å€¼$[x_1, x_0]$ï¼Œåˆ™æ‰§è¡Œä¸Šè¿°ä»£ç çš„ç»“æœä¸º$[0.0, 0.0, x_0, x_0]$ã€‚\nè¿‡ç¨‹ä¸­çš„æµ®ç‚¹ä»£ç  è§‚å¯Ÿå›¾ 3.45 ä¸­æœ€å³ä¾§çš„æ³¨é‡Šï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ä»¥ä¸‹å‡†åˆ™ï¼š\næœ€å¤šå¯ä»¥ä½¿ç”¨ XMM å¯„å­˜å™¨ä¼ é€’å…«ä¸ªå‚æ•°ï¼ˆ%xmm0-%xmm7ï¼‰ï¼Œå…¶ä½™çš„åˆ™éœ€è¦é€šè¿‡æ ˆï¼› å’Œ %rax ç±»ä¼¼ï¼Œ%xmm0 é€šå¸¸ä½œä¸ºæµ®ç‚¹æ•°çš„è¿”å›å¯„å­˜å™¨ï¼› æ‰€æœ‰ XMM å¯„å­˜å™¨å‡ä¸ºè°ƒç”¨è€…ä¿å­˜ï¼Œè¢«è°ƒç”¨è€…å¯ä»¥è¦†ç›–å…¶ä¸­ä»»æ„ä¸€ä¸ªï¼› å½“å‡½æ•°å‚æ•°æ˜¯æŒ‡é’ˆã€æ•´æ•°å’Œæµ®ç‚¹æ•°çš„ç»„åˆæ—¶ï¼ŒæŒ‡é’ˆå’Œæ•´æ•°åœ¨é€šç”¨å¯„å­˜å™¨ä¸­ä¼ é€’ï¼Œè€Œæµ®ç‚¹å€¼åˆ™åœ¨ XMM å¯„å­˜å™¨ä¸­ä¼ é€’ã€‚ æµ®ç‚¹æ•°çš„ç®—æ•°æ“ä½œ æµ®ç‚¹æ•°ç®—æ•°æ“ä½œæŒ‡ä»¤å¦‚ä¸‹ï¼Œæ¯ä¸ªæŒ‡ä»¤éƒ½æœ‰ä¸€åˆ°ä¸¤ä¸ªæºæ“ä½œæ•°å’Œä¸€ä¸ªç›®çš„æ“ä½œæ•°ã€‚ç¬¬ä¸€ä¸ªæºæ“ä½œæ•°å¯ä»¥æ˜¯ XMM å¯„å­˜å™¨æˆ–å†…å­˜ä¸­çš„ä½ç½®ï¼Œç¬¬äºŒä¸ªæºæ“ä½œæ•°å’Œç›®çš„æ“ä½œæ•°åªèƒ½æ˜¯ XMM å¯„å­˜å™¨ï¼›\næµ®ç‚¹å¸¸é‡çš„å®šä¹‰å’Œä½¿ç”¨ ä¸æ•´æ•°ç®—æœ¯è¿ç®—ä¸åŒï¼ŒAVX æµ®ç‚¹è¿ç®—ä¸èƒ½å°†ç«‹å³æ•°ä½œä¸ºæ“ä½œæ•°ã€‚ç¼–è¯‘å™¨å¿…é¡»ä¸ºå¸¸é‡åˆ†é…å’Œåˆå§‹åŒ–å­˜å‚¨ç©ºé—´ï¼Œå†ç”±ä»£ç ä»å†…å­˜ä¸­è¯»å–å€¼ã€‚\næµ®ç‚¹ä»£ç ä¸­çš„ä½çº§è¿ç®— ä¸‹å›¾å±•ç¤ºäº†ä¸¤ä¸ªç”¨äº XMM å¯„å­˜å™¨çš„ä½çº§è¿ç®—æŒ‡ä»¤ï¼Œå…¶æ“ä½œå¯¹è±¡å‡ä¸º Packed æ•°å€¼ï¼ˆXMM å¯„å­˜å™¨ä¸­å…¨éƒ¨çš„ 128 ä½ï¼‰ï¼š\næµ®ç‚¹æ•°çš„æ¯”è¾ƒæ“ä½œ AVX 2 ä¸ºæµ®ç‚¹æ•°å€¼çš„æ¯”è¾ƒè¿ç®—æä¾›ä¸¤ç§æ“ä½œæŒ‡ä»¤ï¼š\nInstruction Based on Description vucomiss $S_1$, $S_2$ $S_2 - S_1$ Compare Single Precision vucomisd $S_1$, $S_2$ $S_2 - S_1$ Compare Double Precision ä¸Šè¿°æŒ‡ä»¤ä¸ æ¡ä»¶ç  ä¸­ä»‹ç»çš„ CMP æŒ‡ä»¤ç±»ç›¸ä¼¼ã€‚å‚æ•° $S_2$ å¿…é¡»æ˜¯ XMM å¯„å­˜å™¨ï¼Œè€Œå‚æ•° $S_1$ åˆ™æ—¢å¯ä»¥æ˜¯ XMM å¯„å­˜å™¨ï¼Œåˆå¯ä»¥æ˜¯å†…å­˜ä¸­çš„ä½ç½®ã€‚\næµ®ç‚¹æ•°æ¯”è¾ƒæ“ä½œä¼šæ”¹å˜ä»¥ä¸‹æ¡ä»¶ç çš„å€¼ï¼Œå…¶ä¸­ PF æ„ä¸º Parity Flagï¼š\nOrdering $S_2$:$S_1$ CF ZF PF Unordered 1 1 1 $S_2$ \u003c $S_1$ 1 0 0 $S_2$ = $S_1$ 0 1 0 $S_2$ \u003e $S_1$ 0 0 0 å½“ä»»æ„æ“ä½œæ•°ä¸º NaN æ—¶ï¼Œå›¾ä¸­â€œUnorderedâ€çš„æƒ…å†µå°±ä¼šå‡ºç°ã€‚PF çš„å€¼å°†è¢«ç½®ä¸º 1ï¼Œå¯¹åº”çš„è·³è½¬æŒ‡ä»¤ä¸ºjpã€‚å…¶ä½™ä¸‰ç§æƒ…å†µåˆ™å’Œæ•´å‹çš„ è·³è½¬æŒ‡ä»¤ ç›¸åŒï¼Œåˆ†åˆ«ä¸ºjbã€jeå’Œjaã€‚\n","description":"","tags":["OS"],"title":"CSAPP è¯»ä¹¦ç¬”è®°ï¼šç¨‹åºçš„æœºå™¨çº§è¡¨ç¤º","uri":"/posts/machine-level-representation-of-programs-note/"},{"content":"ä¿¡æ¯çš„å­˜å‚¨ å¤§å¤šæ•°æœºå™¨ä½¿ç”¨å­—èŠ‚ï¼ˆ8 ä½çš„å—ï¼‰ä½œä¸ºå­˜å‚¨å™¨ä¸­çš„æœ€å°å¯»å€å•å…ƒï¼Œè€Œéè®¿é—®å•ç‹¬çš„ä½ã€‚å†…å­˜ä¸­çš„æ¯ä¸€ä¸ªå­—èŠ‚éƒ½å¯¹åº”ä¸€ä¸ªå”¯ä¸€çš„æ•°å­—ï¼Œå³å®ƒçš„åœ°å€ï¼Œæ‰€æœ‰å¯èƒ½çš„åœ°å€é›†åˆæ„æˆäº† è™šæ‹Ÿå†…å­˜ã€‚å®ƒæ˜¯ç”± DRAMã€é—ªå­˜ï¼ˆFlash Memory) å’Œç£ç›˜å­˜å‚¨å…±åŒå®ç°çš„ï¼Œè€Œåœ¨ç¨‹åºçœ‹æ¥åˆ™åªæ˜¯ä¸€ä¸ªç»Ÿä¸€çš„å­—èŠ‚æ•°ç»„ã€‚\nç¼–è¯‘å™¨å’Œè¿è¡Œæ—¶ç³»ç»Ÿè´Ÿè´£å°†å†…å­˜ç©ºé—´åˆ’åˆ†ä¸ºæ›´åŠ æ˜“äºç®¡ç†çš„å•å…ƒï¼Œä»è€Œå­˜å‚¨ä¸åŒçš„ç¨‹åºå¯¹è±¡ã€‚ä¾‹å¦‚ï¼ŒC ä¸­æŒ‡é’ˆçš„å€¼ä»£è¡¨å…¶æŒ‡å‘çš„å­˜å‚¨å—å†…ç¬¬ä¸€ä¸ªå­—èŠ‚çš„è™šæ‹Ÿåœ°å€ã€‚C ç¼–è¯‘å™¨è¿˜å°†æ¯ä¸ªæŒ‡é’ˆä¸å…¶ç±»å‹ä¿¡æ¯è”ç³»èµ·æ¥ï¼Œè¿™æ ·å°±å¯ä»¥æ ¹æ®æŒ‡é’ˆç±»å‹ç”Ÿæˆä¸åŒçš„æœºå™¨çº§ä»£ç æ¥è®¿é—®æŒ‡é’ˆæ‰€æŒ‡å‘çš„å¯¹è±¡ã€‚ä¸è¿‡æœºå™¨çº§ä»£ç ä¸­å¹¶æ²¡æœ‰ä»»ä½•ä¸ç±»å‹ç›¸å…³çš„ä¿¡æ¯ï¼Œç¼–è¯‘å™¨åªæ˜¯ç®€å•åœ°æŠŠæ¯ä¸ªç¨‹åºå¯¹è±¡éƒ½è§†ä¸ºä¸€ä¸ªå­—èŠ‚å—ï¼Œè€ŒæŠŠç¨‹åºè§†ä¸ºä¸€ä¸ªå­—èŠ‚åºåˆ—ã€‚\nåå…­è¿›åˆ¶è¡¨ç¤ºæ³• ä½¿ç”¨äºŒè¿›åˆ¶è¡¨ç¤ºä½æ¨¡å¼ï¼ˆBit Patternï¼‰ä¼šéå¸¸å†—é•¿ï¼Œå› ä¸ºä¸€ä¸ªå­—èŠ‚å°±åŒ…å«äº† 8 ä½ã€‚è€Œå¦‚æœä½¿ç”¨åè¿›åˆ¶ï¼Œåˆ™ä¸æ–¹ä¾¿ä¸ä½æ¨¡å¼è¿›è¡Œäº’ç›¸è½¬åŒ–ï¼Œå› æ­¤æˆ‘ä»¬é‡‡ç”¨åå…­è¿›åˆ¶ï¼ˆHexadecimalï¼‰æ¥ä¹¦å†™ä½æ¨¡å¼ã€‚ä¸€ä¸ªåå…­è¿›åˆ¶æ•°å  4 ä½ï¼Œå› æ­¤ä¸€ä¸ªå­—èŠ‚çš„å–å€¼èŒƒå›´å°±æ˜¯ $00_{16}$ ~ $FF_{16}$ ã€‚\nå°†ä¸€ä¸ªäºŒè¿›åˆ¶æ•°å­—è½¬åŒ–ä¸ºåå…­è¿›åˆ¶æ•°å­—ï¼Œéœ€è¦é¦–å…ˆå°†å…¶åˆ†ä¸ºå¤šä¸ª 4 ä½çš„ç»„ï¼Œç„¶åå†å°†æ¯ç»„æ•°è½¬åŒ–ä¸ºåå…­è¿›åˆ¶ã€‚å¦‚æœæ€»ä½æ•°ä¸ä¸º 4 çš„å€æ•°ï¼Œé‚£ä¹ˆæœ€å·¦è¾¹çš„ä¸€ç»„å¯ä»¥å°‘äºå››ä½ï¼Œç„¶ååœ¨é¦–ä½è¡¥ 0ã€‚å¦‚ $111100_2$ å¯ä»¥åˆ†æˆ $0011_2$ å’Œ $1100_2$ï¼Œè½¬åŒ–ç»“æœä¸º $3C_{16}$ ã€‚åœ¨ C ä¸­ï¼Œè‹¥ä¸€ä¸ªå¸¸æ•°ä»¥ 0x æˆ– 0X ä½œä¸ºå‰ç¼€ï¼Œåˆ™ä»£è¡¨å®ƒæ˜¯ä¸€ä¸ªåå…­è¿›åˆ¶æ•°å­—ã€‚\næ•°æ®å¤§å° æ¯å°è®¡ç®—æœºéƒ½æœ‰ä¸€ä¸ªå­—é•¿ï¼ˆWord Sizeï¼‰ï¼Œå®ƒæŒ‡å®šäº†æŒ‡é’ˆæ•°æ®çš„æ ‡å‡†å¤§å°ã€‚å¦‚æœä¸€å°æœºå™¨çš„å­—é•¿ä¸º $w$ ä½ï¼Œé‚£ä¹ˆè™šæ‹Ÿåœ°å€çš„èŒƒå›´ä¸º $0ï½2^w -1$ï¼Œç¨‹åºæœ€å¤šå¯ä»¥è®¿é—® $2^w$ å­—èŠ‚ã€‚32 ä½æœºå™¨çš„è™šæ‹Ÿåœ°å€å¤§å°çº¦ä¸º 4 GBï¼Œè€Œ 64 ä½æœºå™¨åˆ™èƒ½è¾¾åˆ° 16 EBã€‚\nC ä¸­å‡ ä¸ªåŸºæœ¬æ•°æ®ç±»å‹çš„å¤§å°å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š\nSigned Unsigned 32-bit 64-bit [signed] char unsigned char 1 1 short unsigned short 2 2 int unsigned 4 4 long unsigned long 4 8 int32_t uint_32t 4 4 int64_t uint_64t 8 8 char * 4 8 float 4 4 double 8 8 é™¤charå¤–ï¼Œè‹¥ä¸æ·»åŠ å‰ç¼€unsignedï¼Œåˆ™é»˜è®¤ä½¿ç”¨æœ‰ç¬¦å·ç±»å‹ã€‚æŒ‡é’ˆç±»å‹çš„æ•°æ®ä½¿ç”¨æœºå™¨çš„å…¨å­—é•¿ï¼Œå¦‚char *ã€‚ç”±äºæŸäº›æ•°æ®ç±»å‹çš„å¤§å°åœ¨ä¸åŒæœºå™¨ä¸Šæœ‰æ‰€ä¸åŒï¼Œå› æ­¤å¼€å‘äººå‘˜åº”ä½¿ç¨‹åºå¯¹ä¸åŒæ•°æ®ç±»å‹çš„ç¡®åˆ‡å¤§å°ä¸æ•æ„Ÿï¼Œä»è€Œä¿è¯ç¨‹åºçš„å¯ç§»æ¤æ€§ï¼ˆPortableï¼‰ã€‚\nå¯»å€å’Œå­—èŠ‚é¡ºåº å¯¹äºåŒ…å«å¤šå­—èŠ‚çš„ç¨‹åºå¯¹è±¡ï¼Œæˆ‘ä»¬å¿…é¡»å»ºç«‹ä¸¤ä¸ªå‡†åˆ™ï¼šè¿™ä¸ªå¯¹è±¡çš„åœ°å€æ˜¯ä»€ä¹ˆå’Œè¿™äº›å­—èŠ‚åœ¨å†…å­˜ä¸­çš„æ’åˆ—é¡ºåºæ˜¯æ€æ ·çš„ã€‚æŸäº›æœºå™¨æŒ‰ç…§ä»æœ€ä½æœ‰æ•ˆå­—èŠ‚åˆ°æœ€é«˜æœ‰æ•ˆå­—èŠ‚çš„é¡ºåºå­˜å‚¨å¯¹è±¡ï¼Œè¯¥æ–¹å¼è¢«ç§°ä¸ºå°ç«¯æ³•ï¼ˆLittle Endianï¼‰ï¼›æŸäº›æœºå™¨åˆ™ä¸ä¹‹ç›¸åï¼Œè¢«ç§°ä¸ºå¤§ç«¯æ³•ï¼ˆBig Endianï¼‰ã€‚ä¾‹å¦‚ä¸€ä¸ªintç±»å‹çš„å˜é‡åœ°å€ä¸º 0x100ï¼Œå…¶å€¼ä¸ºåå…­è¿›åˆ¶çš„ 0x1234567ï¼Œé‚£ä¹ˆä¸Šè¿°ä¸¤ç§æœºå™¨å­˜å‚¨è¯¥å˜é‡çš„æ–¹å¼åˆ†åˆ«å¦‚ä¸‹ï¼š\nLittle Endian\n0x100 0x101 0x102 0x103 â€¦ 67 45 23 01 â€¦ Big Endian\n0x100 0x101 0x102 0x103 â€¦ 01 23 45 67 â€¦ æœ‰äº›æ—¶å€™ä¸åŒçš„å­—èŠ‚å­˜å‚¨é¡ºåºå¯èƒ½å¯¼è‡´ä¸€äº›é—®é¢˜ï¼š\nä¸åŒç±»å‹çš„æœºå™¨é€šè¿‡ç½‘ç»œä¼ é€’äºŒè¿›åˆ¶æ•°æ®ï¼Œå¦‚å°ç«¯æ³•æœºå™¨ç”Ÿæˆçš„æ•°æ®å‘é€åˆ°å¤§ç«¯æ³•æœºå™¨ä¸Šï¼Œç¨‹åºæ”¶åˆ°çš„å­—èŠ‚åºåˆ—æ˜¯åçš„ã€‚ä¸ºäº†é¿å…è¿™ä¸€é—®é¢˜ï¼Œå‘é€æ–¹åº”å…ˆå°†æ•°æ®è½¬æ¢ä¸ºç½‘ç»œæ ‡å‡†æ ¼å¼ï¼Œæ¥æ”¶æ–¹å†å°†å…¶è½¬æ¢ä¸ºå†…éƒ¨è¡¨è¾¾æ–¹å¼ï¼› å¯¹äºå°ç«¯æ³•æœºå™¨ï¼Œä¹¦å†™å­—èŠ‚åºåˆ—ä¸ä¹¦å†™æ•°å­—çš„é¡ºåºç›¸åï¼› æŸäº›ä½¿ç”¨å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼ˆCastï¼‰çš„ç¨‹åºï¼Œåœ¨ä¸åŒç±»å‹çš„æœºå™¨ä¸Šç¼–è¯‘è¿è¡Œçš„ç»“æœä¸åŒã€‚ å¯¹äºä¸Šè¿°ç¬¬ä¸‰ç§æƒ…å†µï¼Œæˆ‘ä»¬ä»¥ä¸€ä¸ªç¨‹åºä¸ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 #include \u003cstdio.h\u003e typedef unsigned char *byte_pointer; void show_bytes(byte_pointer start, size_t len) { size_t i; for (i = 0; i \u003c len; i++) { // %.2x ä»£è¡¨æ•´æ•°ä¼šè¢«æ‰“å°ä¸ºè‡³å°‘ä¸¤ä½ï¼ˆdigitsï¼‰çš„åå…­è¿›åˆ¶æ•°å­— printf(\"%.2x\", start[i]); } printf(\"\\n\"); } void show_int(int x) { show_bytes((byte_pointer)\u0026x, sizeof(int)); } void show_float(float x) { show_bytes((byte_pointer)\u0026x, sizeof(float)); } void show_pointer(void *x) { show_bytes((byte_pointer)\u0026x, sizeof(void *)); } int main() { int val = 12345; float fval = (float) val; int *pval = \u0026val; show_int(val); show_float(fval); show_pointer(pval); } ä¸åŒç±»å‹æœºå™¨çš„è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š\nMachine val fval pval Linux32 0x39300000 0x00e44046 0xe4f9ffbf Windows32 0x39300000 0x00e44046 0xb4cc2200 Sun 0x00003039 0x4640e400 0xeffffa0c Linux64 0x39300000 0x00e44046 0xb811e5ffff7f0000 è¿™æ˜¯å› ä¸º Sun ç³»ç»Ÿé‡‡ç”¨å¤§ç«¯æ³•ï¼Œå…¶ä»–ä¸‰è€…é‡‡ç”¨å°ç«¯æ³•ã€‚å¯¹äºæŒ‡é’ˆç±»å‹çš„å˜é‡ï¼Œä¸åŒæ“ä½œç³»ç»Ÿåœ¨å­˜å‚¨åˆ†é…ä¸Šæœ‰ç€ä¸åŒçš„å‡†åˆ™ã€‚åŒæ—¶ï¼Œ64 ä½ç³»ç»Ÿä½¿ç”¨ 8 å­—èŠ‚åœ°å€ï¼Œ32 ä½ç³»ç»Ÿä½¿ç”¨ 4 å­—èŠ‚åœ°å€ï¼Œè¿™å¯¼è‡´äº†æŒ‡é’ˆç±»å‹å˜é‡pvalè¾“å‡ºç»“æœçš„ä¸åŒã€‚\nå­—ç¬¦ä¸² å­—ç¬¦ä¸²åœ¨ C ä¸­è¢«ç¼–ç ä¸ºä¸€ä¸ªä»¥NULLå­—ç¬¦ç»“å°¾ï¼ˆå…¶å€¼ä¸º 0ï¼‰çš„å­—ç¬¦æ•°ç»„ï¼Œæ¯ä¸ªå­—ç¬¦éƒ½ç”±æŸç§æ ‡å‡†ç¼–ç ç»„æˆï¼Œå¦‚ ASCII ç ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬æ‰§è¡Œä¸Šé¢çš„ç¨‹åºshow_bytes(\"12345\", 6)ï¼Œå°†å¾—åˆ°31 32 33 34 35 00ã€‚\nç”±äºå­—ç¬¦ä¸²ä¸­å„å­—ç¬¦çš„æ’åˆ—é¡ºåºæ˜¯ç”±å­—ç¬¦ä¸²æœ¬èº«å†³å®šçš„ï¼Œå› æ­¤å­—ç¬¦ä¸²ä¸ä¼šå—åˆ°å­—èŠ‚é¡ºåºçš„å½±å“ï¼Œé™¤éå­—ç¬¦ä½¿ç”¨ä¸¤å­—èŠ‚çš„ Unicode è¿›è¡Œç¼–ç ã€‚\nä»£ç  ä¸åŒç±»å‹çš„æœºå™¨ä½¿ç”¨ä¸åŒä¸”ä¸å…¼å®¹çš„æŒ‡ä»¤å’Œç¼–ç æ–¹å¼ï¼Œå› æ­¤äºŒè¿›åˆ¶ä»£ç å¾ˆå°‘èƒ½åœ¨ä¸åŒæœºå™¨å’Œæ“ä½œç³»ç»Ÿç»„åˆä¹‹é—´ç§»æ¤ã€‚\nå¸ƒå°”ä»£æ•°ç®€ä»‹ å‡ ç§å¸ƒå°”è¿ç®—ç¬¦çš„å®šä¹‰å¦‚ä¸‹ï¼š\nï½ï¼šéï¼Œç›¸å½“äºé€»è¾‘è¿ç®—çš„ NOTï¼› \u0026ï¼šä¸ï¼Œç›¸å½“äºé€»è¾‘è¿ç®—çš„ ANDï¼› |ï¼šæˆ–ï¼Œç›¸å½“äºé€»è¾‘è¿ç®—çš„ ORï¼› ^ï¼šå¼‚æˆ–ï¼Œç›¸å½“äºé€»è¾‘è¿ç®—çš„ EXCLUSIVE-ORã€‚è‹¥ $p = 0$ï¼Œ$q = 1$ æˆ– $p = 1$ï¼Œ$q = 0$ æ—¶ï¼Œ$p \\text{\\textasciicircum} q = 1$ã€‚ å¸ƒå°”è¿ç®—ç¬¦å¯ä»¥åº”ç”¨äºä½å‘é‡ï¼Œå³å›ºå®šé•¿åº¦çš„ 0ã€1 åºåˆ—ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œè‹¥ a ä¸º [0110]ï¼Œb ä¸º [0101]ï¼Œé‚£ä¹ˆï¼š\nOperation Result ~a [1001] a \u0026 b [0100] a | b [0111] a ^ b [0011] C ä¸­çš„ä½çº§è¿ç®— C ä¸­æ”¯æŒæŒ‰ä½å¸ƒå°”è¿ç®—ï¼Œä¸Šé¢æåˆ°çš„å¸ƒå°”è¿ç®—ç¬¦å…¶å®å°±æ˜¯åœ¨ C ä¸­ä½¿ç”¨çš„ã€‚ä¸€ä¸ªä½¿ç”¨å¸ƒå°”è¿ç®—ç¬¦çš„ç»å…¸ç¨‹åºå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 #include \u003cstdio.h\u003e void inplace_swap(int *x, int *y) { *y = *x ^ *y; *x = *x ^ *y; *y = *x ^ *y; } åˆ©ç”¨å¯¹äºä»»æ„æ•° $a$ ï¼Œ$a \\text{\\textasciicircum} a$ = 0 ä¸” $0 \\text{\\textasciicircum} a = a$ è¿™ä¸€æ€§è´¨ï¼Œè¯¥ç¨‹åºä¸ä½¿ç”¨ä¸­é—´å˜é‡ä¾¿å®Œæˆäº†å˜é‡å€¼çš„äº¤æ¢ã€‚å¦å¤–ï¼Œä¸Šè¿°ç¨‹åºçš„å®ç°è¿˜å»ºç«‹åœ¨å¼‚æˆ–è¿ç®—æ»¡è¶³äº¤æ¢å¾‹å’Œç»“åˆå¾‹çš„åŸºç¡€ä¹‹ä¸Šã€‚\nC ä¸­çš„é€»è¾‘è¿ç®— C è¿˜æä¾›äº†é€»è¾‘è¿ç®—ç¬¦ï¼Œå³||ã€\u0026\u0026å’Œ!ã€‚å®ƒä»¬å’Œä½çº§è¿ç®—çš„ä¸€ä¸ªåŒºåˆ«æ˜¯ï¼Œå¦‚æœå¯¹ç¬¬ä¸€ä¸ªå‚æ•°æ±‚å€¼å°±èƒ½ç¡®å®šè¡¨è¾¾å¼çš„ç»“æœï¼Œä¾¿ä¸ä¼šå¯¹ç¬¬äºŒä¸ªå‚æ•°è¿›è¡Œæ±‚å€¼ã€‚å¦‚è¡¨è¾¾å¼a \u0026\u0026 5 / aä¸ä¼šå¯¼è‡´é™¤æ•°ä¸º 0 çš„å¼‚å¸¸ï¼Œè€Œp \u0026\u0026 *p++ä¹Ÿä¸ä¼šå¯¼è‡´ç©ºæŒ‡é’ˆå¼•ç”¨å¼‚å¸¸ã€‚\nC ä¸­çš„ç§»ä½è¿ç®— C ä¸­çš„ç§»ä½è¿ç®—æœ‰å·¦ç§»å’Œå³ç§»ä¸¤ç§ï¼Œå‡ä¸ä¼šæ”¹å˜ä½å‘é‡çš„é•¿åº¦ã€‚å·¦ç§»è¿ç®— $x Â« k$ å°±æ˜¯ $x$ å‘å·¦ç§»åŠ¨ $k$ ä½ï¼Œä¸¢å¼ƒ $k$ ä¸ªé«˜ä½ï¼Œå¹¶åœ¨å³ç«¯è¡¥å…… $k$ ä¸ª 0ã€‚é€šå¸¸å¯ä»¥ä½¿ç”¨ $x Â« 1$ å’Œ $x Â« 2$ åˆ†åˆ«ä»£æ›¿ $x \\times 2$ å’Œ $x \\times 4$ï¼Œå› ä¸ºä½çº§è¿ç®—æ‹¥æœ‰ç›¸æ¯”ä¹˜æ³•æ›´å¿«çš„è¿ç®—é€Ÿåº¦ã€‚\nå³ç§»è¿ç®—åˆ†ä¸ºä¸¤ç§å½¢å¼ï¼Œé€»è¾‘å’Œç®—æœ¯ã€‚æ— ç¬¦å·æ•°æ®å¿…é¡»ä½¿ç”¨é€»è¾‘å³ç§»ï¼Œ$x Â» k$ å°† x çš„å·¦ç«¯è¡¥å…… $k$ ä¸ª 0 ï¼Œå¹¶ä¸¢å¼ƒ $k$ ä¸ªä½ä½ã€‚è€Œå¤§å¤šæ•°æœºå™¨ä½¿ç”¨ç®—æœ¯å³ç§»å¤„ç†æœ‰ç¬¦å·æ•°æ®ï¼Œ$x Â» k$ å°† $x$ çš„å·¦ç«¯è¡¥å…… $k$ ä¸ªæœ€é«˜æœ‰æ•ˆä½çš„æ‹·è´ï¼Œå¹¶ä¸¢å¼ƒ $k$ ä¸ªä½ä½ã€‚\nåŠ å‡ä¹˜é™¤è¿ç®—ç¬¦çš„ä¼˜å…ˆçº§å¤§äºç§»ä½è¿ç®—ç¬¦ï¼Œå› æ­¤ $1 Â« 2 + 3 Â« 4$ ç­‰æ•ˆäº $1 Â« (2 + 3) Â« 4$ã€‚\næ•´æ•°çš„è¡¨ç¤º æ— ç¬¦å·ç¼–ç  ä¸€ä¸ªé•¿åº¦ä¸º $w$ çš„ä½å‘é‡ $\\vec{x} = [x_{w-1},x_{w-2},â€¦,x_0]$ï¼Œå®ƒä»äºŒè¿›åˆ¶ï¼ˆBinaryï¼‰è½¬åŒ–ä¸ºæ— ç¬¦å·ç¼–ç ï¼ˆUnsignedï¼‰çš„å…¬å¼ä¸ºï¼š\n$$ B2U_w(\\vec{x}) \\doteq \\displaystyle\\sum_{i=0}^{w - 1}x_i2^i $$\nå…¶ä¸­ï¼Œ $\\doteq$ ç¬¦å·è¡¨ç¤ºç­‰å¼çš„å·¦æ‰‹è¾¹è¢«å®šä¹‰ä¸ºå³æ‰‹è¾¹ã€‚æ— ç¬¦å·ç¼–ç çš„æœ€å°å€¼ä¸ºä½å‘é‡ [00â€¦0]ï¼Œå³æ•´æ•°å€¼ 0ã€‚æœ€å¤§å€¼ä¸ºä½å‘é‡ [11â€¦1]ï¼Œå³æ•´æ•°å€¼ $U\\max_w \\doteq \\displaystyle\\sum_{i=0}^{w - 1}2^i = 2^w -1$ã€‚å‡½æ•° $B2U_w$ æ˜¯ä¸€ä¸ªåŒå°„ï¼ˆBijectionï¼‰ï¼šå¯¹äºæ¯ä¸ªé•¿åº¦ä¸º $w$ çš„ä½å‘é‡ï¼Œéƒ½æœ‰å”¯ä¸€çš„æ•´æ•°å€¼ä¸ä¹‹å¯¹åº”ï¼Œåä¹‹äº¦ç„¶ã€‚\näºŒè¿›åˆ¶è¡¥ç  äºŒè¿›åˆ¶è¡¥ç ï¼ˆTwoâ€™s-Complement Encodingï¼‰å°†ä½å‘é‡çš„ç¬¦å·ä½ï¼ˆå³æœ€é«˜æœ‰æ•ˆä½ï¼‰ä½œä¸ºè´Ÿæƒé‡ï¼ˆNegative Weightï¼‰ï¼Œç¬¦å·ä½ä¸º 1 ä»£è¡¨å€¼ä¸ºè´Ÿï¼Œç¬¦å·ä½ä¸º 0 ä»£è¡¨å€¼ä¸ºæ­£ã€‚å¦‚ä¸€ä¸ªé•¿åº¦ä¸º $w$ çš„ä½å‘é‡ $\\vec{x} = [x_{w-1},x_{w-2},â€¦,x_0]$ï¼Œå®ƒä»äºŒè¿›åˆ¶è½¬åŒ–ä¸ºäºŒè¿›åˆ¶è¡¥ç çš„å…¬å¼ä¸ºï¼š\n$$ B2T_w(\\vec{x}) \\doteq -x_{w - 1}2^{w - 1} + \\displaystyle\\sum_{i=0}^{w - 2}x_i2^i $$\näºŒè¿›åˆ¶è¡¥ç çš„æœ€å°å€¼ä¸ºä½å‘é‡ [10â€¦0]ï¼Œå³æ•´æ•°å€¼ $T\\min_w \\doteq -2^{w-1}$ã€‚æœ€å¤§å€¼ä¸ºä½å‘é‡ [01â€¦1]ï¼Œå³æ•´æ•°å€¼ $T\\max_w \\doteq \\displaystyle\\sum_{i=0}^{w - 2}2^i = 2^{w-1} -1$ã€‚ä¸äºŒè¿›åˆ¶è½¬åŒ–æ— ç¬¦å·ç¼–ç ç±»ä¼¼ï¼Œå‡½æ•° $B2T_w$ ä¹Ÿæ˜¯ä¸€ä¸ªåŒå°„ã€‚è€Œå®ƒä»¬çš„æœ€å€¼ä¹‹é—´æœ‰ç€å¦‚ä¸‹æ€§è´¨ï¼š\n$$ |T\\min| =|T\\max| + 1$$ $$ U\\max = 2T\\max + 1$$\nç‰¹åˆ«åœ°ï¼Œæ•´æ•° -1 å’Œ $U\\max_w$çš„ä½çº§è¡¨ç¤ºå‡ä¸ºå…¨ 1ï¼š[11â€¦1]ï¼Œè€Œæ•´æ•° 0 åœ¨ä¸¤ç§è¡¨è¾¾æ–¹å¼ä¸­å‡ä¸ºå…¨ 0ï¼š[00â€¦0]ã€‚è™½ç„¶ C æ ‡å‡†å¹¶æ²¡æœ‰é™åˆ¶æœ‰ç¬¦å·æ•´æ•°çš„äºŒè¿›åˆ¶è¡¨è¾¾ï¼Œä½†å¤§å¤šæ•°æœºå™¨éƒ½é‡‡ç”¨äº†äºŒè¿›åˆ¶è¡¥ç çš„æ–¹å¼ã€‚\næœ‰ç¬¦å·æ•°å’Œæ— ç¬¦å·æ•°çš„è½¬æ¢ åœ¨ C ä¸­ï¼Œæœ‰ç¬¦å·æ•°å’Œæ— ç¬¦å·æ•°ä¹‹é—´çš„è½¬æ¢æ˜¯åŸºäºä½çº§è§†è§’çš„ï¼Œè€Œéæ•°å­—ã€‚ä¾‹å¦‚ï¼š\n1 2 3 short int v = -12345; unsigned short uv = (unsigned short) v; printf(\"v = %d, uv = %u\\n\", v, uv); è¾“å‡ºç»“æœä¸ºv = -12345ï¼Œuv = 53191ã€‚è¿™æ„å‘³ç€åœ¨ç±»å‹è½¬æ¢è¿‡ç¨‹ä¸­ä½å‘é‡ä¸å˜ï¼Œä½†ä½å‘é‡è½¬æ¢åˆ°æ•´æ•°å€¼çš„æ–¹å¼ä¸åŒã€‚æ ¹æ®æ¨å¯¼ï¼ŒäºŒè¿›åˆ¶è¡¥ç è½¬æ¢ä¸ºæ— ç¬¦å·æ•°çš„å…¬å¼å¦‚ä¸‹ï¼š\n$$T2U_w(x) = \\begin{cases} x + 2^w \u0026\\text x \u003c 0 \\cr x \u0026\\text x \\geq 0 \\end{cases}$$\nå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œéè´Ÿæ•°è½¬æ¢å‰åä¿æŒä¸å˜ï¼Œè´Ÿæ•°åˆ™å˜æˆäº†ä¸€ä¸ªæ›´å¤§çš„æ­£æ•°ï¼š\nè€Œæ— ç¬¦å·æ•°è½¬æ¢ä¸ºäºŒè¿›åˆ¶è¡¥ç çš„å…¬å¼åˆ™ä¸ºï¼š\n$$U2T_w(u) = \\begin{cases} u \u0026\\text u \\leq T\\max_w \\cr u - 2^w \u0026\\text u \u003e T\\max_w \\end{cases}$$\nå¦‚å›¾æ‰€ç¤ºï¼Œå°äº $2 ^ {w - 1}$ ï¼ˆæœ€é«˜æœ‰æ•ˆä½ä¸º 0ï¼‰çš„æ•°è½¬æ¢å‰åä¿æŒä¸å˜ï¼Œå¤§äºç­‰äº $2 ^ {w - 1}$ ï¼ˆæœ€é«˜æœ‰æ•ˆä½ä¸º 1ï¼‰çš„æ•°å°†è¢«è½¬æ¢ä¸ºä¸€ä¸ªè´Ÿæ•°ï¼š\né€šè¿‡ä¸Šé¢çš„è®¨è®ºæˆ‘ä»¬å‘ç°ï¼Œå¤§äºç­‰äº 0 ä¸”å°äº $2 ^ {w - 1}$ çš„å€¼æœ‰ç›¸åŒçš„æ— ç¬¦å·å’ŒäºŒè¿›åˆ¶è¡¥ç è¡¨ç¤ºã€‚è€Œè¿™ä¸ªèŒƒå›´ä¹‹å¤–çš„æ•°ï¼Œåœ¨è½¬æ¢è¿‡ç¨‹ä¸­éœ€è¦åŠ ä¸Šæˆ–å‡å» $2 ^ w$ã€‚\nC ä¸­çš„æœ‰ç¬¦å·æ•°å’Œæ— ç¬¦å·æ•° é€šå¸¸æˆ‘ä»¬é»˜è®¤æ•°å­—æ˜¯æœ‰ç¬¦å·çš„ï¼Œé™¤éåŠ ä¸Šåç¼€ U æˆ– uï¼Œå¦‚ 12345U å’Œ 0x1A2Bu ç­‰ã€‚é™¤äº†æ˜¾å¼åœ°ä½¿ç”¨å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼ˆå¦‚ä¸Šä¸€èŠ‚ä¸­çš„ç¨‹åºï¼‰ä»¥å¤–ï¼Œä¹Ÿå¯ä»¥å°†ä¸€ç§ç±»å‹çš„è¡¨è¾¾å¼èµ‹å€¼ç»™å¦ä¸€ç§å˜é‡ï¼Œå³éšå¼è½¬æ¢ï¼š\n1 2 3 4 int tx, ty; unsigned ux, uy; tx = ux; /* Cast to signed*/ uy = ty; /* Cast to usigned*/ å¦‚æœå‚ä¸è¿ç®—çš„ä¸¤ä¸ªæ•°ä¸€ä¸ªæ˜¯æœ‰ç¬¦å·çš„ï¼Œä¸€ä¸ªæ˜¯æ— ç¬¦å·çš„ï¼Œé‚£ä¹ˆ C ä¼šéšå¼åœ°å°†æœ‰ç¬¦å·æ•°è½¬æ¢ä¸ºæ— ç¬¦å·æ•°å¹¶å‡å®šä¸¤æ•°å‡ä¸ºéè´Ÿåå†è¿›è¡Œè®¡ç®—ã€‚æ¯”å¦‚è¡¨è¾¾å¼ -1 \u003c 0U çš„å€¼ä¸º falseï¼Œå› ä¸º -1 ä¼šå…ˆè¢«è½¬æ¢ä¸ºæ— ç¬¦å·æ•°å†ä¸ 0 è¿›è¡Œæ¯”è¾ƒã€‚\næ‰©å±•ä¸€ä¸ªæ•°çš„ä½çº§è¡¨ç¤º è¦å°†ä¸€ä¸ªæ— ç¬¦å·æ•°è½¬æ¢ä¸ºæ›´å¤§çš„æ•°æ®ç±»å‹ï¼Œåªéœ€ç®€å•åœ°åœ¨å¤´éƒ¨æ·»åŠ  0ï¼Œè¿™ç§è¿ç®—è¢«ç§°ä¸ºé›¶æ‰©å±•ï¼ˆZero Extensionï¼‰ã€‚è€Œå¯¹äºäºŒè¿›åˆ¶è¡¥ç ï¼Œåˆ™éœ€è¦åœ¨å¤´éƒ¨æ·»åŠ æœ€é«˜æœ‰æ•ˆä½ï¼ˆç¬¦å·ä½ï¼‰ï¼Œå³ç¬¦å·æ‰©å±•ï¼ˆSign Extensionï¼‰ã€‚\nå½“ç±»å‹è½¬æ¢æ—¢æ”¹å˜æ•°æ®ç±»å‹çš„å¤§å°åˆæ”¹å˜ç¬¦å·ç±»å‹æ—¶ï¼Œåˆ™å…ˆæ”¹å˜å¤§å°ï¼Œå†æ”¹å˜æœ‰æ— ç¬¦å·ã€‚ä¾‹å¦‚å°†ä¸€ä¸ªshortç±»å‹çš„å˜é‡è½¬æ¢ä¸ºunsignedç±»å‹ï¼Œå®ƒä¼šå…ˆè¢«è½¬æ¢ä¸ºintç±»å‹ï¼Œå†è¢«è½¬æ¢ä¸ºunsignedç±»å‹ã€‚\næˆªæ–­æ•°å­— å°†ä¸€ä¸ªæ•°è½¬æ¢ä¸ºæ›´å°çš„æ•°æ®ç±»å‹æ—¶ï¼Œæˆªæ–­æ•°å­—çš„ä½æ•°æ˜¯ä¸å¯é¿å…çš„ã€‚å¦‚ä¸€ä¸ª $w$ ä½çš„ä½å‘é‡ $\\vec{x} = [x_{w-1},x_{w-2},â€¦,x_0]$ è¢«æˆªæ–­ä¸º $k$ ä½æ—¶ï¼Œæˆ‘ä»¬ä¼šä¸¢å¼ƒ $w-k$ ä¸ªé«˜ä½ï¼Œå¾—åˆ° ${\\vec{x} = [x_{k-1},x_{k-2},â€¦,x_0]}$ã€‚æˆªæ–­æ•°å­—å¯èƒ½ä¼šå¯¼è‡´å€¼çš„å˜åŒ–ï¼š\n$$B2U_k([x_{k-1},x_{k-2},â€¦,x_0]) = B2U_w([x_{w-1},x_{w-2},â€¦,x_0]) \\bmod 2^k $$ $$B2T_k([x_{k-1},x_{k-2},â€¦,x_0])= U2T_k(B2U_w([x_{w-1},x_{w-2},â€¦,x_0]) \\bmod 2^k)$$\né€šè¿‡ä¸Šé¢å‡ å°èŠ‚çš„è®¨è®ºï¼Œæˆ‘ä»¬å‘ç°æ— ç¬¦å·æ•°ä¸æœ‰ç¬¦å·æ•°ä¹‹é—´çš„éšå¼è½¬æ¢å¯¼è‡´äº†ä¸€äº›ä¸å¸¸è¯†ç›¸æ‚–çš„è¿ç®—ç»“æœï¼Œè¿™å°†å¯¼è‡´ä¸€äº›å¾ˆéš¾å‘ç°çš„ç¨‹åºé”™è¯¯ã€‚å› æ­¤å¾ˆå¤šç¼–ç¨‹è¯­è¨€ï¼Œå¦‚ Javaï¼Œä¸æ”¯æŒæ— ç¬¦å·æ•°çš„ä½¿ç”¨ã€‚\næ•´æ•°çš„è¿ç®— æ— ç¬¦å·åŠ æ³• ä¸¤ä¸ªå¯ç”¨ $w$ ä½æ— ç¬¦å·ç¼–ç è¡¨ç¤ºçš„éè´Ÿæ•´æ•° $x$ å’Œ $y$ï¼Œå…¶èŒƒå›´ï¼š$0 \\leq x, y \\leq 2^w -1$ï¼Œé‚£ä¹ˆå®ƒä»¬çš„å’Œï¼š$0 \\leq x+ y \\leq 2^{w + 1} -2$ å°±æœ‰å¯èƒ½éœ€è¦ç”¨ $w+1$ ä½æ¥è¡¨ç¤ºã€‚å¦‚æœå‡ºç°æº¢å‡ºä¾¿ä¸¢å¼ƒé«˜ä½ï¼Œå› æ­¤æ— ç¬¦å·åŠ æ³•ï¼ˆ$+_w^u$ï¼‰ç­‰ä»·äºè®¡ç®— $(x+y) \\bmod 2^w$ï¼Œå³ï¼š\n$$x + _w^uy = \\begin{cases} x + y \u0026\\text x + y \u003c 2^w \u0026\\text Normal \\cr x + y - 2^w \u0026\\text 2^w \\leq x + y \u003c 2^{w+1} \u0026\\text \\space \\space \\space Overflow \\end{cases}$$\næ¨¡æ•°åŠ æ³•æ„æˆäº†ä¸€ç§æ•°å­¦ç»“æ„ï¼Œå³é˜¿è´å°”ç¾¤ï¼ˆAbelian Groupï¼‰ï¼Œå®ƒæ˜¯å¯äº¤æ¢çš„å’Œå¯ç»“åˆçš„ã€‚$w$ ä½æ— ç¬¦å·æ•°çš„é›†åˆæ‰§è¡Œ $+_w^u$ è¿ç®—ï¼Œå¯¹äºæ¯ä¸ªå€¼ $x$ï¼Œå¿…ç„¶æœ‰æŸä¸ªå€¼ $-_w^ux$ æ»¡è¶³ $-_w^ux +_w^ux = 0$ï¼Œè¯¥å€¼è¢«ç§°ä¸º $x$ çš„é€†å…ƒï¼ˆInverseï¼‰ã€‚å½“ $x = 0$ æ—¶ï¼Œå…¶é€†å…ƒè‡ªç„¶ä¸º 0ã€‚å½“ $x \u003e 0$ æ—¶ï¼Œæ˜¾ç„¶ $ (x + 2^w - x)\\bmod 2^w = 0$ã€‚ç”±äº $0 \u003c 2^w -x \u003c 2^w$ï¼Œå› æ­¤ $2^w -x$ ä¾¿æ˜¯ $x$ çš„é€†å…ƒã€‚ä¸Šè¿°ä¸¤ç§æƒ…å†µæ€»ç»“å¦‚ä¸‹ï¼š\n$$ -_w^ux = \\begin{cases} x \u0026\\text x = 0 \\cr 2^w -x \u0026\\text x \u003e 0 \\end{cases}$$\näºŒè¿›åˆ¶è¡¥ç åŠ æ³• ä¸¤ä¸ªæ•°çš„ $w$ ä½äºŒè¿›åˆ¶è¡¥ç ä¹‹å’Œï¼ˆ$+_w^t$ï¼‰ä¸æ— ç¬¦å·ä¹‹å’Œæœ‰ç€å®Œå…¨ç›¸åŒçš„ä½çº§è¡¨ç¤ºï¼Œå› æ­¤å¯¹äº $-2^{w-1} \\leq x, y \\leq 2^{w-1} -1$ ï¼Œæœ‰ï¼š\n$$\\begin{split} x +_w^ty \u0026=U2T_w(T2U_w(x) +_w^uT2U_w(y))\\cr \u0026=U2T_w[(x+y)\\bmod 2^w] \\end{split}$$\nè¿›ä¸€æ­¥åœ°ï¼Œæˆ‘ä»¬æ ¹æ®ä¸¤æ•°ä¹‹å’Œçš„èŒƒå›´ï¼Œå°†ä¸Šè¿°ç»“æœåˆ†æƒ…å†µè®¨è®ºï¼Œä»è€Œå¾—åˆ°ï¼š\n$$x + _w^ty = \\begin{cases} x + y + 2^w \u0026\\text x + y \u003c -2^{w-1} \u0026\\text \\space \\space \\space Negative \\space \\space Overflow \\cr x + y \u0026\\text -2^{w-1} \\leq x + y \u003c 2^{w-1} \u0026\\text Normal \\cr x + y - 2^w \u0026\\text x + y \\geq 2^{w-1} \u0026\\text \\space \\space \\space Positive \\space \\space Overflow \\end{cases}$$\nå› æ­¤ï¼Œè‹¥ $x\u003e0, y\u003e0, x+_w^ty\\leq 0$ï¼Œé‚£ä¹ˆç»“æœä¾¿å‡ºç°äº†æ­£æº¢å‡ºï¼›è‹¥ $x\u003c0, y\u003c0, x+_w^ty\\geq 0$ï¼Œç»“æœä¾¿å‡ºç°äº†è´Ÿæº¢å‡ºã€‚\näºŒè¿›åˆ¶è¡¥ç çš„é€†å…ƒè®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š\n$$ -_w^tx = \\begin{cases} T\\min_w \u0026\\text x = T\\min_w \\cr -x \u0026\\text x \u003e T\\min_w \\end{cases}$$\næ— ç¬¦å·ä¹˜æ³• æ— ç¬¦å·ä¹˜æ³•è¿ç®—ï¼ˆ$\\times_w^u$ï¼‰ä¸åŠ æ³•ç±»ä¼¼ï¼Œéƒ½å¯ä»¥è½¬æ¢ä¸ºå¯¹ $2^w$ çš„æ¨¡è¿ç®—ï¼š\n$$x\\times_w^uy=(x \\times y)\\bmod2^w$$\näºŒè¿›åˆ¶è¡¥ç ä¹˜æ³• åŒæ ·ä¸åŠ æ³•ç±»ä¼¼ï¼Œä¸¤ä¸ªæ•°çš„ $w$ ä½äºŒè¿›åˆ¶è¡¥ç ä¹‹ç§¯ï¼ˆ$\\times_w^t$ï¼‰ä¸æ— ç¬¦å·ä¹‹ç§¯æœ‰ç€å®Œå…¨ç›¸åŒçš„ä½çº§è¡¨ç¤ºï¼Œå› æ­¤ï¼š\n$$\\begin{split} x \\times_w^ty \u0026=U2T_w(T2U_w(x)\\times_w^uT2U_w(y))\\cr \u0026=U2T_w[(x \\times y)\\bmod 2^w] \\end{split}$$\nä¹˜ä»¥å¸¸æ•° æ•´æ•°ä¹˜æ³•è¿ç®—åœ¨è®¸å¤šæœºå™¨ä¸Šè¿è¡Œç¼“æ…¢ï¼Œä¸€ä¸ªé‡è¦çš„ä¼˜åŒ–ä¾¿æ˜¯ä½¿ç”¨ç§»ä½è¿ç®—å’ŒåŠ æ³•è¿ç®—æ¥ä»£æ›¿å®ƒã€‚æˆ‘ä»¬é¦–å…ˆè€ƒè™‘ä¹˜ä»¥ 2 çš„å¹‚çš„æƒ…å†µï¼Œç„¶åæ¨å¹¿åˆ°ä»»æ„å¸¸æ•°ã€‚è‹¥å­˜åœ¨ä½å‘é‡ $[x_{w-1},x_{w-2},â€¦,x_0]$ï¼Œ$x \\times 2^k$ å¯ä»¥è¡¨ç¤ºä¸ºåœ¨å…¶å³ç«¯æ·»åŠ  $k$ ä¸ª 0ï¼Œå³ $[x_{w-1},x_{w-2},â€¦,x_0,0,â€¦,0]$ã€‚å› æ­¤åœ¨ C ä¸­ï¼Œå¯¹äºæ•´æ•° $x$ ï¼ˆæ— è®ºæ˜¯æ— ç¬¦å·æ•°è¿˜æ˜¯äºŒè¿›åˆ¶è¡¥ç ï¼‰å’Œ æ— ç¬¦å·æ•° $k$ï¼Œ$x \\times 2^k$ å°±ç­‰äº $xÂ«k$ã€‚\nå¦‚æœä¸€ä¸ªå¸¸æ•°å¯ä»¥æ‹†åˆ†ä¸º 2 çš„å¹‚çš„å’Œï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¾¿å¯ä»¥ä½¿ç”¨å·¦ç§»è¿ç®—å’ŒåŠ ï¼ˆå‡ï¼‰æ³•è¿ç®—æ¥æ›¿æ¢ä¸ç›¸å…³çš„ä¹˜æ³•è¿ç®—ã€‚å¦‚ $14=2^3+2^2+2^1$ï¼Œé‚£ä¹ˆ $x\\times14=(xÂ«3)+(xÂ«2)+(xÂ«1)$ã€‚\né™¤ä»¥ 2 çš„å¹‚ æˆ‘ä»¬ä½¿ç”¨å³ç§»è¿ç®—æ¥ä»£æ›¿é™¤æ³•è¿ç®—ï¼Œé€»è¾‘å³ç§»å’Œç®—æœ¯å³ç§»åˆ†åˆ«é€‚ç”¨äºæ— ç¬¦å·æ•°å’ŒäºŒè¿›åˆ¶è¡¥ç ã€‚ç”±äºç»“æœä¸ºæ•´æ•°ï¼Œå› æ­¤å¾ˆå¯èƒ½éœ€è¦è¿›è¡Œèˆå…¥ï¼ˆRoundï¼‰ã€‚æˆ‘ä»¬å®šä¹‰ $âŒŠ âŒ‹$ ä¸ºå‘ä¸‹å–æ•´ï¼Œ$âŒˆ âŒ‰$ ä¸ºå‘ä¸Šå–æ•´ã€‚å¦‚ $âŒŠ3.14âŒ‹=3$ï¼Œ$âŒŠ-3.14âŒ‹=-4$ï¼Œè€Œ $âŒˆ3.14âŒ‰=4$ï¼Œ$âŒˆ-3.14âŒ‰=-3$ã€‚\nåœ¨ C ä¸­ï¼Œå¯¹äºæ— ç¬¦å·æ•° $x, k$ï¼Œ $xÂ»k=âŒŠx/2^kâŒ‹$ï¼›å¯¹äºäºŒè¿›åˆ¶è¡¥ç  $x$ å’Œæ— ç¬¦å·æ•° $k$ï¼Œåˆ™æœ‰ $xÂ»k=âŒŠx/2^kâŒ‹$ã€‚å‰è€…ä¸ºé€»è¾‘å³ç§»ï¼Œåè€…ä¸ºç®—æœ¯å³ç§»ã€‚\nè€ƒè™‘åˆ°è‹¥ $x\u003c0$ï¼Œ$x/y$ çš„ç»“æœåº”ä¸º $âŒˆx/yâŒ‰$ï¼Œè€Œé $âŒŠx/yâŒ‹$ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨æ€§è´¨ï¼š$âŒˆx/yâŒ‰=âŒŠ(x+y-1)/yâŒ‹$ï¼Œæ¥ä¿®æ­£è¿™ç§ä¸åˆé€‚çš„èˆå…¥ã€‚å› æ­¤ï¼Œå¯¹äº $x\u003c0$ çš„äºŒè¿›åˆ¶è¡¥ç é™¤æ³•ï¼Œåº”ä½¿ç”¨ï¼š$(x+(1Â«k)-1)Â»k=âŒˆx/2^kâŒ‰$ã€‚ç»¼ä¸Šï¼ŒäºŒè¿›åˆ¶è¡¥ç é™¤ä»¥ 2 çš„å¹‚ $x/2^k$ å¯ä»¥ç”¨ä¸‰å…ƒè¿ç®—ç¬¦è¡¨ç¤ºä¸ºï¼š\n1 (x\u003c0 ? x+(1\u003c\u003ck)-1 : x) \u003e\u003e k ä¸ä¹˜æ³•ä¸åŒï¼Œé™¤æ³•æ— æ³•æ¨å¹¿åˆ°ä»»æ„å¸¸æ•°ã€‚\næµ®ç‚¹ äºŒè¿›åˆ¶å°æ•° åè¿›åˆ¶å°æ•°çš„è¡¨ç¤ºæ–¹æ³•ä¸º $d_md_{m-1}â€¦d_1d_0.d_{-1}d_{-2}â€¦d_{-n}$ï¼Œå…¶ä¸­ $d_i$ ä¸º 0ï½9 çš„æ•´æ•°ã€‚é‚£ä¹ˆè¯¥æ•°çš„å¤§å°ä¸ºï¼š\n$$d=\\displaystyle\\sum_{i=-n}^{m}10^id_i$$\nå°æ•°ç‚¹å·¦è¾¹çš„æ•°çš„æƒå€¼ä¸º 10 çš„éè´Ÿå¹‚ï¼Œå³è¾¹çš„åˆ™ä¸º 10 çš„è´Ÿå¹‚ã€‚ç±»ä¼¼åœ°ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºäºŒè¿›åˆ¶å°æ•°çš„è¡¨ç¤ºæ–¹æ³•ã€‚$b_i$ ä¸º 0 æˆ– 1ï¼Œåˆ™äºŒè¿›åˆ¶æ•° $b_mb_{m-1}â€¦b_1b_0.b_{-1}b_{-2}â€¦b{-n}$ çš„å€¼ä¸ºï¼š\n$$b=\\displaystyle\\sum_{i=-n}^{m}2^ib_i$$\näºŒè¿›åˆ¶å°æ•°ç‚¹å‘å·¦ç§»åŠ¨ä¸€ä½ï¼Œç›¸å½“äºæ•°å­—é™¤ä»¥ 2ã€‚å‘å³ç§»åŠ¨ä¸€ä½ï¼Œåˆ™ç›¸å½“äºæ•°å­—ä¹˜ä»¥ 2ã€‚è¿™ç§æ–¹æ³•åªèƒ½è¡¨ç¤ºå¯è½¬åŒ–ä¸º $x \\times 2^y$ å½¢å¼çš„æ•°ï¼Œæ— æ³•ç²¾ç¡®è¡¨ç¤ºå¦‚ $\\frac{1}{3}$ã€$\\frac{5}{7}$ è¿™æ ·çš„æ•°ã€‚\nIEEE æµ®ç‚¹æ•°è¡¨ç¤º äºŒè¿›åˆ¶å°æ•°çš„è¡¨ç¤ºæ–¹æ³•éš¾ä»¥è¡¨ç¤ºå¾ˆå¤§çš„æ•°ï¼Œæˆ‘ä»¬æ›´å¸Œæœ›é€šè¿‡ç»™å®š $x, y$ çš„å€¼æ¥è¡¨ç¤ºå½¢å¦‚ $x \\times 2^y$ çš„æ•°ã€‚IEEE æµ®ç‚¹æ•°æ ‡å‡†ä½¿ç”¨ $V=(-1)^s\\times M \\times 2^E$ çš„å½¢å¼æ¥è¡¨ç¤ºå°æ•°ï¼š\nç¬¦å· $s$ï¼šä¸º 1 ä»£è¡¨è´Ÿå€¼ï¼Œä¸º 0 ä»£è¡¨æ­£å€¼ï¼› æœ‰æ•ˆæ•° $M$ï¼šä¸€ä¸ªäºŒè¿›åˆ¶å°æ•°ï¼ŒèŒƒå›´åœ¨ 1 åˆ° $2-\\varepsilon$ æˆ– 0 åˆ° $1-\\varepsilon$ ä¹‹é—´ï¼› æŒ‡æ•° $E$ï¼š2 çš„å¹‚æŒ‡æ•°ï¼Œæœ‰å¯èƒ½æ˜¯è´Ÿæ•°ã€‚ å› æ­¤ï¼Œæµ®ç‚¹æ•°çš„ä½çº§è¡¨è¾¾åˆ†ä¸ºäº†ä¸‰ä¸ªéƒ¨åˆ†ï¼š\nä¸€ä¸ªç¬¦å·ä½ $s$; $k$ ä½çš„æŒ‡æ•°åŸŸ $exp=e_{k-1}â€¦e_1e_0$ ç¼–ç æŒ‡æ•° $E$ï¼› $n$ ä½çš„å°æ•°åŸŸ $frac=f_{n-1}â€¦f_1f_0$ ç¼–ç æœ‰æ•ˆæ•° $M$ã€‚ å¯¹äº C ä¸­çš„floatç±»å‹ï¼Œ$s=1, k=8, n=23$ã€‚è€Œå¯¹äºdoubleç±»å‹ï¼Œ$s=1, k=11, n=52$ã€‚IEEE æµ®ç‚¹æ•°è¡¨ç¤ºæ³•æœ‰ä¸‰ç§æƒ…å†µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nç¬¬ä¸€ç§æƒ…å†µæ˜¯æœ€å¸¸è§çš„ï¼Œå³æŒ‡æ•°åŸŸä¸å…¨ä¸º 0ï¼Œä¹Ÿä¸å…¨ä¸º 1ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒæŒ‡æ•°åŸŸçš„å€¼ä¸º $E=e-Bias$ï¼Œå…¶ä¸­ $e$ æ˜¯ä¸€ä¸ªä½çº§è¡¨è¾¾ä¸º $e_{k-1}â€¦e_1e_0$ çš„æ— ç¬¦å·æ•°ï¼Œ$Bias$ åˆ™æ˜¯ä¸€ä¸ªç­‰äº $2^{k-1}-1$ çš„å¸¸æ•°ã€‚å°æ•°åŸŸçš„å€¼ä¸º $M=1+f$ï¼Œå…¶ä¸­ï¼Œ$f$ æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶å°æ•° $0.f_{n-1}â€¦f_1f_0$ã€‚\nç¬¬äºŒå¼ æƒ…å†µæ˜¯æŒ‡æ•°åŸŸå…¨ä¸º 0ï¼Œè¿™æ ·æ‰€è¡¨ç¤ºçš„æ•°å°±æ˜¯éæ ‡å‡†åŒ–å½¢å¼çš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ$E=1-Bias, M=f$ã€‚éæ ‡å‡†åŒ–æ•°å¯ä»¥è¡¨ç¤ºç¬¬ä¸€ç§æƒ…å†µæ— æ³•è¡¨ç¤ºçš„ 0 ä»¥åŠéå¸¸æ¥è¿‘ 0 çš„æ•°å­—ã€‚\nç¬¬ä¸‰ç§æƒ…å†µæ˜¯æŒ‡æ•°åŸŸå…¨ä¸º 1 æ—¶å‡ºç°çš„ã€‚è‹¥å°æ•°åŸŸå…¨ä¸º 0ï¼Œå¾—åˆ°çš„å€¼åˆ™ä¸º $\\pm \\infin$ã€‚è‹¥å°æ•°åŸŸä¸å…¨ä¸º 0ï¼Œåˆ™ç»“æœä¸º NaNï¼Œå³ä¸æ˜¯ä¸€ä¸ªæ•°å­—ã€‚æ¯”å¦‚è®¡ç®— $\\infin -\\infin$ å’Œ $\\sqrt{-1}$ï¼Œå°±ä¼šå¾—åˆ°è¿™æ ·çš„ç»“æœã€‚\nä»¥ 8 ä½æµ®ç‚¹æ•°ä¸ºä¾‹ï¼Œ$s=1, k=4, n=3$ï¼Œæ­¤æ—¶åç§»é‡ $Bias=2^{4-1}-1=7$ã€‚æœ€é è¿‘ 0 çš„æ˜¯éæ ‡å‡†åŒ–æ•°ï¼Œ$E=1-Bias=-6$ï¼Œ$2^E=\\frac{1}{64}$ï¼Œ$M=f=0,\\frac{1}{8},â€¦,\\frac{7}{8}$ï¼Œå› æ­¤æµ®ç‚¹æ•° $V$ çš„èŒƒå›´å°±æ˜¯ 0 ï½$\\frac{7}{8\\times64}=\\frac{7}{512}$ã€‚è€Œå¯¹äºæœ€å°çš„æ ‡å‡†æ•°æ¥è¯´ï¼ŒæŒ‡æ•°åŸŸä¸º [0001]ï¼Œå› æ­¤ $E=e-Bias=-6$ï¼Œå°æ•°åŸŸ $M=1+f=1,\\frac{9}{8},â€¦\\frac{15}{8}$ï¼Œæµ®ç‚¹æ•° $V$ çš„èŒƒå›´ä¸º $\\frac{8}{512}=\\frac{1}{64}$ ~ $\\frac{15}{512}$ã€‚\næˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°æœ€å¤§éæ ‡å‡†æ•°å’Œæœ€å°æ ‡å‡†æ•°åˆ†åˆ«ä¸º $\\frac{7}{512}$ å’Œ $\\frac{8}{512}$ï¼Œè¿™ç§å¹³æ»‘çš„è¿‡æ¸¡å¾—ç›Šäºæˆ‘ä»¬å°†éæ ‡å‡†æ•°çš„ $E$ ä½¿ç”¨ $1-Bias$ æ¥è®¡ç®—ï¼Œè€Œé $-Bias$ã€‚\nåœ¨è¿™ç§æ¡ä»¶ä¸‹ï¼Œå½“æŒ‡æ•°åŸŸä¸º [1110]ï¼Œ$E=e-Bias=7, 2^E=128$ï¼Œå°æ•°åŸŸ $M=1+0.111_2=\\frac{15}{8}$ æ—¶ï¼Œ$V$ å–åˆ°æœ€å¤§å€¼ 240ï¼Œè¶…å‡ºè¿™ä¸ªå€¼å°±ä¼šæº¢å‡ºåˆ° $+\\infin$ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒIEEE æµ®ç‚¹æ•°å¯ä»¥ä½¿ç”¨æ•´æ•°æ’åºå‡½æ•°æ¥è¿›è¡Œæ’åºã€‚\nèˆå…¥ å¯¹æµ®ç‚¹æ•°çš„è¡¨ç¤ºé™åˆ¶äº†å…¶èŒƒå›´å’Œç²¾åº¦ï¼Œå› æ­¤æµ®ç‚¹è®¡ç®—åªèƒ½è¿‘ä¼¼åœ°è¡¨ç¤ºå®æ•°è®¡ç®—ã€‚IEEE æµ®ç‚¹æ•°æ ¼å¼å®šä¹‰äº†å››ç§ä¸åŒçš„èˆå…¥æ–¹å¼ï¼š\nå‘å¶æ•°èˆå…¥ï¼ˆRound-to-evenï¼‰ï¼Œä¹Ÿç§°å‘æœ€æ¥è¿‘çš„æ•°èˆå…¥ï¼ˆRound-to-nearestï¼‰ï¼Œæ˜¯é»˜è®¤çš„æ–¹æ³•ã€‚å®ƒè¯•å›¾æ‰¾åˆ°ä¸€ä¸ªæœ€æ¥è¿‘çš„åŒ¹é…å€¼ï¼Œå¯¹äºä¸­é—´å€¼ï¼ˆå¦‚è¡¨ä¸­çš„ 1.5ï¼‰ï¼Œåˆ™ä½¿ç»“æœçš„æœ€ä½æœ‰æ•ˆä½ä¸ºå¶æ•°ï¼ˆèˆå…¥ä¸º 2ï¼‰ã€‚å…¶ä»–ä¸‰ç§æ–¹æ³•ç”¨æ¥ç¡®å®šå€¼çš„ä¸Šä¸‹ç•Œã€‚\nå³ä½¿åœ¨èˆå…¥åˆ°å°æ•°çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ•´æ•°èˆå…¥ï¼Œåªéœ€ç®€å•åœ°è€ƒè™‘æœ€ä½æœ‰æ•ˆæ•°å­—æ˜¯å¶æ•°è¿˜æ˜¯å¥‡æ•°ã€‚å¦‚ä¿ç•™ä¸¤ä½å°æ•°ï¼Œæˆ‘ä»¬æŠŠåè¿›åˆ¶å°æ•° 1.234999 èˆå…¥åˆ° 1.23ï¼ŒæŠŠ 1.235001 èˆå…¥åˆ° 1.24ï¼Œè€Œ 1.235 å’Œ 1.245 å‡èˆå…¥åˆ° 1.24ã€‚è¿™ç§æ–¹æ³•åŒæ ·å¯ä»¥æ¨å¹¿åˆ°äºŒè¿›åˆ¶å°æ•°ï¼Œæ­¤æ—¶åº”å°†ä¸­é—´å€¼èˆå…¥åˆ°æœ€ä½æœ‰æ•ˆä½ç­‰äº 0 çš„æ•°ã€‚\næµ®ç‚¹è¿ç®— æµ®ç‚¹æ•°çš„åŠ æ³•å’Œä¹˜æ³•æ˜¯å®é™…è¿ç®—åè¿›è¡Œèˆå…¥åçš„ç»“æœï¼Œå³å¯¹äºå®æ•° $x, y$ï¼Œä»¥åŠè¿ç®— $\\odot$ï¼Œç»“æœä¸º $Round(x\\odot y)$ã€‚IEEE æ ‡å‡†è§„å®šäº†æµ®ç‚¹æ•°è¿ç®—çš„è¡Œä¸ºï¼Œè¿™æ„å‘³ç€å®ƒä¸ä¾èµ–äºä»»ä½•å…·ä½“çš„ç¡¬ä»¶æˆ–è½¯ä»¶ï¼Œä»è€Œå®ç°äº†å¯ç§»æ¤æ€§ã€‚\nä¸Šæ–‡æåˆ°æ•´æ•°çš„åŠ æ³•å’Œä¹˜æ³•å½¢æˆäº†é˜¿è´å°”ç¾¤ï¼Œè€Œå®æ•°äº¦å¦‚æ­¤ï¼Œä½†æµ®ç‚¹æ•°è¿˜è¦è€ƒè™‘èˆå…¥å¯¹å…¶ç‰¹æ€§çš„å½±å“ã€‚æµ®ç‚¹æ•° $\\infin$ å’Œ NaN æ²¡æœ‰é€†å…ƒï¼ŒåŠ æ³•ä¹Ÿåªæ»¡è¶³äº¤æ¢å¾‹ä½†ä¸æ»¡è¶³ç»“åˆå¾‹ã€‚ç±»ä¼¼åœ°ï¼Œæµ®ç‚¹æ•°ä¹˜æ³•åªæ»¡è¶³äº¤æ¢å¾‹ï¼Œè€Œä¸æ»¡è¶³ç»“åˆå¾‹å’Œåˆ†é…å¾‹ã€‚è¿™äº›ç‰¹æ€§çš„ç¼ºå°‘å¯¹ç¨‹åºå‘˜æœ‰ç€éå¸¸é‡è¦çš„å½±å“ï¼Œå¦‚ç¤ºä¾‹çš„ç®€å•ç¨‹åºï¼š\n1 2 x = a + b + c; y = b + c + d; ç¼–è¯‘å™¨å¯ä»¥ç”Ÿæˆä¸‹åˆ—ä»£ç ä»¥çœå»ä¸€æ¬¡æµ®ç‚¹åŠ æ³•è¿ç®—ï¼Œä»è€Œæå‡æ•ˆç‡ï¼š\n1 2 3 t = b + c; x = t + a; y = t + d; ç”±äºä½¿ç”¨äº†åŠ æ³•ç»“åˆå¾‹ï¼Œè®¡ç®—ç»“æœå¯èƒ½ä¸é¢„æœŸä¸åŒã€‚å› æ­¤å¤§å¤šæ•°ç¼–è¯‘å™¨å¯¹æµ®ç‚¹è¿ç®—çš„ä¼˜åŒ–éƒ½è¾ƒä¸ºä¿å®ˆï¼Œä»¥å…äº§ç”Ÿé”™è¯¯çš„ç»“æœã€‚\n","description":"","tags":["OS"],"title":"CSAPP è¯»ä¹¦ç¬”è®°ï¼šä¿¡æ¯çš„è¡¨ç¤ºå’Œå¤„ç†","uri":"/posts/representing-and-manipulating-information-note/"},{"content":"ä¿¡æ¯å°±æ˜¯ Bits + Context ä¸€å †äºŒè¿›åˆ¶ä½ï¼ˆBitsï¼‰å¯ä»¥è¡¨ç¤ºç³»ç»Ÿä¸­çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç£ç›˜ä¸­çš„æ–‡ä»¶ã€å†…å­˜ä¸­çš„ç¨‹åºå’Œç”¨æˆ·æ•°æ®ä»¥åŠç½‘ç»œä¸­ä¼ è¾“çš„æ•°æ®ï¼Œå”¯ä¸€å¯ä»¥åŒºåˆ†å®ƒä»¬çš„ä¾¿æ˜¯æˆ‘ä»¬æŸ¥çœ‹è¿™äº›æ•°æ®å¯¹è±¡æ—¶æ‰€å¤„çš„ä¸Šä¸‹æ–‡ï¼ˆContextï¼‰ã€‚ä¾‹å¦‚ï¼Œç›¸åŒçš„ä¸€ä¸²äºŒè¿›åˆ¶ä½åœ¨ä¸åŒçš„ä¸Šä¸‹æ–‡ä¸­å¯èƒ½ä»£è¡¨ä¸€ä¸ªæ•´æ•°ï¼Œä¹Ÿå¯èƒ½ä»£è¡¨ä¸€ä¸ªæµ®ç‚¹æ•°ï¼Œç”šè‡³å­—ç¬¦ä¸²ã€‚\nç¨‹åºçš„è½¬åŒ–è¿‡ç¨‹ ä¸€ä¸ªç®€å•çš„ C ç¨‹åºhello.cå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 #include \u003cstdio.h\u003e int main() { printf(\"hello world\\n\"); return 0; } é«˜çº§çš„ C ç¨‹åºæ–‡ä»¶hello.cè¢«è½¬åŒ–ä¸ºä¸€ç³»åˆ—ä½çº§çš„æœºå™¨è¯­è¨€æŒ‡ä»¤ï¼Œæœ€åä»¥äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶å­˜å‚¨åœ¨ç£ç›˜ä¸­ã€‚\né¢„å¤„ç†é˜¶æ®µï¼ˆPreprocessorï¼‰ï¼šé¢„å¤„ç†å™¨ä¿®æ”¹ C ç¨‹åºæ–‡ä»¶ä¸­ä»¥#å·å¼€å¤´çš„å‘½ä»¤ã€‚å¦‚ç¤ºä¾‹ç¨‹åºä¸­çš„#include \u003cstdio.h\u003eæŒ‡ç¤ºé¢„å¤„ç†å™¨ç³»ç»Ÿè¯»å–å¤´æ–‡ä»¶stdio.hçš„å†…å®¹ï¼Œç„¶åå°†å…¶ç›´æ¥æ’å…¥åˆ°ç¨‹åºæ–‡æœ¬ä¸­ã€‚ç”Ÿæˆçš„æ–°ç¨‹åºæ–‡ä»¶ä¸ºhello.iï¼› ç¼–è¯‘é˜¶æ®µï¼ˆCompilationï¼‰ï¼šç¼–è¯‘å™¨å°†hello.iæ–‡ä»¶è½¬åŒ–ä¸ºç”±æ±‡ç¼–è¯­è¨€ç»„æˆçš„hello.sæ–‡ä»¶ã€‚æ¯æ¡æ±‡ç¼–è¯­å¥éƒ½æè¿°äº†ä¸€æ¡ä½çº§çš„æœºå™¨è¯­è¨€æŒ‡ä»¤ï¼Œä¸åŒé«˜çº§è¯­è¨€ç¼–è¯‘åçš„æ±‡ç¼–è¯­å¥æ˜¯é€šç”¨çš„ï¼› æ±‡ç¼–é˜¶æ®µï¼ˆAssemblyï¼‰ï¼šæ±‡ç¼–å™¨å°†hello.sæ–‡ä»¶è½¬åŒ–ä¸ºç”±äºŒè¿›åˆ¶æœºå™¨è¯­è¨€æŒ‡ä»¤çš„hello.oæ–‡ä»¶ã€‚å¦‚æœæˆ‘ä»¬ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€è¯¥æ–‡ä»¶ï¼Œå°†ä¼šå‡ºç°ä¸€å †ä¹±ç ï¼› é“¾æ¥é˜¶æ®µï¼ˆLinkingï¼‰ï¼šç”±äºæˆ‘ä»¬çš„ç¨‹åºè°ƒç”¨äº†printfå‡½æ•°ï¼Œè€Œå®ƒå­˜åœ¨äºä¸€ä¸ªåä¸ºprintf.oçš„é¢„ç¼–è¯‘æ–‡ä»¶ä¸­ã€‚é“¾æ¥å™¨è´Ÿè´£å°†è¯¥æ–‡ä»¶å¹¶å…¥ï¼Œå¾—åˆ°æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶helloã€‚ ç³»ç»Ÿçš„ç¡¬ä»¶ç»„æˆ æ€»çº¿ï¼ˆBusesï¼‰ï¼šè´¯ç©¿æ•´ä¸ªç³»ç»Ÿçš„ä¸€ç»„ç”µå­ç®¡é“ï¼Œè´Ÿè´£åœ¨å„ä¸ªç»„ä»¶ä¹‹é—´ä¼ é€’ç»™å®šå¤§å°çš„å­—èŠ‚å—ï¼ˆä¹Ÿç§° Wordï¼‰ã€‚Word çš„å¤§å°æ˜¯ç³»ç»Ÿçš„åŸºæœ¬å‚æ•°ï¼Œä¸€èˆ¬æœ‰ 4 å­—èŠ‚ï¼ˆ32 ä½ï¼‰æˆ– 8 å­—èŠ‚ï¼ˆ64 ä½ï¼‰ä¸¤ç§ï¼› I/O è®¾å¤‡ï¼šç³»ç»Ÿä¸å¤–éƒ¨ä¸–ç•Œè¿æ¥çš„æ¡¥æ¢ã€‚ä¸‹å›¾ä¸­çš„ I/O è®¾å¤‡åŒ…æ‹¬ç”¨äºç”¨æˆ·è¾“å…¥çš„é”®ç›˜âŒ¨ï¸å’Œé¼ æ ‡ğŸ–±ï¸ã€ç”¨äºå±•ç¤ºçš„ç”¨æˆ·è¾“å‡ºä»¥åŠç”¨äºé•¿æœŸå­˜å‚¨æ•°æ®å’Œç¨‹åºçš„ç£ç›˜é©±åŠ¨ï¼Œæ¯ä¸ª I/O è®¾å¤‡éƒ½é€šè¿‡æ§åˆ¶å™¨ï¼ˆControllerï¼‰æˆ–é€‚é…å™¨ï¼ˆAdapterï¼‰ä¸ I/O æ€»çº¿ç›¸è¿ã€‚å…¶ä¸­ï¼Œæ§åˆ¶å™¨æ˜¯è®¾å¤‡è‡ªèº«æˆ–ç³»ç»Ÿä¸»æ¿ï¼ˆMotherboardï¼‰ä¸Šçš„èŠ¯ç‰‡ç»„ï¼Œè€Œé€‚é…å™¨åˆ™æ˜¯æ’åœ¨ä¸»æ¿æ’æ§½ä¸Šçš„å¡ï¼› ä¸»å­˜å‚¨å™¨ï¼ˆMain Memoryï¼‰ï¼šå¤„ç†å™¨æ‰§è¡Œç¨‹åºæ—¶å­˜æ”¾ç¨‹åºå’Œæ•°æ®çš„ä¸´æ—¶å­˜å‚¨ï¼Œç®€ç§°ä¸»å­˜ã€‚ä»ç‰©ç†ä¸Šæ¥è¯´ï¼Œä¸»å­˜å‚¨å™¨æ˜¯ç”± åŠ¨æ€éšæœºå­˜å–å­˜å‚¨å™¨ï¼ˆDynamic Random Access Memoryï¼ŒDRAMï¼‰èŠ¯ç‰‡ç»„æˆçš„é›†åˆã€‚è€Œå®ƒåœ¨é€»è¾‘ä¸Šåˆ™æ˜¯ä¸€ä¸ªçº¿æ€§çš„å­—èŠ‚æ•°ç»„ï¼Œæ¯ä¸ªå­—èŠ‚éƒ½æœ‰å…¶å”¯ä¸€åœ°å€ï¼› CPUï¼ˆCentral Processing Unit ï¼‰: è§£é‡Šæˆ–æ‰§è¡Œä¸»å­˜å‚¨å™¨ä¸­æŒ‡ä»¤çš„å¼•æ“ã€‚ PCï¼šCPU çš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªå¤§å°ä¸ Word ç›¸åŒçš„å­˜å‚¨è®¾å¤‡ï¼ˆæˆ–å¯„å­˜å™¨ï¼‰ï¼Œå®ƒè¢«ç§°ä¸ºç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counterï¼ŒPCï¼‰ã€‚PC å§‹ç»ˆæŒ‡å‘ä¸»å­˜å‚¨å™¨ä¸­æŸæ¡æœºå™¨è¯­è¨€æŒ‡ä»¤ï¼Œå³å†…å«å…¶åœ°å€ã€‚CPU ä¼šä¸æ–­åœ°é‡å¤æ‰§è¡Œ PC æŒ‡å‘çš„æœºå™¨æŒ‡ä»¤ï¼Œå¹¶æ›´æ–° PC ä½¿å…¶æŒ‡å‘ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼› Register Fileï¼šå¯„å­˜å™¨æ–‡ä»¶æ˜¯ä¸€ä¸ªç”±ä¸€ç»„ä»¥ Word ä¸ºå¤§å°çš„å¯„å­˜å™¨ç»„æˆçš„å°å‹å­˜å‚¨è®¾å¤‡ï¼Œæ¯ä¸ªå¯„å­˜å™¨éƒ½æœ‰å…¶å”¯ä¸€åç§°ï¼› ALUï¼š ç®—æœ¯/é€»è¾‘å•å…ƒï¼ˆArithmetic/Logic Unitï¼‰ï¼Œèƒ½å¤Ÿè®¡ç®—æ–°çš„æ•°æ®å’Œåœ°å€å€¼ã€‚ ç¨‹åºçš„è¿è¡Œè¿‡ç¨‹ ä»é”®ç›˜ä¸Šè¯»å–å‘½ä»¤ï¼šå½“æˆ‘ä»¬åœ¨ç»ˆç«¯ä¸­è¾“å…¥å‘½ä»¤./helloåï¼ŒBash ç¨‹åºå°†é€ä¸€è¯»å–å‘½ä»¤å­—ç¬¦ä¸²åˆ°å¯„å­˜å™¨ï¼ˆRegisterï¼‰ï¼Œç„¶åå­˜å‚¨äºä¸»å­˜ä¸­ï¼›\nä»ç£ç›˜åŠ è½½å¯æ‰§è¡Œæ–‡ä»¶åˆ°ä¸»å­˜ï¼šå½“æˆ‘ä»¬è¾“å…¥å›è½¦é”®åï¼ŒBash ç¨‹åºå¾—çŸ¥è¾“å…¥ç»“æŸï¼Œäºæ˜¯å¼€å§‹åŠ è½½å¯æ‰§è¡Œæ–‡ä»¶helloï¼Œå…¶ä¸­çš„ä»£ç å’Œæ•°æ®å°†é€šè¿‡ ç›´æ¥å­˜å‚¨å™¨è®¿é—®æŠ€æœ¯ï¼ˆDMA, Direct Memory Accessï¼‰ä»ç£ç›˜æ‹·è´åˆ°ä¸»å­˜ä¸­ï¼›\nä»ä¸»å­˜ä¸­å°†ç»“æœè¾“å‡ºåˆ°æ˜¾ç¤ºå™¨ï¼šå¤„ç†å™¨æ‰§è¡Œhelloæ–‡ä»¶ä¸­çš„æœºå™¨è¯­è¨€æŒ‡ä»¤ï¼Œç„¶åå°†hello world\\nå­—ç¬¦ä¸²ä¸­çš„å­—èŠ‚ä»ä¸»å­˜æ‹·è´åˆ°å¯„å­˜å™¨æ–‡ä»¶ä¸­ï¼Œæœ€ç»ˆä¼ è¾“åˆ°ç”¨äºå±•ç¤ºçš„å±å¹•ğŸ–¥ä¸Šã€‚\né«˜é€Ÿç¼“å†²å­˜å‚¨ åœ¨ç¨‹åºè¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œæ“ä½œç³»ç»ŸèŠ±è´¹äº†å¤§é‡æ—¶é—´å°†ä¿¡æ¯ä»ä¸€ä¸ªåœ°æ–¹æ‹·è´å¦ä¸€ä¸ªåœ°æ–¹ï¼ŒCPU ä»å¯„å­˜å™¨æ–‡ä»¶ä¸­è¯»å–æ•°æ®è¦æ¯”ä»ä¸»å­˜å‚¨å™¨ä¸­è¯»å–å¿«è¿‘ç™¾å€ã€‚å› æ­¤ç³»ç»Ÿè®¾è®¡è€…å¼•å…¥äº†ä¸€ç§æ›´å°ã€æ›´å¿«çš„å­˜å‚¨è®¾å¤‡ï¼Œå³é«˜é€Ÿç¼“å†²å­˜å‚¨ï¼ˆCache Memories æˆ– Cachesï¼‰ï¼Œå®ƒä¼šæš‚å­˜ CPU åœ¨çŸ­æœŸå†…éœ€è¦ç”¨åˆ°çš„æ•°æ®ã€‚\nL1 çº§åˆ«çš„ Caches ä½äº CPU èŠ¯ç‰‡ä¹‹ä¸Šï¼Œå®¹é‡ä¸ºä¸Šä¸‡å­—èŠ‚å¹¶ä¸”æ‹¥æœ‰å’Œå¯„å­˜å™¨æ–‡ä»¶ç›¸å½“çš„è®¿é—®é€Ÿåº¦ã€‚è€Œ L2 çº§åˆ«çš„ Caches åˆ™é€šè¿‡ä¸€æ¡ç‰¹æ®Šæ€»çº¿è¿æ¥åˆ° CPUï¼Œå®¹é‡å¯è¾¾åä¸‡åˆ°ç™¾ä¸‡å­—èŠ‚ã€‚è™½ç„¶å…¶è®¿é—®é€Ÿåº¦æ¯” L1 Cache æ…¢äº”å€å·¦å³ï¼Œä½†ä¾ç„¶æ¯”ä¸»å­˜å‚¨å™¨è¦å¿«äº”åˆ°åå€ã€‚åœ¨æŸäº›å…ˆè¿›çš„æ“ä½œç³»ç»Ÿä¸­ï¼Œè¿˜ä¼šä½¿ç”¨ L3 çº§åˆ«çš„ Cacheï¼Œå®ƒä»¬å‡æ˜¯é€šè¿‡é™æ€éšæœºå­˜å–å­˜å‚¨å™¨ï¼ˆSRAM, Static Random Access Memoryï¼‰å®ç°çš„ã€‚\nè®¡ç®—æœºç³»ç»Ÿä¸­çš„å­˜å‚¨å™¨å±‚çº§ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä½å±‚æ¬¡çš„å­˜å‚¨è®¾å¤‡ä½œä¸ºç›¸é‚»é«˜å±‚æ¬¡è®¾å¤‡çš„ç¼“å­˜ï¼š\næ“ä½œç³»ç»Ÿå¯¹ç¡¬ä»¶çš„ç®¡ç† æ“ä½œç³»ç»Ÿæ˜¯åº”ç”¨ç¨‹åºå’Œç¡¬ä»¶çš„ä¸­é—´å±‚ï¼Œåº”ç”¨ç¨‹åºå¯¹ç¡¬ä»¶çš„æ‰€æœ‰æ“ä½œå¿…é¡»é€šè¿‡æ“ä½œç³»ç»Ÿå®ç°ã€‚\næ“ä½œç³»ç»Ÿæœ‰ä¸¤ä¸ªä¸»è¦åŠŸèƒ½ï¼šé˜²æ­¢ç¡¬ä»¶è¢«å¤±æ§çš„åº”ç”¨ç¨‹åºæ‰€æ»¥ç”¨ï¼›ä¸ºåº”ç”¨ç¨‹åºæä¾›ä¸€ç§ç®€å•è€Œç»Ÿä¸€çš„æœºåˆ¶æ¥å¤„ç†å¤æ‚ä¸”é€šå¸¸å·®å¼‚å¾ˆå¤§çš„ä½çº§ç¡¬ä»¶è®¾å¤‡ã€‚ä¸Šè¿°ä¸¤ç§åŠŸèƒ½æ˜¯é€šè¿‡ä¸‹å›¾ä¸­çš„å‡ ä¸ªåŸºæœ¬æŠ½è±¡å®ç°çš„ï¼š\næ–‡ä»¶ï¼ˆFilesï¼‰æ˜¯å¯¹ I/O è®¾å¤‡çš„æŠ½è±¡ï¼Œè™šæ‹Ÿå†…å­˜ (Virtual Memory) æ˜¯å¯¹ä¸»å­˜å‚¨å™¨å’Œ I/O è®¾å¤‡çš„æŠ½è±¡ï¼Œè€Œè¿›ç¨‹ï¼ˆProcessesï¼‰åˆ™æ˜¯å¯¹å¤„ç†å™¨ï¼Œä¸»å­˜å‚¨å™¨å’Œ I/O è®¾å¤‡çš„æŠ½è±¡ã€‚\nè¿›ç¨‹ è¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿå¯¹æ­£åœ¨è¿è¡Œçš„ç¨‹åºçš„æŠ½è±¡ï¼Œå®ƒè®©æˆ‘ä»¬çš„helloç¨‹åºçœ‹èµ·æ¥åƒæ˜¯ç³»ç»Ÿä¸­å”¯ä¸€è¿è¡Œçš„ç¨‹åºã€‚å¤šä¸ªè¿›ç¨‹å¯ä»¥å¹¶å‘åœ°åœ¨åŒä¸€ä¸ªç³»ç»Ÿä¸­è¿è¡Œï¼ŒåŒæ—¶æ¯ä¸ªè¿›ç¨‹éƒ½å¥½åƒåœ¨ç‹¬å ç¡¬ä»¶çš„ä½¿ç”¨æƒã€‚è€Œå®é™…ä¸Šä¸åŒè¿›ç¨‹ä¸­çš„æŒ‡ä»¤æ˜¯äº¤é”™æ‰§è¡Œçš„ï¼ŒåŸºäºä¸‹å›¾ä¸­çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼š\næ“ä½œç³»ç»Ÿä¼šè·Ÿè¸ªè¿›ç¨‹è¿è¡Œæ‰€éœ€çš„æ‰€æœ‰çŠ¶æ€ä¿¡æ¯ï¼Œå³ä¸Šä¸‹æ–‡ï¼Œå®ƒåŒ…æ‹¬äº†ç¨‹åºè®¡æ•°å™¨ PC çš„å½“å‰å€¼ï¼Œå¯„å­˜å™¨æ–‡ä»¶å’Œä¸»å­˜å‚¨å™¨çš„å†…å®¹ä¹‹ç±»çš„ä¿¡æ¯ã€‚ åœ¨ä»»ä½•æ—¶é—´ç‚¹ï¼Œå•å¤„ç†å™¨ç³»ç»Ÿåªèƒ½ä¸ºå•ä¸ªè¿›ç¨‹æ‰§è¡Œä»£ç ã€‚ å½“æ“ä½œç³»ç»Ÿå†³å®šå°†æ§åˆ¶æƒä»å½“å‰è¿›ç¨‹è½¬ç§»åˆ°æŸä¸ªæ–°è¿›ç¨‹æ—¶ï¼Œå®ƒéœ€è¦é¦–å…ˆä¿å­˜å½“å‰è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œç„¶åè¿˜åŸæ–°è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œæœ€åå°†æ§åˆ¶æƒä¼ é€’ç»™æ–°è¿›ç¨‹ä»¥å®Œæˆä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚\nè¿›ç¨‹é—´çš„è½¬æ¢æ˜¯ç”±æ“ä½œç³»ç»Ÿå†…æ ¸ï¼ˆKernelï¼‰ç®¡ç†çš„ã€‚å†…æ ¸å¹¶ä¸æ˜¯ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹ï¼Œè€Œæ˜¯æ“ä½œç³»ç»Ÿä»£ç çš„ä¸€éƒ¨åˆ†ï¼Œå§‹ç»ˆå­˜åœ¨äºå†…å­˜ä¸­ã€‚å½“ä¸€ä¸ªåº”ç”¨ç¨‹åºéœ€è¦æ“ä½œç³»ç»Ÿå®Œæˆä¸€äº›æ“ä½œï¼Œæ¯”å¦‚è¯»å†™æ–‡ä»¶æ—¶ï¼Œå®ƒä¾¿ä¼šæ‰§è¡Œä¸€ä¸ªç‰¹æ®Šçš„ç³»ç»Ÿè°ƒç”¨æŒ‡ä»¤ï¼Œç„¶åå°†æ§åˆ¶æƒç§»äº¤ç»™å†…æ ¸ã€‚å†…æ ¸è´Ÿè´£å®ç°ç¨‹åºéœ€è¦è¿›è¡Œçš„æ“ä½œï¼Œå¹¶å°†ç»“æœè¿”å›ç»™ç¨‹åºã€‚\nçº¿ç¨‹ æ¯ä¸ªè¿›ç¨‹å¯ä»¥ç”±å¤šä¸ªæ‰§è¡Œå•å…ƒï¼ˆçº¿ç¨‹ï¼‰ç»„æˆã€‚ç”±äºæ¯ä¸ªçº¿ç¨‹éƒ½è¿è¡Œåœ¨è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œä¸”ä¸åŒçº¿ç¨‹ä¹‹é—´å¯ä»¥å…±äº«è¿›ç¨‹å†…çš„ä»£ç å’Œå…¨å±€æ•°æ®ï¼Œå› æ­¤çº¿ç¨‹è¦æ¯”è¿›ç¨‹æ›´åŠ é«˜æ•ˆã€‚\nè™šæ‹Ÿå†…å­˜ è™šæ‹Ÿå†…å­˜è®©æ¯ä¸ªè¿›ç¨‹éƒ½çœ‹ä¼¼ç‹¬å äº†ä¸»å­˜å‚¨å™¨çš„ä½¿ç”¨æƒã€‚æ‰€æœ‰è¿›ç¨‹çš„å†…å­˜ç©ºé—´ç»“æ„å‡ç›¸åŒï¼Œå®ƒè¢«ç§°ä¸ºè™šæ‹Ÿåœ°å€ç©ºé—´ï¼ˆVirtual Address Spaceï¼‰ï¼Œå…¶ç»„æˆå¦‚ä¸‹ï¼š\nç¨‹åºä»£ç å’Œæ•°æ®ï¼šæ‰€æœ‰è¿›ç¨‹çš„ä»£ç éƒ½å§‹äºç›¸åŒçš„å›ºå®šåœ°å€ï¼Œéšååˆ™æ˜¯ä¸å…¨å±€å˜é‡ç›¸å…³çš„æ•°æ®åŒºã€‚å®ƒä»¬çš„å¤§å°åœ¨è¿›ç¨‹å¼€å§‹è¿è¡Œæ—¶å›ºå®šï¼› å †ï¼ˆHeapï¼‰ï¼šè°ƒç”¨ mallocæˆ–free è¿™æ ·çš„ C æ ‡å‡†åº“å‡½æ•°çš„ç»“æœï¼Œå…¶å¤§å°å¯ä»¥åœ¨ç¨‹åºè¿è¡Œæ—¶åŠ¨æ€æ‰©ç¼©å®¹ï¼› å…±äº«åº“ï¼ˆShare Librariesï¼‰ï¼šå­˜æ”¾å¦‚ C æ ‡å‡†åº“ã€æ•°å­¦åº“è¿™æ ·çš„å…±äº«åº“çš„ä»£ç å’Œæ•°æ®çš„åŒºåŸŸï¼› æ ˆï¼ˆStackï¼‰ï¼šç¼–è¯‘å™¨å®ç°å‡½æ•°è°ƒç”¨çš„åŒºåŸŸï¼Œå…¶å¤§å°åŒæ ·å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€æ‰©ç¼©å®¹ã€‚å¦‚æœæˆ‘ä»¬è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œæ ˆå°±ä¼šå¢é•¿ã€‚è€Œæ¯å½“ä¸€ä¸ªå‡½æ•°è¿”å›æ—¶ï¼Œæ ˆä¾¿ä¼šç¼©å°ï¼› å†…æ ¸è™šæ‹Ÿå†…å­˜ï¼šä¸ºå†…æ ¸é¢„ç•™çš„å†…å­˜ç©ºé—´ã€‚ æ–‡ä»¶ æ–‡ä»¶æ˜¯ç”±å­—èŠ‚ç»„æˆçš„åºåˆ—ï¼Œå› æ­¤æ‰€æœ‰çš„ I/O è®¾å¤‡ï¼ˆåŒ…æ‹¬ç½‘ç»œï¼‰éƒ½å¯ä»¥è¢«çœ‹ä½œæ–‡ä»¶ã€‚ç³»ç»Ÿä¸­çš„æ‰€æœ‰è¾“å…¥å’Œè¾“å‡ºéƒ½å¯ä»¥é€šè¿‡ Unix I/Oï¼ˆä¸€ç»„ç³»ç»Ÿè°ƒç”¨ï¼‰å¯¹æ–‡ä»¶è¿›è¡Œè¯»å†™æ¥å®ç°ã€‚\nå¤šå¤„ç†å™¨ç³»ç»Ÿ ç”±å•ä¸€æ“ä½œç³»ç»Ÿå†…æ ¸æ§åˆ¶çš„å¤šä¸ªå¤„ç†å™¨å¯ä»¥å…±åŒç»„æˆä¸€ä¸ªå¤šå¤„ç†å™¨ç³»ç»Ÿï¼ˆMultiprocessor Systemï¼‰ï¼Œå®ƒåŸºäºå¤šæ ¸ï¼ˆMulti-coreï¼‰å¤„ç†å™¨ä»¥åŠè¶…çº¿ç¨‹æŠ€æœ¯ï¼ˆHyperthreadingï¼‰ã€‚\nå¤šæ ¸å¤„ç†å™¨ å¤šæ ¸å¤„ç†å™¨å°†å¤šä¸ª CPU é›†æˆåˆ°å•ä¸ªé›†æˆç”µè·¯èŠ¯ç‰‡ä¸­ï¼Œæ¯ä¸ª CPU éƒ½è¢«ç§°ä¸ºä¸€ä¸ªæ ¸ï¼ˆCoresï¼‰ã€‚ä¸‹å›¾å±•ç¤ºäº†ä¸€ä¸ªå…¸å‹çš„å¤šæ ¸å¤„ç†å™¨çš„æ¶æ„ã€‚å…¶ä¸­ L1 çº§åˆ«çš„ Cache è¢«åˆ†æˆäº†ä¸¤éƒ¨åˆ†ï¼Œåˆ†åˆ«å­˜å‚¨çŸ­æœŸå†…éœ€è¦ä½¿ç”¨çš„æŒ‡ä»¤ï¼ˆä¸‹å›¾ä¸­çš„â€œi-cacheâ€ï¼‰å’Œæ•°æ®ï¼ˆä¸‹å›¾ä¸­çš„â€œd-cacheâ€ï¼‰ï¼š\nè¶…çº¿ç¨‹æŠ€æœ¯ è¶…çº¿ç¨‹æŠ€æœ¯å…è®¸å•ä¸ª CPU æ‰§è¡Œå¤šä¸ªæ§åˆ¶æµï¼Œæœ‰æ—¶ä¹Ÿè¢«ç§°ä¸ºåŒæ­¥å¤šçº¿ç¨‹ï¼ˆSimultaneous Multi-threadingï¼‰ã€‚é€šè¿‡å¯¹ CPU ä¸­çš„ç¨‹åºè®¡æ•°å™¨ã€å¯„å­˜å™¨æ–‡ä»¶ç­‰ç¡¬ä»¶èµ„æºè¿›è¡Œæ‹·è´ï¼Œå°†ä¸€ä¸ªç‰©ç† CPU è™šæ‹Ÿä¸ºå¤šä¸ªé€»è¾‘ CPUï¼Œä»è€Œå®ç°å¤šä¸ªçº¿ç¨‹çš„å¹¶è¡Œè®¡ç®—ã€‚å¸¸è§„çš„ CPU éœ€è¦å¤§çº¦ä¸¤ä¸‡ä¸ªæ—¶é’Ÿå‘¨æœŸï¼ˆClock Cycleï¼‰å®Œæˆä¸åŒçº¿ç¨‹é—´çš„åˆ‡æ¢ï¼Œè€Œè¶…çº¿ç¨‹çš„ CPU å¯ä»¥åœ¨å•ä¸ªæ—¶é’Ÿå‘¨æœŸå†…å†³å®šè¦æ‰§è¡Œå“ªä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™ä½¿å¾— CPU èƒ½å¤Ÿæ›´å¥½åœ°åˆ©ç”¨å®ƒçš„æ‰§è¡Œèµ„æºã€‚æ¯”å¦‚ä¸€ä¸ªé€»è¾‘ CPU æ‰§è¡Œçš„çº¿ç¨‹éœ€è¦ç­‰å¾…æ•°æ®åŠ è½½åˆ° Cache ä¸­ï¼Œé‚£ä¹ˆå¦ä¸€ä¸ªé€»è¾‘ CPU å°±å¯ä»¥å‘å…¶å€Ÿç”¨æ‰§è¡Œèµ„æºç»§ç»­æ‰§è¡Œå…¶ä»–çº¿ç¨‹ã€‚\nä¸ä½¿ç”¨å¤šä¸ªç‰©ç† CPU çš„ä¼ ç»Ÿå¤šå¤„ç†å™¨ç³»ç»Ÿä¸åŒï¼Œè¶…çº¿ç¨‹å†…æ ¸ä¸­çš„é€»è¾‘ CPU å…±äº«æ‰§è¡Œèµ„æºã€‚å› æ­¤å½“ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶éœ€è¦æŸä¸ªæ‰§è¡Œèµ„æºæ—¶ï¼Œå…¶ä¸­ä¸€ä¸ªçº¿ç¨‹å¿…é¡»è®©å‡ºèµ„æºæš‚æ—¶æŒ‚èµ·ï¼Œç›´åˆ°è¿™äº›èµ„æºç©ºé—²åæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚\n","description":"","tags":["OS"],"title":"CSAPP è¯»ä¹¦ç¬”è®°ï¼šè®¡ç®—æœºç³»ç»Ÿä¹‹æ—…","uri":"/posts/a-tour-of-computer-systems-note/"},{"content":"å‰è¨€ åœ¨ Kubernetes Pod æ˜¯å¦‚ä½•è·¨èŠ‚ç‚¹é€šä¿¡çš„ï¼Ÿ ä¸­ï¼Œæˆ‘ä»¬ç®€å•åœ°ä»‹ç»äº† Kubernetes ä¸­çš„ä¸¤ç§ SDN ç½‘ç»œæ¨¡å‹ï¼šUnderlay å’Œ Overlayã€‚è€Œ Openshift ä¸­çš„ SDN åˆ™æ˜¯ç”± Overlay ç½‘ç»œ OVSï¼ˆOpen vSwitchï¼‰å®ç°çš„ï¼Œå…¶ä½¿ç”¨çš„æ’ä»¶å¦‚ä¸‹ï¼š\novs-subnet: é»˜è®¤æ’ä»¶ï¼Œæä¾›ä¸€ä¸ªæ‰å¹³åŒ–çš„ Pod ç½‘ç»œä»¥å®ç° Pod ä¸å…¶ä»–ä»»ä½• Pod æˆ– Service çš„é€šä¿¡ï¼› ovs-multitenantï¼šå®ç°å¤šç§Ÿæˆ·ç®¡ç†ï¼Œéš”ç¦»ä¸åŒ Project ä¹‹é—´çš„ç½‘ç»œé€šä¿¡ã€‚æ¯ä¸ª Project éƒ½æœ‰ä¸€ä¸ª NETIDï¼ˆå³ VxLAN ä¸­çš„ VNIDï¼‰ï¼Œå¯ä»¥ä½¿ç”¨oc get netnamespaceså‘½ä»¤æŸ¥çœ‹ï¼› ovs-networkpolicyï¼šåŸºäº Kubernetes ä¸­çš„ NetworkPolicy èµ„æºå®ç°ç½‘ç»œç­–ç•¥ç®¡ç†ã€‚ OVS åœ¨æ¯ä¸ª Openshift èŠ‚ç‚¹ä¸Šéƒ½åˆ›å»ºäº†å¦‚ä¸‹ç½‘ç»œæ¥å£ï¼š\nbr0ï¼šOpenShift åˆ›å»ºå’Œç®¡ç†çš„ OVS ç½‘æ¡¥ï¼Œå®ƒä¼šä½¿ç”¨ OpenFlow æµè¡¨æ¥å®ç°æ•°æ®åŒ…çš„è½¬å‘å’Œéš”ç¦»ï¼› vxlan0ï¼šVxLAN éš§é“ç«¯ç‚¹ï¼Œå³ VTEPï¼ˆVirtual Tunnel End Pointï¼‰ã€‚ç”¨äºé›†ç¾¤å†…éƒ¨çš„ Pod è·¨èŠ‚ç‚¹é€šä¿¡ï¼› tun0ï¼šèŠ‚ç‚¹ä¸Šæ‰€æœ‰ Pod çš„é»˜è®¤ç½‘å…³ï¼Œç”¨äº Pod ä¸é›†ç¾¤å¤–éƒ¨ä»¥åŠ Pod ä¸ Service ä¹‹é—´çš„é€šä¿¡ï¼› vethï¼šPod é€šè¿‡veth-pairè¿æ¥åˆ°br0ç½‘æ¡¥çš„ç«¯ç‚¹ã€‚ ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹br0ä¸Šçš„æ‰€æœ‰ç«¯å£åŠå…¶ç¼–å·ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 [root@node1 ~]# ovs-ofctl -O OpenFlow13 show br0 OFPT_FEATURES_REPLY (OF1.3) (xid=0x2): dpid:0000ea00372f1940 n_tables:254, n_buffers:0 capabilities: FLOW_STATS TABLE_STATS PORT_STATS GROUP_STATS QUEUE_STATS OFPST_PORT_DESC reply (OF1.3) (xid=0x3): 1(vxlan0): addr:72:23:a0:a9:14:a7 config: 0 state: 0 speed: 0 Mbps now, 0 Mbps max 2(tun0): addr:62:80:67:c6:38:58 config: 0 state: 0 speed: 0 Mbps now, 0 Mbps max 8381(vethd040c191): addr:7a:d9:f4:12:94:5f config: 0 state: 0 current: 10GB-FD COPPER speed: 10000 Mbps now, 0 Mbps max ... LOCAL(br0): addr:76:ab:cf:6f:e1:46 config: PORT_DOWN state: LINK_DOWN speed: 0 Mbps now, 0 Mbps max OFPT_GET_CONFIG_REPLY (OF1.3) (xid=0x5): frags=nx-match miss_send_len=0 è€ƒè™‘åˆ° Openshift é›†ç¾¤çš„å¤æ‚æ€§ï¼Œæˆ‘ä»¬åˆ†åˆ«æŒ‰ä»¥ä¸‹å‡ ç§åœºæ™¯åˆ†ææ•°æ®åŒ…çš„æµå‘ï¼š\nèŠ‚ç‚¹å†… Pod äº’è®¿ï¼šPod to Local Pod Pod è·¨èŠ‚ç‚¹äº’è®¿ï¼šPod to Remote Pod Pod è®¿é—® Serviceï¼šPod to Service Pod ä¸é›†ç¾¤å¤–éƒ¨äº’è®¿ï¼šPod to External ç”±äº 3.11 ä»¥ä¸Šç‰ˆæœ¬çš„ Openshift ä¸å†ä»¥å®ˆæŠ¤è¿›ç¨‹è€Œæ˜¯ä»¥ Pod çš„å½¢å¼éƒ¨ç½² OVS ç»„ä»¶ï¼Œä¸æ–¹ä¾¿å¯¹ OpenFlow æµè¡¨è¿›è¡ŒæŸ¥çœ‹ï¼Œæœ¬æ–‡é€‰ç”¨çš„é›†ç¾¤ç‰ˆæœ¬ä¸º 3.6ï¼š\n1 2 3 4 5 6 7 8 [root@node1 ~]# oc version oc v3.6.173.0.5 kubernetes v1.6.1+5115d708d7 features: Basic-Auth GSSAPI Kerberos SPNEGO Server https://test-cluster.ocp.koktlzz.com:8443 openshift v3.6.173.0.5 kubernetes v1.6.1+5115d708d7 å¦å¤–ï¼Œå®éªŒç”¨é›†ç¾¤å¹¶æœªå¼€å¯ ovs-multitenantï¼Œå³æœªè¿›è¡Œå¤šç§Ÿæˆ·éš”ç¦»ã€‚æ•´ä¸ªé›†ç¾¤ Pod ç½‘ç»œæ˜¯æ‰å¹³åŒ–çš„ï¼Œæ‰€æœ‰ Pod çš„ VNID éƒ½ä¸ºé»˜è®¤å€¼ 0ã€‚\nPod to Local Pod æ•°æ®åŒ…é¦–å…ˆé€šè¿‡veth-pairé€å¾€ OVS ç½‘æ¡¥br0ï¼Œéšåä¾¿è¿›å…¥äº†br0ä¸Šçš„ OpenFlow æµè¡¨ã€‚æˆ‘ä»¬å¯ä»¥ç”¨ovs-ofctl -O OpenFlow13 dump-flows br0å‘½ä»¤æŸ¥çœ‹æµè¡¨ä¸­çš„è§„åˆ™ï¼ŒåŒæ—¶ä¸ºäº†è®©è¾“å‡ºç»“æœæ›´åŠ ç®€æ´ï¼Œç•¥å» cookie å’Œ duration çš„ä¿¡æ¯ï¼š\ntable=0, n_packets=62751550874, n_bytes=25344802160312, priority=200,ip,in_port=1,nw_src=10.128.0.0/14,nw_dst=10.130.8.0/23 actions=move:NXM_NX_TUN_ID[0..31]-\u003eNXM_NX_REG0[],goto_table:10 table=0, n_packets=1081527047094, n_bytes=296066911370148, priority=200,ip,in_port=2 actions=goto_table:30 table=0, n_packets=833353346930, n_bytes=329854403266173, priority=100,ip actions=goto_table:20 table0 ä¸­å…³äº IP æ•°æ®åŒ…çš„è§„åˆ™ä¸»è¦æœ‰ä¸‰æ¡ï¼Œå…¶ä¸­å‰ä¸¤æ¡åˆ†åˆ«å¯¹åº”æµå…¥ç«¯å£in_portä¸º 1 å·ç«¯å£vxlan0å’Œ 2 å·ç«¯å£tun0çš„æ•°æ®åŒ…ã€‚è¿™ä¸¤æ¡è§„åˆ™çš„ä¼˜å…ˆçº§priorityéƒ½æ˜¯ 200ï¼Œå› æ­¤åªæœ‰åœ¨ä¸¤è€…å‡ä¸ç¬¦åˆæƒ…å†µä¸‹ï¼Œæ‰ä¼šåŒ¹é…ç¬¬ä¸‰æ¡è§„åˆ™ã€‚æœ¬åœ° Pod å‘å‡ºçš„æ•°æ®åŒ…æ˜¯ç”±vethç«¯å£è¿›å…¥çš„ï¼Œå› æ­¤å°†è½¬åˆ° table20ï¼›\ntable=20, n_packets=607178746, n_bytes=218036511085, priority=100,ip,in_port=8422,nw_src=10.130.9.154 actions=load:0-\u003eNXM_NX_REG0[],goto_table:21 table=21, n_packets=833757781068, n_bytes=329871389393381, priority=0 actions=goto_table:30 table20 ä¼šåŒ¹é…æºåœ°å€nw_srcä¸º 10.130.9.154 ä¸”æµå…¥ç«¯å£in_portä¸º 8422 çš„æ•°æ®åŒ…ï¼Œéšåå°† Pod1 çš„ VNID 0 ä½œä¸ºæº VNID å­˜å…¥å¯„å­˜å™¨ 0 ä¸­ï¼Œç»ç”± table21 è½¬åˆ° table30ï¼›\ntable=30, n_packets=1116329752668, n_bytes=294324730186808, priority=200,ip,nw_dst=10.130.8.0/23 actions=goto_table:70 table=30, n_packets=59672345347, n_bytes=41990349575805, priority=100,ip,nw_dst=10.128.0.0/14 actions=goto_table:90 table=30, n_packets=21061319859, n_bytes=29568807363654, priority=100,ip,nw_dst=172.30.0.0/16 actions=goto_table:60 table=30, n_packets=759636044089, n_bytes=280576476818108, priority=0,ip actions=goto_table:100 table30 ä¸­åŒ¹é…æ•°æ®åŒ…ç›®çš„åœ°å€nw_dstçš„è§„åˆ™æœ‰å››æ¡ï¼Œå‰ä¸‰æ¡åˆ†åˆ«å¯¹åº”æœ¬èŠ‚ç‚¹å†… Pod çš„ CIDR ç½‘æ®µ 10.130.8.0/23ã€é›†ç¾¤å†… Pod çš„ CIDR ç½‘æ®µ 10.128.0.0/14 å’Œ Service çš„ ClusterIP ç½‘æ®µ 172.30.0.0/16ã€‚ç¬¬å››æ¡ä¼˜å…ˆçº§æœ€ä½ï¼Œç”¨äº Pod å¯¹é›†ç¾¤å¤–éƒ¨çš„è®¿é—®ã€‚æ•°æ®åŒ…çš„ç›®çš„åœ°å€ 10.130.9.158 ç¬¦åˆç¬¬ä¸€æ¡è§„åˆ™ï¼Œä¸”ç¬¬ä¸€æ¡è§„åˆ™çš„ä¼˜å…ˆçº§æœ€é«˜ï¼Œå› æ­¤å°†è½¬åˆ° table70ï¼›\ntable=70, n_packets=597219981, n_bytes=243824445346, priority=100,ip,nw_dst=10.130.9.158 actions=load:0-\u003eNXM_NX_REG1[],load:0x20ea-\u003eNXM_NX_REG2[],goto_table:80 table70 åŒ¹é…ç›®çš„åœ°å€nw_dstä¸º Pod2 IP 10.130.9.158 çš„æ•°æ®åŒ…ï¼Œå¹¶å°† Pod2 çš„ VNID 0 ä½œä¸ºç›®çš„ VNID å­˜å…¥å¯„å­˜å™¨ 1 ä¸­ã€‚åŒæ—¶ç«¯å£å·0x20eaè¢«ä¿å­˜åˆ°å¯„å­˜å™¨ 2 ä¸­ï¼Œç„¶åè½¬åˆ° table80ï¼›\ntable=80, n_packets=1112713040332, n_bytes=293801616636499, priority=200 actions=output:NXM_NX_REG2[] table80 æ¯”è¾ƒå¯„å­˜å™¨ 0 å’Œå¯„å­˜å™¨ 1 ä¸­ä¿å­˜çš„æº/ç›®çš„ VNIDã€‚è‹¥äºŒè€…ä¸€è‡´ï¼Œåˆ™æ ¹æ®å¯„å­˜å™¨ 2 ä¸­ä¿å­˜çš„ç«¯å£å·å°†æ•°æ®åŒ…é€å‡ºã€‚\nç«¯å£å·0x20eaæ˜¯ä¸€ä¸ªåå…­è¿›åˆ¶æ•°å­—ï¼Œå³åè¿›åˆ¶æ•° 8426ã€‚è€Œ Pod2 æ­£æ˜¯é€šè¿‡ 8426 å·ç«¯å£è®¾å¤‡vethba48c6deè¿æ¥åˆ°br0ä¸Šï¼Œå› æ­¤æ•°æ®åŒ…ä¾¿æœ€ç»ˆé€šè¿‡å®ƒæµå…¥åˆ°äº† Pod2 ä¸­ã€‚\n1 2 [root@node1 ~]# ovs-ofctl -O OpenFlow13 show br0 | grep 8426 8426(vethba48c6de): addr:e6:b2:7e:42:41:91 Pod to Remote Pod Packet in Local Pod æ•°æ®åŒ…ä¾ç„¶é¦–å…ˆé€šè¿‡veth-pairé€å¾€ OVS ç½‘æ¡¥br0ï¼Œéšåä¾¿è¿›å…¥äº†br0ä¸Šçš„ OpenFlow æµè¡¨ï¼š\ntable=0, n_packets=830232155588, n_bytes=328613498734351, priority=100,ip actions=goto_table:20 table=20, n_packets=1901, n_bytes=299279, priority=100,ip,in_port=6635,nw_src=10.130.9.154 actions=load:0-\u003eNXM_NX_REG0[],goto_table:21 table=21, n_packets=834180030914, n_bytes=330064497351030, priority=0 actions=goto_table:30 ä¸ Pod to Local Pod çš„æµç¨‹ä¸€è‡´ï¼Œæ•°æ®åŒ…æ ¹æ®è§„åˆ™è½¬åˆ° table30ï¼›\ntable=30, n_packets=59672345347, n_bytes=41990349575805, priority=100,ip,nw_dst=10.128.0.0/14 actions=goto_table:90 table=30, n_packets=1116329752668, n_bytes=294324730186808, priority=200,ip,nw_dst=10.130.8.0/23 actions=goto_table:70 æ•°æ®åŒ…çš„ç›®çš„åœ°å€ä¸º Pod2 IP 10.131.8.206ï¼Œä¸å±äºæœ¬èŠ‚ç‚¹ Pod çš„ CIDR ç½‘æ®µ 10.130.8.0/23ï¼Œè€Œå±äºé›†ç¾¤ Pod çš„ CIDR ç½‘æ®µ 10.128.0.0/14ï¼Œå› æ­¤è½¬åˆ° table90ï¼›\ntable=90, n_packets=15802525677, n_bytes=6091612778189, priority=100,ip,nw_dst=10.131.8.0/23 actions=move:NXM_NX_REG0[]-\u003eNXM_NX_TUN_ID[0..31],set_field:10.122.28.8-\u003etun_dst,output:1 table90 æ ¹æ®ç›®çš„ IP çš„æ‰€å±ç½‘æ®µ 10.131.8.0/23 åˆ¤æ–­å…¶ä½äº Node2 ä¸Šï¼Œäºæ˜¯å°† Node2 IP 10.122.28.8 è®¾ç½®ä¸ºtun_dstã€‚å¹¶ä¸”ä»å¯„å­˜å™¨ 0 ä¸­å–å‡º VNID çš„å€¼ï¼Œä» 1 å·ç«¯å£vxlan0è¾“å‡ºã€‚\nvxlan0ä½œä¸ºä¸€ä¸ª VTEP è®¾å¤‡ï¼ˆå‚è§ Overlay Networkï¼‰ï¼Œå°†æ ¹æ® table90 å‘æ¥çš„ä¿¡æ¯ï¼Œå¯¹æ•°æ®åŒ…è¿›è¡Œä¸€å±‚å°è£…ï¼š\nç›®çš„åœ°å€ï¼ˆdst IPï¼‰ â€“\u003e tun_dst â€“\u003e 10.122.28.8 æºåœ°å€ï¼ˆsrc IPï¼‰ â€“\u003e Node1 IP â€“\u003e 10.122.28.7 æº VNID â€“\u003e NXM_NX_TUN_ID[0..31] â€“\u003e 0 å°è£…åçš„æ•°æ®åŒ…æº/ç›®çš„åœ°å€å‡ä¸ºèŠ‚ç‚¹ IPï¼Œå› æ­¤ä» Node1 çš„ç½‘å¡æµå‡ºåï¼Œå¯ä»¥é€šè¿‡ç‰©ç†ç½‘ç»œè®¾å¤‡è½¬å‘åˆ° Node2 ä¸Šã€‚\nPacket in Remote Pod Node2 ä¸Šçš„vxlan0å¯¹æ•°æ®åŒ…è¿›è¡Œè§£å°ï¼Œéšåä»br0ä¸Šçš„ 1 å·ç«¯å£è¿›å…¥ OpenFlow æµè¡¨ä¸­ï¼š\ntable=0, n_packets=52141153195, n_bytes=17269645342781, priority=200,ip,in_port=1,nw_src=10.128.0.0/14,nw_dst=10.131.8.0/23 actions=move:NXM_NX_TUN_ID[0..31]-\u003eNXM_NX_REG0[],goto_table:10 table0 åˆ¤æ–­æ•°æ®åŒ…çš„æµå…¥ç«¯å£in_portã€æº IP æ‰€å±ç½‘æ®µnw_srcå’Œç›®çš„ IP æ‰€å±ç½‘æ®µnw_dstå‡ç¬¦åˆè¯¥æ¡è§„åˆ™ï¼Œäºæ˜¯ä¿å­˜æ•°æ®åŒ…ä¸­çš„æº VNID åˆ°å¯„å­˜å™¨ 0 åè½¬åˆ° table10ï¼›\ntable=10, n_packets=10147760036, n_bytes=4060517391502, priority=100,tun_src=10.122.28.7 actions=goto_table:30 table10 ç¡®è®¤ VxLAN éš§é“çš„æº IPtun_srcå°±æ˜¯èŠ‚ç‚¹ Node1 çš„ IP åœ°å€ï¼Œäºæ˜¯è½¬åˆ° table30ï¼›\ntable=30, n_packets=678759566065, n_bytes=172831151192704, priority=200,ip,nw_dst=10.131.8.0/23 actions=goto_table:70 table30 ç¡®è®¤æ•°æ®åŒ…çš„ç›®çš„ IPï¼ˆå³ Pod2 IPï¼‰å­˜åœ¨äº Node2 ä¸­ Pod çš„ CIDR ç½‘æ®µå†…ï¼Œå› æ­¤è½¬åˆ° table70ï¼›\ntable=70, n_packets=193211683, n_bytes=27881218388, priority=100,ip,nw_dst=10.131.8.206 actions=load:0-\u003eNXM_NX_REG1[],load:0x220-\u003eNXM_NX_REG2[],goto_table:80 table70 å‘ç°æ•°æ®åŒ…çš„ç›®çš„ IP ä¸ Pod2 IP ç›¸ç¬¦ï¼Œäºæ˜¯å°† Pod2 çš„ VNID ä½œä¸ºç›®çš„ VNID å­˜äºå¯„å­˜å™¨ 1 ä¸­ï¼Œå°†0x220ï¼ˆåè¿›åˆ¶æ•° 544ï¼‰ä¿å­˜åœ¨å¯„å­˜å™¨ 2 ä¸­ï¼Œç„¶åè½¬åˆ° table80ï¼›\ntable=80, n_packets=676813794014, n_bytes=172576112594488, priority=200 actions=output:NXM_NX_REG2[] table80 ä¼šæ£€æŸ¥ä¿å­˜åœ¨å¯„å­˜å™¨ 0 å’Œå¯„å­˜å™¨ 1 ä¸­çš„æº/ç›®çš„ VNIDï¼Œè‹¥ç›¸ç­‰ï¼ˆæ­¤ä¾‹ä¸­å‡ä¸º 0ï¼‰ï¼Œåˆ™ä» 544 å·ç«¯å£è¾“å‡ºã€‚\nbr0ä¸Šçš„ 544 ç«¯å£å¯¹åº”çš„ç½‘ç»œæ¥å£æ˜¯vethe9f523a9ï¼Œå› æ­¤æ•°æ®åŒ…ä¾¿æœ€ç»ˆé€šè¿‡å®ƒæµå…¥åˆ°äº† Pod2 ä¸­ã€‚\n1 2 [root@node2 ~]# ovs-ofctl -O OpenFlow13 show br0 | grep 544 544(vethe9f523a9): addr:b2:a1:61:00:dc:3b Pod to Service åœ¨æœ¬ä¾‹ä¸­ï¼ŒPod1 é€šè¿‡ Service è®¿é—®å…¶åç«¯çš„ Pod2ï¼Œå…¶ ClusterIP ä¸º 172.30.107.57ï¼Œç›‘å¬çš„ç«¯å£ä¸º 8080ï¼š\n1 2 3 [root@node1 ~]# oc get svc NAME CLUSTER-IP EXTERNAL-IP PORT(S) AGE myService 172.30.107.57 \u003cnone\u003e 8080/TCP 2y table=30, n_packets=21065939280, n_bytes=29573447694924, priority=100,ip,nw_dst=172.30.0.0/16 actions=goto_table:60 æ•°æ®åŒ…åœ¨é€åˆ° OpenFlow æµè¡¨ table30 å‰çš„æ­¥éª¤ä¸ Pod to Local Pod å’Œ Pod to Remote Pod ä¸­çš„æƒ…å†µä¸€è‡´ï¼Œä½†æ•°æ®åŒ…çš„ç›®çš„åœ°å€å˜ä¸ºäº† myService çš„ ClusterIPã€‚å› æ­¤å°†åŒ¹é…nw_dstä¸­çš„ 172.30.0.0/16 ç½‘æ®µï¼Œè½¬åˆ° table60ï¼›\ntable=60, n_packets=0, n_bytes=0, priority=100,tcp,nw_dst=172.30.107.57,tp_dst=8080 actions=load:0-\u003eNXM_NX_REG1[],load:0x2-\u003eNXM_NX_REG2[],goto_table:80 table60 åŒ¹é…ç›®çš„åœ°å€nw_dstä¸º 172.30.107.57 ä¸”ç›®çš„ç«¯å£ä¸º 8080 çš„æ•°æ®åŒ…ï¼Œå¹¶å°† Pod1 çš„ VNID 0 ä¿å­˜åˆ°å¯„å­˜å™¨ 1 ä¸­ï¼Œå°†0x2ï¼ˆåè¿›åˆ¶æ•°å­— 2ï¼‰ä¿å­˜åˆ°å¯„å­˜å™¨ 2 ä¸­ï¼Œè½¬åˆ° table80ï¼›\ntable=80, n_packets=1113435014018, n_bytes=294106102133061, priority=200 actions=output:NXM_NX_REG2[] table80 æ ¹æ®å¯„å­˜å™¨ 2 ä¸­çš„æ•°å­—å°†æ•°æ®åŒ…ä» 2 å·ç«¯å£tun0ä¼ å‡ºï¼Œéšåè¿›å…¥èŠ‚ç‚¹çš„ iptables å¤„ç†æµä¸­ï¼š\nç”±äº Service çš„å®ç°ä¾èµ–äº NATï¼ˆä¸Šå›¾ä¸­çš„ç´«è‰²æ–¹æ¡†ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ NAT è¡¨ä¸­çœ‹åˆ°ä¸ä¹‹ç›¸å…³çš„è§„åˆ™ï¼š\n1 2 3 4 5 6 7 8 [root@node1 ~]# iptables -t nat -nvL Chain OUTPUT (policy ACCEPT 4753 packets, 489K bytes) pkts bytes target prot opt in out source destination 2702M 274G KUBE-SERVICES all -- * * 0.0.0.0/0 0.0.0.0/0 /* kubernetes service portals */ Chain KUBE-SERVICES (2 references) pkts bytes target prot opt in out source destination 4 240 KUBE-SVC-QYWOVDCBPMWAGC37 tcp -- * * 0.0.0.0/0 172.30.107.57 /* demo/myService:8080-8080 cluster IP */ tcp dpt:8080 æœ¬æœºäº§ç”Ÿçš„æ•°æ®åŒ…ï¼ˆLocally-generated Packetï¼‰é¦–å…ˆè¿›å…¥OUTPUTé“¾ï¼Œç„¶ååŒ¹é…åˆ°è‡ªå®šä¹‰é“¾KUBE-SERVICESã€‚å…¶ç›®çš„åœ°å€ä¸º Service çš„ ClusterIP 172.30.107.57ï¼Œå› æ­¤å°†å†æ¬¡è·³è½¬åˆ°å¯¹åº”çš„KUBE-SVC-QYWOVDCBPMWAGC37é“¾ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 Chain KUBE-SVC-QYWOVDCBPMWAGC37 (1 references) pkts bytes target prot opt in out source destination 1 60 KUBE-SEP-AF5DIL6JV3XLLV6G all -- * * 0.0.0.0/0 0.0.0.0/0 /* demo/myService:8080-8080 */ statistic mode random probability 0.50000000000 1 60 KUBE-SEP-ADAJHSV7RYS5DUBX all -- * * 0.0.0.0/0 0.0.0.0/0 /* demo/myService:8080-8080 */ Chain KUBE-SEP-ADAJHSV7RYS5DUBX (1 references) pkts bytes target prot opt in out source destination 0 0 KUBE-MARK-MASQ all -- * * 10.131.8.206 0.0.0.0/0 /* demo/myService:8080-8080 */ 0 0 DNAT tcp -- * * 0.0.0.0/0 0.0.0.0/0 /* demo/myService:8080-8080 */ tcp to:10.131.8.206:8080 Chain KUBE-SEP-AF5DIL6JV3XLLV6G (1 references) pkts bytes target prot opt in out source destination 0 0 KUBE-MARK-MASQ all -- * * 10.128.10.57 0.0.0.0/0 /* demo/myService:8080-8080 */ 23 1380 DNAT tcp -- * * 0.0.0.0/0 0.0.0.0/0 /* demo/myService:8080-8080 */ tcp to:10.128.10.57:8080 KUBE-SVC-QYWOVDCBPMWAGC37é“¾ä¸‹æœ‰ä¸¤æ¡å®Œå…¨ç›¸åŒçš„åŒ¹é…è§„åˆ™ï¼Œå¯¹åº”äº†è¯¥ Service åç«¯çš„ä¸¤ä¸ª Podã€‚KUBE-SEP-ADAJHSV7RYS5DUBXé“¾å’Œ KUBE-SEP-AF5DIL6JV3XLLV6Gé“¾èƒ½å¤Ÿæ‰§è¡Œ DNAT æ“ä½œï¼Œåˆ†åˆ«å°†æ•°æ®åŒ…çš„ç›®çš„åœ°å€è½¬åŒ–ä¸º Pod IP 10.131.8.206 å’Œ 10.128.10.57ã€‚åœ¨ä¸€æ¬¡é€šä¿¡ä¸­åªä¼šæœ‰ä¸€æ¡é“¾ç”Ÿæ•ˆï¼Œè¿™ä½“ç°äº† Service çš„è´Ÿè½½å‡è¡¡èƒ½åŠ›ã€‚\nå®ŒæˆOUTPUTDNAT çš„æ•°æ®åŒ…å°†è¿›å…¥èŠ‚ç‚¹çš„è·¯ç”±åˆ¤æ–­ï¼ˆRouting Decisionï¼‰ã€‚ç”±äºå½“å‰ç›®çš„åœ°å€å·²ç»å±äºé›†ç¾¤å†… Pod çš„ CIDR ç½‘æ®µ 10.128.0.0/14ï¼Œæ•°æ®åŒ…å°†ä»tun0ç«¯å£å†æ¬¡è¿›å…¥ OVS ç½‘æ¡¥br0ä¸­ã€‚\n1 2 3 4 5 6 7 8 9 [rootnode1 ~]# route -n Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0.0.0.0 10.122.28.1 0.0.0.0 UG 0 0 0 eth0 10.122.28.0 0.0.0.0 255.255.255.128 U 0 0 0 eth0 10.128.0.0 0.0.0.0 255.252.0.0 U 0 0 0 tun0 169.254.0.0 0.0.0.0 255.255.0.0 U 1008 0 0 eth0 172.17.0.0 0.0.0.0 255.255.0.0 U 0 0 0 docker0 172.30.0.0 0.0.0.0 255.255.0.0 U 0 0 0 tun0 ä¸è¿‡æ•°æ®åŒ…åœ¨è¿›å…¥br0ä¹‹å‰ï¼Œè¿˜éœ€è¦ç»è¿‡ iptables ä¸­çš„POSTROUTINGé“¾ï¼Œå®Œæˆä¸€æ¬¡MASQUERADEï¼šæ•°æ®åŒ…çš„æºåœ°å€è½¬æ¢ä¸ºå…¶ä¼ å‡ºç«¯å£çš„ IPï¼Œå³tun0çš„ IP 10.130.8.1ã€‚\n1 2 3 4 5 6 7 8 9 10 11 [root@node1 ~]# iptables -t nat -nvL Chain POSTROUTING (policy ACCEPT 5083 packets, 524K bytes) pkts bytes target prot opt in out source destination 2925M 288G OPENSHIFT-MASQUERADE all -- * * 0.0.0.0/0 0.0.0.0/0 /* rules for masquerading OpenShift traffic */ Chain OPENSHIFT-MASQUERADE (1 references) pkts bytes target prot opt in out source destination 321M 19G MASQUERADE all -- * * 10.128.0.0/14 0.0.0.0/0 /* masquerade pod-to-service and pod-to-external traffic */ [root@node1 ~]# ip a | grep tun0 16: tun0: \u003cBROADCAST,MULTICAST,UP,LOWER_UP\u003e mtu 1450 qdisc noqueue state UNKNOWN qlen 1000 inet 10.130.8.1/23 scope global tun0 æœ¬ä¾‹ä¸­ Service çš„åç«¯ Pod å‡åœ¨ Pod1 æ‰€åœ¨çš„èŠ‚ç‚¹å¤–ï¼Œå› æ­¤æ•°æ®åŒ…ç¬¬äºŒæ¬¡è¿›å…¥ OpenFlow æµè¡¨æ—¶åŒ¹é…çš„è§„åˆ™åŸºæœ¬ä¸ Pod to Remote Pod ä¸€è‡´ï¼š\ntable=0, n_packets=1081527047094, n_bytes=296066911370148, priority=200,ip,in_port=2 actions=goto_table:30 table=30, n_packets=59672345347, n_bytes=41990349575805, priority=100,ip,nw_dst=10.128.0.0/14 actions=goto_table:90 table=90, n_packets=15802525677, n_bytes=6091612778189, priority=100,ip,nw_dst=10.131.8.0/23 actions=move:NXM_NX_REG0[]-\u003eNXM_NX_TUN_ID[0..31],set_field:10.122.28.8-\u003etun_dst,output:1 å…¶ä¼ é€’æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nPod2 è¿”å›çš„æ•°æ®åŒ…åœ¨åˆ°è¾¾ Node1 åå°†è¢«vxlan0è§£å°è£…ï¼Œç„¶åæ ¹æ®å…¶ç›®çš„åœ°å€tun0è¿›å…¥ OpenFlow æµè¡¨ï¼š\ntable=0, n_packets=1084362760247, n_bytes=297224518823222, priority=200,ip,in_port=2 actions=goto_table:30 table=30, n_packets=20784385211, n_bytes=4742514750371, priority=300,ip,nw_dst=10.130.8.1 actions=output:2 æ•°æ®åŒ…ä» 2 å·ç«¯å£tun0é€å‡ºåè¿›å…¥èŠ‚ç‚¹çš„ iptables å¤„ç†æµï¼Œéšåå°†è§¦å‘ Connection Trackingï¼šæ ¹æ®/proc/net/nf_conntrackæ–‡ä»¶ä¸­çš„è®°å½•è¿›è¡Œâ€œDeNATâ€ã€‚è¿”å›æ•°æ®åŒ…çš„æº/ç›®çš„åœ°å€ä» Pod2 IP 10.131.8.206 å’Œ tun0 IP 10.130.8.1ï¼Œå˜å› Service çš„ ClusterIP 172.30.107.57 å’Œ Pod1 IP 10.130.9.154ã€‚\n1 2 [root@node1 ~]# cat /proc/net/nf_conntrack | grep -E \"src=10.130.9.154.*dst=172.30.107.57.*dport=8080.*src=10.131.8.206\" ipv4 2 tcp 6 431986 ESTABLISHED src=10.130.9.154 dst=172.30.107.57 sport=80 dport=8080 src=10.131.8.206 dst=10.130.8.1 sport=8080 dport=80 [ASSURED] mark=0 secctx=system_u:object_r:unlabeled_t:s0 zone=0 use=2 Pod to External æ•°æ®åŒ…ä¾ç„¶é¦–å…ˆé€šè¿‡veth-pairé€å¾€ OVS ç½‘æ¡¥br0ï¼Œéšåä¾¿è¿›å…¥äº†br0ä¸Šçš„ OpenFlow æµè¡¨ï¼š\ntable=0, n_packets=837268653828, n_bytes=331648403594327, priority=100,ip actions=goto_table:20 table=20, n_packets=613807687, n_bytes=220557571042, priority=100,ip,in_port=8422,nw_src=10.130.9.154 actions=load:0-\u003eNXM_NX_REG0[],goto_table:21 table=21, n_packets=837674296060, n_bytes=331665441915651, priority=0 actions=goto_table:30 table=30, n_packets=759636044089, n_bytes=280576476818108, priority=0,ip actions=goto_table:100 table=100, n_packets=761732023982, n_bytes=282091648536325, priority=0 actions=output:2 æ•°æ®åŒ…ä»tun0ç«¯å£ä¼ å‡ºåè¿›å…¥èŠ‚ç‚¹çš„è·¯ç”±è¡¨åŠ iptables å¤„ç†æµï¼š\n1 2 3 4 5 6 7 8 Chain POSTROUTING (policy ACCEPT 2910 packets, 299K bytes) pkts bytes target prot opt in out source destination 0 0 MASQUERADE all -- * !docker0 172.17.0.0/16 0.0.0.0/0 2940M 289G OPENSHIFT-MASQUERADE all -- * * 0.0.0.0/0 0.0.0.0/0 /* rules for masquerading OpenShift traffic */ Chain OPENSHIFT-MASQUERADE (1 references) pkts bytes target prot opt in out source destination 322M 19G MASQUERADE all -- * * 10.128.0.0/14 0.0.0.0/0 /* masquerade pod-to-service and pod-to-external traffic */ è®¿é—®é›†ç¾¤å¤–éƒ¨æ˜¾ç„¶éœ€è¦é€šè¿‡èŠ‚ç‚¹çš„é»˜è®¤ç½‘å…³ï¼Œå› æ­¤æ•°æ®åŒ…å°†ä»èŠ‚ç‚¹ç½‘å¡eth0é€å‡ºã€‚è€Œåœ¨POSTROUTINGé“¾ä¸­ï¼Œæ•°æ®åŒ…çš„æºåœ°å€ç”± Pod IP è½¬æ¢ä¸ºäº†eth0çš„ IP 10.122.28.7ã€‚å®Œæ•´æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆå›¾ä¸­çš„â€œRouterâ€æŒ‡çš„æ˜¯è·¯ç”±å™¨è€Œé Openshift ä¸­çš„æ¦‚å¿µï¼‰ï¼š\nFuture Work æœ¬æ–‡å¹¶æœªæ¶‰åŠ External to Pod çš„åœºæ™¯ï¼Œå®ƒæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿæˆ‘ä»¬éƒ½çŸ¥é“ Openshift æ˜¯é€šè¿‡ Routerï¼ˆHAProxyï¼‰æ¥æš´éœ²é›†ç¾¤å†…éƒ¨æœåŠ¡çš„ï¼Œé‚£ä¹ˆæ•°æ®åŒ…åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­çš„ NAT æ“ä½œæ˜¯æ€æ ·è¿›è¡Œçš„ï¼Ÿ é™¤äº†æœ¬æ–‡æåˆ°çš„å‡ ç§ç½‘ç»œæ¥å£å¤–ï¼ŒOpenshift èŠ‚ç‚¹ä¸Šè¿˜å­˜åœ¨ç€ovs-systemå’Œvxlan_sys_4789ã€‚å®ƒä»¬çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ æ›´æ–°ï¼švxlan_sys_4789å°±æ˜¯ä¸Šæ–‡æåˆ°çš„ç«¯å£vxlan0ï¼Œè€Œovs-systemæ˜¯ä¸€ä¸ªå†å²é—ç•™é—®é¢˜ï¼Œæ²¡æœ‰ä»»ä½•ä½œç”¨ï¼› Openshift 4.X ç‰ˆæœ¬çš„ç½‘ç»œæ¨¡å‹ä¸æœ¬æ–‡å®éªŒç”¨çš„ 3.6 ç‰ˆæœ¬ç›¸æ¯”æœ‰é‚£äº›å˜åŒ–ï¼Ÿ å‚è€ƒæ–‡çŒ® OpenFlow - Wikipedia\nOVS åœ¨äº‘é¡¹ç›®ä¸­çš„ä½¿ç”¨\nOpenShift SDN - OpenShift Container Platform 3.11\nç†è§£ OpenShiftï¼ˆ3ï¼‰ï¼šç½‘ç»œä¹‹ SDN\n[è¯‘] æ·±å…¥ç†è§£ iptables å’Œ netfilter æ¶æ„\nLinux Netfilter: How does connection tracking track connections changed by NAT?\n","description":"","tags":["Openshift","Network","Container","CNI","Open vSwitch"],"title":"å¯¹ Openshift SDN ç½‘ç»œæ¨¡å‹çš„ä¸€äº›æ¢ç´¢","uri":"/posts/explorations-on-the-openshift-sdn-network-model/"},{"content":"å‰è¨€ A Guide to the Kubernetes Networking Model ä¸€æ–‡ç”ŸåŠ¨å½¢è±¡åœ°ä»‹ç»äº† Kubernetes ä¸­çš„ç½‘ç»œæ¨¡å‹ï¼Œç„¶è€Œå—ç¯‡å¹…æ‰€é™ï¼Œä½œè€…å¹¶æ²¡æœ‰å¯¹ Pod è·¨èŠ‚ç‚¹é€šä¿¡æ—¶æ•°æ®åŒ…åœ¨èŠ‚ç‚¹ä¹‹é—´ä¼ é€’çš„ç»†èŠ‚è¿›è¡Œè¿‡å¤šè®¨è®ºã€‚\næˆ‘ä»¬å·²ç»çŸ¥é“ï¼ŒDocker ä½¿ç”¨ç«¯å£æ˜ å°„çš„æ–¹å¼å®ç°ä¸åŒä¸»æœºé—´å®¹å™¨çš„é€šä¿¡ï¼ŒKubernetes ä¸­åŒæ ·ä¹Ÿæœ‰ hostPort çš„æ¦‚å¿µã€‚ä½†æ˜¯å½“èŠ‚ç‚¹å’Œ Pod çš„æ•°é‡ä¸Šå‡åï¼Œæ‰‹åŠ¨ç®¡ç†èŠ‚ç‚¹ä¸Šç»‘å®šçš„ç«¯å£æ˜¯ååˆ†å›°éš¾çš„ï¼Œè¿™ä¹Ÿæ˜¯NodePortç±»å‹çš„ Service çš„ç¼ºç‚¹ä¹‹ä¸€ã€‚è€Œä¸€æ—¦ Pod ä¸å†â€œå€Ÿç”¨â€èŠ‚ç‚¹çš„ IP å’Œç«¯å£æ¥æš´éœ²è‡ªèº«çš„æœåŠ¡ï¼Œå°±ä¸å¾—ä¸é¢ä¸´ä¸€ä¸ªæ£˜æ‰‹çš„é—®é¢˜ï¼šPod çš„æœ¬è´¨æ˜¯èŠ‚ç‚¹ä¸­çš„è¿›ç¨‹ï¼ŒèŠ‚ç‚¹å¤–çš„ç‰©ç†ç½‘ç»œè®¾å¤‡ï¼ˆäº¤æ¢æœº/è·¯ç”±å™¨ï¼‰å¹¶ä¸çŸ¥æ™“ Pod çš„å­˜åœ¨ã€‚å®ƒä»¬åœ¨æ¥æ”¶ç›®çš„åœ°å€ä¸º Pod IP çš„æ•°æ®åŒ…æ—¶ï¼Œæ— æ³•å®Œæˆè¿›ä¸€æ­¥çš„ä¼ è¾“å·¥ä½œã€‚\nä¸ºæ­¤æˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€äº› CNIï¼ˆContainer Network Interfaceï¼‰æ’ä»¶æ¥å®Œå–„ Kubernetes é›†ç¾¤çš„ç½‘ç»œæ¨¡å‹ï¼Œè¿™ç§æ–°å‹çš„ç½‘ç»œè®¾è®¡ç†å¿µè¢«ç§°ä¸º SDNï¼ˆSoftware-defined Networkingï¼‰ã€‚æ ¹æ® SDN å®ç°çš„å±‚çº§ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶åˆ†ä¸º Underlay Network å’Œ Overlay Networkï¼š\nOverlay ç½‘ç»œå…è®¸è®¾å¤‡è·¨è¶Šåº•å±‚ç‰©ç†ç½‘ç»œï¼ˆUnderlay Networkï¼‰è¿›è¡Œé€šä¿¡ï¼Œè€Œåº•å±‚å´å¹¶ä¸çŸ¥æ™“ Overlay ç½‘ç»œçš„å­˜åœ¨ã€‚Underlay ç½‘ç»œæ˜¯ä¸“é—¨ç”¨æ¥æ‰¿è½½ç”¨æˆ· IP æµé‡çš„åŸºç¡€æ¶æ„å±‚ï¼Œå®ƒä¸ Overlay ç½‘ç»œä¹‹é—´çš„å…³ç³»æœ‰ç‚¹ç±»ä¼¼ç‰©ç†æœºå’Œè™šæ‹Ÿæœºã€‚Underlay ç½‘ç»œå’Œç‰©ç†æœºéƒ½æ˜¯çœŸæ­£å­˜åœ¨çš„å®ä½“ï¼Œå®ƒä»¬åˆ†åˆ«å¯¹åº”ç€çœŸå®å­˜åœ¨çš„ç½‘ç»œè®¾å¤‡å’Œè®¡ç®—è®¾å¤‡ï¼Œè€Œ Overlay ç½‘ç»œå’Œè™šæ‹Ÿæœºéƒ½æ˜¯ä¾æ‰˜åœ¨ä¸‹å±‚å®ä½“ä½¿ç”¨è½¯ä»¶è™šæ‹Ÿå‡ºæ¥çš„å±‚çº§ã€‚\nUnderlay Network åˆ©ç”¨ Underlay Network å®ç° Pod è·¨èŠ‚ç‚¹é€šä¿¡ï¼Œæ—¢å¯ä»¥åªä¾èµ– TCP/IP æ¨¡å‹ä¸­çš„äºŒå±‚åè®®ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‰å±‚ã€‚ä½†æ— è®ºå“ªç§å®ç°æ–¹å¼ï¼Œéƒ½å¿…é¡»å¯¹åº•å±‚çš„ç‰©ç†ç½‘ç»œæœ‰æ‰€è¦æ±‚ã€‚\näºŒå±‚ å¦‚å›¾æ‰€ç¤ºï¼ŒPod ä¸èŠ‚ç‚¹çš„ IP åœ°å€å‡å¤„äºåŒä¸€ç½‘æ®µã€‚å½“ Pod1 å‘å¦ä¸€èŠ‚ç‚¹ä¸Šçš„ Pod2 å‘èµ·é€šä¿¡æ—¶ï¼Œæ•°æ®åŒ…é¦–å…ˆé€šè¿‡veth-pairå’Œcbr0é€å¾€ Node1 çš„ç½‘å¡ã€‚ç”±äºç›®çš„åœ°å€ 10.86.44.4 ä¸ Node1 åŒç½‘æ®µï¼Œå› æ­¤ Node1 å°†é€šè¿‡ ARP å¹¿æ’­è¯·æ±‚ 10.86.44.4 çš„ MAC åœ°å€ã€‚\nCNI æ’ä»¶ä¸ä»…ä¸º Pod åˆ†é… IP åœ°å€ï¼Œå®ƒè¿˜ä¼šå°†æ¯ä¸ª Pod æ‰€åœ¨çš„èŠ‚ç‚¹ä¿¡æ¯ä¸‹å‘ç»™ SDN äº¤æ¢æœºã€‚è¿™æ ·å½“ SDN äº¤æ¢æœºæ¥æ”¶åˆ° ARP è¯·æ±‚æ—¶ï¼Œå°†ä¼šç­”å¤ Pod2 æ‰€åœ¨èŠ‚ç‚¹ Node2 çš„ MAC åœ°å€ï¼Œæ•°æ®åŒ…ä¹Ÿå°±é¡ºåˆ©åœ°é€åˆ°äº† Node2 ä¸Šã€‚\né˜¿é‡Œäº‘ Terway æ¨¡å¼çš„ ACK æœåŠ¡ä½¿ç”¨çš„ä¾¿æ˜¯è¿™ç§ç½‘ç»œæ¨¡å‹ï¼Œåªä¸è¿‡ Pod é—´é€šä¿¡ä½¿ç”¨çš„ SDN äº¤æ¢æœºä¸å†æ˜¯èŠ‚ç‚¹çš„äº¤æ¢æœºï¼ˆä¸‹å›¾ä¸­çš„â€œNode vSwitchâ€ï¼‰ï¼Œè€Œæ˜¯å•ç‹¬åˆ›å»ºçš„â€œPod vSwitchâ€ï¼š\nä¸‰å±‚ å¦‚å›¾æ‰€ç¤ºï¼ŒPod ä¸èŠ‚ç‚¹çš„ IP åœ°å€ä¸å†å¤„äºåŒä¸€ç½‘æ®µã€‚å½“ Pod1 å‘å¦ä¸€èŠ‚ç‚¹ä¸Šçš„ Pod2 å‘èµ·é€šä¿¡æ—¶ï¼Œæ•°æ®åŒ…é¦–å…ˆé€šè¿‡veth-pairå’Œcbr0è¿›å…¥å®¿ä¸»æœºå†…æ ¸çš„è·¯ç”±è¡¨ï¼ˆRouting Tableï¼‰ã€‚CNI æ’ä»¶åœ¨è¯¥è¡¨ä¸­æ·»åŠ äº†è‹¥å¹²æ¡è·¯ç”±è§„åˆ™ï¼Œå¦‚ç›®çš„åœ°å€ä¸º Pod2 IP çš„ç½‘å…³ä¸º Node2 çš„ IPã€‚è¿™æ ·æ•°æ®åŒ…çš„ç›®çš„ MAC åœ°å€å°±å˜ä¸ºäº† Node2 çš„ MAC åœ°å€ï¼Œå®ƒå°†ä¼šé€šè¿‡äº¤æ¢æœºå‘é€åˆ° Node2 ä¸Šã€‚\nç”±äºè¿™ç§å®ç°æ–¹å¼åŸºäºä¸‰å±‚åè®®ï¼Œå› æ­¤ä¸è¦æ±‚ä¸¤èŠ‚ç‚¹å¤„äºåŒä¸€ç½‘æ®µã€‚ä¸è¿‡éœ€è¦å°†ç›®çš„åœ°å€ä¸º Pod2 IP çš„ç½‘å…³è®¾ç½®ä¸º SDN è·¯ç”±å™¨çš„ IPï¼Œä¸”è¯¥è·¯ç”±å™¨èƒ½å¤ŸçŸ¥æ™“ç›®çš„ Pod æ‰€åœ¨çš„èŠ‚ç‚¹ã€‚è¿™æ ·æ•°æ®åŒ…çš„ç›®çš„ MAC åœ°å€å°±ä¼šé¦–å…ˆå˜ä¸º SDN è·¯ç”±å™¨çš„ MAC åœ°å€ï¼Œç»è¿‡è·¯ç”±å™¨åå†å˜ä¸º Node2 çš„ MAC åœ°å€ï¼š\né€šè¿‡ä¸Šé¢çš„è®¨è®ºæˆ‘ä»¬å‘ç°ï¼Œæƒ³è¦å®ç°ä¸‰å±‚çš„ Underlay ç½‘ç»œï¼Œéœ€è¦åœ¨å¤šä¸ªèŠ‚ç‚¹é—´ä¸‹å‘å’ŒåŒæ­¥è·¯ç”±è¡¨ã€‚äºæ˜¯å¾ˆå®¹æ˜“æƒ³åˆ°ç”¨äºäº¤æ¢è·¯ç”±ä¿¡æ¯çš„ BGPï¼ˆBorder Gateway Protocolï¼‰åè®®ï¼š\nè¾¹ç•Œç½‘å…³åè®®ï¼ˆè‹±è¯­ï¼šBorder Gateway Protocolï¼Œç¼©å†™ï¼šBGPï¼‰æ˜¯äº’è”ç½‘ä¸Šä¸€ä¸ªæ ¸å¿ƒçš„å»ä¸­å¿ƒåŒ–è‡ªæ²»è·¯ç”±åè®®ã€‚å®ƒé€šè¿‡ç»´æŠ¤ IP è·¯ç”±è¡¨æˆ–â€œå‰ç¼€â€è¡¨æ¥å®ç°è‡ªæ²»ç³»ç»Ÿï¼ˆASï¼‰ä¹‹é—´çš„å¯è¾¾æ€§ï¼Œå±äºçŸ¢é‡è·¯ç”±åè®®ã€‚BGP ä¸ä½¿ç”¨ä¼ ç»Ÿçš„å†…éƒ¨ç½‘å…³åè®®ï¼ˆIGPï¼‰çš„æŒ‡æ ‡ï¼Œè€Œä½¿ç”¨åŸºäºè·¯å¾„ã€ç½‘ç»œç­–ç•¥æˆ–è§„åˆ™é›†æ¥å†³å®šè·¯ç”±ã€‚å› æ­¤ï¼Œå®ƒæ›´é€‚åˆè¢«ç§°ä¸ºçŸ¢é‡æ€§åè®®ï¼Œè€Œä¸æ˜¯è·¯ç”±åè®®ã€‚\nå¯¹äº Calico çš„ BGP æ¨¡å¼æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠé›†ç¾¤ç½‘ç»œæ¨¡å‹è§†ä¸ºåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½éƒ¨ç½²äº†ä¸€å°è™šæ‹Ÿè·¯ç”±å™¨ã€‚è·¯ç”±å™¨å¯ä»¥ä¸å…¶ä»–èŠ‚ç‚¹ä¸Šçš„è·¯ç”±å™¨é€šè¿‡ BGP åè®®äº’é€šï¼Œå®ƒä»¬è¢«ç§°ä¸ºä¸€å¯¹ BGP Peersã€‚Calico çš„é»˜è®¤éƒ¨ç½²æ–¹å¼ä¸º Full-meshï¼Œå³åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„å†…éƒ¨ BGP è¿æ¥ç½‘ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„è·¯ç”±å™¨å‡äº’ä¸º BGP Peersã€‚è¿™ç§æ–¹å¼ä»…é€‚ç”¨äº 100 ä¸ªèŠ‚ç‚¹ä»¥å†…çš„ä¸­å°å‹é›†ç¾¤ï¼Œåœ¨å¤§å‹é›†ç¾¤ä¸­ä½¿ç”¨çš„æ•ˆç‡ä½ä¸‹ã€‚è€Œ Route Reflectors æ¨¡å¼åˆ™å°†éƒ¨åˆ†èŠ‚ç‚¹ä½œä¸ºè·¯ç”±åå°„å™¨ï¼Œå…¶ä»–èŠ‚ç‚¹ä¸Šçš„è·¯ç”±å™¨åªéœ€ä¸è·¯ç”±åå°„å™¨äº’ä¸º BGP Peersã€‚è¿™æ ·ä¾¿å¯ä»¥å¤§å¤§å‡å°‘é›†ç¾¤ä¸­ BGP Peers çš„æ•°é‡ï¼Œä»è€Œæå‡æ•ˆç‡ã€‚\nOverlay Network Overlay ç½‘ç»œå¯ä»¥é€šè¿‡å¤šç§åè®®å®ç°ï¼Œä½†é€šå¸¸æ˜¯å¯¹ IP æ•°æ®åŒ…è¿›è¡Œä¸€å±‚å¤–éƒ¨å°è£…ï¼ˆEncapsulationï¼‰ã€‚è¿™æ ·åº•å±‚çš„ Underlay ç½‘ç»œä¾¿åªä¼šçœ‹åˆ°å¤–éƒ¨å°è£…çš„æ•°æ®ï¼Œè€Œæ— éœ€å¤„ç†å†…éƒ¨çš„åŸæœ‰æ•°æ®ã€‚Overlay ç½‘ç»œå‘é€æ•°æ®åŒ…çš„æ–¹å¼å–å†³äºå…¶ç±»å‹å’Œä½¿ç”¨çš„åè®®ï¼Œå¦‚åŸºäº VxLAN å®ç° Overlay ç½‘ç»œï¼Œæ•°æ®åŒ…å°†è¢«å¤–éƒ¨å°è£…åä»¥ UDP åè®®è¿›è¡Œå‘é€ï¼š\nOverlay ç½‘ç»œçš„å®ç°å¹¶ä¸ä¾èµ–äºåº•å±‚ç‰©ç†ç½‘ç»œè®¾å¤‡ï¼Œå› æ­¤æˆ‘ä»¬å°±ä»¥ä¸€ä¸ªä¸¤èŠ‚ç‚¹ä¸å¤„äºåŒä¸€ç½‘æ®µä¸” Pod ä¸èŠ‚ç‚¹äº¦å¤„äºä¸åŒç½‘æ®µçš„ä¾‹å­æ¥è¯´æ˜ Overlay ç½‘ç»œä¸­çš„æ•°æ®åŒ…ä¼ é€’è¿‡ç¨‹ã€‚é›†ç¾¤ç½‘ç»œä½¿ç”¨ VxLAN æŠ€æœ¯ç»„å»ºï¼Œè™šæ‹Ÿç½‘ç»œè®¾å¤‡ VTEPï¼ˆVirtual Tunnel End Pointï¼‰å°†ä¼šå®Œæˆæ•°æ®åŒ…çš„å°è£…å’Œè§£å°æ“ä½œã€‚\nNode1 ä¸Šçš„ VTEP æ”¶åˆ° Pod1 å‘æ¥çš„æ•°æ®åŒ…åï¼Œé¦–å…ˆä¼šåœ¨æœ¬åœ°çš„è½¬å‘è¡¨ä¸­æŸ¥æ‰¾ç›®çš„ Pod æ‰€åœ¨èŠ‚ç‚¹çš„ IPï¼Œå³ 192.168.1.100ã€‚éšåå®ƒå°†æœ¬æœº IP åœ°å€ 10.86.44.2ã€Node2 çš„ IP åœ°å€ 192.168.1.100 å’Œ Pod1 çš„ VNIDï¼ˆVxLAN Network Identifierï¼‰å°è£…åœ¨åŸå§‹æ•°æ®åŒ…å¤–ï¼Œä» Node1 çš„ç½‘ç»œæ¥å£ eth0 é€å‡ºã€‚ç”±äºæ–°æ„å»ºçš„æ•°æ®åŒ…æº/ç›®çš„åœ°å€å‡ä¸ºèŠ‚ç‚¹çš„ IPï¼Œå› æ­¤å¤–éƒ¨çš„è·¯ç”±å™¨å¯ä»¥å°†å…¶è½¬å‘åˆ° Node2 ä¸Šã€‚Node2 ä¸­çš„ VTEP åœ¨æ¥æ”¶åˆ°æ•°æ®åŒ…åä¼šé¦–å…ˆè¿›è¡Œè§£å°ï¼Œè‹¥æº VNIDï¼ˆPod1 çš„ VNIDï¼‰ä¸ç›®çš„ VNIDï¼ˆPod2 çš„ VNIDï¼‰ä¸€è‡´ï¼Œä¾¿ä¼šæ ¹æ®åŸå§‹æ•°æ®åŒ…ä¸­çš„ç›®çš„åœ°å€ 172.100.1.2 å°†å…¶å‘é€åˆ° Pod2 ä¸Šã€‚æ­¤å¤„çš„ VNID æ£€æŸ¥ï¼Œä¸»è¦æ˜¯ä¸ºäº†å®ç°é›†ç¾¤çš„ç½‘ç»œç­–ç•¥ç®¡ç†å’Œå¤šç§Ÿæˆ·éš”ç¦»ã€‚\né€šè¿‡å¯¹ä¸Šè¿°å‡ ç§ SDN ç½‘ç»œæ¨¡å‹çš„è®¨è®ºï¼Œæˆ‘ä»¬å‘ç°åªæœ‰ Overlay ç½‘ç»œéœ€è¦å¯¹æ•°æ®åŒ…è¿›è¡Œå°è£…å’Œè§£å°ï¼Œå› æ­¤å®ƒçš„æ€§èƒ½ç›¸æ¯”äº Underlay ç½‘ç»œè¾ƒå·®ã€‚ä½† Overlay ç½‘ç»œä¹Ÿæœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š\nå¯¹åº•å±‚ç½‘ç»œè®¾å¤‡çš„ä¾èµ–æ€§æœ€å°ã€‚å³ä½¿ Pod æ‰€åœ¨çš„èŠ‚ç‚¹å‘ç”Ÿè¿ç§»ï¼Œä¾ç„¶å¯ä»¥é€šè¿‡ Overlay ç½‘ç»œä¸åŸé›†ç¾¤å®ç°äºŒå±‚ç½‘ç»œçš„äº’é€šï¼› VNID å…±æœ‰ 24 ä½ï¼Œå› æ­¤å¯ä»¥æ„é€ å‡ºçº¦ 1600 ä¸‡ä¸ªäº’ç›¸éš”ç¦»çš„è™šæ‹Ÿç½‘ç»œã€‚ Future Work é™¤äº† VxLAN ä»¥å¤–ï¼Œè¿˜æœ‰å“ªäº›æŠ€æœ¯å¯ä»¥å®ç° Overlay ç½‘ç»œï¼Ÿå®ƒä»¬æ˜¯æ€æ ·ä¼ è¾“æ•°æ®çš„å‘¢ï¼Ÿ æœ¬æ–‡åœ¨è®¨è®º Underlay ç½‘ç»œæ—¶æåˆ°äº† Terway å’Œ Calicoï¼Œé‚£ä¹ˆæœ‰å“ªäº›ä½¿ç”¨ Overlay ç½‘ç»œçš„ CNI æ’ä»¶å‘¢ï¼Ÿ æ›´æ–°ï¼šæˆ‘åœ¨ å¯¹ Openshift SDN ç½‘ç»œæ¨¡å‹çš„ä¸€äº›æ¢ç´¢ ä¸­ä»‹ç»äº†åŸºäº Overlay ç½‘ç»œçš„ Open vSwitchï¼› è¿‘å¹´æ¥å‘å±•è¿…é€Ÿçš„ Cilium æ˜¯æ€æ ·å®ç° SDN ç½‘ç»œçš„ï¼Ÿå®ƒæ‰€ä¾èµ–çš„ eBPF æŠ€æœ¯åˆæ˜¯ä»€ä¹ˆï¼Ÿ å‚è€ƒæ–‡çŒ® Software-defined networking - Wikipedia\nAbout Kubernetes Networking\nä½¿ç”¨ Terway ç½‘ç»œæ’ä»¶\nè¾¹ç•Œç½‘å…³åè®® - Wikipedia\nConfigure BGP peering - Calico\nä¸ºä»€ä¹ˆé›†ç¾¤éœ€è¦ Overlay ç½‘ç»œ\n","description":"","tags":["Kubernetes","Container","Network","CNI","Calico"],"title":"Kubernetes Pod æ˜¯å¦‚ä½•è·¨èŠ‚ç‚¹é€šä¿¡çš„ï¼Ÿ","uri":"/posts/how-kubernetes-pods-communicate-across-nodes/"},{"content":"å‰è¨€ é€šå¸¸ï¼ŒKafka ä¸­çš„æ¯ä¸ª Partiotion ä¸­æœ‰å¤šä¸ªå‰¯æœ¬ (Replica) ä»¥å®ç°é«˜å¯ç”¨ã€‚æƒ³è±¡ä¸€ä¸ªåœºæ™¯ï¼ŒConsumer æ­£åœ¨æ¶ˆè´¹ Leader ä¸­ Offset = 10 çš„æ•°æ®ï¼Œè€Œæ­¤æ—¶ Follower ä¸­åªåŒæ­¥åˆ° Offset = 8ã€‚é‚£ä¹ˆå½“ Leader æ‰€åœ¨çš„ Broker å®•æœºåï¼Œå½“å‰ Follower ç»é€‰ä¸¾æˆä¸ºæ–°çš„ Leaderï¼ŒConsumer å†æ¬¡æ¶ˆè´¹æ—¶ä¾¿ä¼šæŠ¥é”™ã€‚å› æ­¤ï¼ŒKafka å¼•å…¥äº† HWï¼ˆHigh Watermarkï¼Œé«˜æ°´ä½ï¼‰æœºåˆ¶æ¥ä¿è¯å‰¯æœ¬æ•°æ®çš„å¯é æ€§å’Œä¸€è‡´æ€§ã€‚\nHW æ˜¯ä»€ä¹ˆï¼Ÿ HW å®šä¹‰äº†æ¶ˆæ¯çš„å¯è§æ€§ï¼Œå³æ ‡è¯† Partition ä¸­çš„å“ªäº›æ¶ˆæ¯æ˜¯å¯ä»¥è¢« Consumer æ¶ˆè´¹çš„ï¼Œåªæœ‰å°äº HW å€¼çš„æ¶ˆæ¯æ‰è¢«è®¤ä¸ºæ˜¯å·²å¤‡ä»½æˆ–å·²æäº¤çš„ï¼ˆCommittedï¼‰ã€‚è€Œ LEOï¼ˆLog End Offsetï¼‰åˆ™è¡¨ç¤ºå‰¯æœ¬å†™å…¥ä¸‹ä¸€æ¡æ¶ˆæ¯çš„ Offsetï¼Œå› æ­¤åŒä¸€å‰¯æœ¬çš„ HW å€¼æ°¸è¿œä¸ä¼šå¤§äºå…¶ LEO å€¼ã€‚\nå½“é›†ç¾¤ä¸­å‰¯æœ¬æ‰€åœ¨çš„ Broker å‘ç”Ÿæ•…éšœè€Œåæ¢å¤æ—¶ï¼Œå‰¯æœ¬å…ˆå°†æ•°æ®æˆªæ–­ï¼ˆTruncationï¼‰åˆ°å…¶ HW å¤„ï¼ˆLEO ç­‰äº HWï¼‰ï¼Œç„¶åå†å¼€å§‹å‘ Leader åŒæ­¥æ•°æ®ã€‚\nHW çš„æ›´æ–°æœºåˆ¶ æ¯ä¸€ä¸ªå‰¯æœ¬éƒ½ä¿å­˜äº†å…¶ HW å€¼å’Œ LEO å€¼ï¼Œå³ Leader HWï¼ˆå®é™…ä¸Šä¹Ÿæ˜¯ Partition HWï¼‰ã€Leader LEO å’Œ Follower HWã€Follower LEOã€‚è€Œ Leader æ‰€åœ¨çš„ Broker ä¸Šè¿˜ä¿å­˜äº†å…¶ä»– Follower çš„ LEO å€¼ï¼Œå³ Remote LEOã€‚ä¸Šè¿°å‡ ä¸ªå€¼çš„æ›´æ–°æµç¨‹å¦‚ä¸‹ï¼š\nå¦‚å›¾æ‰€ç¤ºï¼Œå½“ Producer å‘ log æ–‡ä»¶å†™å…¥æ•°æ®æ—¶ï¼ŒLeader LEO é¦–å…ˆè¢«æ›´æ–°ã€‚è€Œ Remote LEO è¦ç­‰åˆ° Follower å‘ Leader å‘é€åŒæ­¥è¯·æ±‚ï¼ˆFetchï¼‰æ—¶ï¼Œæ‰ä¼šæ ¹æ®è¯·æ±‚æºå¸¦çš„å½“å‰ Follower LEO å€¼æ›´æ–°ã€‚éšåï¼ŒLeader è®¡ç®—æ‰€æœ‰å‰¯æœ¬ LEO çš„æœ€å°å€¼ï¼Œå°†å…¶ä½œä¸ºæ–°çš„ Leader HWã€‚è€ƒè™‘åˆ° Leader HW åªèƒ½å•è°ƒé€’å¢ï¼Œå› æ­¤è¿˜å¢åŠ äº†ä¸€ä¸ª LEO æœ€å°å€¼ä¸å½“å‰ Leader HW çš„æ¯”è¾ƒï¼Œé˜²æ­¢ Leader HW å€¼é™ä½ï¼ˆmax[Leader HW, min(All LEO)]ï¼‰ã€‚\nFollower åœ¨æ¥æ”¶åˆ° Leader çš„å“åº”ï¼ˆResponseï¼‰åï¼Œé¦–å…ˆå°†æ¶ˆæ¯å†™å…¥ log æ–‡ä»¶ä¸­ï¼Œéšåæ›´æ–° Follower LEOã€‚ç”±äº Response ä¸­æºå¸¦äº†æ–°çš„ Leader HWï¼ŒFollower å°†å…¶ä¸åˆšåˆšæ›´æ–°è¿‡çš„ Follower LEO ç›¸æ¯”è¾ƒï¼Œå–æœ€å°å€¼ä½œä¸º Follower HWï¼ˆmin(Follower LEO, Leader HW)ï¼‰ã€‚\nä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœä¸€å¼€å§‹ Leader å’Œ Follower ä¸­æ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œå³æ‰€æœ‰å€¼å‡ä¸º 0ã€‚é‚£ä¹ˆå½“ Prouder å‘ Leader å†™å…¥ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œä¸Šè¿°å‡ ä¸ªå€¼çš„å˜åŒ–é¡ºåºå¦‚ä¸‹ï¼š\nLeader LEO Remote LEO Leader HW Follower LEO Follower HW Producer Write 1 0 0 0 0 Follower Fetch 1 0 0 0 0 Leader Update HW 1 0 0 0 0 Leader Response 1 0 0 1 0 Follower Update HW 1 0 0 1 0 Follower Fetch 1 1 0 1 0 Leader Update HW 1 1 1 1 0 Leader Response 1 1 1 1 0 Follower Update HW 1 1 1 1 1 HW çš„éšæ‚£ é€šè¿‡ä¸Šé¢çš„è¡¨æ ¼æˆ‘ä»¬å‘ç°ï¼ŒFollower å¾€å¾€éœ€è¦è¿›è¡Œä¸¤æ¬¡ Fetch è¯·æ±‚æ‰èƒ½æˆåŠŸæ›´æ–° HWã€‚Follower HW åœ¨æŸä¸€é˜¶æ®µå†…æ€»æ˜¯è½åäº Leader HWï¼Œå› æ­¤å‰¯æœ¬åœ¨æ ¹æ® HW å€¼æˆªå–æ•°æ®æ—¶å°†æœ‰å¯èƒ½å‘ç”Ÿæ•°æ®çš„ä¸¢å¤±æˆ–ä¸ä¸€è‡´ã€‚\nå›¾ä¸­ä¸¤å‰¯æœ¬çš„ LEO å‡ä¸º 2ï¼Œä½† Leader å‰¯æœ¬ B ä¸Šçš„ HW ä¸º 2ï¼ŒFollower å‰¯æœ¬ A ä¸Šçš„ HW ä¸º 1ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œå‰¯æœ¬ A å°†åœ¨æ¥æ”¶ Leader Response åæ ¹æ® Leader HW æ›´æ–°å…¶ Follower HW ä¸º 2ã€‚ä½†å‡å¦‚æ­¤æ—¶å‰¯æœ¬ A æ‰€åœ¨çš„ Broker é‡å¯ï¼Œå®ƒä¼šæŠŠ Follower LEO ä¿®æ”¹ä¸ºé‡å¯å‰è‡ªèº«çš„ HW å€¼ 1ï¼Œå› æ­¤æ•°æ® M1ï¼ˆOffset = 1ï¼‰è¢«æˆªæ–­ã€‚å½“å‰¯æœ¬ A é‡æ–°å‘å‰¯æœ¬ B å‘é€åŒæ­¥è¯·æ±‚æ—¶ï¼Œå¦‚æœå‰¯æœ¬ B æ‰€åœ¨çš„ Broker å‘ç”Ÿå®•æœºï¼Œå‰¯æœ¬ A å°†è¢«é€‰ä¸¾æˆä¸ºæ–°çš„ Leaderã€‚å³ä½¿å‰¯æœ¬ B æ‰€åœ¨çš„ Broker èƒ½å¤ŸæˆåŠŸé‡å¯ä¸”å…¶ LEO å€¼ä¾ç„¶ä¸º 2ï¼Œä½†åªè¦å®ƒå‘å½“å‰ Leaderï¼ˆå‰¯æœ¬ Aï¼‰å‘èµ·åŒæ­¥è¯·æ±‚åå°±ä¼šæ›´æ–°å…¶ HW ä¸º 1ï¼ˆè®¡ç®—min(Follower LEO, Leader HW)ï¼‰ï¼Œæ•°æ® M1ï¼ˆOffset = 1ï¼‰éšå³è¢«æˆªæ–­ã€‚å¦‚æœmin.insync.replicaså‚æ•°ä¸º 1ï¼Œé‚£ä¹ˆ Producer ä¸ä¼šå› å‰¯æœ¬ A æ²¡æœ‰åŒæ­¥æˆåŠŸè€Œé‡æ–°å‘é€æ¶ˆæ¯ï¼ŒM1 ä¹Ÿå°±æ°¸è¿œä¸¢å¤±äº†ã€‚\nå›¾ä¸­ Leader å‰¯æœ¬ B å†™å…¥äº†ä¸¤æ¡æ•°æ® M0 å’Œ M1ï¼ŒFollower å‰¯æœ¬ A åªå†™å…¥äº†ä¸€æ¡æ•°æ® M0ã€‚æ­¤æ—¶ Leader HW ä¸º 2ï¼ŒFollower HW ä¸º 1ã€‚å¦‚æœåœ¨ Follower åŒæ­¥ç¬¬äºŒæ¡æ•°æ®å‰ï¼Œä¸¤å‰¯æœ¬æ‰€åœ¨çš„ Broker å‡å‘ç”Ÿé‡å¯ä¸”å‰¯æœ¬ B æ‰€åœ¨çš„ Broker å…ˆé‡å¯æˆåŠŸï¼Œé‚£ä¹ˆå‰¯æœ¬ A å°†æˆä¸ºæ–°çš„ Leaderã€‚è¿™æ—¶ Producer å‘å…¶å†™å…¥æ•°æ® M2ï¼Œå‰¯æœ¬ A ä½œä¸ºé›†ç¾¤ä¸­çš„å”¯ä¸€å‰¯æœ¬ï¼Œæ›´æ–°å…¶ HW ä¸º 2ã€‚å½“å‰¯æœ¬ B æ‰€åœ¨çš„ Broker é‡å¯åï¼Œå®ƒå°†å‘å½“å‰çš„ Leader å‰¯æœ¬ A åŒæ­¥æ•°æ®ã€‚ç”±äºä¸¤è€…çš„ HW å‡ä¸º 2ï¼Œå› æ­¤å‰¯æœ¬ B ä¸éœ€è¦è¿›è¡Œä»»ä½•æˆªæ–­æ“ä½œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå‰¯æœ¬ B ä¸­çš„æ•°æ®ä¸ºé‡å¯å‰çš„ M0 å’Œ M1ï¼Œå‰¯æœ¬ A ä¸­çš„æ•°æ®å´æ˜¯ M0 å’Œ M2ï¼Œå‰¯æœ¬é—´çš„æ•°æ®å‡ºç°äº†ä¸ä¸€è‡´ã€‚\nLeader Epoch Kakfa å¼•å…¥ Leader Epoch åï¼ŒFollower å°±ä¸å†å‚è€ƒ HWï¼Œè€Œæ˜¯æ ¹æ® Leader Epoch ä¿¡æ¯æ¥æˆªæ–­ Leader ä¸­ä¸å­˜åœ¨çš„æ¶ˆæ¯ã€‚è¿™ç§æœºåˆ¶å¯ä»¥å¼¥è¡¥åŸºäº HW çš„å‰¯æœ¬åŒæ­¥æœºåˆ¶çš„ä¸è¶³ï¼ŒLeader Epoch ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š\nEpochï¼šä¸€ä¸ªå•è°ƒå¢åŠ çš„ç‰ˆæœ¬å·ã€‚æ¯å½“ Leader å‰¯æœ¬å‘ç”Ÿå˜æ›´æ—¶ï¼Œéƒ½ä¼šå¢åŠ è¯¥ç‰ˆæœ¬å·ã€‚Epoch å€¼è¾ƒå°çš„ Leader è¢«è®¤ä¸ºæ˜¯è¿‡æœŸ Leaderï¼Œä¸èƒ½å†è¡Œä½¿ Leader çš„æƒåŠ›ï¼› èµ·å§‹ä½ç§»ï¼ˆStart Offsetï¼‰ï¼šLeader å‰¯æœ¬åœ¨è¯¥ Epoch å€¼ä¸Šå†™å…¥é¦–æ¡æ¶ˆæ¯çš„ Offsetã€‚ ä¸¾ä¾‹æ¥è¯´ï¼ŒæŸä¸ª Partition æœ‰ä¸¤ä¸ª Leader Epochï¼Œåˆ†åˆ«ä¸º (0, 0) å’Œ (1, 100)ã€‚è¿™æ„å‘³è¯¥ Partion å†ç»ä¸€æ¬¡ Leader å‰¯æœ¬å˜æ›´ï¼Œç‰ˆæœ¬å·ä¸º 0 çš„ Leader ä» Offset = 0 å¤„å¼€å§‹å†™å…¥æ¶ˆæ¯ï¼Œå…±å†™å…¥äº† 100 æ¡ã€‚è€Œç‰ˆæœ¬å·ä¸º 1 çš„ Leader åˆ™ä» Offset = 100 å¤„å¼€å§‹å†™å…¥æ¶ˆæ¯ã€‚\næ¯ä¸ªå‰¯æœ¬çš„ Leader Epoch ä¿¡æ¯æ—¢ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œä¹Ÿä¼šå®šæœŸå†™å…¥æ¶ˆæ¯ç›®å½•ä¸‹çš„ leaderer-epoch-checkpoint æ–‡ä»¶ä¸­ã€‚å½“ä¸€ä¸ª Follower å‰¯æœ¬ä»æ•…éšœä¸­æ¢å¤é‡æ–°åŠ å…¥ ISR ä¸­ï¼Œå®ƒå°†ï¼š\nå‘ Leader å‘é€ LeaderEpochRequestï¼Œè¯·æ±‚ä¸­åŒ…å«äº† Follower çš„ Epoch ä¿¡æ¯ï¼› Leader å°†è¿”å›å…¶ Follower æ‰€åœ¨ Epoch çš„ Last Offsetï¼› å¦‚æœ Leader ä¸ Follower å¤„äºåŒä¸€ Epochï¼Œé‚£ä¹ˆ Last Offset æ˜¾ç„¶ç­‰äº Leader LEOï¼› å¦‚æœ Follower çš„ Epoch è½åäº Leaderï¼Œåˆ™ Last Offset ç­‰äº Follower Epoch + 1 æ‰€å¯¹åº”çš„ Start Offsetã€‚è¿™å¯èƒ½æœ‰ç‚¹éš¾ä»¥ç†è§£ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä»¥ (0, 0) å’Œ (1, 100) ä¸ºä¾‹è¿›è¡Œè¯´æ˜ï¼šOffset = 100 çš„æ¶ˆæ¯æ—¢æ˜¯ Epoch = 1 çš„ Start Offsetï¼Œä¹Ÿæ˜¯ Epoch = 0 çš„ Last Offsetï¼› Follower æ¥æ”¶å“åº”åæ ¹æ®è¿”å›çš„ Last Offset æˆªæ–­æ•°æ®ï¼› åœ¨æ•°æ®åŒæ­¥æœŸé—´ï¼Œåªè¦ Follower å‘ç° Leader è¿”å›çš„ Epoch ä¿¡æ¯ä¸è‡ªèº«ä¸ä¸€è‡´ï¼Œä¾¿ä¼šéšä¹‹æ›´æ–° Leader Epoch å¹¶å†™å…¥ç£ç›˜ã€‚ åœ¨åˆšåˆšä»‹ç»çš„æ•°æ®ä¸¢å¤±åœºæ™¯ä¸­ï¼Œå‰¯æœ¬ A æ‰€åœ¨çš„ Broker é‡å¯åæ ¹æ®è‡ªèº«çš„ HW å°†æ•°æ® M1 æˆªæ–­ã€‚è€Œç°åœ¨ï¼Œå‰¯æœ¬ A é‡å¯åä¼šå…ˆå‘å‰¯æœ¬ B å‘é€ä¸€ä¸ªè¯·æ±‚ï¼ˆLeaderEpochRequestï¼‰ã€‚ç”±äºä¸¤å‰¯æœ¬çš„ Epoch å‡ä¸º 0ï¼Œå‰¯æœ¬ B è¿”å›çš„ Last Offset ä¸º Leader LEO å€¼ 2ã€‚è€Œå‰¯æœ¬ A ä¸Šå¹¶æ²¡æœ‰ Offset å¤§äºç­‰ 2 çš„æ¶ˆæ¯ï¼Œå› æ­¤æ— éœ€è¿›è¡Œæ•°æ®æˆªæ–­ï¼ŒåŒæ—¶å…¶ HW ä¹Ÿä¼šæ›´æ–°ä¸º 2ã€‚ä¹‹åå‰¯æœ¬ B æ‰€åœ¨çš„ Broker å®•æœºï¼Œå‰¯æœ¬ A æˆä¸ºæ–°çš„ Leaderï¼ŒLeader Epoch éšå³æ›´æ–°ä¸º (1, 2)ã€‚å½“å‰¯æœ¬ B é‡å¯å›æ¥å¹¶å‘å½“å‰ Leader å‰¯æœ¬ A å‘é€ LeaderEpochRequestï¼Œå¾—åˆ°çš„ Last Offset ä¸º Epoch = 1 å¯¹åº”çš„ Start Offset å€¼ 2ã€‚åŒæ ·ï¼Œå‰¯æœ¬ B ä¸­æ¶ˆæ¯çš„æœ€å¤§ Offset å€¼åªæœ‰ 1ï¼Œå› æ­¤ä¹Ÿæ— éœ€è¿›è¡Œæ•°æ®æˆªæ–­ï¼Œæ¶ˆæ¯ M1 æˆåŠŸä¿ç•™äº†ä¸‹æ¥ã€‚\nåœ¨åˆšåˆšä»‹ç»çš„æ•°æ®ä¸ä¸€è‡´åœºæ™¯ä¸­ï¼Œç”±äºæœ€åä¸¤å‰¯æœ¬ HW å€¼ç›¸ç­‰ï¼Œå› æ­¤æ²¡æœ‰å°†ä¸ä¸€è‡´çš„æ•°æ®æˆªæ–­ã€‚è€Œç°åœ¨ï¼Œå‰¯æœ¬ A é‡å¯åå¹¶ä¾¿ä¼šæ›´æ–° Leader Epoch ä¸º (1, 1)ï¼ŒåŒæ—¶ä¹Ÿä¼šæ›´æ–°å…¶ HW å€¼ä¸º 2ã€‚å‰¯æœ¬ B é‡å¯åå‘å½“å‰ Leader å‰¯æœ¬ A å‘é€ LeaderEpochRequestï¼Œå¾—åˆ°çš„ Last Offset ä¸º Epoch = 1 å¯¹åº”çš„ Start Offset å€¼ 1ï¼Œå› æ­¤æˆªæ–­ Offset = 1 çš„æ¶ˆæ¯ M1ã€‚è¿™æ ·åªè¦å‰¯æœ¬ B å†æ¬¡å‘èµ·è¯·æ±‚åŒæ­¥æ¶ˆæ¯ M2ï¼Œä¸¤å‰¯æœ¬çš„æ•°æ®ä¾¿å¯ä»¥ä¿æŒä¸€è‡´ã€‚\nå€¼å¾—ä¸€æçš„æ˜¯ï¼ŒLeader Epoch æœºåˆ¶åœ¨min.insync.replicaså‚æ•°ä¸º 1 ä¸”unclean.leader.election.enabledå‚æ•°ä¸ºtrueæ—¶ä¾ç„¶æ— æ³•ä¿è¯æ•°æ®çš„å¯é æ€§ã€‚æ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥é˜…è¯» KIP-101 - Alter Replication Protocol to use Leader Epoch rather than High Watermark for Truncation æ–‡ä¸­çš„é™„å½•éƒ¨åˆ†ã€‚\nå‚è€ƒæ–‡çŒ® KIP-101 - Alter Replication Protocol to use Leader Epoch rather than High Watermark for Truncation\n","description":"","tags":["Kafka"],"title":"Kafka æ˜¯å¦‚ä½•åŒæ­¥å‰¯æœ¬çš„ï¼Ÿ","uri":"/posts/how-does-kafka-synchronize-replicas/"}]